var app=app||angular.module("hxApp",["ngRoute"]);app.value("ActionHistoryDto",{noteType:"SUBSCRIPTION",note:"note",orderNumber:"",subType:"TEAM",reasonType:"",reasonCode:"",sku:"",guid:"",currency:"",cancelReason:"",eccContractId:"",creditDebitMemoNo:"",productCode:"",productLanguage:"",etfAmount:0,cancellationValue:0,agentId:0,userId:0,seatsCancelled:0,seatsLeft:0,event:{agentId:0,userId:0,eventType:"",comments:"",guid:""}});var app=app||angular.module("hxApp",["ngRoute"]);app.value("AddDRSeatDto",{lastModifiedById:"",ownerId:"",status:"",country:"",teamId:"",cartItems:[]});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("AddProductFromStoreCartController",["$scope","$log","$rootScope","$location","$routeParams","StoreConstants","SkuSearchService","StoreCustomerService","AppUtils","StoreUtil",function($scope,$log,$rootScope,$location,$routeParams,StoreConstants,SkuSearchService,StoreCustomerService,AppUtils,StoreUtil){$scope.isPONumberEdited=false;$scope.tempPoNumber="";var requestProductSearchDto=new Object();requestProductSearchDto.storeId=$scope.currentStore.storeKey;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};var defaultJemOrderDto=function(){return{id:"",contractType:"",extContractId:"",annivDay:"",annivDate:"",nextAnnivDate:"",origEntityeid:"",enrolleeId:"",contStartDt:"",contEndDt:"",curr:"",totalValue:"",jemOrderItems:[],puftype:"",paymentType:"",poNumber:""}};var defaultJemOrderItemDto=function(){return{orderedProd:"",description:"",numberInt:"",quantity:"",quantityUnit:"",listPrice:"",grossValue:"",adjPrice:"",adjGrossValue:"",zprdtype:"",startDate:new Date(),endDate:new Date(),ispuf:""}};$scope.editPONumber=function(){$scope.isPONumberEdited=true;$scope.tempPoNumber=$scope.$parent.$parent.jemOrderDto.poNumber};$scope.cancelEditPONumber=function(){$scope.isPONumberEdited=false;$scope.$parent.$parent.jemOrderDto.poNumber=$scope.tempPoNumber};$scope.updateAddProductPrice=function(){var totalValue=0;var grossValue=0;angular.forEach($scope.storeCart.items,function(item){angular.forEach($scope.$parent.$parent.jemOrderDto.jemOrderItems,function(jemItem){if(jemItem.orderedProd==item.sku){jemItem.quantity=item.quantity;jemItem.adjGrossValue=(Number(jemItem.adjPrice)*Number(jemItem.quantity)).toFixed(2);jemItem.grossValue=(Number(jemItem.listPrice)*Number(jemItem.quantity)).toFixed(2);totalValue=totalValue+Number(jemItem.adjGrossValue);grossValue=grossValue+Number(jemItem.grossValue)}})});$scope.$parent.$parent.jemOrderDto.totalValue=totalValue;$scope.$parent.$parent.jemOrderDto.grossValue=grossValue};$scope.deleteItemFromCartAndJemOrder=function(cartItemIndex){var cartItem=$scope.storeCart.items[cartItemIndex];angular.forEach($scope.$parent.$parent.jemOrderDto.jemOrderItems,function(jemItem){if(jemItem.orderedProd==cartItem.sku){$scope.$parent.$parent.jemOrderDto.totalValue=$scope.$parent.$parent.jemOrderDto.totalValue-jemItem.adjGrossValue;$scope.$parent.$parent.jemOrderDto.grossValue=$scope.$parent.$parent.jemOrderDto.grossValue-jemItem.grossValue;$scope.$parent.$parent.jemOrderDto.jemOrderItems.splice(jemItem,1)}});$scope.storeCart.items.splice(cartItemIndex,1);if($scope.storeCart.items.length>0&&!StoreUtil.isConflictSKUExist($scope.storeCart.items)){$scope.$parent.showHideAddProductBtn(false)}};$scope.removeStoreCartItem=function(cartItemIndex){$scope.cartItems.splice(cartItemIndex,1);$scope.updateStoreCart();$scope.cartMessage=CartValidator.getCartMessage("Cart Item Removed Successfully","success");$scope.isCartMessageShow=true};$scope.searchAndApplyMatchingProductSKU=function(sku){$scope.$parent.updateLoadingMessage("Updating product ..");$scope.$parent.showViewLoading();var requestProductSearchDto=new Object();requestProductSearchDto.storeId=$scope.currentStore.storeKey;crmSearchObject.sku=sku;requestProductSearchDto.criteria=crmSearchObject;SkuSearchService.search(requestProductSearchDto).success(function(result){$scope.updateCartItemWithNewSKU(result[0]);result[0].productImg=AppUtils.getProductThumbnailImageFromCrmDescription(result[0].description);result[0].name=StoreUtil.getSkuProductName(result[0].name,result[0].description)}).error(function(result){$scope.$parent.hideViewLoading()})};$scope.updateCartItemWithNewSKU=function(item){for(var i=0;i<$scope.storeCart.items.length;i++){if($scope.storeCart.items[i].conflictSKU==item.sku){item.quantity=$scope.storeCart.items[i].quantity;$scope.storeCart.items[i]=item;$scope.$parent.updateLoadingMessage("Reviewing order ..");$scope.reviewJemOrder();break}}};$scope.reviewJemOrder=function(){StoreCustomerService.reviewJemOrder($scope.customerId,$scope.getCartItemAsJemOrderItemDto()).success(function(result){$scope.updateCartItemWithMoreDetail(result);$scope.updateAddProductPrice();$scope.updateJemOrderDto(result);$scope.$parent.hideViewLoading();if(!StoreUtil.isConflictSKUExist(result.jemOrderItems)){$scope.$parent.showHideAddProductBtn(false)}}).error(function(error){$scope.$parent.hideViewLoading()})};$scope.updateJemOrderDto=function(jemOrderDto){$scope.$parent.$parent.jemOrderDto=jemOrderDto};$scope.getCartItemAsJemOrderItemDto=function(){var defaultJemOrderDtoObj=defaultJemOrderDto();if($scope.storeCart&&$scope.storeCart.items){angular.forEach($scope.storeCart.items,function(item){var defaultJemOrderItemObj=defaultJemOrderItemDto();defaultJemOrderItemObj.ispuf=item.puf?"X":"";defaultJemOrderItemObj.quantity=item.quantity;defaultJemOrderItemObj.description=item.description;defaultJemOrderItemObj.orderedProd=item.sku;defaultJemOrderItemObj.zprdtype=item.prodType;defaultJemOrderItemObj.listPrice=item.price.listPrice;defaultJemOrderItemObj.productCode=item.productCode;defaultJemOrderDtoObj.jemOrderItems.push(defaultJemOrderItemObj)})}return defaultJemOrderDtoObj};$scope.updateCartItemWithMoreDetail=function(jemOrderDto){jemOrderDto.grossValue=0;angular.forEach(jemOrderDto.jemOrderItems,function(jemOrderItem){angular.forEach($scope.storeCart.items,function(cartItem){if(jemOrderItem.orderedProd==cartItem.sku){cartItem.adjGrossValue=jemOrderItem.adjGrossValue;cartItem.adjPrice=jemOrderItem.adjPrice;cartItem.grossValue=jemOrderItem.grossValue;cartItem.listPrice=jemOrderItem.listPrice;cartItem.currencyCode=jemOrderDto.curr;cartItem.adjPrice=jemOrderItem.adjPrice;cartItem.listPrice=jemOrderItem.listPrice;cartItem.conflictSKU=jemOrderItem.conflictSKU}});jemOrderDto.grossValue=jemOrderDto.grossValue+Number(jemOrderItem.grossValue)})}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngAddReminder",["CustomerPreviewService","ReminderService","Utils","$rootScope","AppConstants","$routeParams",function(CustomerPreviewService,ReminderService,Utils,$rootScope,AppConstants,$routeParams){return{restrict:"EA",replace:true,templateUrl:"js/reminder/partials/add-reminder.html",link:function(scope,element,attrs){scope.isValidCustomer=false;scope.isDateSelected=false;scope.reminderForm={};scope.loadingCustomer=false;scope.errorMessages=[];$rootScope.$on(AppConstants.ADD_REMINDER_EVENT,function(event,customer){scope.reminderForm.firstName=customer.firstName;scope.reminderForm.lastName=customer.lastName;scope.reminderForm.phoneNumber=customer.telephone||customer.mobileNo;scope.reminderForm.customerNo=customer.customerNo;scope.reminderForm.caseNumber=$routeParams.caseNo;if(scope.reminderForm.caseNumber&&(scope.reminderForm.caseNumber=="newCs"||scope.reminderForm.caseNumber=="newTs")){scope.reminderForm.caseNumber=""}scope.reminderForm.transactionNumber=$routeParams.transactionNo;$("#addReminderModal").modal("show")});var remDatePicker=$("#reminderDatePicker").datetimepicker({minDate:moment(new Date()),sideBySide:true});remDatePicker.on("dp.change",function(e){scope.isDateSelected=true;if(scope.isFormValid()&&$("#txtReminderDate").val()!=""){$("#btnReminderSubmit").removeAttr("disabled")}else{$("#btnReminderSubmit").attr("disabled","disabled")}});scope.validateCustomer=function(){scope.loadingCustomer=true;scope.isValidCustomer=false;scope.errorMessages=[];if(scope.reminderForm.customerNo!=""){CustomerPreviewService.getCustomerWithoutLocking({customerNo:scope.reminderForm.customerNo}).success(function(result,status){console.log("Customer is valid");scope.reminderForm.firstName=result.firstName;scope.reminderForm.lastName=result.lastName;scope.reminderForm.phoneNumber=result.telephone||result.mobileNo;scope.isValidCustomer=true;scope.loadingCustomer=false}).error(function(errorData){console.log("Customer is not valid");scope.isValidCustomer=false;scope.loadingCustomer=false;scope.errorMessages=Utils.showMessage("info","Customer ID is not valid.")})}else{scope.isValidCustomer=false;scope.loadingCustomer=false}};scope.customerChangeEvent=function(changeEvent){if(typeof changeEvent!="undefined"){if(scope.reminderForm.customerNo){scope.validateCustomer()}}};scope.transactionChangeEvent=function(changeEvent){if(typeof changeEvent!="undefined"){if(scope.reminderForm.transactionCaseID){scope.searchByTransactionOrCaseId()}}};scope.isFormValid=function(){return scope.reminderForm.notes&&scope.isDateSelected&&moment($("#txtReminderDate").val()).isValid()&&!scope.loadingCustomer};scope.saveReminder=function(){scope.errorMessages=[];var reminderObj={userID:scope.currentUser.username.toUpperCase(),firstName:scope.reminderForm.firstName,lastName:scope.reminderForm.lastName,phoneNumber:scope.reminderForm.phoneNumber,customerNo:scope.reminderForm.customerNo,notes:scope.reminderForm.notes,transactionNumber:scope.reminderForm.transactionNumber,caseNumber:scope.reminderForm.caseNumber,dateTime:moment($("#txtReminderDate").val()),createdDate:moment(new Date()),reminderTime:moment(new Date(($("#txtReminderDate").val()))-60000*5),isChecked:false};ReminderService.addReminder(reminderObj).success(function(response){console.log("Reminder Added",response);scope.$broadcast("event:ReminderAdded");scope.resetForm();scope.errorMessages=Utils.showMessage("success","Reminder added successfully.");$rootScope.$broadcast("event:ReloadReminders");setTimeout(function(){$("#addReminderModal").modal("hide")},4000)}).error(function(error){console.log("Error in adding reminders",error);scope.errorMessages=Utils.showMessage("error","Problem in adding reminder.")})};scope.reminderForm={firstName:"",lastName:"",phoneNumber:"",customerNo:"",notes:"",transactionCaseID:"",transactionNumber:"",caseNumber:""};scope.resetForm=function(){scope.errorMessages=[];scope.reminderForm.firstName="";scope.reminderForm.lastName="";scope.reminderForm.phoneNumber="";scope.reminderForm.customerNo="";scope.reminderForm.notes="";scope.reminderForm.transactionCaseID="";scope.reminderForm.transactionNumber="";scope.reminderForm.caseNumber="";scope.isValidCustomer=false;scope.loadingCustomer=false;$("#txtReminderDate").val("")};$("#addReminderModal").on("hidden.bs.modal",function(e){scope.resetForm()});scope.searchByTransactionOrCaseId=function(searchParam){scope.loadingCustomer=true;scope.errorMessages=[];CustomerPreviewService.findCustomerByTransactionOrCase(searchParam).success(function(result){scope.loadingCustomer=false;if(result&&result.caseDto){scope.reminderForm.customerNo=result.caseDto.customerId;scope.validateCustomer()}else{if(result&&result.transactionDto){scope.transaction=result.transactionDto;scope.reminderForm.firstName=scope.transaction.customer.firstName;scope.reminderForm.lastName=scope.transaction.customer.lastName;scope.reminderForm.phoneNumber=scope.transaction.customer.telephone||scope.transaction.customer.mobileNo;scope.reminderForm.customerNo=scope.transaction.customer.customerNo}else{scope.errorMessages=Utils.showMessage("error","Transaction or case number is not found.")}}}).error(function(){scope.loadingCustomer=false;scope.errorMessages=Utils.showMessage("error","Transaction or case number is not found.")})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("AddressDto",{addressNo:"",addressType:"",city:"",company:"",country:{code:"",drLocale:"",drSiteId:"",drThemeId:"",name:""},defaultFlag:"",department:"",district:"",email:"",homeCity:"",houseNo1:"",houseNo2:"",name:"",partnerNo:"",phone:"",poBox:"",postCode:"",state:"",stateName:"",street1:"",street2:"",street3:""});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("AddressValidationService",["$http",function($http){var service={};service.validate=function(data){return $http({method:"POST",url:"../addressValidationService/validate.do",data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("addSeatProduct",["$rootScope","$location","$routeParams","TeamConstants","TeamService","TeamUtil","AppUtils","AppConstants","SalesConstants","$q","SFDCService","SFDCConstants","TransactionService","TransactionConstants","DrTeamService","AddDRSeatDto","DrTeamAddSeatDto","ActionHistoryDto","TeamActionHistoryService",function($rootScope,$location,$routeParams,TeamConstants,TeamService,TeamUtil,AppUtils,AppConstants,SalesConstants,$q,SFDCService,SFDCConstants,TransactionService,TransactionConstants,DrTeamService,AddDRSeatDto,DrTeamAddSeatDto,ActionHistoryDto,TeamActionHistoryService){return{restrict:"EA",scope:{},replace:true,templateUrl:"js/team/partials/team-add-seat-product.html",link:function($scope,element,attrs){$scope.$on("InitiateAddSeatProduct",function(event,addSeatProductObj){$scope.teamId=addSeatProductObj.teamId;$scope.customerGuid=addSeatProductObj.customerGuid;$scope.source=addSeatProductObj.source;$scope.productData=addSeatProductObj.productData;$scope.paymentType=addSeatProductObj.paymentType;$scope.billingFrequency=addSeatProductObj.billingFrequency;$scope.externalContractId=addSeatProductObj.externalContractId;$scope.teamSubscription=_.has(addSeatProductObj,"teamSubscription")?addSeatProductObj.teamSubscription:"";$scope.isAddProduct=false;$scope.addSeatModalTitle="Purchase Additional Seat(s)";$scope.isDeleteProductBtn=false;$scope.productList=[];$scope.isSFDCFLow=angular.isDefined($routeParams.asynchId)&&$routeParams.asynchId.length>0?true:false;$scope.newPoNumber="";$scope.drReviewResult;if(!$scope.customerGuid.contains("@AdobeID")){$scope.customerGuid=$scope.customerGuid+"@AdobeID"}if($scope.source==SalesConstants.SALES_DIRECT_SALES){$scope.productData=TeamUtil.getSeatProductDetails(addSeatProductObj.productData);$scope.externalContractId=$scope.teamSubscription.externalContractId;$scope.paymentType=TeamUtil.getPaymentTypeText($scope.teamSubscription.billingInfo["paymentCategory"]);$scope.billingFrequency=$scope.teamSubscription.billingInfo["billingFrequency"];$scope.productData[0].totalSeats=$scope.teamSubscription.seats["summary"]["namedSummary"]["total"]-$scope.teamSubscription.seats["summary"]["namedSummary"]["cancelled"];_.each($scope.productData,function(product){var productExists=_.find($scope.teamSubscription.seats.named,{offerId:product.offerId});if(!productExists&&!$scope.isAddProduct){$scope.isAddProduct=true;$scope.addSeatModalTitle="Purchase Additional Product(s)"}});_.each($scope.productData,function(product){var conflictProductExists=_.find($scope.teamSubscription.seats.named,{productCode:product.productCode});if(conflictProductExists&&product.sku!=conflictProductExists.sku){product.isConflictProduct=true;product.swapProductDetails=TeamUtil.getProductDetailsFromCart(product,conflictProductExists)}});$scope.isDeleteProductBtn=true}if($scope.teamId&&$scope.customerGuid&&$scope.productData){$scope.addSeatProduct()}});$scope.TeamConstants=TeamConstants;$scope.addSeatProduct=function(){$scope.isAddSeatProcessing=false;$scope.isAddSeatLoading=true;$scope.isAddSeatProcessSuccess="";$scope.addSeatErrorMessage="";$scope.modalMessages="";$scope.locale="en_us";var parallelApiCalls=[];$scope.isProratedPrice=false;if($scope.billingFrequency.toUpperCase()==TeamConstants.TEAM_BILLING_FREQUENCY_ANNUAL){$scope.isProratedPrice=true}$scope.offerId=_.has($routeParams,"offerId")?$routeParams.offerId:"";if($scope.paymentType==TeamConstants.PAYMENT_TYPE_PO){if(!$scope.externalContractId){$scope.isAddSeatLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(AppConstants.MESSAGE_INFO_TYPE,"Order is being processed. Add Seat/Product is not allowed now. Please try after some time!")}else{TransactionService.getTransaction({guid:"",number:$scope.externalContractId,subscriptionId:""}).success(function(result){$scope.isLoading=false;if(result){if(!$scope.isTransactionValid(result.transactionType)){$scope.modalMessages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Transaction Is Not Valid");$scope.isLoading=false;$scope.isTransactionViewValid=false;return}$scope.transaction=result;console.log($scope.transaction.paymentDetails);if($scope.transaction.paymentDetails.paymentType==9){$scope.latestPoNumber=$scope.transaction.paymentDetails.poNumber}angular.forEach($scope.productData,function(product){var addProductInfo={};product.seatQuantity=_.has(product,"seatQuantity")?parseInt(product.seatQuantity):1;addProductInfo.priceInfo={};addProductInfo.productInfo=product;parallelApiCalls.push(TeamService.getPricingData({teamId:$scope.teamId,offerId:product.offerId}).success(function(result,status,headers,config){addProductInfo.priceInfo=TeamUtil.getTeamAddSeatPriceDetails(result.countryPriceData[0]);$scope.currentBillingPrice=addProductInfo.priceInfo.currentPriceWithoutTax;$scope.currencyCode=addProductInfo.priceInfo.currencyCode;$scope.productList.push(addProductInfo);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){console.log("error",result);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}))});$q.all(parallelApiCalls).then(function(value){$scope.isAddSeatLoading=false;$scope.totalPrice=0;angular.forEach($scope.productList,function(product){$scope.totalPrice=$scope.totalPrice+product.priceInfo.currentPriceWithoutTax+(product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax)});if(!$scope.productList.length){$scope.addSeatErrorMessage="Unable to add products/seats to the existing contract. Please try later!.";AppUtils.sendLogToServer("Unable to add products/seats to the existing contract. Please try later! Team Id: "+$scope.teamId+"Customer GUID : "+$scope.customerGuid)}else{$scope.addSeatErrorMessage=""}},function(reason){console.log("All call fail");$scope.isAddSeatLoading=false;if($scope.paymentType==TeamConstants.TEAM_UNKNOWN){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"The order is being processed. Please retry after some time!")}else{$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Unable fetch the price details. Please try again.")}})}}).error(function(result){$scope.isLoading=$scope.isTransactionViewValid=false;$scope.modalMessages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Failed to load transaction details")})}}else{angular.forEach($scope.productData,function(product){var addProductInfo={};product.seatQuantity=_.has(product,"seatQuantity")?parseInt(product.seatQuantity):1;addProductInfo.priceInfo={};addProductInfo.productInfo=product;parallelApiCalls.push(TeamService.getPricingData({teamId:$scope.teamId,offerId:product.offerId}).success(function(result,status,headers,config){addProductInfo.priceInfo=TeamUtil.getTeamAddSeatPriceDetails(result.countryPriceData[0]);$scope.currentBillingPrice=addProductInfo.priceInfo.currentPriceWithoutTax;$scope.currencyCode=addProductInfo.priceInfo.currencyCode;$scope.productList.push(addProductInfo);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){console.log("error",result);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}))});$q.all(parallelApiCalls).then(function(value){$scope.isAddSeatLoading=false;$scope.totalPrice=0;angular.forEach($scope.productList,function(product){$scope.totalPrice=$scope.totalPrice+product.priceInfo.currentPriceWithoutTax+(product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax)});if(!$scope.productList.length){$scope.addSeatErrorMessage="Unable to add products/seats to the existing contract. Please try later!.";AppUtils.sendLogToServer("Unable to add products/seats to the existing contract. Please try later! Team Id: "+$scope.teamId+"Customer GUID : "+$scope.customerGuid)}else{$scope.addSeatErrorMessage=""}},function(reason){console.log("All call fail");$scope.isAddSeatLoading=false;if($scope.paymentType==TeamConstants.TEAM_UNKNOWN){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"The order is being processed. Please retry after some time!")}else{$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Unable fetch the price details. Please try again.")}})}$("#addSeatProductModal").modal("show")};$scope.$on("InitiateAddDrSeatSalesProduct",function(event,addSeatProductObj){var drObject=angular.copy(DrTeamAddSeatDto);var admin=_.filter(addSeatProductObj.teamSubscription.administrators,function(admin){return admin.isPrimaryAdmin||admin.type=="PRIMARY_ADMIN"});drObject.isDrFlow=true;drObject.last_modified_by_id=$rootScope.currentUser.username;drObject.owner_id=admin[0].userId+"@AdobeID";drObject.teamId=addSeatProductObj.teamId;drObject.productData=addSeatProductObj.productData;drObject.status="PENDING";drObject.externalContractId=addSeatProductObj.teamSubscription.externalContractId;drObject.country=_.has(addSeatProductObj.customerDetails,"address.country.code")?addSeatProductObj.customerDetails.address["country"]["code"]:"";drObject.productData=TeamUtil.getSeatProductDetails(addSeatProductObj.productData);angular.forEach(addSeatProductObj.productData,function(prod){var cartItem={offerId:_.has(prod,"offerId")?prod.offerId:"",quantity:prod.qtySelected};drObject.cartItems.push(cartItem)});$scope.productData=drObject.productData;$scope.externalContractId=drObject.externalContractId;$scope.teamId=drObject.teamId;$scope.offerId=_.has($routeParams,"offerId")?$routeParams.offerId:"";$scope.customerGuid=addSeatProductObj.customerGuid;$scope.isDrFlow=true;$scope.isAddProduct=true;$scope.addSeatModalTitle="Purchase Additional Product(s)";$scope.isDeleteProductBtn=true;$scope.teamSubscription=addSeatProductObj.teamSubscription;_.each($scope.productData,function(product){var conflictProductExists=_.find(addSeatProductObj.teamSubscription.seats.named,{productCode:product.productCode});if(conflictProductExists&&product.sku!=conflictProductExists.sku){product.isConflictProduct=true;product.swapProductDetails=TeamUtil.getProductDetailsFromCart(product,conflictProductExists)}});$scope.productList=addSeatProductObj.productList;$scope.addDRSeatProduct(drObject)});$scope.$on("InitiateAddDrSeatProduct",function(event,addSeatProductObj){$scope.productData=addSeatProductObj.productData;$scope.externalContractId=addSeatProductObj.externalContractId;$scope.teamId=addSeatProductObj.teamId;$scope.offerId=_.has($routeParams,"offerId")?$routeParams.offerId:"";$scope.customerGuid=addSeatProductObj.customerGuid;$scope.isDrFlow=true;$scope.isAddProduct=false;$scope.addSeatModalTitle="Purchase Additional Seat(s)";$scope.isDeleteProductBtn=false;$scope.productList=addSeatProductObj.productList;$scope.addDRSeatProduct(addSeatProductObj)});$scope.addDRSeatProduct=function(addSeatProductObj){$scope.addSeatProductObjs=addSeatProductObj;$scope.isAddSeatProcessing=false;$scope.isAddSeatLoading=true;$scope.isAddSeatProcessSuccess="";$scope.addSeatErrorMessage="";$scope.modalMessages="";$scope.addSeatDTSeatDto=angular.copy(AddDRSeatDto);$scope.addSeatDTSeatDto.lastModifiedById=addSeatProductObj.last_modified_by_id;$scope.addSeatDTSeatDto.ownerId=addSeatProductObj.owner_id;$scope.addSeatDTSeatDto.status="PENDING";$scope.addSeatDTSeatDto.country=addSeatProductObj.country;$scope.addSeatDTSeatDto.teamId=addSeatProductObj.teamId;$scope.addSeatDTSeatDto.cartItems=addSeatProductObj.cartItems;$scope.addSeatDTSeatDto.productData=TeamUtil.getSeatProductDetails(addSeatProductObj.productData);DrTeamService.addDRSeat($scope.addSeatDTSeatDto).success(function(result,status,headers,config){$scope.drReviewResult=result;$scope.isAddSeatProcessSuccess=false;$scope.productDrList=[];$scope.isAddSeatLoading=false;$scope.nextBillingPrice=0;angular.forEach($scope.addSeatProductObjs.productData,function(prod){var addProductInfo={};$scope.productInfo={};addProductInfo.priceInfo={};if($scope.isAddProduct){prod.seatQuantity=_.has(prod,"seatQuantity")?parseInt(prod.seatQuantity):1}else{prod.seatQuantity=_.has(prod,"seatQuantity")?parseInt(prod.seatQuantity):1}addProductInfo.productInfo=prod;addProductInfo.productInfo.primaryImageUrl=_.has(prod,"primaryImageUrl")?prod.primaryImageUrl:prod.primaryImage;addProductInfo.productInfo.productName=_.has(prod,"productName")?prod.productName:prod.name;if($scope.isAddProduct){angular.forEach(result.cartItems,function(cartItem){if(cartItem.offerId==prod.offerId){addProductInfo.priceInfo=TeamUtil.drTeamAddProductPriceDetails(result,cartItem)}})}else{addProductInfo.priceInfo=TeamUtil.getDrTeamAddSeatPriceDetails(result)}$scope.productDrList.push(addProductInfo)});var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_DR,true,result);messageObject.Functionality=$scope.isAddProduct?"Team Subscription:Add Product(s) - Review":"Team Subscription:Add Seat(s) - Review";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isAddSeatProcessSuccess=false;$scope.isAddSeatLoading=false;$scope.addSeatErrorMessage="Unable to review/add product(s). Please try later.";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_DR,false,error);messageObject.Functionality=$scope.isAddProduct?"Team Subscription:Add Product(s) - Review":"Team Subscription:Add Seat(s) - Review";AppUtils.sendLogToServer(messageObject,status,headers,config)});$("#addSeatProductModal").modal("show")};$scope.addDRSeatRequest=function(){var submitDRDto=angular.copy($scope.addSeatDTSeatDto);submitDRDto.status="SUBMIT";submitDRDto.cartItems=[];angular.forEach($scope.productDrList,function(prod){var cartItem={offerId:_.has(prod.productInfo,"offerId")?prod.productInfo.offerId:"",quantity:prod.productInfo.seatQuantity};submitDRDto.cartItems.push(cartItem)});$scope.isAddSeatProcessing=true;DrTeamService.addDRSeat(submitDRDto).success(function(result,status,headers,config){$scope.isAddSeatProcessing=false;$scope.isAddSeatProcessSuccess=true;var actionHistoryDto=angular.copy(ActionHistoryDto);actionHistoryDto.noteType="SUBSCRIPTION";actionHistoryDto.note=$scope.productDrList[0].productInfo.seatQuantity+" seat(s) added for "+$scope.productDrList[0].productInfo.productName;actionHistoryDto.productCode=$scope.productDrList[0].productInfo.productCode;actionHistoryDto.orderNumber=$scope.externalContractId;actionHistoryDto.eccContractId=$scope.externalContractId;actionHistoryDto.subType="TEAM";actionHistoryDto.reasonType="SEAT_MGMT";actionHistoryDto.guid=$scope.customerGuid.split("@")[0];actionHistoryDto.currency=result.currency.code;actionHistoryDto.userId=0;actionHistoryDto.agentId=0;actionHistoryDto.seatsCancelled=$scope.productDrList[0].productInfo.seatQuantity;actionHistoryDto.seatLeft=_.has(result,"seatInfo.summary.total")?result.seatInfo["summary"]["total"]:0;actionHistoryDto.cancellationValue=0;actionHistoryDto.event.eventType=$scope.isAddProduct?"CCT_DR_ADD_PRODUCTS":"CCT_DR_ADD_SEATS";actionHistoryDto.event.comments=$scope.teamId.split("@")[0];actionHistoryDto.event.guid=$scope.customerGuid.split("@")[0];TeamActionHistoryService.logActionHistoryForAddDrSeat(actionHistoryDto).success(function(result){$scope.resultMessage=result}).error(function(error){$scope.errorMessage=error});$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Purchased additional seat(s) to existing product.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_DR,true,result);messageObject.Functionality=$scope.isAddProduct?"DR Team Subscription:Add Product(s) - Submitted":"DR Team Subscription:Add Seat(s) - Submitted";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isAddSeatProcessing=false;$scope.isAddSeatProcessSuccess=false;$scope.modalMessages=AppUtils.getSingleMessage("error",error.errorMessage);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_DR,false,error);messageObject.Functionality=$scope.isAddProduct?"DR Team Subscription:Add Product(s) - Submitted":"DR Team Subscription:Add Seat(s) - Submitted";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.closeAddSeat=function(){$scope.isAddSeatProcessing=false;$("#addSeatProductModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.isTransactionValid=function(transactionType){return[TransactionConstants.TRANSACTION_STANDARD_ORDER,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER,TransactionConstants.TRANSACTION_ADOBE_TRAINING_SERVICE_ORDER,TransactionConstants.TRANSACTION_QUOTATION,TransactionConstants.TRANSACTION_STANDARD_QUOTATION,TransactionConstants.TRANSACTION_DYLAN_ORDER].indexOf(transactionType)>-1};$scope.refreshTeamSubscriptionDetails=function(){$scope.viewType=_.has($scope,"viewType")?$scope.viewType:"product";$location.$$search={};$location.$$compose();var templateUrl="/team?teamId="+$scope.teamId+"&customerGuid="+$scope.customerGuid+"&viewType="+$scope.viewType;if($scope.offerId){templateUrl=templateUrl+"&offerId="+$scope.offerId}$location.url(templateUrl);location.reload()};$scope.cancelAddSeat=function(){$scope.isAddSeatProcessing=false;$("#addSeatProductModal").modal("hide")};$scope.getTotalPrice=function(product){$scope.totalPrice=product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax};$scope.isAddSeatFormValidate=function(){var isNotValidForm=true;var ddMaxValue=54600;if(!$scope.checkConflictExists()){isNotValidForm=false}if($scope.checked){if($scope.newPoNumber){isNotValidForm=false}else{isNotValidForm=true}}if($scope.productList&&!$scope.productList.length){isNotValidForm=false}if($scope.productList&&$scope.productList.length&&!isNotValidForm){angular.forEach($scope.productList,function(product){if(!product.productInfo.seatQuantity&&!isNotValidForm){isNotValidForm=true}if(product.productInfo.seatQuantity>0&&product.productInfo.seatQuantity>100){isNotValidForm=true}})}if(!$scope.totalPrice){isNotValidForm=true}if($scope.totalPrice>ddMaxValue&&$scope.paymentType==TeamConstants.PAYMENT_TYPE_DD){$scope.addSeatErrorMessage="For orders this large, please use a different payment method";isNotValidForm=true}return isNotValidForm};$scope.isAddSeatDrFormValidate=function(){var isNotValidForm=true;var ddMaxValue=54600;if(!$scope.checkDrConflictExists()){isNotValidForm=false}if($scope.productDrList&&!$scope.productDrList.length){isNotValidForm=false}if($scope.productDrList&&$scope.productDrList.length&&!isNotValidForm){angular.forEach($scope.productDrList,function(product){if(!product.productInfo.seatQuantity&&!isNotValidForm){isNotValidForm=true}if(product.productInfo.seatQuantity>0&&product.productInfo.seatQuantity>100){isNotValidForm=true}})}return isNotValidForm};$scope.checkDrConflictExists=function(){var conflictExists=false;angular.forEach($scope.productDrList,function(product){if(product.productInfo.seatQuantity){if(typeof product.productInfo.isConflictProduct!="undefined"&&product.productInfo.isConflictProduct&&!conflictExists){conflictExists=true}}});return conflictExists};$scope.checkConflictExists=function(){var conflictExists=false;angular.forEach($scope.productList,function(product){if(product.productInfo.seatQuantity&&$scope.totalPrice){if(typeof product.productInfo.isConflictProduct!="undefined"&&product.productInfo.isConflictProduct&&!conflictExists){conflictExists=true}}});return conflictExists};$scope.removeProduct=function(offerId,index){angular.forEach($scope.productList,function(product){if(product.productInfo.offerId==offerId){$scope.productList.splice(index,1)}});var i=0;angular.forEach($scope.productData,function(product){if(product.offerId==offerId){$scope.productData.splice(i,1)}i++});if(!$scope.productList.length){$scope.addSeatErrorMessage="There are no products remaining to be added."}else{$scope.addSeatErrorMessage=""}};$scope.removeDrProduct=function(offerId,index){angular.forEach($scope.productDrList,function(product){if(product.productInfo.offerId==offerId){$scope.productDrList.splice(index,1)}});var i=0;angular.forEach($scope.productData,function(product){if(product.offerId==offerId){$scope.productData.splice(i,1)}i++});if(!$scope.productDrList.length){$scope.addSeatErrorMessage="There are no products remaining to be added."}else{$scope.addSeatErrorMessage=""}};$scope.editPoNumber=function(){$scope.checked=($scope.checked)?false:true};$scope.addSeatRequest=function(){$scope.isAddSeatProcessing=true;$scope.seatOrderList=[];angular.forEach($scope.productList,function(product){var seatInfo={count:product.productInfo.seatQuantity,sku:product.productInfo.sku};$scope.seatOrderList.push(seatInfo)});$scope.addSeatRequestBody={};$scope.addSeatRequestBody.jsonValue={storeOrderNumber:"",seatOrderList:$scope.seatOrderList};if($scope.checked&&$scope.newPoNumber){$scope.addSeatRequestBody.jsonValue.poNumber=$scope.newPoNumber}else{if($scope.paymentType==TeamConstants.PAYMENT_TYPE_PO){$scope.addSeatRequestBody.jsonValue.poNumber=$scope.latestPoNumber}}if($scope.source==SalesConstants.SALES_DIRECT_SALES){$scope.notedetails="";$scope.totalSeatQty=0;$scope.productTotalSeats=0;var count=1;angular.forEach($scope.productList,function(product){$scope.currencyCode=product.priceInfo.currencyCode;if(count>1){$scope.notedetails=$scope.notedetails+" | "}$scope.notedetails=$scope.notedetails+product.productInfo.productCode+": "+product.productInfo.seatQuantity;$scope.totalSeatQty=$scope.totalSeatQty+product.productInfo.seatQuantity;if($scope.productTotalSeats==0){$scope.productTotalSeats=_.has(product,"productInfo.totalSeats")?product.productInfo["totalSeats"]:0}count++});$scope.addSeatRequestBody.note={noteType:"SUBSCRIPTION",note:$scope.notedetails,orderNumber:$scope.externalContractId,eccContractId:$scope.externalContractId,subType:"TEAM",reasonType:"SEAT_MGMT",guid:$scope.customerGuid.split("@")[0],currency:$scope.currencyCode,userId:0,agentId:0,seatsCancelled:$scope.totalSeatQty,seatsLeft:$scope.totalSeatQty+$scope.productTotalSeats,cancellationValue:$scope.totalPrice,event:{eventType:"CCT_ADD_PRODUCTS",comments:$scope.teamId.split("@")[0],guid:$scope.customerGuid.split("@")[0],userId:0,agentId:0}}}else{$scope.productSkus=$scope.productList[0].productInfo.sku;$scope.currencyCode=$scope.productList[0].priceInfo.currencyCode;$scope.seatsCancelled=$scope.productList[0].productInfo.seatQuantity;$scope.seatsLeft=$scope.productList[0].productInfo.totalSeats+$scope.seatsCancelled;$scope.productCode=$scope.productList[0].productInfo.productCode;$scope.language=$scope.productList[0].productInfo.language;$scope.addSeatRequestBody.note={noteType:"SUBSCRIPTION",note:$scope.seatsCancelled+" seat(s) added for "+$scope.productList[0].productInfo.productName,orderNumber:$scope.externalContractId,eccContractId:$scope.externalContractId,subType:"TEAM",reasonType:"SEAT_MGMT",guid:$scope.customerGuid.split("@")[0],productCode:$scope.productCode,productLanguage:$scope.language,sku:$scope.productSkus,currency:$scope.currencyCode,userId:0,agentId:0,seatsCancelled:$scope.seatsCancelled,seatsLeft:$scope.seatsLeft,cancellationValue:$scope.totalPrice,event:{eventType:"CCT_ADD_SEATS",comments:$scope.teamId.split("@")[0],guid:$scope.customerGuid.split("@")[0],userId:0,agentId:0}}}TeamService.addSeat({teamId:$scope.teamId,addSeatRequestBody:$scope.addSeatRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){$scope.isAddSeatProcessing=false;$scope.isAddSeatProcessSuccess=true;if($scope.paymentType==TeamConstants.PAYMENT_TYPE_OFFLINE){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"しばらくしたらお支払い案内メールが送られますので、お客様にその旨お伝えください")}else{if($scope.isAddProduct){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Purchased additional product(s) to existing contract.")}else{$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Purchased additional seat(s) to existing product.")}}if($scope.source==SalesConstants.SALES_DIRECT_SALES&&$scope.isSFDCFLow){$scope.updateSFDCOpportunityDetail(result,$scope.modalMessages)}var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Add Seat";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){console.log("error",result);$scope.isAddSeatProcessing=false;$scope.isAddSeatProcessSuccess=false;if(status==504){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. But this is does not necessarily imply failure. Please check the subscription after 10 minutes before attempting to reprocess.");if($scope.source==SalesConstants.SALES_DIRECT_SALES&&$scope.isSFDCFLow){$scope.updateSFDCOpportunityDetail(result,$scope.modalMessages)}}else{errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message)}var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Add Seat";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.applyDrSwapProduct=function(productForSwap){$scope.newReviewAddProducts=angular.copy($scope.addSeatProductObjs);angular.forEach($scope.newReviewAddProducts.cartItems,function(cartItem){if(cartItem.offerId==productForSwap.productInfo.offerId){cartItem.offerId=productForSwap.productInfo.swapProductDetails.offerId;cartItem.quantity=productForSwap.productInfo.seatQuantity}});angular.forEach($scope.newReviewAddProducts.productData,function(prodData){if(prodData.offerId==productForSwap.productInfo.offerId){prodData.isConflictProduct=false;prodData.primaryImageUrl=productForSwap.productInfo.swapProductDetails.primaryImageUrl;prodData.productName=productForSwap.productInfo.swapProductDetails.productName;prodData.sku=productForSwap.productInfo.swapProductDetails.sku;prodData.pricePoint=productForSwap.productInfo.swapProductDetails.pricePoint;prodData.offerId=productForSwap.productInfo.swapProductDetails.offerId}});$scope.addDRSeatProduct($scope.newReviewAddProducts)};$scope.applySwapProduct=function(swapProductDetails){var parallelApiCalls=[];$scope.swapProducts=[];angular.forEach($scope.productData,function(product){if(product.productCode==swapProductDetails.productCode){$scope.swapProducts.push(swapProductDetails)}else{$scope.swapProducts.push(product)}});$scope.productData=[];$scope.productData=$scope.swapProducts;angular.forEach($scope.swapProducts,function(product){$scope.isAddSeatLoading=true;var addProductInfo={};$scope.productList=[];product.seatQuantity=_.has(product,"seatQuantity")?parseInt(product.seatQuantity):1;addProductInfo.priceInfo={};addProductInfo.productInfo=product;parallelApiCalls.push(TeamService.getPricingData({teamId:$scope.teamId,offerId:product.offerId}).success(function(result,status,headers,config){addProductInfo.priceInfo=TeamUtil.getTeamAddSeatPriceDetails(result.countryPriceData[0]);$scope.currentBillingPrice=addProductInfo.priceInfo.currentPriceWithoutTax;$scope.currencyCode=addProductInfo.priceInfo.currencyCode;$scope.productList.push(addProductInfo);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){console.log("error",result);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Get Pricing Data";AppUtils.sendLogToServer(messageObject,status,headers,config)}))});$q.all(parallelApiCalls).then(function(value){$scope.isAddSeatLoading=false;$scope.totalPrice=0;angular.forEach($scope.productList,function(product){$scope.totalPrice=$scope.totalPrice+product.priceInfo.currentPriceWithoutTax+(product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax)})},function(reason){console.log("All call fail");$scope.isAddSeatLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Unable fetch the price details. Please try again.")})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Team_Id=$scope.teamId;messageObject.Customer_Guid=$scope.customerGuid;messageObject.OfferId=$scope.offerId?$scope.offerId:"";messageObject.viewType=$scope.viewType?$scope.viewType:"";messageObject.fulfilledEntitlementId=$scope.fulfilledEntitlementId?$scope.fulfilledEntitlementId:"";messageObject.productCode=$scope.productCode?$scope.productCode:"";messageObject.productLanguage=$scope.productLanguage?$scope.productLanguage:""}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_CRM){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Customer_No=$scope.customerNo}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_DR){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_DR;messageObject.Team_Id=$scope.teamId;messageObject.Customer_Guid=$scope.customerGuid;messageObject.OfferId=$scope.offerId?$scope.offerId:"";messageObject.viewType=$scope.viewType?$scope.viewType:"";messageObject.fulfilledEntitlementId=$scope.fulfilledEntitlementId?$scope.fulfilledEntitlementId:"";messageObject.cartId=result&&result.cartId?result.cartId:""}}}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};$scope.updateSFDCOpportunityDetail=function(result,message){var messageObject={Source_System:SFDCConstants.SOURCE_SYSTEM_SFDC};$scope.saccountID=$routeParams.saccountID;$scope.scontactID=$routeParams.scontactID;$scope.sopportunityID=$routeParams.sopportunityID;$scope.asynchId=$routeParams.asynchId;SFDCService.updateSFDCOpportunityDetail({oppID:$scope.sopportunityID,process:"AbdApi.UpdateOpportunity",message:message,order:{orderId:"",asynchId:$scope.asynchId}}).success(function(result,status,headers,config){messageObject.Functionality="Update Opportunity - Add Product";messageObject.Flow=SalesConstants.SALES_DIRECT_SALES;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=result.message;messageObject.info=message;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){messageObject.Functionality="Update Opportunity - Add Product";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.Flow=SalesConstants.SALES_DIRECT_SALES;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=error.toString();messageObject.info=message;AppUtils.sendLogToServer(messageObject,status,headers,config)})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("ApiHubRequestDto",{urlKey:"",pathVariables:{},queryParameters:{},requestBody:{},requestBodyType:"application/json",responseBodyType:"application/json"});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("APOService",["$http",function($http){var service={};var transform=function(data){return $.param(data)};var transform2=function(data){return $.customParam(data)};service.sendEmail=function(data,templateName){return $http({method:"POST",url:"../apoService/sendEmail.do?templateName="+templateName+"&locale=en_US",headers:{"Content-Type":"application/json",Accept:"text/plain"},data:data})};service.getEmails=function(requestObj){return $http({method:"GET",url:"../apoService/getEmails.do?recipientId="+encodeURIComponent(requestObj.email)+"&startDate="+encodeURIComponent(requestObj.startDateTime)+"&endDate="+encodeURIComponent(requestObj.endDateTime)+"&expanded=true",headers:{"Content-Type":"application/json",Accept:"text/plain"}})};service.getEmailDetails=function(requestId){return $http({method:"GET",url:"../apoService/getEmails.do?requestId="+requestId+"&expanded=true",headers:{"Content-Type":"application/json",Accept:"text/plain"}})};return service}]);var dependencies=["hxApp.directive","hxApp.filters","hxApp.services","hxApp.controllers","ui","hxApp.loading","LocalStorageModule","localization","ngRoute"];var app=app||angular.module("hxApp",dependencies);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/login",{templateUrl:"js/user/partials/login.html",controller:"UserCtrl",title:"Login"}).when("/setting",{templateUrl:"js/user/partials/setting.html",controller:"SettingCtrl",title:"User Setting"}).otherwise({redirectTo:"/search",title:"Search"});$httpProvider.interceptors.push(function($q,$rootScope,$location){return{request:function(config){if(config&&config.url.indexOf(".do")>0){var logMessage="Service Request : "+config.url.split("/")[1]+" -> "+config.url.split("/")[2]}return config},requestError:function(rejection){return $q.reject(rejection)},response:function(response){if(response&&response.config.url.indexOf(".do")>0){var logMessage="Success : "+response.config.url.split("/")[1]+" -> "+response.config.url.split("/")[2]+" -> ";console.info("%c"+logMessage,"color:blue;font-weight:bold",response.data)}worker.postMessage("start");return response},responseError:function(rejection){if(rejection&&rejection.config&&rejection.config.url.indexOf(".do")>0){var logMessage="Error : "+rejection.config.url.split("/")[1]+" -> "+rejection.config.url.split("/")[2]+" -> ";console.error("%c"+logMessage,"color:red;font-weight:bold",rejection.data)}var status=rejection.status;if(status==403){var deferred=$q.defer();var req={config:rejection.config,deferred:deferred};if($location.path().indexOf("login")==-1){window.sessionStorage.returnUrl=encodeURIComponent($location.path());$rootScope.returnUrl=encodeURIComponent($location.path())}if(encodeURIComponent($location.path()).indexOf("login")==-1){$rootScope.rediretUrl=encodeURIComponent($location.path())}worker.postMessage("stop");localStorage.setItem("ls.isValidUser",false);$location.path("/login");return deferred.promise}return $q.reject(rejection)}}})}]).run(["$rootScope","$templateCache","Utils","$route","$location","features",function($rootScope,$templateCache,Utils,$route,$location,features){$("#wrapperDiv").show();if(features.isFeatureEnabled("msdynamics")){updateStylesForMSD()}$rootScope.$on("$viewContentLoaded",function(){$templateCache.removeAll()});$rootScope.$on("$routeChangeSuccess",function(event,current,previous){if(current&&current.$route&&current.$route.title){Utils.pageTitle(current.$route.title)}});$rootScope.skipReload=false;$rootScope.lastRoute=$route.current;$rootScope.$on("$locationChangeSuccess",function(){if($rootScope.skipReload&&$route.current.$$route.controller==$rootScope.lastRoute.$$route.controller){$route.current=$rootScope.lastRoute;$rootScope.skipReload=false}else{$rootScope.lastRoute=$route.current}});$location.skipReload=function(){$rootScope.skipReload=true;return $location}}]);app.factory("location",["$location","$route","$rootScope",function($location,$route,$rootScope){$location.skipReloadController=function(){var lastRoute=$route.current;var un=$rootScope.$on("$locationChangeSuccess",function(){if($route.current.$$route.controller==lastRoute.$$route.controller){$route.current=lastRoute;un()}});return $location};return $location}]);var lastCustomerCached=null;var transform=function(data){return $.param(data)};jQuery.fn.highlight=function(){$(this).each(function(){var el=$(this);el.before("<span/>");el.prev().width(el.width()).height(el.height()).css({position:"absolute","background-color":"#ffff99",opacity:".9"}).delay(500).fadeOut(500)})};Array.prototype.unique=function(){var a=this.concat();for(var i=0;i<a.length;++i){for(var j=i+1;j<a.length;++j){if(a[i]===a[j]){a.splice(j--,1)}}}return a};Array.prototype.unset=function(value){if(this.indexOf(value)!=-1){this.splice(this.indexOf(value),1)}};String.prototype.replaceAll=function(replaceThis,withThis){var re=new RegExp(RegExp.quote(replaceThis),"g");return this.replace(re,withThis)};jQuery.fn.center=function(){this.css("position","absolute");this.css("top",Math.max(0,(($(window).height()-$(this).outerHeight())/2)+$(window).scrollTop())+"px");this.css("left",Math.max(0,(($(window).width()-$(this).outerWidth())/2)+$(window).scrollLeft())+"px");return this};angular.resetForm=function(scope,formName,defaults){$("form[name="+formName+"], form[name="+formName+"] .ng-dirty").removeClass("ng-dirty").addClass("ng-pristine");var form=scope[formName];if(!form){return}form.$dirty=false;form.$pristine=true;for(var field in form){if(form[field].$pristine===false){form[field].$pristine=true}if(form[field].$dirty===true){form[field].$dirty=false}}for(var d in defaults){scope[d]=defaults[d]}};Array.prototype.clean=function(deleteValue){for(var i=0;i<this.length;i++){if(this[i]==deleteValue){this.splice(i,1);i--}}return this};function isNumber(evt){evt=(evt)?evt:window.event;var charCode=(evt.which)?evt.which:evt.keyCode;if(charCode>31&&(charCode<48||charCode>57)){return false}return true}function maxLengthCheck(object){if(object.value.length>object.maxLength){object.value=object.value.slice(0,object.maxLength)}}function JSONToCSVConvertor(JSONData,ReportTitle,ShowLabel){var arrData=typeof JSONData!="object"?JSON.parse(JSONData):JSONData;var CSV="";CSV+=ReportTitle+"\r\n\n";if(ShowLabel){var row="";for(var index in arrData[0]){row+=index+","}row=row.slice(0,-1);CSV+=row+"\r\n"}for(var i=0;i<arrData.length;i++){var row="";for(var index in arrData[i]){row+='"'+arrData[i][index]+'",'}row.slice(0,row.length-1);CSV+=row+"\r\n"}if(CSV==""){alert("Invalid data");return}var fileName="";fileName+=ReportTitle.replace(/ /g,"_");var uri="data:application/csv;charset=utf-8,"+escape(CSV);var link=document.createElement("a");link.href=uri;link.style="visibility:hidden";link.download=fileName+".csv";document.body.appendChild(link);link.click();document.body.removeChild(link)}function deleteCookie(cookieName){try{document.cookie=cookieName+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";console.log("Cookie "+cookieName+" deleted")}catch(error){console.log("Error while deleting cookie "+cookieName,error)}}var QueryString=function(){var query_string={};var query=window.location.hash.split("?")[1];var vars;if(query!=undefined){vars=query.split("&")}else{return}for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(typeof query_string[pair[0]]==="undefined"){query_string[pair[0]]=decodeURIComponent(pair[1])}else{if(typeof query_string[pair[0]]==="string"){var arr=[query_string[pair[0]],decodeURIComponent(pair[1])];query_string[pair[0]]=arr}else{query_string[pair[0]].push(decodeURIComponent(pair[1]))}}}return query_string}();function updateStylesForMSD(){$("body").css("background-color","transparent");$(".container > #mainView").css({"margin-top":"5px"})}var app=app||angular.module("hxApp",["ngRoute"]);app.constant("AppConstants",{MODULE_INIT_METADATA_SUCCESS:"METADATA_SUCCESS",MODULE_INIT_METADATA_FAILED:"METADATA_FAILED",DB_SUCCESS:"success",DB_FAILED:"failed ",MODULE_SUPER:"SUPERMODULE ",MODULE_SALES:"SALES ",MODULE_TEAM:"Team Subscription",MODULE_JILTEAM:"Team v2 Subscription",MODULE_SFDC:"SFDC ",ALERT_MESSAGE_ERROR_TYPE:"E",ALERT_MESSAGE_INFO_TYPE:"I",ALERT_MESSAGE_SUCCESS_TYPE:"S",ALERT_MESSAGE_WARNING_TYPE:"W",PRODUCTS_MODEL_CODE_INDIVIDUAL:"INDIVIDUAL",PRODUCTS_MODEL_CODE_TEAM_DIRECT:"TEAM_DIRECT",PRODUCTS_MODEL_CODE_ENTERPRISE:"ENTERPRISE",PRODUCTS_MODEL_CODE_PERPETUAL:"PERPETUAL",MESSAGE_ERROR_TYPE:"error",MESSAGE_INFO_TYPE:"info",MESSAGE_SUCCESS_TYPE:"success",MESSAGE_WARNING_TYPE:"warning",SERVICE_MESSAGE_SUCCESS:"Service is successful",SERVICE_MESSAGE_UNSUCCESS:"Service is unsuccessful",SERVICE_MESSAGE_SUCCESS_WITH_WARNING:"Service is success with warning",MARKET_TYPE_COMMERCIAL:"COM",MARKET_TYPE_EDUCATIONAL:"EDU",EMAIL_VERIFIED:"true",EMAIL_NOT_VERIFIED:"false",LANGUAGES:[{code:"EN",value:"EN - English",dbName:"Hx5-Metadata"},{code:"JA",value:"JP - Japanese",dbName:"Hx5-Metadata-JP"}],DEFAULT_LANGUAGE:"EN",HENDRIX_PROD:"hendrixprod.corp.adobe.com",HENDRIX_S2:"hendrix-s2.corp.adobe.com",HENDRIX_S4:"hendrix-s4.corp.adobe.com",HENDRIX_D2:"hendrix-d2.corp.adobe.com",HENDRIX_D4:"hendrix-d4.corp.adobe.com",HENDRIX_FIX:"hendrix-fix.corp.adobe.com",HENDRIX_TRAINING:"hendrix-trn.corp.adobe.com",TOOLS_NONJP:{Fileshare:"https://fileshare.corp.adobe.com","HDX5 Quick Reference Guide":"https://helpx-internal.corp.adobe.com/content/help/en/x-productkb/policy-pricing/hendrix-html-5.html","ABO Tool":"https://abo.services.adobe.com","Activation Server":"https://csapp.licensingstack.com/cservice/index.jsp",CRM:"http://sap-cm3ap1.corp.adobe.com:8001/sap/bc/bsp/sap/crm_ic/default.htm",Worldpay:"https://secure.worldpay.com/sso/public/auth/login.html","Cyber Source":"https://ebc.cybersource.com/ebc/login/Login.do","DNR- SN Server":"https://coho.corp.adobe.com/cgi-bin/WebObjects/SNServer.woa/1080/wo/nnhOyQOVqqiQrUKfEzOv8M/0.0","DIGITAL RIVER":"https://gc.digitalriver.com/gc/ent/login.do",LWS:"https://licensing.adobe.com/sap(bD1lbiZjPTAwMw==)/bc/bsp/sap/zavllogin/login.htm","Unlocking Tool":"https://lockunlock.corp.adobe.com/LockUnlock/challenge/welcome","Case Notes Search Tool":"https://helpx-internal.corp.adobe.com/content/help/en/customer-insight/casenotes.html","HDX5 Admin Tool":"http://sj1glm088.corp.adobe.com:8888/notestemplate/notes.login.html/#/notesadmin","Knowledge Base - New!":"https://adobe.my.salesforce.com/apex/Km_AgentSearchResults?sfdc.tabName=01r14000001KUnq"},TOOLS_JP:{Fileshare:"https://fileshare.corp.adobe.com","HDX5 Quick Reference Guide":"https://helpx-internal.corp.adobe.com/content/help/en/x-productkb/policy-pricing/hendrix-html-5.html","Serial Recorder":"https://coho.corp.adobe.com/cgi-bin/WebObjects/SNServer.woa/",SLDB:"https://adobe-academic.jp/l/",LWS:"https://licensing.adobe.com/sap(bD1lbiZjPTAwMw==)/bc/bsp/sap/zavllogin/login.htm","Upgrade Unlocking":"http://unlock-new.corp.adobe.com/default.nsf",CSEC:"http://coho.corp.adobe.com/cgi-bin/WebObjects/CSEC.woa/17/wo/Ol2000cs300jE700a1/0.7.0",ABO:"https://abo.services.adobe.com","Adobe Software Activation System":"https://csactivate.adobe.com/cservice/index.jsp","MPEG Encoder":"http://www.adobe.com/special/encoderactivation/sw_activation02.html","Adobe MPEG Encoder Activation":"http://www.adobe.com/motion/mpegactivation.html","Adobe Encoder Activation":"http://www.adobe.com/special/encoderactivation/sw_activation.html","Sagawa Website":"http://k2k.sagawa-exp.co.jp/p/sagawa/web/okurijoinput.jsp","Creative Cloud":"https://creative.adobe.com/",IKBS:"https://internalapps.adobe.com/cfusion/intranet/support/search/index.cfm?loc=ja","Service Status":"http://csbuservicesstatus.adobe.com/","Activation System":"https://csapp.licensingstack.com/cservice/index.jsp",Worldpay:"https://secure.worldpay.com/sso/public/auth/login.html","Case Notes Search Tool":"https://helpx-internal.corp.adobe.com/content/help/en/customer-insight/casenotes.html","HDX5 Admin Tool":"http://sj1glm088.corp.adobe.com:8888/notestemplate/notes.login.html/#/notesadmin","Knowledge Base - New!":"https://adobe.my.salesforce.com/apex/Km_AgentSearchResults?sfdc.tabName=01r14000001KUnq"},CCM_INDIVIDUAL_PRODUCT_NAME:"CCSN",CCM_TEAM_PRODUCT_NAME:"CCLE",CCM_TEAM_PRODUCT_TYPE:"CCMT",TEMPLATE_DEFAULT_EDU:"template_default_edu",TEMPLATE_EDU_ORDER:"template_edu_order",TEMPLATE_DEFAULT_RETURN:"template_default_return",TEMPLATE_RETURN_ORDER:"template_return_order",TEMPLATE_GO_CART_CS_CASE:"template_go_cart_cs_case",TEMPLATE_GO_CART_CS_CASE_FOR_GID_LOOKUP:"template_go_cart_default_cs_case",TEMPLATE_CREDIT_MEMO_RETURN_ORDER:"template_credit_memo_return_order",TEMPLATE_DEFAULT_CS_ENTERPRISE:"template_default_cs_enterprise",TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE:"template_default_subscription_cs_case",TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE:"template_default_subscription_ts_case",SHIPPING:"shipping",BILLING:"billing",STORE_TYPE_EDU:"EDU",STORE_TYPE_COM:"COM",STORE_TYPE_COMMERCIAL:"Commercial",STORE_TYPE_EDUCATIONAL:"Educational",MARKETING_CLASS_NAME_BY_REGIONS:{ROW:"0105MKTGSURVEYEMEA",NA:"MKTGCORESURVEY",JP:"0105MKTGSURVEYJP",EMEA:"0105MKTGSURVEYEMEA",APAC:"0105MKTGSURVEYEMEA"},TRACKING_CHANNEL_USER:"User",TRACKING_CHANNEL_TRANSACTION:"Transaction",TRACKING_CHANNEL_CASE:"Cases",TRACKING_CHANNEL_SYSTEM:"System",TRACKING_PAGE_SYSTEM_ERROR:"System Error: ",COUNTRY_CODE_JAPAN:"JP",COUNTRY_CODE_US:"US",NON_JP_REGION_FIELD_STREET1_LENGTH:35,NON_JP_REGION_FIELD_STREET2_LENGTH:35,NON_JP_REGION_FIELD_STREET3_LENGTH:35,NON_JP_REGION_FIELD_CITY_LENGTH:35,NON_JP_REGION_FIELD_POSTAL_CODE_LENGTH:10,NON_JP_REGION_FIELD_COMPANY_NAME_LENGTH:40,NON_JP_REGION_FIELD_ACCOUNT_HOLDERS_NAME_LENGTH:40,NON_JP_REGION_FIELD_TELEPHONE_MIN_LENGTH:6,JP_REGION_FIELD_STREET1_LENGTH:17,JP_REGION_FIELD_STREET2_LENGTH:17,JP_REGION_FIELD_STREET3_LENGTH:17,JP_REGION_FIELD_CITY_LENGTH:17,JP_REGION_FIELD_POSTAL_CODE_LENGTH:10,JP_REGION_FIELD_COMPANY_NAME_LENGTH:40,JP_REGION_FIELD_ACCOUNT_HOLDERS_NAME_LENGTH:20,JP_REGION_FIELD_FIELD_TELEPHONE_MIN_LENGTH:6,SELLABLE_COMMERCIAL_COUNTRIES:"us,au,at,gb,fr,de,jp,se,dk,no,ch,ie,mx,ca,nz,pt,be,cz,fi,pl,it,lu,nl,es,za",SELLABLE_EDUCATIONAL_COUNTRIES:"us,au,at,gb,fr,de,jp,se,dk,no,ch,ie,mx,ca,nz,pt,be,cz,fi,pl,it,lu,nl,es",NOT_SELLABLE_COMMERCIAL_COUNTRIES:"",NOT_SELLABLE_EDUCATIONAL_COUNTRIES:"za",CUSTOMER_WEB_GUID:"ZGUID",ADD_REMINDER_EVENT:"ADD_REMINDER_EVENT",SEARCH_RESULT_TYPE_IMS:"I",SEARCH_RESULT_TYPE_E_COMMERCE:"E",PRODUCT_TYPE_IBASE:"IBASE",PRODUCT_TYPE_ENT:"ENT",PRODUCT_TYPE_ALL:"",PRODUCT_TYPE_TEAM:"CCT",ENTERPRISE_SUPPORT_ID:"Enterprise-Support@adobe.com",ENTERPRISE_SUPPORT_ID_TEXT:"Enterprise-Support@adobe.com(Enterprise Support)",SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT:"SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT",PRODUCTS_VIEW_SELECT_EVENT:"PRODUCTS_VIEW_SELECT_EVENT",SUBSCRIPTION_VIEW_SELECT_EVENT:"SUBSCRIPTION_VIEW_SELECT_EVENT",UPDATE_CS_PRODUCT_VIEW_CONTEXT_EVENT:"UPDATE_CS_PRODUCT_VIEW_CONTEXT_EVENT",UPDATE_CS_SUBSCRIPTION_VIEW_CONTEXT_EVENT:"UPDATE_CS_SUBSCRIPTION_VIEW_CONTEXT_EVENT",UPDATE_TS_PRODUCT_VIEW_CONTEXT_EVENT:"UPDATE_TS_PRODUCT_VIEW_CONTEXT_EVENT",UPDATE_TS_SUBSCRIPTION_VIEW_CONTEXT_EVENT:"UPDATE_TS_SUBSCRIPTION_VIEW_CONTEXT_EVENT",UPDATE_CLOSE_POPUP_EVENT:"UPDATE_CLOSE_POPUP_EVENT",ADOBE_IO_BEHANCE_API_URL:"https://cc-api-behance-stage.adobe.io/v2/users/",ADOBE_IO_SERVICE_TOKEN_ID:"HendrixService1",GENUINE_SUCCESSFULL:"Y27",GENUINE_UNSUCCESSFULL:"Y28",PRODUCT_CATEGORIES:[{name:"mp",productCodes:"CCSN, STOS, ACRO",type:"Most Popular Collection"},{name:"dc",productCodes:"ACRO, APRO",type:"Acrobat DC Collection"},{name:"cc",productCodes:"CCSN, CCSK, STOS",type:"Creative Cloud Collections"},{name:"pc",productCodes:"PHSP, PHSK, PHLT",type:"Adobe Photoshop Collections"},{name:"stock",productCodes:"STKL, STKM, STKS, STOS",type:"Adobe Stock Collections"}],SOURCE_SYSTEM_JIL_SDS:"JIL & SDS",SOURCE_SYSTEM_JIL_DR:"JIL & DR",SOURCE_SYSTEM_IMS_RENGA:"IMS & RENGA",SOURCE_SYSTEM_CRM:"CRM",SOURCE_SYSTEM_SFDC:"SFDC",SOURCE_SYSTEM_COMMERCE:"COMMERCE",SOURCE_SYSTEM_ANYWARE:"ANYWARE",SOURCE_SYSTEM_JIL:"JIL",SOURCE_SYSTEM_RENGA:"RENGA",SOURCE_SYSTEM_DR:"DR",SOURCE_SYSTEM_COMMERCE_DB:"COMMERCE_DB",SERVICE_INVOKE_GET_PRODUCT_CATALOG:"SERVICE_INVOKE_GET_PRODUCT_CATALOG",SERVICE_INVOKE_ORDER_SERVICE:"SERVICE_INVOKE_ORDER_SERVICE",SERVICE_INVOKE_CONTRACT_CART_SERVICE:"SERVICE_INVOKE_CONTRACT_CART_SERVICE",SERVICE_INVOKE_QUOTE_SERVICE:"SERVICE_INVOKE_QUOTE_SERVICE",SERVICE_INVOKE_TOKEN_GENERATE:"SERVICE_INVOKE_TOKEN_GENERATE",SERVICE_INVOKE_CREATE_CUSTOMER:"SERVICE_INVOKE_CREATE_CUSTOMER",SERVICE_INVOKE_SEARCH_CUSTOMER:"SERVICE_INVOKE_SEARCH_CUSTOMER",SERVICE_INVOKE_CANCEL_SUBSCRIPTION:"SERVICE_INVOKE_CANCEL_SUBSCRIPTION",SERVICE_INVOKE_SKU_SEARCH:"SERVICE_INVOKE_SKU_SEARCH",ORDER_SERVICE_IN_PROGRESS:"IN_PROGRESS",ORDER_SERVICE_SUBMITTED:"SUBMITTED",TRANSACTION_TYPE_SUBSCRIPTION_QUOTE:"ZSAG",APO_TEMPLATES:[{templateName:"anyware_bounceback_caseclosed",description:"ENT customer reply to a closed case"},{templateName:"anyware_bounceback_error",description:"ENT customer replied to a case using an unrecognized email"},{templateName:"csr_fileshare_customer_activation",description:"Fileshare account activation notification"},{templateName:"crm_quote",description:"Quotation message"},{templateName:"hendrix_notification",description:"New case created notification"},{templateName:"hendrix_notification_antipiracy_notgenuine",description:"Product license is not genuine notification"},{templateName:"hendrix_notification_antipiracy_sendURL",description:"Product license is invalid notification"},{templateName:"ecomm_ccm_order_received",description:"Payment received notification"},{templateName:"ecc_ccm_stock_suspend_reject",description:"Preffered payment method failed"},{templateName:"ecc_cc_expiration_email",description:"Credit Card about to expire notification"},{templateName:"ecc_ccm_cc_exp_email",description:"CCM Credit Card about to expire notification"},{templateName:"ecc_ccm_invoice_email",description:"Payment confirmation, invoice download link"},{templateName:"ecc_ccm_cc_attempt_day7_email",description:"Payment past due, day 7"},{templateName:"ecomm_stock_order_received",description:"Stock payment received notification"},{templateName:"ecc_ccm_cc_attempt_day14_email",description:"Payment past due, day 14, cancellation warning"},{templateName:"ecc_DC_suspend_reject",description:"Payment failed, update payment information"},{templateName:"ecomm_acbt_order_received",description:"Subscription order confirmation"},{templateName:"ecc_ccm_cc_attempt_day21_email",description:"Fourth billing attempt failed (day 21)"},{templateName:"ecomm_ccm_acrobat_order_received",description:"Acrobat subscription order confirmation"},{templateName:"ecc_ccm_cc_attempt_day28_email",description:"Final billing failure (day 28)"},{templateName:"ecc_ccm_day7_no_cc_email",description:"CC membership about to expire"},{templateName:"jaq_adminui_CCE_COMPLETE_provisioned",description:"CCE access confirmation"},{templateName:"jaq_adminui_adobe_deprovisioned",description:"Access removed notification"},{templateName:"ecomm_order_received",description:"Adobe Store order confirmation"},{templateName:"ecomm_esd",description:"Electronic Software Downloads Serial Numbers"},{templateName:"jem_stock_suspended_reject_email",description:"Credit card expired notice"},{templateName:"yoda_ccm_sub_update_renewal_email",description:"CC membership updated notification"},{templateName:"tdrc_captivate",description:"Captivate trial confirmation email"},{templateName:"ecomm_jem_order_received",description:"CCT payment confirmation"},{templateName:"ecomm_acbt_dsp_order_received",description:"Acrobat order confirmation"},{templateName:"ecc_forms_suspend_reject",description:"FormsCentral subscription suspended"},{templateName:"ecc_invoice_pdf_renew",description:"Subscription renewed notification"},{templateName:"yoda_apro_sub_update_renewal",description:"Subscription changed notification"},{templateName:"ecomm_stock_demand_order_received",description:"Stock payment confirmation"},{templateName:"jaq_adminui_DCE_provisioned",description:"DCE access confirmation"},{templateName:"jaq_adminui_CCE_SINGLE_provisioned",description:"CCE access confirmation"},{templateName:"connecttrial_day0_meetings",description:"Adobe Connect trial confirmation"},{templateName:"jaq_adminui_DCE_proOnly_provisioned",description:"DCE welcome email"},{templateName:"jil_loyalty_changed_membership",description:"Adobe Value Incentive Plan welcome email"},{templateName:"tdrc_presenter",description:"Adobe Presenter trial confirmation"},{templateName:"connecttrial_day0_webinars",description:"Adobe Connect Webinars trial confirmation"},{templateName:"jaq_adminui_CCE_CUSTOM_provisioned",description:"CCE access confirmation"},{templateName:"connecttrial_day0_learning",description:"Adobe Connect Learning trial confirmation"},{templateName:"yoda_CREATEPDF_SUBSCR_UPDATED",description:"Subscription changed notification"},{templateName:"tdrc_coldfusion",description:"AdobeColdFusion trial confirmation"},{templateName:"jaq_adminui_DMA_analytics_provisioned",description:"Adobe Analytics access confirmation"},{templateName:"tdrc_framemaker",description:"Adobe FrameMaker trial confirmation"},{templateName:"jem_acro_sub_update",description:"Subscription changed notification"},{templateName:"jaq_adminui_DCE_standardOnly_provisioned",description:"DCE access confirmation"},{templateName:"ecomm_held_order_cancelled",description:"Duplicate order notification"},{templateName:"tdrc_robohelp",description:"Adobe RoboHelp trial confirmation"},{templateName:"tdrc_director",description:"Adobe Director trial confirmation"},{templateName:"crm_quote",description:"Adobe Quote email"},{templateName:"ecc_printpublish_suspend_reject",description:"Credit card billing failed"}],API_HUB_BODY_TYPE_XML:"application/xml",API_HUB_BODY_TYPE_JSON:"application/json",API_HUB_URL_KEY_SAP_PRODUCTS_GET_PRODUCTS:"sap-products-getProducts"});var app=app||angular.module("hxApp.directive",[]);app.directive("hxAlertMessages",["AppConstants",function(AppConstants){return{restrict:"E",scope:{messages:"="},replace:true,templateUrl:"js/common/partials/app-messages.html",link:function($scope,element,attrs){$scope.AppConstants=AppConstants;$scope.selectedMessageType=AppConstants.ALERT_MESSAGE_ERROR_TYPE;$scope.setSelectedType=function(messageType){$scope.selectedMessageType=messageType;$scope.showExpandedMessage()};$scope.showAllItems=function(){$scope.selectedMessageType="";$scope.showExpandedMessage()};$scope.toggleClassName=function($event){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseShowMessages").hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseShowMessages").removeClass().addClass(accordionClassName)};$scope.showExpandedMessage=function(){$("i").removeClass().addClass("glyphicon glyphicon-minus pull-right");$("#collapseShowMessages").removeClass().addClass("panel-collapse collapse in")}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("AppPodServices",["$http","AppConstants",function($http,AppConstants){var transform=function(data){return $.customParam(data)};var service={searchCustomer:function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:transform,data:data})},getCustomerDetails:function(data){return $http({method:"POST",url:"../customerRecordService/getItem.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data,transformResponse:function(data,headerGetters){try{data=angular.fromJson(data)}catch(err){console.log("Fail to convert into JSON object")}return data}})},getTransaction:function(data){return $http({method:"POST",url:"../transactionService/getTransaction.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},reviewTransaction:function(data){return $http({method:"POST",url:"../transactionService/review.do",data:data})},createTransaction:function(data){return $http({method:"POST",url:"../transactionService/create.do",data:data})},getBehanceProfileDetails:function(data){return $http({method:"GET",url:AppConstants.ADOBE_IO_BEHANCE_API_URL+data+"?api_key="+AppConstants.ADOBE_IO_SERVICE_TOKEN_ID,data:data})},};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("$app",["AppConstants",function(AppConstants){var loadingDiv=$('<div class="modal fade" id="loadingDialog" data-backdrop="static" data-keyboard="false" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><img src="img/ajax-loader.gif" class="img-spin"/></div></div></div></div></div></div>');var loadingMessageDiv=$('<div class="modal fade" id="loadingMessageDialog" data-backdrop="static" data-keyboard="false" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"><img src="img/ajax-loader.gif" class="img-spin"/><span id="loadingMessageContent"></span></div></div></div></div></div></div>');var service={showLoading:function(loadingMessage){if(loadingMessage){loadingMessageDiv.find("#loadingMessageContent").html(loadingMessage+" ...");loadingMessageDiv.modal()}else{loadingDiv.modal()}},hideLoading:function(){loadingDiv.modal("hide");loadingMessageDiv.modal("hide")},getMessages:function(){var messageList=[];switch(arguments.length){case 1:if(typeof arguments[0]==="string"){messageList.push({type:AppConstants.ALERT_MESSAGE_ERROR_TYPE,description:args[0]})}else{if(Array.isArray(arguments[0])){angular.forEach(arguments[0],function(item){var messageType=new Object();messageType.type=item.type;messageType.description=item.text;messageList.push(messageType)})}}break;case 2:if(typeof arguments[0]==="string"&&typeof arguments[1]==="string"){if(angular.uppercase(arguments[0])==AppConstants.ALERT_MESSAGE_ERROR_TYPE||angular.uppercase(arguments[0])==AppConstants.ALERT_MESSAGE_WARNING_TYPE||angular.uppercase(arguments[0])==AppConstants.ALERT_MESSAGE_INFO_TYPE||angular.uppercase(arguments[0])==AppConstants.ALERT_MESSAGE_SUCCESS_TYPE){messageList.push({type:arguments[0],description:arguments[1]})}else{if(angular.uppercase(arguments[1])==AppConstants.ALERT_MESSAGE_ERROR_TYPE||angular.uppercase(arguments[1])==AppConstants.ALERT_MESSAGE_WARNING_TYPE||angular.uppercase(arguments[1])==AppConstants.ALERT_MESSAGE_INFO_TYPE||angular.uppercase(arguments[1])==AppConstants.ALERT_MESSAGE_SUCCESS_TYPE){messageList.push({type:arguments[1],description:arguments[0]})}}}break}return messageList},resetMessages:function(messagesObject){return messagesObject=null}};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("AppUtils",["$rootScope","$app","Utils","TrackingService","MetadataService","$location","AppConstants","ProductInformationConstants","MessageDto","CustomerRecordService","ImsCustomerService","LoggerService","PaymentConstants","TransactionConstants",function($rootScope,$app,Utils,TrackingService,MetadataService,$location,AppConstants,ProductInformationConstants,MessageDto,CustomerRecordService,ImsCustomerService,LoggerService,PaymentConstants,TransactionConstants){this.initializeModule=function(moduleName,moduleCallBack){$app.showLoading();Utils.pageTitle(moduleName);TrackingService.trackPageView(moduleName,moduleName+" View ");MetadataService.initializeModule(moduleName,function(metadata,dbStatus){dbStatus==AppConstants.DB_SUCCESS?moduleCallBack(metadata,AppConstants.MODULE_INIT_METADATA_SUCCESS):moduleCallBack(metadata,AppConstants.MODULE_INIT_METADATA_FAILED)})};this.getSingleMessage=function(type,message){var messages=[];var messageDto=angular.copy(MessageDto);messageDto.type=type;messageDto.text=message;if(type=="error"){messageDto.error=true}else{if(type=="success"){messageDto.success=true}}messages.push(messageDto);return messages};this.getMultipleMessages=function(messagesList){var messages=[];angular.forEach(messagesList,function(message){if(angular.isDefined(message.number)&&(message.number==193||message.number=="193")){}else{if(message.type=="E"){var messageDto=angular.copy(MessageDto);messageDto.type=AppConstants.MESSAGE_ERROR_TYPE;messageDto.text=message.text;messages.push(messageDto)}}});return messages};this.validatePostalCode=function(postalCode){var message=[];if(!(postalCode&&postalCode.match(/^\d{3}-\d{4}$/))){return this.getSingleMessage("error","Invalid format of Postal code. Please enter in the valid format of XXX-XXXX.")}return message};this.getProductThumbnailImage=function(productName){for(var count=0;count<ProductInformationConstants.PRODUCT.length;count++){if(productName.indexOf(ProductInformationConstants.PRODUCT[count].name)>=0){return ProductInformationConstants.PRODUCT[count].thumbnail_cayenne_url}}return ProductInformationConstants.NON_PRODUCT_IMG_SOURCE};this.getProductThumbnailImageFromProductName=function(productName){for(var count=0;count<ProductInformationConstants.PRODUCT.length;count++){var productKeywords=ProductInformationConstants.PRODUCT[count].keywords.split(",");for(var keywordCount=0;keywordCount<productKeywords.length;keywordCount++){if(angular.lowercase(productName).indexOf(angular.lowercase(productKeywords[keywordCount]))>=0){return ProductInformationConstants.PRODUCT[count].thumbnail_cayenne_url}}}return ProductInformationConstants.NON_PRODUCT_IMG_SOURCE};this.getProductThumbnailImageFromCrmDescription=function(productDescription){var productName=productDescription.substr(0,productDescription.indexOf(","));for(var count=0;count<ProductInformationConstants.PRODUCT.length;count++){if(ProductInformationConstants.PRODUCT[count].name.indexOf(productName)>=0){return ProductInformationConstants.PRODUCT[count].thumbnail_cayenne_url}}return ProductInformationConstants.NON_PRODUCT_IMG_SOURCE};this.getProductNameFromCrmProductName=function(productName){for(var count=0;count<ProductInformationConstants.PRODUCT.length;count++){if(productName.indexOf(ProductInformationConstants.PRODUCT[count].name)>=0){return ProductInformationConstants.PRODUCT[count].full_name}}return productName};this.loadCustomer=function(customerNo,email,customerObj){var customerRequestObject=new Object();customerRequestObject.customerNo=customerNo;customerObj.isLoading=true;customerObj.isImsLoading=false;CustomerRecordService.getItem(customerRequestObject).success(function(result){console.log("Success : CustomerRecordService -> getItem()");customerObj.customer=result;customerObj.isLoading=false;if(result){angular.forEach(result.messages,function(message){if(message.type=="E"&&message.number=="201"){customerObj.isLoading=false}})}}).error(function(result){console.log("Error : CustomerRecordService -> getItem() : ",result);customerObj.isLoading=false;customerObj.isCustomerFailed=true});ImsCustomerService.getItem({email:email}).success(function(result){console.log("Success : ImsCustomerService -> getItem()");customerObj.imsCustomer=result;customerObj.isImsLoading=false;customerObj.imsCustomer.emailVerified=result.emailVerified==AppConstants.EMAIL_VERIFIED;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){customerObj.imsCustomer.serviceCode=item.serviceCode;customerObj.imsCustomer.serviceStatus=item.serviceStatus;customerObj.imsCustomer.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){customerObj.imsCustomer.serviceStorage=item.params[imsCount].pv+" GB"}}}}})}}).error(function(result){console.log("Error : ImsCustomerService -> getItem() : ",result);customerObj.isImsLoading=false})};this.isHavingErrorMessage=function(messagesList){var havingErrorMessage=false;angular.forEach(messagesList,function(message){if(message.type=="E"){havingErrorMessage=true}});return havingErrorMessage};this.getErrorMessage=function(messagesList){if(messagesList){for(var count=0;count<messagesList.length;count++){if(messagesList[count].type=="E"){return messagesList[count].text}}}return""};this.getErrorMessages=function(messagesList){var errorList=[];if(messagesList){for(var count=0;count<messagesList.length;count++){if(messagesList[count].type=="E"){errorList.push(messagesList[count])}}}return errorList};this.getSuccessMessage=function(messagesList){if(messagesList){for(var count=0;count<messagesList.length;count++){if(messagesList[count].type=="S"){return messagesList[count].text}}}return""};this.getInformationMessage=function(messagesList){if(messagesList){for(var count=0;count<messagesList.length;count++){if(messagesList[count].type=="I"&&messagesList[count].information==true){return messagesList[count].text}}}return""};this.isCcmIndividualByProductName=function(productName){if(productName){return productName.toUpperCase().indexOf(AppConstants.CCM_INDIVIDUAL_PRODUCT_NAME)>-1?true:false}return false};this.isCcmTeamByProductName=function(productName){productName.toUpperCase().indexOf(AppConstants.CCM_TEAM_PRODUCT_NAME)>-1?true:false};this.getProductName=function(productName){for(var count=0;count<ProductInformationConstants.PRODUCT.length;count++){if(productName.indexOf(ProductInformationConstants.PRODUCT[count].name)==0){return ProductInformationConstants.PRODUCT[count].full_name}}return};this.getApplicationUrl=function(){var appUrl=$location.absUrl();if(appUrl.indexOf("#")>0){return appUrl.substring(0,appUrl.indexOf("#")+1)}};var errorMessage="";this.isDataInvalid=function(data,charLength,errorMsg,minLengthError){if(minLengthError){if(data.length<charLength){return errorMsg+" - Should not be less than "+charLength+". \n"}}else{if(data.length>charLength){return errorMsg+" - Exceeds maximum limit. \n"}}return""};this.getInvalidErrorMessages=function(addressDto,isCountryJP){errorMessage="";if(addressDto){if(!addressDto.country){errorMessage+="Country should not be empty.\n"}if(!addressDto.city){errorMessage+="City should not be empty.\n"}if(!addressDto.postCode){errorMessage+="Postal Code should not be empty.\n"}if(isCountryJP){errorMessage+=isDataInvalid(addressDto.city,AppConstants.JP_REGION_FIELD_CITY_LENGTH,"City");errorMessage+=isDataInvalid(addressDto.postCode,AppConstants.JP_REGION_FIELD_POSTAL_CODE_LENGTH,"Postal Code");errorMessage+=isDataInvalid(addressDto.company,AppConstants.JP_REGION_FIELD_COMPANY_NAME_LENGTH,"Company Name");errorMessage+=isDataInvalid(addressDto.street1,AppConstants.JP_REGION_FIELD_STREET1_LENGTH,"Street 1");errorMessage+=isDataInvalid(addressDto.street2,AppConstants.JP_REGION_FIELD_STREET2_LENGTH,"Street 2");errorMessage+=isDataInvalid(addressDto.street3,AppConstants.JP_REGION_FIELD_STREET3_LENGTH,"Street 3");errorMessage+=isDataInvalid(addressDto.phone,AppConstants.JP_REGION_FIELD_FIELD_TELEPHONE_MIN_LENGTH,"Telephone",true)}else{errorMessage+=isDataInvalid(addressDto.city,AppConstants.NON_JP_REGION_FIELD_CITY_LENGTH,"City");errorMessage+=isDataInvalid(addressDto.postCode,AppConstants.NON_JP_REGION_FIELD_POSTAL_CODE_LENGTH,"Postal Code");errorMessage+=isDataInvalid(addressDto.company,AppConstants.NON_JP_REGION_FIELD_COMPANY_NAME_LENGTH,"Company Name");errorMessage+=isDataInvalid(addressDto.street1,AppConstants.NON_JP_REGION_FIELD_STREET1_LENGTH,"Street 1");errorMessage+=isDataInvalid(addressDto.street2,AppConstants.NON_JP_REGION_FIELD_STREET2_LENGTH,"Street 2");errorMessage+=isDataInvalid(addressDto.street3,AppConstants.NON_JP_REGION_FIELD_STREET3_LENGTH,"Street 3");errorMessage+=isDataInvalid(addressDto.phone,AppConstants.NON_JP_REGION_FIELD_TELEPHONE_MIN_LENGTH,"Telephone",true)}}return errorMessage};var isAddressInvalid=false;this.getAddressInvalidStatus=function(addressDto,isCountryJP){isAddressInvalid=false;if(addressDto){if(isCountryJP){if(((addressDto.street1)?(addressDto.street1.length>AppConstants.JP_REGION_FIELD_STREET1_LENGTH):false)||((addressDto.street2)?(addressDto.street2.length>AppConstants.JP_REGION_FIELD_STREET2_LENGTH):false)||((addressDto.street3)?(addressDto.street3.length>AppConstants.JP_REGION_FIELD_STREET3_LENGTH):false)||((addressDto.postCode)?(addressDto.postCode.length>AppConstants.JP_REGION_FIELD_POSTAL_CODE_LENGTH):false)||((addressDto.city)?(addressDto.city.length>AppConstants.JP_REGION_FIELD_CITY_LENGTH):false)||((addressDto.company)?(addressDto.company.length>AppConstants.JP_REGION_FIELD_COMPANY_NAME_LENGTH):false)||!addressDto.country||!addressDto.city||!addressDto.postCode){isAddressInvalid=true}}else{if(((addressDto.street1)?(addressDto.street1.length>AppConstants.NON_JP_REGION_FIELD_STREET1_LENGTH):false)||((addressDto.street2)?(addressDto.street2.length>AppConstants.NON_JP_REGION_FIELD_STREET2_LENGTH):false)||((addressDto.street3)?(addressDto.street3.length>AppConstants.NON_JP_REGION_FIELD_STREET3_LENGTH):false)||((addressDto.postCode)?(addressDto.postCode.length>AppConstants.NON_JP_REGION_FIELD_POSTAL_CODE_LENGTH):false)||((addressDto.city)?(addressDto.city.length>AppConstants.NON_JP_REGION_FIELD_CITY_LENGTH):false)||((addressDto.company)?(addressDto.company.length>AppConstants.NON_JP_REGION_FIELD_COMPANY_NAME_LENGTH):false)||!addressDto.country||!addressDto.city||!addressDto.postCode){isAddressInvalid=true}}}return isAddressInvalid};this.isCommercialStore=function(country){var isCommStore=false;if(AppConstants.SELLABLE_COMMERCIAL_COUNTRIES.indexOf(angular.lowercase(country))==-1){isCommStore=false}else{if(AppConstants.NOT_SELLABLE_COMMERCIAL_COUNTRIES.indexOf(angular.lowercase(country))==-1){isCommStore=true}else{isCommStore=false}}return isCommStore};this.isEducationalStore=function(country){var isEduStore=false;if(AppConstants.SELLABLE_EDUCATIONAL_COUNTRIES.indexOf(angular.lowercase(country))==-1){isEduStore=false}else{if(AppConstants.NOT_SELLABLE_EDUCATIONAL_COUNTRIES.indexOf(angular.lowercase(country))==-1){isEduStore=true}else{isEduStore=false}}return isEduStore};this.isLaunchDRStoreEnable=function(country){var drLocale=country.drLocale;var drCountryForInternalAgents={SG:"en_SG",MY:"en_MY",ID:"en_MY",PH:"en_MY",TH:"en_MY",HK:"en_HK",IN:"en_IN"};if(drLocale!=null&&drLocale!=""){if(($rootScope.currentUser.external!=null&&!$rootScope.currentUser.external&&drCountryForInternalAgents[country.code.toUpperCase()])){return true}else{if($rootScope.currentUser.external!=null&&$rootScope.currentUser.external&&!drCountryForInternalAgents[country.code.toUpperCase()]){return true}else{return false}}}return false};this.isLaunchCctDRStoreEnable=function(country){var enableDRCountryList=["IN","KR","RU","BY","KZ","KG","TJ","UA","UZ"];for(var countryCount=0;countryCount<hendrixConfig.drCountries.length;countryCount++){if((angular.uppercase(country.code)==angular.uppercase(hendrixConfig.drCountries[countryCount].countryCode))&&enableDRCountryList.indexOf(country.code)>=0){return true}}return false};this.isDRCountry=function(countryCode){for(var countryCount=0;countryCount<hendrixConfig.drCountries.length;countryCount++){if((angular.uppercase(countryCode)==angular.uppercase(hendrixConfig.drCountries[countryCount].countryCode))){return true}}return false};this.getCustomerWebGUID=function(customer){var customerWebGUID="";if(customer&&customer.customerIdentifications){for(var count=0;count<customer.customerIdentifications.length;count++){if(customer.customerIdentifications[count].idType==AppConstants.CUSTOMER_WEB_GUID){customerWebGUID=customer.customerIdentifications[count].idNumber;break}}}return customerWebGUID};this.isValidHouseNumber=function(address){var street1WithPinCode=address.street1+" "+address.postCode;var houseNo=this.getHouseNo(street1WithPinCode);return(houseNo&&houseNo.indexOf("-")>0)};this.getHouseNo=function(addressStr){addressStr=addressStr.trim();var addressElements=addressStr.split(/[\s,\,]/);if(!addressElements){return null}addressElements.pop();for(var i=0;i<addressElements.length;i++){var houseNoMatcher=addressElements[i].match(/(\d+)/gi);if(houseNoMatcher&&houseNoMatcher.length>0){return addressElements[i]}}return null};this.getReplacedStreet1Address=function(newHouseNumber,address){if(newHouseNumber&&newHouseNumber.length>0){var street1WithPinCode=address.street1+" "+address.postCode;var houseNo=this.getHouseNo(street1WithPinCode);if(houseNo){address.street1=address.street1.replace(this.getHouseNo(street1WithPinCode),newHouseNumber)}else{address.street1=newHouseNumber+" "+address.street1}}return address};this.sendLogToServer=function(logMessage){var log=logMessage+", Agent -"+$rootScope.currentUser.firstName+" "+$rootScope.currentUser.lastName+"("+$rootScope.currentUser.username+")";LoggerService.log({message:log}).success(function(result){}).error(function(result){})};this.sendLogToServerWithoutAuth=function(messageObject,status,headers,config){this.sendLogToServer(messageObject,status,headers,config,true)};this.sendLogToServer=function(messageObject,status,headers,config,isNoAuth){var logMessage="";if($.isPlainObject(messageObject)){var logObject=new Object();var headerObject=new Object();logObject.Origin="Hx5 UI";logObject.Agent_System_Date_Time=new Date();logObject.Module=(_.has($rootScope,"lastRoute.$$route.title")?$rootScope.lastRoute.$$route.title:"")+" - "+(_.has($rootScope,"lastRoute.$$route.controller")?$rootScope.lastRoute.$$route.controller:"");logObject.Service="";logObject.Method="";if(config&&config.url.indexOf(".do")>0){logObject.Service=config.url.split("/")[1];logObject.Method+=config.url.split("/")[2].replace(".do","")}logObject.Status=status?status:"";if($rootScope.currentUser){logObject.Agent_ID=$rootScope.currentUser.username;logObject.Agent_Name=$rootScope.currentUser.firstName+" "+$rootScope.currentUser.lastName;logObject.Agent_Type=$rootScope.currentUser.external?"External Agent":"Internal Agent";logObject.Agent_Workstation=$rootScope.currentUser.workstationId}if(headers&&headers()){for(var prop in headers()){headerObject["Header_"+prop]=headers()[prop]}}logObject=$.extend({},logObject,messageObject,headerObject,configObj);for(var logProperty in logObject){if(this.isProd()&&logProperty.indexOf("Test_")==-1){logMessage+=logProperty+'="'+logObject[logProperty]+'" '}else{if(!this.isProd()){var logPropertyName=logProperty.replace(/Test_/i,"");logMessage+=logPropertyName+'="'+logObject[logProperty]+'" '}}}}else{logMessage=messageObject}if(isNoAuth){LoggerService.logNoAuth({message:logMessage})}else{LoggerService.log({message:logMessage})}console.info("%c Log Message:"+messageObject.Functionality,"color:blue;font-weight:green",JSON.stringify(messageObject))};this.isProd=function(){var hostName=angular.lowercase(location.hostname);return(hostName.indexOf("s2-v2")>=0||hostName.indexOf("prod")>=0)};this.replaceCustomerPath=function(newTab,subTab){var currentPath=$location.path();var newCustomerUrlPath=currentPath.replace(/\/individual|\/jilteam|\/team|\/trial|\/perpetual|\/enterprise|\/all/gi,"").replace(/memos|cases|transactions|products|subscriptions|contracts|services|stock/gi,newTab);switch(newTab){case"products":if(subTab){newCustomerUrlPath=newCustomerUrlPath+"/"+subTab}else{newCustomerUrlPath=newCustomerUrlPath.replace(/products/i,"products/perpetual")}break;case"subscriptions":if(subTab){newCustomerUrlPath=newCustomerUrlPath+"/"+subTab}else{newCustomerUrlPath=newCustomerUrlPath.replace(/subscriptions/i,"subscriptions/individual")}break}return newCustomerUrlPath};this.getTemplateName=function(storeTransaction,currentStore){var templateName="";if(storeTransaction.items[0].ispuf=="true"&&(storeTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||storeTransaction.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE)){templateName="tc_ccm_team_com_reg_po"}else{if(storeTransaction.items[0].ispuf=="true"&&storeTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){templateName="tc_ccm_team_com_reg_pp"}else{if(storeTransaction.items[0].ispuf!="true"&&(storeTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE||storeTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||storeTransaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)){templateName="tc_ccm_complete_anu_pp"}else{if(currentStore.isEduStore){templateName="tc_ccm_team_edu_reg_po"}}}}console.log("templateName :: "+templateName);return templateName};this.showTnCWhenPaymentReset=function(transaction,updatedPaymentdetails){var showTnC=false;if(transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE&&(updatedPaymentdetails.paymentType==PaymentConstants.CREDIT_CARD_ON_FILE_PAYMENT_TYPE||updatedPaymentdetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE)&&updatedPaymentdetails.paymentType!=transaction.paymentDetails.paymentType&&this.isCcmTeam(transaction.items)){showTnC=true}else{if(transaction.reason.code==TransactionConstants.SESI_ORDER_REASON_CODE_ADOBE_MANAGED&&transaction.paymentDetails.paymentType==PaymentConstants.DUMMY_CARD){showTnC=true}}return showTnC};this.isCcmTeam=function(cartItems){if(cartItems){for(var cartCount=0;cartCount<cartItems.length;cartCount++){if(angular.uppercase(cartItems[cartCount].productType)==TransactionConstants.CCM_TEAM_PRODUCT_TYPE||angular.uppercase(cartItems[cartCount].productName)==TransactionConstants.CCM_TEAM_PRODUCT_NAME){return true}}return false}return false};this.checkSKUForPredefinedTemplate=function(val){var predefinedSTOCKSKU=["65260661","65260757","65260754","65260753","65260755"];if(angular.isDefined(val)&&predefinedSTOCKSKU.indexOf(val.toString())>0){return true}else{return false}};this.createSubscriptionLinkInCustomerView=function(imsCustomerData,customerNo){var subLink="#/customer/"+customerNo+"/subscriptions";if(imsCustomerData&&imsCustomerData.account_type&&imsCustomerData.roles){angular.forEach(imsCustomerData.roles,function(role){if(role.organization.indexOf("@AdobeOrg")!=-1&&imsCustomerData.account_type=="type1"){subLink="#/customer/"+customerNo+"/subscriptions/team"}else{subLink="#/customer/"+customerNo+"/subscriptions/individual"}})}return subLink};this.createProductLinkInCustomerView=function(imsCustomerData,customerNo){var productLink='#/customer/"+customerNo+"/products';if(imsCustomerData&&imsCustomerData.account_type!="type1"){productLink="#/customer/"+customerNo+"/products/enterprise"}else{productLink="#/customer/"+customerNo+"/products/perpetual"}return productLink};this.getParameterByName=function(name,url){if(!url){url=window.location.href}name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);if(!results){return null}if(!results[2]){return""}return decodeURIComponent(results[2].replace(/\+/g," "))};this.assignDefaultEmptyValue=function(object){_.forEach(object,function(value,key){object[key]=_.isNull(object[key])?"":object[key]});return object};this.getCategoryFromProductCode=function(productCode){var categoryName="";angular.forEach(AppConstants.PRODUCT_CATEGORIES,function(category){if(category.productCodes.indexOf(productCode)>-1){categoryName=categoryName+category.name+", "}});return categoryName};this.getENVCode=function(){var envCode={hendrixprod:"prd","hendrix-s2":"stg","hendrix-s2-v2":"stage","hendrix-pr":"prd"};if(location.host.toLowerCase().indexOf("hendrixprod")>=0||location.host.toLowerCase().indexOf("hendrix-pr")>=0){return envCode.hendrixprod}else{if(location.host.toLowerCase().indexOf("hendrix-s2")>=0||location.host.toLowerCase().indexOf("hendrix-s2-v2")>=0){return envCode["hendrix-s2"]}else{return envCode["hendrix-s2"]}}};this.getMonthDifference=function(d1,d2){var months;months=(d2.getFullYear()-d1.getFullYear())*12;months-=d1.getMonth()+1;months+=d2.getMonth();return months};this.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};this.convertXmlToJson=function(xmlText){return new X2JS().xml_str2json(xmlText)};this.convertJsonToXmlText=function(jsonObj){return new X2JS().json2xml_str(jsonObj)}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("AtsController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","ATS Order View");$scope.atsTransaction=angular.copy($scope.transaction);$scope.isTransactionComplete=false;$scope.isUpdateOrderDisabled=true;$scope.isMemoBtnEnabled=false;$scope.checkTrackingInfo=function(){if($scope.atsTransaction){if($scope.atsTransaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.atsTransaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.atsTransaction.items&&$scope.atsTransaction.items.length>0){for(var itemCount=0;itemCount<$scope.atsTransaction.items.length;itemCount++){if($scope.atsTransaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.checkDocumentFlow=function(){if($scope.atsTransaction){return[TransactionConstants.TRANSACTION_STANDARD_ORDER,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER].indexOf($scope.transaction.transactionType)>-1}return false};$scope.validateButtonVisibility=function(){$scope.isTransactionComplete=OrderUtils.isTransactionComplete($scope.atsTransaction.statusLabel);$scope.isJpbtCcmOrder=false;if($scope.isSubscriptionOrder){$scope.isSubscriptionEditBtnShow=true;$scope.isNonSubscriptionEditBtnShow=false}else{$scope.isSubscriptionEditBtnShow=false;$scope.isNonSubscriptionEditBtnShow=true}if(($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)&&OrderUtils.isPuf($scope.transaction.items)){$scope.isJpbtCcmOrder=true}angular.forEach($scope.atsTransaction.items,function(productItem){if(productItem.deliveryStatus!=TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){$scope.isMemoBtnEnabled=true}})};$scope.initializeOrderScreen=function(){$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.isDocumentFlowShow=$scope.checkDocumentFlow();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.atsTransaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.atsTransaction.items);$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.atsTransaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.atsTransaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.atsTransaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.atsTransaction);$scope.transactionStatusLabel=TransactionUtil.getStatusLabel($scope.atsTransaction.statusLabel);$scope.validateButtonVisibility()};$scope.initializeOrderScreen();$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.atsTransaction.transactionGuid,transactionNo:$scope.atsTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.atsTransaction.transactionGuid,transactionNo:$scope.atsTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.openEditBillingView=function(){TransactionService.lockTransaction({guid:$scope.atsTransaction.transactionGuid}).success(function(lockResult){if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_EDIT_BILLING_EVENT,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,lockResult)}}).error(function(result){})};$scope.openCreateCreditMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_EVENT)};$scope.openCreateDebitMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_EVENT)};$scope.openReturnOrderView=function(){$scope.$emit(TransactionConstants.TRANSACTION_ORDER_RETURN_VIEW_EVENT)};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show")}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(function($httpProvider){$httpProvider.interceptors.push(function($q,$rootScope){return{request:function(config){return config},requestError:function(rejection){return $q.reject(rejection)},response:function(response){return response},responseError:function(rejection){var status=rejection.status;if(status==401||status==403){var deferred=$q.defer();var req={config:rejection.config,deferred:deferred};$rootScope.requests401.push(req);$rootScope.$broadcast("event:loginRequired");return deferred.promise}return $q.reject(rejection)}}})});app.run(["$rootScope","$http","$log",function(scope,$http,$log){scope.requests401=[];scope.$on("event:loginConfirmed",function(){console.log("auth.js event:loginConfirmed");var i,requests=scope.requests401;for(i=0;i<requests.length;i++){}scope.requests401=[];function retry(req){$http(req.config).then(function(response){req.deferred.resolve(response)})}});scope.$on("event:loginRequest",function(event,username,password){var payload=$.param({j_username:username,j_password:password});var config={headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}};$http.post("j_spring_security_check",payload,config).success(function(data){if(data==="AUTHENTICATION_SUCCESS"){scope.$broadcast("event:loginConfirmed")}})});scope.$on("event:logoutRequest",function(){$http.put("j_spring_security_logout",{}).success(function(){ping()})});scope.$on("event:ping",function(){ping()});function ping(){console.log("ping()");$http({method:"GET",url:"../userService/getCurrentUser.do?"+Math.random()}).success(function(result){console.log("ping success");scope.currentUser=result;scope.$broadcast("event:loginConfirmed",result)}).error(function(error){console.log("ping failed")})}ping()}]);var app=app||angular.module("hxApp.directive",[]);app.directive("backTop",function(){return{restrict:"E",scope:false,replace:true,template:"<p id='backTop'><a href='#topOfPage'><span></span>Back To Top</a></p>",link:function(scope,element,attrs){element.hide();$(function(){$(window).scroll(function(){if($(this).scrollTop()>150){element.fadeTo(0,0.4)}else{element.fadeOut()}});element.find("a").click(function(){$("body,html").animate({scrollTop:0},200);return false})})}}});var app=app||angular.module("kamrad.directive",[]);app.directive("ngCahDetail",["$rootScope","CAHService","CustomerConstants","AppUtils","CustomerSubscriptionService",function($rootScope,CAHService,CustomerConstants,AppUtils,CustomerSubscriptionService){return{restrict:"EA",scope:{flow:"=",viewDetail:"=",guid:"=",contractId:"=",jilContractId:"=",showVertical:"=",data:"=",indData:"=",teamData:"=",teamJilData:"="},replace:true,templateUrl:"js/customer/partials/cah-detail.html",link:function(scope,element,attrs){scope.iscahGreen=false;scope.iscahRed=false;scope.iscahYellow=false;scope.showCardExpire=false;scope.showBillingExpire=false;scope.numberOfBillingFail=0;scope.numberOfCreditCardExpire=0;scope.loading=true;scope.cahguiDResult;scope.jilIndSubData;scope.BILLING_EXPIRE_CLICK_EVENT="CLICK :: Billing Expire Event";scope.CC_EXPIRE_CLICK_EVENT="CLICK :: CC Expire Event";scope.$on("initiateCAHContractDetail",function(event,result){scope.loading=false;if(scope.flow==CustomerConstants.CAH_TEAM_FLOW||scope.flow==CustomerConstants.CAH_TEAM_JIL){scope.checkForBillingStatus(result.cahdetail,true);scope.checkForCardValidity(result.cahdetail,true);scope.checkForChurnLevelTeam(result.cahdetail,true)}});scope.$on("initiateCAHContractDetailFailed",function(event,result){scope.loading=false});scope.$on("loadedCAHGUIDDetail",function(event,result){scope.loading=false;if(scope.flow==CustomerConstants.CAH_IND_FLOW){scope.handleCAHDisplayForCustomer(result)}});scope.$on("loadedCAHGUIDDetailFailed",function(event,result){scope.loading=false});scope.$on("stopCAHLoading",function(event,result){scope.loading=false});var handleValueChange=function(value){if(value&&angular.isDefined(value)&&value.length>0){if(scope.flow==CustomerConstants.CAH_CUST_FLOW){scope.loading=true;scope.loadCAHGUIDetails(value)}else{}}else{if(scope.flow==CustomerConstants.CAH_CUST_FLOW){scope.loading=false}}};var handleContractValueChange=function(value){if(value&&angular.isDefined(value)&&value.length>0&&scope.teamJilData.programContractId==value){if(scope.flow==CustomerConstants.CAH_TEAM_JIL){scope.loading=true;scope.loadCAHContractDetail(value)}}else{scope.loading=false}};scope.loadCAHContractDetail=function(value){CAHService.getCAHContractDetail(value).success(function(result,status,headers,config){scope.loading=false;if(scope.flow==CustomerConstants.CAH_TEAM_JIL){scope.checkForBillingStatus(result,true);scope.checkForCardValidity(result,true);scope.checkForChurnLevelTeam(result,true)}var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for jilTeam";messageObject.Result="SUCCESS";messageObject.Flow="JIL TEAM";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){scope.loading=false;var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for jilTeam";messageObject.Result="ERROR";messageObject.Flow="JIL TEAM";AppUtils.sendLogToServer(messageObject,status,headers,config)})};scope.$watch(function(){return scope.guid},handleValueChange);scope.$watch(function(){return scope.jilContractId},handleContractValueChange);scope.loadCAHGUIDetails=function(value){if(scope.showVertical==true){$("#cahWaitDiv").addClass("cah-wait")}CAHService.getCAHGUIDDetail(value).success(function(result,status,headers,config){scope.loading=false;scope.cahguiDResult=result;if(scope.flow==CustomerConstants.CAH_CUST_FLOW){scope.handleCAHDisplayForCustomer(result)}var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="SUCCESS";messageObject.Flow="Customer header";messageObject.guid=value;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){scope.loading=false;var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="ERROR";messageObject.Flow="Customer header";messageObject.guid=value;AppUtils.sendLogToServer(messageObject,status,headers,config)})};scope.handleCAHDisplayForCustomer=function(result){if(angular.isDefined(result)){var churnScore;var currentDate=new Date();if(scope.flow==CustomerConstants.CAH_IND_FLOW){angular.forEach(result.predictive,function(pred){if(angular.isDefined(scope.indData)&&angular.isDefined(scope.indData.contract)&&angular.isDefined(scope.indData.contract.externalContractId)&&angular.isDefined(pred.subscription_id)&&pred.subscription_id.indexOf(scope.indData.contract.externalContractId)>=0){churnScore=Number(pred.churn_level)}});angular.forEach(result.subscriptions,function(sub){if(angular.isDefined(scope.indData)&&angular.isDefined(scope.indData.contract)&&angular.isDefined(scope.indData.contract.id)&&sub.contract_id==scope.indData.contract.id){if(sub.payment_method==CustomerConstants.CAH_CC_LABEL&&sub.cc_expiration_date!="NULL"&&AppUtils.getMonthDifference(currentDate,new Date(Number(sub.cc_expiration_date.substr(2,6)),Number(sub.cc_expiration_date.substr(0,2))))<=2&&AppUtils.getMonthDifference(currentDate,new Date(Number(sub.cc_expiration_date.substr(2,6)),Number(sub.cc_expiration_date.substr(0,2))))>=0){scope.showCardExpire=true}if(angular.isDefined(sub.payment_status)&&(sub.payment_status==CustomerConstants.CAH_PAYMENT_PENDING||sub.payment_status==CustomerConstants.CAH_PAYMENT_FAILURE)){scope.showBillingExpire=true}}})}else{churnScore=scope.getFinalChurnScore(result);scope.setCardValidityForInd(result);scope.setBillingStatusForInd(result)}if(churnScore>0){scope.setChurnScore(churnScore)}}};scope.setCardValidityForInd=function(result){scope.checkForCardValidity(result,false)};scope.setBillingStatusForInd=function(result){scope.checkForBillingStatus(result,false)};scope.getFinalChurnScore=function(result){var predictiveScore=-1;angular.forEach(result.predictive,function(value){if(Number(value.churn_level)>predictiveScore){predictiveScore=Number(value.churn_level)}});return predictiveScore};scope.checkForCardValidity=function(result,isTeam){var currentDate=new Date();if(scope.flow==CustomerConstants.CAH_TEAM_FLOW||scope.flow==CustomerConstants.CAH_TEAM_JIL){angular.forEach(result.payment_methods,function(payment){if(angular.isDefined(payment.cc_expiration_date)&&payment.cc_expiration_date&&payment.cc_expiration_date!="NULL"&&payment.payment_method==CustomerConstants.CAH_CC_LABEL&&AppUtils.getMonthDifference(currentDate,new Date(Number(payment.cc_expiration_date.substr(2,6)),Number(payment.cc_expiration_date.substr(0,2))))<=2&&AppUtils.getMonthDifference(currentDate,new Date(Number(payment.cc_expiration_date.substr(2,6)),Number(payment.cc_expiration_date.substr(0,2))))>=0){scope.numberOfCreditCardExpire+=1;scope.setCardValidityStatus()}})}else{angular.forEach(result.subscriptions,function(subs){if(subs.subscription_type!="TEAM_DIRECT"&&subs.subscription_type!="TEAM_INDIRECT"&&subs.payment_method==CustomerConstants.CAH_CC_LABEL&&subs.subscription_type!="TEAM_DIRECT"&&subs.subscription_type!="TEAM_INDIRECT"&&subs.cc_expiration_date!="NULL"&&AppUtils.getMonthDifference(currentDate,new Date(Number(subs.cc_expiration_date.substr(2,6)),Number(subs.cc_expiration_date.substr(0,2))))<=2&&AppUtils.getMonthDifference(currentDate,new Date(Number(subs.cc_expiration_date.substr(2,6)),Number(subs.cc_expiration_date.substr(0,2))))>=0){scope.numberOfCreditCardExpire+=1;scope.setCardValidityStatus()}})}};scope.checkForBillingStatus=function(result,isTeam){if(scope.flow==CustomerConstants.CAH_TEAM_FLOW||scope.flow==CustomerConstants.CAH_TEAM_JIL){angular.forEach(result.seats_by_payment_status,function(seat){if(seat.status==CustomerConstants.CAH_PAYMENT_FAILURE&&Number(seat.seats)>0){scope.showBillingExpire=true}})}else{angular.forEach(result.subscriptions,function(subs){if(subs.subscription_type!="TEAM_DIRECT"&&subs.subscription_type!="TEAM_INDIRECT"&&((subs.payment_status==CustomerConstants.CAH_PAYMENT_PENDING)||subs.payment_status==CustomerConstants.CAH_PAYMENT_FAILURE)){scope.showBillingExpire=true}})}};scope.checkForChurnLevelTeam=function(result,isTeam){if(angular.isDefined(result)&&angular.isDefined(result.predictive)){scope.setChurnScore(Number(result.predictive.churn_level))}};scope.clickOnAboutToExpireBtn=function(rec){var transactionURL;var messageObj;if(scope.viewDetail==true||scope.viewDetail=="true"){if(scope.flow==CustomerConstants.CAH_TEAM_FLOW){transactionURL="transaction/"+scope.teamData[0].externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.teamData[0].externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_TEAM_JIL){transactionURL="transaction/"+scope.teamJilData.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.teamJilData.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_IND_FLOW){transactionURL="transaction/"+scope.indData.contract.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.indData.contract.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_CUST_FLOW){if(scope.cahguiDResult&&angular.isArray(scope.cahguiDResult.subscriptions)&&scope.cahguiDResult.subscriptions.length==1){scope.getIndSubscriptionDetailByGuidAndOpenOrder();messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.cahguiDResult.subscriptions[0].contract_id);AppUtils.sendLogToServer(messageObj)}else{var data={};$rootScope.$broadcast("loadIndividualSubscriptionTab",data)}}}}}}else{if(scope.flow==CustomerConstants.CAH_TEAM_FLOW){transactionURL="transaction/"+scope.teamData.teamJILResult[0].externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.teamData.teamJILResult[0].externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_TEAM_JIL){transactionURL="transaction/"+scope.teamJilData.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.teamJilData.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_IND_FLOW){transactionURL="transaction/"+scope.indData.contract.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.indData.contract.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_CUST_FLOW){if(scope.cahguiDResult&&angular.isArray(scope.cahguiDResult.subscriptions)&&scope.cahguiDResult.subscriptions.length==1){scope.getIndSubscriptionDetailByGuidAndOpenOrder();messageObj=scope.getMessageLoggingObject(scope.flow,scope.CC_EXPIRE_CLICK_EVENT,scope.cahguiDResult.subscriptions[0].contract_id);AppUtils.sendLogToServer(messageObj)}else{var data={};$rootScope.$broadcast("loadIndividualSubscriptionTab",data)}}}}}}if(angular.isDefined(transactionURL)&&transactionURL.length>0){window.open(AppUtils.getApplicationUrl()+transactionURL)}};scope.clickOnBillingExpiredBtn=function(rec){var transactionURL;var messageObj;if(scope.viewDetail==true||scope.viewDetail=="true"){if(scope.flow==CustomerConstants.CAH_TEAM_FLOW){transactionURL="transaction/"+scope.teamData[0].externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.teamData[0].externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_TEAM_JIL){transactionURL="transaction/"+scope.teamJilData.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.teamJilData.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_IND_FLOW){transactionURL="transaction/"+scope.indData.contract.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.indData.contract.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_CUST_FLOW){if(scope.cahguiDResult&&angular.isArray(scope.cahguiDResult.subscriptions)&&scope.cahguiDResult.subscriptions.length==1){scope.getIndSubscriptionDetailByGuidAndOpenOrder()}else{var data={};$rootScope.$broadcast("loadIndividualSubscriptionTab",data)}messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.cahguiDResult.subscriptions[0].contract_id);AppUtils.sendLogToServer(messageObj)}}}}}else{if(scope.flow==CustomerConstants.CAH_TEAM_FLOW){transactionURL="transaction/"+scope.teamData.teamJILResult[0].externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.teamData.teamJILResult[0].externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_TEAM_JIL){transactionURL="transaction/"+scope.teamJilData.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.teamJilData.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_IND_FLOW){transactionURL="transaction/"+scope.indData.contract.externalContractId;messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.indData.contract.externalContractId);AppUtils.sendLogToServer(messageObj)}else{if(scope.flow==CustomerConstants.CAH_CUST_FLOW){if(scope.cahguiDResult&&angular.isArray(scope.cahguiDResult.subscriptions)&&scope.cahguiDResult.subscriptions.length==1){scope.getIndSubscriptionDetailByGuidAndOpenOrder()}else{var data={};$rootScope.$broadcast("loadIndividualSubscriptionTab",data)}messageObj=scope.getMessageLoggingObject(scope.flow,scope.BILLING_EXPIRE_CLICK_EVENT,scope.cahguiDResult.subscriptions[0].contract_id);AppUtils.sendLogToServer(messageObj)}}}}}if(angular.isDefined(transactionURL)&&transactionURL.length>0){window.open(AppUtils.getApplicationUrl()+transactionURL)}};scope.getIndSubscriptionDetailByGuidAndOpenOrder=function(){if(!angular.isDefined(scope.jilIndSubData)){CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:scope.guid+"@AdobeID",locale:""}).success(function(result){scope.jilIndSubData=result;scope.openTransaction()}).error(function(error){})}else{scope.openTransaction()}};scope.openTransaction=function(){if(scope.flow==CustomerConstants.CAH_CUST_FLOW){angular.forEach(scope.jilIndSubData,function(indsub){if(indsub.contract.id==scope.cahguiDResult.subscriptions[0].contract_id){var transactionURL="transaction/"+indsub.contract.externalContractId;window.open(AppUtils.getApplicationUrl()+transactionURL)}})}};scope.setChurnScore=function(value){scope.iscahGreen=false;scope.iscahYellow=false;scope.iscahRed=false;if(value>0&&value<=33){scope.iscahGreen=true}else{if(value>33&&value<=66){scope.iscahYellow=true}else{if(Number(value>66&&value<=99)){scope.iscahRed=true}}}};scope.setCardValidityStatus=function(){scope.showCardExpire=true};scope.churnScoreButtonClick=function(){if(scope.flow==CustomerConstants.CAH_CUST_FLOW){var data={rengaGuid:scope.guid};$rootScope.$broadcast("loadIndividualSubscriptionTab",data)}};scope.getMessageLoggingObject=function(scope,eventName,data){var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - AGENT CLICK EVENT";messageObject.Event=eventName;messageObject.scope=scope;messageObject.data=data;return messageObject}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CAHService",["$http","AppUtils",function($http,AppUtils){var service={};service.getCAHGUIDDetail=function(guid){var processData={urlKey:"cah-service",queryParameters:{"individual:guid":guid}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:processData})};service.getCAHContractDetail=function(contractId){var processData={urlKey:"cah-service",queryParameters:{"team:contract_id":contractId}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:processData})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CallbackController",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","VHTCallbackService","CustomerPreviewService","$timeout","LocalStorageService","Utils",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,VHTCallbackService,CustomerPreviewService,$timeout,LocalStorageService,Utils){TrackingService.trackPageView("Callback","Callback");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Callback");$scope.currentUser=$rootScope.currentUser;$scope.customerNo=$routeParams.customerNo;$scope.countries=[{code:"AR",name:"Argentina"},{code:"AU",name:"Australia"},{code:"AT",name:"Austria"},{code:"BH",name:"Bahrain"},{code:"BE",name:"Belgium"},{code:"BR",name:"Brazil"},{code:"BG",name:"Bulgaria"},{code:"CA",name:"Canada"},{code:"CF",name:"Central Africa"},{code:"CL",name:"Chile"},{code:"CN",name:"China"},{code:"CY",name:"Cyprus"},{code:"DK",name:"Denmark"},{code:"EG",name:"Egypt"},{code:"EE",name:"Estonia"},{code:"FI",name:"Finland"},{code:"FR",name:"France"},{code:"DE",name:"Germany"},{code:"GR",name:"Greece"},{code:"HK",name:"HongKong"},{code:"HU",name:"Hungary"},{code:"IN",name:"India"},{code:"ID",name:"Indonesia"},{code:"IE",name:"Ireland"},{code:"IL",name:"Israel"},{code:"LV",name:"Latvia"},{code:"LT",name:"Lithuania"},{code:"LU",name:"Luxembourg"},{code:"MY",name:"Malaysia"},{code:"MT",name:"Malta"},{code:"NL",name:"Netherlands"},{code:"NZ",name:"NewZealand"},{code:"NO",name:"Norway"},{code:"OM",name:"Oman"},{code:"PH",name:"Philippines"},{code:"PL",name:"Poland"},{code:"QA",name:"Qatar"},{code:"RO",name:"Romania"},{code:"RU",name:"Russia"},{code:"SA",name:"SaudiArabia"},{code:"SG",name:"Singapore"},{code:"SK",name:"Slovakia"},{code:"SI",name:"Slovenia"},{code:"ZA",name:"SouthAfrica"},{code:"SE",name:"Sweden"},{code:"CH",name:"Switzerland"},{code:"TH",name:"Thailand"},{code:"AE",name:"United Arab Emirates"},{code:"GB",name:"United Kingdom"},{code:"UA",name:"Ukraine"},{code:"US",name:"United States"}];$scope.validateCountry=function(){for(var i=0;i<$scope.countries.length;i++){if($scope.customer.address.country.code==$scope.countries[i].code){$scope.isValidCountry=true;$scope.country=$scope.customer.address.country.code;return}else{$scope.isValidCountry=false}}if($scope.customer.address.country.name==null||$scope.customer.address.country.name==""){$scope.customer.address.country.name=$scope.customer.address.country.code}};$scope.customer={};$scope.showMessage=function(type,message){$scope.customer.messages=[];$scope.customer.messages.push({info:type=="info",error:type=="error",success:type=="success",text:message})};$scope.Queue={};$scope.Queue.loadQueues=function(){$scope.isLoading=true;var data={};VHTCallbackService.getVHTQueue(data).success(function(response){$scope.Queue.refreshedTimeStamp=new Date();$scope.Queue.queueList=response;$scope.isLoading=false}).error(function(errorData){$scope.showMessage("error","Error in getting queues. Please try again.");console.log("Error in getting queues");$scope.isLoading=false})};var refreshTimer;$scope.isSaving=false;$scope.Queue.getVHTStatus=function(){VHTCallbackService.getStatus().success(function(response){if(response.statusCode==107000&&response.systemStatusCode==106000){$scope.Queue.loadQueues();$scope.getCustomerDetails();refreshTimer=setInterval(function(){$scope.$apply(function(){$scope.Queue.loadQueues()})},60000)}else{$scope.isLoading=false;$scope.showMessage("error","System is down under maintanence. Please contact your admin.")}}).error(function(errorData){$scope.isLoading=false;$scope.showMessage("error","System is down under maintanence. Please contact your admin.")})};$scope.$on("$destroy",function(e){if(refreshTimer){clearInterval(refreshTimer)}});$scope.Queue.scheduleCallback=function(){if($scope.isFormValid){$scope.isSaving=true;var data={customerNo:$scope.isCustomerAvail==true?$scope.customerGUID:"000000000000000000000000",customerName:$scope.name,queueId:$scope.Queue.currentQueueID,adobeId:$scope.email,caseId:$scope.caseID,countryCode:$("#countriesList").val(),phoneNumber:$scope.phoneNumber};VHTCallbackService.scheduleVHTCallback(data).success(function(response){console.log(response);$scope.isSaving=false;if(response.statusCode==107000){$scope.showMessage("success","Callback scheduled successfully")}else{if(response.statusCode==107005){$scope.showMessage("error","This queue is no longer accepting callbacks. Please try again later.")}else{$scope.showMessage("error","Callbacks for this queue are unavailable due to system maintanence.")}}$("#myModal").modal("hide");$("html, body").animate({scrollTop:0})}).error(function(errorData){console.log("Error in schedule callback");$scope.isSaving=false;$("#myModal").modal("hide");$scope.showMessage("error","Callbacks for this queue are unavailable due to system maintanence.")})}};$scope.appointmentType="JoinQueue";$timeout(function(){$("#appointmentType").on("change",function(){if($(this).val()=="SetupAppointment"){$(".row-hide").show();$scope.appointmentType="SetupAppointment"}else{$(".row-hide").hide();$scope.appointmentType="JoinQueue"}$scope.isFormValid()})},500);$scope.appointmentDate="";$scope.isFormValid=function(){if($scope.appointmentType=="JoinQueue"){return $scope.country!=""&&$scope.appointmentType!=""&&$scope.phoneNumber&&$scope.name}else{return $scope.country!=""&&$scope.appointmentType!=""&&$scope.phoneNumber&&$scope.name&&$scope.appointmentDate!=""}};$scope.loadingCustomer=false;$scope.getCustomerDetails=function(){if(typeof $scope.customerNo=="undefined"){$scope.isCustomerAvail=false;console.log("Customer not found");return}$scope.isValidCountry=true;$scope.loadingCustomer=true;CustomerPreviewService.getCustomerWithoutLocking({customerNo:$scope.customerNo}).success(function(result,status){if(status!=200){$scope.showMessage("error","The Customer Number is Not Valid");$scope.loadingCustomer=false;$scope.isCustomerAvail=false;return}$scope.customer=result;for(var i=0;i<$scope.customer.customerIdentifications.length;i++){if($scope.customer.customerIdentifications[i].idType=="ZGUID"){$scope.customerGUID=$scope.customer.customerIdentifications[i].idNumber}}$scope.phoneNumber=$scope.customer.telephone==""?$scope.customer.mobileNo:$scope.customer.telephone;$scope.name=$scope.customer.firstName+" "+$scope.customer.lastName;$scope.email=$scope.customer.email;$scope.validateCountry();$scope.isCustomerAvail=true;$scope.loadingCustomer=false;console.log("Customer Info Loaded")}).error(function(errorData){$scope.loadingCustomer=false;$scope.isCustomerAvail=false;console.log("Customer number not valid");$scope.showMessage("error","The Customer Number is Not Valid")})};$scope.Queue.getVHTStatus()}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("VHTCallbackService",["$http",function($http){var service={};service.getVHTQueue=function(data){return $http({method:"GET",url:"/callback/queueStat.json?antiCache="+new Date().getTime().toString()})};service.scheduleVHTCallback=function(data){return $http({method:"POST",url:"../callbackService/requestCallback.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getStatus=function(){return $http({method:"GET",url:"../callbackService/getStatus.do"})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CancellationService",["$http",function($http){var service={};service.getSubscriptionDetails=function(data){return $http({method:"GET",url:"../subscriptionService/getSubscriptionDetails.do",params:{subscriptionId:data.subscriptionId,subscriptionAccountId:data.subscriptionAccountId+"@AdobeID",locale:"",displayPromoData:true}})};service.getCancellationPreviewDetails=function(cancellationPreviewRequestObj){return $http({method:"GET",url:"../csuiService/getCancelPreview.do",params:cancellationPreviewRequestObj})};service.cancelImmediately=function(data){return $http({method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../subscriptionService/cancelSubscription.do",params:{cancelSubscriptionJson:{terminateRule:"IMMEDIATELY",reasonCode:data.isCountryChange?"COUNTRY_CHANGED":""},subscriptionId:data.subscriptionId,customerGuid:data.customerGuid,subscriptionType:"",reasonCode:data.reasonCode,note:data.note,sku:data.sku,etfAmount:data.etfAmount,currency:data.currency,eccContractId:data.eccContractId,creditDebitMemoNo:data.creditDebitMemoNo}})};service.cancelByStopBilling=function(data){return $http({method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../subscriptionService/cancelSubscription.do",params:{cancelSubscriptionJson:{terminateRule:"NEXT_BILLING_CYCLE",reasonCode:data.isCountryChange?"COUNTRY_CHANGED":""},subscriptionId:data.subscriptionId,customerGuid:data.customerGuid,subscriptionType:"",reasonCode:data.reasonCode,note:data.note,sku:data.sku,etfAmount:data.etfAmount,currency:data.currency,eccContractId:data.eccContractId,creditDebitMemoNo:data.creditDebitMemoNo}})};service.getChangePlanOffers=function(data){return $http({method:"GET",url:"../subscriptionService/relatedOffers.do",params:{offerId:data.offerId,country:data.country,locale:""}})};service.getChangePlanPreview=function(data){return $http({method:"GET",url:"../subscriptionService/changePlanPreview.do",params:{subscriptionId:data.subscriptionId,offerId:data.offerId,customerGuid:data.customerGuid,locale:"",suppressOfferData:false}})};service.applyPlanChange=function(data){return $http({method:"POST",url:"../subscriptionService/changePlan.do",params:{validationToken:data.validationToken,toSubscriptionOfferId:data.toSubscriptionOfferId,subscriptionId:data.subscriptionId,customerGuid:data.customerGuid,locale:"",asynchronous:"false",planChangeReasonCode:data.reasonCode,isSave:data.isSave,saveReasonCode:data.saveReasonCode}})};service.saveSubscription=function(data){return $http({method:"GET",url:"../csuiService/saveSubscription.do",params:{subscriptionAccountID:data.subscriptionAccountID,saveReasonCode:data.saveReasonCode,customerGuid:data.customerGuid,note:data.note,etfAmount:data.etfAmount,currency:data.currency,cancelReason:data.cancelReason,eccContractId:data.eccContractId,isTeam:false,productCode:data.productCode,}})};service.search=function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CancelSubscriptionController",["$scope","$rootScope","$location","$routeParams","$timeout","TrackingService","TransactionService","SubscriptionService","SubscriptionConstants","Utils","AppUtils","AppConstants","MetadataService","CancellationService","PaymentConstants","TransactionConstants","SubscriptionUtil",function($scope,$rootScope,$location,$routeParams,$timeout,TrackingService,TransactionService,SubscriptionService,SubscriptionConstants,Utils,AppUtils,AppConstants,MetadataService,CancellationService,PaymentConstants,TransactionConstants,SubscriptionUtil){TrackingService.trackPageView("Subscription","Cancel Subscription View");$scope.INITIALIZE_DM_TRANSACTION="INITIALIZE_DM_TRANSACTION";$scope.INITIALIZE_CM_TRANSACTION="INITIALIZE_CM_TRANSACTION";$scope.CREATE_DEBIT_MEMO_EVENT_FAILED="CREATE_DEBIT_MEMO_EVENT_FAILED";$scope.CREATE_CREDIT_MEMO_EVENT_FAILED="CREATE_CREDIT_MEMO_EVENT_FAILED";$scope.DEBIT_MEMO_VIEW_LOADED="DEBIT_MEMO_VIEW_LOADED";$scope.CREDIT_MEMO_VIEW_LOADED="CREDIT_MEMO_VIEW_LOADED";$scope.CREATE_DEBIT_MEMO_EVENT_SUCCESS="CREATE_DEBIT_MEMO_EVENT_SUCCESS";$scope.CREATE_CREDIT_MEMO_EVENT_SUCCESS="CREATE_CREDIT_MEMO_EVENT_SUCCESS";$scope.BACK_TO_SUBSCRIPTION_DETAILS="BACK_TO_SUBSCRIPTION_DETAILS";$scope.SAVE_MIGRATION_PATH_UNAVAILABLE="SAVE MIGRATION PATH UNAVAILABLE";$scope.SAVE_OTHER_MANDATORY_TEXT="OTHER REASON";$scope.WIZARD_STEP_CANCEL_REASON=1;$scope.WIZARD_STEP_CANCEL_CRITERIA=2;$scope.WIZARD_STEP_DEBIT_MEMO=3;$scope.WIZARD_STEP_DEBIT_MEMO_CONFIRM=4;$scope.WIZARD_STEP_REFUND_REASON=5;$scope.WIZARD_STEP_CREDIT_MEMO=6;$scope.WIZARD_STEP_CREDIT_MEMO_CONFIRM=7;$scope.WIZARD_STEP_WITHOUT_FEE_REASON=8;$scope.WIZARD_STEP_WITHOUT_FEE_CONFIRM=9;$scope.WIZARD_STEP_CREDIT_DAYS=10;$scope.WIZARD_STEP_CREDIT_DAYS_CONFIRM=11;$scope.WIZARD_STEP_CHANGE_PLAN=12;$scope.WIZARD_STEP_CHANGE_PLAN_TNC=13;$scope.WIZARD_STEP_CHANGE_PLAN_PREVIEW=14;$scope.WIZARD_STEP_CHANGE_PLAN_CONFIRM=15;$scope.WIZARD_STEP_NO_CHANGE_PLAN_CONFIRM=16;$scope.WIZARD_STEP_SAVE_MOVE_TO_CCT=17;$scope.WIZARD_STEP_SAVE_MOVE_TO_CCT_CONFIRM=18;$scope.WIZARD_STEP_SAVE_OTHERS_PREVIEW=19;$scope.WIZARD_STEP_SAVE_OTHERS=20;$scope.WIZARD_STEP_SAVE_OTHERS_CONFIRM=21;$scope.CANCEL_TYPE_STOP_BILLING=1;$scope.CANCEL_TYPE_IMMEDIATELY=2;$scope.CANCEL_SELECTION_WITH_PENALTY=1;$scope.CANCEL_SELECTION_WITHOUT_FEE=2;$scope.CANCEL_SELECTION_WITH_REFUND=3;$scope.CANCEL_SELECTION_SAVE=4;$scope.CANCEL_REASON_OTHER_CODE="Y218";$scope.CANCEL_REASON_CHANGE_COUNTRY_CODE="Y266";$scope.CANCEL_REFUND_REASON_CHANGE_COUNTRY_CODE=$scope.CANCEL_WITHOUT_REASON="Customer moved to new country";$scope.CANCEL_CRM_REAONS="CBC";$scope.SubscriptionConstants=SubscriptionConstants;$scope.PaymentConstants=PaymentConstants;$scope.TransactionConstants=TransactionConstants;$scope.wizardStep=$scope.WIZARD_STEP_CANCEL_REASON;$scope.cancelReason={selectedId:null};$scope.cancelRefundReason={selectedId:null};$scope.cmReason={selectedId:null};$scope.cancelWithoutFeeReason={selectedId:null};$scope.changePlanSaveReason={selectedId:null};$scope.creditDays={selectedId:null};$scope.creditMemoReturnReasons=[];$scope.cancellationAccountDetails;$scope.cancellationPreviewDetails;$scope.cancelSubscriptionNote;$scope.cancellationReasonOther={selectedText:null};$scope.cancellationType=$scope.CANCEL_TYPE_STOP_BILLING;$scope.isDebitMemoFlow=false;$scope.isCreditMemoFlow=false;$scope.isWithoutFeeFlow=false;$scope.isSaveSuccessfulFlow=$scope.isCreditDaysFlow=$scope.isChangePlanFlow=$scope.isNoChangePlanFlow=$scope.isMoveToCctFlow=$scope.isSaveOthersFlow=$scope.isSaveOthersTextFlow=false;$scope.isDebitMemoViewLoaded=false;$scope.isCancelSubscriptionInitializeComplete=false;$scope.isWithoutFeeSaveOptionSelected=false;$scope.isCreditDaysInputEnabled=false;$scope.isPosaSubscription=false;$scope.isSubscriptionInProcess=false;$scope.isCancelReasonNextDisable=true;$scope.isCancelWithoutFee=false;$scope.isChangePlanBtnDisabled=false;$scope.isTncButtonDisabled=true;$scope.creditDaysValue={selectedNumber:1};$scope.isCsCaseExists="Yes";$scope.isCctCsCaseExist=$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isCreditDaysCsCaseExist=$scope.isChangePlanCsCaseExist=$scope.isNoChangePlanCsCaseExists=$scope.isSaveOthersCsCaseExist=true;$scope.defaultCancellationSelection;$scope.defaultCancellationSelectionBtn;$scope.cancelSubscriptionSelectedChangePlan;var errorDetails={};Utils.pageTitle("Cancel Subscription [ "+$scope.subscriptionId+" ]");angular.forEach($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],function(reasonItem){var cmReasonItem=angular.copy(reasonItem);if(cmReasonItem[MetadataService.INDEX_NAMES.ORDER_TYPE]==TransactionConstants.TRANSACTION_CREDIT_MEMO){if(cmReasonItem.code==TransactionConstants.SELF_CANCELLATION_CM_REASON_CODE){}else{$scope.creditMemoReturnReasons.push(cmReasonItem)}}});$scope.$watch("cancelReason.selectedId",function(){if($scope.cancelReason.selectedId!=null&&$scope.cancelReason.selectedId!=""){angular.forEach($scope.metadata.subscriptionMetadata.cancellation_reason,function(reason){if(reason.crmcode==$scope.cancelReason.selectedId){$scope.cancelReasonCsuiCode=reason.code}});if($scope.cancelReason.selectedId!=$scope.CANCEL_REASON_OTHER_CODE){$scope.wizardStep=$scope.WIZARD_STEP_CANCEL_CRITERIA}else{$scope.cancellationReasonOther.selectedText=null}}$scope.checkCancelReasonNextEnable()},true);$scope.$watch("cancelRefundReason.selectedId",function(){if($scope.cancelRefundReason.selectedId!=null&&$scope.cancelRefundReason.selectedId!=""&&$scope.cmReason.selectedId!=null&&$scope.cmReason.selectedId!=""){$scope.wizardStep=$scope.WIZARD_STEP_CREDIT_MEMO;$scope.$broadcast($scope.INITIALIZE_CM_TRANSACTION,"Transaction Initialize")}},true);$scope.$watch("cmReason.selectedId",function(){if($scope.cmReason.selectedId!=null&&$scope.cmReason.selectedId!=""&&$scope.cancelRefundReason.selectedId!=null&&$scope.cancelRefundReason.selectedId!=""){$scope.wizardStep=$scope.WIZARD_STEP_CREDIT_MEMO;$scope.$broadcast($scope.INITIALIZE_CM_TRANSACTION,"Transaction Initialize")}},true);$scope.validateIsCsCaseExist=function(selectedValue){console.log(selectedValue);if(selectedValue=="Yes"){$scope.isCctCsCaseExist=$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isCreditDaysCsCaseExist=$scope.isChangePlanCsCaseExist=$scope.isSaveOthersCsCaseExist=$scope.isNoChangePlanCsCaseExists=true}else{$scope.isCctCsCaseExist=$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isCreditDaysCsCaseExist=$scope.isChangePlanCsCaseExist=$scope.isSaveOthersCsCaseExist=$scope.isNoChangePlanCsCaseExists=false}};$scope.$watch("creditDays.selectedId",function(){$scope.isCreditDaysInputEnabled=false;if($scope.creditDays.selectedId!=null&&$scope.creditDays.selectedId!=""){if(angular.uppercase($scope.creditDays.selectedId).indexOf("GAVE ONE MONTH")>=0){$scope.creditDaysValue.selectedNumber=31}else{if(angular.uppercase($scope.creditDays.selectedId).indexOf("GAVE TWO MONTHS")>=0){$scope.creditDaysValue.selectedNumber=62}else{if(angular.uppercase($scope.creditDays.selectedId).indexOf("GAVE MORE THAN TWO MONTHS")>=0){$scope.creditDaysValue.selectedNumber=93}else{$scope.creditDaysValue.selectedNumber=1;$scope.isCreditDaysInputEnabled=true}}}}},true);$scope.$watch("cancellationReasonOther.selectedText",function(){$scope.checkCancelReasonNextEnable()},true);$scope.checkCancelReasonNextEnable=function(){if($scope.cancelReason.selectedId&&$scope.cancelReason.selectedId==$scope.CANCEL_REASON_OTHER_CODE){if($scope.cancellationReasonOther.selectedText){$scope.isCancelReasonNextDisable=false}else{$scope.isCancelReasonNextDisable=true}}else{if($scope.cancelReason.selectedId){$scope.isCancelReasonNextDisable=false}else{$scope.isCancelReasonNextDisable=true}}};$scope.initializeCancelSubscriptionScreen=function(){$scope.cancelSubscriptionDto=SubscriptionUtil.getSubscriptionDto($scope.subscriptionDetails);$scope.paymentInfoDetails=SubscriptionUtil.getPaymentType($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo);$scope.loadingMessage="Loading Details, Please wait...";$scope.showViewLoading();$scope.cancelPreviewError="";if($scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE_STUDENT||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_DIGITAL_RIVER_PAYMENT||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_APPLE_PAYMENT||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_GOOGLE_PAYMENT||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_AMAZON_PAYMENT||$scope.cancelSubscriptionDto.sourceType==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED_PAYMENT){$scope.isPosaSubscription=true}if($scope.cancelSubscriptionDto.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PROCESSING){$scope.isSubscriptionInProcess=true}$scope.initializeCaseCategories();$scope.showViewLoading();if(($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.address&&$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.address.country.countryCode==SubscriptionConstants.JP_COUNTRY_CODE&&$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase()=="OFFLINE")||($scope.paymentInfoDetails.paymentType==0||$scope.paymentInfoDetails.cardTypeName=="")||!$scope.cancelSubscriptionDto.isChangePlanAvailable){$scope.isChangePlanBtnDisabled=true}if($scope.isPosaSubscription){$scope.isCancelSubscriptionInitializeComplete=true;$scope.hideViewLoading();$scope.searchCustomerByOrderId();return}var cancellationPreviewRequestObj={accountGuid:$scope.cancelSubscriptionDto.id,isChangeCountry:false};if($scope.isCountryChangeFLow()){cancellationPreviewRequestObj.isChangeCountry=true;$scope.cancelReason.selectedId=$scope.CANCEL_REASON_CHANGE_COUNTRY_CODE}CancellationService.getCancellationPreviewDetails(cancellationPreviewRequestObj).success(function(result){$scope.cancellationPreviewDetails=result;if(angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[0].ruleId)=="REMAINDERMONTHS50_V01"){$scope.defaultCancellationSelection=$scope.CANCEL_SELECTION_WITH_PENALTY;$scope.cancellationPreviewDetails.refundTotalPrice=0;$scope.cancellationPreviewDetails.debitTotalPrice=$scope.cancellationPreviewDetails.contracts[0].items[0].prices[0].price.priceWithTax}else{if(angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[1].ruleId)=="FULL_V01"||angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[1].ruleId)=="REFUNDOFCURRENTBILLINGCYCLE_V01"||angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[1].ruleId)=="TRANSITION_REFUNDOFCURRENTBILLINGCYCLE_V01"){$scope.defaultCancellationSelection=$scope.CANCEL_SELECTION_WITH_REFUND;$scope.cancellationPreviewDetails.refundTotalPrice=$scope.cancellationPreviewDetails.contracts[0].items[0].prices[1].price.priceWithTax;$scope.cancellationPreviewDetails.debitTotalPrice=0}else{if(angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[1].ruleId)=="NOREFUND_V01"){$scope.defaultCancellationSelection=$scope.CANCEL_SELECTION_WITHOUT_FEE;$scope.cancellationPreviewDetails.refundTotalPrice=0;$scope.cancellationPreviewDetails.debitTotalPrice=0}}}if(angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[2].ruleId)=="STOPIMMEDIATE_V01"){$scope.defaultCancellationSelectionBtn=$scope.CANCEL_TYPE_IMMEDIATELY}else{if(angular.uppercase($scope.cancellationPreviewDetails.contracts[0].items[0].prices[2].ruleId)=="STOPATNEXTBILL_V01"){$scope.defaultCancellationSelectionBtn=$scope.CANCEL_TYPE_STOP_BILLING}}$scope.cancelSubscriptionDto.orderNumber=$scope.cancellationPreviewDetails.contracts[0].contractId;$scope.getTransactionDetails();$scope.searchCustomerByOrderId();$scope.isCancelSubscriptionInitializeComplete=true;$scope.hideViewLoading()}).error(function(result){$scope.hideViewLoading();$scope.cancelPreviewError="The order is being processed right now. Please try after 2 hours!";$scope.searchCustomerByOrderId();$scope.isCancelWithoutFee=true;AppUtils.sendLogToServer("ECC Cancellation Service Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId)})};$scope.getTransactionDetails=function(){TransactionService.getTransaction({guid:"",number:$scope.cancelSubscriptionDto.orderNumber,subscriptionId:""}).success(function(result){$scope.crmTransaction=result}).error(function(){})};$scope.initializeCaseCategories=function(){$scope.caseCategories=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.META_PRODUCT_CATEGORIES],function(item){if(item.name.indexOf("*")!=0&&item.code=="Y06"){$scope.caseCategories.push(item)}})};$scope.searchCustomerByOrderId=function(){$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:$scope.customerGuid,customerType:"1"};CancellationService.search($scope.searchFields).success(function(result){if(result&&result.customerSearchResults&&result.customerSearchResults.length==1){$scope.cancelSubscriptionDto.customerNo=result.customerSearchResults[0].customerNo}else{$scope.cancelSubscriptionDto.customerNo=$scope.customerDetails.customerNo}}).error(function(result){$scope.cancelSubscriptionDto.customerNo=$scope.customerDetails.customerNo})};$scope.startDebitMemo=function(type){$scope.cancellationType=type;$scope.isCreditMemoFlow=$scope.isWithoutFeeFlow=$scope.isSaveSuccessfulFlow=false;$scope.isDebitMemoFlow=true;$scope.wizardStep=$scope.WIZARD_STEP_DEBIT_MEMO;$scope.$broadcast($scope.INITIALIZE_DM_TRANSACTION,"Transaction Initialize")};$scope.startCreditMemo=function(type){$scope.cancellationType=type;$scope.isDebitMemoFlow=$scope.isWithoutFeeFlow=$scope.isSaveSuccessfulFlow=false;$scope.isCreditMemoFlow=true;$scope.wizardStep=$scope.WIZARD_STEP_REFUND_REASON;if($scope.isCountryChangeFLow()){$scope.cancelRefundReason.selectedId=$scope.CANCEL_REFUND_REASON_CHANGE_COUNTRY_CODE;$scope.cmReason.selectedId=$scope.CANCEL_CRM_REAONS;$("#s2id_cancelSubscriptionRefundReasons >a >span").text($scope.CANCEL_REFUND_REASON_CHANGE_COUNTRY_CODE);$("#s2id_cancelSubscriptionCreditMemoReasons >a >span").text($scope.CANCEL_REFUND_REASON_CHANGE_COUNTRY_CODE)}$scope.$broadcast($scope.INITIALIZE_CM_TRANSACTION,"Transaction Initialize")};$scope.startWithoutFeeFlow=function(type){$scope.cancellationType=type;$scope.isWithoutFeeFlow=true;$scope.isDebitMemoFlow=$scope.isCreditMemoFlow=$scope.isSaveSuccessfulFlow=false;if($scope.isCountryChangeFLow()){$scope.cancelWithoutFeeReason.selectedId=$scope.CANCEL_WITHOUT_REASON;$("#s2id_cancelSubscriptionWithoutFeeReasons >a >span").text($scope.CANCEL_WITHOUT_REASON)}$scope.wizardStep=$scope.WIZARD_STEP_WITHOUT_FEE_REASON};$scope.startSaveSuccessful=function(wizardStep,description){$scope.isSaveSuccessfulFlow=true;$scope.isDebitMemoFlow=$scope.isCreditMemoFlow=$scope.isWithoutFeeFlow=false;$scope.saveSuccessfulOtherDescription=description;$scope.saveSuccessfulOtherNote="";$scope.isCreditDaysFlow=$scope.isChangePlanFlow=$scope.isNoChangePlanFlow=false;$scope.setWizardStep(wizardStep);$scope.isCreditDaysFlow=$scope.isChangePlanFlow=$scope.isNoChangePlanFlow=$scope.isMoveToCctFlow=$scope.isSaveOthersFlow=$scope.isSaveOthersTextFlow=false;if(wizardStep==$scope.WIZARD_STEP_CREDIT_DAYS){$scope.isCreditDaysFlow=true}else{if(wizardStep==$scope.WIZARD_STEP_CHANGE_PLAN){$scope.isChangePlanFlow=true;$scope.initiateChangePlan()}else{if(wizardStep==$scope.WIZARD_STEP_SAVE_MOVE_TO_CCT){$scope.isMoveToCctFlow=true}else{if(wizardStep==$scope.WIZARD_STEP_SAVE_OTHERS_PREVIEW){$scope.isSaveOthersFlow=$scope.isSaveOthersTextFlow=false;if(angular.uppercase(description)==$scope.SAVE_OTHER_MANDATORY_TEXT){$scope.isSaveOthersTextFlow=true;$scope.setWizardStep($scope.WIZARD_STEP_SAVE_OTHERS)}else{$scope.isSaveOthersFlow=true;$scope.setWizardStep($scope.WIZARD_STEP_SAVE_OTHERS_PREVIEW)}}}}}};$scope.$on($scope.CREATE_DEBIT_MEMO_EVENT_FAILED,function(event,messages,result){$scope.setWizardStep($scope.WIZARD_STEP_DEBIT_MEMO_CONFIRM);if(result){$scope.errorMessages=result.messages}});$scope.$on($scope.CREATE_CREDIT_MEMO_EVENT_FAILED,function(event,messages,result){$scope.setWizardStep($scope.WIZARD_STEP_CREDIT_MEMO_CONFIRM);if(result){$scope.errorMessages=result.messages}});$scope.$on($scope.DEBIT_MEMO_VIEW_LOADED,function(event,messages){$scope.isDebitMemoViewLoaded=true});$scope.$on($scope.CREATE_DEBIT_MEMO_EVENT_SUCCESS,function(event,message,transaction){$scope.errorMessages=null;$scope.wizardStep=$scope.WIZARD_STEP_DEBIT_MEMO_CONFIRM;$scope.createdDebitMemoTransaction=transaction;$scope.creditDebitMemoNo=$scope.createdDebitMemoTransaction.transactionNumber;$scope.cancelSubscriptionNote="With Fee - "+$scope.createdDebitMemoTransaction.transactionNumber+" | Reason: None";$scope.cancelSubscription()});$scope.$on($scope.CREATE_CREDIT_MEMO_EVENT_SUCCESS,function(event,message,transaction){$scope.errorMessages=null;$scope.setWizardStep($scope.WIZARD_STEP_CREDIT_MEMO_CONFIRM);$scope.createdCreditMemoTransaction=transaction;$scope.creditDebitMemoNo=$scope.createdCreditMemoTransaction.transactionNumber;$scope.createCreditMemoCsCase();$scope.cancelSubscriptionNote="With Refund - "+$scope.createdCreditMemoTransaction.transactionNumber+" | Reason: "+$scope.cancelRefundReason.selectedId;$scope.cancelSubscription()});$scope.cancelSubscriptionFromWithoutFee=function(){$scope.setWizardStep($scope.WIZARD_STEP_WITHOUT_FEE_CONFIRM);$scope.cancelSubscriptionNote="Without Fee | Reason: "+$scope.cancelWithoutFeeReason.selectedId;$scope.cancelSubscription();if(angular.uppercase($scope.cancelWithoutFeeReason.selectedId).indexOf($scope.SAVE_MIGRATION_PATH_UNAVAILABLE)>=0){$scope.isWithoutFeeSaveOptionSelected=true}else{$scope.isWithoutFeeSaveOptionSelected=false}};$scope.cancelSubscriptionForMoveToCct=function(){$scope.cancelSubscriptionNote="Moved To CCT";$scope.cancellationType=$scope.CANCEL_TYPE_IMMEDIATELY;$scope.setWizardStep($scope.WIZARD_STEP_SAVE_MOVE_TO_CCT_CONFIRM);$scope.cancelSubscription()};$scope.cancelSubscriptionForNoChangePlan=function(){$scope.isChangePlanFlow=false;$scope.isNoChangePlanFlow=true;$scope.cancelSubscriptionNote="Without Fee | Reason: Save migration path unavailable";$scope.cancellationType=$scope.CANCEL_TYPE_IMMEDIATELY;$scope.setWizardStep($scope.WIZARD_STEP_NO_CHANGE_PLAN_CONFIRM);$scope.cancelSubscription()};$scope.cancelSubscription=function(){$scope.loadingMessage="Cancelling Subscription, Please wait...";$scope.showViewLoading();if($scope.cancellationType==$scope.CANCEL_TYPE_IMMEDIATELY){$scope.cancelSubscriptionImmediately()}else{$scope.cancelSubscriptionByStopBilling()}};$scope.initiateChangePlan=function(){$scope.isChangePlanListServiceLoading=true;$scope.loadingMessage="Finding Subscription Plans, Please wait...";$scope.showViewLoading();$scope.offerType="Standard";var changePlans={offerId:$scope.subscriptionDetails.offerId,country:$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.address.country.countryCode};if($scope.subscriptionDetails.offerId.startsWith("non_sds")){$scope.isChangePlanListServiceLoading=false;$scope.subscriptionChangePlans=null;$scope.isChangePlanFlow=false;$scope.isNoChangePlanFlow=true;$scope.changePlanMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_INFO_TYPE,"There are no plans available for upgrade or downgrade.");$scope.hideViewLoading()}else{CancellationService.getChangePlanOffers(changePlans).success(function(result){$scope.isChangePlanListServiceLoading=false;$scope.subscriptionChangePlans=SubscriptionUtil.getChangePlanOfferDetails(result.relatedOffers);if($scope.subscriptionChangePlans.length>0){$scope.changePlanMessages=null;$scope.isChangePlanFlow=true;$scope.isNoChangePlanFlow=false}else{$scope.subscriptionChangePlans=null;$scope.isChangePlanFlow=false;$scope.isNoChangePlanFlow=true;$scope.changePlanMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_INFO_TYPE,"There are no plans available for upgrade or downgrade.")}$scope.hideViewLoading()}).error(function(result){$scope.isChangePlanListServiceLoading=false;errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.changePlanMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation Get Change Plans Service Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId)})}};$scope.openChangePlanPreview=function(selectedPlan){$scope.isChangePlanFlow=true;$scope.isNoChangePlanFlow=false;$scope.isChangePlanPreviewLoading=true;$scope.cancelSubscriptionSelectedChangePlan=selectedPlan;$scope.loadingMessage="Verifying Subscription Plan, Please wait...";$scope.showViewLoading();$scope.stockValidationMsg="";var verifyPlanData={subscriptionId:$scope.subscriptionId,offerId:selectedPlan.offerId,customerGuid:$scope.customerGuid};if(selectedPlan.displayPrice==""){selectedPlan.stockValidationMsg=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Incomplete offer information. Switch is not possible!");$scope.hideViewLoading();$scope.isChangePlanPreviewLoading=false;return}var requestProductSearchDto=new Object();$scope.crmData=new Object();requestProductSearchDto.storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};crmSearchObject.sku=selectedPlan.sku;requestProductSearchDto.criteria=crmSearchObject;SubscriptionService.search(requestProductSearchDto).success(function(result){if(result&&result.length==1){$scope.crmData=result[0];if($scope.crmData.stock&&$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase()=="DIRECT_DEBIT"){selectedPlan.stockValidationMsg=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Can not process an Adobe Stock upgrade plan as payment type is Direct Debit. A standalone Adobe Stock plan may be purchase from Hendrix instead.");$scope.hideViewLoading();$scope.isChangePlanPreviewLoading=false}else{$scope.setWizardStep($scope.WIZARD_STEP_CHANGE_PLAN_PREVIEW);CancellationService.getChangePlanPreview(verifyPlanData).success(function(result){$scope.hideViewLoading();$scope.isChangePlanPreviewLoading=false;if(angular.isObject(result)){$scope.cancelChangePlanPreviewDetails=result;$scope.cancelChangePlanPreviewDetails.productImg="https://wwwimages2.adobe.com"+$scope.cancelChangePlanPreviewDetails.offer.material.data.detail.primaryImageUrl;if($scope.cancelChangePlanPreviewDetails.cancellation.refund.amount.price.priceWithTax){$scope.showRefundMsg="Refund: As per the calculation, a refund amount of "+$scope.cancelChangePlanPreviewDetails.cancellation.refund.amount.price.priceWithoutTax+" "+$scope.cancelChangePlanPreviewDetails.cancellation.refund.amount.currency.iso3Code+" (exclusive of tax) / "+$scope.cancelChangePlanPreviewDetails.cancellation.refund.amount.price.priceWithTax+" "+$scope.cancelChangePlanPreviewDetails.cancellation.refund.amount.currency.iso3Code+" (inclusive of tax) will be credited to the payment medium registered."}else{$scope.showRefundMsg="Refund: There will be no refund for this subscription switch"}AppUtils.sendLogToServer("Cancellation Change Plan Preview Service Success - Subscription GUID : "+$scope.subscriptionId+"Customer GUID : "+$scope.customerGuid+"New Subscription Offer ID:"+selectedPlan.offerId+"New Sku - "+selectedPlan.sku)}}).error(function(result){$scope.verifyPlanMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Change Plan Preview Service Failed, Please try again...");$scope.hideViewLoading();$scope.isChangePlanPreviewLoading=false;AppUtils.sendLogToServer("Cancellation Change Plan Preview Service Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+$scope.subscriptionId+"Customer GUID : "+$scope.customerGuid+"New Subscription Offer ID:"+selectedPlan.offerId+"New Sku - "+selectedPlan.sku)})}}}).error(function(result){$scope.verifyPlanMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Change Plan Preview Service Failed, Please try again...");$scope.hideViewLoading();$scope.isChangePlanPreviewLoading=false;AppUtils.sendLogToServer("Cancellation Change Plan Preview Service Failed - Failed to load SKU search. Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+"New Sku - "+selectedPlan.sku)})};$scope.cancelSubscriptionImmediately=function(){$scope.isCancelServiceLoading=true;$scope.showViewLoading();$scope.errorMessages=null;$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"debitTotalPrice")?$scope.cancellationPreviewDetails.debitTotalPrice:"";if($scope.etfAmount==""||$scope.etfAmount==0){$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"refundTotalPrice")?$scope.cancellationPreviewDetails.refundTotalPrice:0;$scope.etfAmount=0-$scope.etfAmount}var cancelData={subscriptionId:$scope.cancelSubscriptionDto.id,customerGuid:$scope.customerGuid,subscriptionType:"",reasonCode:$scope.cancelReasonCsuiCode,note:$scope.cancelSubscriptionNote,sku:$scope.cancelSubscriptionDto.sku,isCountryChange:$scope.isCountryChangeFLow(),etfAmount:$scope.etfAmount,currency:_.has($scope.cancellationPreviewDetails,"currency.iso3code")?$scope.cancellationPreviewDetails.currency.iso3code:"",eccContractId:$scope.subscriptionDetails.contract.externalContractId,creditDebitMemoNo:$scope.creditDebitMemoNo};CancellationService.cancelImmediately(cancelData).success(function(result,status,headers,config){$scope.refreshSubscription();$scope.isCancelServiceLoading=false;$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation(Immediate) Completed Successfully: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+"Customer GUID :"+$scope.customerGuid+", Country Change Flow : "+$scope.isCountryChangeFLow());if($scope.isCountryChangeFLow()){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Functionality="Cancel Subscription - Country Change";messageObject.Cancellation_Type="Immediate";messageObject["Subscription ID"]=$scope.cancelSubscriptionDto.subscriptionAccountId;messageObject["Customer GUID"]=$scope.customerGuid;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.errorMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message+"The service failed to cancel subscription, please try again...");$scope.isCancelServiceLoading=false;$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation(Immediate) Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+"Customer GUID :"+$scope.customerGuid+", Country Change Flow : "+$scope.isCountryChangeFLow());if($scope.isCountryChangeFLow()){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Functionality="Cancel Subscription - Country Change";messageObject.Cancellation_Type="Immediate";messageObject["Subscription ID"]=$scope.cancelSubscriptionDto.subscriptionAccountId;messageObject["Customer GUID"]=$scope.customerGuid;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}})};$scope.cancelSubscriptionByStopBilling=function(){$scope.isCancelServiceLoading=true;$scope.showViewLoading();$scope.errorMessages=null;$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"debitTotalPrice")?$scope.cancellationPreviewDetails.debitTotalPrice:"";if($scope.etfAmount==""||$scope.etfAmount==0){$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"refundTotalPrice")?$scope.cancellationPreviewDetails.refundTotalPrice:0;$scope.etfAmount=0-$scope.etfAmount}var cancelData={subscriptionId:$scope.cancelSubscriptionDto.id,customerGuid:$scope.customerGuid,subscriptionType:"",reasonCode:$scope.cancelReasonCsuiCode,note:$scope.cancelSubscriptionNote,sku:$scope.cancelSubscriptionDto.sku,isCountryChange:$scope.isCountryChangeFLow(),etfAmount:$scope.etfAmount,currency:_.has($scope.cancellationPreviewDetails,"currency.iso3code")?$scope.cancellationPreviewDetails.currency.iso3code:"",eccContractId:$scope.subscriptionDetails.contract.externalContractId,creditDebitMemoNo:$scope.creditDebitMemoNo};CancellationService.cancelByStopBilling(cancelData).success(function(result,status,headers,config){$scope.refreshSubscription();$scope.isCancelServiceLoading=false;$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation(Stop Billing) Completed Successfully: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+", Customer GUID :"+$scope.customerGuid+", Country Change Flow : "+$scope.isCountryChangeFLow());if($scope.isCountryChangeFLow()){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Functionality="Cancel Subscription - Country Change";messageObject.Cancellation_Type="Stop Immediate";messageObject["Subscription ID"]=$scope.cancelSubscriptionDto.subscriptionAccountId;messageObject["Customer GUID"]=$scope.customerGuid;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.errorMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message+" The service failed to cancel subscription, please try again...");$scope.isCancelServiceLoading=false;$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation(Stop Billing) Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+", Customer GUID :"+$scope.customerGuid+", Country Change Flow : "+$scope.isCountryChangeFLow());if($scope.isCountryChangeFLow()){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Functionality="Cancel Subscription - Country Change";messageObject.Cancellation_Type="Stop Immediate";messageObject["Subscription ID"]=$scope.cancelSubscriptionDto.subscriptionAccountId;messageObject["Customer GUID"]=$scope.customerGuid;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}})};$scope.applyCreditDays=function(){$scope.isSaveServiceLoading=true;$scope.loadingMessage="Applying Credit Days, Please wait...";$scope.showViewLoading();$scope.errorMessages=null;$scope.setWizardStep($scope.WIZARD_STEP_CREDIT_DAYS_CONFIRM);var creditDaysData={customerGuid:$scope.customerGuid,orderNo:$scope.subscriptionDetails.contract.externalContractId,subscriptionAccountID:$scope.subscriptionId,note:$scope.note,isSave:true,reasonCode:"Customer Retention",saveReasonCode:$scope.creditDays.selectedId,creditDays:$scope.creditDaysValue.selectedNumber};SubscriptionService.addCreditDays(creditDaysData).success(function(result){$scope.isCreditDaysLoading=false;$scope.hideViewLoading();if(result){if(AppUtils.isHavingErrorMessage(result)){$scope.isSaveServiceLoading=false;$scope.errorMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"The service failed to apply credit days, please try again...");AppUtils.sendLogToServer("Cancellation Credit Days Failed: Subscription ID - "+$scope.subscriptionId+" Customer GUID - "+$scope.customerGuid+" Days - "+$scope.creditDaysValue.selectedNumber)}else{$scope.isSaveServiceLoading=false;$scope.refreshSubscription();AppUtils.sendLogToServer("Cancellation Credit Days Completed Successfully: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+" Customer GUID - "+$scope.customerGuid+" Days - "+$scope.creditDaysValue.selectedNumber)}}}).error(function(result){$scope.isSaveServiceLoading=false;$scope.hideViewLoading();$scope.errorMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"The service failed to apply credit days, please try again...");AppUtils.sendLogToServer("Cancellation Credit Days Failed: Subscription ID - "+$scope.subscriptionId+" Customer GUID - "+$scope.customerGuid+" Days - "+$scope.creditDaysValue.selectedNumber)})};$scope.saveSubscription=function(saveReasonCode,noteData){$scope.setWizardStep($scope.WIZARD_STEP_SAVE_OTHERS_CONFIRM);$scope.isSaveServiceLoading=true;$scope.loadingMessage="Saving Subscription, Please wait...";$scope.showViewLoading();$scope.errorMessages=null;$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"debitTotalPrice")?$scope.cancellationPreviewDetails.debitTotalPrice:"";if($scope.etfAmount==""||$scope.etfAmount==0){$scope.etfAmount=_.has($scope.cancellationPreviewDetails,"refundTotalPrice")?$scope.cancellationPreviewDetails.refundTotalPrice:0}var saveData={subscriptionAccountID:$scope.cancelSubscriptionDto.id,customerGuid:$scope.customerGuid,saveReasonCode:saveReasonCode,note:noteData,etfAmount:$scope.etfAmount,currency:_.has($scope.cancellationPreviewDetails,"currency.iso3code")?$scope.cancellationPreviewDetails.currency.iso3code:"",cancelReason:$scope.cancelReasonCsuiCode,eccContractId:$scope.subscriptionDetails.contract.externalContractId,productCode:$scope.subscriptionDetails.productCode};CancellationService.saveSubscription(saveData).success(function(result){$scope.isSaveServiceLoading=false;$scope.hideViewLoading();if(result&&result.STATUS&&result.STATUS==false){$scope.errorMessages="Service Failed - "+result.REASON}else{if(!result){$scope.errorMessages="Service Failed, Please Try Again..."}else{$scope.errorMessages=null;AppUtils.sendLogToServer("Cancellation Save Subscription Completed Successfully: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId)}}}).error(function(result){$scope.isSaveServiceLoading=false;$scope.hideViewLoading();$scope.errorMessages="Service Failed, Please Try Again...";AppUtils.sendLogToServer("Cancellation Save Subscription Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId)})};$scope.refreshSubscription=function(){CancellationService.getSubscriptionDetails({subscriptionId:$scope.cancelSubscriptionDto.id,subscriptionAccountId:$scope.cancelSubscriptionDto.subscriptionAccountId}).success(function(result){$scope.subscriptionDetails=result;if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAID)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE}else{if($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_GRACE_PAST_DUE&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED}else{if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30}else{if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_INACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED}else{if($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED}else{$scope.subscriptionDetails.status=""}}}}}customerNo=$scope.cancelSubscriptionDto.customerNo;$scope.cancelSubscriptionDto=SubscriptionUtil.getSubscriptionDto($scope.subscriptionDetails);$scope.cancelSubscriptionDto.customerNo=customerNo}).error(function(result){})};$scope.checkConfirmPlanEnable=function(){if($scope.changePlanSaveReason.selectedId){if(angular.uppercase($scope.changePlanSaveReason.selectedId)==$scope.SAVE_OTHER_MANDATORY_TEXT){return false}return false}return true};$scope.showTnC=function(){$scope.setWizardStep($scope.WIZARD_STEP_CHANGE_PLAN_TNC)};$scope.doChangePlan=function(){$scope.isSaveServiceLoading=true;$scope.loadingMessage="Changing Plan, Please wait...";$scope.showViewLoading();$scope.errorMessages=null;var saveReason=angular.uppercase($scope.changePlanSaveReason.selectedId)!=$scope.SAVE_OTHER_MANDATORY_TEXT?$scope.changePlanSaveReason.selectedId:$("#changePlanSaveOtherFreeText").val();var confirmPlanData={validationToken:$scope.cancelChangePlanPreviewDetails.cancellation.validationToken,toSubscriptionOfferId:$scope.cancelChangePlanPreviewDetails.offerId,subscriptionId:$scope.subscriptionId,customerGuid:$scope.customerGuid,locale:"",asynchronous:"false",reasonCode:"Customer Retention",isSave:"true",saveReasonCode:saveReason};CancellationService.applyPlanChange(confirmPlanData).success(function(result){$scope.isSaveServiceLoading=false;$scope.hideViewLoading();$scope.refreshSubscription();$scope.setWizardStep($scope.WIZARD_STEP_CHANGE_PLAN_CONFIRM);AppUtils.sendLogToServer("Cancellation Change Plan Completed Successfully: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+", Customer GUID : "+$scope.customerGuid+", New Subscription Offer ID :"+$scope.cancelChangePlanPreviewDetails.offerId+", Save ReasonCode:"+saveReason)}).error(function(result){$scope.isSaveServiceLoading=false;$scope.hideViewLoading();$scope.setWizardStep($scope.WIZARD_STEP_CHANGE_PLAN_CONFIRM);errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.errorMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);AppUtils.sendLogToServer("Cancellation Change Plan Failed: Subscription ID - "+$scope.cancelSubscriptionDto.subscriptionAccountId+", Customer GUID : "+$scope.customerGuid+", New Subscription Offer ID :"+$scope.cancelChangePlanPreviewDetails.offerId+", Save ReasonCode:"+saveReason)})};$scope.setWizardStep=function(stepNumber){$scope.wizardStep=stepNumber};$scope.backToCriteria=function(wizardNumber){$scope.setWizardStep(wizardNumber)};$scope.showViewLoading=function(){$("#cancel-subscription-loading-modal").modal("show")};$scope.hideViewLoading=function(){$("#cancel-subscription-loading-modal").modal("hide")};$scope.gotoSubscriptionView=function(isReloadRequired){$scope.errorMessages=null;if(isReloadRequired){window.open(AppUtils.getApplicationUrl()+"/subscription/"+$scope.cancelSubscriptionDto.id+"/"+$scope.customerGuid)}else{if($scope.wizardStep==$scope.WIZARD_STEP_DEBIT_MEMO_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_CREDIT_MEMO_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_WITHOUT_FEE_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_CREDIT_DAYS_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_CHANGE_PLAN_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_SAVE_OTHERS_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_SAVE_MOVE_TO_CCT_CONFIRM||$scope.wizardStep==$scope.WIZARD_STEP_NO_CHANGE_PLAN_CONFIRM){$location.path("/subscription/"+$scope.cancelSubscriptionDto.id+"/"+$scope.customerGuid);location.reload()}else{$scope.$emit($scope.BACK_TO_SUBSCRIPTION_DETAILS,"Exit Cancel Subscription");$location.skipReload().path("/subscription/"+$scope.cancelSubscriptionDto.id+"/"+$scope.customerGuid).replace()}}};$scope.launchStore=function(){window.open(AppUtils.getApplicationUrl()+"/store/"+angular.lowercase($scope.storeMetadata.countryCode)+"?customer="+$scope.customerDetails.customerNo)};$scope.openCaseHistory=function(){window.open(AppUtils.getApplicationUrl()+"/customer/"+$scope.customerDetails.customerNo+"/cases")};$scope.openCsCase=function(caseNumber){window.open(AppUtils.getApplicationUrl()+"/case/"+caseNumber)};$scope.createCsCaseFromTemplate=function(){var customerNo=$scope.customerDetails.customerNo;var productSku=$scope.cancelSubscriptionDto.sku;var storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var orderNumber=$scope.cancelSubscriptionDto.orderNumber;var caseNote=$scope.cancelReason.selectedId==$scope.CANCEL_REASON_OTHER_CODE?$scope.cancellationReasonOther.selectedText:"";var tenureStartDate=angular.isDefined($scope.subscriptionDetails.contract.termStartDate)==true?$scope.subscriptionDetails.contract.termStartDate.split("T")[0]:"";var csCaseCreationUrl="/case/newCs?customerNo="+customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&subId="+$scope.cancelSubscriptionDto.id+"&cancelSubscription=true&cancelReason="+$scope.cancelReason.selectedId+"&cancelNote="+caseNote+"&contextType=INDIVIDUAL&customerGuid="+$scope.customerGuid+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureStartDate);window.open(AppUtils.getApplicationUrl()+csCaseCreationUrl)};$scope.createCreditMemoCsCase=function(){var customerNo=$scope.customerDetails.customerNo;var productSku=$scope.cancelSubscriptionDto.sku;var storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var orderNumber=$scope.cancelSubscriptionDto.orderNumber;var tenureStartDate=angular.isDefined($scope.subscriptionDetails.contract.termStartDate)==true?$scope.subscriptionDetails.contract.termStartDate.split("T")[0]:"";var returnCaseTemplateUrl="/case/newCs?customerNo="+customerNo+"&tempId="+AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER+"&productSku="+productSku+"&storeId="+$scope.storeId+"&orderNumber="+$scope.createdCreditMemoTransaction.transactionNumber+"&contextType=INDIVIDUAL&customerGuid="+$scope.customerGuid+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureStartDate);window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.continueCancelWithoutEccPreview=function(){$scope.isCancelSubscriptionInitializeComplete=$scope.isCancelWithoutFee=true;$scope.cancelPreviewError=""};$scope.tncStatus=function(isTnCLoaded){$scope.isTncButtonDisabled=!isTnCLoaded};SubscriptionService.getSubscriptionMetadata().success(function(result){$scope.metadata.subscriptionMetadata=result;$scope.initializeCancelSubscriptionScreen()}).error(function(result){$scope.initializeCancelSubscriptionScreen();console.log("Unable to load the subscription metadata.")})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("CancelSubscriptionDto",{id:"",productName:"",sourceType:"",orderNumber:"",customerNo:"",sku:"",termType:"",billingFrequency:"",billingPriceWithTax:"",billingPriceWithoutTax:"",currencyCode:"",purchaseDate:"",nextBillingDate:"",subExpirationDate:"",status:"",paymentStatus:"",subscriptionAccountId:"",isCancelAvailable:"",isResumeAvailable:"",isChangePlanAvailable:"",promoData:{}});var app=app||angular.module("hxApp.directive",[]);app.directive("capitalize",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){var capitalize=function(inputValue){var capitalized=inputValue.toUpperCase();if(capitalized!==inputValue){modelCtrl.$setViewValue(capitalized);modelCtrl.$render()}return capitalized};modelCtrl.$parsers.push(capitalize);capitalize(scope[attrs.ngModel])}}});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("CartValidator",["$rootScope","$routeParams","StoreConstants","StoreUtil",function($rootScope,$routeParams,StoreConstants,StoreUtil){this.isCartItemValid=function(metadata,cart,cartItem){var cartMessage={text:"Cart Is Empty",info:true,success:false,error:false};var skuProductFound=false;var isHavingZCOR=false,isHavingZCSB=false,isHavingCcmTeam=false,isHavingDSP=false,isHavingHGD=false,isHavingESD=false,isHavingPuf=false,isHavingSSP=false;var existingProductCodes=[];if(cart.length>0){for(var itemCount=0;itemCount<cart.length;itemCount++){if(cart[itemCount].sku==cartItem.sku){if(cart[itemCount].prodType==StoreConstants.ESD_PRODUCT_TYPE&&cart[itemCount].educational==true){cartMessage=this.getCartMessage("Maximum Quantity Allowed For This Product Is 1","error")}else{if(cart[itemCount].prodType!=StoreConstants.DSP_PRODUCT_TYPE&&cart[itemCount].prodType!=StoreConstants.SSP_PRODUCT_TYPE){cart[itemCount].quantity=cart[itemCount].quantity+1;cartMessage=this.getCartMessage('"'+cartItem.name+'" Quantity Increased By 1',"success")}else{if(cart[itemCount].prodType==StoreConstants.DSP_PRODUCT_TYPE||cart[itemCount].prodType==StoreConstants.SSP_PRODUCT_TYPE){cartMessage=this.getCartMessage("Maximum Quantity Allowed For This Product Is 1","error")}}}skuProductFound=true;break}else{var cartItemTransactionType=StoreUtil.getTransactionType(metadata.orderTypes,cart[itemCount].prodType,StoreConstants.TRANSACTION_ORDER);var currentItemTransactionType=StoreUtil.getTransactionType(metadata.orderTypes,cartItem.prodType,StoreConstants.TRANSACTION_ORDER);if(cartItemTransactionType==StoreConstants.TRANSACTION_SUBSCRIPTION_ORDER){isHavingZCSB=true}else{if(cartItemTransactionType==StoreConstants.TRANSACTION_NON_SUBSCRIPTION__ORDER){isHavingZCOR=true}}if(cart[itemCount].prodType==StoreConstants.HARD_GOOD_PRODUCT_TYPE){isHavingHGD=true}else{if(cart[itemCount].prodType==StoreConstants.ESD_PRODUCT_TYPE){isHavingESD=true}else{if(cart[itemCount].prodType==StoreConstants.DSP_PRODUCT_TYPE){isHavingDSP=true}else{if(cart[itemCount].prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE){isHavingCcmTeam=true}else{if(cart[itemCount].prodType==StoreConstants.SSP_PRODUCT_TYPE){isHavingSSP=true}}}}}if((angular.isDefined($routeParams.asynchId)&&$routeParams.asynchId.length>0)&&!isHavingCcmTeam){cartMessage=this.getCartMessage("Only team product can be added for sfdc to hendrix flow","error");return cartMessage}if(isHavingHGD&&cartItem.prodType!=StoreConstants.HARD_GOOD_PRODUCT_TYPE){cartMessage=this.getCartMessage("You have Hard Good product in the cart, You cannot add other products","error");return cartMessage}if(isHavingESD&&cartItem.prodType!=StoreConstants.ESD_PRODUCT_TYPE){cartMessage=this.getCartMessage("You have ESD product in the cart, You cannot add other products","error");return cartMessage}if(cartItem.prodType==StoreConstants.DSP_PRODUCT_TYPE&&isHavingCcmTeam){cartMessage=this.getCartMessage("You have CCT product in the cart, You cannot add DSP products","error");return cartMessage}if(cartItem.prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE&&isHavingDSP){cartMessage=this.getCartMessage("You have DSP product in the cart, You cannot add CCT products","error");return cartMessage}if(cartItem.prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE&&isHavingSSP){cartMessage=this.getCartMessage("You have SSP product in the cart, You cannot add CCT products","error");return cartMessage}if(cartItem.prodType==StoreConstants.SSP_PRODUCT_TYPE&&isHavingCcmTeam){cartMessage=this.getCartMessage("You have CCT product in the cart, You cannot add SSP products","error");return cartMessage}if(isHavingZCSB&&currentItemTransactionType==StoreConstants.TRANSACTION_NON_SUBSCRIPTION__ORDER){cartMessage=this.getCartMessage("You have ZCSB product in the cart, You cannot add ZCOR product","error");return cartMessage}else{if(isHavingZCOR&&currentItemTransactionType==StoreConstants.TRANSACTION_SUBSCRIPTION_ORDER){cartMessage=this.getCartMessage("You have ZCOR product in the cart, You cannot add ZCSB product","error");return cartMessage}}if(!cartItem.puf){if(cart[itemCount].puf){cartMessage=this.getCartMessage("Monthly billed product can't be added to PUF subscription","error");return cartMessage}}if(cartItem.puf){if(!cart[itemCount].puf){cartMessage=this.getCartMessage("PUF product can't be added to monthly billed product","error");return cartMessage}}if(cart[itemCount].prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE&&cartItem.prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE){existingProductCodes.push(cart[itemCount].description.substr(0,4));if(existingProductCodes.indexOf(cartItem.description.substr(0,4))>-1){cartMessage=this.getCartMessage("You can not add this product as a similar product is already in cart","error");return cartMessage}}}}}if((angular.isDefined($routeParams.asynchId)&&$routeParams.asynchId.length>0)&&cartItem.prodType!=StoreConstants.CCM_TEAM_PRODUCT_TYPE){cartMessage=this.getCartMessage(" Only team product can be added for sfdc to hendrix flow","error");return cartMessage}if(!skuProductFound){if(!cartItem.quantity){cartItem.quantity=1}cart.push(cartItem);cartMessage=this.getCartMessage('"'+cartItem.name+'" Added Successfully',"success")}return cartMessage};this.getCartMessage=function(messageText,type){var message={text:messageText,info:false,success:false,error:false};if(type=="info"){message.info=true}else{if(type=="success"){message.success=true}}if(type=="error"){message.error=true}return message}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CaseAttachmentService",["$http","$q","$rootScope","$timeout",function($http,$q,$rootScope,$timeout){var service={};service.upload=function(caseGuid,uploadId){return $http({method:"POST",url:"../caseAttachmentService/upload.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{caseGuid:caseGuid,uploadId:uploadId}})};service.uploadAll=function(caseEdit){var deferred=$q.defer();var done=0;$timeout(function(){if(!caseEdit||!caseEdit.filesUploaded||caseEdit.filesUploaded.length==0){deferred.resolve()}else{var checkIfDone=function(){done++;if(done>=caseEdit.filesUploaded.length){deferred.resolve()}};angular.forEach(caseEdit.filesUploaded,function(file){service.upload(caseEdit.guid,file.id).success(function(result){file.guid=result.caseGuid;checkIfDone()}).error(function(errorData){console.log("Error in upload: ",errorData);file.failed=true;alert("Failed to upload "+file.filename);checkIfDone()})})}},10);return deferred.promise};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CaseController",["$scope","$log","$rootScope","$location","$routeParams","$filter","$timeout","CustomerRecordService","TsCaseService","ImsCustomerService","AppConstants","MetadataService","TsCaseUtils","Utils","TrackingService","SubscriptionService","StoreConstants","AppUtils","StoreUtil","$http","CustomerConstants","CustomerPreviewService","CommerceServices",function($scope,$log,$rootScope,$location,$routeParams,$filter,$timeout,CustomerRecordService,TsCaseService,ImsCustomerService,AppConstants,MetadataService,TsCaseUtils,Utils,TrackingService,SubscriptionService,StoreConstants,AppUtils,StoreUtil,$http,CustomerConstants,CustomerPreviewService,CommerceServices){$scope.headeredit=false;$scope.unidentifyshow=false;const CS_CASE="csCase",TS_CASE="tsCase";$scope.appConstant=AppConstants;$scope.isLoading=true;$scope.loadingCustomer=true;$scope.dbStatus=MetadataService.DB_STATUS.NEW;$scope.metadata=new Object();$scope.productSku=$routeParams.productSku;$scope.storeId=$routeParams.storeId;$scope.orderNumber=$routeParams.orderNumber;$scope.gcGUD=$routeParams.gid;$scope.gcGIDSN=$routeParams.gidSN;$scope.priorityData=[{id:9,value:"P5 - Low"},{id:5,value:"P4 - Medium"},{id:3,value:"P3 - High"},{id:1,value:"P2 - Very High"},{id:7,value:"P1 - Urgent"}];$scope.tempId=$routeParams.tempId;$scope.defaultCaseTemplateSearchDto;$scope.caseNo=$routeParams.caseNo;$scope.contextType=$routeParams.contextType;$scope.marketSegment=$routeParams.marketSegment;$scope.businessSegment=$routeParams.businessSegment;$scope.orgguid=$routeParams.orgguid;if($routeParams.tenureDate==="null"||$routeParams.tenureDate==="undefined"){$scope.tenureDate=null}else{$scope.tenureDate=$routeParams.tenureDate}$scope.isNewCsCase=$scope.caseNo.toLowerCase()=="newcs"?true:false;$scope.isNewTsCase=$scope.caseNo.toLowerCase()=="newts"?true:false;$scope.nCaseNo=Number($routeParams.caseNo);$scope.customerNo;$scope.requestContactId;$scope.contactIdForPopup=$routeParams.contactId;$scope.caseView;$scope.customer;$scope.caseEdit;$scope.editCaseView=($location.search().view)?($location.search().view.toString().toLowerCase()=="edit"):false;Utils.pageTitle("Case [ "+$scope.caseNo+" ]");$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:"",customerType:"1"};$scope.contact={contactFunction:"",contactRole:"",contactType:"",country:"",dayPhone:"",department:"",email:"",fax:"",faxExt:"",firstName:"",language:"",lastName:"",mobile:"",mobileExt:"",orgName1:"",orgName2:"",partner1:"",partner2:"",partnerNo:"",relationFlag:"",relationshipType:"",relationshipTypeName:"",searchableContent:"",telephone:"",telephoneExt:"",title:""};var defaultCustomer=function(){return jQuery.extend({},{firstName:"",lastName:"",outputLanguage:""})};$scope.bugtrackerLink="";if($scope.isNewCsCase||$scope.isNewTsCase){TrackingService.trackPageView("Cases","New Case")}else{TrackingService.trackPageView("Cases","Case View")}$scope.subProductMetadataDtos=[];$scope.subServices=[];$scope.technologyCodes=[];$scope.tempCategories=[];$scope.newCsCaseCategories=[];$scope.selectedCategory={code:""};$scope.isCaseViewValid=true;$scope.CONTEXT_TYPE_ENTERPRISE="ENTERPRISE";$scope.CONTEXT_TYPE_TEAM="TEAM";$scope.CONTEXT_TYPE_INDIVIDUAL="INDIVIDUAL";$scope.CONTEXT_TYPE_TRIAL="TRIAL";var timer;var timerForCaseTemplate;$scope.lengthOfLicense;$scope.licenseSubType;$scope.marketSegment;$scope.isLengthOfLicenseSet=false;var lengthOfLicenseWatcher;$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.showErrorMessage=function(message){$scope.showMessage("error",message);$scope.isLoading=false;$scope.isCaseViewValid=false;if($rootScope.returnUrl){$rootScope.returnUrl=null}};$scope.checkErrorMessage=function(result){if(result){angular.forEach(result.messages,function(message){if(message.type=="E"&&message.number=="35"){$scope.showErrorMessage(message.text)}})}};$scope.startCaseProcessing=function(){if($scope.caseNo&&$scope.caseNo!=""){if($scope.caseNo.indexOf("01")==0||$scope.caseNo.indexOf("1")==0){$scope.caseType=TS_CASE}else{if($scope.caseNo.indexOf("02")==0||$scope.caseNo.indexOf("2")==0){$scope.caseType=CS_CASE}else{$scope.showErrorMessage("The Case Number Is Not Valid");return}}MetadataService.initializeCaseMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;$scope.metadata.productNames=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_NAMES],MetadataService.INDEX_NAMES.NAME);$scope.metadata.productPlatforms=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_PLATFORMS],MetadataService.INDEX_NAMES.NAME);$scope.metadata.productLanguages=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_LANGUAGES],MetadataService.INDEX_NAMES.NAME)})}if($scope.caseType==CS_CASE){TsCaseService.getCSItem({caseNumber:$scope.caseNo}).success(function(result){$scope.isLoading=false;$scope.checkErrorMessage(result);if($scope.isCaseViewValid){timer=setInterval(function(){$scope.processCaseDetails(result)},500)}}).error(function(){$scope.showErrorMessage("Failed to load case details")})}else{if($scope.caseType==TS_CASE){TsCaseService.getTSItem({caseNumber:$scope.caseNo}).success(function(result){$scope.isLoading=false;$scope.checkErrorMessage(result);if($scope.isCaseViewValid){timer=setInterval(function(){$scope.processCaseDetails(result)},500)}}).error(function(){$scope.showErrorMessage("Failed to load case details");return})}}};$scope.startNewCaseProcessing=function(){if($scope.isNewCsCase){$scope.caseType=CS_CASE}else{if($scope.isNewTsCase){$scope.caseType=TS_CASE}}MetadataService.initializeCaseMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;$scope.metadata.productNames=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_NAMES],MetadataService.INDEX_NAMES.NAME);$scope.metadata.productPlatforms=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_PLATFORMS],MetadataService.INDEX_NAMES.NAME);$scope.metadata.productLanguages=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.PRODUCT_LANGUAGES],MetadataService.INDEX_NAMES.NAME)});if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0){if($scope.tempId==AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE||$scope.tempId==AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE){if($scope.contextType==$scope.CONTEXT_TYPE_TEAM){$scope.loadSubscriptionCaseFromTemplate()}else{SubscriptionService.getSubscriptionDetails({subscriptionId:$routeParams.subId,subscriptionAccountId:$routeParams.customerGuid,locale:""}).success(function(result){$scope.productSku=result.sellableItemSku;$scope.loadSubscriptionCaseFromTemplate()}).error(function(error){})}}else{$scope.loadCaseFromTemplate()}}else{TsCaseService.getDefaultTsCase({customerNo:$location.search().customerNo,contactId:$location.search().contactId?$location.search().contactId:$location.search().customerNo,uniqueId:$location.search().uniqueId,componentId:$location.search().componentId,regType:$location.search().regType,regInd:$location.search().regInd}).success(function(result){$scope.isLoading=false;$scope.checkErrorMessage(result);result.product.product.name=$routeParams.prodName;result.product.product.serialNumber=$routeParams.serialNumber;result.product.product.platform=$routeParams.prodPlatform;result.product.product.language=$routeParams.prodLang;result.product.product.version=$routeParams.prodVersion;result.product.product.metaName=decodeURIComponent($routeParams.prodMetaName);result.product.product.metaLanguage=$routeParams.prodMetaLanguage;result.product.product.metaConfig=$routeParams.prodMetaConfig;result.product.product.metaPlatform=$routeParams.prodMetaPlatform;result.product.product.componentId=$routeParams.componentId;result.product.product.regType=$routeParams.regType;result.product.product.regInd=$routeParams.productType;result.product.product.educational=($routeParams.productSegment=="true")?true:false;if($scope.isCaseViewValid){timer=setInterval(function(){$scope.processCaseDetails(result)},500)}}).error(function(){$scope.showErrorMessage("Failed to load new case details")})}};$scope.loadCaseFromTemplate=function(){$scope.defaultCaseTemplateSearchDto.templateId=$scope.tempId;$scope.defaultCaseTemplateSearchDto.productSku=$scope.productSku;$scope.defaultCaseTemplateSearchDto.orderNumber=$scope.orderNumber;$scope.defaultCaseTemplateSearchDto.storeId=$scope.storeId;$scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();$scope.defaultCaseTemplateSearchDto.customerDto.customerNo=$scope.customer.customerNo;$scope.defaultCaseTemplateSearchDto.customerDto.firstName=$scope.customer.firstName;$scope.defaultCaseTemplateSearchDto.customerDto.lastName=$scope.customer.lastName;$scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=$scope.customer.outputLanguage;$scope.defaultCaseTemplateSearchDto.customerDto.address=$scope.customer.address;$scope.defaultCaseTemplateSearchDto.contactId=$location.search().contactId?$location.search().contactId:isNaN($location.search().customerNo)?$scope.customer.customerNo:$location.search().customerNo;$scope.defaultCaseTemplateSearchDto.uniqueId=$location.search().uniqueId;$scope.defaultCaseTemplateSearchDto.componentId=$location.search().componentId;$scope.defaultCaseTemplateSearchDto.regType=$location.search().regType;$scope.defaultCaseTemplateSearchDto.regInd=$location.search().regInd;TsCaseService.getCSCaseFromTemplate($scope.defaultCaseTemplateSearchDto).success(function(result){console.log("Case  template loaded successfully");$scope.isLoading=false;$scope.checkErrorMessage(result);if(!($scope.tempId==AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER||$scope.tempId==AppConstants.TEMPLATE_RETURN_ORDER||$scope.tempId==AppConstants.TEMPLATE_GO_CART_CS_CASE||$scope.tempId==AppConstants.TEMPLATE_DEFAULT_CS_ENTERPRISE)){result.product.product.name=$routeParams.prodName;result.product.product.serialNumber=$routeParams.serialNumber;result.product.product.platform=$routeParams.prodPlatform;result.product.product.language=$routeParams.prodLang;result.product.product.version=$routeParams.prodVersion;result.product.product.metaName=decodeURIComponent($routeParams.prodMetaName);result.product.product.metaLanguage=$routeParams.prodMetaLanguage;result.product.product.metaConfig=$routeParams.prodMetaConfig;result.product.product.metaPlatform=$routeParams.prodMetaPlatform;result.product.product.componentId=$routeParams.componentId;result.product.product.regType=$routeParams.regType;result.product.product.regInd=$routeParams.productType;result.product.product.educational=($routeParams.productSegment=="true")?true:false}if($scope.contextType==$scope.CONTEXT_TYPE_TEAM||$scope.contextType==$scope.CONTEXT_TYPE_INDIVIDUAL){$scope.getSKUDetailFromEcomerce(result.product)}if(angular.isDefined($routeParams.gid)&&$routeParams.gid.length>0){result.gcGID={noteType:"GO_CART_GID",text:$routeParams.gid};result.gcSerialNumber={noteType:"GO_CART_SERIAL_NUMBER",text:$routeParams.gidSN};result.gcPhoneNumber={noteType:"GO_CART_PHONE_NUMBER",text:""}}if($scope.isCaseViewValid){timerForCaseTemplate=setInterval(function(){$scope.processCaseDetails(result)},500)}}).error(function(){$scope.showErrorMessage("Failed to load new case details")})};$scope.loadSubscriptionCaseFromTemplate=function(){$scope.defaultCaseTemplateSearchDto.templateId=$scope.tempId;$scope.defaultCaseTemplateSearchDto.productSku=$scope.productSku;$scope.defaultCaseTemplateSearchDto.storeId=$scope.storeId;$scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();$scope.defaultCaseTemplateSearchDto.customerDto.customerNo=$scope.customer.customerNo;$scope.defaultCaseTemplateSearchDto.customerDto.firstName=$scope.customer.firstName;$scope.defaultCaseTemplateSearchDto.customerDto.lastName=$scope.customer.lastName;$scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=$scope.customer.outputLanguage;$scope.defaultCaseTemplateSearchDto.customerDto.address=$scope.customer.address;$scope.defaultCaseTemplateSearchDto.contactId=$location.search().contactId?$location.search().contactId:isNaN($location.search().customerNo)?$scope.customer.customerNo:$location.search().customerNo;TsCaseService.getCSCaseFromTemplate($scope.defaultCaseTemplateSearchDto).success(function(result){if($scope.contextType==$scope.CONTEXT_TYPE_TEAM||$scope.contextType==$scope.CONTEXT_TYPE_INDIVIDUAL){$scope.getSKUDetailFromEcomerce(result.product)}console.log("Case  template loaded successfully");$scope.isLoading=false;$scope.checkErrorMessage(result);if($scope.isCaseViewValid){timerForCaseTemplate=setInterval(function(){$scope.processCaseDetails(result)},500)}}).error(function(){$scope.showErrorMessage("Failed to load new case details")})};$scope.loadCustomer=function(){if($rootScope.lastCustomer&&$rootScope.lastCustomer.customerNo==$scope.customerNo){$scope.customer=$rootScope.lastCustomer;$scope.caseContact=CustomerRecordService.findContact($rootScope.lastCustomer,$scope.caseView.contactId);if($routeParams.relCustomerNo){$scope.currentContact=CustomerRecordService.findContact($rootScope.lastCustomer,$routeParams.relCustomerNo)}else{$scope.currentContact=$scope.caseContact}Utils.pageTitle("Case [ "+$scope.caseView.caseNumber+" ]");$scope.loadingCustomer=false;if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0){$scope.startNewCaseProcessing()}}else{var customerRequestObject=new Object();customerRequestObject.customerNo=$scope.customerNo;if(angular.isDefined($scope.requestContactId)&&$scope.requestContactId!=""){customerRequestObject.relCustomerNo=$scope.requestContactId}else{if($routeParams.contactId&&$routeParams.contactId.length>0){customerRequestObject.relCustomerNo=$routeParams.contactId}}customerRequestObject.relViewMode=CustomerConstants.LOAD_ORG_DETAIL_WITHOUT_REL;CustomerRecordService.getItem(customerRequestObject).success(function(result){$scope.customer=result;if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0){$scope.startNewCaseProcessing()}$scope.caseContact=CustomerRecordService.findContact(result,$scope.customer,$scope.requestContactId);if($scope.customer.bpType=="2"){if($scope.requestContactId==undefined||$scope.requestContactId.length==0){$scope.currentContact=CustomerRecordService.findContact($scope.customer,$routeParams.contactId)}else{$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.requestContactId);$scope.caseContact=$scope.currentContact}}else{$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.requestContactId)}if($scope.caseView&&$scope.caseView.caseNumber){Utils.pageTitle("Case [ "+$scope.caseView.caseNumber+" ]")}$scope.loadingCustomer=false;$rootScope.$broadcast("updatedCustomerEmailId");$scope.contactIdForPopup=customerRequestObject.relCustomerNo;$scope.loadContactDetailBeforeIms(customerRequestObject.relCustomerNo)}).error(function(){$scope.loadingCustomer=false})}};var initImsService=function(){var customerEmailIdAuthSrc="";if($scope.customer.customerIdentifications){for(var i in $scope.customer.customerIdentifications){if($scope.customer.customerIdentifications[i].idNumber&&$scope.customer.customerIdentifications[i].idNumber!=""&&($scope.customer.customerIdentifications[i].idType=="ZENTID"||$scope.customer.customerIdentifications[i].idType=="ZADBID")){customerEmailIdAuthSrc=$scope.customer.customerIdentifications[i].idNumber}}}if(customerEmailIdAuthSrc==""&&$scope.customer.adobeId&&$scope.customer.adobeId!=""){customerEmailIdAuthSrc=$scope.customer.adobeId}else{if($scope.customer.contacts&&$scope.contactId){for(var i in $scope.customer.contacts){if($scope.customer.contacts[i].partnerNo!=""&&$scope.customer.contacts[i].partnerNo==$scope.contactId){customerEmailIdAuthSrc=$scope.customer.contacts[i].email}}}}if(!customerEmailIdAuthSrc&&$scope.customer.contacts.length>0){customerEmailIdAuthSrc=$scope.customer.contacts[0].email}var emailId=customerEmailIdAuthSrc;var imsGetItemObj;if($scope.customer.enterpriseId){imsGetItemObj={email:emailId,authSrc:emailId.split("@")[1]}}else{imsGetItemObj={email:emailId}}ImsCustomerService.getItem(imsGetItemObj).success(function(result){console.log("success ImsCustomerService.getItem");$scope.imsCustomer=result;$scope.imsCustomer.emailVerified=result.emailVerified=="true";$rootScope.imsCustomer=result;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){$scope.imsCustomer.serviceCode=item.serviceCode;$scope.imsCustomer.serviceStatus=item.serviceStatus;$scope.imsCustomer.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){$scope.imsCustomer.serviceStorage=item.params[imsCount].pv+" GB"}}}return}})}}).error(function(result){console.log("error",result);$scope.isLoading=false})};if($scope.isNewCsCase||$scope.isNewTsCase){if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0){TsCaseService.getDefaultCaseTemplate().success(function(result){$scope.defaultCaseTemplateSearchDto=result}).error(function(error){console.log("error",error)});$scope.customerNo=$routeParams.customerNo;$scope.loadCustomer()}else{$scope.startNewCaseProcessing()}}else{if(isNaN($scope.nCaseNo)||$scope.nCaseNo==0){$scope.showErrorMessage("The Case Number Is Not Valid")}else{$scope.startCaseProcessing()}}$scope.processCaseDetails=function(caseResult){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){console.log("Metadata Initialized Successfully");clearInterval(timer);clearInterval(timerForCaseTemplate);if($rootScope.returnUrl){$rootScope.returnUrl=null}caseResult.customerId=Utils.getCorrectIdforCRM(caseResult.customerId);caseResult.contactId=Utils.getCorrectIdforCRM(caseResult.contactId);$scope.customerNo=caseResult.customerId;if(caseResult.customerId!=caseResult.contactId){$scope.requestContactId=caseResult.contactId}if($scope.caseType==CS_CASE){caseResult.status.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_CASE_STATUSES],caseResult.status.id,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if(caseResult.results){caseResult.results.value=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.META_CS_CASE_RESULTS],caseResult.status.id,caseResult.results.id,MetadataService.INDEX_NAMES.STATUS_CODE,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}caseResult.direction.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_DIRECTION_DTOS],caseResult.direction.id,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);caseResult.priority.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_PRIORITY_DTOS],caseResult.priority.id,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);caseResult.reasonText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_CASE_TYPES],caseResult.reason,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);caseResult.productCategoryText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_PRODUCT_CATEGORIES],caseResult.productCategory,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);loadProductMetadata(caseResult);$scope.caseView=caseResult;if($scope.tenureDate){$scope.caseView.tenureDate=$scope.tenureDate}else{$scope.caseEdit=$scope.caseEdit||{};$scope.caseEdit.tenureDate=$scope.caseView.tenureDate}}else{if($scope.caseType==TS_CASE){$scope.updateTsCaseMetadata(caseResult);loadProductMetadata(caseResult);$scope.caseView=caseResult;$scope.createBugTrackerLink();$scope.isLoading=false;if($scope.tenureDate){$scope.caseView.tenureDate=$scope.tenureDate}else{$scope.caseEdit=$scope.caseEdit||{};$scope.caseEdit.tenureDate=$scope.caseView.tenureDate}}}if(!($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0)){$scope.loadCustomer()}if($scope.isNewCsCase||$scope.isNewTsCase||$scope.editCaseView){if(!($scope.caseView.guid==null||$scope.caseView.guid.length==0||$scope.isNewCsCase||$scope.isNewTsCase)){$scope.handleLock()}else{$scope.handleEdit()}}}};$scope.createBugTrackerLink=function(){if($scope.caseView.tracker=="02"){$scope.bugtrackerLink="https://watsonexp.corp.adobe.com/#bug="+$scope.caseView.bugTrackingNo}else{if($scope.caseView.tracker=="05"){$scope.bugtrackerLink="https://issues.adobe.com/browse/"+$scope.caseView.bugTrackingNo}}};var loadProductMetadata=function(customerCase){TsCaseUtils.getTSCaseProductMetadataDetails(customerCase.product).then(function(result){customerCase.product=result.product;$scope.subProductMetadataDtos=result.subProductMetadataDtos;$scope.subService=result.subService;$scope.technologyCodes=result.technologyCodes},function(){$scope.showMessage("error","Failed to load product metadata");$log.warn("error","Failed to load product metadata")})};var getOverviewNote=function(currentCase){console.log(currentCase.caseNumber);if(!currentCase.caseNumber){return"Issue:\n\nEnvironment:\n\nWorkflow steps:\n\nExpectation:\n\nResult:\n\nWorkaround:"}return currentCase.overviewNote?currentCase.overviewNote.text:""};$scope.caseHeaderMessage="";$scope.caseLockMessage="";$scope.handleLock=function(){TsCaseService.lock({caseGuid:$scope.caseView.guid}).success(function(result){console.log(result);if(result&&result.length>0&&result[0].type=="E"&&result[0].number=="13"){$("#showLockedCaseMessage").modal("show");$("#showLockedCaseMessage").css("z-index","1000000");$scope.caseLockmessages=result;var caseErrorText=result[0].text;var caseNoRegEx=/\d+/g;var agentNo=caseErrorText.substr(48,caseErrorText.length);agentNo=agentNo.trim();$scope.caseHeaderMessage="Case locked by another agent ("+agentNo+")";$scope.caseLockMessage="Case "+$scope.caseView.caseNumber+" is currently being processed by agent "+agentNo}else{$scope.editHandler()}}).error(function(error){console.log("Failed to put lock"+error)})};$scope.handleEdit=function(){if(!($scope.caseView.guid==null||$scope.caseView.guid.length==0||$scope.isNewCsCase||$scope.isNewTsCase)){$scope.handleLock()}else{$scope.editHandler()}};$scope.editHandler=function(){$scope.removeWatchersForLicense();$scope.firstTimeSetCode=false;$scope.caseEdit=angular.copy($scope.caseView);$scope.caseEdit.filesUploaded=[];$scope.caseEdit.csCaseStatus={code:""};$scope.caseEdit.csCaseResult={code:""};$scope.caseEdit.caseNote={text:"",noteType:"CASE_NOTE"};$scope.caseEdit.toCustomerNote={text:"",noteType:"TO_CUSTOMER"};$scope.caseEdit.fromCustomerNote={text:"",noteType:"FROM_CUSTOMER"};$scope.caseEdit.overviewNote={text:getOverviewNote($scope.caseEdit),noteType:"OVERVIEW"};$scope.caseEdit.emailFrom={text:"",noteType:"EMAIL_FROM"};$scope.caseEdit.emailTo={text:"",noteType:"EMAIL_TO"};$scope.caseEdit.emailBcc={text:"",noteType:"EMAIL_BCC"};$scope.caseEdit.emailCc={text:"",noteType:"EMAIL_CC"};if($scope.tenureDate){$scope.caseView.tenureDate=$scope.tenureDate}else{$scope.caseEdit=$scope.caseEdit||{};$scope.caseEdit.tenureDate=$scope.caseView.tenureDate}if(!($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0)){$scope.caseEdit.employeeResponsible.agent.username=$scope.currentUser.username}if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0&&$scope.isNewCsCase&&$scope.caseView.toCustomerNote&&$scope.caseView.toCustomerNote.text){$scope.caseEdit.toCustomerNote.text=$scope.caseView.toCustomerNote.text}$scope.editMode=true;$scope.statuses=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_STATUS_DTOS],MetadataService.INDEX_NAMES.VALUE);$scope.directions=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_DIRECTION_DTOS],MetadataService.INDEX_NAMES.VALUE);$scope.activities=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_ACTIVITY_TYPE_DTOS],MetadataService.INDEX_NAMES.VALUE);$scope.priorities=angular.copy($scope.priorityData);$scope.primaryCaseSubjects=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_SUBJECT_DTOS],MetadataService.INDEX_NAMES.VALUE);loadProductMetadata($scope.caseEdit);if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&($scope.caseEdit.product.product.regInd=="I"||$scope.caseEdit.product.product.regInd=="C"||$scope.caseEdit.product.product.regInd=="N"||$scope.caseEdit.product.product.regInd=="S")){$scope.caseEdit.licenseType="SUBSC"}else{if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&($scope.caseEdit.product.product.regInd=="E"||$scope.caseEdit.product.product.regInd=="")){$scope.caseEdit.licenseType="PERPE"}}if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&($scope.caseEdit.product.product.name=="CCSV"||$scope.caseEdit.product.product.name=="APAP")){$scope.caseEdit.licenseType="SUBSC";$scope.caseEdit.licenseSubType="VOLUM";$scope.caseEdit.licenseLength="YEAR";if(!($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0)){$scope.caseEdit.direction.id="K"}}else{if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&$scope.caseEdit.product.product.educational&&$scope.caseEdit.product.product.regInd=="C"){$scope.caseEdit.licenseSubType="EVOLU"}else{if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&$scope.caseEdit.product.product.educational){$scope.caseEdit.licenseSubType="ESING"}else{if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&!$scope.caseEdit.product.product.educational&&$scope.caseEdit.product.product.regInd=="C"){$scope.caseEdit.licenseSubType="VOLUM"}else{if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.product&&!$scope.caseEdit.product.product.educational){$scope.caseEdit.licenseSubType="SINGL"}}}}}if($scope.caseType==CS_CASE){$scope.csCaseStatuses=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.META_CASE_STATUSES],MetadataService.INDEX_NAMES.LABEL);$scope.tempCategories=$scope.getNewCsCaseCategory();$scope.newCsCaseCategories=$filter("orderBy")($scope.tempCategories,"name");$scope.caseTypes=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.META_CASE_TYPES],MetadataService.INDEX_NAMES.NAME);if($scope.tempId==AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE&&$routeParams.cancelSubscription=="true"){$scope.caseEdit.caseDescription="Subscription Cancellation Request";$scope.selectedCategory.code="Y06";$scope.caseEdit.reason=$routeParams.cancelReason;$scope.caseEdit.caseNote.text=$routeParams.cancelNote}else{if($scope.tempId==AppConstants.TEMPLATE_GO_CART_CS_CASE){$scope.caseEdit.licenseSubType="INCOM";$scope.selectedCategory.code=$scope.caseEdit.productCategory}else{$scope.selectedCategory.code=$scope.caseEdit.productCategory}}if($scope.selectedCategory&&$scope.selectedCategory.code){$scope.caseTypes=[];angular.forEach($scope.newCsCaseCategories,function(item){if(item.code==$scope.selectedCategory.code){$scope.caseTypes=item.caseTypes;return}});$scope.caseTypes=$filter("orderBy")($scope.caseTypes,"name")}$scope.caseEdit.csCaseStatus.code=$scope.caseEdit.status.id;if($scope.caseEdit.results!=null){$scope.caseEdit.csCaseResult.code=$scope.caseEdit.results.id}}$rootScope.$broadcast("updatedSelectedTags");$rootScope.$broadcast("updatedCustomerEmailId");$scope.addWatchersForLicense();if($scope.contextType==$scope.CONTEXT_TYPE_TEAM||$scope.contextType==$scope.CONTEXT_TYPE_INDIVIDUAL||$scope.contextType==$scope.CONTEXT_TYPE_ENTERPRISE||$scope.contextType==$scope.CONTEXT_TYPE_TRIAL){$scope.caseEdit.licenseType="SUBSC";if($scope.contextType==$scope.CONTEXT_TYPE_ENTERPRISE){$scope.caseEdit.licenseSubType=$scope.marketSegment=="COM"?"ENCOM":"ENEDU";$timeout(function(){if($scope.businessSegment&&$scope.businessSegment==="VIP"){$scope.caseEdit.licenseLength="ENVIP"}else{$scope.caseEdit.licenseLength="ETLA"}},2000)}else{if($scope.contextType==$scope.CONTEXT_TYPE_TRIAL){$scope.caseEdit.licenseType="TRIAL"}}}if(($scope.caseNo=="newTs"||$scope.caseNo=="newCs")&&$scope.caseEdit.licenseType=="SUBSC"&&$scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0&&$scope.tempId!=AppConstants.TEMPLATE_GO_CART_CS_CASE){$scope.caseEdit.licenseSubType=$scope.licenseSubType;lengthOfLicenseWatcher=$scope.$watch("isLengthOfLicenseSet",function(newValue,oldValue){if(newValue==true){$scope.resetSubTypeAndLengthOfLicense();lengthOfLicenseWatcher()}})}if($scope.caseEdit&&$scope.caseEdit.caseNumber&&$scope.caseEdit.licenseType=="SUBSC"&&($scope.caseEdit.licenseSubType=="ESING"||$scope.caseEdit.licenseSubType=="EVOLU"||$scope.caseEdit.licenseSubType=="SINGL"||$scope.caseEdit.licenseSubType=="VOLUM")){$rootScope.$broadcast("LOAD_EXISTING_PRODUCT_DETAIL",$scope.caseType)}};$scope.getNewCsCaseCategory=function(){var tempCategories=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.META_PRODUCT_CATEGORIES],function(item){if(item.name.indexOf("*")!=0){tempCategories.push(item)}});return tempCategories};$scope.$watch("caseEdit.status.id",function(newValue,oldValue){if(newValue==oldValue){return}$scope.results=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_RESULTS_DTOS],function(item){if(item.tsCaseStatusId==$scope.caseEdit.status.id){$scope.results.push(item)}});$scope.results=$filter("orderBy")($scope.results,"value")});$scope.firstTimeSetCode=false;$scope.$watch("caseEdit.csCaseStatus.code",function(newValue,oldValue){if(newValue==oldValue){return}$scope.csCaseResults=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.META_CS_CASE_RESULTS],function(item){if(item.statusCode==$scope.caseEdit.csCaseStatus.code){$scope.csCaseResults.push(item)}});$scope.csCaseResults=$filter("orderBy")($scope.csCaseResults,"label");if($scope.firstTimeSetCode){$scope.caseEdit.csCaseResult.code=""}$scope.firstTimeSetCode=true});$scope.primaryCaseSubjectSelected=null;$scope.$watch("caseEdit.primaryCaseSubject.id",function(newValue,oldValue){if(newValue==oldValue){return}if(newValue){$scope.secondaryCaseSubjects=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_SUBJECT_DTOS],function(item){if(item.id==newValue){$scope.primaryCaseSubjectSelected=item;$scope.secondaryCaseSubjects=item.children;$scope.tertiaryCaseSubjects=[];return}});$scope.secondaryCaseSubjects=$filter("orderBy")($scope.secondaryCaseSubjects,MetadataService.INDEX_NAMES.VALUE)}else{$scope.secondaryCaseSubjects=[];$scope.tertiaryCaseSubjects=[]}});$scope.$watch("caseEdit.reason",function(newValue,oldValue){if(newValue==oldValue){return}});$scope.$watch("selectedCategory.code",function(newValue,oldValue){if($scope.caseEdit){$scope.caseEdit.productCategory=newValue}if(newValue==oldValue){return}if(newValue){$scope.caseTypes=[];angular.forEach($scope.newCsCaseCategories,function(item){if(item.code==newValue){$scope.caseTypes=item.caseTypes;return}});$scope.caseTypes=$filter("orderBy")($scope.caseTypes,"name")}else{$scope.caseTypes=[]}});$scope.$watch("caseEdit.secondaryCaseSubject.id",function(newValue,oldValue){if(newValue==oldValue){return}$scope.tertiaryCaseSubjects=[];if($scope.primaryCaseSubjectSelected){angular.forEach($scope.primaryCaseSubjectSelected.children,function(item){if(item.id==newValue){$scope.tertiaryCaseSubjects=item.children;return}});$scope.tertiaryCaseSubjects=$filter("orderBy")($scope.tertiaryCaseSubjects,"value")}});$scope.updateTsCaseMetadata=function(tsCase){tsCase.trackerText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.BUG_SYSTEMS],tsCase.tracker,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);tsCase.contractTypeText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CONTRACT_TYPES],tsCase.contractType,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);tsCase.entitlementMethodText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ENTITLEMENT_METHODS],tsCase.entitlementMethod,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE)};$scope.updateCsCaseMetadata=function(caseResult){caseResult.status.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_CASE_STATUSES],caseResult.status.id,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if(caseResult.results){caseResult.results.value=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.META_CS_CASE_RESULTS],caseResult.status.id,caseResult.results.id,MetadataService.INDEX_NAMES.STATUS_CODE,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}caseResult.direction.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_DIRECTION_DTOS],caseResult.direction.id,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);caseResult.priority.value=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.TS_CASE_PRIORITY_DTOS],caseResult.priority.id,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.VALUE);caseResult.reasonText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_CASE_TYPES],caseResult.reason,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);caseResult.productCategoryText=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.META_PRODUCT_CATEGORIES],caseResult.productCategory,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)};$scope.updateView=function(newView){$scope.updateTsCaseMetadata(newView);if(newView.transType=="ZCSC"){$scope.updateCsCaseMetadata(newView)}$scope.caseView=newView};$scope.redirectToCustomer=function(){$scope.showMessage("error","The case number does not exist with this customer");$scope.isLoading=false;$scope.loadingCustomer=false;$timeout(function(){$location.url(Utils.customerUrl($scope.customerNo))},3000)};$scope.refreshAttachments=function(){$scope.isAttachmentsRefresh=true;TsCaseService.getAttachmentList({caseId:$scope.caseNo}).success(function(result){$scope.caseView.attachments=result;$scope.isAttachmentsRefresh=false}).error(function(result){$scope.isAttachmentsRefresh=false;console.log("Error : TsCaseService -> getAttachmentInfo() : ",result)})};$scope.addWatchersForLicense=function(){$timeout(function(){$scope.$watch1=$scope.$watch("caseEdit.licenseType",function(value,oldValue){if(value==oldValue||!value){return}if($scope.caseEdit){$scope.caseEdit.licenseSubType=null;$scope.caseEdit.licenseLength=null}});$scope.$watch2=$scope.$watch("caseEdit.licenseSubType",function(value,oldValue){if(value==oldValue||!value){return}if($scope.caseEdit){$scope.caseEdit.licenseLength=null}})})};$scope.removeWatchersForLicense=function(){if($scope.$watch1){$scope.$watch1()}if($scope.$watch2){$scope.$watch2()}};$scope.validateSubProdInColl=function(val){var subproducts=$scope.subProductMetadataDtos;var isSubProductCodeFound=false;for(var i=0;i<subproducts.length;i++){if(subproducts[i].code==val){isSubProductCodeFound=true;break}}if(isSubProductCodeFound){return true}else{return false}};$scope.$watch("caseEdit.product.subProduct.code",function(newValue,oldValue){if(!$scope.caseEdit){return}TsCaseUtils.getTSCaseProductMetadataDetails($scope.caseEdit.product).then(function(result){$scope.subProductMetadataDtos=result.subProductMetadataDtos;$scope.subService=result.subService;$scope.technologyCodes=result.technologyCodes;if(!newValue||newValue==""||!$scope.validateSubProdInColl(newValue)){$scope.caseEdit.product.subProduct=null}else{if($scope.caseEdit.product&&$scope.caseEdit.product.subProduct){$scope.caseEdit.product.subProduct.code=newValue}}},function(){$scope.showMessage("error","Failed to load product metadata");$log.warn("error","Failed to load product metadata")})});$scope.$watch("caseEdit.licenseType",function(newValue,oldValue){if(!$scope.caseEdit){return}if(!newValue||newValue==""){$scope.caseEdit.licenseType=null}else{if($scope.caseEdit.licenseType){$scope.caseEdit.licenseType=newValue}}});$scope.$watch("caseEdit.licenseSubType",function(newValue,oldValue){if(!$scope.caseEdit){return}if(!newValue||newValue==""){$scope.caseEdit.licenseSubType=null}else{if($scope.caseEdit.licenseSubType){$scope.caseEdit.licenseSubType=newValue}}});$scope.$watch("caseEdit.licenseLength",function(newValue,oldValue){if(!$scope.caseEdit){return}if(!newValue||newValue==""){$scope.caseEdit.licenseLength=null}else{if($scope.caseEdit.licenseLength){$scope.caseEdit.licenseLength=newValue}}});$scope.$watch("caseEdit.product.technologyCode.id",function(newValue,oldValue){var techCode;if($scope.caseEdit&&$scope.caseEdit.product&&$scope.caseEdit.product.technologyCode&&$scope.caseEdit.product.technologyCode.id){techCode=$scope.caseEdit.product.technologyCode.id.indexOf("?")}if(!$scope.caseEdit){return}if((!newValue||newValue=="")||techCode>=0){$scope.caseEdit.product.technologyCode.id=null}else{if($scope.caseEdit.product&&$scope.caseEdit.product.technologyCode&&$scope.caseEdit.product.technologyCode.id){$scope.caseEdit.product.technologyCode.id=newValue}}});$scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)};$scope.getSKUDetailFromEcomerce=function(product){$scope.marketSegment=product.product.educational?"EDU":"COM";$scope.setLicenseSubType();if($scope.contextType=="ENTERPRISE"){$scope.setLicenseLength()}else{CommerceServices.searchBySku({sku:$scope.defaultCaseTemplateSearchDto.productSku,country:$scope.defaultCaseTemplateSearchDto.customerDto.address.country.code,market_segment:$scope.marketSegment}).success(function(data,status,headers,config){$scope.setLicenseLength(data)}).error(function(data,status,headers,config){})}};$scope.setLicenseLength=function(data){if($scope.contextType==$scope.CONTEXT_TYPE_ENTERPRISE){if($scope.businessSegment&&$scope.businessSegment==="VIP"){$scope.lengthOfLicense="ENVIP"}else{$scope.lengthOfLicense="ETLA"}}else{if(data&&data.sellableItem&&data.sellableItem.olsServiceCommitment){if(data.sellableItem.olsServiceCommitment.name=="MONTH"){$scope.lengthOfLicense="MONTH"}else{if(data.sellableItem.olsServiceCommitment.name=="YEAR"){if(data.sellableItem.termType&&data.sellableItem.termType.termType=="MONTH"){$scope.lengthOfLicense="YRPMN"}else{$scope.lengthOfLicense="YRPMN"}}else{if(data.sellableItem.olsServiceCommitment.name=="YEAR_PREPAID"){if(data.sellableItem&&data.sellableItem.termType&&data.sellableItem.termType.termType=="MONTH"){$scope.lengthOfLicense="YRPMN"}else{$scope.lengthOfLicense="YRPUF"}}}}}}$scope.isLengthOfLicenseSet=true};$scope.setLicenseSubType=function(){if($scope.contextType==$scope.CONTEXT_TYPE_INDIVIDUAL){if($scope.marketSegment=="EDU"){$scope.licenseSubType="INEDU"}else{$scope.licenseSubType="INCOM"}}else{if($scope.contextType==$scope.CONTEXT_TYPE_TEAM){if($scope.marketSegment=="EDU"){$scope.licenseSubType="TEEDU"}else{$scope.licenseSubType="TECOM"}}else{if($scope.contextType==$scope.CONTEXT_TYPE_ENTERPRISE){if($scope.marketSegment=="EDU"){$scope.licenseSubType="ENEDU"}else{$scope.licenseSubType="ENCOM"}}}}};$scope.resetSubTypeAndLengthOfLicense=function(){$timeout(function(){$scope.caseEdit.licenseLength=$scope.lengthOfLicense},2000)};$scope.loadContactDetail=function(contactId){$scope.searchFields.customerId=contactId;CustomerPreviewService.search($scope.searchFields).success(function(result){var customerPreviewDetail=result.customerSearchResults[0];$scope.contact.email=customerPreviewDetail.email;$scope.contact.firstName=customerPreviewDetail.firstName;$scope.contact.language=customerPreviewDetail.language;$scope.contact.lastName=customerPreviewDetail.lastName;$scope.contact.partner2=customerPreviewDetail.customerNo;$scope.contact.partnerNo=customerPreviewDetail.customerNo;$scope.contact.lastName=customerPreviewDetail.lastName;if(customerPreviewDetail.address&&customerPreviewDetail.address.country){$scope.contact.country=customerPreviewDetail.address.country.code}$scope.customer.contacts=[];$scope.customer.contacts.push($scope.contact);$scope.currentContact=$scope.contact;$scope.caseContact=$scope.contact;$rootScope.$broadcast("updatedCustomerEmailId");initImsService()}).error(function(error){initImsService()})};$scope.loadContactDetailBeforeIms=function(contactId){if(contactId){$scope.loadContactDetail(contactId)}else{initImsService()}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CaseCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","$timeout","CustomerRecordService","TsCaseService","ImsCustomerService","MetadataService","TsCaseUtils","Utils","TrackingService","AppConstants",function($scope,$log,$rootScope,$location,$routeParams,$filter,$timeout,CustomerRecordService,TsCaseService,ImsCustomerService,MetadataService,TsCaseUtils,Utils,TrackingService,AppConstants){TrackingService.trackPageView("Cases","Case View");$scope.appConstant=AppConstants;$scope.isLoading=true;$scope.loadingCustomer=true;$scope.customerNo=$routeParams.customerNo;$scope.nCustomerNo=parseInt($routeParams.customerNo).toString();$scope.requestContactId=$routeParams.relCustomerNo;if($routeParams.tenureDate==="null"||$routeParams.tenureDate==="undefined"){$scope.tenureDate=null}else{$scope.tenureDate=$routeParams.tenureDate}$scope.caseType=$location.path().indexOf("csCase")>-1?"csCase":"tsCase";$scope.caseNo=$routeParams.caseNo=="new"?"":$routeParams.caseNo;$scope.editMode=false;$scope.subProductMetadataDtos=[];$scope.subServices=[];$scope.technologyCodes=[];$scope.tempCategories=[];$scope.newCsCaseCategories=[];$scope.selectedCategory={code:""};$scope.isCaseViewValid=true;$scope.orgguid=$routeParams.orgguid;var serviceCall;var loadProductMetadata=function(customerCase){TsCaseUtils.getTSCaseProductMetadataDetails(customerCase.product).then(function(result){customerCase.product=result.product;$scope.subProductMetadataDtos=result.subProductMetadataDtos;$scope.subService=result.subService;$scope.technologyCodes=result.technologyCodes},function(){$scope.showMessage("error","Failed to load product metadata");$log.warn("error","Failed to load product metadata")})};MetadataService.getAllMetadata().success(function(result){$scope.metadata=result;loadCase()}).error(function(){$scope.showMessage("error","Failed to load metadata")});var loadCase=function(){var successCallback,errorCallback;if($scope.caseType=="csCase"){successCallback=function(result){if($scope.nCustomerNo==parseInt(result.customerId).toString()){var caseMetadata=$scope.metadata.caseMetadataDto;result.status.value=MetadataService.find(caseMetadata.caseStatuses,result.status.id,"code","label");if(result.results){result.results.value=MetadataService.findResult(caseMetadata.csCaseResults,result.status.id,result.results.id,"statusCode","code","label")}result.direction.value=MetadataService.find($scope.metadata.tsCaseMetadataDto.tsCaseDirectionDtos,result.direction.id,"id","value");result.priority.value=MetadataService.find($scope.metadata.tsCaseMetadataDto.tsCasePriorityDtos,result.priority.id,"id","value");result.reasonText=MetadataService.find(caseMetadata.caseTypes,result.reason,"code","name");result.productCategoryText=MetadataService.find(caseMetadata.productCategories,result.productCategory,"code","name");loadProductMetadata(result);$scope.caseView=result;$scope.isLoading=false;loadCustomer();if($scope.caseNo==""){$scope.handleEdit()}}else{$scope.redirectToCustomer()}};errorCallback=function(error){$scope.isLoading=false};if($scope.caseNo==""){serviceCall=TsCaseService.getDefaultTsCase({customerNo:$scope.customerNo,contactId:$routeParams.relCustomerNo?$routeParams.relCustomerNo:$scope.customerNo,uniqueId:$location.search().uniqueId,componentId:$location.search().componentId,regType:$location.search().regType,regInd:$location.search().regInd})}else{serviceCall=TsCaseService.getCSItem({caseNumber:$scope.caseNo})}}else{successCallback=function(result){if($scope.nCustomerNo==parseInt(result.customerId).toString()){$scope.updateTsCaseMetadata(result);loadProductMetadata(result);$scope.caseView=result;$scope.isLoading=false;loadCustomer();if($scope.caseNo==""){$scope.handleEdit()}}else{$scope.redirectToCustomer()}};errorCallback=function(error){$scope.isLoading=false};if($scope.caseNo==""){serviceCall=TsCaseService.getDefaultTsCase({customerNo:$scope.customerNo,contactId:$routeParams.relCustomerNo?$routeParams.relCustomerNo:$scope.customerNo,uniqueId:$location.search().uniqueId,componentId:$location.search().componentId,regType:$location.search().regType,regInd:$location.search().regInd})}else{serviceCall=TsCaseService.getTSItem({caseNumber:$scope.caseNo})}}serviceCall.success(successCallback).error(errorCallback)};var loadCustomer=function(){if($rootScope.lastCustomer&&$rootScope.lastCustomer.customerNo==$scope.customerNo){$scope.customer=$rootScope.lastCustomer;$scope.caseContact=CustomerRecordService.findContact($rootScope.lastCustomer,$scope.caseView.contactId);$scope.currentContact=CustomerRecordService.findContact($rootScope.lastCustomer,$routeParams.relCustomerNo);Utils.pageTitle($scope.caseView.caseNumber+" - "+Utils.getNameFromCustomerDto($scope.customer));$scope.loadingCustomer=false}else{var customerRequestObject=new Object();customerRequestObject.customerNo=$scope.customerNo;if(angular.isDefined($scope.requestContactId)&&$scope.requestContactId!=""){customerRequestObject.relCustomerNo=$scope.requestContactId}CustomerRecordService.getItem(customerRequestObject).success(function(result){$scope.customer=result;$scope.caseContact=CustomerRecordService.findContact(result,$scope.caseView.contactId);$scope.currentContact=CustomerRecordService.findContact(result,$routeParams.relCustomerNo);if($scope.caseView.caseNumber){Utils.pageTitle($scope.caseView.caseNumber+" - "+Utils.getNameFromCustomerDto($scope.customer))}$scope.loadingCustomer=false;$rootScope.$broadcast("updatedCustomerEmailId");initImsService()}).error(function(){$scope.loadingCustomer=false})}};var initImsService=function(){var emailId=$scope.customer.bpType=="1"?$scope.customer.email:$scope.customer.contacts[0].email;ImsCustomerService.getItem({email:emailId}).success(function(result){console.log("success ImsCustomerService.getItem");$scope.isLoading=false;$scope.imsCustomer=result;$scope.imsCustomer.emailVerified=result.emailVerified=="true";$rootScope.imsCustomer=result;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){$scope.imsCustomer.serviceCode=item.serviceCode;$scope.imsCustomer.serviceStatus=item.serviceStatus;$scope.imsCustomer.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){$scope.imsCustomer.serviceStorage=item.params[imsCount].pv+" GB"}}}return}})}}).error(function(result){console.log("error",result);$scope.isLoading=false})};var getOverviewNote=function(currentCase){console.log(currentCase.caseNumber);if(!currentCase.caseNumber){return"Issue:\n\nEnvironment:\n\nWorkflow steps:\n\nExpectation:\n\nResult:\n\nWorkaround:"}return currentCase.overviewNote?currentCase.overviewNote.text:""};$scope.handleEdit=function(){removeWatchersForLicense();$scope.caseEdit=angular.copy($scope.caseView);$scope.caseEdit.filesUploaded=[];$scope.caseEdit.csCaseStatus={code:""};$scope.caseEdit.csCaseResult={code:""};$scope.caseEdit.tenureDate=$scope.tenureDate;$scope.caseEdit.caseNote={text:"",noteType:"CASE_NOTE"};$scope.caseEdit.toCustomerNote={text:"",noteType:"TO_CUSTOMER"};$scope.caseEdit.fromCustomerNote={text:"",noteType:"FROM_CUSTOMER"};$scope.caseEdit.overviewNote={text:getOverviewNote($scope.caseEdit),noteType:"OVERVIEW"};$scope.caseEdit.emailFrom={text:"",noteType:"EMAIL_FROM"};$scope.caseEdit.emailTo={text:"",noteType:"EMAIL_TO"};$scope.caseEdit.emailBcc={text:"",noteType:"EMAIL_BCC"};$scope.caseEdit.emailCc={text:"",noteType:"EMAIL_CC"};$scope.caseEdit.employeeResponsible.agent.username=$scope.currentUser.username;$scope.editMode=true;$scope.statuses=$filter("orderBy")($scope.metadata.tsCaseMetadataDto.tsCaseStatusDtos,"value");$scope.directions=$filter("orderBy")($scope.metadata.tsCaseMetadataDto.tsCaseDirectionDtos,"value");$scope.activities=$filter("orderBy")($scope.metadata.tsCaseMetadataDto.tsCaseActivityTypeDtos,"value");$scope.primaryCaseSubjects=$filter("orderBy")($scope.metadata.tsCaseMetadataDto.tsCaseSubjectDtos,"value");loadProductMetadata($scope.caseEdit);addWatchersForLicense();if($scope.caseNo==""&&$scope.caseEdit.product&&$scope.caseEdit.product.product.name=="CCSV"){$scope.caseEdit.licenseType="SUBSC";$scope.caseEdit.licenseSubType="VOLUM";$scope.caseEdit.licenseLength="YEAR";$scope.caseEdit.direction.id="K"}if($scope.caseType=="csCase"){$scope.selectedCategory.code=$scope.caseEdit.productCategory;$scope.csCaseStatuses=$filter("orderBy")($scope.metadata.caseMetadataDto.caseStatuses,"label");$scope.tempCategories=$scope.getNewCsCaseCategory();$scope.newCsCaseCategories=$filter("orderBy")($scope.tempCategories,"name");$scope.caseTypes=$filter("orderBy")($scope.metadata.caseMetadataDto.caseTypes,"name");$scope.caseEdit.csCaseStatus.code=$scope.caseEdit.status.id;if($scope.caseEdit.results!=null){$scope.caseEdit.csCaseResult.code=$scope.caseEdit.results.id}}$rootScope.$broadcast("updatedSelectedTags");$rootScope.$broadcast("updatedCustomerEmailId")};$scope.getNewCsCaseCategory=function(){var tempCategories=[];angular.forEach($scope.metadata.caseMetadataDto.productCategories,function(item){if(item.name.indexOf("*")!=0){tempCategories.push(item)}});return tempCategories};$scope.$watch("caseEdit.status.id",function(newValue,oldValue){if(newValue==oldValue){return}$scope.results=[];angular.forEach($scope.metadata.tsCaseMetadataDto.tsCaseResultsDtos,function(item){if(item.tsCaseStatusId==$scope.caseEdit.status.id){$scope.results.push(item)}});$scope.results=$filter("orderBy")($scope.results,"value")});$scope.$watch("caseEdit.csCaseStatus.code",function(newValue,oldValue){if(newValue==oldValue){return}$scope.csCaseResults=[];angular.forEach($scope.metadata.caseMetadataDto.csCaseResults,function(item){if(item.statusCode==$scope.caseEdit.csCaseStatus.code){$scope.csCaseResults.push(item)}});$scope.csCaseResults=$filter("orderBy")($scope.csCaseResults,"label")});$scope.primaryCaseSubjectSelected=null;$scope.$watch("caseEdit.primaryCaseSubject.id",function(newValue,oldValue){if(newValue==oldValue){return}if(newValue){$scope.secondaryCaseSubjects=[];angular.forEach($scope.metadata.tsCaseMetadataDto.tsCaseSubjectDtos,function(item){if(item.id==newValue){$scope.primaryCaseSubjectSelected=item;$scope.secondaryCaseSubjects=item.children;$scope.tertiaryCaseSubjects=[];return}});$scope.secondaryCaseSubjects=$filter("orderBy")($scope.secondaryCaseSubjects,"value")}else{$scope.secondaryCaseSubjects=[];$scope.tertiaryCaseSubjects=[]}});$scope.$watch("caseEdit.reason",function(newValue,oldValue){if(newValue==oldValue){return}});$scope.$watch("selectedCategory.code",function(newValue,oldValue){if($scope.caseEdit){$scope.caseEdit.productCategory=newValue}if(newValue==oldValue){return}if(newValue){$scope.caseTypes=[];angular.forEach($scope.newCsCaseCategories,function(item){if(item.code==newValue){$scope.caseTypes=item.caseTypes;return}});$scope.caseTypes=$filter("orderBy")($scope.caseTypes,"name")}else{$scope.caseTypes=[]}});$scope.$watch("caseEdit.secondaryCaseSubject.id",function(newValue,oldValue){if(newValue==oldValue){return}$scope.tertiaryCaseSubjects=[];if($scope.primaryCaseSubjectSelected){angular.forEach($scope.primaryCaseSubjectSelected.children,function(item){if(item.id==newValue){$scope.tertiaryCaseSubjects=item.children;return}});$scope.tertiaryCaseSubjects=$filter("orderBy")($scope.tertiaryCaseSubjects,"value")}});$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};var removeWatchersForLicense=function(){if($scope.$watch1){$scope.$watch1()}if($scope.$watch2){$scope.$watch2()}};var addWatchersForLicense=function(){$timeout(function(){$scope.$watch1=$scope.$watch("caseEdit.licenseType",function(value,oldValue){if(value==oldValue||!value){return}if($scope.caseEdit){$scope.caseEdit.licenseSubType=null;$scope.caseEdit.licenseLength=null}});$scope.$watch2=$scope.$watch("caseEdit.licenseSubType",function(value,oldValue){if(value==oldValue||!value){return}if($scope.caseEdit){$scope.caseEdit.licenseLength=null}})})};$scope.updateTsCaseMetadata=function(tsCase){var tsMetadata=$scope.metadata.tsCaseMetadataDto;tsCase.trackerText=MetadataService.find($scope.metadata.bugSystems,tsCase.tracker,"id","value");tsCase.contractTypeText=MetadataService.find($scope.metadata.contractTypes,tsCase.contractType,"id","value");tsCase.entitlementMethodText=MetadataService.find($scope.metadata.entitlementMethods,tsCase.entitlementMethod,"id","value")};$scope.updateCsCaseMetadata=function(result){var caseMetadata=$scope.metadata.caseMetadataDto;result.status.value=MetadataService.find(caseMetadata.caseStatuses,result.status.id,"code","label");if(result.results){result.results.value=MetadataService.findResult(caseMetadata.csCaseResults,result.status.id,result.results.id,"statusCode","code","label")}result.direction.value=MetadataService.find($scope.metadata.tsCaseMetadataDto.tsCaseDirectionDtos,result.direction.id,"id","value");result.priority.value=MetadataService.find($scope.metadata.tsCaseMetadataDto.tsCasePriorityDtos,result.priority.id,"id","value");result.reasonText=MetadataService.find(caseMetadata.caseTypes,result.reason,"code","name");result.productCategoryText=MetadataService.find(caseMetadata.productCategories,result.productCategory,"code","name")};$scope.updateView=function(newView){$scope.updateTsCaseMetadata(newView);if(newView.transType=="ZCSC"){$scope.updateCsCaseMetadata(newView)}$scope.caseView=newView};$scope.redirectToCustomer=function(){$scope.showMessage("error","The case number does not exist with this customer");$scope.isLoading=false;$scope.loadingCustomer=false;$timeout(function(){$location.url(Utils.customerUrl($scope.customerNo))},3000)}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CaseEditCtrl",["$scope","$rootScope","$timeout","$http","$location","$routeParams","$filter","$window","AppConstants","CustomerRecordService","CustomerPreviewService","TsCaseService","CaseAttachmentService","Utils","TagCloudService","fileNameFilterFilter","bytesToSizeFilterFilter","fileExtensionFilterFilter","webGuidFilterFilter","ProductRecordService","TsCaseUtils","StoreConstants","CommerceServices",function($scope,$rootScope,$timeout,$http,$location,$routeParams,$filter,$window,AppConstants,CustomerRecordService,CustomerPreviewService,TsCaseService,CaseAttachmentService,Utils,TagCloudService,fileNameFilterFilter,bytesToSizeFilterFilter,fileExtensionFilterFilter,webGuidFilterFilter,ProductRecordService,TsCaseUtils,StoreConstants,CommerceServices){$scope.appConstant=AppConstants;$scope.isSendButtonDisabled=false;$scope.selectedTags=["TS"];$scope.caseTagsCloud=[];$scope.caseTags=[];$scope.selectedCaseTags=[];$scope.toEmailId="";$scope.tagCategories=[];$scope.availableTagCategories=[];$scope.selectedTagCategory=[];$scope.selectedTagsForCategory=[];$scope.availbleTagsForCategory=[];$scope.updateMessages="";$scope.assignedTags=[];$scope.bugLink="";$scope.tempId=$routeParams.tempId;$scope.orgguid=$routeParams.orgguid;$scope.isProductUpdateEnabled=false;$scope.isSubProductEnable=false;$scope.isProductRemoved=false;$scope.showUpdateProductAction=false;$scope.isProductDetailDisable=true;$scope.modifiedProductName={name:""};$scope.modifiedPlateform={platform:""};$scope.modifiedLanguage={language:""};$scope.modifiedVersion={version:""};$scope.isLoadingProductsCrm=false;$scope.snProductList=[];$scope.enterpriseSupportId=AppConstants.ENTERPRISE_SUPPORT_ID;$scope.enterpriseSupportIdText=AppConstants.ENTERPRISE_SUPPORT_ID_TEXT;$scope.CONTEXT_TYPE_ENTERPRISE="ENTERPRISE";$scope.CONTEXT_TYPE_ENTERPRISE="TRIAL";$scope.CONTEXT_TYPE_TEAM="TEAM";$scope.CONTEXT_TYPE_JIL_TEAM="JILTEAM";$scope.CONTEXT_TYPE_INDIVIDUAL="INDIVIDUAL";TagCloudService.getTagCaseClouds().success(function(result){if(!(result instanceof Array)){return}$scope.caseTagsCloud=result.sort(function(a,b){if(a.tagtext<b.tagtext){return -1}if(a.tagtext>b.tagtext){return 1}return 0});angular.forEach($scope.caseTagsCloud,function(item){$scope.caseTags.push({tagtext:item.tagtext,description:item.description})});$scope.caseTags=$scope.caseTags.unique().sort()}).error(function(){});TagCloudService.getTagCategory().success(function(result){if(!(result instanceof Array)){return}$scope.tagCategory=result.sort(function(a,b){if(a.categorytext<b.categorytext){return -1}if(a.categorytext>b.categorytext){return 1}return 0});angular.forEach($scope.tagCategory,function(item){if(item.status=="ACTIVE"){$scope.availableTagCategories.push(item)}})});$scope.updateTagCloudForCategory=function(){var categoryName=this.tagCategory;var index=$scope.selectedTagCategory.indexOf(($.trim(categoryName.categorytext)));if(index!=-1){$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext)}else{$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext);$scope.populateTagsForCategory(categoryName.categorytext)}};$scope.populateTagsForCategory=function(newValue){$scope.availbleTagsForCategory=[];TagCloudService.getTagsForCategory(newValue).success(function(result){angular.forEach(result,function(item){if(item.status=="ACTIVE"){$scope.availbleTagsForCategory.push(item)}})})};$scope.isSelected=function(){return $scope.selectedCaseTags.indexOf(($.trim(this.tag.tagtext)))!=-1};$scope.isSelectedTag=function(){return $scope.selectedCaseTags.length>0};$scope.isCategorySelected=function(){return $scope.selectedTagCategory.indexOf(($.trim(this.tagCategory.categorytext)))!=-1};$scope.isCategoryTagSelected=function(){return $scope.selectedCaseTags.indexOf(($.trim(this.tag.tagtext)))!=-1};$rootScope.$on("updatedSelectedTags",function(event,e){if($scope.caseEdit&&$scope.caseEdit.tags!=null&&$scope.caseEdit.tags.length>0){$scope.selectedCaseTags=$scope.caseEdit.tags.split(",");$scope.assignedTags=$scope.selectedCaseTags}});$rootScope.$on("updatedCustomerEmailId",function(event,e){try{if(($scope.caseEdit.product.product.name==null||$scope.caseEdit.product.product.name=="")){$scope.handleProductRemoved()}if($scope.customer.bpType==1){$scope.caseEdit.emailTo.text=$scope.customer.email}else{if($scope.currentContact){$scope.caseEdit.emailTo.text=$scope.currentContact.email}}$timeout(function(){$scope.modifiedProductName.name=$scope.caseEdit.product.product.name;$scope.modifiedPlateform.platform=$scope.caseEdit.product.product.platform;$scope.modifiedLanguage.language=$scope.caseEdit.product.product.language;$scope.modifiedVersion.version=$scope.caseEdit.product.product.version},1);if(($scope.customer.bpType==2)&&(($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="CCSV")||($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="APAP")||($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="XCMS")||($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="APB")||($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="AEMM")||($scope.caseEdit.product&&$scope.caseEdit.product.product.name.toUpperCase()=="CESK"))){$scope.caseEdit.emailFrom.text=AppConstants.ENTERPRISE_SUPPORT_ID}else{$scope.caseEdit.emailFrom.text="suppnr@adobe.com"}}catch(e){console.log(e)}});$scope.toggleTag=function(){var tagName=this.tag;var index=$scope.selectedCaseTags.indexOf(($.trim(tagName.tagtext)));if(index!=-1){$scope.selectedCaseTags.splice(index,1)}else{$scope.selectedCaseTags.push(($.trim(tagName.tagtext)))}};$scope.removeTag=function(){var tagName=this.tag;var index=$scope.selectedCaseTags.indexOf(($.trim(tagName)));if(index!=-1){$scope.selectedCaseTags.splice(index,1)}};$scope.updateToCustomerNote=function(){var tempText="";var finalText="";var flag=false;if($scope.caseEdit.emailFrom.text.length>0){tempText+="From: "+$scope.caseEdit.emailFrom.text+"\n";flag=true}if($scope.caseEdit.emailTo.text.length>0){tempText+="To: "+$scope.caseEdit.emailTo.text+"\n";flag=true}if($scope.caseEdit.emailCc.text.length>0){tempText+="Cc: "+$scope.caseEdit.emailCc.text+"\n";flag=true}if(flag){finalText=tempText+"\n"+$scope.caseEdit.toCustomerNote.text;$scope.caseEdit.toCustomerNote.text=finalText}};$scope.handleSave=function(){$("#pleaseWaitModal").modal("show");if($scope.caseType=="csCase"){$scope.caseEdit.status.id=$scope.caseEdit.csCaseStatus.code;$scope.caseEdit.results.id=$scope.caseEdit.csCaseResult.code;$scope.caseEdit.transType="ZCSC";$scope.caseEdit.gcGID={noteType:"GO_CART_GID",text:$scope.caseEdit.gcGID?$scope.caseEdit.gcGID.text:""};$scope.caseEdit.gcSerialNumber={noteType:"GO_CART_SERIAL_NUMBER",text:$scope.caseEdit.gcSerialNumber?$scope.caseEdit.gcSerialNumber.text:""};$scope.caseEdit.gcPhoneNumber={noteType:"GO_CART_PHONE_NUMBER",text:$scope.caseEdit.gcPhoneNumber?$scope.caseEdit.gcPhoneNumber.text:""}}var isNewCase=$scope.caseEdit.caseNumber==null;if($scope.caseEdit.toCustomerNote.text.length>0){$scope.updateToCustomerNote()}if(!$scope.overviewNoteChanged&&!isNewCase){$scope.tempOverview=$scope.caseEdit.overviewNote;$scope.caseEdit.overviewNote=null}$scope.caseEdit.tags=$scope.selectedCaseTags.toString();if($scope.caseEdit.kbDocId&&$scope.caseEdit.kbDocId.length>132){$scope.caseEdit.kbDocId=$scope.caseEdit.kbDocId.substr($scope.caseEdit.kbDocId.length-132)}TsCaseService.save($scope.caseEdit).success(function(result){$scope.overviewNoteChanged=false;$scope.unlockCase();$scope.caseEdit.guid=result.guid;CaseAttachmentService.uploadAll($scope.caseEdit).then(function(){if(!result.attachments){result.attachments=[]}angular.forEach($scope.caseEdit.filesUploaded,function(file){result.attachments.push({createdAt:new Date(),description:file.filename,name:file.filename,size:file.size,guid:file.guid})});$scope.$parent.$parent.editMode=false;$scope.$parent.$parent.updateView(result);$("#progress").empty();$("#progress2").empty();$("#pleaseWaitModal").modal("hide");if(isNewCase){$location.url("/case/"+result.caseNumber)}})}).error(function(){$("#pleaseWaitModal").modal("hide");$("#progress").empty();$("#progress2").empty();$scope.showMessage("error","Failed to save case");if(!$scope.overviewNoteChanged){$scope.caseEdit.overviewNote=$scope.tempOverview}})};$scope.handleSendManualUpdate=function(){$scope.isSendButtonDisabled=true;if(!$scope.caseEdit.actions){$scope.caseEdit.actions=[]}$scope.caseEdit.actions.unshift({statusDescription:"Active",logNumber:null,previewUrl:null,status:"3",timestamp:null,actionDescription:"Case Update Email - Manual",actionType:null});$scope.caseEdit.commitAction=true};$scope.handleOverviewNoteChange=function(){$scope.caseEdit.overviewNote.author=$scope.currentUser;$scope.caseEdit.overviewNote.noteType="OVERVIEW";$scope.caseEdit.overviewNote.creationDate=new Date();$scope.overviewNoteChanged=true};$scope.unlockCase=function(){TsCaseService.unlock({caseGuid:$scope.caseView.guid}).success(function(result){console.log(result)}).error(function(error){console.log(error)})};$scope.handleCancel=function(){$scope.isProductUpdateEnabled=false;$scope.isSubProductEnable=false;$scope.isProductRemoved=false;$scope.showUpdateProductAction=false;$scope.isProductDetailDisable=true;$scope.unlockCase();if($scope.caseEdit.caseNumber==null){$location.url(Utils.customerLink2($scope.caseEdit.customerId,$scope.caseEdit.contactId))}else{$scope.$parent.$parent.editMode=false;if($scope.caseType=="csCase"){$("#progress2").empty()}else{$("#progress").empty()}}};$scope.assignCurrentUser=function(){$scope.caseEdit.owner.agent.username=$scope.currentUser.username};$scope.handleApplyChanges=function(){if($scope.changeAgent.type=="owner"){$scope.caseEdit.owner.agent={username:$scope.changeAgent.name}}else{$scope.caseEdit.employeeResponsible.agent={username:$scope.changeAgent.name}}$("#changeOwnerModal,#changeCsOwnerModal").modal("hide")};$scope.$watch("caseEdit.tracker",function(newValue,oldValue){if(newValue==oldValue){return}else{if($scope.caseEdit.tracker=="02"){$scope.bugLink="https://watsonexp.corp.adobe.com/#bug="+$scope.caseEdit.bugTrackingNo}else{if($scope.caseEdit.tracker=="05"){$scope.bugLink="https://it.jira.corp.adobe.com/browse/"+$scope.caseEdit.bugTrackingNo}}}});$scope.handleClosePopup=function(){$("#changeOwnerModal,#changeCsOwnerModal").modal("hide")};$scope.isSubLicensesDisabled=function(){for(var i=0;i<($scope.metadata.licenses.length);i++){if($scope.metadata.licenses[i].id==$scope.caseEdit.licenseType){$scope.selectedSubLicenses=$scope.metadata.licenses[i].subLicenses;if($scope.metadata.licenses[i].subLicenses.length==0){return true}return false}}};$scope.isLicenseLengthDisabled=function(){if($scope.selectedSubLicenses.length==0){return true}for(var i=0;i<($scope.selectedSubLicenses.length);i++){if($scope.selectedSubLicenses[i].id==$scope.caseEdit.licenseSubType){if($scope.selectedSubLicenses[i].licenseLengths.length==0){return true}}}return false};$scope.isValid=function(){var result=false;if(!$scope.caseEdit){return false}try{if($scope.caseType=="csCase"){result=$scope.caseEdit.csCaseStatus.code!=""&&$scope.caseEdit.csCaseResult.code!=""&&$scope.caseEdit.caseDescription!=""&&$scope.caseEdit.caseDescription!=undefined&&$scope.caseEdit.reason!=""&&$scope.caseEdit.productCategory!=""&&$scope.caseEdit.direction.id!=""&&$scope.caseEdit.product!=null&&(($scope.subProductMetadataDtos.length!=0)?$scope.caseEdit.product.subProduct!=null:true)&&$scope.caseEdit.licenseType!=""&&$scope.caseEdit.licenseType!=null&&$scope.caseEdit.product.product.name!=null&&$scope.caseEdit.product.product.name!=""&&(($scope.isSubLicensesDisabled())?true:($scope.caseEdit.licenseSubType!=null))&&(($scope.isLicenseLengthDisabled())?true:($scope.caseEdit.licenseLength!=null))}else{result=$scope.caseEdit.status.id!=""&&$scope.caseEdit.results.id!=""&&$scope.caseEdit.caseDescription!=""&&$scope.caseEdit.caseDescription!=undefined&&$scope.caseEdit.primaryCaseSubject.id!=""&&$scope.caseEdit.direction.id!=""&&$scope.caseEdit.product!=null&&(($scope.subProductMetadataDtos.length!=0)?$scope.caseEdit.product.subProduct!=null:true)&&$scope.caseEdit.licenseType!=null&&$scope.caseEdit.licenseType!=""&&$scope.caseEdit.licenseType!=null&&(($scope.isSubLicensesDisabled())?true:($scope.caseEdit.licenseSubType!=null))&&(($scope.isLicenseLengthDisabled())?true:($scope.caseEdit.licenseLength!=null))}}catch(err){}return result};$scope.addTextToCurrentNote=function(text,isAppend,isCs){var currentSelectedNote;var selectedTabName;if(isCs){currentSelectedNote=$("#notesCaseEdit div.active textarea");selectedTabName=$("#notesCaseEdit").find("li.active a").first().text()}else{currentSelectedNote=$("#notesEdit div.active textarea");selectedTabName=$("#notesEdit").find("li.active a").first().text()}var textTemp="";if(isAppend){var existingNotes=currentSelectedNote.val();if(existingNotes!=""){existingNotes+="\n"}textTemp=existingNotes+text}else{textTemp=text}switch(selectedTabName){case"Overview":$scope.caseEdit.overviewNote.text=textTemp;$scope.overviewNoteChanged=true;break;case"Case note":$scope.caseEdit.caseNote.text=textTemp;break;case"To Customer":$scope.caseEdit.toCustomerNote.text=textTemp;break;case"From Customer":$scope.caseEdit.fromCustomerNote.text=textTemp;break}};$scope.handleProductUpdateSave=function(){$scope.isProductUpdateEnabled=false;$scope.isSubProductEnable=false;$scope.isProductUpdateEnabledForSavedCase=false;$scope.isProductRemoved=false;loadProductMetadata($scope.caseEdit.product);$scope.caseEdit.product.product.platform=$scope.modifiedPlateform.platform;$scope.caseEdit.product.product.name=$scope.modifiedProductName.name;angular.forEach($scope.metadata.productPlatforms,function(value){if($scope.modifiedPlateform.platform==value.code){$scope.caseEdit.product.product.metaPlatform=value.name}});angular.forEach($scope.metadata.productNames,function(value){if($scope.modifiedProductName.name==value.code){$scope.caseEdit.product.product.metaName=value.name}});angular.forEach($scope.metadata.productLanguages,function(value){if($scope.modifiedLanguage.language==value.code){$scope.caseEdit.product.product.metaLanguage=value.name}});$scope.caseEdit.product.product.language=$scope.modifiedLanguage.language;$scope.caseEdit.product.product.version=$scope.modifiedVersion.version;$scope.isSubProductEnable=false;$scope.isProductRemoved=false};$scope.handleProductEdit=function(){$scope.isProductUpdateEnabled=true;$scope.isProductUpdateEnabledForSavedCase=true;$scope.isProductDetailDisable=false};$scope.handleProductEditForNewCS=function(){$scope.isProductUpdateEnabled=true;$scope.isSubProductEnable=true};$scope.handleProductRemoved=function(){$scope.isProductRemoved=true;$scope.isSubProductEnable=true;$scope.showUpdateProductAction=true;$scope.caseEdit.product.product.language=null;$scope.caseEdit.product.product.metaLanguage=null;$scope.caseEdit.product.product.metaName=null;$scope.caseEdit.product.product.metaPlatform=null;$scope.caseEdit.product.product.name=null;$scope.caseEdit.product.product.version=null;$scope.caseEdit.product.product.componentId=null;$scope.caseEdit.product.product.recordNumber=null;$scope.caseEdit.product.product.serialNumber=null;$scope.caseEdit.product.product.platform=null;$scope.caseEdit.product.product.componentId=null;$scope.caseEdit.product.product.config=null;$scope.caseEdit.product.product.description=null;$scope.caseEdit.product.product.isSelected=null;$scope.caseEdit.product.product.language=null;$scope.caseEdit.product.product.mediaType=null;$scope.caseEdit.product.product.metaConfig=null;$scope.caseEdit.product.product.metaLanguage=null;$scope.caseEdit.product.product.metaName=null;$scope.caseEdit.product.product.metaPlatform=null;$scope.caseEdit.product.product.metaType=null;$scope.caseEdit.product.product.name=null;$scope.caseEdit.product.product.ownerId="";$scope.caseEdit.product.product.platform="";$scope.caseEdit.product.product.price=null;$scope.caseEdit.product.product.prodType=null;$scope.caseEdit.product.product.promoSku=null;$scope.caseEdit.product.product.recordNumber=null;$scope.caseEdit.product.product.regInd=null;$scope.caseEdit.product.product.regType=null;$scope.caseEdit.product.product.searchableContent=null;$scope.caseEdit.product.product.serialNumber=null;$scope.caseEdit.product.product.sku=null;$scope.caseEdit.product.product.status=null;$scope.caseEdit.product.product.teamId=null;$scope.caseEdit.product.product.teamName=null;$scope.caseEdit.product.product.teamRole=null;$scope.caseEdit.product.product.uniqueId=null;$scope.caseEdit.product.product.version=null};var loadProductMetadata=function(product){TsCaseUtils.getTSCaseProductMetadataDetails(product).then(function(result){$scope.subProductMetadataDtos=result.subProductMetadataDtos;$scope.subService=result.subService;$scope.technologyCodes=result.technologyCodes},function(){$scope.showMessage("error","Failed to load product metadata");$log.warn("error","Failed to load product metadata")})};$scope.$on(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,function(event,rec){$scope.isLengthOfLicenseSet=false;$scope.tempContextType="";if(rec.viewType=="TEAM"||rec.viewType=="JILTEAM"||rec.viewType=="ENTERPRISE"||rec.viewType=="INDIVIDUAL"||rec.viewType=="TRIAL"){$scope.tempContextType=rec.viewType;if($scope.tempContextType=="ENTERPRISE"){$scope.handleRegisteredProductSelection(rec)}else{if($scope.tempContextType=="TRIAL"){$scope.handleRegisteredProductSelection(rec)}else{if(rec.product&&rec.product.product){$scope.getSKUDetailFromEcomerce(rec.product.product)}$scope.handleRegisteredProductSelection(rec.product.product)}}}else{$scope.handleRegisteredProductSelection(rec)}});$scope.getSKUDetailFromEcomerce=function(product){$scope.marketSegment=product.educational?"EDU":"COM";$scope.setLicenseSubType();if($scope.tempContextType=="ENTERPRISE"){$scope.setLicenseLength()}else{CommerceServices.searchBySku({sku:product.sku,country:$scope.customer.address.country.code,market_segment:$scope.marketSegment}).success(function(data,status,headers,config){$scope.setLicenseLength(data)}).error(function(data,status,headers,config){})}};$scope.setLicenseLength=function(data){if($scope.tempContextType=="ENTERPRISE"){if($scope.businessSegment&&$scope.businessSegment==="VIP"){$scope.lengthOfLicense="ENVIP"}else{$scope.lengthOfLicense="ETLA"}}else{if(data&&data.sellableItem&&data.sellableItem.olsServiceCommitment){if(data.sellableItem.olsServiceCommitment.name=="MONTH"){$scope.lengthOfLicense="MONTH"}else{if(data.sellableItem.olsServiceCommitment.name=="YEAR"){if(data.sellableItem.termType&&data.sellableItem.termType.termType=="MONTH"){$scope.lengthOfLicense="YRPMN"}else{$scope.lengthOfLicense="YRPMN"}}else{if(data.sellableItem.olsServiceCommitment.name=="YEAR_PREPAID"){if(data.sellableItem&&data.sellableItem.termType&&data.sellableItem.termType.termType=="MONTH"){$scope.lengthOfLicense="YRPMN"}else{$scope.lengthOfLicense="YRPUF"}}}}}}$scope.isLengthOfLicenseSet=true};$scope.setLicenseSubType=function(){if($scope.tempContextType=="INDIVIDUAL"){if($scope.marketSegment=="EDU"){$scope.licenseSubType="INEDU"}else{$scope.licenseSubType="INCOM"}}else{if($scope.tempContextType=="TEAM"){if($scope.marketSegment=="EDU"){$scope.licenseSubType="TEEDU"}else{$scope.licenseSubType="TECOM"}}else{if($scope.tempContextType=="JILTEAM"){if($scope.marketSegment=="EDU"){$scope.licenseSubType="TEEDU"}else{$scope.licenseSubType="TECOM"}}else{if($scope.tempContextType=="ENTERPRISE"){if($scope.marketSegment=="EDU"){$scope.licenseSubType="ENEDU"}else{$scope.licenseSubType="ENCOM"}}}}}};$scope.resetSubTypeAndLengthOfLicense=function(){$timeout(function(){$scope.caseEdit.licenseLength=$scope.lengthOfLicense},500)};$scope.handleRegisteredProductSelection=function(rec){$scope.caseEdit.licenseType=null;$scope.caseEdit.licenseSubType=null;$scope.caseEdit.licenseLength=null;$scope.businessSegment=rec.businessSegment;if(rec.registrationDate&&rec.registrationDate.length>0){$scope.caseEdit.tenureDate=rec.registrationDate}else{$scope.caseEdit.tenureDate=""}if($scope.caseEdit.product.subProduct!=null){$scope.caseEdit.product.subProduct.code=null}$scope.caseEdit.product.product=rec;loadProductMetadata($scope.caseEdit.product);$("#existingCsCaseProductList").modal("hide");$("#existingTsCaseProductList").modal("hide");$scope.isProductRemoved=false;$scope.isProductUpdateEnabled=false;$scope.isProductUpdateEnabledForSavedCase=false;$scope.isProductUpdateEnabled=false;$scope.showUpdateProductAction=false;$scope.$parent.removeWatchersForLicense();$scope.modifiedProductName.name=$scope.caseEdit.product.product.name;$scope.modifiedLanguage.language=$scope.caseEdit.product.product.language;$scope.modifiedPlateform.platform=$scope.caseEdit.product.product.platform;$scope.modifiedVersion.version=$scope.caseEdit.product.product.version;if(rec.businessSegment&&rec.businessSegment==="VIP"){$scope.caseEdit.licenseLength="ENVIP"}else{$scope.caseEdit.licenseLength="ETLA"}$timeout(function(){if($scope.caseEdit.product&&($scope.caseEdit.product.product.regInd=="I"||$scope.caseEdit.product.product.regInd=="C"||$scope.caseEdit.product.product.regInd=="N"||$scope.caseEdit.product.product.regInd=="S")){$scope.caseEdit.licenseType="SUBSC"}else{if($scope.caseEdit.product&&($scope.caseEdit.product.product.regInd=="E"||$scope.caseEdit.product.product.regInd=="")){$scope.caseEdit.licenseType="PERPE"}}if($scope.caseEdit.product&&($scope.caseEdit.product.product.name=="CCSV"||$scope.caseEdit.product.product.name=="APAP")){$scope.caseEdit.licenseType="SUBSC";$scope.caseEdit.licenseSubType="VOLUM";$scope.caseEdit.licenseLength="YEAR";if(!($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0)){$scope.caseEdit.direction.id="K"}}else{if($scope.caseEdit.product&&$scope.caseEdit.product.product.educational&&$scope.caseEdit.product.product.regInd=="C"){$scope.caseEdit.licenseSubType="EVOLU"}else{if($scope.caseEdit.product&&$scope.caseEdit.product.product.educational){$scope.caseEdit.licenseSubType="ESING"}else{if($scope.caseEdit.product&&!$scope.caseEdit.product.product.educational&&$scope.caseEdit.product.product.regInd=="C"){$scope.caseEdit.licenseSubType="VOLUM"}else{if($scope.caseEdit.product&&!$scope.caseEdit.product.product.educational){$scope.caseEdit.licenseSubType="SINGL"}}}}}if($scope.tempContextType&&($scope.tempContextType==$scope.CONTEXT_TYPE_JIL_TEAM||$scope.tempContextType==$scope.CONTEXT_TYPE_TEAM||$scope.tempContextType==$scope.CONTEXT_TYPE_INDIVIDUAL||$scope.tempContextType==$scope.CONTEXT_TYPE_ENTERPRISE||$scope.tempContextType==$scope.CONTEXT_TYPE_TRIAL)){if($scope.tempContextType==$scope.CONTEXT_TYPE_TRIAL){$scope.caseEdit.licenseType="TRIAL"}else{$scope.caseEdit.licenseType="SUBSC"}if($scope.tempContextType==$scope.CONTEXT_TYPE_ENTERPRISE){$scope.caseEdit.licenseSubType=$scope.caseEdit.product.product.marketSegment=="COM"?"ENCOM":"ENEDU";$timeout(function(){if(rec.businessSegment&&rec.businessSegment==="VIP"){$scope.caseEdit.licenseLength="ENVIP"}else{$scope.caseEdit.licenseLength="ETLA"}},2000)}}if($scope.caseEdit.licenseType=="SUBSC"&&$scope.tempContextType!=$scope.CONTEXT_TYPE_ENTERPRISE){$scope.caseEdit.licenseSubType=$scope.licenseSubType;lengthOfLicenseWatcher=$scope.$watch("isLengthOfLicenseSet",function(newValue,oldValue){if(newValue==true){$scope.resetSubTypeAndLengthOfLicense();lengthOfLicenseWatcher()}})}},1000)};$scope.handleOpenSNProductList=function(rec){$scope.caseEdit.product.product=rec;$("#existingCsCaseProductList").modal("hide");$("#existingTsCaseProductList").modal("hide");$scope.isProductRemoved=false;$scope.isProductUpdateEnabled=false;$scope.isProductUpdateEnabledForSavedCase=false;$scope.isProductUpdateEnabled=false;$scope.showUpdateProductAction=false;$scope.modifiedProductName.name=$scope.caseEdit.product.product.name;$scope.modifiedLanguage.language=$scope.caseEdit.product.product.language;$scope.modifiedPlateform.platform=$scope.caseEdit.product.product.platform;$scope.modifiedVersion.version=$scope.caseEdit.product.product.version};$scope.addRegisteredCsCaseProduct=function(){$scope.isProductUpdateEnabled=false;$scope.isProductRemoved=false;$scope.productsCrm=null;$scope.isSubProductEnable=false};$scope.addRegisteredProductSNList=function(){$("#existingSNProductListForCsCase").modal("show");console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isLoadingProductsCrm=true;$scope.productsCrm=[];$scope.selectAll=false;if($scope.customer.bpType=="2"){ProductRecordService.fillForCCE({customerNo:$scope.contactId,orgId:$scope.customerNo,startIndex:0,numberOfRows:500}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");$scope.isLoadingProductsCrm=false;$scope.productsCrm=$scope.removeProductsWithoutSerialsNo(result);$scope.markAsSelectedSNProduct()}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$("#products").html(error)})}else{ProductRecordService.fillFromCrm({customerNo:$scope.customerNo,startIndex:0,numberOfRows:500,isIndirect:"false"}).success(function(result){console.log("success ProductRecordService.fill");$scope.isLoadingProductsCrm=false;$scope.productsCrm=$scope.removeProductsWithoutSerialsNo(result);$scope.markAsSelectedSNProduct()}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$("#products").html(error)})}};$scope.markAsSelectedSNProduct=function(){if(!($scope.caseEdit&&$scope.caseEdit.serialNumbers&&$scope.caseEdit.serialNumbers.length>0)){return}var exitingSelectedProduct=$scope.caseEdit.serialNumbers.split("\n");angular.forEach($scope.productsCrm,function(item){angular.forEach(exitingSelectedProduct,function(existingItem){if(existingItem==item.serialNumber){item.isSelected=true}})})};$scope.updateRegisteredSNProduct=function(rec){rec.isSelected=!rec.isSelected};$scope.updateSNProduct=function(){var selectedProducts="";if($scope.selectAll){angular.forEach($scope.productsCrm,function(item){selectedProducts+=item.serialNumber+"\n"})}else{angular.forEach($scope.productsCrm,function(item){if(item.isSelected){selectedProducts+=item.serialNumber+"\n"}})}if(selectedProducts==""){selectedProducts="(empty)"}$scope.caseEdit.serialNumbers=selectedProducts;$("#existingSNProductListForCsCase").modal("hide");return selectedProducts};$scope.removeProductsWithoutSerialsNo=function(products){var productsWithSN=[];if(products){angular.forEach(products,function(item){if(item.serialNumber&&item.serialNumber.length!=""&&item.regInd!="S"){productsWithSN.push(item)}})}return productsWithSN};$scope.addRegisteredTsCaseProduct=function(){$scope.isProductUpdateEnabled=false;$scope.isProductRemoved=false;$scope.productsCrm=null;$scope.isSubProductEnable=false;$scope.productsCrm=[]};$scope.addProductDetailManually=function(){$scope.isProductUpdateEnabled=true;$scope.showUpdateProductAction=false;$scope.isSubProductEnable=true};$scope.handleProductUpdateCancel=function(){$scope.isProductUpdateEnabled=false;$scope.isProductUpdateEnabledForSavedCase=false;$scope.isSubProductEnable=false;if($scope.caseEdit.product.product.name==null){$scope.isProductRemoved=true;$scope.showUpdateProductAction=true}};$scope.handleInsertTemplate=function(val){$scope.addTextToCurrentNote($scope.selectedTemplate,true,val)};$scope.insertTemplate=function(template){var val=$scope.caseType=="csCase";$scope.addTextToCurrentNote(template,true,val)};$scope.handleReplaceTemplate=function(val){$scope.addTextToCurrentNote($scope.selectedTemplate,false,val)};$scope.replaceTemplate=function(template){var val=$scope.caseType=="csCase";$scope.addTextToCurrentNote(template,false,val)};$scope.handleInsertSelfHelpLink=function(link){$scope.caseEdit.kbDocId=link;if($scope.caseType=="csCase"){$scope.addTextToCurrentNote(link,true,true)}else{$scope.addTextToCurrentNote(link,true,false)}};$scope.changeOwner=function(){$scope.caseType=="tsCase"?$("#changeOwnerModal").modal("show"):$("#changeCsOwnerModal").modal("show")};$scope.searchOwner=function(){$scope.serviceLoading=true;$scope.searchOwnerFields.funnel=null;$scope.searchOwnerFields.agent.external=false;TsCaseService.getEmployees($scope.searchOwnerFields).success(function(result){$scope.searchOwnerResults=result.employees;$scope.serviceLoading=false}).error(function(result){$scope.serviceLoading=false})};$scope.assignOwner=function(record){$scope.caseEdit.owner.agent.firstName=record.agent.firstName;$scope.caseEdit.owner.agent.lastName=record.agent.lastName;$scope.caseEdit.owner.agent.username=record.agent.username;$("#changeOwnerModal,#changeCsOwnerModal").modal("hide");$scope.resetSearchOwnerFields()};$scope.resetSearchOwnerFields=function(){$scope.searchOwnerFields.agent={firstName:"",lastName:"",username:""};$scope.searchOwnerResults=null};$scope.changeEmployeeResponsible=function(){$scope.caseType=="tsCase"?$("#changeEmployeeModal").modal("show"):$("#changeCsEmployeeModal").modal("show");$scope.searchEmployeeFunnel()};$scope.searchEmployee=function(){$scope.serviceLoading=true;$scope.searchEmployeeFields.funnel=null;$scope.searchEmployeeFields.agent.external=false;TsCaseService.getEmployees($scope.searchEmployeeFields).success(function(result){$scope.searchEmployeeResults=result.employees;$scope.serviceLoading=false}).error(function(result){$scope.serviceLoading=false})};$scope.assignEmployee=function(record){$scope.caseEdit.employeeResponsible.agent=record.agent;$("#changeEmployeeModal,#changeCsEmployeeModal").modal("hide");$scope.resetSearchEmployeeFields()};$scope.resetSearchEmployeeFields=function(){$scope.searchEmployeeFields.agent={firstName:"",lastName:"",username:""};$scope.searchEmployeeResults=null};$scope.searchEmployeeFunnel=function(){$scope.productFamilies=[];$scope.funnelRegions=[];$scope.funnelLevels=[];TsCaseService.getFunnels().success(function(result){$scope.searchEmployeeFunnelResults=result.employees;$scope.filteredFunnerlResult=angular.copy($scope.searchEmployeeFunnelResults);angular.forEach($scope.searchEmployeeFunnelResults,function(item){item.funnel.family.value=item.funnel.family.value==null?"Others":item.funnel.family.value;item.funnel.region.value=item.funnel.region.value==null?"Others":item.funnel.region.value;item.funnel.level.value=item.funnel.level.value==null?"Others":item.funnel.level.value;$scope.productFamilies.push(item.funnel.family);$scope.funnelRegions.push(item.funnel.region);$scope.funnelLevels.push(item.funnel.level)});$scope.serviceLoading=false}).error(function(result){$scope.serviceLoading=false})};$scope.assignEmployeeFunnel=function(record){$scope.caseEdit.employeeResponsible.agent.username=record.agent.username;$("#changeEmployeeModal,#changeCsEmployeeModal").modal("hide");$scope.resetSearchEmployeeFields()};$scope.changeContact=function(){$scope.caseType=="tsCase"?$("#changeContactModal").modal("show"):$("#changeCsContactModal").modal("show")};$scope.contactSearch=function(){$scope.isContactSearchLoading=true;CustomerPreviewService.search($scope.searchFields).success(function(result){$scope.contactSearchResults=result.customerSearchResults;$scope.isContactSearchLoading=false}).error(function(result){$scope.isContactSearchLoading=false})};$scope.resetSearchFields=function(){$scope.searchFields={email:"",firstName:"",lastName:"",customerId:"",idNumber:""};$scope.contactSearchResults=null};$scope.assignContact=function(record){$scope.caseContact.firstName=record.firstName;$scope.caseContact.lastName=record.lastName;$scope.caseContact.partnerNo=record.customerNo;$scope.caseEdit.contactId=$scope.caseContact.partnerNo;$("#changeContactModal,#changeCsContactModal").modal("hide");$scope.resetSearchFields()};$scope.openTagCloud=function(){$scope.updateMessages="";$scope.selectedCaseTags=angular.copy($scope.assignedTags);$("#tagListContainer").css("display","block");$("#openTagListBtn").css("display","block");$("#tsCaseTagListContainer").css("display","block");$("#openTsCaseTagListBtn").css("display","block");$scope.isSavedHistoryOpen=true};$scope.closeTagOption=function(){$("#tagListContainer").css("display","none");$("#openTagListBtn").css("display","none");$("#tsCaseTagListContainer").css("display","none");$("#openTsCaseTagListBtn").css("display","none");$scope.isSavedHistoryOpen=false;$scope.updateMessages=""};$scope.closeTagCloud=function(){$("#tagListContainer").css("display","none");$("#openTagListBtn").css("display","none");$("#tsCaseTagListContainer").css("display","none");$("#openTsCaseTagListBtn").css("display","none");$scope.isSavedHistoryOpen=false};$scope.applyCustomeTag=function(){if($("#id_tagtext").val()){var ac=$("#id_tagtext").val().split(",");angular.forEach(ac,function(item){$scope.selectedCaseTags.push(item)})}};$scope.applyCustomeTsCaseTag=function(){if($("#id-ts-case-tagtext").val()){var ac=$("#id-ts-case-tagtext").val().split(",");angular.forEach(ac,function(item){$scope.selectedCaseTags.push(item)})}};$scope.updateTagOption=function(){$scope.updateMessages="updated";$scope.assignedTags=$scope.selectedCaseTags};$scope.getCaseName=function(){if($scope.tempId!="undefined"&&$scope.tempId&&$scope.tempId.length>0){if($scope.tempId==AppConstants.TEMPLATE_DEFAULT_EDU){return"CS Case Educational"}else{if($scope.tempId==AppConstants.TEMPLATE_DEFAULT_CS_ENTERPRISE){return"CS Case Enterprise"}else{if($scope.tempId==AppConstants.TEMPLATE_DEFAULT_RETURN||$scope.tempId==AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER||$scope.tempId==AppConstants.TEMPLATE_RETURN_ORDER){return"CS Case Return"}else{return"New"}}}}else{return"New"}};$window.onbeforeunload=function(){if($scope.caseView.guid){TsCaseService.unlock({caseGuid:$scope.caseView.guid}).success(function(result){console.log(result)}).error(function(error){console.log(error)});setTimeOut(function(){},100)}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCasePriority",function(){return{restrict:"E",scope:{ngModel:"=",metadata:"=",byId:"="},replace:false,template:"<div>{{name}}</div>",link:function(scope,element,attrs){var handleChange=function(value,oldValue){if(scope.ngModel&&scope.metadata){angular.forEach(scope.metadata,function(item){if(scope.byId){if(item.id==scope.ngModel){scope.name=item.value;return}}else{if(item.priority==scope.ngModel){scope.name=item.value;return}}})}};scope.$watch(function(){return scope.ngModel},handleChange);scope.$watch(function(){return scope.metadata},handleChange)}}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CaseRecordService",["$http",function($http){var service={};service.fill=function(data){return $http({method:"POST",url:"../caseRecordService/fill.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getCSItem=function(data){return $http({method:"POST",url:"../tsCaseService/getItem.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCasesInteraction",["TransactionService",function(TransactionService){return{restrict:"EA",scope:{caseid:"=",casetype:"="},replace:true,templateUrl:"js/cases/partials/cases-interaction-history.html",link:function(scope,element,attrs){scope.showInteractionHistoryBtn=false;scope.$watch(scope.caseid,function(value){if(value&&value.toString().indexOf("new")==-1){scope.showInteractionHistoryBtn=true}});scope.showInteractionHistoryModal=function(){element.find("#interactionHistoryModal").modal("show");if(scope.casetype&&scope.casetype.indexOf("cs")>-1){scope.caseType="CS"}else{scope.caseType="TS"}scope.rescale();scope.fetchInteractionHistory();$(window).bind("resize",scope.rescale)};scope.closeInteractionHistoryModal=function(){scope.interactionHistory=[];$("body").css("overflow","auto");element.find("#interactionHistoryModal").modal("hide")};scope.fetchInteractionHistory=function(){scope.interactionHistory=[];scope.isInteractionHistoryLoading=true;scope.showInteractionHistoryMessage=false;TransactionService.getTransactionHistory({transactionId:scope.caseid}).success(function(result){console.log("TransactionService.getTransactionHistory  :: -->"+result);scope.interactionHistory=result;if(scope.interactionHistory==0){scope.interactionHistoryMessage="No records found";scope.showInteractionHistoryMessage=true;scope.isInteractionHistoryLoading=false}scope.isInteractionHistoryLoading=false}).error(function(result){scope.interactionHistoryMessage="There was some error while fetching the history. Please refresh..";scope.showInteractionHistoryMessage=true;scope.isInteractionHistoryLoading=false;console.log("TransactionService.getTransactionHistory  :: -->"+result)})};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};$("#interactionHistoryModal .modal-body").css({height:size.height-300,"max-height":"none","overflow-x":"hidden"})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CatalogController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","StoreUtil","StoreConstants","CatalogService","SkuSearchService","$timeout","$http","CommerceServices",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,StoreUtil,StoreConstants,CatalogService,SkuSearchService,$timeout,$http,CommerceServices){$scope.isStoreCatalogLoading=true;$scope.catalogProductFilteredValue="";$scope.catalogSearchObject={storeName:"CRM-US",catalogId:"PRODUCTS",viewName:"CSFAMILY"};$scope.$on(StoreConstants.STORE_INVOKE_CATALOG_EVENT,function(event){if($scope.isDylan){$scope.invokeDylanCatalogService($scope.currentStore.crmStoreName,$scope.catalogSearchObject.catalogId,$scope.catalogSearchObject.viewName)}else{$scope.invokeCatalogService($scope.currentStore)}});var unbindStoreChangeWatcher=$scope.$watch(function(){return $scope.currentStore},function(value){if(!value){return}if($scope.isDylan){$scope.invokeDylanCatalogService($scope.currentStore.crmStoreName,$scope.catalogSearchObject.catalogId,$scope.catalogSearchObject.viewName)}else{$scope.invokeCatalogService($scope.currentStore)}});$scope.invokeDylanCatalogService=function(storeName,catalogId,viewName){unbindStoreChangeWatcher();CatalogService.getAllProducts(storeName,catalogId,viewName).success(function(result){$scope.isStoreCatalogLoading=false;$scope.catalogProducts=StoreUtil.getStoreDylanCatalogProducts(result.categories);$scope.$parent.catalogProductCount=$scope.catalogProducts.length}).error(function(result){})};$scope.invokeCatalogService=function(currentStore){unbindStoreChangeWatcher();if(currentStore.isEduStore){CatalogService.getEducationalCatalogProducts().success(function(result){$scope.isStoreCatalogLoading=false;$scope.catalogProducts=StoreUtil.getStoreCatalogProducts(result,$scope.currentStore);$scope.$parent.catalogProductCount=$scope.catalogProducts.length}).error(function(result){})}else{CatalogService.getCommercialCatalogProducts().success(function(result){$scope.isStoreCatalogLoading=false;$scope.catalogProducts=StoreUtil.getStoreCatalogProducts(result,$scope.currentStore);$scope.$parent.catalogProductCount=$scope.catalogProducts.length}).error(function(result){})}};$scope.getSkus=function(catalogProduct){catalogProduct.isSkuLoading=true;catalogProduct.isConfiguratorView=true;catalogProduct.isSkuDataSuccess=false;catalogProduct.isPriceLoading=true;if(catalogProduct.inStore){CommerceServices.searchByCategoryPath({categoryPath:catalogProduct.categoryPath,countryCode:$scope.currentStore.countryCode,marketSegment:$scope.currentStore.storeType}).success(function(data,status,headers,config){if(data&&data.product&&data.product.skus){if(!Array.isArray(data.product.skus)){var skuArray=new Array();skuArray.push(data.product.skus);data.product.skus=skuArray}catalogProduct.skuList=StoreUtil.filterSkusFromHendrix($scope.currentStore,catalogProduct,data.product.skus);StoreUtil.initializeDataForConfigurator(catalogProduct.skuList);catalogProduct.skuCurrency=data.product.currency;catalogProduct.isSkuDataSuccess=true;catalogProduct.isSkuLoading=false}else{catalogProduct.skuList=null;catalogProduct.isSkuDataSuccess=false;catalogProduct.isSkuLoading=false}}).error(function(data,status,headers,config){catalogProduct.skuList=null;catalogProduct.isSkuDataSuccess=false;catalogProduct.isSkuLoading=false})}else{CatalogService.getSkusFromHendrix().success(function(result){$scope.isStoreCatalogLoading=false;catalogProduct.skuList=StoreUtil.filterSkus(result,catalogProduct.categoryPath,$scope.currentStore);catalogProduct.skuCurrency=result[0].product.currency;catalogProduct.isSkuDataSuccess=true;catalogProduct.isSkuLoading=false}).error(function(result){})}};$scope.$watch("catalogFilter",function(){if($scope.$$childTail){$timeout(function(){$scope.$parent.catalogProductCount=$scope.$$childTail.catalogProductFilteredValue.length},1)}});$scope.$watch("searchInProducts",function(){if($scope.$$childTail){$timeout(function(){$scope.$parent.catalogProductCount=$scope.$$childTail.catalogProductFilteredValue.length},1)}});$scope.reloadConfigurator=function(catalogProduct){$scope.getSkus(catalogProduct)};$scope.closeConfigurator=function(catalogProduct){catalogProduct.isConfiguratorView=false;delete catalogProduct.crmData;delete catalogProduct.skuList};$scope.getSkuData=function(catalogProduct){catalogProduct.isPriceLoading=true;CatalogService.getSkusData($scope.currentStore.crmStoreName,catalogProduct.uniqueIdentifier).success(function(result){catalogProduct.skuList=StoreUtil.getStoreCatalogSkuProducts(result.products);if(catalogProduct.skuList.length==1){$scope.getCrmPrice(catalogProduct)}catalogProduct.isPriceLoading=false}).error(function(result){catalogProduct.skuList=[];catalogProduct.isPriceLoading=false})};$scope.getCrmPrice=function(catalogProduct){var requestProductSearchDto=new Object();requestProductSearchDto.storeId=$scope.currentStore.storeKey;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};if(catalogProduct.skuList.length==1){crmSearchObject.sku=catalogProduct.skuList[0].sku;requestProductSearchDto.criteria=crmSearchObject;catalogProduct.isPriceLoading=true;SkuSearchService.search(requestProductSearchDto).success(function(result){if(result&&result.length==1){catalogProduct.selectedSku=result[0];catalogProduct.selectedSku.productImg=AppUtils.getProductThumbnailImageFromCrmDescription(catalogProduct.selectedSku.description)}catalogProduct.isPriceLoading=false}).error(function(result){catalogProduct.selectedSku=[];catalogProduct.isPriceLoading=false})}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("CatalogProductDto",{name:"",description:"",uniqueIdentifier:"",boxImage:"",configuratorImage:""});var app=app||angular.module("hxApp",["ngRoute"]);app.value("CatalogProductSkuDto",{name:"",sku:"",fulfillmentMethod:"",language:"",platform:"",termType:"",termTypeLabel:"",distributionType:"",distributionTypeLabel:"",version:""});var app=app||angular.module("hxApp",["ngRoute"]);app.value("CatalogRequestDto",{modelCode:"INDIVIDUAL",country:"US",countryName:"United States",marketSegment:"COM",channel:"hdx_offers",locale:"",region:"NA",languageCode:"",billingFrequency:"MONTHLY",serviceCommitment:"MONTH",tags:"",ignoreMarketEndDate:true,priceTableIndex:"1",priceTableSize:"2",isDrStore:false});var app=app||angular.module("hxApp",["ngRoute"]);app.value("CatalogResponseDto",{modelCode:"INDIVIDUAL",country:"",marketSegment:"COM",locale:"EN_US"});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CatalogService",["$http",function($http){var service={};service.getAllProducts=function(storeName,catalogId,viewName){return $http({method:"POST",url:"../shoppingService/getViewCategories.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{storeName:storeName,catalogId:catalogId,viewName:viewName}})};service.getCommercialCatalogProducts=function(){return $http({method:"GET",cache:true,url:"../hx5/json/commercial-products.json"})};service.getEducationalCatalogProducts=function(){return $http({method:"GET",cache:true,url:"../hx5/json/educational-products.json"})};service.getSkus=function(categoryPath,countryCode,storeType){var skuUrl="https://store1.adobe.com/svcs/products"+categoryPath+".json?countryCode="+countryCode+"&marketSegment="+storeType+"&callback=JSON_CALLBACK";return $http.jsonp(skuUrl,{responseType:"json",transformResponse:function(data,headers){return data}})};service.getSkusFromHendrix=function(){return $http({method:"GET",url:"../hx5/json/product-skus.json",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform})};service.getSkusData=function(storeName,uniqueIdentifier){return $http({method:"POST",url:"../shoppingService/getProductData.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{storeName:storeName,categoryPath:uniqueIdentifier}})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("ChangePlanDto",{sku:"",productName:"",displayPrice:"",currencyCode:"",offerId:"",term:"",tncTemplateName:"",marketSegment:"",offerType:""});var app=app||angular.module("hxApp.directive",[]);app.directive("classificationText",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}MetadataService.getClassifications().success(function(response){angular.forEach(response,function(item){if(value==item.code){scope.value=item.description;return}})})})}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CommerceServices",["$http",function($http){var service={};service.createViaCommerce=function(data){return $http({method:"POST",url:"../transactionService/createViaCommerce.do",headers:{"Content-Type":"application/json;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},data:data})};service.updateOrder=function(data){return $http({method:"POST",url:"../transactionService/updateOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.placeOrder=function(data){return $http({method:"POST",url:"../transactionService/placeOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.placeQuote=function(data){return $http({method:"POST",url:"../transactionService/placeOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.getOrderExceptions=function(){return $http({method:"GET",cache:true,url:"../hx5/json/order-exceptions.json"})};service.searchQuotes=function(searchData){var apiHubData={urlKey:"commerce-quote-searchQuotes",queryParameters:{"order-type":"QUOTE","order-number":searchData.quoteNumber,email:searchData.quoteEmail,"company-name":searchData.quoteCompanyName}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.resendQuote=function(data){var apiHubData={urlKey:"commerce-quote-resendQuote",pathVariables:{"order-id":data.quoteId},requestBody:{requestor:data.email,languageCode:data.lang},requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.deleteQuote=function(data){var apiHubData={urlKey:"commerce-quote-deleteQuote",pathVariables:{orderId:data.orderId}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.searchByOfferId=function(searchData){var apiHubData={urlKey:"commerce-quote-searchQuotes",queryParameters:{"order-type":"QUOTE","order-number":searchData.quoteNumber,email:searchData.quoteEmail,"company-name":searchData.quoteCompanyName}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.searchBySku=function(data){var apiHubData={urlKey:"store-sellable-skuSearchService",pathVariables:{sku:data.sku+".json"},queryParameters:{country:data.country,market_segment:data.market_segment},responseBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.searchByCategoryPath=function(data){var apiHubData={urlKey:"store-sellable-categoryPathSearchService",pathVariables:{categoryPath:data.categoryPath},queryParameters:{countryCode:data.countryCode,marketSegment:data.marketSegment},responseBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CommerceTransactionListCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","Utils","ImsCustomerService",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,Utils,ImsCustomerService){TrackingService.trackPageView("CommerceTransactionList","CommerceTransactionList");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Transaction List");$scope.customerAccountID=$routeParams.customerAccountID;$scope.customer={};var customerSearchObj={guid:$scope.customerAccountID.split("@")[0],authSrc:$scope.customerAccountID.split("@")[1]};ImsCustomerService.getCustomerProfileByGuid(customerSearchObj).then(function(response){if(angular.isDefined(response.data.error)){$scope.customer.messages=Utils.showMessage("error","Customer is not valid");$scope.isLoading=false;return}$scope.customer=response.data;setTimeout(function(){$rootScope.$broadcast("LOAD_COMMERCE_TRANSACTION_LIST",$scope.customer)},0);$scope.isLoading=false},function(error){console.log("IMS details load failed");$scope.customer.messages.push(Utils.showMessage("error","Customer is not valid"));$scope.isLoading=false})}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListCommerceTransaction",["Utils","webGuidFilterFilter","CustomerTransactionService",function(Utils,webGuidFilterFilter,CustomerTransactionService){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&"},replace:true,templateUrl:"js/customer/transaction/partials/commerceTransactionListDirective.html",link:function($scope,element,attrs){$scope.$on("LOAD_COMMERCE_TRANSACTION_LIST",function(event,customerObj){$scope.customerObj=customerObj;$scope.customerGuid=customerObj.userId.split("@")[0];$scope.ordersViewType=1;$scope.loadCommerceTransactionList()});var handleValueChange=function(value){if(value){$scope.newCaseCustomerLink=Utils.newCaseCustomerLink($scope.customerNo,$scope.contactNo)}};$scope.encodeUriQuery=function(val){return encodeURIComponent(val)};$scope.$watch(function(){return $scope.contactNo},handleValueChange);$scope.$watch(function(){return $scope.customerNo},handleValueChange);$scope.loadCommerceTransactionList=function(){$scope.transactions=[];$scope.isTransactionLoading=true;console.log("Query CustomerTransactionService.getDylanOrders",$scope.customerGuid);CustomerTransactionService.getAllCommerceOrders({customerGuid:$scope.customerGuid}).success(function(result){console.log("success CustomerTransactionService.getDylanOrders");$scope.dylanOrdersList=[];if(result!=""){var dylanResult=result.order;outer:for(var count=0;count<dylanResult.length;count++){dylanResult[count].creationDate=dylanResult[count]["order-date"];dylanResult[count].type="Order";for(var transactionCount=0;transactionCount<$scope.transactions.length;transactionCount++){try{if(dylanResult[count]["order-number"]==$scope.transactions[transactionCount].externalReferenceNo){dylanResult.splice(count,1);count=-1;continue outer}}catch(error){}}}$scope.dylanOrdersList=dylanResult;$scope.dylanOrders=$scope.dylanOrdersList}else{console.log("No dylan orders",result)}$scope.isTransactionLoading=false}).error(function(error){$scope.dylanOrdersList=[];$rootScope.$broadcast("showTransactionErrorMessage");console.log("error",error);$scope.isTransactionLoading=false})};$scope.intervalSelection=9;$scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}$scope.creationDateFilter=result};$scope.updateInterval($scope.intervalSelection);$scope.handleIntervalChange=function(){$scope.updateInterval($scope.intervalSelection)};$scope.dateFilterFunction=function(data){if(new Date(data.creationDate).getTime()>$scope.creationDateFilter.getTime()){return true}}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CommunicationCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","Utils","ImsCustomerService",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,Utils,ImsCustomerService){TrackingService.trackPageView("Communication","Communication");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Communication");$scope.currentUser=$rootScope.currentUser;$scope.customerAccountID=$routeParams.customerAccountID;$scope.customer={};var customerSearchObj={guid:$scope.customerAccountID.split("@")[0],authSrc:$scope.customerAccountID.split("@")[1]};ImsCustomerService.getCustomerProfileByGuid(customerSearchObj).then(function(response){if(angular.isDefined(response.data.error)){$scope.customer.messages=Utils.showMessage("error","Customer is not valid");$scope.isLoading=false;return}$scope.customer=response.data;setTimeout(function(){$rootScope.$broadcast("LOAD_CUSTOMER_EMAILS")},0);$scope.isLoading=false},function(error){console.log("IMS details load failed");$scope.customer.messages.push(Utils.showMessage("error","Customer is not valid"));$scope.isLoading=false})}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ContractService",["$http",function($http){var service={fill:function(data){return $http({method:"POST",url:"../contractService/fill.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},getAll:function(data){return $http({method:"POST",url:"../contractService/getAll.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})}};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("countryChangeModal",["$rootScope","CustomerSubscriptionService","SubscriptionConstants","CustomerUtil","CustomerPreviewService","CaseRecordService","Utils","$app","AppConstants","SalesConstants","AppUtils","features",function($rootScope,CustomerSubscriptionService,SubscriptionConstants,CustomerUtil,CustomerPreviewService,CaseRecordService,Utils,$app,AppConstants,SalesConstants,AppUtils,features){return{restrict:"EA",scope:{},replace:true,templateUrl:"js/sales/partials/country-change-modal.html",link:function($scope,element,attrs){$scope.$on("InitiateCountryChangeValidations",function(event,customerObj){$scope.customer=customerObj;$scope.validateCountryChange()});$scope.messages=[];$scope.showMessage=function(type,message){$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.validateCountryChange=function(){console.log("Country Change Validations started for customer",$scope.customer);$scope.messages=[];$scope.searchCustomer();$scope.loadSubscriptions();$scope.loadJilTeamSubscriptions()};$scope.loadSubscriptions=function(){$scope.isSubscriptionLoading=true;$scope.locale=$scope.getCustomerCountryCode();$scope.subscriptionAccountId=$scope.customer.rengaId+"@AdobeID";console.log("Query CustomerSubscriptionService.getSubscriptionLists",$scope.guid);CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:$scope.subscriptionAccountId,locale:$scope.locale}).success(function(result){console.log("Success CustomerSubscriptionService.getSubscriptionLists");if(result.length>0){_.each(result,function(subsObj){if(subsObj.billingInfo.paymentInstrumentInfo!==null&&angular.isDefined(subsObj.billingInfo.paymentInstrumentInfo.paymentCategory)){if(subsObj.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase().indexOf(SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED)!=-1){console.log("Vendor managed Subscription found");$scope.showMessage("info","Customer has vendor managed subscription. Country change not allowed")}else{if(subsObj.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase()!==SalesConstants.PAYMENT_CREDIT_CARD_TYPE){console.log("Payment type other than Credit Card found in Subscription "+subsObj.id);$scope.showMessage("info","Unable to Initiate Country Change: Subscription "+subsObj.contract.externalContractId+" has a payment method other than Credit Card")}}}else{console.log("Vendor managed Subscription found");$scope.showMessage("info","Customer has vendor managed subscription. Country change not allowed")}})}$scope.subscriptionlists=_.filter(result,{isChangeCountryAvailable:true});for(i=0;i<$scope.subscriptionlists.length;i++){$scope.subscriptionlists[i].transactionLabel=SubscriptionConstants.SUBSCRIPITON_EXTERNAL_REF_NUMBER;$scope.subscriptionlists[i].formatedPurchaseDate=$scope.subscriptionlists[i].contract.termStartDate;$scope.subscriptionlists[i].ageing=moment().diff(new Date($scope.subscriptionlists[i].formatedPurchaseDate),"days");$scope.subscriptionlists[i].locale=$scope.locale;$scope.subscriptionlists[i].subscriptionAccountId=$scope.customer.rengaId;if($scope.subscriptionlists[i].paymentStatus.toUpperCase()!=SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){$scope.subscriptionlists[i].storeOrderNumber=$scope.subscriptionlists[i].contract.externalContractId;$scope.subscriptionlists[i].transactionLabel=SubscriptionConstants.SUBSCRIPTION_CONTRACT_ID}$scope.subscriptionlists[i].productName=$scope.subscriptionlists[i].localizedLongProductDescriptor}$scope.isSubscriptionLoading=false}).error(function(error){console.log("error",error);$("#subscriptions").html(error);$scope.isSubscriptionLoading=false;$scope.showMessage("error","Error while fetching active subscriptions from JIL");AppUtils.sendLogToServer("Country Change Validation Failed (Load Individual Subscriptions): Customer GUID :"+$scope.subscriptionAccountId)})};$scope.loadJilTeamSubscriptions=function(){$scope.isJilTeamSubscriptionLoading=true;$scope.customerGuid=$scope.customer.rengaId;$scope.locale=$scope.getCustomerCountryCode();CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:$scope.locale}).success(function(result){$scope.isJilTeamSubscriptionLoading=false;if(result.length>0){var isInDirectContract=_.every(result,function(subs){return subs.type==="INDIRECT"});if(isInDirectContract){console.log("Customer has indirect team subscription");$scope.showMessage("info","Customer has indirect team subscription. Country change not allowed.")}$scope.jilTeamSubscriptionlists=CustomerUtil.getTeamSubscriptionList(result,$scope.customerGuid);var isPrimaryAdmin=_.every($scope.jilTeamSubscriptionlists,function(subscription){return subscription.isPrimaryAdmin===true});if(!features.isFeatureEnabled("cbc_teamflow")){if(isPrimaryAdmin){console.log("Customer has team subscriptions and a primary admin. Country change not allowed.");$scope.showMessage("info","Country change is not allowed for team customer")}}if(!isPrimaryAdmin){console.log("Customer has team subscriptions but is not a primary admin. Go ahead");$scope.jilTeamSubscriptionlists=[]}_.every(result,function(subs){if(subs.type==="DIRECT"&&subs.billingInfo.paymentCategory==="PAYPAL"){$scope.showMessage("info","Customer has direct team subscription with paypal payment method. Country change not allowed.")}})}}).error(function(error){$scope.isJilTeamSubscriptionLoading=false;$scope.showMessage("error","Error while fetching team subscriptions from JIL");AppUtils.sendLogToServer("Country Change Validation Failed (Load Team Subscriptions ): Customer GUID :"+$scope.customerGuid)})};$scope.getProductSeats=function(records,offerId){var qty=0;angular.forEach(records,function(product){if(offerId==product.offerId&&product.paymentStatus&&product.paymentStatus.toUpperCase()!=="CANCELLED"){qty=qty+product.quantity}});return qty};$scope.getCustomerCountryCode=function(){return angular.isDefined($scope.customer.countryCode)?$scope.customer.countryCode:$scope.customer.country};$scope.loadOpenCases=function(){console.log("loading open cases for customer",$scope.customer);$scope.isLoadingCases=true;CaseRecordService.fill({customerNo:$scope.customer.customerNo,startIndex:0,numberOfRows:-1,status:"open"}).success(function(result){console.log("success CaseRecordService.fill");$scope.isLoadingCases=false;$scope.cases=_.filter(result,{closed:false})}).error(function(error){console.log("error",error);$scope.isLoadingCases=false;$scope.showMessage("error","Error while fetching open cases from CRM");AppUtils.sendLogToServer("Country Change Validation Failed (Load Open Cases): Customer Number :"+$scope.customer.customerNo)})};$scope.searchCustomer=function(){$scope.isLoadingCases=true;$scope.searchFields={idNumber:$scope.customer.rengaId,customerType:1,authSrc:"AdobeID"};CustomerPreviewService.search($scope.searchFields).success(function(result){if(angular.isDefined(result.customerSearchResults[0].customerNo)&&result.customerSearchResults[0].customerNo!==""){$scope.customer.customerNo=result.customerSearchResults[0].customerNo;$scope.loadOpenCases()}else{console.log("Customer not found in CRM");$scope.isLoadingCases=false;$scope.cases=[]}}).error(function(error){console.log("[Error in Country Change flow] customer not found in CRM");$scope.showMessage("error","Error while fetching customer profile from CRM to load open cases");AppUtils.sendLogToServer("Country Change Validation Failed (Load Customer Profile from CRM): Customer Number :"+$scope.customer.rengaId)})};$scope.closeChangeCountryModal=function(){$scope.subscriptionlists=[];$scope.cases=[];$scope.jilTeamSubscriptionlists=[];$("#countryChangeModal").modal("hide");$rootScope.$broadcast("CHANGE_COUNTRY_MODEL_CANCEL")};$scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-chevron-right")?"glyphicon glyphicon-chevron-down":"glyphicon glyphicon-chevron-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseJilTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseJilTeamProductItems"+indexId).removeClass().addClass(accordionClassName)};$scope.getStatusColor=function(statusText){return Utils.getStatusColor(statusText)};$scope.proceedCountryChange=function(){$scope.subscriptionlists=[];$scope.cases=[];$scope.jilTeamSubscriptionlists=[];$("#countryChangeModal").modal("hide");$rootScope.$broadcast("COUNTRY_CHANGE_MODAL_PROCEED",$scope.customer);AppUtils.sendLogToServer("Country Change Validation Successful (Proceeding to next step > Customer Details): Customer Guid :"+$scope.customer.rengaId)};$scope.isSubscriptionLoading=$scope.isJilTeamSubscriptionLoading=$scope.isLoadingCases=false;$scope.subscriptionlists=$scope.jilTeamSubscriptionlists=$scope.cases=[];$scope.isCountryValidationOk=function(){return !$scope.isSubscriptionLoading&&$scope.subscriptionlists.length<1&&!$scope.isJilTeamSubscriptionLoading&&$scope.jilTeamSubscriptionlists.length<1&&!$scope.isLoadingCases}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCreateCustomer",["$filter","Utils","MetadataService","CustomerRecordService","TrackingService","$location","AppConstants","AddressValidationService","LocalStorageService","AppUtils","SalesServices","ImsNewCustomerDto","$routeParams","SalesConstants","$rootScope","CustomerConstants","SalesUtil",function($filter,Utils,MetadataService,CustomerRecordService,TrackingService,$location,AppConstants,AddressValidationService,LocalStorageService,AppUtils,SalesServices,ImsNewCustomerDto,$routeParams,SalesConstants,$rootScope,CustomerConstants,SalesUtil){return{restrict:"EA",scope:{metadata:"=",titles:"=",languages:"=",loading:"=",salesView:"=",showGst:"=",customerData:"=",openModal:"=",isQuoteToOrder:"=",quoteDetails:"="},replace:true,templateUrl:"js/search/partials/create-customer.html",link:function(scope,element,attrs){scope.showVatOptions=false;scope.showGSTOptions=false;scope.gstRegxPattern=/^\d{2,3}-?\d{3}-?\d{3}$/;scope.isGSTFormatValid=true;scope.newCustomerUI=false;scope.oldFlow=false;scope.isSFDCFLow=false;scope.openModalFunction=scope.openModal||{};scope.setStep=function(step){scope.step=step};scope.getStep=function(){return scope.step};scope.setStep(1);scope.canViewCreateButton=false;scope.defaultCustomer={allowSurveyInOutput:false,blocked:false,marketingValues:null,locked:false,address:{country:{code:null}},bpType:"1",customerNo:null,updateLegacy:false,legacy:false};scope.isCountryJP=false;scope.customerLink=Utils.customerLink;scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};var offset=50;var offsetBody=150;var newSize=offset*2};scope.defaultCountry={code:null};scope.openModalFunction.openModal=function(value){scope.customer=value;scope.isSFDCFLow=true;if(angular.isDefined(scope.customer)&&angular.isDefined(scope.customer.address)){}scope.showModal()};scope.showModal=function(){scope.modelSource="js/search/partials/create-customer-modal.html";var locallyStoredLanguage=LocalStorageService.get("language");if(locallyStoredLanguage=="JA"){scope.isCountryJP=true}else{scope.isCountryJP=false}scope.messages=[];scope.newCustomerUI=scope.salesView?true:false;if(!scope.newCustomerUI){scope.oldFlow=$routeParams.oldFlow?true:false}};scope.modalLoaded=function(){if(scope.isSFDCFLow){}else{scope.customer=angular.copy(scope.defaultCustomer)}scope.customer.taxInfo={};if(scope.salesView){scope.customer.address.country.code=$routeParams.store;scope.customer.address.country.code=scope.customer.address.country.code.split("-")[0];if(scope.isQuoteToOrder&&scope.quoteDetails&&scope.customer.address.country.code==scope.quoteDetails.country){var quoteCustomerData=SalesUtil.getCustomerDetailsFromOrderService(scope.quoteDetails);scope.customer.firstName=quoteCustomerData.firstName;scope.customer.lastName=quoteCustomerData.lastName;scope.customer.email=quoteCustomerData.email;scope.customer.telephone=quoteCustomerData.phone;scope.customer.companyName=quoteCustomerData.companyName;scope.customer.address.postCode=quoteCustomerData.address.postCode}}if(scope.customer.taxInfo){scope.customer.taxInfo.taxType="";scope.customer.taxInfo.taxNumber=""}$("body").css("overflow","hidden");$("#createCustomerModal").modal("show");element.find("#createCustomerModal").scroll(function(){if($(document).find(".bootstrap-maxlength")){$(document).find(".bootstrap-maxlength").hide()}});(scope.customer.address&&scope.customer.address.country.code=="JP")?scope.isCountryJP=true:scope.isCountryJP=false;scope.rescale();$(window).bind("resize",scope.rescale);scope.setStep(1)};scope.closeModal=function(){scope.modelSource="";$("body").css("overflow","auto");$("#createCustomerModal").modal("hide");scope.unlockCustomer()};scope.unlockCustomer=function(){CustomerRecordService.customerLock({customerNo:scope.newCustomerNo,flag:"U"}).success(function(result){console.log("Customer unlocked")}).error(function(err){console.log("Customer unlock failed"+err)})};scope.handleCreate=function(){scope.isSaving=true;scope.isSuccess=false;scope.isWarning=false;scope.isCreatePersonWizard=true;scope.selectedMarkeitngInformation=[];scope.selectedMarkeitngInformation=[];angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values[0].selected=="no"){var objectToPushNo=angular.copy(marketingOptInItem.values[0]);delete objectToPushNo.selected;scope.selectedMarkeitngInformation.push(objectToPushNo)}else{if(marketingOptInItem.values[1].selected=="yes"){var objectToPushYes=angular.copy(marketingOptInItem.values[1]);delete objectToPushYes.selected;scope.selectedMarkeitngInformation.push(objectToPushYes)}}});scope.selectedMarkeitngProfile=[];angular.forEach(scope.marketingProfileInformation,function(marketingProfileItem){angular.forEach(marketingProfileItem.values,function(marketingProfileOptionItem){if(scope.marketingProfile0&&scope.marketingProfile0.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile0.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile1&&scope.marketingProfile1.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile1.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile2&&scope.marketingProfile2.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile2.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile3&&scope.marketingProfile3.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile3.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile4&&scope.marketingProfile4.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile4.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile5&&scope.marketingProfile5.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile5.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}}}}}}})});scope.customer.marketingValues=$.merge(scope.selectedMarkeitngInformation,scope.selectedMarkeitngProfile);if(scope.customer.taxInfo&&angular.isDefined(scope.customer.taxInfo.taxNumber)&&scope.customer.taxInfo.taxNumber.length==0){scope.customer.taxInfo.taxType=""}if(scope.newCustomerUI||!scope.oldFlow){var imsNewCustomerDTO=angular.copy(ImsNewCustomerDto);imsNewCustomerDTO.person.firstName=scope.customer.firstName;imsNewCustomerDTO.person.lastName=scope.customer.lastName;imsNewCustomerDTO.person.countryCode=scope.customer.address.country.code;imsNewCustomerDTO.person.email=scope.customer.email;if(scope.customer.defaultCountryLanguage&&scope.customer.address.country.code){imsNewCustomerDTO.person.locale=scope.customer.defaultCountryLanguage+"_"+scope.customer.address.country.code}else{imsNewCustomerDTO.person.locale="EN_"+scope.customer.address.country.code}scope.successMessage="";scope.warningMessage="";if(imsNewCustomerDTO.person.countryCode=="KR"){imsNewCustomerDTO.person.specialPrivacy={krCol:scope.customer.isPIUseSelected,krSp:scope.customer.isPIShareSelected,krExp:scope.customer.isPIShareThirdPartySelected,krTpr:angular.isDefined(scope.customer.isPIShareThirdPartyCompTrfSelected)&&scope.customer.isPIShareThirdPartyCompTrfSelected?true:false}}SalesServices.createPerson(imsNewCustomerDTO).success(function(imsResult,status,headers,config){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_IMS_RENGA;messageObject.Functionality="New Customer - Search Customer";messageObject.Test_Customer_Name=imsNewCustomerDTO.person.firstName+" "+imsNewCustomerDTO.person.lastName;messageObject.Customer_Country=imsNewCustomerDTO.person.countryCode;messageObject.Test_Customer_Email=imsNewCustomerDTO.person.email;messageObject.Test_Customer_AdobeID=imsNewCustomerDTO.person.email;messageObject.Customer_Guid=imsResult.guid;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config);scope.imsMessages=AppUtils.getSingleMessage("success","Customer created successfully GUID"+imsResult.guid);scope.newIMSCustomerCreateResult=imsResult;scope.customer.userId=scope.newIMSCustomerCreateResult.guid;scope.customer.adobeId=scope.customer.email;scope.customer.newCustomer=true;scope.customer.fmfCustomerFlag=true;scope.customer.customerIdentifications=[];scope.customer.customerIdentifications.push({idType:"ZGUID",idNumber:scope.customer.userId.replace(/@AdobeID/i,""),authSrcType:""});scope.customer.customerIdentifications.push({idType:"ZADBID",idNumber:scope.customer.email,authSrcType:""});if(scope.customer.taxInfo&&angular.isDefined(scope.customer.taxInfo.taxNumber)&&scope.customer.taxInfo.taxNumber.length!==0){AppUtils.sendLogToServer("Request - New Customer Creation Flow - Customer Tax Information - Tax Number="+scope.customer.taxInfo.taxNumber+" FirstName="+scope.customer.firstName+" LastName="+scope.customer.lastName+" CustomerGUID="+scope.customer.userId,AppConstants.MESSAGE_INFO_TYPE)}CustomerRecordService.createItem(scope.customer).success(function(createCrmResult,status,headers,config){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Functionality="New Customer - Search Customer";messageObject.Test_Customer_Name=imsNewCustomerDTO.person.firstName+" "+imsNewCustomerDTO.person.lastName;messageObject.Customer_Country=imsNewCustomerDTO.person.countryCode;messageObject.Test_Customer_Email=imsNewCustomerDTO.person.email;messageObject.Test_Customer_AdobeID=imsNewCustomerDTO.person.email;messageObject.Customer_Guid=imsResult.guid;messageObject.Customer_Number=createCrmResult.customerNo;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;if(!Utils.hasErrors(createCrmResult.messages)){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;scope.isCreatePersonWizard=true;scope.isSaving=false;scope.isSuccess=true;scope.newCustomerNo=createCrmResult.customerNo;scope.customer.customerNo=createCrmResult.customerNo;scope.messages=createCrmResult.messages;scope.successMessage="Customer "+scope.customer.email+"("+createCrmResult.customerNo+") created successfully."}else{scope.isSaving=false;scope.isCreatePersonWizard=true;scope.isSuccess=true;scope.isWarning=true;scope.successMessage="Customer "+scope.customer.email+" created successfully.";if(updateCrmResult.messages){scope.warningMessage=updateCrmResult.messages[0].text}messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS_WITH_WARNING;messageObject.Warning_Reason=scope.warningMessage}AppUtils.sendLogToServer(messageObject,status,headers,config);$("#createCustomerModal .modal-body").css({opacity:"0.4","pointer-events":"none"})}).error(function(error,status,headers,config){scope.successMessage="Customer "+scope.customer.email+" created successfully.";if(error.messages){scope.warningMessage=error.messages[0].text}scope.isSaving=false;scope.isSuccess=true;scope.isWarning=true;scope.isCreatePersonWizard=true;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Functionality="New Customer - Search Customer";messageObject.Test_Customer_Name=imsNewCustomerDTO.person.firstName+" "+imsNewCustomerDTO.person.lastName;messageObject.Customer_Country=imsNewCustomerDTO.person.countryCode;messageObject.Test_Customer_Email=imsNewCustomerDTO.person.email;messageObject.Test_Customer_AdobeID=imsNewCustomerDTO.person.email;messageObject.Customer_Guid=imsResult.guid;messageObject.Exception_Reason=scope.warningMessage;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(error,status,headers,config){if(error.error_description&&error.error_description=="unable to validate entity"&&error.error_list[0].propertyName=="person.email"&&error.error_list[0].errorMessage=="create denied"){scope.messages=AppUtils.getSingleMessage("error","Email address already in use by existing customer")}else{if(error.error_description&&error.error_description=="unable to validate entity"&&error.error_list[0].propertyName=="person.locale"&&error.error_list[0].errorMessage=="may not be empty"){scope.messages=AppUtils.getSingleMessage("error","Customer locale may not be empty.")}else{scope.messages=AppUtils.getSingleMessage("error",error.error_description)}}var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_IMS_RENGA;messageObject.Functionality="New Customer - Search Customer";messageObject.Test_Customer_Name=imsNewCustomerDTO.person.firstName+" "+imsNewCustomerDTO.person.lastName;messageObject.Customer_Country=imsNewCustomerDTO.person.countryCode;messageObject.Test_Customer_Email=imsNewCustomerDTO.person.email;messageObject.Test_Customer_AdobeID=imsNewCustomerDTO.person.email;messageObject.Customer_Guid=error.guid;messageObject.Exception_Reason=scope.messages[0].text;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config);scope.isSaving=false;scope.isCreatePersonWizard=false;scope.step=2})}else{if(scope.oldFlow){CustomerRecordService.createItem(scope.customer).success(function(result){scope.isSaving=false;scope.messages=result.messages;scope.isCreatePersonWizard=false;if(!Utils.hasErrors(result.messages)){scope.isCreatePersonWizard=true;scope.newCustomerNo=result.customerNo;scope.messages=result.messages;scope.successMessage=result.messages[0].text;$("#createCustomerModal .modal-body").css({opacity:"0.4","pointer-events":"none"})}}).error(function(result){scope.messages=result.messages;scope.isSaving=false;scope.isCreatePersonWizard=false;scope.step=2})}}};scope.hideCustomerSuccessModal=function(){scope.customer.messages=scope.messages;scope.closeModal();scope.isCreatePersonWizard=false;if(angular.isDefined(scope.isSFDCFLow)&&scope.isSFDCFLow){scope.openModalFunction.updateCreateDetail(scope.customer)}else{if(scope.salesView){scope.selectedCustomer=SalesUtil.getCustomerDetailsData(false,scope.customer);$rootScope.$broadcast("UpdateCustomerDetails",{custromerDetails:angular.copy(scope.selectedCustomer),isCustomerInUrlValid:false})}else{if(scope.newCustomerNo){$location.path("/customer/"+scope.newCustomerNo)}else{if(scope.customer.email){scope.$parent.searchFields.idNumber=scope.customer.email;scope.$parent.search()}}}}};scope.checkGSTDisplay=function(){scope.showGSTOptions=false;if(scope.customer.address.country.code.toUpperCase()=="NZ"&&scope.showGst!=false){scope.customer.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;scope.showGSTOptions=true}};scope.checkVatDisplay=function(){scope.showVatOptions=false;angular.forEach(scope.metadata.vatOptions,function(vatItem){if(scope.customer.address.country.code&&!scope.showVatOptions){if(vatItem.code.indexOf(scope.customer.address.country.code)!=-1){scope.showVatOptions=true}}})};scope.$watch("customer.address.state",function(newValue){if(angular.isDefined(newValue)&&angular.isDefined(scope.countrySpecificInfo)){angular.forEach(scope.countrySpecificInfo.statesByCountry,function(stateItem){if(newValue==stateItem.id){scope.customer.address.stateName=stateItem.description}})}});scope.$watch("customer.address.country.code",function(value){if(!value){return}value=value.split("-")[0];if(value=="JP"){scope.isCountryJP=true}else{scope.isCountryJP=false}scope.checkVatDisplay();scope.checkGSTDisplay();MetadataService.getCountrySpecificInfo({countryCode:value}).success(function(result){scope.countrySpecificInfo=result});if(scope.metadata){scope.marketingOptinInformation=[];scope.marketingProfileInformation=[];scope.customer.address.country.name="";scope.marketingOptinInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,value,true);scope.marketingProfileInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,value,false);scope.customer.address.country.name=MetadataService.getCountryNameFromCountry(scope.metadata.countries,value)}});scope.showDefaultLanguage=function(){scope.customer.defaultCountryLanguage=Utils.getDefaultCountriesLanguage(scope.customer.address.country.code);scope.customer.outputLanguage=scope.customer.defaultCountryLanguage};scope.$watch("customer.outputLanguage",function(value){if(!scope.customer){return}if(!value){return scope.customer.isCountryLanguageMismatch=true}scope.customer.isCountryLanguageMismatch=scope.customer.defaultCountryLanguage.toUpperCase()!=scope.customer.outputLanguage.toUpperCase()?true:false});scope.isValid=function(customer){var returnResult=false;scope.isGSTFormatValid=true;if(!customer){returnResult=false;return returnResult}if(scope.newCustomerUI){var nameRegex=/^[0-9A-Za-z?\s]{1,}[\.]{0,1}[0-9A-Za-z?\-'.,&\s]{0,}$/;if(customer.firstName&&customer.lastName&&customer.email){returnResult=true;var customerEmail=customer.email;if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){returnResult=false}}}if(angular.uppercase(customer.address.country.code)!=="JP"&&(!nameRegex.test(customer.firstName)||!nameRegex.test(customer.lastName))){returnResult=false}}else{if(!scope.newCustomerUI&&!scope.oldFlow){var nameRegex=/^[0-9A-Za-z?\s]{1,}[\.]{0,1}[0-9A-Za-z?\-'.,&\s]{0,}$/;if(customer.firstName&&customer.lastName&&customer.email){returnResult=true;var customerEmail=customer.email;if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){returnResult=false}}}if(angular.uppercase(customer.address.country.code)!=="JP"&&(!nameRegex.test(customer.firstName)||!nameRegex.test(customer.lastName))){returnResult=false}}else{if(customer.firstName&&customer.lastName){returnResult=true;var customerEmail=$("#createCustomerEmail").val();if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){returnResult=false}}}}}if(customer.taxInfo&&customer.taxInfo.taxType&&customer.taxInfo.taxType==CustomerConstants.GST_NZ_CODE){if(angular.isDefined(customer.taxInfo.taxNumber)&&customer.taxInfo.taxNumber.length>0){returnResult=scope.gstRegxPattern.test(customer.taxInfo.taxNumber);if(!returnResult){scope.isGSTFormatValid=returnResult}}}else{if(customer.taxInfo&&customer.taxInfo.taxType&&!customer.taxInfo.taxNumber){returnResult=false;return returnResult}else{if(customer.taxInfo&&!customer.taxInfo.taxType&&customer.taxInfo.taxNumber){returnResult=false;return returnResult}}}return returnResult};scope.disableNext=false;scope.$watch("customer",function(value){if(!value){return}if(value.firstName&&value.lastName&&value.firstName==""&&value.lastName==""){scope.disableNext=true}});scope.handleValidateAddress=function(){scope.setStep(3);scope.isValidatingAddress=true;scope.canViewCreateButton=false;scope.fadeTo("#postalStandardSerivceAddress",0.4);scope.fadeTo("#originalAddress",0.4);scope.adddressValidationMessages=[];scope.validateCorrectStreetOption();AddressValidationService.validate(scope.customer.address).success(function(result){scope.fadeTo("#postalStandardSerivceAddress",1);scope.fadeTo("#originalAddress",1);if(result.message!=null){scope.adddressValidationMessages=[];scope.adddressValidationMessages.push(result.message)}scope.validPssa=result.addressFinal;if(result.finalProposal!=null){if(result.finalProposal){result.finalProposal.country=scope.customer.address.country}if(!result.finalProposal.stateName){angular.forEach(scope.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}scope.finalPssa=angular.copy(result.finalProposal)}scope.isValidatingAddress=false;scope.suggestions=result.suggestions;if(scope.customer.address.country.code=="JP"){scope.finalPssa=scope.customer.address}}).error(function(result){scope.isValidatingAddress=false})};scope.handleValidateOwnAddress=function(){scope.canViewCreateButton=true;scope.fadeTo("#postalStandardSerivceAddress",0.4);scope.fadeTo("#originalAddress",1);scope.isValidAddress=true};scope.fadeTo=function(el,level){$(el).fadeTo("fast",level)};scope.handleValidateNewAddress=function(){scope.canViewCreateButton=true;scope.replaceCorrectStreetNo();scope.customer.address=scope.finalPssa;scope.fadeTo("#postalStandardSerivceAddress",1);scope.fadeTo("#originalAddress",0.4);scope.isValidAddress=true};scope.marketingProfile0={};scope.marketingProfile1={};scope.marketingProfile2={};scope.marketingProfile3={};scope.marketingProfile4={};scope.marketingProfile5={};scope.checkMarketingInfo=function(){scope.unSelectNoValue="";scope.unSelectYesValue="";angular.forEach(scope.customer.marketingValues,function(customerMarketingOptInItem){angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(customerMarketingOptInItem.code==marketingOptInItem.code){if(customerMarketingOptInItem.value==marketingOptInItem.values[0].value&&customerMarketingOptInItem.description.toLowerCase()==marketingOptInItem.values[0].description.toLowerCase()&&customerMarketingOptInItem.description.toLowerCase()=="no"){marketingOptInItem.values[0].selected="no"}if(customerMarketingOptInItem.value==marketingOptInItem.values[1].value&&customerMarketingOptInItem.description.toLowerCase()==marketingOptInItem.values[1].description.toLowerCase()&&customerMarketingOptInItem.description.toLowerCase()=="yes"){marketingOptInItem.values[1].selected="yes"}}});for(var i=0;i<scope.marketingProfileInformation.length;i++){var marketingProfileItem=scope.marketingProfileInformation[i];if(customerMarketingOptInItem.code==marketingProfileItem.code){if(customerMarketingOptInItem.description!=null||customerMarketingOptInItem.value!=""){switch(i){case 0:scope.marketingProfile0.value=customerMarketingOptInItem.value;break;case 1:scope.marketingProfile1.value=customerMarketingOptInItem.value;break;case 2:scope.marketingProfile2.value=customerMarketingOptInItem.value;break;case 3:scope.marketingProfile3.value=customerMarketingOptInItem.value;break;case 4:scope.marketingProfile4.value=customerMarketingOptInItem.value;break;case 5:scope.marketingProfile5.value=customerMarketingOptInItem.value;break}}}}})};scope.checkMarketingProfileInfo=function(){angular.forEach(scope.marketingProfileInformation,function(marketingProfileItem){marketingProfileItem.selected=""})};scope.selectedMarketingItem=function(item,selectedValue){if(selectedValue=="no"){item[0].selected="no";item[1].selected=""}else{if(selectedValue=="yes"){item[0].selected="";item[1].selected="yes"}}scope.unSelectNoValue="";scope.unSelectYesValue=""};scope.checkSelectAll=function(checkAllValue){if(checkAllValue=="no"){scope.unSelectNoValue="no";scope.unSelectYesValue=""}else{scope.unSelectNoValue="";scope.unSelectYesValue="yes"}angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values[0].description.toLowerCase()==checkAllValue||checkAllValue=="no"){marketingOptInItem.values[0].selected="no";marketingOptInItem.values[1].selected=""}if(marketingOptInItem.values[1].description.toLowerCase()==checkAllValue||checkAllValue=="yes"){marketingOptInItem.values[0].selected="";marketingOptInItem.values[1].selected="yes"}})};scope.handleMarketingProfileSelect=function(selectedRecord,selectedProfileItem){if(selectedRecord.selected==""){scope.selectedMarkeitngProfile.push(selectedProfileItem);selectedRecord.selected="combo"}else{if(selectedRecord.selected=="combo"){angular.forEach(scope.selectedMarkeitngProfile,function(marketingProfileItem){if(marketingProfileItem.code==selectedProfileItem.code){marketingProfileItem.description=selectedProfileItem.description;marketingProfileItem.value=selectedProfileItem.value}})}}};scope.isVATTypeMismatched=false;scope.$watch("customer.taxInfo.taxType",function(value){if(!scope.customer){return}if(scope.customer.taxInfo&&scope.customer.address.country&&scope.metadata.vatOptions){scope.isVATTypeMismatched=(MetadataService.getDefaultVATOptionFromMetadata(scope.metadata.vatOptions,scope.customer.address.country.code)!=scope.customer.taxInfo.taxType)?true:false}});scope.resetDefaultVatType=function(){if(scope.customer.taxInfo&&scope.customer.address.country){scope.customer.taxInfo.taxType=MetadataService.getDefaultVATOptionFromMetadata(scope.metadata.vatOptions,scope.customer.address.country.code)}};scope.clearVat=function(){if(scope.customer.taxInfo){scope.customer.taxInfo.taxType="";scope.customer.taxInfo.taxNumber=""}};scope.isCorrectStreetOptionVisible=false;scope.validateCorrectStreetOption=function(){scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber(scope.customer.address)};scope.correctStreetNo="";scope.updateCorrectStreetNo=function(correctStreetNo){scope.correctStreetNo=correctStreetNo};scope.replaceCorrectStreetNo=function(){if(scope.correctStreetNo&&scope.correctStreetNo!=""){scope.finalPssa=AppUtils.getReplacedStreet1Address(scope.correctStreetNo,scope.finalPssa)}scope.correctStreetNo=""}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCreateOrganizationContact",["$filter","$rootScope","Utils","MetadataService","CustomerRecordService","TrackingService","$location","CustomerPreviewService",function($filter,$rootScope,Utils,MetadataService,CustomerRecordService,TrackingService,$location,CustomerPreviewService){return{restrict:"EA",scope:{organization:"=",metadata:"=",languages:"=",loading:"="},replace:true,templateUrl:"js/search/partials/create-organization-contact.html",link:function(scope,element,attrs){scope.isSaving=false;scope.isSearching=false;scope.searchPage=1;scope.defaultContact={relationFlag:1,relationshipType:"BUR001",contactType:"9001"};scope.defaultCustomer={allowSurveyInOutput:false,blocked:false,locked:false,customerNo:null,bpType:"2",updateLegacy:false,legacy:false,customerRelations:{}};scope.relationship={};scope.contact={};scope.customerLink=Utils.customerLink;scope.showModal=function(){scope.modelSource="js/search/partials/create-organization-contact-modal.html"};scope.modalLoaded=function(){scope.customer=angular.copy(scope.defaultCustomer);scope.contact=angular.copy(scope.defaultContact);$("body").css("overflow","hidden");element.find("#createOrganizationContactModal").modal("show");scope.step=1};scope.closeModal=function(){scope.searchPage=1;scope.relationship={};scope.messages=[];scope.modelSource="";$("body").css("overflow","auto");element.find("#createOrganizationContactModal").modal("hide")};scope.handleCreate=function(){scope.isSaving=true;scope.contact.partner1=scope.organization.customerNo;scope.customer.customerNo=scope.organization.customerNo;scope.customer.customerRelations=[];scope.customer.customerRelations.push(scope.contact);CustomerRecordService.updateItem(scope.customer).success(function(result){$rootScope.lastCustomer=null;scope.messages=result.messages;scope.isSaving=false;if(!Utils.hasErrors(result.messages)){scope.closeModal();$location.path("/customer/"+result.customerNo+"/rel/"+result.customerRelations[0].partnerNo)}}).error(function(result){scope.messages=result.messages;scope.isSaving=false})};scope.handleSearch=function(){scope.isSearching=true;scope.relationship.customerType="1";CustomerPreviewService.search(scope.relationship).success(function(result){scope.isSearching=false;scope.messages=result.messages;scope.results=result.customerSearchResults;scope.searchPage=2}).error(function(result){scope.isSearching=false;scope.messages=result.messages;scope.results=null})};scope.isValid=function(contactx){if(!contactx){return false}if(contactx.firstName&&contactx.lastName&&contactx.email&&contactx.contactType){return true}return false};scope.currentTab=function(){var selectedTabName=element.find("li.active a").first().text();return selectedTabName=="New Contact"?2:1};scope.handleBack=function(){scope.searchPage=1};scope.handleSelectForLink=function(contactNo){scope.isCreatingLink=true;scope.customer.customerNo=scope.organization.customerNo;scope.customer.customerRelations=[];scope.customer.customerRelations.push({partner1:scope.customer.customerNo,partner2:contactNo,contactType:"9001"});$("#searchResultArea :input").attr("disabled",true);CustomerRecordService.updateItem(scope.customer).success(function(result){$rootScope.lastCustomer=null;scope.messages=result.messages;$("#searchResultArea :input").removeAttr("disabled");scope.isCreatingLink=false;if(!Utils.hasErrors(result.messages)&&!Utils.hasWarnings(result.messages)){scope.closeModal();$location.path("/customer/"+result.customerNo+"/rel/"+result.customerRelations[0].partnerNo)}}).error(function(result){$("#searchResultArea :input").removeAttr("disabled");scope.messages=result.messages;scope.isCreatingLink=false})};scope.isValidForSearch=function(relationship){if(!relationship){return}if((relationship.firstName&&relationship.firstName!="")||(relationship.lastName&&relationship.lastName!="")||(relationship.countryCode&&relationship.countryCode!="")||(relationship.customerId&&relationship.customerId!="")||(relationship.externalRef&&relationship.externalRef!="")||(relationship.transactionNo&&relationship.transactionNo!="")||(relationship.serialNo&&relationship.serialNo!="")||(relationship.idNumber&&relationship.idNumber!="")||(relationship.email&&relationship.email!="")){return true}return false}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CreditMemoController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","Credit Memo View");$scope.PaymentConstants=PaymentConstants;$scope.creditMemoReturnReasons=[];$scope.wizardStep=1;$scope.creditMemoTransaction=angular.copy($scope.transaction);$scope.cmReason={selectedId:null};$scope.isOverrideBtnShow=true;$scope.isNewPaymentEnableForCreateCM=false;$scope.isOrderReasonValidInUrl=false;angular.forEach($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],function(reasonItem){var cmReasonItem=angular.copy(reasonItem);if(cmReasonItem[MetadataService.INDEX_NAMES.ORDER_TYPE]==TransactionConstants.TRANSACTION_CREDIT_MEMO){if(cmReasonItem.code==TransactionConstants.SELF_CANCELLATION_CM_REASON_CODE&&!$scope.isCreditMemoFromDirectUrl){}else{$scope.creditMemoReturnReasons.push(cmReasonItem)}if($scope.isCreditMemoFromDirectUrl&&!$scope.isOrderReasonValidInUrl){$scope.isOrderReasonValidInUrl=cmReasonItem[MetadataService.INDEX_NAMES.CODE]==$location.search().reason}}});$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.creditMemoTransaction.transactionGuid,transactionNo:$scope.creditMemoTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.creditMemoTransaction.transactionGuid,transactionNo:$scope.creditMemoTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.cancelCreditMemo=function(){$("#cancelOrderModal").modal("show")};$scope.initializeCheckbox=function(){if($scope.creditMemoTransaction.items.length==1){$scope.selectAll=true;angular.forEach($scope.creditMemoTransaction.items,function(productItem){productItem.NewProp_selected=true})}else{$scope.selectAll=false;angular.forEach($scope.creditMemoTransaction.items,function(productItem){productItem.NewProp_selected=false})}};$scope.checkJpPaymentEnabling=function(){if($scope.creditMemoTransaction.customer.address.country.code==AppConstants.COUNTRY_CODE_JAPAN&&$scope.creditMemoTransaction.paymentDetails&&($scope.creditMemoTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.creditMemoTransaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)){$scope.isNewPaymentEnableForCreateCM=true;$scope.viewType="EDIT";$scope.btPaymentDetails=angular.copy($scope.creditMemoTransaction.paymentDetails);$scope.btPaymentDetails.bankCountry=$scope.creditMemoTransaction.customer.address.country.code;$scope.cvsPaymentDetails=angular.copy($scope.creditMemoTransaction.paymentDetails);$scope.cvsPaymentDetails.bankCountry=$scope.creditMemoTransaction.customer.address.country.code;$scope.btPaymentDetails.accountHolder=$scope.cvsPaymentDetails.accountHolder=""}if($scope.transactionView==TransactionConstants.TRANSACTION_CREDIT_MEMO_VIEW){$scope.viewType="CM_VIEW"}};$scope.$watch("cmReason.selectedId",function(){if($scope.cmReason.selectedId!=null&&$scope.cmReason.selectedId!=""){$scope.wizardStep=2}},true);$scope.backStep=function(step){$scope.wizardStep=step;if(step==1){$scope.cmReason.selectedId=""}$scope.transactionErrorMessage=$scope.transactionReviewErrorMessage=""};$scope.checkProductsValid=function(){var result=false;var minItemSelected=false;var quantityValid=true;var totalItemSelected=0;angular.forEach($scope.creditMemoTransaction.items,function(productItem){if(productItem.NewProp_selected){minItemSelected=true;totalItemSelected++;$scope.selectAll=$scope.creditMemoTransaction.items.length==totalItemSelected?true:false}if(productItem.quantity>productItem.NotModify_quantity){productItem.quantity=productItem.NotModify_quantity}if(!angular.isNumber(productItem.quantity)){quantityValid=false}});if(!minItemSelected){$scope.transactionErrorMessage="Select at least one product item";$scope.selectAll=false}else{if(!quantityValid){$scope.transactionErrorMessage="Enter valid quantity/seat";$scope.selectAll=false}else{$scope.transactionErrorMessage="";result=true}}$("#selectedAllChk").prop("checked",$scope.selectAll);return result};$scope.selectAllItems=function($event){var selectedValue=$($event.target).is(":checked");angular.forEach($scope.creditMemoTransaction.items,function(productItem){if(selectedValue){productItem.NewProp_selected=true}else{productItem.NewProp_selected=false}});$scope.selectAll=selectedValue};$scope.checkItemSelection=function(selectedRowValue,$event){selectedRowValue.NewProp_selected=$($event.target).is(":checked")};$scope.isProductItemQtyEditable=function(productItem){if(productItem.NotModify_quantity==1||!productItem.NewProp_selected){return false}return true};$scope.reviewTransaction=function(){var creditMemoReview=angular.copy($scope.creditMemoTransaction);$scope.transactionReviewErrorMessage="";$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Review","Reviewing the credit memo items",false,false);creditMemoReview.returnInProgress=true;creditMemoReview.returnReasonCode=$scope.cmReason.selectedId;creditMemoReview.externalReferenceNo=$scope.creditMemoTransaction.externalReferenceNo;angular.forEach(creditMemoReview.items,function(productItem){if(productItem.NewProp_selected){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity}else{productItem.toReturn=false;productItem.quantityToReturn=0}});TransactionService.review(creditMemoReview).success(function(result){$("#transactionProgressModal").modal("hide");$scope.creditMemoReviewTransaction=result;angular.forEach($scope.creditMemoReviewTransaction.items,function(productItem){productItem.NewProp_productImg=AppUtils.getProductThumbnailImage(productItem.productName);productItem.NotModify_listPrice=productItem.listPrice});$scope.wizardStep=3;if($scope.isCreditMemoFromDirectUrl&&$location.search().amount&&$location.search().amount!=""){$scope.creditMemoReviewTransaction.items[0].listPrice=$location.search().amount;$scope.overrideTransaction();$scope.isCreditMemoFromDirectUrl=false}}).error(function(result){$("#transactionProgressModal").modal("hide");$scope.wizardStep=2;$scope.transactionReviewErrorMessage="Server Exception - Review Failed, Please Try again";TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_SYSTEM,AppConstants.TRACKING_PAGE_SYSTEM_ERROR+"Credit Memo Review")})};$scope.checkOverrideBtn=function(){var returnValue=false;var listPriceValid=true;if($scope.creditMemoReviewTransaction){angular.forEach($scope.creditMemoReviewTransaction.items,function(productItem){if(productItem.listPrice!=productItem.NotModify_listPrice){returnValue=true}if(productItem.listPrice==""||isNaN(Number(productItem.listPrice))){listPriceValid=false}})}$scope.isOverrideBtnShow=returnValue;if(!listPriceValid){$scope.transactionOverrideErrorMessage="Enter valid list price";returnValue=false}else{$scope.transactionOverrideErrorMessage=""}return returnValue};$scope.overrideTransaction=function(){$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Credit Memo Override Is In Progress",false,false);var creditMemoOverride=angular.copy($scope.creditMemoReviewTransaction);creditMemoOverride.returnInProgress=true;creditMemoOverride.returnReasonCode=$scope.cmReason.selectedId;creditMemoOverride.paymentDetails=angular.copy($scope.transaction.paymentDetails);creditMemoOverride.externalReferenceNo=$scope.creditMemoTransaction.externalReferenceNo;angular.forEach(creditMemoOverride.items,function(productItem){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity;productItem.promoPrice=$scope.isCreditMemoFromDirectUrl?Math.abs(Number($location.search().amount).toFixed(2)):Math.abs(Number(productItem.listPrice).toFixed(2));productItem.listPrice=productItem.NotModify_listPrice});if(creditMemoOverride.messages){delete creditMemoOverride.messages}TransactionService.review(creditMemoOverride).success(function(result){$("#transactionProgressModal").modal("hide");$scope.creditMemoOverrideTransaction=result;angular.forEach($scope.creditMemoOverrideTransaction.items,function(productItem){productItem.NewProp_productImg=AppUtils.getProductThumbnailImage(productItem.productName)});$scope.wizardStep=4}).error(function(result){$("#transactionProgressModal").modal("hide");$scope.transactionErrorMessage="Create Credit Memo Transaction Failed, Try again";TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_SYSTEM,AppConstants.TRACKING_PAGE_SYSTEM_ERROR+"Credit Memo Override")})};$scope.createCreditMemoWizard=function(){$scope.wizardStep=4;$scope.creditMemoOverrideTransaction=angular.copy($scope.creditMemoReviewTransaction)};$scope.createCreditMemo=function(){$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Create Credit Memo Is In Progress",false,false);$scope.creditMemoOverrideTransaction.returnInProgress=true;$scope.creditMemoOverrideTransaction.returnReasonCode=$scope.cmReason.selectedId;$scope.creditMemoOverrideTransaction.externalReferenceNo=$scope.creditMemoTransaction.externalReferenceNo;if(!$scope.creditMemoOverrideTransaction.paymentDetails){$scope.creditMemoOverrideTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails)}angular.forEach($scope.creditMemoOverrideTransaction.items,function(productItem){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity});if($scope.creditMemoOverrideTransaction.messages){delete $scope.creditMemoOverrideTransaction.messages}TransactionService.create($scope.creditMemoOverrideTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed",result.messages,true,true);TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Credit Memo Creation Failed")}else{TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Credit Memo Created");var productSku=$scope.creditMemoOverrideTransaction.items[0].sku;var tenureDate=$scope.creditMemoTransaction.creationDate;var returnCaseTemplateUrl;if($scope.isProductCCT||$scope.isCcmTeam){returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.creditMemoOverrideTransaction.customer.customerNo+"&tempId="+AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER+"&productSku="+productSku+"&storeId="+$scope.storeId+"&orderNumber="+result.transactionNumber+"&contextType=TEAM&tenureDate="+tenureDate}else{returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.creditMemoOverrideTransaction.customer.customerNo+"&tempId="+AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER+"&productSku="+productSku+"&storeId="+$scope.storeId+"&orderNumber="+result.transactionNumber+"&contextType=INDIVIDUAL&tenureDate="+tenureDate}window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl);$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Confirmation",result.messages,true,true);$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Credit Memo Creation Failed");TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_SYSTEM,AppConstants.TRACKING_PAGE_SYSTEM_ERROR+"Credit Memo Creation");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed","Create Credit Memo Transaction Failed",true,true)})};$scope.$watch("btPaymentDetails",function(){if($scope.btPaymentDetails){$scope.btCvsPaymentValid=$scope.isBtPaymentFormValid()}},true);$scope.$watch("cvsPaymentDetails",function(){if($scope.cvsPaymentDetails){$scope.btCvsPaymentValid=$scope.isCvsPaymentFormValid()}},true);$scope.isBtPaymentFormValid=function(){var result=false;if(!angular.isDefined($scope.btPaymentDetails.bankKey)||$scope.btPaymentDetails.bankKey==null||$scope.btPaymentDetails.bankKey==""){$scope.btCvsPaymentErrorMessage="Bank Key Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.bankName)||$scope.btPaymentDetails.bankName==null||$scope.btPaymentDetails.bankName==""){$scope.btCvsPaymentErrorMessage="Bank Name Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.controlCode)||$scope.btPaymentDetails.controlCode==null||$scope.btPaymentDetails.controlCode==""){$scope.btCvsPaymentErrorMessage="Control Code Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.bankAccount)||$scope.btPaymentDetails.bankAccount==null||$scope.btPaymentDetails.bankAccount==""){$scope.btCvsPaymentErrorMessage="Bank Account Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.accountHolder)||$scope.btPaymentDetails.accountHolder==null||$scope.btPaymentDetails.accountHolder==""){$scope.btCvsPaymentErrorMessage="Account Holder Is Required"}else{$scope.btCvsPaymentErrorMessage="";result=true}}}}}return result};$scope.isCvsPaymentFormValid=function(){var result=false;if(!angular.isDefined($scope.cvsPaymentDetails.bankKey)||$scope.cvsPaymentDetails.bankKey==null||$scope.cvsPaymentDetails.bankKey==""){$scope.btCvsPaymentErrorMessage="Bank Key Is Required"}else{if(!angular.isDefined($scope.cvsPaymentDetails.bankName)||$scope.cvsPaymentDetails.bankName==null||$scope.cvsPaymentDetails.bankName==""){$scope.btCvsPaymentErrorMessage="Bank Name Is Required"}else{if(!angular.isDefined($scope.cvsPaymentDetails.bankAccount)||$scope.cvsPaymentDetails.bankAccount==null||$scope.cvsPaymentDetails.bankAccount==""){$scope.btCvsPaymentErrorMessage="Bank Account Is Required"}else{if(!angular.isDefined($scope.cvsPaymentDetails.accountHolder)||$scope.cvsPaymentDetails.accountHolder==null||$scope.cvsPaymentDetails.accountHolder==""){$scope.btCvsPaymentErrorMessage="Account Holder Is Required"}else{$scope.btCvsPaymentErrorMessage="";result=true}}}}return result};$scope.updatePayment=function(){$scope.creditMemoOverrideTransaction.paymentDetails=angular.copy($scope.btPaymentDetails);$scope.wizardStep=5};$scope.backStepInCreateCM=function(){$scope.wizardStep=$scope.isNewPaymentEnableForCreateCM?4:3};$scope.initializeCreditMemoScreen=function(){$scope.isDocumentFlowShow=true;$scope.isOnlyHardGoodOrder=false;$scope.isHavingHardGoodItem=false;$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.creditMemoTransaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.creditMemoTransaction);if($scope.creditMemoTransaction.paymentDetails&&$scope.creditMemoTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.creditMemoTransaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}$scope.storeId=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],$scope.creditMemoTransaction.customer.address.country.code,AppConstants.STORE_TYPE_COM,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,MetadataService.INDEX_NAMES.KEY);for(var count=0;count<$scope.creditMemoTransaction.items.length;count++){if($scope.creditMemoTransaction.items[count].deliveryStatus==TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED&&$scope.transactionView!=TransactionConstants.TRANSACTION_CREDIT_MEMO_VIEW){$scope.creditMemoTransaction.items.splice(count,1)}}$scope.initializeCheckbox();$scope.checkJpPaymentEnabling();$scope.handleDirectUrlCreditMemoScreen()};$scope.handleDirectUrlCreditMemoScreen=function(){if($scope.isCreditMemoFromDirectUrl&&$scope.creditMemoTransaction.items.length==1&&$scope.creditMemoTransaction.items[0].productType!=TransactionConstants.CCM_TEAM_PRODUCT_TYPE){$scope.cmReason.selectedId=$scope.isOrderReasonValidInUrl?$location.search().reason:"";if($scope.isOrderReasonValidInUrl){$scope.reviewTransaction()}}else{$scope.isCreditMemoFromDirectUrl=false}};$scope.initializeCreditMemoScreen()}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("CrmCustomerDto",{firstName:"",lastName:"",address:"",customerNo:"",email:"",address:"",taxInfo:{taxType:"",taxNumber:""},allowSurveyInOutput:false,blocked:false,bpType:"1",legacy:false,locked:false,updateLegacy:false});var app=app||angular.module("hxApp",["ngRoute"]);app.value("CrmProductPreviewDto",{REQUEST:{IV_LANG:"",IV_PROD_TYPE:"",IV_INDIRECT:"",IT_PARTNER:{PARTNER:{CONTACT:"",CONTACT_RENGA_GUID:"",CONTACT_IDTYPE:"",CONTACT_AUTHSRCTYPE:"",CONTACT_AUTHSRC:"",ORG:"",ORG_ID_NUMBER:"",ORG_IDTYPE:"",ORG_AUTHSRCTYPE:"",ORG_AUTHSRC:""}}}});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("CrmUtil",["$rootScope","$location","$routeParams","ProductDto",function($rootScope,$location,$routeParams,ProductDto){this.getProductsList=function(crmResult){var productsList=[];var crmProducts=_.has(crmResult,"RESPONSE.ET_RESULT.RESULT")?crmResult.RESPONSE["ET_RESULT"]["RESULT"]:{};angular.forEach(crmProducts,function(product){var productDto=angular.copy(ProductDto);productDto.name=_.has(product,"PRD_NAME")?product.PRD_NAME:"";productDto.ownerId=_.has(product,"PARTNER_NO")?product.PARTNER_NO:"";productDto.serialNumber=_.has(product,"SERIAL_NO")?product.SERIAL_NO:"";productDto.status=_.has(product,"PR_STATUS")?product.PR_STATUS:"";productDto.componentId=_.has(product,"COMPONENTID")?product.COMPONENTID:"";productDto.version=_.has(product,"PRD_VERSION")?product.PRD_VERSION:"";productDto.registrationDate=_.has(product,"PR_DATE")?new Date(product.PR_DATE):"";productDto.sku=_.has(product,"SKU")?product.SKU:"";productDto.regType=_.has(product,"REG_TYPE")?product.REG_TYPE:"";productDto.prodType=_.has(product,"PRD_TYPE")?product.PRD_TYPE:"";productDto.platform=_.has(product,"PRD_PLATFORM")?product.PRD_PLATFORM:"";productDto.config=_.has(product,"PRD_CONFIG")?product.PRD_CONFIG:"";productDto.uniqueId=_.has(product,"UNIQUE_ID")?product.UNIQUE_ID:"";productDto.educational=_.has(product,"IS_EDU")?product.IS_EDU:false;productDto.metaName=productDto.name;productsList.push(productDto)});return productsList}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCsCasesListProductsCrm",["Utils","$rootScope","$routeParams","$location","AppConstants","AppUtils","$timeout","TsCaseService",function(Utils,$rootScope,$routeParams,$location,AppConstants,AppUtils,$timeout,TsCaseService){return{restrict:"EA",scope:{records:"=",perpetualRecords:"=",enterpriseRecords:"=",allRecords:"=",customerNo:"=customerno",customerdetail:"=customerdetail",contactNo:"=contactno",refresh:"&",loading:"=",customer:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/cs-cases-list-products-crm.html",link:function(scope,element,attrs){scope.AppConstants=AppConstants;scope.VIEW_TYPE_PERPETUAL="PERPETUAL";scope.VIEW_TYPE_ENTERPRISE="ENTERPRISE";scope.viewType=scope.VIEW_TYPE_PERPETUAL;var defaultCustomer=function(){return jQuery.extend({},{firstName:"",lastName:"",outputLanguage:""})};scope.$watch("perpetualRecords",function(value){if(scope.viewType==scope.VIEW_TYPE_PERPETUAL&&value){scope.records=value}});scope.$watch("enterpriseRecords",function(value){if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE&&value){scope.records=value}});scope.filterProductName=function(recordItem){var productName="";if(angular.uppercase(recordItem.name)!="CCLE"&&(angular.uppercase(recordItem.regInd)=="C")){productName=recordItem.metaName+" (CCTeam)"}else{if((angular.uppercase(recordItem.name)=="CCSV"||angular.uppercase(recordItem.name)=="APAP")&&(angular.uppercase(recordItem.regType)=="N")){scope.orgNameRecordStyle={width:"240px"};productName=recordItem.offeringCode+" | "+recordItem.cceDesc}else{productName=recordItem.metaName}}return productName};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.isEnterpriseID=function(){return(scope.customer&&scope.customer.enterpriseId)};scope.isCustomerRecord=function(){return(scope.customer&&scope.customer.bpType!=2)};scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseProductItems"+indexId).removeClass().addClass(accordionClassName)};scope.toggleExpandCollapseAll=function(){var buttonClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#product-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};scope.selectExistingProductHandler=function(rec){if(rec){rec.viewType=scope.viewType;if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE){scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,rec)}else{scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,rec)}}};scope.fetchProductDetailsFromProductSkuAndTemplate=function(productSku,storeId){console.log("tempID:: "+scope.tempid);scope.defaultCaseTemplateSearchDto={};scope.selectTemplateDependingOnCaseType();scope.defaultCaseTemplateSearchDto.templateId=scope.tempid;scope.defaultCaseTemplateSearchDto.productSku=productSku;scope.defaultCaseTemplateSearchDto.storeId=storeId;scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();scope.defaultCaseTemplateSearchDto.customerDto.customerNo=scope.customer.customerNo;scope.defaultCaseTemplateSearchDto.customerDto.firstName=scope.customer.firstName;scope.defaultCaseTemplateSearchDto.customerDto.lastName=scope.customer.lastName;scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=scope.customer.outputLanguage;scope.defaultCaseTemplateSearchDto.customerDto.address=scope.customer.address;scope.defaultCaseTemplateSearchDto.contactId=scope.contactid;TsCaseService.getCSCaseFromTemplate(scope.defaultCaseTemplateSearchDto).success(function(result){result.viewType=scope.viewType;result.product.product.sku=productSku;scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,result);scope.isFetchingProductDetailsFromRecord=false}).error(function(error){console.log("TsCaseService.getCSCaseFromTemplate: "+error)})};scope.selectTemplateDependingOnCaseType=function(){if(!scope.tempid){if(scope.casetype=="csCase"){scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE}else{scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE}}};scope.triggerBtnName="";scope.isBtnTriggered=false;scope.triggerClickInBtnGrp=function(triggerBtnName){if(triggerBtnName&&!angular.element(triggerBtnName).hasClass("active")){scope.isBtnTriggered=true;$("#perpetualProductsListBtn").removeClass("active");$("#enterpriseProductsListBtn").removeClass("active");$timeout(function(){$(triggerBtnName).trigger("click");scope.isBtnTriggered=false},0)}};$rootScope.$on(AppConstants.UPDATE_CLOSE_POPUP_EVENT,function(event){scope.isBtnTriggered=false});scope.switchViewInProducts=function(type){if(!scope.isBtnTriggered){if(type==scope.VIEW_TYPE_PERPETUAL){scope.records=scope.perpetualRecords;scope.viewType=scope.VIEW_TYPE_PERPETUAL;if(!scope.perpetualRecords){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#perpetualProductsListBtn")}else{if(type==scope.VIEW_TYPE_ENTERPRISE){scope.records=scope.enterpriseRecords;scope.viewType=scope.VIEW_TYPE_ENTERPRISE;if(!scope.enterpriseRecords){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#enterpriseProductsListBtn")}}}};scope.refreshPerpetualList=function(){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshEnterpriseList=function(){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)};$rootScope.$on(AppConstants.UPDATE_CS_PRODUCT_VIEW_CONTEXT_EVENT,function(event,viewType){scope.viewType=viewType;if(scope.viewType==AppConstants.PRODUCT_TYPE_IBASE){scope.viewType=scope.VIEW_TYPE_PERPETUAL}else{if(scope.viewType==AppConstants.PRODUCT_TYPE_ENT){scope.viewType=scope.VIEW_TYPE_ENTERPRISE}}scope.switchViewInProducts(scope.viewType)})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCsCasesListSubscriptions",["Utils","$rootScope","$location","$routeParams","AppConstants","AppUtils","$timeout","SubscriptionService","TsCaseService","TeamConstants",function(Utils,$rootScope,$location,$routeParams,AppConstants,AppUtils,$timeout,SubscriptionService,TsCaseService,TeamConstants){return{restrict:"EA",scope:{records:"=",trialRecords:"=",trialLoading:"=",teamRecords:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&",loading:"=",teamLoading:"=",jilTeamLoading:"=",jilTeamRecords:"=",subTab:"=",customer:"=",casetype:"=",contactid:"=",tempid:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/cs-cases-list-subscriptions.html",link:function(scope,element,attrs){scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;scope.isBtnClicked=false;var defaultCustomer=function(){return jQuery.extend({},{firstName:"",lastName:"",outputLanguage:""})};var defaultProductDto=function(){return jQuery.extend({},{allowedOnlyWithCcmt:false,cceDesc:null,classification:null,commitTerm:null,componentId:null,config:null,description:null,educational:false,excludeFromHendrix:false,isSelected:null,language:null,marketSegment:null,mediaType:"",metaConfig:"",metaLanguage:"",metaName:"",metaPlatform:"",metaType:"",name:"",offeringCode:"",ownerId:"",platform:"",price:null,prodType:"",productCode:"",promoSku:false,puf:false,recordNumber:"",regInd:"",regType:"",registrationDate:"",searchableContent:"",serialNumber:"",sku:"",status:"",stock:false,teamId:null,teamName:null,teamRole:null,uniqueId:null,version:null})};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.formatDate=function(date){return new Date(date)};scope.showProductDetail=function(productData){scope.$parent.selectedProductData=productData;$rootScope.$broadcast("showProductDetailEvent",productData)};scope.toggleClassNameForSubscription=function($event,indexId){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseSubscriptionItems"+indexId).hasClass("collapse in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseSubscriptionItems"+indexId).removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_TEAM){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseTeamProductItems"+indexId).removeClass().addClass(accordionClassName)}}};scope.toggleExpandCollapseAll=function(){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var buttonClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionSubscriptionsView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionSubscriptionsView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){var buttonClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#jil-team-subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-chevron-right":"glyphicon glyphicon-chevron-down";$("#accordionJilTeamProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionJilTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{var buttonClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#team-subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionTeamProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}}};scope.isFetchingProductDetailsFromRecord=false;scope.fetchProductSkuDataFromSubscriptionId=function(rec){SubscriptionService.getSubscriptionDetails({subscriptionId:rec.id,subscriptionAccountId:rec.customerGuid,locale:""}).success(function(result){if(result.sellableItemSku){scope.productSku=result.sellableItemSku;scope.storeId="";scope.fetchProductDetailsFromProductSkuAndTemplate(scope.productSku,scope.storeId,rec)}}).error(function(error){console.log("fetchProductSkuDataFromSubscriptionId ::"+error)})};scope.selectTemplateDependingOnCaseType=function(){if(!scope.tempid){if(scope.casetype=="csCase"){scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE}else{scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE}}};scope.fetchProductDetailsFromProductSkuAndTemplate=function(productSku,storeId,rec){scope.defaultCaseTemplateSearchDto={};scope.selectTemplateDependingOnCaseType();scope.defaultCaseTemplateSearchDto.templateId=scope.tempid;scope.defaultCaseTemplateSearchDto.productSku=productSku;scope.defaultCaseTemplateSearchDto.storeId=storeId;scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();scope.defaultCaseTemplateSearchDto.customerDto.customerNo=scope.customer.customerNo;scope.defaultCaseTemplateSearchDto.customerDto.firstName=scope.customer.firstName;scope.defaultCaseTemplateSearchDto.customerDto.lastName=scope.customer.lastName;scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=scope.customer.outputLanguage;scope.defaultCaseTemplateSearchDto.customerDto.address=scope.customer.address;scope.defaultCaseTemplateSearchDto.contactId=scope.contactid;TsCaseService.getCSCaseFromTemplate(scope.defaultCaseTemplateSearchDto).success(function(result){result.viewType=scope.viewType;result.product.product.sku=productSku;if(rec&&rec.contract&&rec.contract.termStartDate){result.product.product.registrationDate=rec.contract.termStartDate}if(rec&&rec.registrationDate){result.product.product.registrationDate=rec.registrationDate}scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,result);scope.isFetchingProductDetailsFromRecord=false}).error(function(error){console.log("TsCaseService.getCSCaseFromTemplate: "+error)})};scope.selectExistingProductHandler=function(rec){if(rec){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductSkuDataFromSubscriptionId(rec)}else{if(scope.viewType==scope.VIEW_TYPE_TEAM){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductDetailsFromProductSkuAndTemplate(rec.sku,"")}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductDetailsFromProductSkuAndTemplate(rec.sku,"")}else{if(scope.viewType==scope.VIEW_TYPE_TRIAL){var prodDto=new defaultProductDto();prodDto.name=rec.sap_code;prodDto.metaName=rec.product_name;prodDto.metaType=rec.app_leid;prodDto.metaConfig=rec.app_leid;prodDto.viewType=scope.viewType;scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,prodDto)}}}}}};scope.triggerBtnName="";scope.isBtnTriggered=false;scope.triggerClickInBtnGrp=function(triggerBtnName){if(triggerBtnName&&!angular.element(triggerBtnName).hasClass("active")){scope.isBtnTriggered=true;$("#individualSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");$timeout(function(){$(triggerBtnName).trigger("click");scope.isBtnTriggered=false},0)}};$rootScope.$on(AppConstants.UPDATE_CLOSE_POPUP_EVENT,function(event){scope.isBtnTriggered=false});scope.switchViewInSubscriptions=function(type){if(!scope.isBtnTriggered){if(type==scope.VIEW_TYPE_INDIVIDUAL){scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;if(!scope.records){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#individualSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_TEAM){scope.viewType=scope.VIEW_TYPE_TEAM;if(!scope.teamRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#teamSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_JIL_TEAM){scope.viewType=scope.VIEW_TYPE_JIL_TEAM;if(!scope.jilTeamRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#jilTeamSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_TRIAL){scope.viewType=scope.VIEW_TYPE_TRIAL;if(!scope.trialRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#trialSubscriptionListBtn")}}}}}};scope.refreshIndividualsList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshTeamsList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshTrialList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};$rootScope.$on(AppConstants.UPDATE_CS_SUBSCRIPTION_VIEW_CONTEXT_EVENT,function(event,viewType){scope.viewType=viewType;scope.switchViewInSubscriptions(scope.viewType)});scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCsSelectExistingProducts",["$rootScope","ProductRecordService","CustomerSubscriptionService","webGuidFilterFilter","AppConstants","Utils","CustomerConstants","$timeout","SubscriptionConstants","OnlineFlexibleTrialProductService","CustomerPreviewService","CustomerUtil","AppUtils",function($rootScope,ProductRecordService,CustomerSubscriptionService,webGuidFilterFilter,AppConstants,Utils,CustomerConstants,$timeout,SubscriptionConstants,OnlineFlexibleTrialProductService,CustomerPreviewService,CustomerUtil,AppUtils){return{restrict:"EA",scope:{customer:"=",caseedit:"=",contactid:"=",imscustomer:"=",casetype:"=",tempid:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/cs-select-existing-products.html",link:function(scope,element,attrs){scope.showTransactionHistoryBtn=false;scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_IBASE;scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;scope.VIEW_TYPE_PERPETUAL="PERPETUAL";scope.VIEW_TYPE_ENTERPRISE="ENTERPRISE";scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.PRODUCT_TAB="PRODUCT_TAB";scope.SUBSCRIPTION_TAB="SUBSCRIPTION_TAB";scope.DEFAULT_CASE_TYPE="csCase";scope.isTeamOrIndividual=false;scope.$watch("isTeamOrIndividual",function(newValue,oldValue){if(!newValue){return}if(newValue==true){$timeout(function(){$("#csSubProducts a").tab("show")},0)}});scope.$watch("contactid",function(newValue,oldValue){if(!newValue){return}scope.contactId=newValue});$rootScope.$on("LOAD_EXISTING_PRODUCT_DETAIL",function(event,caseViewType){if(caseViewType==scope.DEFAULT_CASE_TYPE){scope.showExistingProductsModal()}});scope.isPopUpInitailized=false;scope.showExistingProductsModal=function(){if(scope.isPopUpInitailized){return}element.find("#existingCsCaseProductListModal").modal("show");scope.rescale();$(window).bind("resize",scope.rescale);scope.isPopUpInitailized=true;scope.loadContextualData()};scope.isCustomerEnterprise=false;scope.loadContextualData=function(){if(scope.customer.enterpriseId==true){scope.PRODUCT_VIEW_TYPE=scope.VIEW_TYPE_ENTERPRISE;scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;scope.isCustomerEnterprise=true}else{scope.PRODUCT_VIEW_TYPE=scope.VIEW_TYPE_PERPETUAL;scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE}if(Utils.getCustomerTypeFromImsDetail($rootScope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_JIL_TEAM;if(!scope.isCustomerEnterprise){scope.fetchSelectedTabInformation(scope.SUBSCRIPTION_TAB);scope.isTeamOrIndividual=true}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}else{if(Utils.getCustomerTypeFromImsDetail($rootScope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;if(!scope.isCustomerEnterprise){scope.fetchSelectedTabInformation(scope.SUBSCRIPTION_TAB);scope.isTeamOrIndividual=true}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}};scope.closeExistingProductsModal=function(){scope.interactionHistory=[];$("body").css("overflow","auto");scope.$emit(AppConstants.UPDATE_CLOSE_POPUP_EVENT);scope.isTeamOrIndividual=false;scope.isPopUpInitailized=false;element.find("#existingCsCaseProductListModal").modal("hide")};scope.rescale=function rescale(){$("#existingCsCaseProductListModal .modal-body").css({"max-height":"none","overflow-x":"hidden"})};scope.$on(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,function(event,rec){scope.closeExistingProductsModal()});scope.$on(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,function(event,viewType,isInitialLoading){if(viewType==scope.VIEW_TYPE_PERPETUAL){scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_IBASE;scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;scope.loadProducts()}else{if(viewType==scope.VIEW_TYPE_ENTERPRISE){scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_ENT;scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;scope.loadProducts()}}});scope.$on(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,function(event,viewType){if(viewType==scope.VIEW_TYPE_INDIVIDUAL){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;scope.loadSubscriptions()}else{if(viewType==scope.VIEW_TYPE_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_TEAM;scope.loadTeamProducts()}else{if(viewType==scope.VIEW_TYPE_JIL_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_JIL_TEAM;scope.loadJilTeamSubscriptions()}else{if(viewType==scope.VIEW_TYPE_TRIAL){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_TRIAL;scope.loadTrialProduct()}}}}});scope.loadSubscriptions=function(){scope.isSubscriptionLoading=true;scope.subscriptionlists=[];scope.guid=webGuidFilterFilter(scope.customer);console.log("Query CustomerSubscriptionService.getSubscriptions",scope.guid);if(!scope.isSubscriptionsListCalled){scope.isSubscriptionsListCalled=true;scope.subscriptionAccountId=scope.guid+"@AdobeID";scope.locale=scope.customer.outputLanguage+"_"+scope.customer.address.country.code;CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:scope.subscriptionAccountId,locale:scope.locale}).success(function(result){console.log("Success CustomerSubscriptionService.getSubscriptions");scope.subscriptionlists=result;scope.isSubscriptionsListCalled=false;for(var i=0;i<scope.subscriptionlists.length;i++){scope.subscriptionlists[i].purchaseDate=scope.subscriptionlists[i].contract.termStartDate;scope.subscriptionlists[i].productName=scope.subscriptionlists[i].localizedLongProductDescriptor;scope.subscriptionlists[i].customerGuid=scope.guid;if(scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE_STUDENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_DIGITAL_RIVER_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_APPLE_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_GOOGLE_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_AMAZON_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED_PAYMENT){scope.subscriptionlists[i].storeOrderNumber=scope.subscriptionlists[i].contract.id}}scope.isSubscriptionLoading=false}).error(function(error){console.log("error",error);$("#subscriptions").html(error);scope.isSubscriptionLoading=false;scope.isSubscriptionsListCalled=false})}};scope.isFillForCCEWithImsCalled=false;scope.loadTeamProducts=function(){console.log("Query ProductRecordService.fill",scope.customer.customerNo);scope.isTeamSubscriptionLoading=true;if(scope.customer&&scope.customer.bpType=="2"){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}if(!scope.isFillForCCEWithImsCalled){scope.isFillForCCEWithImsCalled=true;ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:"CCT",janusOrgId:scope.orgguid,isIndirect:true}).success(function(result){scope.isTeamSubscriptionLoading=false;scope.teamProductsCrm=result;scope.isFillForCCEWithImsCalled=false}).error(function(error){scope.isTeamSubscriptionLoading=false;scope.isFillForCCEWithImsCalled=false;$("#subscriptions").html(error)})}}else{if(!scope.isFillFromCrmCalled){scope.isFillFromCrmCalled=true;ProductRecordService.fillFromCrm({customerNo:scope.customer.customerNo,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:"true"}).success(function(result){scope.isTeamSubscriptionLoading=false;scope.teamProductsCrm=result;scope.isFillFromCrmCalled=false}).error(function(error){scope.isTeamSubscriptionLoading=false;scope.isFillFromCrmCalled=false;$("#subscriptions").html(error)})}}};scope.loadJilTeamSubscriptions=function(){scope.jilTeamLoading=true;scope.jilTeamRecords=[];scope.customerGuid=webGuidFilterFilter(scope.customer);scope.locale=scope.customer.outputLanguage+"_"+scope.customer.address.country.code;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){scope.jilTeamAdminRecords=CustomerUtil.getTeamSubscriptionList(result,scope.customerGuid);var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config);CustomerSubscriptionService.getTeamSubscriptionListByDelegate({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config);scope.delegateCount=result.length;scope.delegateSearchCount=1;if(result&&result.length>=1){angular.forEach(result,function(team){CustomerSubscriptionService.getTeamSubscriptionDetails({customerGuid:scope.customerGuid,teamId:team.teamId,locale:scope.locale}).success(function(resultDetails,status,headers,config){var delegateDetails=[];if(scope.delegateCount==scope.delegateSearchCount){scope.jilTeamLoading=false}else{scope.delegateSearchCount++}delegateDetails.push(resultDetails);if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}scope.jilTeamDelegateRecords=CustomerUtil.getTeamSubscriptionList(delegateDetails,scope.customerGuid);if(scope.jilTeamAdminRecords.length&&scope.jilTeamAdminRecords[0].teamId!=scope.jilTeamDelegateRecords[0].teamId){scope.jilTeamRecords.push(scope.jilTeamDelegateRecords)}else{if(!scope.jilTeamAdminRecords.length&&scope.jilTeamDelegateRecords.length){scope.jilTeamRecords.push(scope.jilTeamDelegateRecords)}}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,resultDetails);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(resultDetails,status,headers,config){scope.totalRecords="";scope.jilTeamLoading=false;var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,resultDetails);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})})}else{scope.jilTeamLoading=false;if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}else{scope.totalRecords=""}}}).error(function(result,status,headers,config){if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}else{scope.totalRecords=""}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(result,status,headers,config){scope.jilTeamLoading=false;scope.totalRecords="";if(status==504){scope.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. Please check the subscription after 5 minutes before attempting to reprocess.")}else{scope.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load team subscription details")}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config)})};scope.loadTrialProduct=function(){scope.isTrialProductLoading=true;OnlineFlexibleTrialProductService.getTrialDeviceDetails({customerGuid:webGuidFilterFilter(scope.customer)+"@AdobeID",filterType:""}).success(function(result){scope.trialProductList=result;scope.isTrialProductLoading=false;if(!angular.isArray(scope.trialProductList[0].machines)){var machineArray=[];machineArray.push(scope.trialProductList[0].machines);scope.trialProductList[0].machines=machineArray}if(angular.isArray(scope.trialProductList[0].machines)){var applicationArray=[];angular.forEach(scope.trialProductList[0].machines,function(machine){applicationArray=[];if(!angular.isArray(machine.applications)){applicationArray.push(machine.applications);machine.applications=applicationArray}})}var allApplication=[];angular.forEach(scope.trialProductList[0].machines,function(machine){angular.forEach(machine.applications,function(app){app.machine_id=machine.machine_id;allApplication.push(app)})});scope.trialProductList[0]["newmachines"]=angular.copy(allApplication)}).error(function(error){scope.isTrialProductLoading=false;$("#subscriptions").html(error)})};scope.showTab=function(tabName){if(tabName=="PRODUCT"){$timeout(function(){$("#csCrmProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_CS_PRODUCT_VIEW_CONTEXT_EVENT,scope.PRODUCT_VIEW_TYPE);if((scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE&&!scope.perpetualProducts)||(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT&&!scope.enterpriseProducts)){scope.loadProducts()}}else{if(tabName=="SUBSCRIPTIONS"){$timeout(function(){$("#csSubProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_CS_SUBSCRIPTION_VIEW_CONTEXT_EVENT,scope.SUBSCRIPTION_VIEW_TYPE);if(!scope.jilTeamRecords){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_JIL_TEAM;scope.loadJilTeamSubscriptions()}}}};scope.fetchSelectedTabInformation=function(selectedTab){if(selectedTab==scope.PRODUCT_TAB){$timeout(function(){$("#csCrmProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_CS_PRODUCT_VIEW_CONTEXT_EVENT,scope.PRODUCT_VIEW_TYPE);if((scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE&&!scope.perpetualProducts)||(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT&&!scope.enterpriseProducts)){scope.loadProducts()}}else{if(selectedTab==scope.SUBSCRIPTION_TAB){$timeout(function(){$("#csSubProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_CS_SUBSCRIPTION_VIEW_CONTEXT_EVENT,scope.SUBSCRIPTION_VIEW_TYPE);if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_INDIVIDUAL&&!scope.subscriptionlists){scope.loadSubscriptions()}else{if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_TEAM&&!scope.teamProductsCrm){scope.loadTeamProducts()}else{if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_JIL_TEAM&&!scope.jilTeamRecords){scope.loadJilTeamSubscriptions()}}}}}};scope.imsCustomer=null;scope.loadProducts=function(){scope.isLoadingProductsCrm=true;if(scope.customer&&scope.customer.bpType=="2"){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}if(!scope.isOrgProductsServiceCalled){scope.isOrgProductsServiceCalled=true;scope.processENTProduct()}}else{if(!scope.isProductServiceCalled){scope.isProductServiceCalled=true;var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillFromCrm({customerNo:scope.customer.customerNo,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("success ProductRecordService.fill");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isProductServiceCalled=false}).error(function(error){console.log("error",error);scope.isLoadingProductsCrm=false;scope.isProductServiceCalled=false;$("#products").html(error)})}}};scope.processENTProduct=function(){if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.loadPerpetualData()}else{if(angular.isDefined(scope.orgguid)&&scope.orgguid.length>0){scope.loadENTData()}else{scope.orgguidFound=false;CustomerPreviewService.getCustomerRelatedOrgWithoutLocking({customerNo:scope.contactid,customerType:"ENT",viewMode:""}).success(function(result){if(angular.isDefined(result)&&angular.isArray(result.customerRelations)&&result.customerRelations.length>0){for(var i=0;i<result.customerRelations.length;i++){if(result.customerRelations[i].partner1==scope.customer.customerNo){scope.orgguid=result.customerRelations[i].orgguid;if(angular.isDefined(scope.orgguid)&&scope.orgguid&&scope.orgguid.length>0){scope.orgguidFound=true;scope.loadENTData()}else{scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}break}}if(!scope.orgguidFound){scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}}else{scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}}).error(function(error){})}}};scope.loadENTData=function(){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,janusOrgId:scope.orgguid,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isOrgProductsServiceCalled=false}).error(function(error){console.log("error",error);scope.isLoadingProductsCrm=false;scope.isOrgProductsServiceCalled=false;$("#products").html(error)})};scope.loadPerpetualData=function(){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isOrgProductsServiceCalled=false}).error(function(error){console.log("error",error);scope.isLoadingProductsCrm=false;scope.isOrgProductsServiceCalled=false;$("#products").html(error)})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("CustomerConstants",{LOAD_RELATED_ORG_IND:"RELATED_ORG_IND",LOAD_RELATED_ORG_ENT:"RELATED_ORG_ENT",LOAD_RELATED_ORG_TEAM:"RELATED_ORG_TEAM",LOAD_RELATED_ORG_ALL:"RELATED_ORG_ALL",CUSTOMER_CONTEXT_ALL:"ALL",CUSTOMER_CONTEXT_TEAM:"CCM",CUSTOMER_CONTEXT_IND:"CRM",CUSTOMER_CONTEXT_ENT:"ENT",LOAD_ORG_DETAIL_WITHOUT_REL:"C",LOAD_ORG_DETAIL_WITH_REL:"F",GST_NZ_CODE:"NZ0",NEWZEALAND_COUNTRY_CODE:"NZ",AUSTRALIA_COUNTRY_CODE:"AU",CAH_PAYMENT_FAILURE:"PAYMENT FAILURE",CAH_PAYMENT_PENDING:"PENDING PAYMENT",CAH_CC_LABEL:"Credit Card",CAH_TEAM_FLOW:"TEAM",CAH_IND_FLOW:"IND",CAH_CUST_FLOW:"CUST",CAH_TEAM_JIL:"TEAM_JIL"});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("CustomerCtrl",["$scope","$rootScope","$routeParams","$filter","$timeout","$location","CustomerRecordService","ImsCustomerService","CaseRecordService","CustomerTransactionService","StockServices","AppConstants","OnlineFlexibleTrialProductService","TeamProductService","ProductRecordService","ContractService","AppUtils","Utils","MetadataService","TrackingService","webGuidFilterFilter","TransactionUtil","CustomerSubscriptionService","CustomerConstants","CustomerPreviewService","SubscriptionConstants","CustomerUtil","CAHService","$q","TeamUtil","CrmProductPreviewDto","CrmUtil",function($scope,$rootScope,$routeParams,$filter,$timeout,$location,CustomerRecordService,ImsCustomerService,CaseRecordService,CustomerTransactionService,StockServices,AppConstants,OnlineFlexibleTrialProductService,TeamProductService,ProductRecordService,ContractService,AppUtils,Utils,MetadataService,TrackingService,webGuidFilterFilter,TransactionUtil,CustomerSubscriptionService,CustomerConstants,CustomerPreviewService,SubscriptionConstants,CustomerUtil,CAHService,$q,TeamUtil,CrmProductPreviewDto,CrmUtil){TrackingService.trackPageView("Customer Record","Customer RecordView");$scope.headeredit=true;$scope.unidentifyshow=true;$scope.CUSTOMER_HOME_VIEW="customer_home_view";$scope.TEAM="team";$scope.JILTEAM="jilteam";$scope.TRIAL="trial";$scope.INDIVIDUAL="individual";$scope.PERPETUAL="perpetual";$scope.ENTERPRISE="enterprise";$scope.COMMUNICATION="communication";$scope.ALL="all";$scope.PRODUCT_DETAILS_VIEW="product_details_view";$scope.customerCurrentState=$scope.CUSTOMER_HOME_VIEW;$scope.CUSTOMER_INFO_NON_JP="customerInfoNonJp";$scope.CUSTOMER_INFO_JP="customerInfoJp";$scope.ORGANIZATION_INFO_NON_JP="organizationInfoNonJp";$scope.ORGANIZATION_INFO_JP="organizationInfoJp";$scope.SUBSCRIPTON_DETAILS_VIEW="subscription_details_view";$scope.newUI=$routeParams.newui=="true"?true:false;$scope.isRelationshipLoading=false;$scope.isLoading=true;$scope.customerNo=$routeParams.customerNo;$scope.contactId=$routeParams.relCustomerNo;$scope.currentTab=$routeParams.tabView;$scope.subTab=$routeParams.subTabView;$scope.orgguid=$routeParams.orgGuid;if(angular.isDefined($routeParams.orgTyp)&&$routeParams.orgTyp=="ENT"){$scope.subTab=$scope.ENTERPRISE}$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$scope.teamProductsCrm=null;$scope.trialProductList=null;$scope.isTrialProductLoading=false;$scope.subscriptionlists=null;$scope.productContext="";$scope.isTeamProductsFetching=false;$scope.refreshButtonClick=false;$scope.subscriptionLoaded=false;$scope.loyality;if(!$scope.currentTab){$location.skipReload().path($location.path()+"/memos").replace()}else{var currentTabReference="#customerDocTabs a[data-target='#"+$scope.currentTab+"']";$(currentTabReference).tab("show")}$scope.nCustomerNo=Number($routeParams.customerNo);$scope.nContactId=Number($routeParams.relCustomerNo);$scope.tabs=[];$scope.customerLink=Utils.customerLink;$scope.dbStatus=MetadataService.DB_STATUS.NEW;$scope.metadata=new Object();var timer;$scope.isCustomerViewValid=true;$scope.webGUID="";$scope.isCustomerLocked=false;Utils.pageTitle("Customer");$scope.validateCustomerLock=function(messages){$scope.isCustomerLocked=false;if(messages&&messages.length>0){angular.forEach(messages,function(msg){if(msg.number=="38"){$scope.isCustomerLocked=true}})}};$scope.getCustomerNo=function(){if(typeof $routeParams.relCustomerNo=="undefined"){return $scope.customerNo}else{return $scope.contactId}};$scope.showMessage=function(type,message){$scope.customer=new Object();$scope.customer.messages=[];$scope.customer.messages.push({info:type=="info",error:type=="error",warning:type=="warning",text:message})};$scope.showErrorMessage=function(message){$scope.showMessage("error",message);$scope.isLoading=false;$scope.isCustomerViewValid=false};$scope.startCustomerProcessing=function(){$scope.customerNo=Utils.getCorrectIdforCRM($scope.customerNo);$scope.contactId=Utils.getCorrectIdforCRM($scope.contactId);MetadataService.initializeCustomerMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus});if($rootScope.lastCustomer&&$rootScope.lastCustomer.customerNo==$scope.customerNo&&!$scope.contactId){$scope.customer=$rootScope.lastCustomer;$scope.isLoading=false;$scope.validateCustomerLock($scope.customer.messages);var contactFound=false;if($scope.customer.bpType=="2"){if($scope.contactId==""||isNaN($scope.contactId)){$scope.showErrorMessage("The Contact ID Is Not Valid");return}else{angular.forEach($scope.customer.contacts,function(contactItem){var partnerNo=Number(contactItem.partnerNo);if(partnerNo==$scope.contactId){contactFound=true}})}if(!contactFound){$scope.showErrorMessage("The Contact ID is not linked with the organization");return}else{$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.contactId)}}timer=setInterval(function(){$scope.processCustomerDetails()},500)}else{console.log("start CustomerRecordService.getItem",$routeParams.customerNo);var customerRequestObject=new Object();customerRequestObject.customerNo=$scope.customerNo;if(angular.isDefined($scope.contactId)&&$scope.contactId!=""){customerRequestObject.relCustomerNo=$scope.contactId}customerRequestObject.relViewMode=CustomerConstants.LOAD_ORG_DETAIL_WITHOUT_REL;CustomerRecordService.getItem(customerRequestObject).success(function(result){console.log("success CustomerRecordService.getItem");$scope.isLoading=false;$scope.customer=result;$scope.validateCustomerLock($scope.customer.messages);$rootScope.lastCustomer=result;$scope.customerGUID=webGuidFilterFilter($scope.customer);if($scope.customer.bpType!=="2"&&$scope.customer.email===""&&($scope.customerGuid===""||angular.isUndefined($scope.customerGuid))){$scope.customer.messages.push({warning:true,text:"Customer AdobeId, Person Guid missing : Please do not create new transactions using this customer."})}if(angular.isDefined($scope.customer.customerRelations)){var oldPartnerData=_.find($scope.customer.customerRelations,{relationshipType:"ZREPBP"});if(angular.isDefined(oldPartnerData)&&oldPartnerData.partner2!==$scope.customer.customerNo){$scope.customer.OldPartnerInfo=oldPartnerData;console.log("Customer Old Partner Info is",$scope.customer.OldPartnerInfo)}else{console.log("OLD partner no is same as customer no. Not displaying OLD partner")}}ImsCustomerService.getCustomerOrganizations({guid:$scope.customerGUID}).success(function(result){var isEnterPriseOrg=Utils.isEnterPriseOrgExist(result);if(isEnterPriseOrg){$scope.customer.isType1EnterpriseCustomer=true}}).error(function(error){});var contactFound=false;if(result){angular.forEach(result.messages,function(message){if(message.type=="E"&&message.number=="201"){$scope.isLoading=false;$scope.isCustomerViewValid=false;return}})}if($scope.customer.bpType=="2"){if($scope.contactId==""||isNaN($scope.nContactId)){$scope.showErrorMessage("The Contact ID Is Not Valid");return}$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.contactId);$scope.customer.customerRelations=null}timer=setInterval(function(){$scope.processCustomerDetails()},500)}).error(function(result){console.log("error",result);$scope.isLoading=false})}};if(isNaN($scope.nCustomerNo)||$scope.nCustomerNo==0){$scope.showErrorMessage("The Customer Number Is Not Valid")}else{$scope.customer=new Object();$scope.customer.messages=[];$scope.startCustomerProcessing()}$scope.isCountryJP=false;$scope.validInfoView="";$scope.getCustomerInfoView=function(customer){$scope.$apply(function(){if(customer.bpType=="1"&&!$scope.isCountryJP){$scope.validInfoView=$scope.CUSTOMER_INFO_NON_JP}else{if(customer.bpType=="1"&&$scope.isCountryJP){$scope.validInfoView=$scope.CUSTOMER_INFO_JP}else{if(customer.bpType=="2"&&!$scope.isCountryJP){$scope.validInfoView=$scope.ORGANIZATION_INFO_NON_JP}else{if(customer.bpType=="2"&&$scope.isCountryJP){$scope.validInfoView=$scope.ORGANIZATION_INFO_JP}}}}})};$scope.loadAllRelationships=function(){console.log("start CustomerRecordService.getItem",$routeParams.customerNo);$scope.isRelationshipLoading=true;var customerRequestObject=new Object();customerRequestObject.customerNo=$scope.customerNo;if(angular.isDefined($scope.contactId)&&$scope.contactId!=""){customerRequestObject.relCustomerNo=$scope.contactId}customerRequestObject.relViewMode=CustomerConstants.LOAD_ORG_DETAIL_WITH_REL;CustomerRecordService.getItem(customerRequestObject).success(function(result){$scope.customer.customerRelations=result.customerRelations;var customerRelationship=$scope.customer.customerRelations;angular.forEach(customerRelationship,function(relationshipItem){angular.forEach($scope.metadata[MetadataService.STORE_NAMES.RELATIONSHIP_TYPES],function(item){if(item.code==relationshipItem.relationshipType){relationshipItem.relationshipTypeName=item.description}});angular.forEach($scope.metadata[MetadataService.STORE_NAMES.CONTACT_TYPES],function(item){if(item.department==relationshipItem.contactType){relationshipItem.contactTypeName=item.description}})});$scope.customer.contacts=result.contacts;$scope.isRelationshipLoading=false;$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.contactId)}).error(function(result){console.log("error",result);$scope.isLoading=false;$scope.isRelationshipLoading=false})};$scope.processCustomerDetails=function(){$scope.isCountryJP=($scope.customer.address.country.code=="JP")?true:false;$scope.imsCustomer=$rootScope.imsCustomer=null;$scope.getCustomerInfoView($scope.customer);if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){console.log("Metadata Initialized Successfully");clearInterval(timer);$scope.loadContactDetailBeforeIms();$scope.initCurrentTab();if($rootScope.returnUrl){$rootScope.returnUrl=null}}};$scope.initCurrentTab=function(){if($scope.currentTab){switch($scope.currentTab){case"memos":loadTab("memos");break;case"cases":loadTab("cases");break;case"transactions":loadTab("transactions");break;case"products":loadTab("products",$scope.subTab);break;case"subscriptions":loadTab("subscriptions",$scope.subTab);break;case"contracts":loadTab("contracts");break;case"services":loadTab("services");break;case"stock":loadTab("stock");break;case"communication":loadTab("communication");break}}};var hideEmptyRows=function(){$timeout(function(){$("#customerInfo td:nth-child(2)").each(function(index,item){if($(this).text().trim()!=""){$(this).parent().show()}else{if($(this).text().trim()==""){$(this).parent().hide()}}});$("#customerInfoOrg td:nth-child(2)").each(function(index,item){if($(this).text().trim()!=""){$(this).parent().show()}else{$(this).parent().hide()}})})};$scope.triggerBtnName="";$scope.triggerClickInBtnGrp=function(triggerBtnName){if(triggerBtnName&&!angular.element(triggerBtnName).hasClass("active")){$timeout(function(){angular.element(triggerBtnName).trigger("click")},0)}};$scope.changeSubscriptionBtnSelection=function(imsCustomer){if($scope.subTab==$scope.JILTEAM||(!$scope.subTab&&$scope.selectedTab&&imsCustomer&&Utils.getCustomerTypeFromImsDetail(imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM)){$scope.subTab=$scope.JILTEAM;$location.skipReload().path(AppUtils.replaceCustomerPath($scope.subTab,$scope.JILTEAM)).replace();$scope.triggerBtnName="#jilTeamSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName);if(!$scope.jilTeamSubscriptionlists){if($scope.customer.bpType!="2"){$rootScope.$broadcast("LOAD_TEAM_SUBSCRIPTION_LIST",imsCustomer)}}}else{if($scope.subTab==$scope.INDIVIDUAL||(!$scope.subTab&&$scope.selectedTab&&imsCustomer&&Utils.getCustomerTypeFromImsDetail(imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){$scope.subTab=$scope.INDIVIDUAL;$location.skipReload().path(AppUtils.replaceCustomerPath($scope.subTab,$scope.INDIVIDUAL)).replace();$scope.triggerBtnName="#individualSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName);if(!$scope.subscriptionlists){if($scope.customer.bpType!="2"){$rootScope.$broadcast("LOAD_INDIVIDUAL_SUBSCRIPTION_LIST",$scope.imsCustomer)}}}else{if($scope.subTab==$scope.TRIAL||(!$scope.subTab&&$scope.selectedTab&&imsCustomer&&Utils.getCustomerTypeFromImsDetail(imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){$scope.subTab=$scope.TRIAL;$location.skipReload().path(AppUtils.replaceCustomerPath($scope.subTab,$scope.TRIAL)).replace();$scope.triggerBtnName="#trialSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName);if(!$scope.trialProductList){$scope.loadTrialProduct()}}}}};$scope.$watch("imsCustomer",function(newValue){if(angular.isDefined(newValue)){$scope.changeSubscriptionBtnSelection(newValue)}});$scope.isSubscriptionServiceCalled=false;$scope.loadTeamContract=function(){$timeout(function(){$scope.customerGuid=webGuidFilterFilter($scope.customer);$scope.locale=$scope.customer.defaultCountryLanguage+"_"+$scope.customer.address.country.code;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:$scope.locale}).success(function(result,status,headers,config){$scope.teamContractDetail=result;$scope.loadCAHContractDetails(result)}).error(function(result,status,headers,config){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Search Customer - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config)})},500)};$scope.$on("loadIndividualSubscriptionTab",function(event,result){loadTab("subscriptions",$scope.INDIVIDUAL)});$scope.loadCAHContractDetails=function(value){if(angular.isDefined(value)&&angular.isArray(value)&&value.length>0){CAHService.getCAHContractDetail(value[0].programContractId).success(function(result,status,headers,config){var data={cahdetail:result,contractdetail:value};$rootScope.$broadcast("initiateCAHContractDetail",data);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for Team";messageObject.Result="SUCCESS";messageObject.Function="CAH-Contract service";messageObject.contract=value[0].programContractId;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$rootScope.$broadcast("initiateCAHContractDetailFailed",error);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for Team";messageObject.Result="ERROR";messageObject.Function="CAH-Contract service";messageObject.contract=value[0].programContractId;AppUtils.sendLogToServer(messageObject,status,headers,config)})}else{$rootScope.$broadcast("stopCAHLoading","")}};$scope.loadCAHGUIDetails=function(){CAHService.getCAHGUIDDetail(webGuidFilterFilter($scope.customer)).success(function(result,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetail",result);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="SUCCESS";messageObject.Function="CAH-IND service";messageObject.Flow="Customer Detail";messageObject.guid=webGuidFilterFilter($scope.customer);AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetailFailed",error);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="ERROR";messageObject.Function="CAH-IND service";messageObject.Flow="Customer Detail";messageObject.guid=webGuidFilterFilter($scope.customer);AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=$scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};$scope.isFillForCCEWithImsCalled=false;$scope.isFillFromCrmCalled=false;$scope.loadTeamProducts=function(){console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isTeamSubscriptionLoading=true;if($scope.customer.bpType=="2"){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}if(!$scope.isFillForCCEWithImsCalled){$scope.isFillForCCEWithImsCalled=true;ProductRecordService.fillForCCEWithIms({customerNo:$scope.contactId,orgId:$scope.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:true}).success(function(result){$scope.isTeamSubscriptionLoading=false;$scope.teamProductsCrm=result;$scope.isFillForCCEWithImsCalled=false;$scope.loadTeamContract()}).error(function(error){$scope.isTeamSubscriptionLoading=false;$scope.isFillForCCEWithImsCalled=false;$("#subscriptions").html(error)})}}else{if(!$scope.isFillFromCrmCalled){$scope.isFillFromCrmCalled=true;ProductRecordService.fillFromCrm({customerNo:$scope.customerNo,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:"true"}).success(function(result){$scope.teamProductsCrm=result;$scope.isTeamSubscriptionLoading=false;$scope.isFillFromCrmCalled=false;$scope.loadTeamContract()}).error(function(error){$scope.isTeamSubscriptionLoading=false;$scope.isFillFromCrmCalled=false;$("#subscriptions").html(error)})}}};$scope.loadTrialProduct=function(){$scope.isTrialProductLoading=true;OnlineFlexibleTrialProductService.getTrialDeviceDetails({customerGuid:$scope.guid+"@AdobeID",filterType:""}).success(function(result){$scope.trialProductList=result;$scope.isTrialProductLoading=false;if(!angular.isArray($scope.trialProductList[0].machines)){var machineArray=[];machineArray.push($scope.trialProductList[0].machines);$scope.trialProductList[0].machines=machineArray}if(angular.isArray($scope.trialProductList[0].machines)){var applicationArray=[];angular.forEach($scope.trialProductList[0].machines,function(machine){applicationArray=[];if(!angular.isArray(machine.applications)){applicationArray.push(machine.applications);machine.applications=applicationArray}})}var allApplication=[];angular.forEach($scope.trialProductList[0].machines,function(machine){angular.forEach(machine.applications,function(app){app.machine_id=machine.machine_id;allApplication.push(app)})});$scope.trialProductList[0]["newmachines"]=angular.copy(allApplication)}).error(function(error){$scope.isTrialProductLoading=false;$("#subscriptions").html(error)})};$scope.isOrgfillForCCEWithImsCalled=false;var loadTab=function(selectedTab,subTab){$scope.subTab=subTab;$scope.selectedTab=selectedTab;$scope.triggerBtnName="";var currentTabReference="#customerDocTabs a[data-target='#"+selectedTab+"']";$(currentTabReference).tab("show");if($scope.subTab&&selectedTab=="products"){if($scope.subTab==$scope.ENTERPRISE||(!$scope.subTab&&$scope.customer&&($scope.customer.enterpriseId==true||$scope.customer.isType1EnterpriseCustomer))){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ENTERPRISE)).replace();$scope.triggerBtnName="#enterpriseProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.ALL){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ALL;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ALL)).replace();$scope.triggerBtnName="#allProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.PERPETUAL)).replace();$scope.triggerBtnName="#perpetualProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}}else{if(selectedTab=="subscriptions"){if(!$scope.refreshButtonClick){$scope.changeSubscriptionBtnSelection($scope.imsCustomer)}$scope.refreshButtonClick=true}}if($scope.tabs.indexOf(selectedTab)!=-1){return}$scope.tabs.push(selectedTab);switch(selectedTab){case"transactions":$scope.isTransactionLoading=true;$scope.loadTransactions=function(){$scope.isTransactionLoading=true;$scope.ordersViewType=0;console.log("Query CustomerTransactionService.fill",$scope.customerNo);CustomerTransactionService.fill({customerNo:$scope.customerNo,startIndex:0,numberOfRows:-1}).success(function(result){console.log("success CustomerTransactionService.fill");$scope.transactions=[];var transactionsResult=result;for(var count=0;count<transactionsResult.length;count++){for(var orderTypeCount=0;orderTypeCount<$scope.metadata[MetadataService.STORE_NAMES.ORDER_TYPES].length;orderTypeCount++){if(transactionsResult[count].transactionType==$scope.metadata[MetadataService.STORE_NAMES.ORDER_TYPES][orderTypeCount].proct){transactionsResult[count].transactionTypeName=$scope.metadata[MetadataService.STORE_NAMES.ORDER_TYPES][orderTypeCount].type;break}}if(!transactionsResult[count].transactionTypeName){transactionsResult[count].transactionTypeName=TransactionUtil.getTransactionTypeName(transactionsResult[count].transactionType)}transactionsResult[count].statusLabelName=TransactionUtil.getStatusLabel(transactionsResult[count].statusLabel)}$scope.transactions=transactionsResult;$scope.isTransactionLoading=false}).error(function(error){console.log("error",error);$("#transactions").html(error);$scope.isTransactionLoading=false})};$scope.loadDylanOrders=function(){$scope.ordersViewType=1;$rootScope.$broadcast("LOAD_COMMERCE_TRANSACTION_LIST",$scope.imsCustomer)};$scope.loadNotProcessedDylanOrders=function(){console.log("Query CustomerTransactionService.getAllStoreOrders");$scope.ordersViewType=2;$scope.isTransactionLoading=true;CustomerTransactionService.getAllCommerceOrders({customerGuid:$scope.customerGUID}).success(function(result){console.log("suceess CustomerTransactionService.getAllStoreOrders");$scope.storeOrderList=[];angular.forEach(result.order,function(order){if(order.status=="UNAUTHORIZED"||order.status=="CANCELLED"){$scope.storeOrderList.push(order)}});$scope.isTransactionLoading=false}).error(function(error){console.log("error",error);$scope.storeOrderList=[];$scope.isTransactionLoading=false})};$scope.loadTransactions();break;case"cases":$scope.loadCases=function(){console.log("Query CaseRecordService.fill",$scope.customerNo);$scope.isLoadingCases=true;CaseRecordService.fill({customerNo:$scope.customerNo,startIndex:0,numberOfRows:-1}).success(function(result){console.log("success CaseRecordService.fill");$scope.isLoadingCases=false;$scope.cases=result}).error(function(error){console.log("error",error);$scope.isLoadingCases=false;$("#cases").html(error)})};$scope.loadCases();break;case"products1":console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isLoadingProducts=true;var customerGuid=webGuidFilterFilter($scope.customer);ProductRecordService.fill({customerGuid:customerGuid}).success(function(result){console.log("success ProductRecordService.fill");$scope.isLoadingProducts=false;$scope.products=result}).error(function(error){console.log("error",error);$scope.isLoadingProducts=false;$("#products").html(error)});break;case"products":$scope.loadProducts=function(){console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isLoadingProductsCrm=true;if($scope.customer.bpType=="2"){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}if(!$scope.isOrgfillForCCEWithImsCalled){$scope.isOrgfillForCCEWithImsCalled=true;$scope.processENTProduct()}}else{var crmProductPreviewDto=angular.copy(CrmProductPreviewDto);crmProductPreviewDto.REQUEST.IT_PARTNER.PARTNER.CONTACT=$scope.customerNo;crmProductPreviewDto.REQUEST.IV_PROD_TYPE=$scope.refreshProductType;crmProductPreviewDto.REQUEST.IV_INDIRECT=$scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE?"":"X";ProductRecordService.fillFromCrm(crmProductPreviewDto,$rootScope.currentUser.username).success(function(crmResult){var result=CrmUtil.getProductsList(crmResult);$scope.isLoadingProductsCrm=false;if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.perpetualProducts=result}else{if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){$scope.enterpriseProducts=result}else{$scope.allCrmProducts=result}}$scope.productsCrm=result}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$("#products").html(error)})}};if($scope.subTab==$scope.ENTERPRISE||(!$scope.subTab&&$scope.customer&&($scope.customer.enterpriseId==true||$scope.customer.isType1EnterpriseCustomer))){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ENTERPRISE)).replace();$scope.triggerBtnName="#enterpriseProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.ALL){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ALL;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ALL)).replace();$scope.triggerBtnName="#allProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.PERPETUAL)).replace();$scope.triggerBtnName="#perpetualProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}$scope.loadProducts();break;case"contracts":console.log("Query ContractService.fill",$scope.customerNo);ContractService.getAll({customerNo:$scope.customerNo}).success(function(result){console.log("success ContractService.fill");$scope.contracts=result}).error(function(error){console.log("error",error);$("#contracts").html(error)});break;case"subscriptions":if(($scope.subTab==$scope.JILTEAM||(!$scope.subTab&&Utils.getCustomerTypeFromImsDetail($scope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM))){if($scope.customer.bpType!="2"){$rootScope.$broadcast("LOAD_TEAM_SUBSCRIPTION_LIST",$scope.imsCustomer)}$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.JILTEAM)).replace();$scope.triggerBtnName="#jilTeamSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.TEAM){$scope.loadTeamProducts();$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.TEAM)).replace();$scope.triggerBtnName="#teamSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.INDIVIDUAL||(!$scope.subTab&&Utils.getCustomerTypeFromImsDetail($scope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){if($scope.customer.bpType!="2"){$rootScope.$broadcast("LOAD_INDIVIDUAL_SUBSCRIPTION_LIST",$scope.imsCustomer)}$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.INDIVIDUAL)).replace();$scope.triggerBtnName="#individualSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.TRIAL||(!$scope.subTab&&Utils.getCustomerTypeFromImsDetail($scope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){$scope.loadTrialProduct();$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.TRIAL)).replace();$scope.triggerBtnName="#trialSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}}}break;case"stock":console.log("Query customer entitlements",$scope.customer.customerGUID);var customerGUID=$filter("webGuidFilter")($scope.customer);$scope.webGUID=customerGUID;StockServices.getStockCustomerEntitlements({customerGuid:customerGUID+"@AdobeID"}).success(function(result){console.log("successfully pulled entitlement from stock API");if(result==""){result=[]}$scope.entitlements=result}).error(function(error){console.log("error",error);$("#stock").html(error)});break;case"communication":console.log("Query customer emails",$scope.customer.email);$rootScope.$broadcast("LOAD_CUSTOMER_EMAILS");break}};$scope.processENTProduct=function(){if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.loadPerpetualData()}else{if(angular.isDefined($scope.orgguid)&&$scope.orgguid.length>0){$scope.loadENTData()}else{$scope.orgguidFound=false;CustomerPreviewService.getCustomerRelatedOrgWithoutLocking({customerNo:$scope.contactId,customerType:"ENT",viewMode:""}).success(function(result){if(angular.isDefined(result)&&angular.isArray(result.customerRelations)&&result.customerRelations.length>0){for(var i=0;i<result.customerRelations.length;i++){if(result.customerRelations[i].partner1==$routeParams.customerNo){$scope.orgguid=result.customerRelations[i].orgguid;if(angular.isDefined($scope.orgguid)&&$scope.orgguid&&$scope.orgguid.length>0){$scope.orgguidFound=true;$scope.loadENTData()}else{$scope.isLoadingProductsCrm=false;$scope.productsCrm=[];$scope.isOrgfillForCCEWithImsCalled=false;$scope.enterpriseProducts=[]}break}}if(!$scope.orgguidFound){$scope.isLoadingProductsCrm=false;$scope.productsCrm=[];$scope.isOrgfillForCCEWithImsCalled=false;$scope.enterpriseProducts=[]}}else{$scope.isLoadingProductsCrm=false;$scope.productsCrm=[];$scope.isOrgfillForCCEWithImsCalled=false;$scope.enterpriseProducts=[]}}).error(function(error){})}}};$scope.loadENTData=function(){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}ProductRecordService.fillForCCEWithImsV1({customerNo:$scope.contactId,orgId:$scope.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:$scope.refreshProductType,janusOrgId:$scope.orgguid}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");$scope.isLoadingProductsCrm=false;$scope.productsCrm=result;$scope.isOrgfillForCCEWithImsCalled=false;if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.perpetualProducts=result}else{if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){$scope.enterpriseProducts=result}else{$scope.allCrmProducts=result}}}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$scope.isOrgfillForCCEWithImsCalled=false;$("#products").html(error)})};$scope.loadPerpetualData=function(){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}var isInDirectFlag="true";if($scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithIms({customerNo:$scope.contactId,orgId:$scope.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:$scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");$scope.isLoadingProductsCrm=false;$scope.productsCrm=result;$scope.isOrgfillForCCEWithImsCalled=false;if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.perpetualProducts=result}else{if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){$scope.enterpriseProducts=result}else{$scope.allCrmProducts=result}}}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$scope.isOrgfillForCCEWithImsCalled=false;$("#products").html(error)})};var checkDataObj=function(obj){var hasData=false;angular.forEach(obj,function(value){if(!hasData){if(value&&value!=null){hasData=true}}});return hasData};$scope.initCustomer=function(){$scope.customer.billingAddress=(checkDataObj($scope.customer.billingAddress))?$scope.customer.billingAddress:angular.copy($scope.customer.address);$scope.customer.shippingAddress=(checkDataObj($scope.customer.shippingAddress))?$scope.customer.shippingAddress:angular.copy($scope.customer.address);$scope.guid=webGuidFilterFilter($scope.customer);var memoNotes=$scope.customer.memoNotes;for(var count=0;count<memoNotes.length;count++){for(var memoTypeCount=0;memoTypeCount<$scope.metadata[MetadataService.STORE_NAMES.MEMO_NOTE_TYPES].length;memoTypeCount++){if(memoNotes[count].type==$scope.metadata[MetadataService.STORE_NAMES.MEMO_NOTE_TYPES][memoTypeCount].id){memoNotes[count].typeName=$scope.metadata[MetadataService.STORE_NAMES.MEMO_NOTE_TYPES][memoTypeCount].value;break}}}var customerRelationship=$scope.customer.customerRelations;angular.forEach(customerRelationship,function(relationshipItem){angular.forEach($scope.metadata[MetadataService.STORE_NAMES.RELATIONSHIP_TYPES],function(item){if(item.code==relationshipItem.relationshipType){relationshipItem.relationshipTypeName=item.description}});angular.forEach($scope.metadata[MetadataService.STORE_NAMES.CONTACT_TYPES],function(item){if(item.department==relationshipItem.contactType){relationshipItem.contactTypeName=item.description}})});Utils.pageTitle("Customer [ "+Utils.getNameFromCustomerDto($scope.customer)+" ]");var defaultLanguageCode=Utils.getDefaultCountriesLanguage($scope.customer.address.country.code);if($scope.customer.bpType=="2"){$scope.currentContact=CustomerRecordService.findContact($scope.customer,$scope.contactId);if($scope.customer&&$scope.customer.contacts&&$scope.customer.contacts.length>0&&$scope.customer.contacts[0].language){$scope.customer.isCountryLanguageMismatch=defaultLanguageCode.toUpperCase()!=$scope.customer.contacts[0].language.toUpperCase()?true:false}}else{$scope.customer.isCountryLanguageMismatch=defaultLanguageCode.toUpperCase()!=$scope.customer.outputLanguage.toUpperCase()?true:false}if(defaultLanguageCode.length!=2){$scope.customer.isCountryLanguageMismatch=false}$scope.customer.defaultCountryLanguage=defaultLanguageCode;hideEmptyRows()};$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:"",customerType:"1"};$scope.contact={contactFunction:"",contactRole:"",contactType:"",country:"",dayPhone:"",department:"",email:"",fax:"",faxExt:"",firstName:"",language:"",lastName:"",mobile:"",mobileExt:"",orgName1:"",orgName2:"",partner1:"",partner2:"",partnerNo:"",relationFlag:"",relationshipType:"",relationshipTypeName:"",searchableContent:"",telephone:"",telephoneExt:"",title:""};$scope.loadContactDetail=function(){$scope.searchFields.customerId=$scope.contactId;CustomerPreviewService.search($scope.searchFields).success(function(result){var customerPreviewDetail=result.customerSearchResults[0];$scope.contact.email=customerPreviewDetail.email;$scope.contact.firstName=customerPreviewDetail.firstName;$scope.contact.language=customerPreviewDetail.language;$scope.contact.lastName=customerPreviewDetail.lastName;$scope.contact.partner2=customerPreviewDetail.customerNo;$scope.contact.partnerNo=customerPreviewDetail.customerNo;$scope.contact.lastName=customerPreviewDetail.lastName;if(customerPreviewDetail.address&&customerPreviewDetail.address.country){$scope.contact.country=customerPreviewDetail.address.country.code}$scope.customer.contacts=[];$scope.customer.contacts.push($scope.contact);$scope.initCustomer();$scope.loadLoyalityForOrg();initImsService()}).error(function(error){initImsService()})};$scope.loadContactDetailBeforeIms=function(){if($scope.contactId){$scope.loadContactDetail()}else{$scope.initCustomer();initImsService()}};$scope.loadLoyalityForOrg=function(){};var initImsService=function(){var customerEmailIdAuthSrc="";if($scope.customer.customerIdentifications){for(var i in $scope.customer.customerIdentifications){if($scope.customer.customerIdentifications[i].idNumber&&$scope.customer.customerIdentifications[i].idNumber!=""&&($scope.customer.customerIdentifications[i].idType=="ZENTID"||$scope.customer.customerIdentifications[i].idType=="ZADBID")){customerEmailIdAuthSrc=$scope.customer.customerIdentifications[i].idNumber}}}if(customerEmailIdAuthSrc==""&&$scope.customer.adobeId&&$scope.customer.adobeId!=""){customerEmailIdAuthSrc=$scope.customer.adobeId}else{if($scope.customer.contacts&&$scope.contactId){for(var i in $scope.customer.contacts){if($scope.customer.contacts[i].partnerNo!=""&&$scope.customer.contacts[i].partnerNo==$scope.contactId){customerEmailIdAuthSrc=$scope.customer.contacts[i].email}}}}var emailId=customerEmailIdAuthSrc;var imsGetItemObj;if($scope.customer.enterpriseId){imsGetItemObj={email:emailId,authSrc:emailId.split("@")[1]}}else{imsGetItemObj={email:emailId}}ImsCustomerService.getItem(imsGetItemObj).success(function(result){console.log("success ImsCustomerService.getItem");$scope.isLoading=false;$scope.imsCustomer=result;$scope.imsCustomer.emailVerified=result.emailVerified=="true";$rootScope.imsCustomer=result;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){$scope.imsCustomer.serviceCode=item.serviceCode;$scope.imsCustomer.serviceStatus=item.serviceStatus;$scope.imsCustomer.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){$scope.imsCustomer.serviceStorage=item.params[imsCount].pv+" GB"}}}}})}angular.forEach($scope.imsCustomer.serviceAccounts,function(item){if(item.params){for(var imsItemCount=0;imsItemCount<item.params.length;imsItemCount++){if(item.params[imsItemCount].pn=="storage_quota"){item.serviceStorage=item.params[imsItemCount].pv+" GB"}}}})}).error(function(result){console.log("error",result);$scope.isLoading=false})};$scope.handleTabShown=function(tabName){if(angular.isDefined($routeParams.orgTyp)&&$routeParams.orgTyp=="ENT"&&tabName=="products"){$scope.subTab=$scope.ENTERPRISE;loadTab(tabName,$scope.subTab)}else{loadTab(tabName)}};$scope.refreshProducts=function(productType){if(productType==$scope.PERPETUAL){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$scope.subTab=$scope.PERPETUAL;$scope.perpetualProducts=null}else{if(productType==$scope.ENTERPRISE){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;$scope.subTab=$scope.ENTERPRISE;$scope.enterpriseProducts=null}else{$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ALL;$scope.subTab=$scope.ALL;$scope.allCrmProducts=null}}$scope.tabs.splice($scope.tabs.indexOf("products"),1);$scope.products=null;loadTab("products",productType)};$scope.$on("showProductDetailEvent",function(event,selectedProduct){$scope.customerCurrentState=$scope.PRODUCT_DETAILS_VIEW;$scope.productContext=selectedProduct.productContext;$scope.customerItemDetailsTitle=$scope.filterProductTitleForView(selectedProduct);$scope.selectedProductData=selectedProduct;$scope.uniqueId=selectedProduct.uniqueId;$scope.selectedProductData.isOrganization=Utils.isOrganization($scope.customer.bpType);$scope.selectedProductData.isEnrollee=Utils.isEnrollee($scope.customer.bpType);$scope.checkIfCcmReseller();if(($scope.selectedProductData.name=="CCSV"||$scope.selectedProductData.name=="APAP")&&($scope.selectedProductData.regType=="N")){setTimeout(function(){$scope.refreshProductDetails()},1)}});$scope.createTSCase=function(){var returnCaseTemplateUrl="/case/newTs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&productSku="+$scope.selectedProductData.sku+"&contextType="+$scope.productContext+"&tenureDate="+$scope.selectedProductData.registrationDate+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.createCSCase=function(){var returnCaseTemplateUrl="/case/newCs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+$scope.selectedProductData.sku+"&contextType="+$scope.productContext+"&tenureDate="+$scope.selectedProductData.registrationDate+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.refreshProductDetails=function(){$rootScope.$broadcast("RefreshProductDetailsEvent")};$scope.filterProductTitleForView=function(productData){var productTitle=" ";if(angular.uppercase(productData.name)=="CCLE"){productTitle="CCM Team Product Details View"}else{if(angular.uppercase(productData.name)!="CCLE"&&(angular.uppercase(productData.regInd)=="C")&&(productData.businessSegment!=="VIP")){productTitle="CCM Team Single App - "+productData.metaName+" - Product Details View"}else{productTitle="Product Details : "+productData.metaName}}return productTitle};$scope.checkIfCcmReseller=function(){$scope.selectedProductData.isCcmTeamVIP=false;angular.forEach($scope.customer.customerIdentifications,function(customerIdentification){if(customerIdentification.idType=="ZVIPID"){$scope.selectedProductData.isCcmTeamVIP=true}})};$scope.refreshCustomerDetails=function(tabType){switch(angular.lowercase(tabType)){case"products":$scope.refreshProducts()}$scope.goToCustomerDetails()};$scope.goToCustomerDetails=function(){$scope.customerCurrentState=$scope.CUSTOMER_HOME_VIEW};var handleValueChange=function(value){if(value){$scope.newCaseCustomerLink=Utils.newCaseCustomerLink($scope.customer.customerNo,$scope.contactId)}};$scope.$watch(function(){return $scope.contactId},handleValueChange);$scope.$watch(function(){return $scope.customer.customerNo},handleValueChange);$scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className)};$scope.refreshSubscriptions=function(subscriptionType){$scope.refreshButtonClick=true;if(subscriptionType==$scope.TEAM){$scope.subTab=$scope.TEAM;$scope.teamProductsCrm=null}else{if(subscriptionType==$scope.JILTEAM){$scope.subTab=$scope.JILTEAM;$scope.jilTeamSubscriptionlists=null}else{if(subscriptionType==$scope.TRIAL){$scope.subTab=$scope.TRIAL;$scope.trialProductList=null}else{$scope.subTab=$scope.INDIVIDUAL;$scope.subscriptionlists=null}}}$scope.tabs.splice($scope.tabs.indexOf("subscriptions"),1);loadTab("subscriptions",$scope.subTab)}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("CustomerDetailsDto",{displayName:"",firstName:"",lastName:"",email:"",rengaId:"",address:"",countryCode:""});var app=app||angular.module("hxApp.directive",[]);app.directive("customerHeader",["$rootScope","$routeParams","CustomerService","$location","AppConstants","AppUtils","$routeParams","Utils","webGuidFilterFilter","CustomerConstants",function($rootScope,$routeParams,CustomerService,$location,AppConstants,AppUtils,$routeParams,Utils,webGuidFilterFilter,CustomerConstants){return{restrict:"E",scope:{customer:"=",contact:"=",imscustomer:"=",metadata:"=",headeredit:"=",unidentifyshow:"=",loyality:"=",imsView:"="},replace:true,templateUrl:"js/customer/partials/customer-header.html",link:function(scope,element,attrs){scope.isCountryJP=false;scope.vip_level="";scope.CustomerConstants=CustomerConstants;scope.$watch("customer.address.country.code",function(value){if(!value){return}scope.isCountryJP=(value=="JP")?true:false;scope.customer.isCommercialStoreSellable=AppUtils.isCommercialStore(scope.customer.address.country.code);scope.customer.isEducationalStoreSellable=AppUtils.isEducationalStore(scope.customer.address.country.code);scope.customer.isDRStoreSellable=AppUtils.isLaunchDRStoreEnable(scope.customer.address.country);scope.customer.isDRCctStoreSellable=AppUtils.isLaunchCctDRStoreEnable(scope.customer.address.country)});scope.$watch("customer",function(value){if(!value){return}scope.fetchSubscriptionAndProductsLink()});scope.$watch("imscustomer",function(value){if(!value){return}scope.fetchSubscriptionAndProductsLink();var customerGuid=webGuidFilterFilter(scope.customer);scope.customerRoles={roles:[]};if(scope.imscustomer&&scope.imscustomer.roles&&scope.imscustomer.roles.length){for(var i in scope.imscustomer.roles){if(scope.imscustomer.roles&&scope.imscustomer.roles[i]&&scope.imscustomer.roles[i].named_role){if(scope.customerRoles.roles.indexOf(scope.imscustomer.roles[i].named_role.toLowerCase().replace(/_/g," "))===-1){scope.customerRoles.roles.push(scope.imscustomer.roles[i].named_role.toLowerCase().replace(/_/g," "))}}}}if(scope.imscustomer&&scope.imscustomer.countryCode){scope.isCountryJP=(scope.imscustomer.countryCode.toLowerCase()=="jp")?true:false;scope.imscustomer.isCommercialStoreSellable=AppUtils.isCommercialStore(scope.imscustomer.countryCode);scope.imscustomer.isEducationalStoreSellable=AppUtils.isEducationalStore(scope.imscustomer.countryCode);scope.imscustomer.isDRStoreSellable=AppUtils.isLaunchDRStoreEnable(scope.imscustomer.countryCode);scope.imscustomer.isDRCctStoreSellable=AppUtils.isLaunchCctDRStoreEnable(scope.imscustomer.countryCode)}if(scope.imscustomer&&scope.imscustomer.userId){scope.imscustomer.rengaGuid=scope.imscustomer.userId.split("@")[0]}if(_.has(scope.imscustomer,"address.mail_to")&&angular.isDefined(scope.imscustomer.address)&&angular.isDefined(scope.imscustomer["address.mail_to"])){scope.imscustomer.address={street1:scope.imscustomer["address.mail_to"]["line1"],street2:scope.imscustomer["address.mail_to"]["line2"],street3:scope.imscustomer["address.mail_to"]["line3"],city:scope.imscustomer["address.mail_to"]["city"],stateName:scope.imscustomer["address.mail_to"]["stateProv"],postCode:scope.imscustomer["address.mail_to"]["postalZip"],countryCode:scope.imscustomer["address.mail_to"]["countryCode"],countryName:scope.imscustomer["address.mail_to"]["countryCode"]}}else{if(scope.imscustomer&&scope.imscustomer.address){var addressList=scope.imscustomer.address.split(",");scope.imscustomer.address={street1:addressList[1].replace(/null/gi,""),street2:"",street3:"",city:addressList[2],stateName:addressList[3].replace(/null/gi,""),postCode:addressList[5],countryCode:addressList[6],countryName:addressList[6]}}}});scope.$watch("loyality",function(value){if(!angular.isDefined(value)){return}else{angular.forEach(value[0].features,function(val){if(val.name=="DISCOUNT"){scope.vip_level=val.level}})}});scope.fetchSubscriptionAndProductsLink=function(){if(scope.customer&&scope.imscustomer){scope.customerViewProductLink=Utils.createProductLinkInCustomerView(scope.imscustomer,scope.customer.customerNo);scope.customerViewSubscriptionLink=Utils.createSubscriptionLinkInCustomerView(scope.imscustomer,scope.customer.customerNo)}};scope.unidentify=function(){CustomerService.unidentify({customerNo:scope.customer.customerNo,contactNo:""}).success(function(result){console.log("success CustomerService.endInteraction")}).error(function(result){console.log("error",result)})};scope.launchDRStore=function(customer){var drStoreData=new Object();drStoreData.adobeId=customer.adobeId;drStoreData.rengaId=AppUtils.getCustomerWebGUID(customer);drStoreData.locale=customer.address.country.drLocale;drStoreData.themeId=customer.address.country.drThemeId;drStoreData.siteId=customer.address.country.drSiteId;drStoreData.salesRepName=$rootScope.currentUser.username;drStoreData.firstName=customer.firstName;drStoreData.lastName=customer.lastName;drStoreData.street1=customer.address.street1;drStoreData.street2=customer.address.street2;drStoreData.street3=customer.address.street3;drStoreData.city=customer.address.city;drStoreData.state=customer.address.state;drStoreData.postCode=customer.address.postCode;drStoreData.countryCode=customer.address.country.code;drStoreData.countryName=customer.address.country.name;drStoreData.email=customer.email;drStoreData.phoneNumber=customer.telephone;drStoreData.mobileNo=customer.mobileNo;drStoreData.faxPhone=customer.fax;var url="/radon_java_webapp/drstore/index.html";var drStoreWindow=window.open(url,"DRStore","width=900,height=600,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left=0,top=0");drStoreWindow.focus();drStoreWindow.drStoreData=drStoreData};scope.getCustomerNo=function(){if(typeof scope.customer!=="undefined"){if(typeof $routeParams.relCustomerNo=="undefined"){return scope.customer.customerNo}else{return scope.customer.contactId}}};scope.addReminder=function(customer){$rootScope.$broadcast(AppConstants.ADD_REMINDER_EVENT,customer)};scope.isCustomerSearch=function(){return $location.path().indexOf("customer")>-1};scope.loadMemos=function(){scope.$parent.goToCustomerDetails();$('a[href="#memos"]').trigger("click")};var popTimer;setTimeout(function(){$("#checkMemoLink,#checkMemoLinkBlank").on("mouseenter",function(){$("#memoListPopover").css({top:$(this).offset().top+15,left:$(this).offset().left-$("#memoListPopover").width()/2-10});$("#memoListPopover").show()});$("#checkMemoLink,#checkMemoLinkBlank").on("mouseleave",function(){popTimer=setTimeout(function(){$("#memoListPopover").hide()},2000)});$("#memoListPopover").on("mouseenter",function(){if(popTimer){clearTimeout(popTimer)}});$("#memoListPopover").on("mouseleave",function(){$("#memoListPopover").hide()})},1);$("#orgCustomerRolesType2JP, #orgCustomerRolesType1JP, #orgCustomerRolesType2, #orgCustomerRolesType1").mouseenter(function(){$("#pop"+$(this)[0].id).css({top:$(this).offset().top+15,left:$(this).offset().left-$("#pop"+$(this).id).width()/2-10});$("#pop"+$(this)[0].id).show()});$("#orgCustomerRolesType2JP, #orgCustomerRolesType1JP, #orgCustomerRolesType2, #orgCustomerRolesType1").mouseleave(function(){$("#pop"+$(this)[0].id).hide()})}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CustomerPreviewService",["$http",function($http){var service={getCustomerWithoutLocking:function(data){return $http({method:"POST",url:"../customerPreviewService/getCustomerWithoutLocking.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},getCustomerRelatedOrgWithoutLocking:function(data){return $http({method:"POST",url:"../customerPreviewService/getCustomerRelatedOrgWithoutLocking.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},getCustomerRelatedOrgDetailWithoutLocking:function(data){return $http({method:"POST",url:"../customerPreviewService/getRelatedOrgDetailWithoutLocking.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},search:function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:transform,data:data})},findCustomerByTransactionOrCase:function(id){return $http({method:"GET",url:"../customerPreviewService/findCustomerByTransactionOrCase.do",params:{id:id}})}};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CustomerRecordService",["$http",function($http){var service={};service.getItem=function(data){return $http({method:"POST",url:"../customerRecordService/getItem.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data,transformResponse:function(data,headerGetters){try{data=angular.fromJson(data);if(data.billingAddress==null){data.billingAddress=data.address}if(data.shippingAddress==null){data.shippingAddress=data.address}}catch(err){console.log("Fail to convert into JSON object")}return data}})};service.createItem=function(data){return $http({method:"POST",url:"../customerRecordService/createItem.do",data:data})};service.updateItem=function(data){return $http({method:"POST",url:"../customerRecordService/updateItem.do",data:data})};service.customerLock=function(data){return $http({method:"POST",url:"../customerRecordService/customerLock.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.findContact=function(customer,contactId){var result=null;if(!customer||!contactId){return null}result={firstName:customer.firstName,lastName:customer.lastName,partnerNo:contactId};angular.forEach(customer.contacts,function(contact){if(contact.partnerNo==contactId||contact.partnerNo=="0"+contactId){result=contact;return}});return result};service.createCrmRecord=function(data){return $http({method:"POST",url:"../customerRecordService/createEnterprise.do",data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("CustomerRequestDto",{contact:{"last-name":"","first-name":"","primary-phone":"","primary-email":""},street1:"",street2:"",street3:"",street4:"",city:"",country:{name:"",code:""},"postal-code":"","state-province":{name:"",code:""}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CustomerService",["$http",function($http){var service={};service.unidentify=function(data){return $http({method:"POST",url:"../customerService/endInteraction.do",data:data,transformRequest:transform,headers:{"Content-Type":"application/x-www-form-urlencoded"}})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CustomerSubscriptionService",["$http",function($http){var service={};service.getSubscriptions=function(data){return $http({method:"GET",url:"../subscriptionService/getSubscriptions.do",params:{subscriptionAccountId:data.subscriptionAccountId,locale:data.locale,subscriptionType:"INDIVIDUAL",displayPromoData:true}})};service.getTeamSubscriptionListByAdmin=function(data){return $http({method:"GET",url:"../teamSubscriptionService/getTeamSubscriptionListByAdmin.do",params:{customerGuid:data.customerGuid,locale:data.locale}})};service.getTeamSubscriptionListByDelegate=function(data){return $http({method:"GET",url:"../teamSubscriptionService/getTeamSubscriptionListByDelegate.do",params:{customerGuid:data.customerGuid,locale:data.locale}})};service.getTeamSubscriptionDetails=function(data){return $http({method:"GET",url:"../teamSubscriptionService/getTeamSubscriptionDetails.do",params:{customerGuid:data.customerGuid,teamId:data.teamId,locale:data.locale}})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("CustomerTransactionService",["$http",function($http){var service={fill:function(data){return $http({method:"POST",url:"../transactionService/fill.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},getDylanOrders:function(data){return $http({method:"GET",url:"../transactionService/getStoreOnlyOrders.do?customerGuid="+data})},getAllStoreOrders:function(data){return $http({method:"GET",url:"../transactionService/getAllStoreOrders.do?customerGuid="+data})}};service.getAllCommerceOrders=function(searchData){var apiHubData={urlKey:"commerce-order-getAllOrders",queryParameters:{"page-size":"999","person-guid":searchData.customerGuid}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("CustomerUtil",["$rootScope","$location","TeamSubscriptionListDto",function($rootScope,$location,TeamSubscriptionListDto){this.getTeamSubscriptionList=function(teamList,customerGuid){var teamSubscriptionLists=[];var seatDetails;angular.forEach(teamList,function(team){var teamSubscriptionListDto=angular.copy(TeamSubscriptionListDto);teamSubscriptionListDto.teamId=_.has(team,"id")?team.id:"";teamSubscriptionListDto.customerGuid=customerGuid+"@AdobeID";teamSubscriptionListDto.teamName=_.has(team,"name")?team.name:"";teamSubscriptionListDto.totalSeats=_.has(team,"seats.summary.namedSummary.total")?team.seats["summary"]["namedSummary"]["total"]:"";teamSubscriptionListDto.cancelledSeats=_.has(team,"seats.summary.namedSummary.cancelled")?team.seats["summary"]["namedSummary"]["cancelled"]:"";teamSubscriptionListDto.availableSeats=teamSubscriptionListDto.totalSeats-teamSubscriptionListDto.cancelledSeats;teamSubscriptionListDto.isPrimaryAdmin=false;teamSubscriptionListDto.isSeondaryAdmin=false;teamSubscriptionListDto.isInvitedAsPrimary=false;teamSubscriptionListDto.isInvitedAsSecondary=false;teamSubscriptionListDto.programContractId=_.has(team,"programContractId")?team.programContractId:"";teamSubscriptionListDto.externalContractId=_.has(team,"externalContractId")?team.externalContractId:"";if(team.isDrContract){teamSubscriptionListDto.isDrContract=team.isDrContract;teamSubscriptionListDto.type=team.type;teamSubscriptionListDto.billingInfo=team.billingInfo}angular.forEach(team.administrators,function(admin){if(admin.type&&admin.type.toUpperCase()=="PRIMARY_ADMIN"&&teamSubscriptionListDto.customerGuid==admin.userId){teamSubscriptionListDto.isPrimaryAdmin=true}else{if(admin.type&&admin.type.toUpperCase()=="GRP_ADMIN"&&teamSubscriptionListDto.customerGuid==admin.userId&&admin.invitation&&admin.invitation.typeCode.toUpperCase()=="CCM_TEAM_INVITE_PRIMARY"){teamSubscriptionListDto.isInvitedAsPrimary=true}else{if(admin.type&&admin.type.toUpperCase()=="GRP_ADMIN"&&teamSubscriptionListDto.customerGuid==admin.userId){teamSubscriptionListDto.isSeondaryAdmin=true}else{if(admin.type&&admin.type.toUpperCase()=="INVITED"&&teamSubscriptionListDto.customerGuid==admin.userId){teamSubscriptionListDto.isInvitedAsSecondary=true}}}}});teamSubscriptionListDto.seatDetails=[];angular.forEach(team.seats.named,function(seat){seatDetails={};seatDetails.productName=_.has(seat,"productName")?seat.productName:_.has(seat,"localizedLongProductDescriptor")?seat.localizedLongProductDescriptor:"";seatDetails.productCode=_.has(seat,"productCode")?seat.productCode:"";seatDetails.quantity=_.has(seat,"quantity")?seat.quantity:"";seatDetails.status=_.has(seat,"status")?seat.status:"";seatDetails.paymentStatus=_.has(seat,"paymentStatus")?seat.paymentStatus:"";seatDetails.fulfilledEntitlementId=_.has(seat,"fulfilledEntitlementId")?seat.fulfilledEntitlementId:"";seatDetails.language=_.has(seat,"language")?seat.language:"";seatDetails.primaryImageUrl=_.has(seat,"primaryImageUrl")?"https://wwwimages2.adobe.com"+seat.primaryImageUrl:"img/products/no-product.png";seatDetails.sku=_.has(seat,"sku")?seat.sku:"";seatDetails.ProductLongName=_.has(seat,"localizedLongProductDescriptor")?seat.localizedLongProductDescriptor:"";seatDetails.offerId=_.has(seat,"offerId")?seat.offerId:"";seatDetails.isRemoveDelegateAvailable=_.has(seat,"isRemoveDelegateAvailable")?seat.isRemoveDelegateAvailable:false;seatDetails.isInviteDelegateAvailable=_.has(seat,"isInviteDelegateAvailable")?seat.isInviteDelegateAvailable:false;seatDetails.isCancelAvailable=_.has(seat,"isCancelAvailable")?seat.isCancelAvailable:false;teamSubscriptionListDto.seatDetails.push(seatDetails);console.log(seatDetails)});console.log(teamSubscriptionListDto);teamSubscriptionLists.push(teamSubscriptionListDto)});console.log(teamSubscriptionLists);return teamSubscriptionLists}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngDashboardCases",["$timeout","TrackerService","Utils","LocalStorageService","TagCloudService",function($timeout,TrackerService,Utils,LocalStorageService,TagCloudService){return{restrict:"E",scope:{defaultUser:"=defaultuser",metadata:"="},replace:true,templateUrl:"js/dashboard/partials/open-cases.html",link:function(scope,element,attrs){scope.selectedTags=[];var currentAgent="";var d=new Date();d.setTime((d.getTime()+86400*1000*1));scope.agents="";scope.filterOptions={maxResults:200,startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")};scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}scope.filterOptions.startDate=result.toString("dddd, MMMM, yyyy")};scope.customerLink=Utils.customerLink;scope.intervalSelection=4;scope.updateInterval(scope.intervalSelection);scope.handleIntervalChange=function(){scope.updateInterval(scope.intervalSelection);scope.updateOrders(scope.agents,scope.filterOptions)};scope.isSelected=function(){return scope.selectedTags.indexOf(($.trim(this.tag)))!=-1};scope.isSelectedTag=function(){return scope.selectedTags.length>0};scope.toggleTag=function(){if(scope.selectedTags==undefined){scope.selectedTags=[]}var tagName=this.tag;var index=scope.selectedTags.indexOf(($.trim(tagName)));if(index!=-1){scope.selectedTags.splice(index,1)}else{scope.selectedTags.push(($.trim(tagName)))}};scope.handleMyDashboardButton=function(){scope.agents=currentAgent;scope.updateOrders(scope.agents,scope.filterOptions)};scope.handlePopupSaveButton=function(){$("#agentsSelection").modal("hide");scope.updateOrders(scope.agents,scope.filterOptions)};scope.handleClosePopup=function(){scope.agents=scope.beforeDialog;$("#agentsSelection").modal("hide")};scope.handleAgentsChangeButton=function(){scope.beforeDialog=scope.agents;$("#agentsSelection").modal("show")};scope.handleRefresh=function(){scope.updateOrders(scope.agents,scope.filterOptions)};scope.$watch(function(){return scope.defaultUser},function(value){if(!value){return}currentAgent=value.username;scope.agents=value.username;scope.updateOrders(scope.agents,scope.filterOptions)});scope.handleCollapseList=function(){element.find(".row .inner").addClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","collapse")};scope.handleExpandList=function(){element.find(".row .inner").removeClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","")};var checkListItemState=function(){$timeout(function(){var listItemState=LocalStorageService.user.get("dashboard.listitem.state");if(listItemState&&listItemState=="collapse"){scope.handleCollapseList()}},100)};scope.updateOrders=function(agents,filterOptions){scope.isLoading=true;scope.populateCaseTags();TrackerService.getOpenCases(agents,filterOptions).success(function(result){scope.records=result;checkListItemState();scope.isLoading=false}).error(function(){scope.isLoading=false;scope.records=[]})};scope.populateCaseTags=function(){scope.caseTags=[];scope.caseTagsCloud=[];TagCloudService.getTagCaseClouds().success(function(result){scope.caseTagsCloud=result.sort(function(a,b){if(a.tagtext<b.tagtext){return -1}if(a.tagtext>b.tagtext){return 1}return 0});angular.forEach(scope.caseTagsCloud,function(item){scope.caseTags.push(item.tagtext)});scope.caseTags=scope.caseTags.unique().sort()}).error(function(){})};scope.$watch("agents",function(value){if(!value){value=scope.defaultUser.username}Utils.pageTitle("Dashboard [ "+value+" ]")});scope.getStatusColor=function(rec){return Utils.getStatusColor(rec.status)};Utils.pageTitle("Dashboard [ "+scope.defaultUser.username+" ]")}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("DashboardConstants",{DASHBOARD_CASE_LABEL:"cases",DASHBOARD_QUOTE_LABEL:"quotes",DASHBOARD_ORDER_LABEL:"orders",DASHBOARD_OPEN_CASES_TAB_EVENT:"openCasesTab",DASHBOARD_OPEN_QUOTES_TAB_EVENT:"openQuotesTab",DASHBOARD_OPEN_ORDERS_TAB_EVENT:"openOrdersTab"});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("DashboardCtrl",["$scope","MetadataService","TrackingService","$rootScope","$routeParams","$location","DashboardConstants",function DashboardCtrl($scope,MetadataService,TrackingService,$rootScope,$routeParams,$location,DashboardConstants){TrackingService.trackPageView("Dashboard","Dashboard View");$scope.metadata=new Object();$scope.openTab=angular.lowercase($routeParams.tabName);$scope.loadDashboardTab=function(){$("#opentCaseTabLink").removeClass("active");$("#openCaseContent").removeClass("active");$("#opentQuoteTabLink").removeClass("active");$("#openQuoteContent").removeClass("active");$("#opentOrderTabLink").removeClass("active");$("#openOrderContent").removeClass("active");switch($scope.openTab){case DashboardConstants.DASHBOARD_CASE_LABEL:$("#openCaseTabLink").addClass("active");$("#openCaseContent").addClass("active");$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_CASES_TAB_EVENT);break;case DashboardConstants.DASHBOARD_QUOTE_LABEL:$("#openQuoteTabLink").addClass("active");$("#openQuoteContent").addClass("active");$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_QUOTES_TAB_EVENT);break;case DashboardConstants.DASHBOARD_ORDER_LABEL:$("#openOrderTabLink").addClass("active");$("#openOrderContent").addClass("active");$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_ORDERS_TAB_EVENT);break;default:$("#openCaseTabLink").addClass("active");$("#openCaseContent").addClass("active");$scope.openTab=DashboardConstants.DASHBOARD_CASE_LABEL;$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_CASES_TAB_EVENT);break}};$scope.loadDashboardTab();MetadataService.initializeDashboardMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;if($rootScope.returnUrl){$rootScope.returnUrl=null}});$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.handleTabClick=function(tabName){switch(tabName){case"openCases":$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_CASES_TAB_EVENT);break;case"openQuotes":$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_QUOTES_TAB_EVENT);break;case"openOrders":$rootScope.$broadcast(DashboardConstants.DASHBOARD_OPEN_ORDERS_TAB_EVENT);break;default:break}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTagCases",["$timeout","TrackerService","Utils","LocalStorageService","TagCloudService","PersonalizeDashboardService",function($timeout,TrackerService,Utils,LocalStorageService,TagCloudService,PersonalizeDashboardService){return{restrict:"E",scope:{defaultUser:"=defaultuser",metadata:"="},replace:true,templateUrl:"js/dashboard/partials/open-tag-cases.html",link:function(scope,element,attrs){scope.selectedTags=[];scope.selectedCaseTags=[];scope.searchCaseTags=[];scope.changedRecordLimit="";scope.message="";scope.showSavedSearch=false;scope.tagCategories=[];scope.availableTagCategories=[];scope.selectedTagCategory=[];scope.selectedTagsForCategory=[];scope.availbleTagsForCategory=[];scope.savedDashboardSearchList=[];scope.isEditMode=false;scope.performedSearch=false;scope.endDate="";scope.performedSearchDto="";var currentAgent="";var defaultDashboard=function(){return jQuery.extend({},{id:null,ownerId:"",searchId:"",agentIds:"",description:"",scope:"",type:"",filterOptionsDto:{startDate:"",endDate:"",tags:"",maxResults:""},defaultSearch:false})};var defaultFilterOption=function(){return jQuery.extend({},{maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")})};scope.dashboardSearchDto=defaultDashboard();var d=new Date();d.setTime((d.getTime()+86400*1000*1));scope.agents="";scope.filterOptions={maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")};scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}scope.filterOptions.startDate=result.toString("dddd, MMMM, yyyy");scope.startDate=result};scope.customerLink=Utils.customerLink;scope.intervalSelection=4;scope.updateInterval(scope.intervalSelection);scope.handleIntervalChange=function(){scope.updateInterval(scope.intervalSelection);scope.updateTaggedOrders(scope.agents,scope.filterOptions)};scope.handleIntervalChangeFromCriteria=function(){scope.updateInterval(scope.intervalSelection)};scope.isSelected=function(){return scope.selectedCaseTags.indexOf(($.trim(this.tag)))!=-1};scope.isSelectedTag=function(){return scope.selectedCaseTags.length>0};scope.toggleTag=function(){if(typeof(scope.selectedCaseTags)=="undefined"||scope.selectedCaseTags==""){scope.selectedCaseTags=[]}var tagName=this.tag.name;var index=scope.selectedCaseTags.indexOf(($.trim(tagName)));if(index!=-1){scope.selectedCaseTags.splice(index,1)}else{scope.selectedCaseTags.push(($.trim(tagName)))}scope.searchCaseTags=scope.selectedCaseTags.toString()};scope.isCategorySelected=function(){return scope.selectedTagCategory.indexOf(($.trim(this.tagCategory.categorytext)))!=-1};scope.isCategoryTagSelected=function(){return scope.selectedCaseTags.indexOf(($.trim(this.tag.tagtext)))!=-1};scope.handleMyDashboardButton=function(){scope.removedSaveSearchCriteria()};scope.handlePopupSaveButton=function(){$("#agentsSelection2").modal("hide");if(scope.isEditMode){scope.performedSearchDto=scope.dashboardSearchDto}scope.isEditMode=false;scope.performedSearch=false;scope.filterOptions.tags=scope.searchCaseTags.toString();scope.filterOptions.maxResults=scope.changedRecordLimit;scope.updateTaggedOrders(scope.agents,scope.filterOptions)};scope.handlePerformSaveSerach=function(){scope.isTagLoading=true;scope.tagrecords=[];scope.performedSearch=true;scope.performedSearchDto=this.rec;scope.agents=scope.performedSearchDto.agentIds;scope.intervalSelection=this.rec.scope;scope.updateInterval(scope.intervalSelection);scope.searchCaseTags=this.rec.filterOptionsDto.tags.split(",");scope.filterOptions.tags=this.rec.filterOptionsDto.tags.toString();scope.filterOptions.maxResults=this.rec.filterOptionsDto.maxResults;scope.dashboardSearchDto=this.rec;PersonalizeDashboardService.performSavedSearch({id:this.rec.id}).success(function(result){scope.tagrecords=result;scope.isTagLoading=false}).error(function(error){scope.isTagLoading=false;console.log("Personalize Save Search Failed");scope.isTagLoading=false})};scope.handleDeleteSaveSerach=function(){if(this.rec.id==scope.performedSearchDto.id){scope.removedSaveSearchCriteria()}PersonalizeDashboardService.deleteSaveSearch({id:this.rec.id}).success(function(result){console.log("Saved search record deleted !!");scope.getSavedPersonalizeSearch()}).error(function(error){console.log("Saved search record deletion failed !!")})};scope.removedSaveSearchCriteria=function(){scope.performedSearchDto="";scope.dashboardSearchDto=defaultDashboard();scope.filterOptions=defaultFilterOption();scope.beforeDialog=scope.defaultUser.username;scope.agents=scope.defaultUser.username;scope.intervalSelection=4;scope.updateInterval(scope.intervalSelection);scope.selectedCaseTags=[];scope.searchCaseTags=[];scope.changedRecordLimit=200;scope.tagrecords=[];scope.updateTaggedOrders(scope.agents,scope.filterOptions)};scope.handleSearchSaveButton=function(){scope.dashboardSearchDto.id=null;scope.filterOptions.maxResults=scope.changedRecordLimit;scope.saveSearchCriteria(scope.agents,scope.filterOptions)};scope.handleSearchModifyButton=function(){scope.filterOptions.maxResults=scope.changedRecordLimit;scope.saveSearchCriteria(scope.agents,scope.filterOptions);scope.message=[]};scope.handleClosePopup=function(){scope.agents=scope.beforeDialog;$("#agentsSelection2").modal("hide")};scope.handleAgentsChangeButton=function(){if(scope.performedSearchDto){scope.handleEditSearchFromDashboard();return}else{if(scope.isEditMode&&!scope.performedSearch){scope.selectedCaseTags=[];scope.searchCaseTags=[];scope.changedRecordLimit=200;scope.filterOptions=defaultFilterOption();scope.agents=scope.defaultUser.username;scope.dashboardSearchDto=defaultDashboard();scope.intervalSelection=4}}scope.message=[];scope.isEditMode=false;scope.beforeDialog=scope.agents;scope.selectedCaseTags=scope.filterOptions.tags.split(",");scope.searchCaseTags=scope.filterOptions.tags.split(",");scope.changedRecordLimit=scope.filterOptions.maxResults;$("#agentsSelection2").css("z-index",1999);$("#agentsSelection2").modal("show")};scope.handleRefresh=function(){scope.updateTaggedOrders(scope.agents,scope.filterOptions)};scope.exportDashboard=function(){var csvData=[];var data=scope.filtered;for(var i=0;i<scope.filtered.length;i++){var dataObj={};dataObj["Case Number"]=data[i].caseNumber;dataObj["Case Type"]=data[i].transTypeLabel;dataObj["Transaction Type"]=data[i].transType;dataObj["Creation Date"]=new Date(data[i].creationDate);dataObj["Modified Date"]=new Date(data[i].lastModifiedDate);dataObj.OCA=data[i].ocard;dataObj["Case Type"]=data[i].transTypeLabel;dataObj["Customer Name"]=data[i].customerName;dataObj["Customer Number"]=data[i].customerNumber;dataObj["Contact Name"]=data[i].contactFullName;dataObj["Contact Number"]=data[i].contact;dataObj["Bp Type"]=data[i].bpType;var description;try{description=decodeURIComponent(escape(data[i].description))}catch(error){description=unescape(encodeURIComponent(data[i].description))}dataObj.Description=description;dataObj["Reason/Subject"]=data[i].reasonLabel;dataObj["Product Name"]=data[i].productName;dataObj["Product Code"]=data[i].productCode;dataObj.Tags=data[i].tags;dataObj.Priority=getPriorityLabel(data[i].priority);dataObj.Status=data[i].status;dataObj.Owner=data[i].caseOwner.firstName+" "+data[i].caseOwner.lastName;dataObj["Employee Responsible"]=data[i].caseEmployeeResponsible.firstName+" "+data[i].caseEmployeeResponsible.lastName;dataObj["Attachment Flag"]=data[i].attachmentFlag;csvData.push(dataObj)}JSONToCSVConvertor(csvData,"My Dashboard",true);csvData=data=[]};function getPriorityLabel(priorityCode){var priorityLabel=priorityCode;if(typeof scope.metadata.tsCasePriorityDtos!=="undefined"){angular.forEach(scope.metadata.tsCasePriorityDtos,function(item){if(item.priority==priorityCode){priorityLabel=item.value}})}return priorityLabel}unbindWatcher1=scope.$watch(function(){return scope.defaultUser},function(value){if(!value){return}currentAgent=value.username;scope.agents=value.username;scope.updateTaggedOrders(scope.agents,scope.filterOptions)});scope.handleCollapseList=function(){element.find(".row .inner").addClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","collapse")};scope.handleExpandList=function(){element.find(".row .inner").removeClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","")};var checkListItemState=function(){$timeout(function(){var listItemState=LocalStorageService.user.get("dashboard.listitem.state");if(listItemState&&listItemState=="collapse"){scope.handleCollapseList()}},100)};scope.updateTaggedOrders=function(agents,filterOptions){scope.loadCaseTags();scope.tagrecords=[];scope.isTagLoading=true;TrackerService.getOpenCases(agents,filterOptions).success(function(result){scope.tagrecords=result;scope.isTagLoading=false}).error(function(){scope.isTagLoading=false;scope.tagrecords=[]})};scope.getSavedPersonalizeSearch=function(){PersonalizeDashboardService.getSavedSearches().success(function(result){scope.savedDashboardSearchList=result.sort(function(a,b){if(a.description<b.description){return -1}if(a.description>b.description){return 1}return 0})}).error(function(error){console.log("ERROR"+error)})};scope.getSavedPersonalizeSearch();scope.saveSearchCriteria=function(agents,filterOptions){scope.dashboardSearchDto.filterOptionsDto.maxResults=scope.filterOptions.maxResults;scope.dashboardSearchDto.filterOptionsDto.tags=scope.searchCaseTags.toString();scope.dashboardSearchDto.filterOptionsDto.startDate=scope.startDate;scope.dashboardSearchDto.filterOptionsDto.endDate=new Date().getTime();scope.dashboardSearchDto.agentIds=scope.agents.split(",");scope.dashboardSearchDto.ownerId=scope.defaultUser.username;scope.dashboardSearchDto.scope=scope.intervalSelection;scope.dashboardSearchDto.searchId=scope.dashboardSearchDto.description;scope.dashboardSearchDto.type="CASE";PersonalizeDashboardService.saveSearch(false,scope.dashboardSearchDto).success(function(result){var obj=[];obj.push(result);scope.message=obj;scope.getSavedPersonalizeSearch()}).error(function(error){var obj=[];obj.push(error);scope.message=obj})};scope.isSavedHistoryOpen=false;scope.showSaveSearchHistory=function(){if(!scope.isSavedHistoryOpen){$("#savedSearchListContainer").css("display","block");$("#searchListBtn").css("right","160px");scope.isSavedHistoryOpen=true}else{$("#savedSearchListContainer").css("display","none");$("#searchListBtn").css("right","-59px");scope.isSavedHistoryOpen=false}};scope.editSaveSearchCriteria=function(){scope.handleEditCriteria(angular.copy(this.rec))};scope.handleEditSearchFromDashboard=function(){scope.handleEditCriteria(scope.performedSearchDto)};scope.handleEditCriteria=function(rec){scope.isEditMode=true;scope.performedSearch=false;scope.message=[];scope.dashboardSearchDto=defaultDashboard();scope.dashboardSearchDto=rec;scope.beforeDialog=rec.agentIds;scope.agents=rec.agentIds.toString();scope.intervalSelection=scope.dashboardSearchDto.scope;scope.updateInterval(scope.dashboardSearchDto.scope);scope.selectedCaseTags=rec.filterOptionsDto.tags.split(",");scope.searchCaseTags=rec.filterOptionsDto.tags.split(",");scope.changedRecordLimit=rec.filterOptionsDto.maxResults;$("#agentsSelection2").css("z-index",1999);$("#agentsSelection2").modal("show")};TagCloudService.getTagCategory().success(function(result){if(typeof(result)=="undefined"||result==null||result.length==0){return}scope.tagCategory=result.sort(function(a,b){if(a.categorytext<b.categorytext){return -1}if(a.categorytext>b.categorytext){return 1}return 0});angular.forEach(scope.tagCategory,function(item){if(item.status=="ACTIVE"){scope.availableTagCategories.push(item)}})});scope.updateTagCloudForCategory=function(){var categoryName=this.tagCategory;var index=scope.selectedTagCategory.indexOf(($.trim(categoryName.categorytext)));if(index!=-1){scope.selectedTagCategory.splice(0,scope.selectedTagCategory.length);scope.selectedTagCategory.push(categoryName.categorytext)}else{scope.selectedTagCategory.splice(0,scope.selectedTagCategory.length);scope.selectedTagCategory.push(categoryName.categorytext);scope.populateTagsForCategory(categoryName.categorytext)}};scope.populateTagsForCategory=function(newValue){scope.availbleTagsForCategory=[];TagCloudService.getTagsForCategory(newValue).success(function(result){angular.forEach(result,function(item){if(item.status=="ACTIVE"){scope.availbleTagsForCategory.push(item)}})})};scope.loadCaseTags=function(){scope.caseTags=[];scope.caseTagsCloud=[];TagCloudService.getTagCaseClouds().success(function(result){if(typeof(result)=="undefined"||result==null||result.length==0){return}scope.caseTagsCloud=result.sort(function(a,b){if(a.tagtext<b.tagtext){return -1}if(a.tagtext>b.tagtext){return 1}return 0});angular.forEach(scope.caseTagsCloud,function(item){scope.caseTags.push(item.tagtext)});scope.caseTags=scope.caseTags.unique().sort()}).error(function(){})};var unbindWatcher2=scope.$watch("agents",function(value){if(!value){value=scope.defaultUser.username}Utils.pageTitle("Dashboard [ "+value+" ]")});scope.getStatusColor=function(rec){return Utils.getStatusColor(rec.status)};Utils.pageTitle("Dashboard [ "+scope.defaultUser.username+" ]");scope.$on("$destroy",function(){unbindWatcher1();unbindWatcher2()})}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("DebitMemoController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","Debit Memo View");$scope.debitMemoReturnReasons=[];$scope.wizardStep=1;$scope.debitMemoTransaction=angular.copy($scope.transaction);$scope.debitMemoTransaction.transactionType=TransactionConstants.TRANSACTION_DEBIT_MEMO;$scope.dmReason={selectedId:null};$scope.isOverrideBtnShow=true;$scope.isOrderReasonValidInUrl=false;angular.forEach($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],function(reasonItem){var dmReasonItem=angular.copy(reasonItem);if(dmReasonItem[MetadataService.INDEX_NAMES.ORDER_TYPE]==TransactionConstants.TRANSACTION_DEBIT_MEMO){if(dmReasonItem.code==TransactionConstants.SELF_CANCELLATION_DM_REASON_CODE&&!$scope.isDebitMemoFromDirectUrl){}else{$scope.debitMemoReturnReasons.push(dmReasonItem)}if($scope.isDebitMemoFromDirectUrl&&!$scope.isOrderReasonValidInUrl){$scope.isOrderReasonValidInUrl=dmReasonItem[MetadataService.INDEX_NAMES.CODE]==$location.search().reason}}});$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.debitMemoTransaction.transactionGuid,transactionNo:$scope.debitMemoTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.debitMemoTransaction.transactionGuid,transactionNo:$scope.debitMemoTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.cancelDebitMemo=function(){$("#cancelOrderModal").modal("show")};$scope.initializeCheckbox=function(){if($scope.debitMemoTransaction.items.length==1){$scope.selectAll=true;angular.forEach($scope.debitMemoTransaction.items,function(productItem){productItem.NewProp_selected=true})}else{$scope.selectAll=false;angular.forEach($scope.debitMemoTransaction.items,function(productItem){productItem.NewProp_selected=false})}};$scope.$watch("dmReason.selectedId",function(){if($scope.dmReason.selectedId!=null&&$scope.dmReason.selectedId!=""){$scope.wizardStep=2}},true);$scope.backStep=function(step){$scope.wizardStep=step;if(step==1){$scope.dmReason.selectedId=""}$scope.transactionErrorMessage=""};$scope.checkProductsValid=function(){var result=false;var minItemSelected=false;var totalItemSelected=0;angular.forEach($scope.debitMemoTransaction.items,function(productItem){if(productItem.NewProp_selected){minItemSelected=true;totalItemSelected++;$scope.selectAll=$scope.debitMemoTransaction.items.length==totalItemSelected?true:false}if(productItem.quantity>productItem.NotModify_quantity){productItem.quantity=productItem.NotModify_quantity}});if(!minItemSelected){$scope.transactionErrorMessage="Select at least one product item";$scope.selectAll=false}else{$scope.transactionErrorMessage="";result=true}$("#selectedAllChk").prop("checked",$scope.selectAll);return result};$scope.selectAllItems=function($event){var selectedValue=$($event.target).is(":checked");angular.forEach($scope.debitMemoTransaction.items,function(productItem){if(selectedValue){productItem.NewProp_selected=true}else{productItem.NewProp_selected=false}});$scope.selectAll=selectedValue};$scope.checkItemSelection=function(selectedRowValue,$event){selectedRowValue.NewProp_selected=$($event.target).is(":checked")};$scope.isProductItemQtyEditable=function(productItem){if(productItem.NotModify_quantity==1||!productItem.NewProp_selected){return false}return true};$scope.reviewTransaction=function(){$scope.debitMemoReviewTransaction=angular.copy($scope.debitMemoTransaction);$scope.debitMemoReviewTransaction.items=[];for(var count=0;count<$scope.debitMemoTransaction.items.length;count++){var productItem=$scope.debitMemoTransaction.items[count];if(productItem.NewProp_selected){productItem.toReturn=true;productItem.quantity=1;productItem.quantityToReturn=1;$scope.debitMemoReviewTransaction.items.push(productItem)}}$scope.wizardStep=3;if($scope.isDebitMemoFromDirectUrl&&$location.search().amount&&$location.search().amount!=""){$scope.debitMemoReviewTransaction.items[0].promoPrice=$location.search().amount;$scope.overrideTransaction();$scope.isDebitMemoFromDirectUrl=false}};$scope.checkOverrideBtn=function(){var returnValue=false;var listPriceValid=true;if($scope.debitMemoReviewTransaction){angular.forEach($scope.debitMemoReviewTransaction.items,function(productItem){if(productItem.promoPrice!=productItem.NotModify_promoPrice){returnValue=true}if(productItem.promoPrice==""||isNaN(Number(productItem.promoPrice))){listPriceValid=false}})}$scope.isOverrideBtnShow=returnValue;if(!listPriceValid){$scope.transactionOverrideErrorMessage="Enter valid list price";returnValue=false}else{$scope.transactionOverrideErrorMessage=""}return returnValue};$scope.overrideTransaction=function(){$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Debit Memo Review Is In Progress",false,false);var debitMemoOverride=angular.copy($scope.debitMemoReviewTransaction);debitMemoOverride.returnInProgress=true;debitMemoOverride.returnReasonCode=$scope.dmReason.selectedId;debitMemoOverride.paymentDetails=angular.copy($scope.transaction.paymentDetails);angular.forEach(debitMemoOverride.items,function(productItem){productItem.toReturn=true;productItem.promoPrice=$scope.isDebitMemoFromDirectUrl?Number($location.search().amount).toFixed(2):Number(productItem.promoPrice).toFixed(2);productItem.listPrice=productItem.NotModify_listPrice});TransactionService.review(debitMemoOverride).success(function(result){$("#transactionProgressModal").modal("hide");$scope.debitMemoOverrideTransaction=result;angular.forEach($scope.debitMemoOverrideTransaction.items,function(productItem){productItem.NewProp_productImg=AppUtils.getProductThumbnailImage(productItem.productName)});$scope.wizardStep=4}).error(function(result){$("#transactionProgressModal").modal("hide");$scope.transactionErrorMessage="Create Debit Memo Transaction Failed, Try again";TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_SYSTEM,AppConstants.TRACKING_PAGE_SYSTEM_ERROR+"Debit Memo Review")})};$scope.createDebitMemoWizard=function(){$scope.wizardStep=4;$scope.debitMemoOverrideTransaction=angular.copy($scope.debitMemoReviewTransaction);$scope.debitMemoOverrideTransaction.returnInProgress=true;$scope.debitMemoOverrideTransaction.returnReasonCode=$scope.dmReason.selectedId;$scope.debitMemoOverrideTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails);angular.forEach($scope.debitMemoOverrideTransaction.items,function(productItem){productItem.toReturn=true;productItem.listPrice=productItem.NotModify_listPrice})};$scope.createDebitMemo=function(){$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Create Debit Memo Is In Progress",false,false);$scope.debitMemoOverrideTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails);TransactionService.create($scope.debitMemoOverrideTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Debit Memo Creation Failed");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed",result.messages,true,true)}else{TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Debit Memo Created");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Confirmation",result.messages,true,true);$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_TRANSACTION,"Debit Memo Creation Failed");TrackingService.trackPageView(AppConstants.TRACKING_CHANNEL_SYSTEM,AppConstants.TRACKING_PAGE_SYSTEM_ERROR+"Create Debit Memo");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed","Create Debit Memo Transaction Failed",true,true)})};$scope.initializeDebitMemoScreen=function(){$scope.isDocumentFlowShow=true;$scope.isOnlyHardGoodOrder=false;$scope.isHavingHardGoodItem=false;$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.debitMemoTransaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.debitMemoTransaction);$scope.debitMemoTransaction.reason.label=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],$scope.debitMemoTransaction.reason.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if($scope.debitMemoTransaction.paymentDetails&&$scope.debitMemoTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.debitMemoTransaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}for(var count=0;count<$scope.debitMemoTransaction.items.length;count++){if($scope.debitMemoTransaction.items[count].deliveryStatus==TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){$scope.debitMemoTransaction.items.splice(count,1)}}$scope.initializeCheckbox();$scope.handleDirectUrlDebitMemoScreen()};$scope.handleDirectUrlDebitMemoScreen=function(){if($scope.isDebitMemoFromDirectUrl&&$scope.debitMemoTransaction.items.length==1&&$scope.debitMemoTransaction.items[0].productType!=TransactionConstants.CCM_TEAM_PRODUCT_TYPE){$scope.dmReason.selectedId=$scope.isOrderReasonValidInUrl?$location.search().reason:"";if($scope.isOrderReasonValidInUrl){$scope.reviewTransaction()}}else{$scope.isDebitMemoFromDirectUrl=false}};$scope.initializeDebitMemoScreen()}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("DeliveryMethodController",["$scope","$log","$rootScope","$location","$routeParams","$filter","StoreConstants","StoreUtil","DeliveryMethodService",function($scope,$log,$rootScope,$location,$routeParams,$filter,StoreConstants,StoreUtil,DeliveryMethodService){$scope.deliveryMethods=[];var deliveryDetail=function(){return{label:"",partner:"",deliveryIndication:""}};$scope.deliveryDetailObject=deliveryDetail();$scope.loadDeliveryMethod=function(countryCode,stateCode){DeliveryMethodService.getDeliveryMethods({countryCode:countryCode,regionCode:stateCode}).success(function(result){$scope.deliveryMethods=result;angular.forEach(result,function(item){if(item.zzDefault=="X"){$scope.deliveryDetailObject.label=item.label;$scope.deliveryDetailObject.partner=item.partner;$scope.deliveryDetailObject.deliveryIndication=""}})}).error(function(error){})};$rootScope.$on(StoreConstants.QUOTE_UPDATE_DELIVERY_DETAIL,function(event,quoteTransaction){$scope.deliveryDetailObject.label=quoteTransaction.deliveryMethod;$scope.deliveryDetailObject.partner=quoteTransaction.deliveryMethodCode;$scope.deliveryDetailObject.deliveryIndication=quoteTransaction.deliveryIndication});$rootScope.$on(StoreConstants.STORE_UPDATE_DELIVERY_METHOD_EVENT,function(event){if($scope.$parent.getDeliveryEnableStatus()){$rootScope.$broadcast(StoreConstants.UPDATE_DELIVERY_METHOD_TO_TRANSACTION_EVENT,$scope.deliveryDetailObject)}$scope.$parent.setDeliveryEnableStatus(false)});$rootScope.$on(StoreConstants.LOAD_DELIVERY_METHOD_FOR_REGION,function(event,storeTransaction){$scope.loadDeliveryMethod(storeTransaction.shippingAddress.country.code,storeTransaction.shippingAddress.state)})}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("DeliveryMethodService",["$http",function($http){var transform=function(data){return $.param(data)};var service={};service.getDeliveryMethods=function(data){return $http({method:"POST",url:"../metadataService/getDeliveryMethods.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("tabs",function(){return{restrict:"E",transclude:true,scope:{},controller:function($scope,$element){var panes=$scope.panes=[];$scope.select=function(pane){angular.forEach(panes,function(pane){pane.selected=false});pane.selected=true};this.addPane=function(pane){if(panes.length==0){$scope.select(pane);pane.selected=false}panes.push(pane)}},template:'<div class="tabbable"><ul class="nav nav-tabs"><li ng-repeat="pane in panes" ng-class="{active:pane.selected}" id="{{pane.id}}"><a href="" ng-click="select(pane)">{{pane.title}}</a></li></ul><div class="tab-content" ng-transclude></div></div>',replace:true}}).directive("pane",function(){return{require:"^tabs",restrict:"E",transclude:true,scope:{title:"@tabtitle",selected:"@tabselected"},link:function(scope,element,attrs,tabsCtrl){tabsCtrl.addPane(scope)},template:'<div class="tab-pane" ng-class="{active: selected}" ng-transclude></div>',replace:true}}).directive("newtabset",function(){return{restrict:"E",replace:true,transclude:true,controller:function($scope){$scope.templateUrl="";var tabs=$scope.tabs=[];var controller=this;this.selectTab=function(tab){angular.forEach(tabs,function(tab){tab.selected=false});tab.selected=true};this.setTabTemplate=function(templateUrl){$scope.templateUrl=templateUrl};this.addTab=function(tab){if(tabs.length==0){controller.selectTab(tab)}tabs.push(tab)}},template:'<div class="row-fluid"><div class="row-fluid"><div class="nav nav-tabs" ng-transclude></div></div><div class="row-fluid" style="background-color: white;"><ng-include src="templateUrl"></ng-include></div></div>'}}).directive("newtab",function(){return{restrict:"E",replace:true,require:"^newtabset",scope:{title:"@",templateUrl:"@"},link:function(scope,element,attrs,tabsetController){tabsetController.addTab(scope);scope.select=function(){tabsetController.selectTab(scope)};scope.$watch("selected",function(){if(scope.selected){tabsetController.setTabTemplate(scope.templateUrl)}})},template:'<li ng-class="{active: selected}"><a href="" ng-click="select()">{{ title }}</a></li>'}}).directive("ngSimpleError",["$compile",function($compile){return{restrict:"EA",scope:{msg:"@"},replace:true,link:function(scope,element,attrs,tabsCtrl){scope.defaultMsg="Error";scope.$watch(function(){return scope.msg},function(value){if(!value){return}scope.defaultMsg=value})},template:'<div class="alert alert-danger">{{defaultMsg}}</div>'}}]).directive("tabShown",function($parse){return{restrict:"A",link:function(scope,element,attrs,ctrl){var invoker=$parse(attrs.tabShown);$(element).on("shown",function(e){try{if(!scope.$$phase){scope.$apply(function(){invoker(scope,{xevent:e})})}}catch(e){}})}}}).directive("appSearchItemContacts",function($parse){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-contacts.html",link:function(scope,element,attrs){}}}).directive("appSearchRelatedOrgListItem",["$parse","ProductService",function($parse,ProductService){return{restrict:"EA",scope:{orgInfo:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/relatedOrg-listItem.html",link:function(scope,element,attrs){scope.isEntitlementLoading=false;scope.getEntitlementType=function(){var data={customerNo:scope.$parent.customerNo,partnerId:scope.orgInfo.id};var isCCE;var isDC;scope.isEntitlementLoading=true;ProductService.getEntitlementType(data).success(function(response){console.log("Get Entitlement Response",response);if(response.length>0){$.grep(response,function(productInfo){if(productInfo.name=="CCSV"){isCCE=true}if(productInfo.name=="APAP"){isDC=true}});if(typeof isCCE!="undefined"){scope.cceEntitlement="CCE"}if(typeof isDC!="undefined"){scope.dcEntitlement="DC"}}else{}scope.isEntitlementLoading=false}).error(function(errorData){console.log("Error in Get Entitlement",errorData);scope.isEntitlementLoading=false})}}}}]).directive("appSearchItemRelatedOrg",["$parse","$rootScope","ProductService","CustomerPreviewService","Utils","CustomerConstants",function($parse,$rootScope,ProductService,CustomerPreviewService,Utils,CustomerConstants){return{restrict:"E",scope:{data:"=",customerNo:"=",metadata:"=",previewcustomer:"=",onNodeClick:"="},replace:true,templateUrl:"js/search/partials/searchItem-relatedOrg.html",link:function(scope,element,attrs){scope.isOrgLoadingLoading=false;scope.CustomerConstants=CustomerConstants;scope.loadRelatedOrg=function(type){scope.removeActiveStyle();scope.data.records=null;scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_ALL;if(type==CustomerConstants.LOAD_RELATED_ORG_IND){scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_IND}else{if(type==CustomerConstants.LOAD_RELATED_ORG_ENT){scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_ENT}else{if(type==CustomerConstants.LOAD_RELATED_ORG_TEAM){scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_TEAM}else{if(type==CustomerConstants.LOAD_RELATED_ORG_ALL){scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_ALL}}}}scope.setActiveStyle(scope.contextType);scope.onNodeClick({customer:scope.previewcustomer,contextType:scope.contextType})};scope.refreshRelatedOrgList=function(){scope.data.records=null;scope.onNodeClick({customer:scope.previewcustomer,contextType:scope.contextType})};scope.setActiveStyle=function(type){if(type==CustomerConstants.CUSTOMER_CONTEXT_IND){$("#indRelBtn").addClass("active")}else{if(type==CustomerConstants.CUSTOMER_CONTEXT_ENT){$("#entRelBtn").addClass("active")}else{if(type==CustomerConstants.CUSTOMER_CONTEXT_TEAM){$("#teamRelBtn").addClass("active")}else{if(type==CustomerConstants.CUSTOMER_CONTEXT_ALL){$("#allRelatedOrgBtn").addClass("active")}}}}};scope.removeActiveStyle=function(){$("#indRelBtn").removeClass("active");$("#entRelBtn").removeClass("active");$("#teamRelBtn").removeClass("active");$("#allRelatedOrgBtn").removeClass("active")};var handleValueChange=function(value){if(value){if(scope.previewcustomer&&(scope.previewcustomer.enterpriseId==true||scope.previewcustomer.type1EntCustomer)){scope.contextType=CustomerConstants.CUSTOMER_CONTEXT_ENT}else{scope.contextType=Utils.getCustomerTypeFromImsDetail(value)}scope.removeActiveStyle();scope.setActiveStyle(scope.contextType)}};scope.$watch(function(){return scope.$parent.imsCustomerDetail},handleValueChange);scope.loadRelatedOrgDetail=function(rec){rec.loading=true;CustomerPreviewService.getCustomerRelatedOrgDetailWithoutLocking({customerNo:rec.id,customerType:"",viewMode:"X"}).success(function(result){rec.loading=false;angular.forEach(scope.data.records,function(oldRec){if(oldRec.id==result.id){oldRec.address=result.address;oldRec.classification=result.classification;oldRec.stratification=result.stratification;oldRec.type=result.type;oldRec.phone=result.phone;oldRec.name=result.name;scope.updateRelatedOrg(oldRec)}})}).error(function(fail){});scope.updateRelatedOrg=function(oldRec){for(var classificationCount=0;classificationCount<scope.metadata.classifications.length;classificationCount++){if(oldRec.classification==scope.metadata.classifications[classificationCount].code){oldRec.classificationName=scope.metadata.classifications[classificationCount].description;oldRec.isOrgLinkDisabled=false;break}}if(oldRec.contactType=="CC4E"){oldRec.contactType="CCE"}if(oldRec.contactType=="ENT"){oldRec.contactType="ENT";oldRec.contactTypeEntitlements="Get Entitlement"}else{oldRec.contactType="";oldRec.contactTypeName="";oldRec.contactTypeEntitlements=""}if(oldRec.contactRole){oldRec.contactTypeName=oldRec.contactRole}}}}}}]).directive("appSearchItemTransactions",["$parse","Utils",function($parse,Utils){return{restrict:"E",scope:{data:"=",dylanOrders:"=",storeOrders:"=",customerNo:"=",loading:"=",webguid:"=webguid"},replace:true,templateUrl:"js/search/partials/searchItem-transactions.html",link:function(scope,element,attrs){scope.ordersViewType=0;console.log("customerGuid "+scope.webguid);scope.loadTransactions=function(){scope.errorMessages=[];scope.intervalSelection=9;$("#transactions-"+scope.customerNo+" .transactionButtonGrp button").removeClass("active");$("#transactions-"+scope.customerNo+" .btnCrmOrders").addClass("active");scope.ordersViewType=0;scope.$parent.loadTransactions()};scope.loadDylanOrders=function(){scope.errorMessages=[];scope.intervalSelection=9;$("#transactions-"+scope.customerNo+" .transactionButtonGrp button").removeClass("active");$("#transactions-"+scope.customerNo+" .btnDylanOrders").addClass("active");scope.ordersViewType=1;scope.$parent.loadDylanOrders()};scope.loadNotProcessedDylanOrders=function(){scope.errorMessages=[];scope.intervalSelection=9;$("#transactions-"+scope.customerNo+" .transactionButtonGrp button").removeClass("active");$("#transactions-"+scope.customerNo+" .btnNotProcessedDylanOrders").addClass("active");scope.ordersViewType=2;scope.$parent.loadNotProcessedDylanOrders()};scope.$on("showTransactionErrorMessage",function(){scope.errorMessages=Utils.showMessage("error","Problem in loading Dylan Only Orders. Please try again.")});scope.$on("showCrmTransactionErrorMessage",function(){scope.errorMessages=Utils.showMessage("error","Problem in loading transactions. Please try again.")})}}}]).directive("appSearchItemCases",["Utils",function(Utils){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-cases.html",link:function(scope,element,attrs){scope.customerLink=Utils.customerLink}}}]).directive("appSearchItemProducts",function($parse){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-products.html",link:function(scope,element,attrs){scope.filterProductName=function(recordItem){var productName="";if(angular.uppercase(recordItem.name)!="CCLE"&&(angular.uppercase(recordItem.regInd)=="C")){productName=recordItem.metaName+" (CCTeam)"}else{productName=recordItem.metaName}return productName}}}}).directive("appSearchItemContracts",function($parse){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-contracts.html",link:function(scope,element,attrs){}}}).directive("appSearchItemMemos",function($parse){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-memos.html",link:function(scope,element,attrs){}}}).directive("appSearchItemServices",function($parse){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-services.html",link:function(scope,element,attrs){}}}).directive("appSearchItemSubscriptions",["$parse","TeamConstants","CustomerConstants",function($parse,TeamConstants,CustomerConstants){return{restrict:"E",scope:{data:"=",customerNo:"="},replace:true,templateUrl:"js/search/partials/searchItem-subscriptions.html",link:function(scope,element,attrs){scope.CustomerConstants=CustomerConstants;scope.getProductSeats=function(records,offerId){var qty=0;angular.forEach(records,function(product){if(offerId==product.offerId&&product.paymentStatus&&product.paymentStatus.toUpperCase()!=="CANCELLED"){qty=qty+product.quantity}});return qty};scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus};scope.toggleClassName=function($event,indexId){if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){var className=$($event.currentTarget).find("i").hasClass("glyphicon-chevron-right")?"glyphicon glyphicon-chevron-down":"glyphicon glyphicon-chevron-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseJilTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseJilTeamProductItems"+indexId).removeClass().addClass(accordionClassName)}}}}}]).directive("ngMessages",["$location","$rootScope",function(location,rootScope){return{restrict:"EA",scope:{source:"="},replace:true,templateUrl:"js/common/partials/messages.html",link:function($scope,element,attrs){$scope.onErrorRedirect=function(val){}}}}]).directive("ngStoreMessages",["$location","$rootScope",function(location,rootScope){return{restrict:"EA",scope:{source:"="},replace:true,templateUrl:"js/store/common/partials/store-messages.html",link:function($scope,element,attrs){}}}]).directive("pleaseWait",function(){return{restrict:"E",replace:true,template:'<div class="pleaseWait"><img src="img/ajax-loader.gif"/></div>',link:function(scope,element,attrs){}}}).directive("ngPriority",function($parse){return{restrict:"E",scope:{ngModel:"="},replace:true,require:"^ngModel",templateUrl:"js/common/partials/priority.html",link:function($scope,$element,$attrs,ctrl){$scope.componentDisabled=false;$scope.$watch("ngModel",function(value){if(ctrl.$viewValue!=value){$scope.currentValue=value}});$scope.setPriority=function(option){if($scope.componentDisabled){return}if(option==-1||option==$scope.currentValue){$scope.currentValue=null;$scope.ngModel=null}else{$scope.currentValue=option;$scope.ngModel=option}};$scope.$watch($attrs.ngDisabled,function(){if($scope.$eval($attrs.ngDisabled)===true){$scope.componentDisabled=true}else{$scope.componentDisabled=false}})}}}).directive("ngLicenseType",function($timeout){return{restrict:"E",scope:{source:"=",readonly:"=",ngModel:"=",selectedValue:"=selectedvalue"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !source || source.length == 0"><option ng-repeat="v in source" value="{{v.id}}" title="{{v.value}}" ng-selected="v.id==ngModel">{{v.value}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$scope.$watch(function(){return $scope.ngModel},function(value){if(!value){$scope.selectedValue=null;return}angular.forEach($scope.source,function(item){if(item.id==value){$scope.selectedValue=item;return}})});$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngLicenseSubType",function($timeout){return{restrict:"E",scope:{ngModel:"=",license:"=",readonly:"=",selectedValue:"=selectedvalue"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !subLicenses || subLicenses.length == 0"><option ng-repeat="v in subLicenses" value="{{v.id}}" title="{{v.value}}" ng-selected="v.id==ngModel">{{v.value}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$scope.$watch(function(){return $scope.license},function(value){if(value){$scope.subLicenses=value.subLicenses}else{$scope.subLicenses=[]}});$scope.$watch(function(){return $scope.ngModel},function(value){$scope.selectedValue=null;if(!value){return}$timeout(function(){angular.forEach($scope.subLicenses,function(item){if(item.id==value){$scope.selectedValue=item;return}})})});$el.on("change",function(e){$scope.$apply(function(){angular.forEach($scope.subLicenses,function(item){if(item.id==$el.val()){$scope.selectedValue=item;return}});$scope.ngModel=$el.val()})})}}}).directive("ngLicenseLength",function($timeout){return{restrict:"E",scope:{ngModel:"=",subLicense:"=",readonly:"="},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !subLicensesLength || subLicensesLength.length == 0"><option ng-repeat="v in subLicensesLength" value="{{v.id}}" title="{{v.value}}" ng-selected="v.id==ngModel">{{v.value}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$scope.$watch(function(){return $scope.subLicense},function(value){if(value){$scope.subLicensesLength=value.licenseLengths}else{$scope.subLicensesLength=[]}});$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngSubProduct",function($timeout){return{restrict:"E",scope:{ngModel:"=",readonly:"=",subProducts:"=subproducts"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !subProducts || subProducts.length == 0"><option ng-repeat="v in subProducts" value="{{v.code}}" title="{{v.name}}" ng-selected="v.code==ngModel">{{v.name}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngPlatforms",function($timeout){return{restrict:"E",scope:{ngModel:"=",readonly:"=",prodPlatforms:"=prodplatforms"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !prodPlatforms || prodPlatforms.length == 0"><option ng-repeat="v in prodPlatforms" value="{{v.code}}" title="{{v.name}}" ng-selected="v.code == ngModel">{{v.name}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngLanguages",function($timeout){return{restrict:"E",scope:{ngModel:"=",readonly:"=",prodLanguages:"=prodlanguages"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !prodLanguages || prodLanguages.length == 0"><option ng-repeat="v in prodLanguages" value="{{v.code}}" title="{{v.name}}" ng-selected="v.code==ngModel">{{v.name}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngSubService",function($timeout){return{restrict:"E",scope:{ngModel:"=",readonly:"=",subServices:"=subservices"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !subServices || subServices.length == 0"><option ng-repeat="v in subServices" value="{{v.id}}" title="{{v.value}}" ng-selected="v.id==ngModel">{{v.value}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngTechCode",function($timeout){return{restrict:"E",scope:{ngModel:"=",readonly:"=",techCodes:"=techcodes"},replace:true,require:"^ngModel",template:'<select ng-disabled="readonly || !techCodes || techCodes.length == 0"><option></option><option ng-repeat="v in techCodes" value="{{v.id}}" title="{{v.value}}" ng-selected="v.id==ngModel">{{v.value}}</option> </select>',link:function($scope,$el,$attrs,$ctrl){$el.on("change",function(e){$scope.$apply(function(){$scope.ngModel=$el.val()})})}}}).directive("ngOCard",function($timeout){return{restrict:"E",scope:{ngModel:"="},replace:true,link:function($scope,$el,$attrs,$ctrl){$scope.$watch(function(){return $scope.ngModel},function(value){var htmlText="<span>";if(value<=2){htmlText+='<span class="badge badge-success">'+value+"</span>"}else{if(value>=3&&$scope.ngModel<=5){htmlText+='<span class="badge badge-warning">'+value+"</span>"}else{htmlText+='<span class="badge badge-important">'+value+"</span>"}}$el.html(htmlText)})}}}).directive("ngAgeing",["SubscriptionConstants","Utils",function(SubscriptionConstants,Utils,$timeout){return{restrict:"E",scope:{ageing:"="},replace:true,link:function($scope,$el,$attrs,$ctrl){var htmlText="<span>";var dateDiff=Utils.getProductSubscriptionAge($scope.ageing);htmlText+='<span class="badge badgeColorOverride">'+dateDiff+"</span>";$el.html(htmlText)}}}]).directive("ngCustomerError",[function($timeout){return{restrict:"E",scope:{errorObj:"="},replace:true,link:function($scope,$el,$attrs,$ctrl){var htmlText='<div id="erroMessage">';htmlText+='<div class="alert alert-danger">Unable to retrieve the requested information. Please try after some time.</div>';$el.html(htmlText)}}}]).directive("ngOnHoldFor",function($timeout){return{restrict:"E",scope:{ngModel:"="},replace:true,link:function($scope,$el,$attrs,$ctrl){$scope.$watch(function(){return $scope.ngModel},function(lastModifiedDate){var func=function(){var today=new Date();var daysBetween=moment().diff(new Date(lastModifiedDate),"days");return daysBetween};var value=Math.round(func());var htmlText="<span>";if(value<=2){htmlText+='<span class="badge badge-success">'+value+"</span>"}else{if(value>=3&&$scope.ngModel<=5){htmlText+='<span class="badge badge-warning">'+value+"</span>"}else{htmlText+='<span class="badge badge-important">'+value+"</span>"}}$el.html(htmlText)})}}}).directive("hcenter",function(){return{restrict:"E",replace:true,transclude:true,template:'<div class="hcenter"><div class="inner" ng-transclude></div></div>',link:function(scope,element,attrs){}}}).directive("ngServiceLoader",function(){return{restrict:"E",scope:{isLoading:"="},replace:true,transclude:true,template:'<img src="img/ajax-loader.gif" ng-show="isLoading" class="ajax-loading"/>',link:function(scope,element,attrs){}}}).directive("ngServiceLoaderMessage",function(){return{restrict:"E",scope:{isLoading:"="},replace:true,transclude:true,template:'<div><span>Please Wait...</span><br><img src="img/ajax-loader.gif" ng-show="isLoading" class="ajax-loading"/></div>',link:function(scope,element,attrs){scope.isLoading=false}}}).directive("trimText",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){var transformedInput=inputValue.toLowerCase().replace(/ /g,"");if(transformedInput!=inputValue){modelCtrl.$setViewValue(transformedInput);modelCtrl.$render()}return transformedInput})}}}).directive("emailAvailable",function($http,$timeout){return{require:"ngModel",link:function(scope,elem,attr,ctrl){console.log(ctrl);ctrl.$parsers.push(function(viewValue){ctrl.$setValidity("emailAvailable",true);if(ctrl.$valid){ctrl.$setValidity("checkingEmail",false);if(viewValue!==""&&typeof viewValue!=="undefined"){$http.get("Invalid.json").success(function(data,status,headers,config){ctrl.$setValidity("emailAvailable",true);ctrl.$setValidity("checkingEmail",true)}).error(function(data,status,headers,config){ctrl.$setValidity("emailAvailable",false);ctrl.$setValidity("checkingEmail",true)})}else{ctrl.$setValidity("emailAvailable",false);ctrl.$setValidity("checkingEmail",true)}}return viewValue})}}}).directive("onEnter",function(){return{scope:{onEnter:"&"},link:function(scope,element){element.bind("keydown keypress",function(event){if(event.which===13){scope.onEnter();scope.$apply()}})}}}).directive("ngBlur",function(){return function(scope,elem,attrs){elem.bind("blur",function(){scope.$apply(attrs.ngBlur)})}}).directive("ngFocus",function($timeout){return function(scope,elem,attrs){scope.$watch(attrs.ngFocus,function(newval){if(newval){$timeout(function(){elem[0].focus()},0,false)}})}}).directive("ngOnFocus",["$parse",function($parse){return function(scope,element,attr){var fn=$parse(attr.ngOnFocus);element.bind("focus",function(event){scope.$apply(function(){fn(scope,{$event:event})})})}}]).directive("regexValidate",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var flags=attr.regexValidateFlags||"";var regex=new RegExp(attr.regexValidate,flags);ctrl.$parsers.unshift(function(value){var valid=regex.test(value);ctrl.$setValidity("regexValidate",valid);return valid?value:undefined});ctrl.$formatters.unshift(function(value){ctrl.$setValidity("regexValidate",regex.test(value));return value})}}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("DocumentFlowService",["$http",function($http){var service={};service.get=function(data){return $http({method:"POST",url:"../documentFlowService/get.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getBillingPlan=function(data){return $http({method:"POST",url:"../documentFlowService/getBillingPlan.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.updateBillingDate=function(data){return $http({method:"POST",url:"../documentFlowService/updateBillingDate.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.retriggerEmail=function(data){return $http({method:"POST",url:"../documentFlowService/retriggerEmail.do",headers:{"Content-Type":"application/json"},data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("DrTeamAddSeatDto",{last_modified_by_id:"",owner_id:"",status:"",country:"",cartItems:[]});app.value("DrTeamCancelContractDto",{cancelledBy:"",cancellationReason:"USER_CANCELLED",status:""});var app=app||angular.module("hxApp",["ngRoute"]);app.value("DrTeamCancelLicenseDto",{offerId:"",quantity:"",entitlementDetails:[]});var app=app||angular.module("hxApp",["ngRoute"]);app.value("DrTeamCartItemDto",{offerId:"",quantity:"",entitlementDetails:{seatId:"",status:""}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("DrTeamService",["$http",function($http){var service={};service.addDRSeat=function(data){var apiHubData={urlKey:"dr-team-addSeat",pathVariables:{teamId:data.teamId},requestBody:{lastModifiedById:data.lastModifiedById,ownerId:data.ownerId,status:data.status,country:data.country,cartItems:data.cartItems},requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.cancelDRContract=function(teamId,data){var apiHubData={urlKey:"dr-team-cancelContract",pathVariables:{teamId:teamId},requestBody:data,requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.cancelDRSeat=function(data){var apiHubData={urlKey:"dr-team-cancelSeat",pathVariables:{teamId:data.teamId},requestBody:{lastModifiedById:data.lastModifiedById,ownerId:data.ownerId,status:data.status,country:data.country,cartItems:data.cartItems},requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("DylanOrderAddressModel",function DylanOrderAddressModel(){return function(orderAddress){var getStateProvinceObject=function(){return{code:orderAddress["address.StateProvince"]["reference.code"],name:orderAddress["address.StateProvince"]["reference.name"]}};var getAddressName=function(){return angular.isDefined(orderAddress["address.addressName"])?orderAddress["address.addressName"]:""};var getAddressStatus=function(){return angular.isDefined(orderAddress["address.addressStatus"])?orderAddress["address.addressName"]:""};var getAddressType=function(){return orderAddress["address.addressType"]};var getCity=function(){return orderAddress["address.city"]};var getCell=function(){return orderAddress["address.contact"]["contact.cell"]};var getAddressId=function(){return orderAddress["address.id"]};var getContactId=function(){return orderAddress["address.contact"]["contact.id"]};var getFirstName=function(){return orderAddress["address.contact"]["contact.firstName"]};var getLastName=function(){return orderAddress["address.contact"]["contact.lastName"]};var getStreet1=function(){return orderAddress["address.street1"]};var getStreet2=function(){return orderAddress["address.street2"]};var getStreet3=function(){return orderAddress["address.street3"]};var getStreet4=function(){return orderAddress["address.street4"]};var getPostalCode=function(){return orderAddress["address.postalCode"]};var getCountry=function(){return{alpha2_code:orderAddress["address.country"]["reference.iso_3166_alpha2_code"],alpha3_code:orderAddress["address.country"]["reference.iso_3166_alpha3_code"],name:orderAddress["address.country"]["reference.iso_3166_name"]}};var getCompanyName=function(){return orderAddress["address.contact"]["contact.companyName"]};var getDepartment=function(){return orderAddress["address.contact"]["contact.department"]};var getPhone=function(){return orderAddress["address.contact"]["contact.phone"]};var getPrimaryEmail=function(){return orderAddress["address.contact"]["contact.primaryEmail"]};var getPronunciationCompanyName=function(){return orderAddress["address.contact"]["contact.pronunciation_company_name"]};var getPronunciationFirstName=function(){return orderAddress["address.contact"]["contact.pronunciation_first_name"]};var getPronunciationLastName=function(){return orderAddress["address.contact"]["contact.pronunciation_last_name"]};var getVatId=function(){return orderAddress["address.contact"]["contact.vat_id"]};var model={firstName:getFirstName(),lastName:getLastName(),street1:getStreet1(),street2:getStreet2(),street3:getStreet3(),street4:getStreet4(),city:getCity(),stateProvince:getStateProvinceObject(),postalCode:getPostalCode(),country:getCountry(),companyName:getCompanyName(),department:getDepartment(),phone:getPhone(),cell:getCell(),email:getPrimaryEmail(),pronunciationCompanyName:getPronunciationCompanyName(),pronunciationFirstName:getPronunciationFirstName(),pronunciationLastName:getPronunciationLastName(),vatId:getVatId(),addressType:getAddressType(),addressStatus:getAddressStatus(),addressName:getAddressName(),addressId:getAddressId,contactId:getContactId()};return model}});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("DylanOrderController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","Order View");$scope.orderTransaction=angular.copy($scope.transaction);$scope.isTransactionComplete=false;$scope.isTransactionOpen=false;$scope.isUpdateOrderDisabled=true;$scope.isMemoBtnEnabled=false;$scope.isExecuteActionShow=false;$scope.isExecuteActionDisabled=true;$scope.isTermsAndConditionsShow=false;$scope.isRetriggerChkBoxDisabled=false;$scope.isDylanOrder=true;$scope.updatedPaymentdetails;$scope.NotModify_billingAddress;$scope.NotModify_shippingAddress;$scope.cancelNonSubscriptionOrderReason={selectedId:null};$scope.triggerJapanesePaymentEmail=false;$scope.triggerJapanesePaymentForm=false;$scope.paymentType;$scope.isTnCAccepted=false;$scope.isTncButtonDisabled=false;$scope.isPaymentFormValid=false;$scope.checkTrackingInfo=function(){if($scope.transaction){if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.transaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.transaction.items&&$scope.transaction.items.length>0){for(var itemCount=0;itemCount<$scope.transaction.items.length;itemCount++){if($scope.transaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.checkDocumentFlow=function(){if($scope.transaction){if($scope.isOnlyEsdOrder||$scope.isOnlySubOrder){return true}return[TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER].indexOf($scope.transaction.transactionType)>-1}return false};$scope.checkOrderActions=function(){if($scope.transaction.actions){if($scope.transaction.actions.length>0){$scope.transactionOrderActionsHistory=$scope.transaction.actions;return true}}return false};$scope.validateButtonVisibility=function(){$scope.isPurchaseOrder=false;$scope.isJpbtCcmOrder=false;if($scope.isSubscriptionOrder&&$scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){$scope.isPurchaseOrder=true;$scope.isSubscriptionEditBtnShow=true}else{if($scope.isSubscriptionOrder){$scope.isSubscriptionEditBtnShow=true;$scope.isNonSubscriptionEditBtnShow=false}else{$scope.isSubscriptionEditBtnShow=false;$scope.isNonSubscriptionEditBtnShow=true;if($scope.isOnlyHardGoodOrder&&$scope.isTransactionOpen){$scope.isModifyOrderBtnShow=true;$scope.isCancelOrderBtnShow=true;$scope.isReturnOrderBtnShow=false}else{$scope.isReturnOrderBtnShow=true;$scope.isModifyOrderBtnShow=false;$scope.isCancelOrderBtnShow=false}}}if(($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)&&OrderUtils.isPuf($scope.transaction.items)){$scope.isJpbtCcmOrder=true}if(!$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=false;return}angular.forEach($scope.transaction.items,function(productItem){if(productItem.deliveryStatus!=TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){$scope.isMemoBtnEnabled=true}})};$scope.initializeOrderScreen=function(){MetadataService.getCountrySpecificInfo({countryCode:$scope.transaction.customer.address.country.code}).success(function(result){$scope.countrySpecificInfo=result;$scope.updatePayerStateName()});$scope.transaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.transaction.billingAddress.country.code,$scope.transaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.transaction.items);$scope.isOnlyEsdOrder=OrderUtils.isOnlyEsdOrder($scope.transaction.items);$scope.isOnlySubOrder=OrderUtils.isOnlySubOrder($scope.transaction.items);$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.isDocumentFlowShow=$scope.checkDocumentFlow();$scope.checkOrderActions();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.transaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.transaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.transaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.transaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.transaction);if($scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.transaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if($scope.transaction.paymentDetails.cardType==PaymentConstants.DYLAN_MASTER_CARD_TYPE){$scope.cardTypeName="MasterCard"}}$scope.transactionStatusLabel=TransactionUtil.getStatusLabel($scope.transaction.statusLabel);$scope.isTransactionComplete=OrderUtils.isTransactionComplete($scope.transaction.statusLabel);$scope.isTransactionOpen=OrderUtils.isTransactionOpen($scope.transaction.statusLabel);$scope.validateButtonVisibility()};$scope.initializeOrderScreen();if($scope.transaction){$scope.isProductCCT=OrderUtils.isCCTProduct($scope.transaction.items[0].productType)}$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.transaction.transactionGuid,transactionNo:$scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.transaction.transactionGuid,transactionNo:$scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.showOrderActions=function(){$scope.showOrderActionsContainer=!$scope.showOrderActionsContainer};$scope.hideOrderActions=function(){$scope.showOrderActionsContainer=false};$scope.openEditBillingView=function(){$scope.isUpdateOrderDisabled=true;TransactionService.lockTransaction({guid:$scope.transaction.transactionGuid}).success(function(lockResult){if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_EDIT_BILLING_EVENT,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,lockResult);if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){$scope.isExecuteActionShow=true}if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE&&OrderUtils.isCcmTeam($scope.transaction.items)){$scope.isRetriggerChkBoxDisabled=true}else{$scope.isRetriggerChkBoxDisabled=false}$scope.checkTnC();$scope.checkOrderActions()}}).error(function(result){})};$scope.openModifyOrderView=function(){$scope.isUpdateOrderDisabled=true;TransactionService.lockTransaction({guid:$scope.transaction.transactionGuid}).success(function(lockResult){if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_MODIFY_ORDER_EVENT,TransactionConstants.TRANSACTION_NON_SUBSCRIPTION__ORDER,lockResult)}}).error(function(result){})};$scope.openCreateCreditMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_EVENT)};$scope.openCreateDebitMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_EVENT)};$scope.openReturnOrderView=function(){$scope.$emit(TransactionConstants.TRANSACTION_ORDER_RETURN_VIEW_EVENT)};$scope.$watch("cancelNonSubscriptionOrderReason.selectedId",function(){if($scope.cancelNonSubscriptionOrderReason.selectedId!=null&&$scope.cancelNonSubscriptionOrderReason.selectedId!=""){$scope.isCancelNonSubscriptionReasonSelected=$scope.cancelNonSubscriptionOrderReason.selectedId}else{$scope.isCancelNonSubscriptionReasonSelected=null}},true);$scope.cancelNonSubscriptionOrder=function(){$scope.cancelNonSubscriptionOrderServiceLoading=true;TransactionService.cancelNonSubscriptionOrder({transactionGuid:$scope.transaction.transactionGuid,cancelReasonCode:$scope.cancelNonSubscriptionOrderReason.selectedId}).success(function(lockResult){$scope.cancelOrderServiceMessage="The Cancel Order Transaction Completed Successfully";$scope.cancelOrderLoading=$scope.cancelNonSubscriptionOrderServiceLoading=false}).error(function(result){$scope.cancelOrderServiceMessage="The Cancel Order Transaction Failed";$scope.cancelOrderLoading=$scope.cancelNonSubscriptionOrderServiceLoading=false})};$scope.showCancelNonSubscriptionOrderModal=function(){$("#cancelNonSubscriptionOrderModal").modal("show");$scope.cancelOrderLoading=true};$scope.closeCancelNonSubscriptionOrderModal=function(){$("#cancelNonSubscriptionOrderModal").modal("hide")};$scope.refreshOrderScreen=function(){location.reload()};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_CANCEL_ADDRESS_UPDATE_EVENT,$scope.NotModify_billingAddress,$scope.NotModify_shippingAddress);$scope.isExecuteActionShow=false;$scope.isRetriggerChkBoxDisabled=false};$scope.$on(TransactionConstants.TRANSACTION_PAYMENT_UPDATE_EVENT,function(event,isPaymentValid,updatedPayment){if(isPaymentValid){$scope.updatedPaymentdetails=updatedPayment}$scope.isPaymentFormValid=isPaymentValid;$scope.checkEnableOrderButton()});$scope.checkEnableOrderButton=function(){if($scope.transaction.customer.address.country.code=="DE"&&$scope.updatedPaymentdetails&&$scope.transaction.paymentDetails.paymentType!=$scope.updatedPaymentdetails.paymentType){$scope.isUpdateOrderDisabled=!($scope.isPaymentFormValid&&$scope.isTnCAccepted)}else{$scope.isUpdateOrderDisabled=!$scope.isPaymentFormValid}};$scope.updateTermsAndConditionsCheck=function(){$scope.isTnCAccepted=true;$scope.checkEnableOrderButton()};$scope.$on(TransactionConstants.TRANSACTION_ADDRESS_UPDATE_EVENT,function(event,addressType,address){$scope.isUpdateOrderDisabled=false;$scope.NotModify_billingAddress=angular.copy($scope.transaction.billingAddress);$scope.NotModify_shippingAddress=angular.copy($scope.transaction.shippingAddress);if(addressType==TransactionConstants.ADDRESS_TYPE_BILLING){$scope.transaction.billingAddress=address}else{if(addressType==TransactionConstants.ADDRESS_TYPE_SHIPPING){$scope.transaction.shippingAddress=address}}});$scope.enableActionExecution=function(){if($("#triggerPaymentFormChkbox").prop("checked")||$("#triggerPaymentFormEmailChkbox").prop("checked")){$scope.triggerJapanesePaymentForm=$("#triggerPaymentFormChkbox").prop("checked");$scope.triggerJapanesePaymentEmail=$("#triggerPaymentFormEmailChkbox").prop("checked");$scope.isExecuteActionDisabled=false;return}$scope.isExecuteActionDisabled=true};$scope.updateOrder=function(){if($scope.updatedPaymentdetails){$scope.transaction.paymentDetails=$scope.updatedPaymentdetails}var updateOrderTransaction=angular.copy($scope.transaction);$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Update Order Is In Progress",false,false);TransactionService.update(updateOrderTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed",result.messages,true,true);$scope.transaction=angular.copy($scope.originalTransaction)}else{$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Confirmation",result.messages,true,true);$scope.transaction.paymentDetails=result.paymentDetails;$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Update Order Transaction Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.executeAction=function(){var executeOrderTransaction=angular.copy($scope.transaction);executeOrderTransaction.triggerJapanesePaymentEmail=$scope.triggerJapanesePaymentEmail;executeOrderTransaction.triggerJapanesePaymentForm=$scope.triggerJapanesePaymentForm;$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execute Actions","Execute Action Is In Progress",false,false);TransactionService.update(executeOrderTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execution Failed",result.messages,true,true);$scope.transaction=angular.copy($scope.originalTransaction)}else{$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed",result.messages,true,true);$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Execute Action Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.openOrderActionHistoryPreview=function(actionHistoryItem){window.open(actionHistoryItem.previewUrl,"Order Action History","width=1024, height=800, scrollbars=yes")};$scope.checkTnC=function(){var storeType=angular.lowercase($scope.transaction.externalReferenceNo).indexOf("ed")>=0?TransactionConstants.STORE_EDUCATIONAL_TYPE:TransactionConstants.STORE_COMMERCIAL_TYPE;var storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,$scope.transaction.customer.address.country.code,storeType);if($scope.transaction.customer.address.country.code=="DE"){TransactionService.getTnC({sku:$scope.transaction.items[0].sku,storeId:storeMetadata.key,language:"DE"}).success(function(result){var tncText=result;var strRegEx=/<a class="support"/gi;var strRegExEdu=/<a class="edu_eligibility"/gi;tncText=tncText.replace(strRegEx,'<a class="support no-link-show"');$scope.termsAndConditionsText=tncText.replace(strRegExEdu,'<a class="edu_eligibility no-link-show"')}).error(function(result){$scope.termsAndConditionsText=result})}};$scope.showCancelJPOPPendingOrder=function(){var executeOrderTransaction=angular.copy($scope.transaction);$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Cancel Pending Order","Cancel Pending Order Is In Progress",false,false);TransactionService.cancelStoreOrder({orderExtRefNo:executeOrderTransaction.externalReferenceNo}).success(function(result){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed","Order "+executeOrderTransaction.externalReferenceNo+" is cancelled successfully",true,true);$scope.$emit(TransactionConstants.TRANSACTION_CANCEL_JPOP_ORDER_EVENT,true)}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Execute Action Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.updatePayerStateName=function(){if(angular.isDefined($scope.transaction.payerAddress.state)&&angular.isDefined($scope.countrySpecificInfo)){angular.forEach($scope.countrySpecificInfo.statesByCountry,function(stateItem){if($scope.transaction.payerAddress.state==stateItem.id){$scope.transaction.payerAddress.stateName=stateItem.description}})}};$scope.$watch("$scope.transaction.payerAddress.country.code",function(newValue){$scope.transaction.payerAddress.country.name=MetadataService.getCountryNameFromCountry($scope.metadata.countries,$scope.transaction.payerAddress.country.code)});$scope.$watch("$scope.transaction.billingAddress.country.code",function(newValue){$scope.transaction.billingAddress.country.name=MetadataService.getCountryNameFromCountry($scope.metadata.countries,$scope.transaction.billingAddress.country.code)});$scope.getApproveEduOrder=function(data){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Approve EDU Order";$scope.isEduOrderStatus=false;var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.approveEduOrder(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been approved successfully.";$scope.isEduOrderStatus=true}).error(function(errorData){console.log(errorData);$scope.isLoading=false})};$scope.getRejectEduOrder=function(data){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Reject EDU Order";$scope.isEduOrderStatus=false;var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.rejectEduOrder(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been rejected successfully.";$scope.isEduOrderStatus=true}).error(function(errorData){console.log(errorData);$scope.isLoading=false})};$scope.dmOrderApprove=function(){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Manual Order Approval (Decision Manager)";var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.dmOrderApprove(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been approved successfully."}).error(function(errorData){console.log(errorData);$scope.approveRejectEduOrderSuccessMessage="Could not approve the order. Please try again.";$scope.isLoading=false})};$scope.dmOrderReject=function(){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Manual Order Rejection (Decision Manager)";var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.dmOrderReject(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been rejected successfully."}).error(function(errorData){console.log(errorData);$scope.approveRejectEduOrderSuccessMessage="Could not reject the order. Please try again.";$scope.isLoading=false})}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngDylanOrderActions",["$rootScope","$location","TransactionService","AppUtils","TransactionConstants","DylanOrderAddressModel","MetadataService",function($rootScope,$location,TransactionService,AppUtils,TransactionConstants,DylanOrderAddressModel,MetadataService){return{restrict:"EA",replace:true,templateUrl:"js/transaction/dylan-order/partials/dylan-order-actions.html",link:function($scope,element,attrs){$scope.defaultValidationFields=["firstName","lastName","city","state","postCode","country","email"];$scope.editBillingValidations=_.has(hendrixConfig,"unifiedCheckout")?hendrixConfig.unifiedCheckout.editBillingAddressValidations:{};$scope.orderAddress={};$scope.orderAddress.email="";$scope.orderAddress.country={};$scope.orderAddress.country.name="";$scope.orderAddress.postalCode="";$scope.orderAddress.street1="";$scope.orderAddress.lastName="";$scope.orderAddress.firstName="";$scope.orderAddress.city="";$scope.orderAddress.stateProvince={};$scope.orderAddress.stateProvince.code="";$scope.showGSTOptions=false;$scope.gstRegxPattern=/^\d{2,3}-?\d{3}-?\d{3}$/;$scope.isGSTFormatValid=true;$scope.resendStoreEmailAct=function(){$scope.orderNumber=$scope.transaction.externalReferenceNo;$scope.orderEmail=$scope.transaction.customer.adobeId;$scope.productName=[];$scope.isResendStoreEmailLoading=true;$scope.resendStoreEmailProgress=false;$scope.resendStoreEmailSuccess=false;$scope.emailTemplates=[];$scope.emailTemplates.push({Code:TransactionConstants.EMAIL_TEMPLATE_CODE_ORDER,Desc:TransactionConstants.EMAIL_TEMPLATE_DESC_ORDER});$scope.esdProductType=true;$scope.selectedEmailTemplate="";$scope.modalMessages="";if($scope.transaction.items.length){for(i=0;i<$scope.transaction.items.length;i++){$scope.productName.push($scope.transaction.items[i].NewProp_productName);$scope.transaction.items[i].isSelected=true;if($scope.transaction.items[i].productType==TransactionConstants.ESD_PRODUCT_TYPE_UNCLASSIFIED&&$scope.esdProductType){$scope.esdProductType=false;$scope.emailTemplates.push({Code:TransactionConstants.EMAIL_TEMPLATE_CODE_ESD,Desc:TransactionConstants.EMAIL_TEMPLATE_DESC_ESD})}}if($scope.esdProductType){$scope.selectedEmailTemplate=TransactionConstants.EMAIL_TEMPLATE_CODE_ORDER}}$("#resendStoreEmailModal").modal("show")};$scope.cancelResendStoreEmailModel=function(){$scope.modalMessages="";$("#resendStoreEmailModal").modal("hide")};$scope.isFormValidate=function(){$scope.itemList=$scope.selectedItemList();return $scope.orderNumber&&$scope.orderEmail&&$scope.selectedEmailTemplate&&$scope.validateEmail($scope.orderEmail)&&$scope.itemList.length};$scope.validateEmail=function(email){var re=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;return re.test(email)};$scope.resendStoreEmail=function(){$scope.isResendStoreEmailLoading=false;console.log($scope.orderNumber);console.log($scope.orderEmail);console.log($scope.selectedEmailTemplate);$scope.itemList=$scope.selectedItemList();console.log($scope.itemList);$scope.resendStoreEmailProgress=true;TransactionService.resendStoreEmail({orderExtRefNo:$scope.orderNumber,emailAddress:$scope.orderEmail,emailTemplate:$scope.selectedEmailTemplate,itemList:$scope.itemList}).success(function(result){$scope.resendStoreEmailSuccess=true;$scope.resendStoreEmailProgress=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_SUCCESS_TYPE,"Successfully sent the Store Email.")}).error(function(result){$scope.resendStoreEmailProgress=false;console.log("resendStoreEmail : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to sent Store Email.")})};$scope.selectedItemList=function(){var j=$scope.transaction.items.length;$scope.selectedItemsList=[];while(j--){if($scope.transaction.items[j].isSelected){if($scope.selectedItemsList.length==0){$scope.selectedItemsList=$scope.transaction.items[j].id}else{$scope.selectedItemsList=$scope.selectedItemsList.toString()+","+$scope.transaction.items[j].id}}}return $scope.selectedItemsList};$scope.resendToCrmModal=function(){$scope.isResendToCrmProgress=false;$scope.modalMessages="";$scope.isResendToCrmSuccess=false;$("#resendToCrmModal").modal("show")};$scope.listOfPaymentsModal=function(){$("#listOfPayments").modal("show");$scope.showLoading=true;$scope.showNoTransmitRow=true;var orderExtRefNo=$scope.transaction.externalReferenceNo;TransactionService.getPaymentList(orderExtRefNo).success(function(result){$scope.showLoading=false;$scope.paymentList=result;var paymentListRecords=$scope.paymentList["PaymentRequest[]"];for(var i in paymentListRecords){if(paymentListRecords[i].invoice&&paymentListRecords[i].invoice.erp_transmit_date){$scope.showNoTransmitRow=false;break}}}).error(function(){$scope.showLoading=false})};$scope.closeListOfPaymentsModal=function(){if(!$scope.addUrlParams){$("#listOfPayments").modal("hide")}else{$("#listOfPayments").modal("hide");$location.search("");$location.search("commerce","true");window.location.reload()}};$scope.cancelResendToCrm=function(){$scope.modalMessages="";$("#resendToCrmModal").modal("hide")};$scope.resendToCrm=function(){console.log($scope.transaction.externalReferenceNo);$scope.isResendToCrmProgress=true;TransactionService.resendOrderToCRM({orderExtRefNo:$scope.transaction.externalReferenceNo}).success(function(result,status){if(status==200){$scope.isResendToCrmSuccess=true;$scope.isResendToCrmProgress=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_SUCCESS_TYPE,"Order successfully flagged for transmission to CRM; Order will be available in CRM within 1 hour.")}else{$scope.isResendToCrmProgress=false;console.log("resendOrderToCRM : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to re-send to CRM.")}}).error(function(result){$scope.isResendToCrmProgress=false;console.log("resendOrderToCRM : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to re-send to CRM.")})};$scope.checkGSTDisplay=function(){$scope.showGSTOptions=false;if($scope.transaction.customer.address.country.code.toUpperCase()=="NZ"){$scope.showGSTOptions=true}};$scope.$watch("orderAddress.vatId",function(){$scope.isGSTFormatValid=true;if(angular.isDefined($scope.orderAddress.vatId)&&$scope.orderAddress.vatId.length>0&&$scope.transaction.customer.address.country.code.toUpperCase()=="NZ"){var returnResult=$scope.gstRegxPattern.test($scope.orderAddress.vatId);if(!returnResult){$scope.isGSTFormatValid=returnResult}}},true);$scope.$watch("orderAddress.stateProvince.code",function(){if(angular.isDefined($scope.orderAddress)&&angular.isDefined($scope.orderAddress.stateProvince)&&angular.isDefined($scope.orderAddress.stateProvince.code)){$scope.orderAddress.state=$scope.orderAddress.stateProvince.code}},true);$scope.$watch("orderAddress.postalCode",function(){if(angular.isDefined($scope.orderAddress)&&angular.isDefined($scope.orderAddress.postalCode)){$scope.orderAddress.postCode=$scope.orderAddress.postalCode}},true);$scope.editOrderAddressModal=function(){$scope.getBillingValidationObj();$scope.isEditOrderAddressLoading=true;$scope.isSaving=false;$scope.isResendToCrmSuccess=false;$scope.isValidVatIdCountry=false;$scope.isAddressReadOnly=false;$("#editDylanOrderAddressModal").modal("show");console.log($scope.transaction.externalReferenceNo);$scope.checkGSTDisplay();TransactionService.getEcommOrderDetails({orderExtRefNo:$scope.transaction.externalReferenceNo}).success(function(resultOrderDetails,status){if(status==200){MetadataService.getVatOptions().success(function(resultVatOptions,status){if(status==200){console.log(resultVatOptions);$scope.isEditOrderAddressLoading=false;$scope.dylanOrderAddress=resultOrderDetails["order.order"]["order.paymentRequest"][0]["paymentRequest.paymentInstrument"]["paymentInstrument.assignedAddress"];$scope.orderId=resultOrderDetails["order.order"]["order.id"];$scope.orderAddress=new DylanOrderAddressModel($scope.dylanOrderAddress);if(angular.isDefined($scope.orderAddress.stateProvince)&&angular.isDefined($scope.orderAddress.stateProvince.code)){$scope.orderAddress.state=$scope.orderAddress.stateProvince.code}if(angular.isDefined($scope.orderAddress.postalCode)){$scope.orderAddress.postCode=$scope.orderAddress.postalCode}$scope.countryCode=$scope.orderAddress.country.alpha2_code+"0";for(j=0;j<resultVatOptions.length;j++){if($scope.countryCode==resultVatOptions[j].code||$scope.countryCode=="NZ0"){$scope.isValidVatIdCountry=true;break}}console.log($scope.orderAddress)}}).error(function(result){console.log("getEcommOrderDetails : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to get Ecomm Order Details.")})}else{console.log("getEcommOrderDetails : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to get Ecomm Order Details.")}}).error(function(result){console.log("getEcommOrderDetails : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to get Ecomm Order Details.")})};$scope.getBillingValidationObj=function(){try{var validatonParams={countryCode:$scope.transaction.billingAddress.country.code.toLowerCase(),paymentMethod:$scope.transaction.paymentDetails.paymentType,productType:isTeamProduct()?"TEAM":"INDIVIDUAL"};console.log("Billing validation parameters\n",validatonParams);$scope.billingValidationFields=_.find($scope.editBillingValidations,function(obj){if(obj.countryCodes.indexOf(validatonParams.countryCode)!==-1&&obj.paymentMethods.indexOf(validatonParams.paymentMethod)!==-1&&obj.productType===validatonParams.productType){return obj}});if(angular.isDefined($scope.billingValidationFields)){$scope.requiredFields=$scope.billingValidationFields.requiredFieldsCommerceFlow;console.log("billingValidationFields\n",$scope.billingValidationFields)}else{$scope.requiredFields=$scope.defaultValidationFields;if(isTeamProduct()&&$scope.requiredFields.indexOf("companyName")==-1){$scope.requiredFields.push("companyName")}console.log("No config found for billingValidationFields, applying default validations")}}catch(error){console.log("Found error in loading UC validations from config",error);$scope.requiredFields=$scope.defaultValidationFields;if(isTeamProduct()&&$scope.requiredFields.indexOf("companyName")==-1){$scope.requiredFields.push("companyName")}}console.log("Required Fields are\n",$scope.requiredFields)};var isTeamProduct=function(){var isTeam=false;_.each($scope.transaction.items,function(obj){if(obj.productType.indexOf("CCT")>-1||obj.productType.indexOf("CCMT")>-1){isTeam=true}});return isTeam};$scope.cancelOrderAddressModal=function(){$scope.modalMessages="";var className="removeTopBottomPadding";$("#editAddressModalBody").removeClass(className);$("#editDylanOrderAddressModal").modal("hide")};$scope.closeOrderAddressModal=function(){$scope.modalMessages="";var className="removeTopBottomPadding";$("#editAddressModalBody").removeClass(className);$("#editDylanOrderAddressModal").modal("hide");$scope.refreshOrderScreen()};$scope.isValidAddress=function(){if(!$scope.orderAddress){return false}var validationResult=[];if(angular.isDefined($scope.requiredFields)&&$scope.requiredFields.length){for(var i=0;i<$scope.requiredFields.length;i++){validationResult.push(angular.isDefined($scope.orderAddress[$scope.requiredFields[i]])&&$scope.orderAddress[$scope.requiredFields[i]]!=="")}if(_.includes(validationResult,false)){return false}else{return true&&$scope.isGSTFormatValid}}};$scope.isRequired=function(field){return _.includes($scope.requiredFields,field)};$scope.editAddressResendToCrm=function(){$scope.modalMessages="";var className="removeTopBottomPadding";$("#editAddressModalBody").removeClass(className);$scope.resendToCrm()};$scope.updateAddress=function(){$scope.isUpdateAddressProcessing=true;console.log($scope.orderAddress);$scope.stateProvinceName="";for(i=0;i<$scope.countrySpecificInfo.statesByCountry.length;i++){if($scope.countrySpecificInfo.statesByCountry[i].id==$scope.orderAddress.stateProvince.code.toString()){$scope.stateProvinceName=$scope.countrySpecificInfo.statesByCountry[i].description}}TransactionService.editAddress({orderId:$scope.orderId,street1:$scope.orderAddress.street1,city:$scope.orderAddress.city,country:{name:$scope.orderAddress.country.name,code:$scope.orderAddress.country.alpha2_code},id:$scope.orderAddress.addressId,"postal-code":$scope.orderAddress.postalCode,"state-province":{code:$scope.orderAddress.stateProvince.code,name:$scope.stateProvinceName},street2:$scope.orderAddress.street2,street3:$scope.orderAddress.street3,street4:$scope.orderAddress.street4,contact:{id:$scope.orderAddress.contactId,"first-name":$scope.orderAddress.firstName,"last-name":$scope.orderAddress.lastName,"primary-phone":$scope.orderAddress.phone,"cellular-phone":$scope.orderAddress.cell,"primary-email":$scope.orderAddress.email,"company-name":$scope.orderAddress.companyName,"vat-id":$scope.orderAddress.vatId,department:$scope.orderAddress.department,"pronunciation-company-name":$scope.orderAddress.pronunciationCompanyName,"pronunciation-first-name":$scope.orderAddress.pronunciationFirstName,"pronunciation-last-name":$scope.orderAddress.pronunciationLastName}}).success(function(result,status){if(status==200){var className="removeTopBottomPadding";$("#editAddressModalBody").addClass(className);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_SUCCESS_TYPE,'Successfully updated the Billing and Shipping address in Commerce. Please use "Resend to CRM" to replicate the changes to CRM.');$scope.isSaving=true;$scope.isUpdateAddressProcessing=false;$scope.isAddressReadOnly=true}else{console.log("editAddress : "+result);$scope.isSaving=false;$scope.isUpdateAddressProcessing=false;$scope.isAddressReadOnly=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to update address details.")}}).error(function(errorResult){console.log("editAddress : "+errorResult);$scope.isSaving=false;$scope.isUpdateAddressProcessing=false;$scope.isAddressReadOnly=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to update address details. "+errorResult.error)})};$rootScope.$on(TransactionConstants.PAYMENT_REQUEST_SUCCESS,function(success,paymentSuccessMessage){$scope.paymentRequestErrorMessage="";$scope.paymentRequestSuccessMessage=paymentSuccessMessage});$rootScope.$on(TransactionConstants.PAYMENT_REQUEST_ERROR,function(error,paymentErrorResult,paymentErrorMessage){$scope.paymentRequestSuccessMessage="";$scope.paymentRequestErrorMessage="["+paymentErrorResult.error+"] "+paymentErrorMessage});if(location.hash.contains("payment-request-id")){$scope.setActionsForPaymentId=location.hash.split("payment-request-id=")[1].split("&")[0];$scope.addUrlParams=true;$scope.listOfPaymentsModal()}else{$scope.setActionsForPaymentId="";$scope.addUrlParams=false}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngEditCustomer",["$filter","Utils","MetadataService","CustomerRecordService","TrackingService","$location","AddressValidationService","ImsCustomerService","LocalStorageService","AppUtils","CustomerConstants",function($filter,Utils,MetadataService,CustomerRecordService,TrackingService,$location,AddressValidationService,ImsCustomerService,LocalStorageService,AppUtils,CustomerConstants){return{restrict:"EA",scope:{customer:"=",imscustomer:"=",metadata:"=",customerlocked:"="},replace:true,templateUrl:"js/customer/partials/edit-customer.html",link:function(scope,element,attrs){scope.step=1;scope.messages=[];scope.canViewCreateButton=false;scope.isCountryJP=false;scope.showVatOptions=false;scope.showGSTOptions=false;scope.gstRegxPattern=/^\d{2,3}-?\d{3}-?\d{3}$/;scope.isGSTFormatValid=true;scope.isCustomerLocked=function(){return scope.customerlocked};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};var offset=50;var offsetBody=150;var newSize=offset*2;$("#editCustomerModal").css({height:size.height-newSize});$("#editCustomerModal .modal-body").css({height:size.height-(newSize+offsetBody-52),"max-height":"none","overflow-x":"hidden"});$("#editCustomerModal").css("top",offset)};scope.showModal=function(){CustomerRecordService.customerLock({customerNo:scope.customer.customerNo,flag:"L"}).success(function(result){if(result&&result.length>0&&result[0].type=="E"&&result[0].number=="38"){element.find("#showLockedCustomerMessage").modal("show");scope.messages=result}else{$("body").css("overflow","hidden");scope.messages=[];scope.checkVatDisplay();scope.checkGSTDisplay();if(scope.customer.address.country.code=="JP"){scope.isCountryJP=true}else{scope.isCountryJP=false}element.find("#editCustomerModal").modal("show");element.find("#editCustomerModal").scroll(function(){if($(document).find(".bootstrap-maxlength")){$(document).find(".bootstrap-maxlength").hide()}});if(scope.metadata){scope.marketingOptinInformation=[];scope.marketingProfileInformation=[];scope.customer.address.country.name="";scope.marketingOptinInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.customer.address.country.code,true);scope.marketingProfileInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.customer.address.country.code,false);scope.customer.address.country.name=MetadataService.getCountryNameFromCountry(scope.metadata.countries,scope.customer.address.country.code)}if(scope.metadata&&scope.metadata.allStates){scope.allStates=MetadataService.getStatesFromMetadata(scope.metadata.allStates,scope.customer.address.country.code)}else{MetadataService.getCountrySpecificInfo({countryCode:scope.customer.address.country.code}).success(function(result){scope.allStates=result.statesByCountry})}if(scope.customer.taxInfo&&(scope.customer.taxInfo.taxType==""||scope.customer.taxInfo.taxNumber=="")){scope.customer.taxInfo.taxType="";scope.customer.taxInfo.taxNumber=""}scope.step=1;scope.defaultCustomerData=angular.copy(scope.customer);scope.checkMarketingInfo()}}).error(function(err){console.log("Customer locked failed"+err)})};scope.unlockCustomer=function(){CustomerRecordService.customerLock({customerNo:scope.customer.customerNo,flag:"U"}).success(function(result){console.log("Customer unlocked")}).error(function(err){console.log("Customer unlock failed"+err)})};scope.checkVatDisplay=function(){scope.showVatOptions=false;angular.forEach(scope.metadata.vatOptions,function(vatItem){if(scope.customer.address.country.code&&!scope.showVatOptions){if(vatItem.code.indexOf(scope.customer.address.country.code)!=-1){scope.showVatOptions=true}}})};scope.checkGSTDisplay=function(){scope.showGSTOptions=false;if(scope.customer.address.country.code.toUpperCase()=="NZ"){scope.customer.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;scope.showGSTOptions=true}};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#editCustomerModal").modal("hide");scope.customer=angular.copy(scope.defaultCustomerData);scope.unlockCustomer()};scope.closeUpdateModal=function(){$("body").css("overflow","auto");element.find("#editCustomerModal").modal("hide");scope.unlockCustomer()};scope.handleCreate=function(){scope.isSaving=true;delete scope.customer.person;delete scope.customer.messages;angular.forEach(scope.customer.customerRelations,function(cr){delete cr.fax;delete cr.faxExt;delete cr.contactFunction;delete cr.title;delete cr.department;delete cr.dayPhone;delete cr.searchableContent});scope.selectedMarkeitngInformation=[];angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values[0].selected=="no"){var objectToPushNo=angular.copy(marketingOptInItem.values[0]);delete objectToPushNo.selected;scope.selectedMarkeitngInformation.push(objectToPushNo)}else{if(marketingOptInItem.values[1].selected=="yes"){var objectToPushYes=angular.copy(marketingOptInItem.values[1]);delete objectToPushYes.selected;scope.selectedMarkeitngInformation.push(objectToPushYes)}}});scope.selectedMarkeitngProfile=[];angular.forEach(scope.marketingProfileInformation,function(marketingProfileItem){angular.forEach(marketingProfileItem.values,function(marketingProfileOptionItem){if(scope.marketingProfile0&&scope.marketingProfile0.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile0.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile1&&scope.marketingProfile1.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile1.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile2&&scope.marketingProfile2.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile2.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile3&&scope.marketingProfile3.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile3.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile4&&scope.marketingProfile4.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile4.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile5&&scope.marketingProfile5.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile5.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}}}}}}})});scope.customer.billingAddress=scope.customer.address;scope.customer.shippingAddress=scope.customer.address;scope.customer.marketingValues=$.merge(scope.selectedMarkeitngInformation,scope.selectedMarkeitngProfile);var editCustomer=angular.copy(scope.customer);if(editCustomer.memoNotes){angular.forEach(editCustomer.memoNotes,function(memoItem){delete memoItem.typeName})}if(editCustomer.taxInfo.taxNumber==""||!editCustomer.taxInfo.taxNumber){editCustomer.taxInfo.taxType=""}if(editCustomer.taxInfo&&angular.isDefined(editCustomer.taxInfo.taxNumber)&&editCustomer.taxInfo.taxNumber.length==0){editCustomer.taxInfo.taxType=""}CustomerRecordService.updateItem(editCustomer).success(function(result){scope.isSaving=false;if(Utils.hasErrors(result.messages)){scope.messages=result.messages;scope.step=1}else{if(!Utils.hasErrors(result.messages)){scope.closeUpdateModal();scope.customer=result;scope.customer.adobeId=scope.customer.email;scope.customer.isCommercialStoreSellable=AppUtils.isCommercialStore(scope.customer.address.country.code);scope.customer.isEducationalStoreSellable=AppUtils.isEducationalStore(scope.customer.address.country.code);scope.customer.isDRStoreSellable=AppUtils.isLaunchDRStoreEnable(scope.customer.address.country);scope.customer.isDRCctStoreSellable=AppUtils.isLaunchCctDRStoreEnable(scope.customer.address.country);$location.path("/customer/"+result.customerNo);if(scope.$parent){result.isCommercialStoreSellable=AppUtils.isCommercialStore(scope.customer.address.country.code);result.isEducationalStoreSellable=AppUtils.isEducationalStore(scope.customer.address.country.code);result.isDRStoreSellable=AppUtils.isLaunchDRStoreEnable(scope.customer.address.country);result.isDRCctStoreSellable=AppUtils.isLaunchCctDRStoreEnable(scope.customer.address.country);scope.$parent.customer=result;scope.$parent.customer.messages=result.messages;scope.$parent.$parent.initCustomer()}}}}).error(function(result){if(Utils.hasErrors(result.messages)){scope.messages=result.messages}else{scope.messages=[Utils.errorMsg("Failed to update!")]}scope.isSaving=false})};scope.$watch("customer.address.country.code",function(value){if(!value){return}if(scope.metadata&&scope.metadata.allStates){scope.allStates=scope.metadata.allStates}else{MetadataService.getCountrySpecificInfo({countryCode:value}).success(function(result){scope.allStates=result.statesByCountry})}var marketingAttrCountryCode="";var locallyStoredLanguage=LocalStorageService.get("language");if(locallyStoredLanguage=="EN"&&value=="JP"){marketingAttrCountryCode="US"}else{marketingAttrCountryCode=value}if(scope.metadata){scope.marketingOptinInformation=[];scope.marketingProfileInformation=[];scope.customer.address.country.name="";scope.marketingOptinInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,marketingAttrCountryCode,true);scope.marketingProfileInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,marketingAttrCountryCode,false);scope.customer.address.country.name=MetadataService.getCountryNameFromCountry(scope.metadata.countries,scope.customer.address.country.code)}});scope.$watch("customer.address.state",function(newValue){if(angular.isDefined(newValue)&&angular.isDefined(scope.allStates)){scope.customer.address.stateName=MetadataService.findResult(scope.allStates,scope.customer.address.country.code,scope.customer.address.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}});scope.$watch("customer.outputLanguage",function(value){if(!scope.customer){return}if(!value){return scope.customer.isCountryLanguageMismatch=true}scope.customer.isCountryLanguageMismatch=scope.customer.defaultCountryLanguage.toUpperCase()!=scope.customer.outputLanguage.toUpperCase()?true:false});scope.isValid=function(customer){var returnResult=false;scope.isGSTFormatValid=true;if(!customer){return returnResult=false}if(customer.firstName&&customer.lastName){returnResult=true;var customerEmail=$("#editCustomerEmail").val();if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){return returnResult=false}}}if(customer.address&&(customer.address.city||customer.address.postCode)&&!customer.address.state){$("#stateRegionContainer").find("a").css({border:"1px solid red"});return returnResult=false}else{$("#stateRegionContainer").find("a").css({border:"1px solid #ccc"})}try{if(scope.customer&&scope.customer.address&&scope.customer.address.country&&scope.customer.address.country.code&&scope.customer.address.country.code.toUpperCase()=="NZ"){scope.customer.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;scope.showGSTOptions=true}}catch(e){console.log(e)}if(customer.taxInfo&&customer.taxInfo.taxType&&customer.taxInfo.taxType==CustomerConstants.GST_NZ_CODE){if(angular.isDefined(customer.taxInfo.taxNumber)&&customer.taxInfo.taxNumber.length>0){returnResult=scope.gstRegxPattern.test(customer.taxInfo.taxNumber);if(!returnResult){scope.isGSTFormatValid=returnResult}}}else{if(customer.taxInfo&&customer.taxInfo.taxType&&!customer.taxInfo.taxNumber){return returnResult=false}else{if(customer.taxInfo&&!customer.taxInfo.taxType&&customer.taxInfo.taxNumber){return returnResult=false}}}return returnResult};scope.handleValidateAddress=function(){scope.step=2;scope.isValidatingAddress=true;scope.canViewCreateButton=false;scope.fadeTo("#postalStandardSerivceAddress",0.4);scope.fadeTo("#originalAddress",0.4);scope.adddressValidationMessages=[];scope.validateCorrectStreetOption();AddressValidationService.validate(scope.customer.address).success(function(result){scope.fadeTo("#postalStandardSerivceAddress",1);scope.fadeTo("#originalAddress",1);if(result.finalProposal){result.finalProposal.country=scope.customer.address.country;if(!result.finalProposal.stateName){result.finalProposal.stateName=MetadataService.findResult(scope.allStates,result.finalProposal.country.code,result.finalProposal.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}}scope.isValidatingAddress=false;scope.suggestions=result.suggestions;scope.pssa=result.finalProposal;if(scope.customer.address.country.code=="JP"){scope.pssa=scope.customer.address}if(result.message!=null){scope.adddressValidationMessages=[];scope.adddressValidationMessages.push(result.message)}}).error(function(result){scope.isValidatingAddress=false})};scope.handleValidateOwnAddress=function(){scope.canViewCreateButton=true;scope.fadeTo("#postalStandardSerivceAddress",0.4);scope.fadeTo("#originalAddress",1)};scope.fadeTo=function(el,level){$(el).fadeTo("fast",level)};scope.handleValidateNewAddress=function(){scope.canViewCreateButton=true;scope.replaceCorrectStreetNo();scope.customer.address=scope.pssa;scope.customer.address=scope.pssa;scope.fadeTo("#postalStandardSerivceAddress",1);scope.fadeTo("#originalAddress",0.4)};scope.selectedMarketingItem=function(item,selectedValue){if(selectedValue=="no"){item[0].selected="no";item[1].selected=""}else{if(selectedValue=="yes"){item[0].selected="";item[1].selected="yes"}}scope.unSelectNoValue="";scope.unSelectYesValue=""};scope.checkSelectAll=function(checkAllValue){if(checkAllValue=="no"){scope.unSelectNoValue="no";scope.unSelectYesValue=""}else{scope.unSelectNoValue="";scope.unSelectYesValue="yes"}angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values[0].description.toLowerCase()==checkAllValue||checkAllValue=="no"){marketingOptInItem.values[0].selected="no";marketingOptInItem.values[1].selected=""}if(marketingOptInItem.values[1].description.toLowerCase()==checkAllValue||checkAllValue=="yes"){marketingOptInItem.values[0].selected="";marketingOptInItem.values[1].selected="yes"}})};scope.marketingProfile0={};scope.marketingProfile1={};scope.marketingProfile2={};scope.marketingProfile3={};scope.marketingProfile4={};scope.marketingProfile5={};scope.checkMarketingInfo=function(){scope.unSelectNoValue="";scope.unSelectYesValue="";angular.forEach(scope.customer.marketingValues,function(customerMarketingOptInItem){angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(customerMarketingOptInItem.code==marketingOptInItem.code){if(customerMarketingOptInItem.value==marketingOptInItem.values[0].value&&customerMarketingOptInItem.description.toLowerCase()==marketingOptInItem.values[0].description.toLowerCase()){marketingOptInItem.values[0].selected="no"}if(customerMarketingOptInItem.value==marketingOptInItem.values[1].value&&customerMarketingOptInItem.description.toLowerCase()==marketingOptInItem.values[1].description.toLowerCase()){marketingOptInItem.values[1].selected="yes"}}});for(var i=0;i<scope.marketingProfileInformation.length;i++){var marketingProfileItem=scope.marketingProfileInformation[i];if(customerMarketingOptInItem.code==marketingProfileItem.code){if(customerMarketingOptInItem.description!=null||customerMarketingOptInItem.value!=""){switch(i){case 0:scope.marketingProfile0.value=customerMarketingOptInItem.value;break;case 1:scope.marketingProfile1.value=customerMarketingOptInItem.value;break;case 2:scope.marketingProfile2.value=customerMarketingOptInItem.value;break;case 3:scope.marketingProfile3.value=customerMarketingOptInItem.value;break;case 4:scope.marketingProfile4.value=customerMarketingOptInItem.value;break;case 5:scope.marketingProfile5.value=customerMarketingOptInItem.value;break}}}}})};scope.handleMarketingProfileSelect=function(selectedRecord,selectedProfileItem){if(selectedRecord.selected==""){scope.selectedMarkeitngProfile.push(selectedProfileItem);selectedRecord.selected="combo"}else{if(selectedRecord.selected=="combo"){angular.forEach(scope.selectedMarkeitngProfile,function(marketingProfileItem){if(marketingProfileItem.code==selectedProfileItem.code){marketingProfileItem.description=selectedProfileItem.description;marketingProfileItem.value=selectedProfileItem.value}})}}};scope.resetPassword=function(){ImsCustomerService.resetPassword({email:scope.customer.email,language:scope.customer.defaultCountryLanguage}).success(function(result){console.log("Success -> Password Reset Email");if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Password Reset Email Sent Successfully")}}}).error(function(error){console.log("error",error)})};scope.verifyEmail=function(){ImsCustomerService.verifyEmail({email:scope.customer.email}).success(function(result){console.log("Success -> Email Verification Service");if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Email Verification Email Sent Successfully")}else{if(result.status=="EMAIL_NOT_SENT_ALREADY_VERIFIED"){scope.messages=Utils.showMessage("info","Email is already verified in the system")}}}}).error(function(error){console.log("error",error)})};scope.isVATTypeMismatched=false;scope.$watch("customer.taxInfo.taxType",function(value){if(!scope.customer){return}if(scope.customer.taxInfo&&scope.customer.address.country&&scope.metadata.vatOptions){scope.isVATTypeMismatched=(MetadataService.getDefaultVATOptionFromMetadata(scope.metadata.vatOptions,scope.customer.address.country.code)!=scope.customer.taxInfo.taxType)?true:false}});scope.resetDefaultVatType=function(){if(scope.customer.taxInfo&&scope.customer.address.country){scope.customer.taxInfo.taxType=MetadataService.getDefaultVATOptionFromMetadata(scope.metadata.vatOptions,scope.customer.address.country.code)}};scope.clearVat=function(){if(scope.customer.taxInfo){scope.customer.taxInfo.taxType="";scope.customer.taxInfo.taxNumber=""}};scope.isCorrectStreetOptionVisible=false;scope.validateCorrectStreetOption=function(){scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber(scope.customer.address)};scope.correctStreetNo="";scope.updateCorrectStreetNo=function(correctStreetNo){scope.correctStreetNo=correctStreetNo};scope.replaceCorrectStreetNo=function(){if(scope.correctStreetNo&&scope.correctStreetNo!=""){scope.pssa=AppUtils.getReplacedStreet1Address(scope.correctStreetNo,scope.pssa)}scope.correctStreetNo=""}}}}]);var app=app||angular.module("kamrad.directive",[]);app.directive("editMarketingAttributes",["$filter","Utils","MetadataService","CustomerRecordService","TrackingService","$location","AddressValidationService","ImsCustomerService","LocalStorageService","$timeout",function($filter,Utils,MetadataService,CustomerRecordService,TrackingService,$location,AddressValidationService,ImsCustomerService,LocalStorageService,$timeout){return{restrict:"EA",scope:{customer:"=",imscustomer:"=",metadata:"=",customerlocked:"=",headerdisplay:"="},replace:true,templateUrl:"js/customer/partials/edit-marketing-customer.html",link:function(scope,element,attrs){element.bind("click",function(e){e.stopPropagation()});scope.messages=[];scope.canViewCreateButton=false;scope.isCountryJP=false;scope.showVatOptions=false;scope.isCountryJP=false;scope.isNoneMaintained=function(){if(scope.customer&&scope.customer.marketingValues&&scope.customer.marketingValues.length==0){return true}else{return false}};scope.isCustomerLocked=function(){return scope.customerlocked};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};var offset=10;var offsetBody=150;var newSize=offset*2;$("#editMarketingAttributesModal").css({height:size.height-newSize,"overflow-y":"hidden !important"});$("#editMarketingAttributesModal .modal-dialog").css({width:"875px","margin-top":"25px"})};scope.showModal=function(){console.log("please maintain");scope.messages=[];scope.isCountryJP=false;element.find("#editMarketingAttributesModal").modal("show");(scope.customer.address&&scope.customer.address.country.code=="JP")?scope.isCountryJP=true:scope.isCountryJP=false;if(scope.metadata){scope.marketingOptinInformation=[];scope.marketingProfileInformation=[];scope.marketingOptinInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.customer.address.country.code,true);scope.marketingProfileInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.customer.address.country.code,false)}scope.rescale();$(window).bind("resize",scope.rescale);scope.defaultCustomerData=angular.copy(scope.customer);scope.checkMarketingInfo()};scope.unlockCustomer=function(){CustomerRecordService.customerLock({customerNo:scope.customer.customerNo,flag:"U"}).success(function(result){console.log("Customer unlocked")}).error(function(err){console.log("Customer unlock failed"+err)})};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#editMarketingAttributesModal").modal("hide");scope.customer=angular.copy(scope.defaultCustomerData);scope.unlockCustomer()};scope.closeUpdateModal=function(){$("body").css("overflow","auto");element.find("#editMarketingAttributesModal").modal("hide");scope.unlockCustomer()};scope.filterMarketingOptionsList=function(optsInInfo){var filteredList=[];angular.forEach(optsInInfo,function(cr){})};scope.handleSave=function(){scope.isSaving=true;delete scope.customer.person;delete scope.customer.messages;angular.forEach(scope.customer.customerRelations,function(cr){delete cr.fax;delete cr.faxExt;delete cr.contactFunction;delete cr.title;delete cr.department;delete cr.dayPhone;delete cr.searchableContent});scope.selectedMarkeitngInformation=[];angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values&&marketingOptInItem.values[0].selected=="no"){var objectToPushNo=angular.copy(marketingOptInItem.values[0]);delete objectToPushNo.selected;scope.selectedMarkeitngInformation.push(objectToPushNo)}else{if(marketingOptInItem.values&&marketingOptInItem.values[1].selected=="yes"){var objectToPushYes=angular.copy(marketingOptInItem.values[1]);delete objectToPushYes.selected;scope.selectedMarkeitngInformation.push(objectToPushYes)}}});scope.selectedMarkeitngProfile=[];angular.forEach(scope.marketingProfileInformation,function(marketingProfileItem){angular.forEach(marketingProfileItem.values,function(marketingProfileOptionItem){if(scope.marketingProfile0&&scope.marketingProfile0.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile0.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile1&&scope.marketingProfile1.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile1.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile2&&scope.marketingProfile2.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile2.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile3&&scope.marketingProfile3.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile3.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile4&&scope.marketingProfile4.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile4.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if(scope.marketingProfile5&&scope.marketingProfile5.value!=""&&marketingProfileOptionItem.value==scope.marketingProfile5.value){scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}}}}}}})});scope.customer.billingAddress=scope.customer.address;scope.customer.shippingAddress=scope.customer.address;scope.customer.marketingValues=$.merge(scope.selectedMarkeitngInformation,scope.selectedMarkeitngProfile);var editCustomer=angular.copy(scope.customer);if(editCustomer.memoNotes){angular.forEach(editCustomer.memoNotes,function(memoItem){delete memoItem.typeName})}CustomerRecordService.updateItem(editCustomer).success(function(result){scope.isSaving=false;if(Utils.hasErrors(result.messages)){scope.messages=result.messages;scope.step=1}else{if(!Utils.hasErrors(result.messages)){scope.closeUpdateModal();scope.customer.adobeId=scope.customer.email;$location.path("/customer/"+result.customerNo);if(scope.$parent){scope.$parent.customer.messages=result.messages;scope.$parent.$parent.initCustomer()}}}}).error(function(result){if(Utils.hasErrors(result.messages)){scope.messages=result.messages}else{scope.messages=[Utils.errorMsg("Failed to update!")]}scope.isSaving=false})};scope.$watch("customer.address.state",function(newValue){if(angular.isDefined(newValue)&&angular.isDefined(scope.countrySpecificInfo)){angular.forEach(scope.countrySpecificInfo.statesByCountry,function(stateItem){if(newValue==stateItem.id){scope.customer.address.stateName=stateItem.description}})}});scope.$watch("customer.outputLanguage",function(value){if(!scope.customer){return}if(!value){return scope.customer.isCountryLanguageMismatch=true}scope.customer.isCountryLanguageMismatch=scope.customer.defaultCountryLanguage.toUpperCase()!=scope.customer.outputLanguage.toUpperCase()?true:false});scope.isValid=function(customer){var returnResult=false;if(!customer){returnResult=false;return returnResult}if(customer.firstName&&customer.lastName){returnResult=true;var customerEmail=$("#editCustomerEmail").val();if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length){returnResult=false}}}return returnResult};scope.fadeTo=function(el,level){$(el).fadeTo("fast",level)};scope.selectedMarketingItem=function(item,selectedValue){if(selectedValue=="no"){item[0].selected="no";item[1].selected=""}else{if(selectedValue=="yes"){item[0].selected="";item[1].selected="yes"}}scope.unSelectNoValue="";scope.unSelectYesValue=""};scope.checkSelectAll=function(checkAllValue){if(checkAllValue=="no"){scope.unSelectNoValue="no";scope.unSelectYesValue=""}else{scope.unSelectNoValue="";scope.unSelectYesValue="yes"}angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values[0].description.toLowerCase()==checkAllValue||checkAllValue=="no"){marketingOptInItem.values[0].selected="no";marketingOptInItem.values[1].selected=""}if(marketingOptInItem.values[1].description.toLowerCase()==checkAllValue||checkAllValue=="yes"){marketingOptInItem.values[0].selected="";marketingOptInItem.values[1].selected="yes"}})};scope.marketingProfile0={};scope.marketingProfile1={};scope.marketingProfile2={};scope.marketingProfile3={};scope.marketingProfile4={};scope.marketingProfile5={};scope.checkMarketingInfo=function(){scope.unSelectNoValue="";scope.unSelectYesValue="";$timeout(function(){angular.forEach(scope.customer.marketingValues,function(customerMarketingOptInItem){angular.forEach(scope.marketingOptinInformation,function(marketingOptInItem){if(customerMarketingOptInItem.code==marketingOptInItem.code){if(customerMarketingOptInItem.value==marketingOptInItem.values[0].value){marketingOptInItem.values[0].selected="no"}if(customerMarketingOptInItem.value==marketingOptInItem.values[1].value){marketingOptInItem.values[1].selected="yes"}}});for(var i=0;i<scope.marketingProfileInformation.length;i++){var marketingProfileItem=scope.marketingProfileInformation[i];if(customerMarketingOptInItem.code==marketingProfileItem.code){if(customerMarketingOptInItem.description!=null||customerMarketingOptInItem.value!=""){switch(i){case 0:scope.marketingProfile0.value=customerMarketingOptInItem.value;break;case 1:scope.marketingProfile1.value=customerMarketingOptInItem.value;break;case 2:scope.marketingProfile2.value=customerMarketingOptInItem.value;break;case 3:scope.marketingProfile3.value=customerMarketingOptInItem.value;break;case 4:scope.marketingProfile4.value=customerMarketingOptInItem.value;break;case 5:scope.marketingProfile5.value=customerMarketingOptInItem.value;break}}}}})})};scope.handleMarketingProfileSelect=function(selectedRecord,selectedProfileItem){if(selectedRecord.selected==""){scope.selectedMarkeitngProfile.push(selectedProfileItem);selectedRecord.selected="combo"}else{if(selectedRecord.selected=="combo"){angular.forEach(scope.selectedMarkeitngProfile,function(marketingProfileItem){if(marketingProfileItem.code==selectedProfileItem.code){marketingProfileItem.description=selectedProfileItem.description;marketingProfileItem.value=selectedProfileItem.value}})}}};scope.resetPassword=function(){ImsCustomerService.resetPassword({email:scope.customer.email}).success(function(result){console.log("Success -> Password Reset Email");if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Password Reset Email Sent Successfully")}}}).error(function(error){console.log("error",error)})};scope.verifyEmail=function(){ImsCustomerService.verifyEmail({email:scope.customer.email}).success(function(result){console.log("Success -> Email Verification Service");if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Email Verification Email Sent Successfully")}else{if(result.status=="EMAIL_NOT_SENT_ALREADY_VERIFIED"){scope.messages=Utils.showMessage("info","Email is already verified in the system")}}}}).error(function(error){console.log("error",error)})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngEditOrderAddress",["$filter","MetadataService","CustomerRecordService","TrackingService","$location","AddressValidationService","ImsCustomerService","LocalStorageService","TransactionConstants","AppUtils",function($filter,MetadataService,CustomerRecordService,TrackingService,$location,AddressValidationService,ImsCustomerService,LocalStorageService,TransactionConstants,AppUtils){return{restrict:"EA",scope:{transactionAddress:"=",addressType:"=",metadata:"="},replace:true,templateUrl:"js/transaction/common/partials/dylan-order-edit-address.html",link:function($scope,element,attrs){scope.showModal=function(){$("#editDylanOrderAddressModal").modal("show");scope.step=1}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngModifyAddress",["$filter","MetadataService","CustomerRecordService","TrackingService","$location","AddressValidationService","ImsCustomerService","LocalStorageService","TransactionConstants","AppUtils","PaymentConstants","features",function($filter,MetadataService,CustomerRecordService,TrackingService,$location,AddressValidationService,ImsCustomerService,LocalStorageService,TransactionConstants,AppUtils,PaymentConstants,features){return{restrict:"EA",scope:{transactionAddress:"=",transactionDetails:"=",addressType:"=",metadata:"="},replace:true,templateUrl:"js/transaction/common/partials/edit-billing-shipping-address.html",link:function(scope,element,attrs){scope.address=angular.copy(scope.transactionAddress);scope.step=1;scope.messages=[];scope.isCountryJP=false;scope.isUpdatedAddressSelected=false;scope.defaultValidationFields=["name","city","state","postCode","country","email"];scope.editBillingValidations=_.has(hendrixConfig,"unifiedCheckout")?hendrixConfig.unifiedCheckout.editBillingAddressValidations:{};scope.showModal=function(){$("body").css("overflow","hidden");scope.messages=[];scope.modifyAddress=angular.copy(scope.address);scope.defaultAddress=angular.copy(scope.address);if(scope.address.country.code=="JP"){scope.isCountryJP=true}else{scope.isCountryJP=false}element.find("#modifyShippingOrBillingAddressModal").modal("show");element.find("#modifyShippingOrBillingAddressModal").scroll(function(){if($(document).find(".bootstrap-maxlength")){$(document).find(".bootstrap-maxlength").hide()}});MetadataService.getCountrySpecificInfo({countryCode:scope.address.country.code}).success(function(result){scope.countrySpecificInfo=result});$(window).bind("resize",scope.rescale);scope.step=1;if(features.isFeatureEnabled("uc_editbilling_validations")){scope.getBillingValidationObj()}else{scope.requiredFields=scope.defaultValidationFields}};scope.getBillingValidationObj=function(){var validatonParams={countryCode:scope.address.country.code.toLowerCase(),paymentMethod:scope.transactionDetails.paymentDetails.paymentType,productType:isTeamProduct()?"TEAM":"INDIVIDUAL"};console.log("Billing validation parameters\n",validatonParams);scope.billingValidationFields=_.find(scope.editBillingValidations,function(obj){if(obj.countryCodes.indexOf(validatonParams.countryCode)!==-1&&obj.paymentMethods.indexOf(validatonParams.paymentMethod)!==-1&&obj.productType===validatonParams.productType){return obj}});if(angular.isDefined(scope.billingValidationFields)){scope.requiredFields=scope.billingValidationFields.requiredFields;console.log("billingValidationFields\n",scope.billingValidationFields)}else{scope.requiredFields=scope.defaultValidationFields;console.log("No config found for billingValidationFields, applying default validations")}console.log("Required Fields are\n",scope.requiredFields)};var isTeamProduct=function(){var isTeam=false;_.each(scope.transactionDetails.items,function(obj){if(obj.productType==="CCT"||obj.productType==="CCMT"){isTeam=true}});return isTeam};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#modifyShippingOrBillingAddressModal").modal("hide")};scope.handleModify=function(){scope.isSaving=true;scope.$emit(TransactionConstants.TRANSACTION_ADDRESS_UPDATE_EVENT,scope.addressType,scope.address);scope.isSaving=false;scope.closeModal()};scope.$watch("modifyAddress.country.code",function(value){if(!value){return}if(scope.metadata){angular.forEach(scope.metadata.countries,function(country){if(country.code==scope.address.country.code){scope.modifyAddress.country.name=country.name;return}})}});scope.$watch("modifyAddress.state",function(newValue){if(angular.isDefined(newValue)&&angular.isDefined(scope.countrySpecificInfo)&&newValue!==""){angular.forEach(scope.countrySpecificInfo.statesByCountry,function(stateItem){if(newValue==stateItem.id){scope.modifyAddress.stateName=stateItem.description}})}else{if(angular.isDefined(newValue)&&newValue==""){scope.modifyAddress.stateName=""}}});scope.isValid=function(address){if(!address){return false}var validationResult=[];if(angular.isDefined(scope.requiredFields)&&scope.requiredFields.length){for(var i=0;i<scope.requiredFields.length;i++){validationResult.push(angular.isDefined(address[scope.requiredFields[i]])&&address[scope.requiredFields[i]]!=="")}if(_.includes(validationResult,false)){return false}else{return true}}};scope.isRequired=function(field){return _.includes(scope.requiredFields,field)};scope.handleValidateAddress=function(){if(scope.modifyAddress.country.code=="JP"){var postalCode=scope.modifyAddress.postCode;scope.messages=AppUtils.validatePostalCode(postalCode);if(scope.messages.length>0){return}}scope.step=2;scope.isValidatingAddress=true;scope.pssa=null;$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:0.4});scope.adddressValidationMessages=[];scope.validateCorrectStreetOption();AddressValidationService.validate(scope.modifyAddress).success(function(result){$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:1});if(result.finalProposal){if(!result.finalProposal.stateName){angular.forEach(scope.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}}scope.isValidatingAddress=false;scope.suggestions=result.suggestions;scope.pssa=result.finalProposal;scope.isEnteredAddressValid=true;scope.isSuggestedAddressValid=true;if(scope.modifyAddress.country.code=="JP"){scope.pssa=scope.modifyAddress}if(result.dsStatus&&result.enteredTaxAddrStatus&&result.suggestedTaxAddrStatus){if(result.dsStatus=="E"||result.enteredTaxAddrStatus=="E"){scope.isEnteredAddressValid=false;$("#originalAddress").css({opacity:0.4})}if(result.suggestedTaxAddrStatus=="E"||scope.isSuggestedAddressEmpty(scope.pssa)){scope.isSuggestedAddressValid=false;$("#postalStandardSerivceAddress").css({opacity:0.4})}}if(result.message!=null){scope.adddressValidationMessages=[];scope.adddressValidationMessages.push(result.message)}}).error(function(result){scope.isValidatingAddress=false;scope.isEnteredAddressValid=false;scope.isSuggestedAddressValid=false})};scope.handleValidateOwnAddress=function(){scope.address=scope.modifyAddress;scope.isUpdatedAddressSelected=true;scope.address.country.name=scope.transactionAddress.country.name;$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:1})};scope.handleValidateNewAddress=function(){scope.replaceCorrectStreetNo();scope.address=scope.pssa;scope.address.country.name=scope.transactionAddress.country.name;$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:0.4});scope.isUpdatedAddressSelected=true};scope.isSuggestedAddressEmpty=function(address){var isAddressEmpty=false;if(address.addressNo==""&&address.city==""&&(address.country&&address.country.code=="")&&address.district==""&&address.homeCity==""&&address.postCode==""&&address.state==""&&address.street1==""&&address.street2==""&&address.street3==""){isAddressEmpty=true}return isAddressEmpty};scope.isCorrectStreetOptionVisible=false;scope.validateCorrectStreetOption=function(){scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber(scope.modifyAddress)};scope.correctStreetNo="";scope.updateCorrectStreetNo=function(correctStreetNo){scope.correctStreetNo=correctStreetNo};scope.replaceCorrectStreetNo=function(){if(scope.correctStreetNo&&scope.correctStreetNo!=""){scope.pssa=AppUtils.getReplacedStreet1Address(scope.correctStreetNo,scope.pssa)}scope.correctStreetNo=""}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngEmailCustomer",["ImsCustomerService","Utils","StoreUtil",function(ImsCustomerService,Utils,StoreUtil){return{restrict:"EA",scope:{imscustomer:"="},replace:true,templateUrl:"js/customer/partials/email-customer.html",link:function(scope,element,attrs){scope.disbaleBtn=false;scope.messages=[];scope.verifyEmail=function(){scope.disbaleBtn=true;scope.messages=[];ImsCustomerService.verifyEmail({email:scope.imscustomer.email}).success(function(result){scope.disbaleBtn=false;console.log("Success -> Email Verification Service");if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Email Verification Email Sent Successfully")}else{if(result.status=="EMAIL_NOT_SENT_ALREADY_VERIFIED"){scope.messages=Utils.showMessage("info","Email is already verified in the system")}}}}).error(function(error){scope.disbaleBtn=false;console.log("error",error)})};scope.resetPassword=function(){scope.messages=[];scope.disbaleBtn=true;var defaultLanguage=angular.isDefined(scope.imscustomer.defaultCountryLanguage)?scope.imscustomer.defaultCountryLanguage:StoreUtil.getDefaultCountryLanguage(scope.imscustomer.country);ImsCustomerService.resetPassword({email:scope.imscustomer.email,language:defaultLanguage}).success(function(result){console.log("Success -> Password Reset Email");scope.disbaleBtn=false;if(result.status=="UNKNOWN"){scope.messages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){scope.messages=Utils.showMessage("info","Password Reset Email Sent Successfully")}else{if(result.status=="EV_IN_QUIET_PERIOD"){scope.messages=Utils.showMessage("info","Email sent recently wait for some time")}}}}).error(function(error){scope.disbaleBtn=false;console.log("error",error)})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("fadeEffect",function(){return{compile:function(elm){$(elm).css("opacity",0.1);return function(scope,elm,attrs){$(elm).animate({opacity:1},1000)}}}});"use strict";var app=app||angular.module("hxApp.services");app.provider("ConfiguredFeatures",function(){this.$get=function(){return{isFeatureEnabled:this.isFeatureEnabled,useFeatures:this.useFeatures,getFeatures:function(){return featuresMap}}}});"use strict";var app=app||angular.module("hxApp.services");app.provider("features",function(){var DEFAULT_FEATURES="sales,uc_editbilling_validations,sepa,communication,countrychange,cbc_teamflow";var featuresMap={features_not_loaded:"enabled"};var getParameterByName=function(name){return decodeURI(window.location.hash.replace(new RegExp("^(?:.*[&\\?]"+encodeURI(name).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"))};this.useFeatures=function(featuresString){var newFeaturesMap={};angular.forEach(featuresString.split(","),function(value){newFeaturesMap[value]="enabled"});featuresMap=newFeaturesMap};this.isFeatureEnabled=function(feature){return(featuresMap[feature]==="enabled")};var urlFeatures=getParameterByName("features");if(urlFeatures){this.useFeatures(urlFeatures+","+DEFAULT_FEATURES)}else{this.useFeatures(DEFAULT_FEATURES)}this.$get=function(){return{isFeatureEnabled:this.isFeatureEnabled,useFeatures:this.useFeatures,getFeatures:function(){return featuresMap}}}});var app=app||angular.module("hxApp.directive",[]);app.directive("fieldLengthValidator",function(){return{require:"ngModel",link:function(scope,element,attrs){var maxLength=$(element).attr("data-maxlength");$(element).attr("maxLength",maxLength);scope.$watch(attrs.ngModel,function(data){if(data){var modelDataLength=data.length;if(modelDataLength>maxLength){scope.isMaxLengthInvalid=true;element.addClass("highlightExceedField")}else{scope.isMaxLengthInvalid=false;element.removeClass("highlightExceedField")}}else{scope.isMaxLengthInvalid=false;element.removeClass("highlightExceedField")}});$(element).maxlength({alwaysShow:true,warningClass:"label label-danger",limitReachedClass:"label label-warning",validate:true})}}});var app=app||angular.module("hxApp.directive",[]);app.directive("ngFileUpload",function(){return{restrict:"E",scope:{ngModel:"="},replace:true,templateUrl:"js/common/partials/file-upload.html",link:function($scope,$el,$attrs,$ctrl){var FileSelectHandler=function(e){var dt=e.dataTransfer||(e.originalEvent&&e.originalEvent.dataTransfer);var files=e.target.files||(dt&&dt.files);for(var i=0,f;f=files[i];i++){if(f.type=="application/x-msdownload"){$("#fileAlertModel").modal("show");$("#fileAlertModel").css("z-index",1999);return}}FileDragHover(e);for(var i=0,f;f=files[i];i++){UploadFile(f)}angular.element("#fileselect").val("")};var FileDragHover=function(e){e.stopPropagation();e.preventDefault();e.target.className=(e.type=="dragover"?"hover":"")};var UploadFile=function(file){var xhr=new XMLHttpRequest();if(xhr.upload){var uid="";var uploadedFilesArea=angular.element("#progress");var fileArea=$("<div></div>");var progress=$("<div class='progress' style='width: 100%'></div>");var bar=$("<div class='progress-bar'></div>");progress.append(bar);var removeButton=$("<div class='pull-right'><i class='glyphicon glyphicon-remove'></i></div>");fileArea.append("<b>"+file.name+"</b>").append(removeButton).append(progress);uploadedFilesArea.append(fileArea);xhr.upload.addEventListener("progress",function(e){var pc=parseInt(100-(e.loaded/e.total*100));bar.css("width",pc+"%");bar.html(pc+"%")},false);xhr.addEventListener("readystatechange",function(e){if(xhr.readyState==4){if(xhr.status!=200){bar.addClass("progress-bar-danger");bar.html("Failed to upload!")}else{bar.addClass("progress-bar-success");bar.html("100%")}bar.css("width","100%");uid=$(xhr.response).find("uploadId").text();$scope.$apply(function(){if(!$scope.ngModel){$scope.ngModel=[]}$scope.ngModel.push({filename:file.name,size:file.size,id:uid})})}removeButton.data("fileId",uid).bind("click",function(e){angular.forEach($scope.ngModel,function(item){if(item.id==$(e.currentTarget).data("fileId")){$(e.target).parent().parent().remove();$scope.ngModel.splice($scope.ngModel.indexOf(item),1);return}})})});var uploadData=new FormData();uploadData.append("multipartFile",file,file.name);xhr.open("POST",angular.element("#upload").attr("action"),true);xhr.send(uploadData)}};var init=function(){var fileselect=angular.element("#fileselect"),filedrag=angular.element("#filedrag"),submitbutton=angular.element("#submitbutton");fileselect.bind("change",FileSelectHandler);var xhr=new XMLHttpRequest();if(xhr.upload){filedrag.bind("dragover",FileDragHover);filedrag.bind("dragleave",FileDragHover);filedrag.bind("drop",FileSelectHandler);filedrag.css("display","block");submitbutton.hide()}};$el.ready(function(){init()},50)}}});var app=app||angular.module("hxApp.directive",[]);app.directive("ngFileUploadSecond",function(){return{restrict:"E",scope:{ngModel:"="},replace:true,templateUrl:"js/common/partials/file-upload2.html",link:function($scope,$el,$attrs,$ctrl){var FileSelectHandler=function(e){var dt=e.dataTransfer||(e.originalEvent&&e.originalEvent.dataTransfer);var files=e.target.files||(dt&&dt.files);for(var i=0,f;f=files[i];i++){if(f.type=="application/x-msdownload"){$("#fileAlertModel2").modal("show");$("#fileAlertModel2").css("z-index",1999);return}}FileDragHover(e);for(var i=0,f;f=files[i];i++){UploadFile(f)}angular.element("#fileselect2").val("")};var FileDragHover=function(e){e.stopPropagation();e.preventDefault();e.target.className=(e.type=="dragover"?"hover":"")};var UploadFile=function(file){var xhr=new XMLHttpRequest();if(xhr.upload){var uid="";var uploadedFilesArea=angular.element("#progress2");var fileArea=$("<div></div>");var progress=$("<div class='progress' style='width: 100%'></div>");var bar=$("<div class='progress-bar'></div>");progress.append(bar);var removeButton=$("<div class='pull-right'><i class='glyphicon glyphicon-remove'></i></div>");fileArea.append("<b>"+file.name+"</b>").append(removeButton).append(progress);uploadedFilesArea.append(fileArea);xhr.upload.addEventListener("progress2",function(e){var pc=parseInt(100-(e.loaded/e.total*100));bar.css("width",pc+"%");bar.html(pc+"%")},false);xhr.addEventListener("readystatechange",function(e){if(xhr.readyState==4){if(xhr.status!=200){bar.addClass("progress-bar-danger");bar.html("Failed to upload!")}else{bar.addClass("progress-bar-success");bar.html("100%")}bar.css("width","100%");uid=$(xhr.response).find("uploadId").text();$scope.$apply(function(){if(!$scope.ngModel){$scope.ngModel=[]}$scope.ngModel.push({filename:file.name,size:file.size,id:uid})})}removeButton.data("fileId",uid).bind("click",function(e){angular.forEach($scope.ngModel,function(item){if(item.id==$(e.currentTarget).data("fileId")){$(e.target).parent().parent().remove();$scope.ngModel.splice($scope.ngModel.indexOf(item),1);return}})})});var uploadData=new FormData();uploadData.append("multipartFile",file,file.name);xhr.open("POST",angular.element("#upload2").attr("action"),true);xhr.send(uploadData)}};var init=function(){var fileselect=angular.element("#fileselect2"),filedrag=angular.element("#filedrag2"),submitbutton=angular.element("#submitbutton2");fileselect.bind("change",FileSelectHandler);var xhr=new XMLHttpRequest();if(xhr.upload){filedrag.bind("dragover",FileDragHover);filedrag.bind("dragleave",FileDragHover);filedrag.bind("drop",FileSelectHandler);filedrag.css("display","block");submitbutton.hide()}};$el.ready(function(){init()},50)}}});var app=app||angular.module("hxApp.filters",[]);app.filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/mg,version)}}]).filter("addressFormatterFilter",function(){var getEmptyIfNull=function(value){if(!value){return""}return value};return function(address){if(!address){return""}var address1=getEmptyIfNull(address.street1)+" "+getEmptyIfNull(address.street2)+" "+getEmptyIfNull(address.street3)+" "+getEmptyIfNull(address.city);var address2=getEmptyIfNull(address.stateName)+" "+getEmptyIfNull(address.postCode)+" "+getEmptyIfNull(address.country?address.country.code:null);if(address2){return address1+" | "+address2}else{return address1}}}).filter("jpAddressFormatterFilter",function(){var getEmptyIfNull=function(value){if(!value){return""}return value};return function(address){if(!address){return""}var address1=getEmptyIfNull(address.street1)+" "+getEmptyIfNull(address.street2)+" "+getEmptyIfNull(address.street3);var address2=getEmptyIfNull(address.postCode)+" "+getEmptyIfNull(address.stateName)+" "+getEmptyIfNull(address.city)+" "+getEmptyIfNull(address.country?address.country.code:null);if(address2){return address2+" | "+address1}else{return address1}}}).filter("recordTypeFilter",function(){return function(rec){var recordType=rec.type;var top100;if(rec&&rec.stratification&&rec.stratification.top100){top100=rec.stratification.top100}if(!recordType||recordType.length==0){return""}if(recordType[0].idType=="ZTEAM"||recordType.length>1?recordType[1].idType=="ZTEAM":false){return"Team"}else{if(recordType[0].idType=="ZVIPID"||recordType.length>1?recordType[1].idType=="ZVIPID":false){return"VIP"}else{if(rec.contactType=="CCE"){return"CCE"}else{if(top100){return"TOP 100 Org"}else{return"Org"}}}}}}).filter("contactTypeFilter",function(){return function(contactType){if(!contactType){return""}else{if(contactType=="CC4E"){return"CCE"}}}}).filter("lowecaseFilter",function(){return function(value){if(value){return angular.lowercase(value)}return""}}).filter("makePositive",function(){return function(value){return Math.abs(value)}}).filter("drInfo",function(){return function(prodList,infoType){if(prodList){if(infoType=="CUR"){return prodList[0].priceInfo.currencyCode}else{if(infoType=="PTOTAL"){return parseFloat(prodList[0].priceInfo.provisionedSubTotal).toFixed(2)}else{if(infoType=="ATOTAL"){var aTotal=0;angular.forEach(prodList,function(product){aTotal=aTotal+product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax});return parseFloat(aTotal).toFixed(2)}else{if(infoType=="NTOTAL"){var nTotal=prodList[0].priceInfo.provisionedSubTotal;angular.forEach(prodList,function(product){nTotal=nTotal+(product.productInfo.seatQuantity*product.priceInfo.oneUnitPriceWithoutTax)});return parseFloat(nTotal).toFixed(2)}}}}}return""}}).filter("noteTypeFilter",function(){return function(value){if(value){switch(value){case"TO_CUSTOMER":return"To Customer";break;case"OVERVIEW":return"Overview";break;case"FROM_CUSTOMER":return"From Customer";break;case"CASE_NOTE":return"Case Notes";break;case"ESCALATION_NOTE":return"Escalation Notes";break;default:return value}}return""}}).filter("serialNumberFilter",function(){return function(product){var result="";if(product){if(product.serialNumber){result="Serial: "+product.serialNumber}else{if(product.componentId){result="Component ID: "+product.componentId}}}return result}}).filter("productLabelFilter",function(){return function(product){var result="";if(product){var productStr=[];if(product.metaLanguage!=null){productStr.push(product.metaLanguage)}if(product.metaPlatform!=null){productStr.push(product.metaPlatform)}if(product.metaType!=null){productStr.push(product.metaType)}if(product.version!=null&&product.version!=""){productStr.push(product.version)}result=productStr.join(", ")}return result}}).filter("defaultFilter",function(){return function(value,parameters){return value?value:parameters[1]?parameters[1]:parameters[0]}}).filter("caseTypeFilter",function(){return function(caseType){return caseType=="ZCSC"?"csCase":"tsCase"}}).filter("dateFormatterFilter",function(){return function(dateTime){if(dateTime!=="null"&&typeof(dateTime)!=="undefined"&&dateTime!==null&&dateTime!==""){var d=new Date(dateTime);if(isNaN(d.valueOf())){return new Date(parseInt(dateTime)).toLocaleString()}else{return d.toLocaleString()}}return"-"}}).filter("tenureDateFormatterFilter",function(){return function(tenureDate){if(tenureDate!=="null"&&typeof(tenureDate)!=="undefined"&&tenureDate!==null&&tenureDate!==""){var d=new Date(tenureDate);if(isNaN(d.valueOf())){tenureDate1=new Date(parseInt(tenureDate));var dd=tenureDate1.getDate();var mm=tenureDate1.getMonth()+1;var yy=tenureDate1.getFullYear();if(dd.toString().length==1){dd="0"+dd}if(mm.toString().length==1){mm="0"+mm}}else{if(tenureDate.toString().indexOf("-")=="-1"){tenureDate1=new Date(tenureDate);var dd=tenureDate1.getDate();var mm=tenureDate1.getMonth()+1;var yy=tenureDate1.getFullYear();if(dd.toString().length==1){dd="0"+dd}if(mm.toString().length==1){mm="0"+mm}}else{var yy=tenureDate.toString().substring(0,4);var mm=tenureDate.toString().substring(5,7);var dd=tenureDate.toString().substring(8,10)}}tenureStartDate=mm+"/"+dd+"/"+yy;return tenureStartDate}return"-"}}).filter("trialStatusFilter",function(){return function(status,trialRec){if(trialRec&&angular.isDefined(trialRec.effective_end_date)&&trialRec.effective_end_date!==""){var currentDate=new Date();var endDate=new Date(trialRec.effective_end_date);if(isNaN(endDate.valueOf())){endDate=new Date(parseInt(dateTime)).toLocaleString()}if(endDate-currentDate<0){trialRec.trial_status="EXPIRED";return"EXPIRED"}else{return trialRec.trial_status}}else{return trialRec.trial_status}}}).filter("paymentTypeFilter",["PaymentConstants",function(PaymentConstants){return function(paymentType){switch(paymentType){case PaymentConstants.CREDIT_CARD_PAYMENT_TYPE:return PaymentConstants.CREDIT_CARD_PAYMENT_LABEL;break;case PaymentConstants.DEBIT_CARD_PAYMENT_TYPE:return PaymentConstants.DEBIT_CARD_PAYMENT_LABEL;break;case PaymentConstants.CVS_PAYMENT_TYPE:return PaymentConstants.CVS_PAYMENT_LABEL;break;case PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE:return PaymentConstants.BANK_TRANSFER_PAYMENT_LABEL;break;case PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE:return PaymentConstants.DIRECT_DEBIT_PAYMENT_LABEL;break;case PaymentConstants.PAYPAL_PAYMENT_TYPE:return PaymentConstants.PAYPAL_PAYMENT_LABEL;break;case PaymentConstants.DUMMY_CARD:return PaymentConstants.DUMMY_CARD_LABEL;break;case PaymentConstants.PO_PAYMENT_TYPE:return PaymentConstants.PO_PAYMENT_DISPLAY_LABEL;break;default:return paymentType}}}]).filter("stockOverAgeFilter",function(){return function(data){if(data==1){return"Yes"}else{if(data==0){return"No"}else{return"No"}}}}).filter("entitlementLabelFilter",function(){return function(data){if(data&&data[0].guid){return"- Entitlement GUID "+data[0].guid}else{return""}}}).filter("esdDescriptionFilter",function(){return function(regInd){var description="";if(regInd){switch(regInd){case"I":description="CC Individual";break;case"C":description="CC Team";break;case"N":description="CC Enterprise";break;case"S":description="Subscription";break;case"E":description="Perpetual";break;default:description=regInd;break}}return description}}).filter("entitlementGUIDFilter",function(){return function(entitlementGUID){if(entitlementGUID.indexOf("Personal")>0){return"Personal"}else{return entitlementGUID}}}).filter("htmlFormatterFilter",function(){return function(value){if(value){return value.replace(/\n/gi,"<br/>")}else{return""}}}).filter("bytesToSizeFilter",function(){return function(bytes){var sizes=["Bytes","KB","MB","GB","TB"];if(bytes==0){return"n/a"}var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));return Math.round(bytes/Math.pow(1024,i),2)+" "+sizes[[i]]}}).filter("displayName1Filter",function(){return function(record){if(!record){return"---"}if(!record.name||record.name==""){if(record&&record.address&&record.address.country&&record.address.country.code=="JP"){return record.lastName+" "+record.firstName}else{return record.firstName+" "+record.lastName}}else{return record.name}}}).filter("webGuidFilter",function(){return function(customer){var result="";if(customer&&customer.customerIdentifications){angular.forEach(customer.customerIdentifications,function(item){if(item.idType=="ZGUID"){result=item.idNumber;return}})}return result}}).filter("gstNumberFilter",["CustomerConstants",function(CustomerConstants){return function(gstNumber,taxInfo){if(taxInfo&&taxInfo.taxType==CustomerConstants.GST_NZ_CODE){return"GST Number "+gstNumber}else{return gstNumber}}}]).filter("removeLeadingZeroFilter",function(){return function(s){var result="";if(s){result=s.replace(/^(0+)/g,"")}return result}}).filter("fileExtensionFilter",function(){return function(fileName){return fileName.substr(fileName.lastIndexOf(".")+1,fileName.length)}}).filter("fileNameFilter",function(){return function(fileName){return fileName.substr(0,fileName.lastIndexOf("."))}}).filter("doubleByteFilter",function(){return function(stringData){var strData="";try{strData=decodeURIComponent(escape(stringData));return strData}catch(error){return strData=""}}}).filter("storeTypeFilter",function(){return function(storeType){var strData="COM";try{if(storeType=="COM"){strData="Commercial"}else{if(storeType=="EDU"){strData="Educational"}else{strData="Not Selected The"}}return strData}catch(error){return strData}}}).filter("noEduName",function(){return function(country){try{return country.indexOf("EDU")>0?country.split("-")[0]:country}catch(error){return country}}}).filter("productDescriptionFilter",function(){return function(products){if(!products){return"-"}var result="";if(products){angular.forEach(products,function(item){if(item.description&&item.description!=""){result+=item.description}})}return result}}).filter("productTypeFilter",function(){return function(productType){if(productType){if(angular.uppercase(productType)=="HGD"){return"HGD"}else{if(angular.uppercase(productType)=="ESD"){return"ESD"}else{if(angular.uppercase(productType)=="DSP"){return"DSP"}else{if(angular.uppercase(productType)=="DSPE"){return"DSPE"}else{if(angular.uppercase(productType)=="CCMT"){return"CCT"}else{if(angular.uppercase(productType)=="SUB"){return"SUB"}else{if(angular.uppercase(productType)=="SSP"){return"SSP"}}}}}}}}return""}}).filter("snProductFilter",function(){return function(products){if(!products){return"-"}var result=[];if(products){angular.forEach(products,function(item){if(item.serialNumber&&item.serialNumber.length!=""&&item.regInd!="S"){result.push(item)}})}return result}}).filter("setEnterpriseType",function(){return function(string){if(typeof string!=="undefined"&&string!=null){if(angular.lowercase(string)=="type2"){return"Enterprise ID"}else{return"Federated ID"}}}}).filter("setPrice",["$filter",function($filter){return function(price,currency){if(typeof price!=="undefined"&&price!=null&&typeof currency!=="undefined"&&currency!=null){if(angular.lowercase(currency)=="jpy"){return price}else{return $filter("number")(price,2)}}}}]).filter("encodeURIComponent",function(){return window.encodeURIComponent}).filter("linkify",["$filter",function($filter){return function(string){if(typeof string!=="undefined"&&string!=null){var linkyString=$filter("linky")(string,"_blank");return linkyString}}}]).filter("statusDescriptionFilter",function(TransactionConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(TransactionConstants.STATUS_TEMPLATES,function(item){if(item.name==statusCode){result=item.description;return}})}return result}}).filter("statusCodeFilter",function(TransactionConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(TransactionConstants.STATUS_TEMPLATES,function(item){if(item.name==statusCode){result=item.code;return}})}return result}}).filter("statusRenameCodeFilter",function(TransactionConstants){return function(statusCode){statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_CANCELLED?"ITEM_CANCELLED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_INVOICED?"ITEM_INVOICED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_FULLFILLED?"ITEM_FULFILLED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_OPEN?"ITEM_OPEN":statusCode;var result="";if(statusCode){angular.forEach(TransactionConstants.STATUS_TEMPLATES,function(item){if(item.name==statusCode){result=item.code;return}})}return result}}).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}}).filter("statusRenameDescriptionFilter",function(TransactionConstants){return function(statusCode){statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_CANCELLED?"ITEM_CANCELLED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_INVOICED?"ITEM_INVOICED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_ECOM_FULLFILLED?"ITEM_FULFILLED":statusCode;statusCode=statusCode==TransactionConstants.TRANSACTION_STATUS_OPEN?"ITEM_OPEN":statusCode;var result="";if(statusCode){angular.forEach(TransactionConstants.STATUS_TEMPLATES,function(item){if(item.name==statusCode){result=item.description;return}})}return result}}).filter("subscriptionStatusDescriptionFilter",function(SubscriptionConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(SubscriptionConstants.SUBSCRIPTION_STATUS_TEMPLATES,function(item){if(item.code==statusCode){result=item.description;return}})}return result}}).filter("subscriptionPaymentStatusDescriptionFilter",function(SubscriptionConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(SubscriptionConstants.SUBSCRIPTION_PAYMENT_STATUS_TEMPLATES,function(item){if(item.code==statusCode){result=item.description;return}})}return result}}).filter("teamPaymentStatusDescriptionFilter",function(TeamConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(TeamConstants.TEAM_PAYMENT_STATUS_TEMPLATES,function(item){if(item.code==statusCode){result=item.description;return}})}return result}}).filter("teamStatusDescriptionFilter",function(TeamConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(TeamConstants.TEAM_STATUS_TEMPLATES,function(item){if(item.code==statusCode){result=item.description;return}})}return result}}).filter("subscriptionContractStatusDescriptionFilter",function(SubscriptionConstants){return function(statusCode){var result="";if(statusCode){angular.forEach(SubscriptionConstants.SUBSCRIPTION_CONTRACT_STATUS_TEMPLATES,function(item){if(item.code==statusCode){result=item.description;return}})}return result}}).filter("hxProductImageSourceFromProductCode",function(AppUtils){return function(productCode){var result="img/products/no-product.png";if(productCode){return AppUtils.getProductThumbnailImage(productCode)}return result}}).filter("drCountryNameFilter",function(){return function(name){return name.replace("(DR)","")}}).filter("hxProductImageSourceFromProductName",function(AppUtils){return function(productName){var result="img/products/no-product.png";if(productName){return AppUtils.getProductThumbnailImageFromProductName(productName)}return result}}).filter("hxProductNameFromCrmProductCode",function(AppUtils){return function(productName){var result="";if(productName){return AppUtils.getProductNameFromCrmProductName(productName)}return result}}).filter("secondryAdminListFilter",function(){return function(teamRoles){var result=[];angular.forEach(teamRoles,function(roleInfo){if(roleInfo.type=="GRP_ADMIN"){result.push(roleInfo)}});return result}}).filter("removeUnderScores",function(){return function(text){if(typeof text!=="undefined"&&text!=null){var str=text.replace(/\_/g," ");return str}}}).filter("cancellationRuleTypeFilter",function(){return function(ruleId){if(ruleId){if(angular.uppercase(ruleId)=="NOFEE_V01"){return"No Fee"}else{if(angular.uppercase(ruleId)=="REMAINDERMONTHS50_V01"){return"50% of Remaining"}else{if(angular.uppercase(ruleId)=="REFUNDOFCURRENTBILLINGCYCLE_V01"){return"Refund of Paid Month"}else{if(angular.uppercase(ruleId)=="NOREFUND_V01"){return"No Refund"}else{if(angular.uppercase(ruleId)=="FULL_V01"){return"Full Refund"}else{if(angular.uppercase(ruleId)=="STOPIMMEDIATE_V01"){return"Terminate Now"}else{if(angular.uppercase(ruleId)=="STOPATNEXTBILL_V01"){return"Stop Billing"}}}}}}}}return""}}).filter("calculateAgeingFilter",function(){return function(date){if(typeof date!=="undefined"&&date!=null){var startDate=new Date(date);var currentDate=new Date();var diff=new Date(currentDate-startDate);var ageing=diff/1000/60/60/24;return Math.round(ageing)}else{return""}}}).filter("filterCancelledProducts",function(){return function(items){if(typeof items!=="undefined"&&items!=null){var result=[];angular.forEach(items,function(item){if(item.rejectionCode==""){result.push(item)}});return result}}}).filter("priceLockInfo",["$filter",function($filter){return function(transaction,info){var toolTipMsg=info=="roleBack"?"Price Roll Back":"Price Lock";if(angular.isDefined(transaction.messages)&&angular.isArray(transaction.messages)&&transaction.messages.length>0){angular.forEach(transaction.messages,function(message){if(message.number==193){try{var regex=new RegExp(",","g");toolTipMsg=(message.text).split(":")[0]+": "+$filter("date")(new Date(((message.text).split(":")[1]).replace(" ","").replace(regex,"")),"dd MMM yyyy")}catch(e){}}})}return toolTipMsg}}]).filter("decodeUTF8",function(){return function(val){var str;try{str=decodeURIComponent(window.escape(val))}catch(error){str=val}return str}}).filter("ageing",["Utils",function(Utils){return function(val){return Utils.getProductSubscriptionAge(val)}}]).filter("languagename",function(){return function(val){var str="";try{if(val=="MULT"){str="Multiple"}else{if(val=="EN"){str="English"}}}catch(error){str=val}return str}}).filter("uniqueData",function(){return function(arr,field){return _.uniqBy(arr,field)}}).filter("paymentText",function(){return function(val){val=angular.uppercase(val);var str="";try{if(val=="CREDIT_CARD"){str="Credit Card"}else{if(val=="MASTERCARD"){str="Master Card"}else{if(val=="AMEX"){str="American Express"}else{if(val=="VISA"){str="VISA"}}}}}catch(error){str=val}return str}}).filter("paymentReasonCodeText",function(){return function(val){var str="";try{if(val.disabledReasonCode=="AMOUNT_HIGH"){str="The "+val.paymentLabel+" payment type is not supported for order value more than ";if(val.paymentType=="BANK_TRANSFER"){str+="9000K YEN"}else{if(val.paymentType=="DIRECT_DEBIT"){str+="65k EUR"}}}else{if(val.disabledReasonCode=="HAS_MULTIPLE_ITEMS"){str="The "+val.paymentLabel+" payment type is not supported for order having multiple items "}else{if(val.disabledReasonCode=="NOT_ENABLED"){str="The "+val.paymentLabel+" payment type is not enabled in this new flow, It will be available soon. Please use old store"}}}}catch(error){str=val}return str}}).filter("drSeatPriceInfo",function(){return function(val){var str="";try{if(val.disabledReasonCode=="AMOUNT_HIGH"){str="The "+val.paymentLabel+" payment type is not supported for order value more than ";if(val.paymentType=="BANK_TRANSFER"){str+="9000K YEN"}else{if(val.paymentType=="DIRECT_DEBIT"){str+="65k EUR"}}}else{if(val.disabledReasonCode=="HAS_MULTIPLE_ITEMS"){str="The "+val.paymentLabel+" payment type is not supported for order having multiple items "}else{if(val.disabledReasonCode=="NOT_ENABLED"){str="The "+val.paymentLabel+" payment type is not enabled in this new flow, It will be available soon. Please use old store"}}}}catch(error){str=val}return str}}).filter("teamPaymentSort",["TeamConstants",function(TeamConstants){function CustomPaymentOrder(item){switch(item){case TeamConstants.PAYMENT_STATUS_PAID:return 1;case TeamConstants.PAYMENT_STATUS_GRACE_PAST_DUE:return 2;case TeamConstants.PAYMENT_STATUS_PAST_DUE:return 3;case TeamConstants.PAYMENT_STATUS_PENDING_PAYMENT:return 4;case TeamConstants.PAYMENT_STATUS_CANCELLING:return 5;case TeamConstants.PAYMENT_STATUS_CANCELLED:return 6}}return function(items,field){var filtered=[];angular.forEach(items,function(item){filtered.push(item)});filtered.sort(function(a,b){return(CustomPaymentOrder(a.paymentStatus)>CustomPaymentOrder(b.paymentStatus)?1:-1)});return filtered}}]).filter("teamCancelSeatSort",["TeamConstants",function(TeamConstants){function CustomPaymentOrder(item){switch(item){case TeamConstants.PAYMENT_STATUS_PENDING_PAYMENT:return 1;case TeamConstants.PAYMENT_STATUS_GRACE_PAST_DUE:return 2;case TeamConstants.PAYMENT_STATUS_PAST_DUE:return 3;case TeamConstants.PAYMENT_STATUS_PAID:return 4;case TeamConstants.PAYMENT_STATUS_CANCELLING:return 5;case TeamConstants.PAYMENT_STATUS_CANCELLED:return 6}}return function(items,field){var filtered=[];angular.forEach(items,function(item){filtered.push(item)});filtered.sort(function(a,b){return(CustomPaymentOrder(a.paymentStatus)>CustomPaymentOrder(b.paymentStatus)?1:-1)});return filtered}}]).filter("formatReasonCode",function(){var splitedMessage;var reasonCodeMessage;return function(reasonCode){reasonCodeMessage="";splitedMessage=reasonCode.split("_");angular.forEach(splitedMessage,function(item){reasonCodeMessage=reasonCodeMessage+" "+item.toLowerCase().replace(/\b(\s\w|^\w)/g,function(txt){return txt.toUpperCase()})});return reasonCodeMessage}}).filter("formatActionType",function(){var splitedMessage;var reasonCodeMessage;return function(reasonCode){reasonCodeMessage="";splitedMessage=reasonCode.split("_");angular.forEach(splitedMessage,function(item){if(item.toUpperCase()!="CCT"&&item.toUpperCase()!="DR"){reasonCodeMessage=reasonCodeMessage+" "+item.toLowerCase().replace(/\b(\s\w|^\w)/g,function(txt){return txt.toUpperCase()})}});return reasonCodeMessage}}).filter("commitmentText",function(){return function(val){val=angular.uppercase(val);var str="";try{if(val=="YEAR_PREPAID"){str="One-year, Prepaid"}else{if(val=="MONTH"){str="Month-to-Month"}else{if(val=="YEAR"||val=="FULL_YEAR"){str="One-year"}}}}catch(error){str=val}return str}});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("FocController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","FOC Order View");$scope.focTransaction=angular.copy($scope.transaction);$scope.isTransactionComplete=false;$scope.isUpdateOrderDisabled=true;$scope.isMemoBtnEnabled=false;$scope.deliveryReasonDetail="";$scope.checkTrackingInfo=function(){if($scope.focTransaction){if($scope.focTransaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.focTransaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.focTransaction.items&&$scope.focTransaction.items.length>0){for(var itemCount=0;itemCount<$scope.focTransaction.items.length;itemCount++){if($scope.focTransaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.checkDocumentFlow=function(){if($scope.focTransaction){return[TransactionConstants.TRANSACTION_STANDARD_ORDER,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO].indexOf($scope.transaction.transactionType)>-1}return false};$scope.validateButtonVisibility=function(){$scope.isTransactionComplete=OrderUtils.isTransactionComplete($scope.focTransaction.statusLabel);if($scope.isSubscriptionOrder){$scope.isSubscriptionEditBtnShow=true;$scope.isNonSubscriptionEditBtnShow=false}else{$scope.isSubscriptionEditBtnShow=false;$scope.isNonSubscriptionEditBtnShow=true}angular.forEach($scope.focTransaction.items,function(productItem){if(productItem.deliveryStatus!=TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){$scope.isMemoBtnEnabled=true}})};$scope.initializeOrderScreen=function(){$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.isDocumentFlowShow=$scope.checkDocumentFlow();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.focTransaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.focTransaction.items);$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.focTransaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.focTransaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.focTransaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.focTransaction);$scope.transactionStatusLabel=TransactionUtil.getStatusLabel($scope.focTransaction.statusLabel);$scope.deliveryReasonDetail=$scope.getDeliveryBlockReason($scope.focTransaction.deliveryBlock);$scope.validateButtonVisibility()};$scope.getDeliveryBlockReason=function(code){var str="";if(typeof code=="undefined"||code==""||code==null){return str}else{for(var i=0;i<$scope.$parent.metadata.deliveryBlockingReasons.length;i++){if($scope.$parent.metadata.deliveryBlockingReasons[i].reason==code){str=$scope.$parent.metadata.deliveryBlockingReasons[i].text;break}}}return str};$scope.initializeOrderScreen();$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.focTransaction.transactionGuid,transactionNo:$scope.focTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.focTransaction.transactionGuid,transactionNo:$scope.focTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.openEditBillingView=function(){TransactionService.lockTransaction({guid:$scope.focTransaction.transactionGuid}).success(function(lockResult){if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_EDIT_BILLING_EVENT,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,lockResult)}}).error(function(result){})};$scope.openCreateCreditMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_EVENT)};$scope.openCreateDebitMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_EVENT)};$scope.openReturnOrderView=function(){$scope.$emit(TransactionConstants.TRANSACTION_ORDER_RETURN_VIEW_EVENT)};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show")};$scope.showOrderActions=function(){$scope.showOrderActionsContainer=!$scope.showOrderActionsContainer};$scope.hideOrderActions=function(){$scope.showOrderActionsContainer=false}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngFocOrderActions",["$rootScope","$location","TransactionService","AppUtils","TransactionConstants","MetadataService",function($rootScope,$location,TransactionService,AppUtils,TransactionConstants,MetadataService){return{restrict:"EA",replace:true,templateUrl:"js/transaction/foc/partials/foc-order-actions.html",link:function($scope,element,attrs){$scope.resendStoreEmailAct=function(){$scope.orderNumber=$scope.transaction.externalReferenceNo;$scope.orderEmail=$scope.transaction.customer.adobeId;$scope.productName=[];$scope.isResendStoreEmailLoading=true;$scope.resendStoreEmailProgress=false;$scope.resendStoreEmailSuccess=false;$scope.emailTemplates=[];$scope.emailTemplates.push({Code:TransactionConstants.EMAIL_TEMPLATE_CODE_ORDER,Desc:TransactionConstants.EMAIL_TEMPLATE_DESC_ORDER});$scope.esdProductType=true;$scope.selectedEmailTemplate="";$scope.modalMessages="";if($scope.orderNumber==""){$scope.isResendStoreEmailLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_INFO_TYPE,"Order has not been replicated to Commerce yet. Please try later!")}else{if($scope.transaction.items.length){for(i=0;i<$scope.transaction.items.length;i++){if(typeof $scope.transaction.items[i].NewProp_productName=="undefined"){$scope.productName.push($scope.transaction.items[i].productName)}else{$scope.productName.push($scope.transaction.items[i].NewProp_productName)}$scope.transaction.items[i].isSelected=true;if($scope.transaction.items[i].productType==TransactionConstants.ESD_PRODUCT_TYPE_UNCLASSIFIED&&$scope.esdProductType){$scope.esdProductType=false;$scope.emailTemplates.push({Code:TransactionConstants.EMAIL_TEMPLATE_CODE_ESD,Desc:TransactionConstants.EMAIL_TEMPLATE_DESC_ESD})}}if($scope.esdProductType){$scope.selectedEmailTemplate=TransactionConstants.EMAIL_TEMPLATE_CODE_ORDER}}}$("#resendStoreEmailModal").modal("show")};$scope.cancelResendStoreEmailModel=function(){$scope.modalMessages="";$("#resendStoreEmailModal").modal("hide")};$scope.isFormValidate=function(){$scope.itemList=$scope.selectedItemList();return $scope.orderNumber&&$scope.orderEmail&&$scope.selectedEmailTemplate&&$scope.validateEmail($scope.orderEmail)&&$scope.itemList.length};$scope.validateEmail=function(email){var re=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;return re.test(email)};$scope.resendStoreEmail=function(){$scope.isResendStoreEmailLoading=false;$scope.resendStoreEmailProgress=true;TransactionService.resendStoreEmail({orderExtRefNo:$scope.orderNumber,emailAddress:$scope.orderEmail,emailTemplate:$scope.selectedEmailTemplate,itemList:""}).success(function(result){$scope.resendStoreEmailSuccess=true;$scope.resendStoreEmailProgress=false;$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_SUCCESS_TYPE,"Successfully sent the Store Email.")}).error(function(result){$scope.resendStoreEmailProgress=false;console.log("resendStoreEmail : "+result);$scope.modalMessages=AppUtils.getSingleMessage(TransactionConstants.MESSAGE_ERROR_TYPE,"Failed to sent Store Email.");AppUtils.sendLogToServer("Failed to sent Store Email : Order Number - "+$scope.orderNumber)})};$scope.selectedItemList=function(){var j=$scope.transaction.items.length;$scope.selectedItemsList=[];while(j--){if($scope.transaction.items[j].isSelected){if($scope.selectedItemsList.length==0){$scope.selectedItemsList=$scope.transaction.items[j].id}else{$scope.selectedItemsList=$scope.selectedItemsList.toString()+","+$scope.transaction.items[j].id}}}return $scope.selectedItemsList}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("GCService",["$http",function($http){var service={};service.getGIDDetails=function(data){return $http({method:"GET",url:"../gcService/getGIDDetails.do",params:{gid:data.gid}})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngGidLookup",["$rootScope","Utils","MetadataService","GCService","AppUtils","AppConstants",function($rootScope,Utils,MetadataService,GCService,AppUtils,AppConstants){return{restrict:"EA",scope:{customerdetail:"=",contactNo:"=contactno"},replace:true,templateUrl:"js/customer/partials/gid-lookup-popup.html",link:function(scope,element,attrs){}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxCreditMemoPod",["$rootScope","$location","TransactionConstants","PaymentConstants","AppUtils","$app","LocalStorageService","AppPodServices",function($rootScope,$location,TransactionConstants,PaymentConstants,AppUtils,$app,LocalStorageService,AppPodServices){return{restrict:"E",scope:{transactionId:"=",sku:"=",reason:"=",overridePrice:"=",teamFlow:"=",cancelSeatCount:"="},replace:true,templateUrl:"js/app-components/credit-memo/hx-credit-memo-pod.html",link:function($scope,element,attrs){$scope.PaymentConstants=PaymentConstants;$scope.isServiceLoading=true;$scope.isReviewServiceLoading=false;$scope.isOverrideServiceLoading=false;$scope.isOverrideBtnShow=false;$scope.isOverrideComplete=false;$scope.isFirstTimeInvoke=true;$scope.isMemoBtnEnabled=false;$scope.isPaymentSwitchEnabled=false;$scope.btPaymentValid=false;$scope.INITIALIZE_CM_TRANSACTION="INITIALIZE_CM_TRANSACTION";$scope.CREATE_CREDIT_MEMO_EVENT_FAILED="CREATE_CREDIT_MEMO_EVENT_FAILED";$scope.CREATE_CREDIT_MEMO_EVENT_SUCCESS="CREATE_CREDIT_MEMO_EVENT_SUCCESS";$scope.CREDIT_MEMO_VIEW_LOADED="CREDIT_MEMO_VIEW_LOADED";$scope.transaction;$scope.btPaymentDetails=new Object();$scope.paymentErrorMessage="";$scope.$on($scope.INITIALIZE_CM_TRANSACTION,function(event,messages){if($scope.isFirstTimeInvoke){$scope.isFirstTimeInvoke=false;$scope.initializeTransaction()}});$scope.getTransaction=function(){AppPodServices.getTransaction({guid:"",number:$scope.transactionId,subscriptionId:""}).success(function(result){$scope.isServiceLoading=false;$scope.transaction=result;if($scope.transaction&&$scope.transaction.items.length==1){$scope.transaction.items[0].NotModify_promoPrice=$scope.transaction.items[0].promoPrice;$scope.transaction.items[0].NotModify_quantity=$scope.transaction.items[0].quantity;$scope.transaction.items[0].NotModify_listPrice=$scope.transaction.items[0].listPrice;if($scope.teamFlow&&$scope.cancelSeatCount){$scope.transaction.items[0].quantityToReturn=$scope.transaction.items[0].quantity=$scope.cancelSeatCount}if(($scope.transaction.items[0].deliveryStatus==TransactionConstants.DELIVERY_STATUS_COMPLETELY_PROCESSED||$scope.transaction.items[0].deliveryStatus==TransactionConstants.DELIVERY_STATUS_PARTIALLY_PROCESSED)&&$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=true}}else{var transactionItem=[];for(var itemCount=0;itemCount<$scope.transaction.items.length;itemCount++){var item=$scope.transaction.items[itemCount];if($scope.sku==item.sku){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice;if($scope.teamFlow&&$scope.cancelSeatCount){item.quantityToReturn=item.quantity=$scope.cancelSeatCount}if((item.deliveryStatus==TransactionConstants.DELIVERY_STATUS_COMPLETELY_PROCESSED||item.deliveryStatus==TransactionConstants.DELIVERY_STATUS_PARTIALLY_PROCESSED)&&$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=true}transactionItem.push(item);break}}$scope.transaction.items=transactionItem}if($scope.isMemoBtnEnabled){if($scope.transaction.paymentDetails&&($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)){$scope.isPaymentSwitchEnabled=true;$scope.btPaymentDetails.bankCountry="JP"}else{$scope.isPaymentSwitchEnabled=false}$scope.reviewCreditMemoTransaction();$scope.message=""}else{$scope.message="Credit Memo Is Not Enabled For This Product";$scope.isServiceLoading=false}}).error(function(){$scope.message="Failed to load transaction";$scope.isServiceLoading=false;AppUtils.sendLogToServer("Cancellation Credit Memo Transaction Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.initializeTransaction=function(){if($scope.transactionId){$scope.getTransaction()}else{$scope.message="Failed to load Credit Memo";$scope.isServiceLoading=false}};$scope.checkOverrideBtn=function(){var returnValue=false;var listPriceValid=true;if($scope.creditMemoReviewTransaction&&$scope.creditMemoReviewTransaction.items&&$scope.creditMemoReviewTransaction.items.length>0){if($scope.creditMemoReviewTransaction.items[0].promoPrice!=$scope.creditMemoReviewTransaction.items[0].NotModify_promoPrice){returnValue=true}if($scope.creditMemoReviewTransaction.items[0].promoPrice==""||isNaN(Number($scope.creditMemoReviewTransaction.items[0].promoPrice))){listPriceValid=false}}$scope.isOverrideBtnShow=returnValue;if(!listPriceValid){$scope.transactionErrorMessage="Enter valid Credit Memo price";$scope.transactionMessage="";$scope.isOverrideComplete=false;returnValue=false}else{$scope.transactionErrorMessage=""}return returnValue};$scope.reviewCreditMemoTransaction=function(){$scope.isReviewServiceLoading=true;var creditMemoReview=angular.copy($scope.transaction);creditMemoReview.returnInProgress=true;creditMemoReview.returnReasonCode=$scope.reason;creditMemoReview.externalReferenceNo=$scope.transaction.externalReferenceNo;if(creditMemoReview.items&&creditMemoReview.items.length==1){creditMemoReview.items[0].toReturn=true;creditMemoReview.items[0].quantityToReturn=creditMemoReview.items[0].quantity}else{angular.forEach(creditMemoReview.items,function(productItem){if($scope.sku==productItem.sku){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity}else{productItem.toReturn=false;productItem.quantityToReturn=0}})}AppPodServices.reviewTransaction(creditMemoReview).success(function(result){$scope.creditMemoReviewTransaction=result;angular.forEach($scope.creditMemoReviewTransaction.items,function(item){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice});$scope.isReviewServiceLoading=false;$scope.$emit($scope.CREDIT_MEMO_VIEW_LOADED,true);if(!$scope.teamFlow){if($scope.$parent.isCountryChangeFLow()){$scope.creditMemoReviewTransaction.items[0].promoPrice=-($scope.overridePrice);$scope.overrideCreditMemo(false)}}}).error(function(result){$scope.isReviewServiceLoading=false;AppUtils.sendLogToServer("Cancellation Credit Memo Review Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.overrideCreditMemo=function(isDefaultOverride){$scope.isOverrideServiceLoading=true;$scope.isOverrideComplete=false;$scope.transactionMessage="";var creditMemoOverride=angular.copy($scope.creditMemoReviewTransaction);creditMemoOverride.returnInProgress=true;creditMemoOverride.returnReasonCode=$scope.reason;creditMemoOverride.paymentDetails=angular.copy($scope.transaction.paymentDetails);creditMemoOverride.externalReferenceNo=$scope.creditMemoReviewTransaction.externalReferenceNo;angular.forEach(creditMemoOverride.items,function(productItem){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity;productItem.promoPrice=Math.abs(Number(productItem.promoPrice).toFixed(2));productItem.listPrice=productItem.NotModify_listPrice});AppPodServices.reviewTransaction(creditMemoOverride).success(function(result){$scope.creditMemoOverrideTransaction=result;angular.forEach($scope.creditMemoOverrideTransaction.items,function(item){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice});$scope.isOverrideComplete=true;$scope.isOverrideServiceLoading=false;$scope.transactionMessage=isDefaultOverride?"":"Override Complete, Create CM Now"}).error(function(result){$scope.isOverrideComplete=true;$scope.isOverrideServiceLoading=false;$scope.transactionReviewMessage="Override Failed, Please try again...";AppUtils.sendLogToServer("Cancellation Credit Memo Override Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.checkCreateCreditMemoBtn=function(){var result=true;if(!$scope.isOverrideBtnShow&&!$scope.isPaymentSwitchEnabled){result=false}else{if($scope.isOverrideBtnShow&&!$scope.isPaymentSwitchEnabled){if($scope.isOverrideComplete){result=false}}else{if($scope.isPaymentSwitchEnabled&&!$scope.isOverrideBtnShow){if($scope.btPaymentValid){result=false}}else{if($scope.isOverrideBtnShow&&$scope.isPaymentSwitchEnabled){if($scope.isOverrideComplete&&$scope.btPaymentValid){result=false}}}}}return result};$scope.createCreditMemo=function(){$scope.loadingMessage="Creating Credit Memo, Please Wait...";$scope.showViewLoading();if(!$scope.creditMemoOverrideTransaction){$scope.creditMemoOverrideTransaction=angular.copy($scope.creditMemoReviewTransaction)}$scope.creditMemoOverrideTransaction.returnInProgress=true;$scope.creditMemoOverrideTransaction.returnReasonCode=$scope.reason;$scope.creditMemoOverrideTransaction.externalReferenceNo=$scope.transaction.externalReferenceNo;$scope.creditMemoOverrideTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails);if($scope.isPaymentSwitchEnabled){$scope.creditMemoOverrideTransaction.paymentDetails.bankCountry=$scope.creditMemoOverrideTransaction.customer.address.country.code;$scope.creditMemoOverrideTransaction.paymentDetails.accountHolder=$scope.btPaymentDetails.accountHolder;$scope.creditMemoOverrideTransaction.paymentDetails.bankKey=$scope.btPaymentDetails.bankKey;$scope.creditMemoOverrideTransaction.paymentDetails.bankName=$scope.btPaymentDetails.bankName;$scope.creditMemoOverrideTransaction.paymentDetails.bankAccount=$scope.btPaymentDetails.bankAccount;$scope.creditMemoOverrideTransaction.paymentDetails.city=$scope.btPaymentDetails.city;$scope.creditMemoOverrideTransaction.paymentDetails.controlCode=$scope.btPaymentDetails.controlCode;$scope.creditMemoOverrideTransaction.paymentDetails.paymentType=PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE}angular.forEach($scope.creditMemoOverrideTransaction.items,function(productItem){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity});AppPodServices.createTransaction($scope.creditMemoOverrideTransaction).success(function(result){if(!result||!result.transactionNumber||AppUtils.isHavingErrorMessage(result.messages)){$scope.transactionReviewMessage="Credit Memo Creation Failed, Please try again...";$scope.$emit($scope.CREATE_CREDIT_MEMO_EVENT_FAILED,"Credit Memo Failed",result);AppUtils.sendLogToServer("Cancellation Credit Memo Creation Service Failed With Errors: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)}else{$scope.$emit($scope.CREATE_CREDIT_MEMO_EVENT_SUCCESS,"Credit Memo Created",result);AppUtils.sendLogToServer("Cancellation Credit Memo Creation Service Successful: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)}$scope.hideViewLoading()}).error(function(result){$scope.transactionReviewMessage="Credit Memo Service Failed, Please try again...";$scope.$emit($scope.CREATE_CREDIT_MEMO_EVENT_FAILED,"Credit Memo Service Failed",null);$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation Credit Memo Creation Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.showViewLoading=function(){if($scope.teamFlow){$app.showLoading("Processing cancellation")}else{$("#credit-memo-view-loading-modal").modal("show")}};$scope.hideViewLoading=function(){$("#credit-memo-view-loading-modal").modal("hide")};$scope.$watch("btPaymentDetails",function(){if($scope.btPaymentDetails){$scope.btPaymentValid=$scope.isBtPaymentFormValid()}},true);$scope.isBtPaymentFormValid=function(){var result=false;if(!angular.isDefined($scope.btPaymentDetails.bankKey)||$scope.btPaymentDetails.bankKey==null||$scope.btPaymentDetails.bankKey==""){$scope.paymentErrorMessage="Bank Key Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.bankName)||$scope.btPaymentDetails.bankName==null||$scope.btPaymentDetails.bankName==""){$scope.paymentErrorMessage="Bank Name Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.bankAccount)||$scope.btPaymentDetails.bankAccount==null||$scope.btPaymentDetails.bankAccount==""){$scope.paymentErrorMessage="Bank Account Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.accountHolder)||$scope.btPaymentDetails.accountHolder==null||$scope.btPaymentDetails.accountHolder==""){$scope.paymentErrorMessage="Account Holder Is Required"}else{if(!angular.isDefined($scope.btPaymentDetails.controlCode)||$scope.btPaymentDetails.controlCode==null||$scope.btPaymentDetails.controlCode==""){$scope.paymentErrorMessage="Control Code Is Required"}else{$scope.paymentErrorMessage="";result=true}}}}}return result}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxCustomerPhoto",["$rootScope","$location","AppUtils","LocalStorageService","AppPodServices",function($rootScope,$location,AppUtils,LocalStorageService,AppPodServices){return{restrict:"E",scope:{rengaId:"=?",hxWidth:"=",imgId:"=?"},replace:true,templateUrl:"js/app-components/customer-photo/hx-customer-photo.html",link:function($scope,element,attrs){if($scope.rengaId){var adobeId=$scope.rengaId.indexOf("@")>=0?$scope.rengaId:$scope.rengaId+"@AdobeID";AppPodServices.getBehanceProfileDetails(adobeId).success(function(result){$scope.customerBehanceProfile=result.user}).error(function(result){console.log(result)})}else{}$scope.showCustomerImage=function(){$("#customerPodImageModal").modal("show")}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxCustomerPreviewPod",["$rootScope","$location","AppUtils","LocalStorageService","AppPodServices",function($rootScope,$location,AppUtils,LocalStorageService,AppPodServices){return{restrict:"E",scope:{metadata:"=?",editable:"=?",customerId:"=?",customerEmail:"=?",contact:"=?",layout:"=?",cache:"=?"},replace:true,templateUrl:"js/app-components/customer-pod/hx-customer-preview-pod.html",link:function($scope,element,attrs){$scope.HORIZONTAL_LAYOUT="horizontal";$scope.VERTICAL_LAYOUT="vertical";$scope.layout=$scope.layout&&$scope.layout=="horizontal"?$scope.HORIZONTAL_LAYOUT:$scope.VERTICAL_LAYOUT;$scope.editable=$scope.editable&&$scope.editable==true?true:false;$scope.cache=$scope.cache&&$scope.cache==false?false:true;$scope.isServiceLoading=true;$scope.isCommercialStoreSellable=false;$scope.isEducationalStoreSellable=false;$scope.customerId=$scope.customerId?$scope.customerId:"";$scope.customerEmail=$scope.customerEmail?$scope.customerEmail:"";$scope.reloadCustomer=function(){$scope.getCustomerDetails()};$scope.checkStoreEnable=function(){$scope.isCommercialStoreSellable=AppUtils.isCommercialStore($scope.customer.address.country.code);$scope.isEducationalStoreSellable=AppUtils.isEducationalStore($scope.customer.address.country.code)};$scope.getCustomerDetails=function(){$scope.isServiceLoading=true;$scope.searchFields={firstName:"",lastName:"",customerId:$scope.customerId,transactionNo:"",serialNo:"",email:$scope.customerEmail,idNumber:"",customerType:"1"};AppPodServices.searchCustomer($scope.searchFields).success(function(result){$scope.isServiceLoading=false;if(result.customerSearchResults.length>0){$scope.customer=result.customerSearchResults[0];$scope.getBehanceProfileDetails($scope.customer.rengaGuid);LocalStorageService.add("customer-preview-pod",$scope.customer);$scope.checkStoreEnable()}else{$scope.message="Customer not found"}}).error(function(){$scope.message="Failed to load customer details";$scope.isServiceLoading=false})};$scope.getBehanceProfileDetails=function(rengaId){var adobeId=rengaId+"@AdobeID";AppPodServices.getBehanceProfileDetails(adobeId).success(function(result){$scope.customer.behanceProfile=result.user;LocalStorageService.add("customer-preview-pod",$scope.customer)}).error(function(result){console.log(result)})};$scope.showCustomerImage=function(){$("#customerPodImageModal").modal("show")};if($scope.customerId||$scope.customerEmail){if($scope.cache){$scope.customerData=LocalStorageService.get("customer-preview-pod");if($scope.customerData&&$scope.customerData.customerNo&&$scope.customerData.customerNo==$scope.customerId){$scope.customer=$scope.customerData;$scope.isServiceLoading=false;$scope.checkStoreEnable()}else{LocalStorageService.remove("customer-preview-pod");$scope.getCustomerDetails()}}else{$scope.getCustomerDetails()}}else{$scope.message="Failed to load customer details";$scope.isServiceLoading=false}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("HxDbFactory",function($location,$rootScope,IndexedDbFactory,AppConstants,LocalStorageService){var factory={};factory.applicationDbStatus;const DB_STATUS={NEW:"new",CREATED:"created",UPDATED:"updated",DELETED:"deleted"};factory.DB_STATUS=DB_STATUS;var metadataDb={name:"Hx5-Metadata",version:1,found:false,db:null,status:DB_STATUS.NEW};factory.metadataDb=metadataDb;factory.metadataLanguage=AppConstants.DEFAULT_LANGUAGE;factory.initDbName=function(){var locallyStoredLanguage=LocalStorageService.get("language");if(locallyStoredLanguage){factory.metadataLanguage=locallyStoredLanguage}else{factory.metadataLanguage=AppConstants.DEFAULT_LANGUAGE}angular.forEach(AppConstants.LANGUAGES,function(languageObject){if(factory.metadataLanguage==languageObject.code){factory.metadataDb.name=languageObject.dbName}})};factory.metadataInit=function(callback){factory.initDbName();factory.openMetadataDb(function(result,dbObject){if(result){if(dbObject.objectStoreNames.length==0){factory.applicationDbStatus=false;dbObject.close();if(factory.metadataDb){callback(factory.applicationDbStatus)}}else{if(!dbObject.objectStoreNames.contains("metadataInfo")){factory.applicationDbStatus=false;callback(factory.applicationDbStatus)}else{factory.applicationDbStatus=true;callback(factory.applicationDbStatus)}}}})};factory.openMetadataDb=function(callback){factory.initDbName();IndexedDbFactory.openDb(factory.metadataDb.name,"1",function(eventType,dbObject){switch(eventType){case IndexedDbFactory.DB_EVENT.SUCCESS:if(callback){callback(true,dbObject)}break;case IndexedDbFactory.DB_EVENT.FAILED:console.error("Not able to open DB "+appDb.name);if(callback){callback(false,dbObject)}break}})};factory.implementDbs=function(metadataDb,resultObject,resultHandler){IndexedDbFactory.deleteDb(factory.metadataDb.name,function(isDeleted){if(isDeleted){factory.createDb(metadataDb,resultObject,function(isSuccess){if(isSuccess){resultHandler(true)}else{resultHandler(false)}})}})};factory.createDb=function(metadataDb,createDbObject,resultHandler){IndexedDbFactory.createNewDb(metadataDb.name,metadataDb.version,function(eventType,dbObject){switch(eventType){case IndexedDbFactory.DB_EVENT.UPGRADE:console.info(new Date()+": Upgrade Event for the db "+metadataDb.name);metadataDb.found=true;if(dbObject&&createDbObject){IndexedDbFactory.createObjectStores(dbObject,createDbObject);metadataDb.status=DB_STATUS.CREATED}break;case IndexedDbFactory.DB_EVENT.SUCCESS:metadataDb.db=dbObject;if(dbObject&&createDbObject){IndexedDbFactory.insertIntoDb(dbObject,createDbObject);metadataDb.status=DB_STATUS.UPDATED;console.info(new Date()+": Successfully Inserted Index Db "+metadataDb.name);resultHandler(true)}break;case IndexedDbFactory.DB_EVENT.FAILED:console.error(new Date()+": Not able to create DB "+metadataDb.name);metadataDb.found=false;metadataDb.status=DB_STATUS.NEW;break}})};factory.deleteDb=function(dbName,callback){IndexedDbFactory.deleteDb(dbName,function(isDeleted){if(isDeleted){callback(DB_STATUS.SUCCESS)}else{callback(DB_STATUS.FAILED)}})};factory.deleteMetadataDb=function(callback){factory.initDbName();IndexedDbFactory.deleteDb(factory.metadataDb.name,function(isDeleted){if(isDeleted){callback(DB_STATUS.SUCCESS)}else{callback(DB_STATUS.FAILED)}})};factory.getAllByStoreName=function(metadataDb,storeName,searchResultHandler){IndexedDbFactory.getAll(metadataDb.db,storeName,function(searchedObjectsList){searchResultHandler(searchedObjectsList)})};return factory});var app=app||angular.module("hxApp.directive",[]);app.directive("hxDebitMemoPod",["$rootScope","$location","TransactionConstants","PaymentConstants","AppUtils","$app","LocalStorageService","AppPodServices",function($rootScope,$location,TransactionConstants,PaymentConstants,AppUtils,$app,LocalStorageService,AppPodServices){return{restrict:"E",scope:{transactionId:"=",overridePrice:"=",sku:"=",teamFlow:"="},replace:true,templateUrl:"js/app-components/debit-memo/hx-debit-memo-pod.html",link:function($scope,element,attrs){$scope.isServiceLoading=true;$scope.isReviewServiceLoading=false;$scope.isOverrideServiceLoading=false;$scope.isOverrideBtnShow=false;$scope.isOverrideComplete=false;$scope.isFirstTimeInvoke=true;$scope.isMemoBtnEnabled=false;$scope.INITIALIZE_DM_TRANSACTION="INITIALIZE_DM_TRANSACTION";$scope.CREATE_DEBIT_MEMO_EVENT_FAILED="CREATE_DEBIT_MEMO_EVENT_FAILED";$scope.CREATE_DEBIT_MEMO_EVENT_SUCCESS="CREATE_DEBIT_MEMO_EVENT_SUCCESS";$scope.DEBIT_MEMO_VIEW_LOADED="DEBIT_MEMO_VIEW_LOADED";$scope.transaction;$scope.$on($scope.INITIALIZE_DM_TRANSACTION,function(event,messages){if($scope.isFirstTimeInvoke){$scope.isFirstTimeInvoke=false;$scope.initializeTransaction()}});$scope.getTransaction=function(){AppPodServices.getTransaction({guid:"",number:$scope.transactionId,subscriptionId:""}).success(function(result){$scope.isServiceLoading=false;$scope.transaction=result;if($scope.transaction&&$scope.transaction.items.length==1){$scope.transaction.items[0].NotModify_promoPrice=$scope.transaction.items[0].promoPrice;$scope.transaction.items[0].NotModify_quantity=$scope.transaction.items[0].quantity;$scope.transaction.items[0].NotModify_listPrice=$scope.transaction.items[0].listPrice;if(($scope.transaction.items[0].deliveryStatus!=TransactionConstants.DELIVERY_STATUS_COMPLETELY_PROCESSED||$scope.transaction.items[0].deliveryStatus!=TransactionConstants.DELIVERY_STATUS_PARTIALLY_PROCESSED)&&($scope.transaction&&$scope.transaction.paymentDetails&&($scope.transaction.paymentDetails.paymentType!=PaymentConstants.DUMMY_CARD&&$scope.transaction.paymentDetails.paymentType!=PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE&&$scope.transaction.paymentDetails.paymentType!=PaymentConstants.CVS_PAYMENT_TYPE))&&$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=true}}else{var transactionItem=[];for(var itemCount=0;itemCount<$scope.transaction.items.length;itemCount++){var item=$scope.transaction.items[itemCount];if($scope.sku==item.sku){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice;if((item.deliveryStatus==TransactionConstants.DELIVERY_STATUS_COMPLETELY_PROCESSED||item.deliveryStatus==TransactionConstants.DELIVERY_STATUS_PARTIALLY_PROCESSED)&&($scope.transaction&&$scope.transaction.paymentDetails&&($scope.transaction.paymentDetails.paymentType!=PaymentConstants.DUMMY_CARD&&$scope.transaction.paymentDetails.paymentType!=PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE&&$scope.transaction.paymentDetails.paymentType!=PaymentConstants.CVS_PAYMENT_TYPE))&&$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=true}transactionItem.push(item);break}}$scope.transaction.items=transactionItem}if($scope.isMemoBtnEnabled){$scope.reviewDebitMemoTransaction();$scope.message=""}else{if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){$scope.message="Debit Memo Is Not Enabled For This Payment Type"}else{$scope.message="Debit Memo Is Not Enabled For This Product"}$scope.isServiceLoading=false}}).error(function(){$scope.message="Failed to load transaction";$scope.isServiceLoading=false;AppUtils.sendLogToServer("Cancellation Debit Memo Transaction Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.initializeTransaction=function(){if($scope.transactionId){$scope.getTransaction()}else{$scope.message="Failed to load debit memo";$scope.isServiceLoading=false}};$scope.checkOverrideBtn=function(){var returnValue=false;var listPriceValid=true;if($scope.debitMemoReviewTransaction&&$scope.debitMemoReviewTransaction.items&&$scope.debitMemoReviewTransaction.items.length>0){if($scope.debitMemoReviewTransaction.items[0].promoPrice!=$scope.debitMemoReviewTransaction.items[0].NotModify_promoPrice){returnValue=true}if($scope.debitMemoReviewTransaction.items[0].promoPrice==""||isNaN(Number($scope.debitMemoReviewTransaction.items[0].promoPrice))){listPriceValid=false}}$scope.isOverrideBtnShow=returnValue;if(!listPriceValid){$scope.transactionErrorMessage="Enter valid Debit Memo price";$scope.transactionMessage="";$scope.isOverrideComplete=false;returnValue=false}else{$scope.transactionErrorMessage=""}return returnValue};$scope.reviewDebitMemoTransaction=function(){$scope.isReviewServiceLoading=true;var debitMemoReview=angular.copy($scope.transaction);debitMemoReview.transactionType=TransactionConstants.TRANSACTION_DEBIT_MEMO;debitMemoReview.returnInProgress=true;debitMemoReview.returnReasonCode="DC";debitMemoReview.paymentDetails=angular.copy($scope.transaction.paymentDetails);if(debitMemoReview.items&&debitMemoReview.items.length==1){debitMemoReview.items[0].toReturn=true;debitMemoReview.items[0].quantity=1;debitMemoReview.items[0].quantityToReturn=1}else{angular.forEach(debitMemoReview.items,function(productItem){if($scope.sku==productItem.sku){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity}else{productItem.toReturn=false;productItem.quantityToReturn=0}})}if($scope.overridePrice||$scope.overridePrice==0){$scope.debitMemoReviewTransaction=angular.copy(debitMemoReview);$scope.debitMemoReviewTransaction.items[0].NotModify_promoPrice=$scope.debitMemoReviewTransaction.items[0].promoPrice;$scope.debitMemoReviewTransaction.items[0].NotModify_quantity=$scope.debitMemoReviewTransaction.items[0].quantity;$scope.debitMemoReviewTransaction.items[0].NotModify_listPrice=$scope.debitMemoReviewTransaction.items[0].listPrice;$scope.debitMemoReviewTransaction.items[0].promoPrice=Number($scope.overridePrice);$scope.isReviewServiceLoading=false;$scope.$emit($scope.DEBIT_MEMO_VIEW_LOADED,true);$scope.overrideDebitMemo(true)}else{AppPodServices.reviewTransaction(debitMemoReview).success(function(result){$scope.debitMemoReviewTransaction=result;angular.forEach($scope.debitMemoReviewTransaction.items,function(item){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice});$scope.isReviewServiceLoading=false;$scope.$emit($scope.DEBIT_MEMO_VIEW_LOADED,true)}).error(function(result){$scope.isReviewServiceLoading=false;AppUtils.sendLogToServer("Cancellation Debit Memo Review Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})}};$scope.overrideDebitMemo=function(isDefaultOverride){$scope.isOverrideServiceLoading=true;$scope.isOverrideComplete=false;$scope.transactionMessage="";var debitMemoOverride=angular.copy($scope.transaction);debitMemoOverride.transactionType=TransactionConstants.TRANSACTION_DEBIT_MEMO;debitMemoOverride.returnInProgress=true;debitMemoOverride.returnReasonCode="DC";debitMemoOverride.paymentDetails=angular.copy($scope.transaction.paymentDetails);debitMemoOverride.items[0].toReturn=true;debitMemoOverride.items[0].quantity=1;debitMemoOverride.items[0].quantityToReturn=1;debitMemoOverride.items[0].promoPrice=Number($scope.debitMemoReviewTransaction.items[0].promoPrice).toFixed(2);debitMemoOverride.items[0].listPrice=$scope.debitMemoReviewTransaction.items[0].NotModify_listPrice;AppPodServices.reviewTransaction(debitMemoOverride).success(function(result){$scope.debitMemoOverrideTransaction=result;angular.forEach($scope.debitMemoOverrideTransaction.items,function(item){item.NotModify_promoPrice=item.promoPrice;item.NotModify_quantity=item.quantity;item.NotModify_listPrice=item.listPrice});$scope.isOverrideComplete=true;$scope.isOverrideServiceLoading=false;$scope.transactionMessage=isDefaultOverride?"":"Override Complete, Create DM now"}).error(function(result){$scope.isOverrideComplete=true;$scope.isOverrideServiceLoading=false;$scope.transactionReviewMessage="Override Failed, Please try again...";AppUtils.sendLogToServer("Cancellation Debit Memo Override Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.checkCreateDebitMemoBtn=function(){if($scope.isOverrideBtnShow){if($scope.isOverrideComplete){return false}return true}return false};$scope.createDebitMemo=function(){$scope.loadingMessage="Creating Debit Memo, Please Wait...";$scope.showViewLoading();if($scope.teamFlow){$scope.isDebitMemoProcessing=true}if(!$scope.debitMemoOverrideTransaction){$scope.debitMemoOverrideTransaction=angular.copy($scope.debitMemoReviewTransaction)}$scope.debitMemoOverrideTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails);AppPodServices.createTransaction($scope.debitMemoOverrideTransaction).success(function(result){if(!result||!result.transactionNumber||AppUtils.isHavingErrorMessage(result.messages)){$scope.transactionReviewMessage="Debit Memo Creation Failed, Please try again...";$scope.$emit($scope.CREATE_DEBIT_MEMO_EVENT_FAILED,"Debit Memo Failed",result);AppUtils.sendLogToServer("Cancellation Debit Memo Creation Service Failed With Errors: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)}else{$scope.$emit($scope.CREATE_DEBIT_MEMO_EVENT_SUCCESS,"Debit Memo Created",result);AppUtils.sendLogToServer("Cancellation Debit Memo Creation Service Successful: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)}$scope.hideViewLoading()}).error(function(result){$scope.transactionReviewMessage="Debit Memo Service Failed, Please try again...";$scope.$emit($scope.CREATE_DEBIT_MEMO_EVENT_FAILED,"Debit Memo Failed",result);$scope.hideViewLoading();AppUtils.sendLogToServer("Cancellation Debit Memo Creation Service Failed: Transaction ID - "+$scope.transactionId+", SKU - "+$scope.sku)})};$scope.showViewLoading=function(){if($scope.teamFlow){$app.showLoading("Processing cancellation")}else{$("#debit-memo-view-loading-modal").modal("show")}};$scope.hideViewLoading=function(){$("#debit-memo-view-loading-modal").modal("hide")}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxPaymentViewPod",["$rootScope","PaymentConstants","MetadataService",function($rootScope,PaymentConstants,MetadataService){return{restrict:"E",scope:{transaction:"=",metadata:"="},replace:true,templateUrl:"js/app-components/payment-view-pod/payment-view-pod.html",link:function($scope,element,attrs){$scope.PaymentConstants=PaymentConstants;if($scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.transaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if($scope.cardTypeName==="MC"){$scope.cardTypeName="MasterCard"}}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxTnCPod",["$rootScope","$http","AppConstants","TransactionConstants","PaymentConstants","ImsCustomerService","StoreUtil","AppUtils","CommerceServices",function($rootScope,$http,AppConstants,TransactionConstants,PaymentConstants,ImsCustomerService,StoreUtil,AppUtils,CommerceServices){return{restrict:"E",scope:{sku:"=",countryCode:"=",marketSegment:"=",templateName:"="},replace:true,templateUrl:"js/app-components/tnc-pod/tnc-pod.html",link:function($scope,element,attrs){$scope.PaymentConstants=PaymentConstants;$scope.termsAndConditionsText="";$scope.isTncLoading=true;$scope.isTncContentLoadingFailed=false;$scope.getTnCTemplate=function(){CommerceServices.searchBySku({sku:$scope.sku,country:$scope.countryCode,market_segment:$scope.marketSegment}).success(function(data,status,headers,config){if(data&&data.sellableItem&&data.sellableItem.terms_and_conditions_service_name){$scope.templateName=data.sellableItem.terms_and_conditions_service_name;$scope.getTnCContent()}else{$scope.isTncLoading=true;$scope.isTncContentLoadingFailed=true;AppUtils.sendLogToServer("The eCommerce Template API Not Having Template Name for "+$scope.countryCode+" for SKU = "+$scope.sku)}}).error(function(data,status,headers,config){$scope.isTncLoading=true;$scope.isTncContentLoadingFailed=true;AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.countryCode+" for SKU = "+$scope.sku)})};$scope.getTnCContent=function(){ImsCustomerService.getTncByTemplate({templateName:$scope.templateName,locale:StoreUtil.getDefaultCountryLanguage($scope.countryCode)}).success(function(result){$scope.isTncLoading=false;if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");$scope.termsAndConditionsText=tncText;$scope.isTncContentLoadingFailed=false;$scope.$parent.tncStatus(true)}else{$scope.isTncContentLoadingFailed=true;$scope.$parent.tncStatus(false)}}).error(function(result){$scope.isTncLoading=false;$scope.isTncContentLoadingFailed=true;$scope.$parent.tncStatus(false);AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.countryCode+" for Template Name = "+$scope.templateName)})};if($scope.templateName){$scope.getTnCContent()}else{if($scope.sku&&$scope.countryCode){$scope.marketSegment=$scope.marketSegment?$scope.marketSegment:AppConstants.MARKET_TYPE_COMMERCIAL;$scope.getTnCTemplate()}else{$scope.isTncLoading=false;$scope.isTncContentLoadingFailed=true;$scope.$parent.tncStatus(false)}}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("ImsCustomerDto",{firstName:"",lastName:"",email:"",adobeId:"",rengaGuid:"",address:{}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ImsCustomerService",["$http",function($http){var service={};service.getItem=function(data){return $http({method:"POST",url:"../imsCustomerProfileService/getCustomerProfile.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data,transformResponse:function(data,headerGetters){try{data=angular.fromJson(data)}catch(e){console.log("Failed to convert into Json in ImsCustomerService")}return data}})};service.getCustomerOrganizations=function(data){return $http({method:"POST",url:"../imsCustomerProfileService/getCustomerOrganizations.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data,transformResponse:function(data,headerGetters){try{data=angular.fromJson(data)}catch(e){console.log("Failed to convert into Json in ImsCustomerService")}return data}})};service.resetPassword=function(data){return $http({method:"POST",url:"../imsCustomerProfileService/sendPasswordResetEmail.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.verifyEmail=function(data){return $http({method:"POST",url:"../imsCustomerProfileService/initiateEmailVerification.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTncByTemplate=function(data){return $http({method:"POST",url:"../imsCustomerProfileService/getTermsAndConditions.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getCustomerProfileByGuid=function(data){return $http({method:"GET",url:"../imsCustomerProfileService/getCustomerProfileByGuid.do?guid="+data.guid+"&authSrc="+data.authSrc,})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("ImsNewCustomerDto",{person:{email:"",firstName:"",lastName:"",countryCode:"",locale:"en_US",marketingPermission:false,paidUser:true},targetClient:{clientId:"SunbreakWebUI1",scopes:"openid,AdobeID",callbackUrl:"https://stage.adobesunbreak.com"}});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("IMSSecondryClientService",["$http",function($http){var service={};var transform=function(data){return $.param(data)};service.createPerson=function(data){return $http({method:"POST",url:"../imsSecondaryClientService/createPerson.do",headers:{"Content-Type":"application/json",Accept:"*/*"},data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("IndexedDbFactory",function(){var factory={};indexedDB=indexedDB||webkitIndexedDB||mozIndexedDB||msIndexedDB;const DB_EVENT={SUCCESS:"success",UPGRADE:"upgrade",BLOCKED:"blocked",FAILED:"failed"};factory.DB_EVENT=DB_EVENT;factory.getAllDbs=function(resultHandler){indexedDB.webkitGetDatabaseNames().onsuccess=function(sender,arguments){if(resultHandler){resultHandler(DB_EVENT.SUCCESS,sender.target.result)}};indexedDB.webkitGetDatabaseNames().onfailed=function(sender,arguments){if(resultHandler){resultHandler(DB_EVENT.FAILED)}}};factory.createNewDb=function(dbName,dbVersion,resultHandler){var newDbRequest=indexedDB.open(dbName,dbVersion);newDbRequest.onupgradeneeded=function(event){console.log(new Date()+": Created Indexed DB : "+dbName);if(resultHandler){resultHandler(DB_EVENT.UPGRADE,event.target.result)}};newDbRequest.onsuccess=function(event){console.log(new Date()+": Successfully Opened Indexed DB : "+dbName);if(resultHandler){resultHandler(DB_EVENT.SUCCESS,event.currentTarget.result)}};newDbRequest.onblocked=function(event){console.error(new Date()+": Indexed DB : "+dbName+" Blocked");if(resultHandler){resultHandler(DB_EVENT.BLOCKED,event.currentTarget.result)}}};factory.createObjectStores=function(db,objectStoreNames){for(var key in objectStoreNames){var objectStore=db.createObjectStore(key,{autoIncrement:true});if(angular.isArray(objectStoreNames[key])){if(objectStoreNames[key].length>0){var firstObject=objectStoreNames[key][0];for(var objectKey in firstObject){objectStore.createIndex(objectKey,objectKey,{unique:false})}}}}};factory.openDb=function(dbName,dbVersion,resultHandler){var openDbRequest=indexedDB.open(dbName,dbVersion);openDbRequest.onsuccess=function(event){console.log(new Date()+": Successfully Opened Indexed DB : "+dbName);if(resultHandler){resultHandler(DB_EVENT.SUCCESS,event.currentTarget.result)}};openDbRequest.onblocked=function(event){console.error(new Date()+": Indexed DB : "+dbName+" Blocked");if(resultHandler){resultHandler(DB_EVENT.BLOCKED,event.currentTarget.result)}};openDbRequest.onblocked=function(event){console.error(new Date()+": Indexed DB : "+dbName+" Blocked");if(resultHandler){resultHandler(DB_EVENT.BLOCKED,event.currentTarget.result)}}};factory.insertIntoDb=function(db,insertData){for(var key in insertData){if(angular.isArray(insertData[key])){var transaction=db.transaction([key],"readwrite");var objectStore=transaction.objectStore(key);angular.forEach(insertData[key],function(item){var request=objectStore.add(item)})}}};factory.deleteDb=function(dbName,callback){factory.openDb(dbName,1,function(eventType,dbObject){if(eventType==DB_EVENT.SUCCESS){dbObject.close();console.log(new Date()+": Deleting "+dbName+" DB");var deleteDbRequest=indexedDB.deleteDatabase(dbName);deleteDbRequest.onsuccess=function(event){console.log(new Date()+": Successfully Deleted "+dbName+" DB");if(callback){callback(true)}};deleteDbRequest.onerror=function(event){console.log(new Date()+": Failed Deletion of "+dbName+" DB");if(callback){callback(false)}}}else{console.error(new Date()+" Not able to open DB "+appDb.name)}})};factory.getAll=function(db,storeName,callback){if(db){var itemList=[];db.transaction(storeName).objectStore(storeName).openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){itemList.push(cursor.value);cursor["continue"]()}else{callback(itemList)}}}};return factory});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("IndividualSubscriptionListCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","Utils","ImsCustomerService",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,Utils,ImsCustomerService){TrackingService.trackPageView("Communication","Communication");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Team Subscription");$scope.customerAccountID=$routeParams.customerAccountID;$scope.customer={};var customerSearchObj={guid:$scope.customerAccountID.split("@")[0],authSrc:$scope.customerAccountID.split("@")[1]};ImsCustomerService.getCustomerProfileByGuid(customerSearchObj).then(function(response){if(angular.isDefined(response.data.error)){$scope.customer.messages=Utils.showMessage("error","Customer is not valid");$scope.isLoading=false;return}$scope.customer=response.data;setTimeout(function(){$rootScope.$broadcast("LOAD_INDIVIDUAL_SUBSCRIPTION_LIST",$scope.customer)},0);$scope.isLoading=false},function(error){console.log("IMS details load failed");$scope.customer.messages.push(Utils.showMessage("error","Customer is not valid"));$scope.isLoading=false})}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListIndividualSubscription",["Utils","webGuidFilterFilter","CustomerSubscriptionService","CustomerUtil","AppConstants","AppUtils","TeamUtil","CustomerConstants","SubscriptionUtil","TeamConstants","CAHService","$rootScope","SubscriptionConstants",function(Utils,webGuidFilterFilter,CustomerSubscriptionService,CustomerUtil,AppConstants,AppUtils,TeamUtil,CustomerConstants,SubscriptionUtil,TeamConstants,CAHService,$rootScope,SubscriptionConstants){return{restrict:"EA",scope:{customerNo:"=customerno",contactNo:"=contactno",filterSubscriptions:"=filter"},replace:true,templateUrl:"js/customer/subscription/partials/individual-subscription-list-directive.html",link:function($scope,element,attrs){$scope.$on("LOAD_INDIVIDUAL_SUBSCRIPTION_LIST",function(event,customerObj){$scope.customerObj=customerObj;$scope.customerGuid=customerObj.userId.split("@")[0];$scope.loadSubscriptions()});var handleValueChange=function(value){if(value){$scope.newCaseCustomerLink=Utils.newCaseCustomerLink($scope.customerNo,$scope.contactNo)}};$scope.encodeUriQuery=function(val){return encodeURIComponent(val)};$scope.$watch(function(){return $scope.contactNo},handleValueChange);$scope.$watch(function(){return $scope.customerNo},handleValueChange);$scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";$scope.CustomerConstants=CustomerConstants;$scope.isSubscriptionLoading=false;$scope.loadSubscriptions=function(){$scope.isSubscriptionLoading=true;$scope.guid=$scope.customerGuid;$scope.locale="en_US";$scope.subscriptionAccountId=$scope.customerObj.userId;console.log("Query CustomerSubscriptionService.getSubscriptionLists",$scope.customerGuid);CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:$scope.subscriptionAccountId,locale:$scope.locale}).success(function(result){console.log("Success CustomerSubscriptionService.getSubscriptionLists");$scope.subscriptionlists=result;$scope.loadCAHGUIDetails();for(i=0;i<$scope.subscriptionlists.length;i++){$scope.subscriptionlists[i].transactionLabel=SubscriptionConstants.SUBSCRIPITON_EXTERNAL_REF_NUMBER;$scope.subscriptionlists[i].formatedPurchaseDate=$scope.subscriptionlists[i].contract.termStartDate;$scope.subscriptionlists[i].ageing=moment().diff(new Date($scope.subscriptionlists[i].formatedPurchaseDate),"days");$scope.subscriptionlists[i].locale=$scope.locale;$scope.subscriptionlists[i].subscriptionAccountId=$scope.guid;$scope.subscriptionlists[i]["backupstoreOrderNumber"]=$scope.subscriptionlists[i].storeOrderNumber;if($scope.subscriptionlists[i].paymentStatus.toUpperCase()!=SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){$scope.subscriptionlists[i].storeOrderNumber=$scope.subscriptionlists[i].contract.externalContractId;$scope.subscriptionlists[i].transactionLabel=SubscriptionConstants.SUBSCRIPTION_CONTRACT_ID}$scope.subscriptionlists[i].productName=$scope.subscriptionlists[i].localizedLongProductDescriptor}$scope.isSubscriptionLoading=false;$scope.records=$scope.subscriptionlists}).error(function(error){console.log("error",error);$("#subscriptions").html(error);$scope.isSubscriptionLoading=false})};$scope.loadCAHGUIDetails=function(){CAHService.getCAHGUIDDetail($scope.customerGuid).success(function(result,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetail",result);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="SUCCESS";messageObject.Function="CAH-IND service";messageObject.Flow="Customer Detail";messageObject.guid=$scope.customerGuid;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetailFailed",error);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="ERROR";messageObject.Function="CAH-IND service";messageObject.Flow="Customer Detail";messageObject.guid=webGuidFilterFilter($scope.customer);AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=$scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};$scope.createTSCase=function(rec,contextType){var returnCaseTemplateUrl;var tenureDate=angular.isDefined(rec.contract.termStartDate)==true?rec.contract.termStartDate.split("T")[0]:"";returnCaseTemplateUrl="/case/newTs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&subId="+rec.id+"&contextType="+contextType+"&customerGuid="+rec.subscriptionAccountId+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate)+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.createCSCase=function(rec,contextType){var returnCaseTemplateUr;var tenureDate=angular.isDefined(rec.contract.termStartDate)==true?rec.contract.termStartDate.split("T")[0]:"";returnCaseTemplateUr="/case/newCs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&subId="+rec.id+"&contextType="+contextType+"&customerGuid="+rec.subscriptionAccountId+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate)+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUr)};$scope.toggleExpandCollapseAll=function(){var buttonClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#subscription-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionSubscriptionsView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionSubscriptionsView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};$scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseSubscriptionItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseSubscriptionItems"+indexId).removeClass().addClass(accordionClassName)};$scope.getProductSeats=function(records,offerId){var qty=0;angular.forEach(records,function(product){if(offerId==product.offerId&&product.paymentStatus&&product.paymentStatus.toUpperCase()!=="CANCELLED"){qty=qty+product.quantity}});return qty};$scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("InvoicePreviewService",["$http",function($http){var service={};service.getInvoicePreviewUrl=function(data){return $http({method:"POST",url:"../invoicePreviewService/getInvoicePreviewUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getInvoice=function(data){return $http({method:"POST",url:"../invoicePreviewService/getInvoice.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("JilServices",["$http",function($http){var service={};service.createContractCart=function(data){var apiHubData={urlKey:"jil-carts-createCart",requestBody:data,requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.updateContractCart=function(data){var apiHubData={urlKey:"jil-carts-updateCart",pathVariables:{cartId:data.cartId},requestBody:data,requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("languageText",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"=",languages:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}angular.forEach(scope.languages,function(item){if(value==item.code){scope.value=item.description;return}})})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListCases",["$filter","Utils","MetadataService","LocalStorageService","$timeout",function($filter,Utils,MetadataService,LocalStorageService,$timeout){return{restrict:"EA",scope:{records:"=",loading:"="},replace:true,templateUrl:"js/customer/partials/list-cases.html",link:function(scope,element,attrs){scope.customerLink=Utils.customerLink;scope.metadata={};scope.metadata.tsCaseMetadataDto={};scope.metadata.tsCaseMetadataDto.tsCasePriorityDtos={};scope.intervalSelection=9;scope.listViewMode="collapsed";scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}scope.creationDateFilter=result};scope.handleIntervalChange=function(){scope.updateInterval(scope.intervalSelection)};scope.getStatusColor=function(statusText){return Utils.getStatusColor(statusText)};scope.handleCollapseList=function(){scope.listViewMode="collapsed"};scope.handleExpandList=function(){scope.listViewMode="expand"};scope.dateFilterFunction=function(data){if(data.creationDate>scope.creationDateFilter.getTime()){return true}};scope.loadCases=function(){scope.$parent.loadCases()};scope.updateInterval(scope.intervalSelection)}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListCommunication",["$filter","APOService","Utils","AppConstants",function($filter,APOService,Utils,AppConstants){return{restrict:"EA",scope:{customer:"=",contact:"=",},replace:true,templateUrl:"js/customer/partials/list-communication.html",link:function($scope,element,attrs){$scope.emails=[];$scope.loading=false;var startDatePicker=$("#startDatePicker").datetimepicker({sideBySide:true,defaultDate:moment(new Date()).subtract(3,"months"),maxDate:moment(new Date())});startDatePicker.on("dp.change",function(e){$scope.isStartDateSelected=true;if($scope.isFormValid()&&$("#txtStartEmailDate").val()!=""){$("#btnSearchEmails").removeAttr("disabled")}else{$("#btnSearchEmails").attr("disabled","disabled")}if(moment($("#txtStartEmailDate").val()).isValid()){$("#endDatePicker").data("DateTimePicker").minDate(moment($("#txtStartEmailDate").val()))}});var endDatePicker=$("#endDatePicker").datetimepicker({sideBySide:true,defaultDate:moment(new Date()),maxDate:moment(new Date())});$("#txtStartEmailDate").tooltip({trigger:"focus",placement:"bottom",title:"Click on calendar icon to select start date and time"});$("#txtEndEmailDate").tooltip({trigger:"focus",placement:"bottom",title:"Click on calendar icon to select end date and time"});endDatePicker.on("dp.change",function(e){$scope.isEndDateSelected=true;if($scope.isFormValid()&&$("#txtEndEmailDate").val()!=""){$("#btnSearchEmails").removeAttr("disabled")}else{$("#btnSearchEmails").attr("disabled","disabled")}});$scope.isFormValid=function(){return moment($("#txtStartEmailDate").val()).isValid()&&moment($("#txtEndEmailDate").val()).isValid()&&!$scope.loading};$scope.getEmailsFromAPO=function(){$scope.loading=true;if(angular.isDefined($scope.customer.bpType)&&$scope.customer.bpType=="2"){if(angular.isUndefined($scope.contact)&&angular.isUndefined($scope.contact.email)){$scope.emails=[];$scope.loading=false;console.log("Customer email is not valid");$scope.errorMessages=Utils.showMessage("error","Customer email is not valid");return}}else{if(angular.isUndefined($scope.customer)&&angular.isUndefined($scope.customer.email)){$scope.emails=[];$scope.loading=false;console.log("Contact email is not valid");$scope.errorMessages=Utils.showMessage("error","Contact email is not valid");return}}$scope.loading=true;var requestObj={email:$scope.customer.bpType=="2"?$scope.contact.email:$scope.customer.email,startDateTime:moment($("#txtStartEmailDate").val()).format("YYYY-MM-DDTHH:mm:00"),endDateTime:moment($("#txtEndEmailDate").val()).format("YYYY-MM-DDTHH:mm:00")};APOService.getEmails(requestObj).success(function(response){console.log("APO emails ",response);$scope.emails=response;$scope.loading=false;$scope.errorMessages=[]}).error(function(errorData){console.log("Error in getting emails from APO",errorData);$scope.errorMessages=Utils.showMessage("error","Error while loading emails from APO. Please try again.");$scope.emails=[];$scope.loading=false})};$scope.$on("LOAD_CUSTOMER_EMAILS",function(){$scope.getEmailsFromAPO()});$scope.getAPOTemplateName=function(template){var templateObj=_.find(AppConstants.APO_TEMPLATES,{templateName:template});return angular.isDefined(templateObj)?templateObj.description:template};$scope.statusDescriptions=[{status:"queued",description:"The email is not yet sent (did not left Adobe's email servers)."},{status:"sent",description:"The email left Adobe's servers but we don't have confirmation yet that it reached its destination."},{status:"delivered",description:"The email reached the recipient's mailbox."},{status:"opened",description:"The recipient opened the email."},{status:"complained",description:"The recipient complained about this email as being unsolicited (spam)."},{status:"bounced",description:"The email could not be delivered to the recipient, and is returned with an error message."}];$scope.getStatusDescription=function(emailStatus){var statusObj=_.find($scope.statusDescriptions,{status:emailStatus.toLowerCase()});return angular.isDefined(statusObj)?statusObj.description:emailStatus}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListContracts",["Utils",function(Utils){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&"},replace:true,templateUrl:"js/customer/partials/list-contracts.html",link:function(scope,element,attrs){var handleValueChange=function(value){if(value){scope.customerLink2=Utils.customerLink2(scope.customerNo,scope.contactNo)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refresh=function(){scope.$parent.refreshProducts()}}}}]);app.directive("ngListStocks",["Utils",function(Utils){return{restrict:"EA",scope:{records:"=",webguid:"=webguid",contactNo:"=contactno",refresh:"&"},replace:true,templateUrl:"js/customer/partials/list-customer-stock-entitlements.html",link:function(scope,element,attrs){scope.refresh=function(){scope.$parent.refreshProducts()}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListMemos",["Utils","MetadataService","CustomerRecordService",function(Utils,MetadataService,CustomerRecordService){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",memoNoteTypes:"=memonotetypes",refresh:"&"},replace:true,templateUrl:"js/customer/partials/list-memos.html",link:function(scope,element,attrs){var handleValueChange=function(value){if(value){scope.customerLink2=Utils.customerLink2(scope.customerNo,scope.contactNo)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refresh=function(){scope.$parent.refreshProducts()};scope.showMemoModal=function(){element.find("#addMemoModal").modal("show")};scope.closeModal=function(){element.find("#addMemoModal").modal("hide");scope.messages=[];scope.memoType="";scope.memoContent=""};scope.addMemo=function(){var memoObject=new Object();memoObject.createdBy=scope.$root.currentUser.firstName+" "+scope.$root.currentUser.lastName;memoObject.createdOn=new Date();memoObject.memoNote=html_sanitize(scope.memoContent);memoObject.newlyAdded=true;memoObject.searchableContent=null;memoObject.type=scope.memoType;angular.forEach(scope.$parent.metadata[MetadataService.STORE_NAMES.MEMO_NOTE_TYPES],function(memoItem){if(memoItem.id==memoObject.type){memoObject.typeName=memoItem.value}});scope.records.push(memoObject);scope.saveMemo(scope.$parent.customer)};scope.saveMemo=function(customer){scope.isSaving=true;var editCustomer=angular.copy(scope.$parent.customer);delete editCustomer.person;delete editCustomer.messages;angular.forEach(editCustomer.customerRelations,function(cr){delete cr.fax;delete cr.faxExt;delete cr.contactFunction;delete cr.title;delete cr.department;delete cr.dayPhone;delete cr.searchableContent});if(editCustomer.memoNotes){angular.forEach(editCustomer.memoNotes,function(memoItem){delete memoItem.typeName})}CustomerRecordService.updateItem(editCustomer).success(function(result){scope.isSaving=false;scope.showMessage("info","Memo Added Successfully");angular.forEach(result.memoNotes,function(memoNote){angular.forEach(scope.$parent.metadata[MetadataService.STORE_NAMES.MEMO_NOTE_TYPES],function(memoItem){if(memoItem.id==memoNote.type){memoNote.typeName=memoItem.value}})});scope.$parent.customer.memoNotes=result.memoNotes;scope.closeModal()}).error(function(result){scope.isSaving=false;scope.closeModal();scope.showMessage("error","Failed to add memo")})};scope.showMessage=function(type,message){scope.messages=[];scope.messages.push({info:type=="info",error:type=="error",text:message})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListProductsCrm",["Utils","$rootScope","$routeParams","$location","AppConstants","AppUtils",function(Utils,$rootScope,$routeParams,$location,AppConstants,AppUtils){return{restrict:"EA",scope:{records:"=",subTab:"=",perpetualRecords:"=",enterpriseRecords:"=",allRecords:"=",customerNo:"=customerno",customerdetail:"=customerdetail",contactNo:"=contactno",refresh:"&",loading:"=",orgguid:"="},replace:true,templateUrl:"js/customer/partials/list-products-crm.html",link:function(scope,element,attrs){scope.AppConstants=AppConstants;scope.VIEW_TYPE_PERPETUAL="PERPETUAL";scope.VIEW_TYPE_ENTERPRISE="ENTERPRISE";scope.VIEW_TYPE_ALL="ALL";scope.viewType=scope.VIEW_TYPE_PERPETUAL;scope.oldUI=$routeParams.oldui=="true"?true:false;var handleValueChange=function(value){if(value){scope.newCaseCustomerLink=Utils.newCaseCustomerLink(scope.customerNo,scope.contactNo)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refresh=function(){scope.$parent.refreshProducts("perpetual")};scope.filterProductName=function(recordItem){var productName="";if(angular.uppercase(recordItem.name)!="CCLE"&&(angular.uppercase(recordItem.regInd)=="C")){productName=recordItem.metaName+" (CCTeam)"}else{if((angular.uppercase(recordItem.name)=="CCSV"||angular.uppercase(recordItem.name)=="APAP")&&(angular.uppercase(recordItem.regType)=="N")){scope.orgNameRecordStyle={width:"240px"};productName=recordItem.offeringCode+" | "+recordItem.cceDesc}else{productName=recordItem.metaName}}return productName};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.showProductDetail=function(productData,productContext){productData.productContext=productContext;scope.$parent.selectedProductData=productData;$rootScope.$broadcast("showProductDetailEvent",productData)};scope.refreshProductList=function(){if(scope.viewType==scope.VIEW_TYPE_PERPETUAL){scope.$parent.refreshProducts("perpetual")}else{if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE){scope.$parent.refreshProducts("enterprise")}else{scope.$parent.refreshProducts("all")}}};scope.isEnterpriseID=function(){return scope.$parent.customer.enterpriseId};scope.isCustomerRecord=function(){return scope.$parent.customer.bpType!=2};scope.createTSCase=function(rec,contextType){var returnCaseTemplateUrl;if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE){returnCaseTemplateUrl="/case/newTs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&productSku="+rec.sku+"&contextType="+contextType+"&orgguid="+scope.orgguid}else{returnCaseTemplateUrl="/case/newTs/?"+scope.newCaseCustomerLink+"&serialNumber="+rec.serialNumber+"&componentId="+rec.componentId+"&regType="+rec.regType+"&prodMetaName="+scope.encodeUriQuery(rec.metaName)+"&prodMetaLanguage="+rec.metaLanguage+"&prodMetaConfig="+rec.metaConfig+"&prodMetaPlatform="+rec.metaPlatform+"&prodName="+rec.name+"&prodPlatform="+rec.platform+"&prodLang="+rec.language+"&prodVersion="+rec.version+"&productType="+rec.regInd+"&productSegment="+rec.educational+"&orgguid="+scope.orgguid}window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};scope.createCSCase=function(rec,contextType){var returnCaseTemplateUr;if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE){returnCaseTemplateUr="/case/newCs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+rec.sku+"&contextType="+scope.viewType}else{returnCaseTemplateUr="/case/newCs/?"+scope.newCaseCustomerLink+"&serialNumber="+rec.serialNumber+"&componentId="+rec.componentId+"&regType="+rec.regType+"&prodMetaName="+scope.encodeUriQuery(rec.metaName)+"&prodMetaLanguage="+rec.metaLanguage+"&prodMetaConfig="+rec.metaConfig+"&prodMetaPlatform="+rec.metaPlatform+"&prodName="+rec.name+"&prodPlatform="+rec.platform+"&prodLang="+rec.language+"&prodVersion="+rec.version+"&productType="+rec.regInd+"&productSegment="+rec.educational}window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUr)};scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseProductItems"+indexId).removeClass().addClass(accordionClassName)};scope.toggleExpandCollapseAll=function(){var buttonClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#product-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionProductView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};scope.openPerpetualProducts=function(){scope.viewType=scope.VIEW_TYPE_PERPETUAL;$("#perpetualProductsListBtn").addClass("active");$("#enterpriseProductsListBtn").removeClass("active");if(scope.perpetualRecords){scope.records=scope.perpetualRecords}else{scope.refreshProductList()}$location.skipReload().path(AppUtils.replaceCustomerPath("products","perpetual")).replace()};scope.openEnterpriseProducts=function(){scope.viewType=scope.VIEW_TYPE_ENTERPRISE;$("#enterpriseProductsListBtn").addClass("active");$("#perpetualProductsListBtn").removeClass("active");if(scope.enterpriseRecords){scope.records=scope.enterpriseRecords}else{scope.refreshProductList()}$location.skipReload().path(AppUtils.replaceCustomerPath("products","enterprise")).replace()};scope.openAllProducts=function(){scope.viewType=scope.VIEW_TYPE_ALL;$("#perpetualProductsListBtn").removeClass("active");$("#enterpriseProductsListBtn").removeClass("active");if(scope.allRecords){scope.records=scope.allRecords}else{scope.refreshProductList()}$location.skipReload().path(AppUtils.replaceCustomerPath("products","all")).replace()};if(scope.subTab=="all"){scope.viewType=scope.VIEW_TYPE_ALL;$("#perpetualProductsListBtn").removeClass("active");$("#enterpriseProductsListBtn").removeClass("active")}else{if(scope.subTab=="enterprise"||$routeParams.subTabView=="enterprise"){scope.viewType=scope.VIEW_TYPE_ENTERPRISE;$("#enterpriseProductsListBtn").addClass("active");$("#perpetualProductsListBtn").removeClass("active")}else{scope.viewType=scope.VIEW_TYPE_PERPETUAL;$("#perpetualProductsListBtn").addClass("active");$("#enterpriseProductsListBtn").removeClass("active")}}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListProducts",["Utils","$rootScope",function(Utils,$rootScope){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&",loading:"="},replace:true,templateUrl:"js/customer/partials/list-products.html",link:function(scope,element,attrs){var handleValueChange=function(value){if(value){scope.customerLink2=Utils.customerLink2(scope.customerNo,scope.contactNo)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refresh=function(){scope.$parent.refreshProducts()};scope.filterProductName=function(recordItem){var productName="";if(angular.uppercase(recordItem.name)!="CCLE"&&(angular.uppercase(recordItem.regType)=="CCM"||angular.uppercase(recordItem.regType)=="ZIBS")){productName=recordItem.metaName+" (CCTeam)"}else{productName=recordItem.metaName}return productName};scope.showProductDetail=function(productData){$rootScope.$broadcast("showProductDetailEvent",productData)}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListServices",["Utils",function(Utils){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&"},replace:true,templateUrl:"js/customer/partials/list-services.html",link:function(scope,element,attrs){}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListSubscriptions",["Utils","$rootScope","$location","$routeParams","AppConstants","AppUtils","SubscriptionUtil","TeamConstants","CustomerConstants",function(Utils,$rootScope,$location,$routeParams,AppConstants,AppUtils,SubscriptionUtil,TeamConstants,CustomerConstants){return{restrict:"EA",scope:{records:"=",teamRecords:"=",jilTeamRecords:"=",trialRecords:"=",trialLoading:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&",loading:"=",teamLoading:"=",jilTeamLoading:"=",subTab:"=",error:"=",orgguid:"=",teamContractDetail:"=",customer:"="},replace:true,templateUrl:"js/customer/partials/list-subscriptions.html",link:function(scope,element,attrs){scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.CustomerConstants=CustomerConstants;scope.oldUI=$routeParams.oldui=="true"?true:false;var handleValueChange=function(value){if(value){scope.newCaseCustomerLink=Utils.newCaseCustomerLink(scope.customerNo,scope.contactNo)}};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refreshSubscriptions=function(){scope.filterSubscriptions="";if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){scope.$parent.refreshSubscriptions("individual")}else{if(scope.viewType==scope.VIEW_TYPE_TRIAL){scope.$parent.refreshSubscriptions("trial")}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){scope.$parent.refreshSubscriptions("jilteam")}else{scope.$parent.refreshSubscriptions("team")}}}};scope.formatDate=function(date){return new Date(date)};scope.showProductDetail=function(productData,productContext){productData.productContext=productContext;scope.$parent.selectedProductData=productData;$rootScope.$broadcast("showProductDetailEvent",productData)};scope.createTSCase=function(rec,contextType){var returnCaseTemplateUrl;if(contextType=="TEAM"){returnCaseTemplateUrl="/case/newTs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&productSku="+rec.sku+"&contextType="+contextType+"&tenureDate="+rec.registrationDate+"&orgguid="+scope.orgguid}else{if(contextType=="TRIAL"){returnCaseTemplateUrl="/case/newTs?"+scope.newCaseCustomerLink+"&prodName="+rec.sap_code+"&contextType="+contextType+"&prodMetaName="+scope.encodeUriQuery(rec.product_name)+"&orgguid="+scope.orgguid}else{var tenureDate=angular.isDefined(rec.contract.termStartDate)==true?rec.contract.termStartDate.split("T")[0]:"";returnCaseTemplateUrl="/case/newTs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&subId="+rec.id+"&contextType="+contextType+"&customerGuid="+rec.subscriptionAccountId+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate)+"&orgguid="+scope.orgguid}}window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};scope.createCSCase=function(rec,contextType){var returnCaseTemplateUr;if(contextType=="TEAM"){returnCaseTemplateUr="/case/newCs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+rec.sku+"&contextType="+contextType+"&tenureDate="+rec.registrationDate+"&orgguid="+scope.orgguid}else{if(contextType=="TRIAL"){returnCaseTemplateUr="/case/newCs?"+scope.newCaseCustomerLink+"&prodName="+rec.sap_code+"&contextType="+contextType+"&prodMetaName="+scope.encodeUriQuery(rec.product_name)+"&orgguid="+scope.orgguid}else{var tenureDate=angular.isDefined(rec.contract.termStartDate)==true?rec.contract.termStartDate.split("T")[0]:"";returnCaseTemplateUr="/case/newCs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&subId="+rec.id+"&contextType="+contextType+"&customerGuid="+rec.subscriptionAccountId+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate)+"&orgguid="+scope.orgguid}}window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUr)};scope.toggleClassName=function($event,indexId){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseSubscriptionItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseSubscriptionItems"+indexId).removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){var className=$($event.currentTarget).find("i").hasClass("glyphicon-chevron-right")?"glyphicon glyphicon-chevron-down":"glyphicon glyphicon-chevron-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseJilTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseJilTeamProductItems"+indexId).removeClass().addClass(accordionClassName)}else{var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseTeamProductItems"+indexId).removeClass().addClass(accordionClassName)}}};scope.toggleExpandCollapseAll=function(){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var buttonClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#subscription-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionSubscriptionsView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionSubscriptionsView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){var buttonClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#jil-team-subscription-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-chevron-right":"glyphicon glyphicon-chevron-down";$("#accordionJilTeamProductView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionJilTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{var buttonClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#team-subscription-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionTeamProductView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}}};scope.$on("loadIndividualSubscriptionTab",function(event,result){scope.loadIndividualSubscriptions()});scope.loadIndividualSubscriptions=function(){scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#individualSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");if(!scope.records){scope.refreshSubscriptions()}$location.skipReload().path(AppUtils.replaceCustomerPath("subscriptions","individual")).replace()};scope.loadTeamSubscriptions=function(){scope.viewType=scope.VIEW_TYPE_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");if(!scope.teamRecords){scope.refreshSubscriptions()}$location.skipReload().path(AppUtils.replaceCustomerPath("subscriptions","team")).replace()};scope.loadJilTeamSubscriptions=function(){scope.viewType=scope.VIEW_TYPE_JIL_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").addClass("active");if(!scope.jilTeamRecords){scope.refreshSubscriptions()}$location.skipReload().path(AppUtils.replaceCustomerPath("subscriptions","team")).replace()};scope.loadTrialProduct=function(){scope.viewType=scope.VIEW_TYPE_TRIAL;$("#individualSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");if(!scope.trialRecords){scope.refreshSubscriptions()}$location.skipReload().path(AppUtils.replaceCustomerPath("subscriptions","trial")).replace()};if(scope.subTab=="team"){scope.viewType=scope.VIEW_TYPE_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active")}if(scope.subTab=="jilteam"){scope.viewType=scope.VIEW_TYPE_JIL_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").addClass("active")}else{if(scope.subTab=="trial"){scope.viewType=scope.VIEW_TYPE_TRIAL;$("#individualSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active")}else{scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#individualSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active")}}scope.getProductSeats=function(records,offerId){var qty=0;angular.forEach(records,function(product){if(offerId==product.offerId&&product.paymentStatus&&product.paymentStatus.toUpperCase()!=="CANCELLED"){qty=qty+product.quantity}});return qty};scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListTransactions",["Utils",function(Utils){return{restrict:"EA",scope:{records:"=",dylanOrders:"=",storeOrders:"=",customerNo:"=customerno",contactNo:"=contactno",guid:"=guid",refresh:"&",loading:"="},replace:true,templateUrl:"js/customer/partials/list-transactions.html",link:function(scope,element,attrs){var handleValueChange=function(value){if(value){scope.customerLink2=Utils.customerLink2(scope.customerNo,scope.contactNo)}};scope.ordersViewType=0;scope.customerGuid=scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.refresh=function(){scope.$parent.refreshProducts()};scope.intervalSelection=9;scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}scope.creationDateFilter=result};scope.handleIntervalChange=function(){scope.updateInterval(scope.intervalSelection)};scope.dateFilterFunction=function(data){if(new Date(data.creationDate).getTime()>scope.creationDateFilter.getTime()){return true}};scope.errorMessages=[];scope.loadTransactions=function(){scope.errorMessages=[];scope.intervalSelection=9;$(".transactionButtonGrp button").removeClass("active");$(".btnCrmOrders").addClass("active");scope.ordersViewType=0;scope.$parent.loadTransactions()};scope.loadDylanOrders=function(){scope.errorMessages=[];scope.intervalSelection=9;$(".transactionButtonGrp button").removeClass("active");$(".btnDylanOrders").addClass("active");scope.ordersViewType=1;scope.$parent.loadDylanOrders()};scope.loadNotProcessedDylanOrders=function(){scope.errorMessages=[];scope.intervalSelection=9;$(".transactionButtonGrp button").removeClass("active");$(".btnNotProcessedDylanOrders").addClass("active");scope.ordersViewType=2;scope.$parent.loadNotProcessedDylanOrders()};scope.$on("showTransactionErrorMessage",function(){scope.errorMessages=Utils.showMessage("error","Problem in loading Dylan Only Orders. Please try again.")});scope.updateInterval(scope.intervalSelection)}}}]);var mod=angular.module("hxApp.loading",[]);angular.module("localization",[]).factory("localize",["$http","$rootScope","$window","$filter",function($http,$rootScope,$window,$filter){var localize={language:"",dictionary:[],url:undefined,resourceFileLoaded:false,successCallback:function(data){localize.dictionary=data;localize.resourceFileLoaded=true;$rootScope.$broadcast("localizeResourcesUpdated")},setLanguage:function(value){localize.language=value;localize.initLocalizedResources()},setUrl:function(value){localize.url=value;localize.initLocalizedResources()},buildUrl:function(){if(!localize.language){var lang,androidLang;if($window.navigator&&$window.navigator.userAgent&&(androidLang=$window.navigator.userAgent.match(/android.*\W(\w\w)-(\w\w)\W/i))){lang=androidLang[1]}else{lang=$window.navigator.userLanguage||$window.navigator.language}localize.language=lang}return"/radon_java_webapp/hx5/i18n/resources-locale_"+localize.language.toLowerCase()+".js"},initLocalizedResources:function(){var url=localize.url||localize.buildUrl();$http({method:"GET",url:url,cache:false}).success(localize.successCallback).error(function(){var url="/radon_java_webapp/hx5/i18n/resources-locale_default.js";$http({method:"GET",url:url,cache:false}).success(localize.successCallback)})},getLocalizedString:function(value){var result="";if((localize.dictionary!==[])&&(localize.dictionary.length>0)){var entry=$filter("filter")(localize.dictionary,function(element){return element.key===value})[0];result=entry.value}return result}};localize.initLocalizedResources();return localize}]).filter("i18n",["localize",function(localize){return function(input){return localize.getLocalizedString(input)}}]).directive("i18n",["localize",function(localize){var i18nDirective={restrict:"EAC",updateText:function(elm,token){var values=token.split("|");if(values.length>=1){var tag=localize.getLocalizedString(values[0]);if((tag!==null)&&(tag!==undefined)&&(tag!=="")){if(values.length>1){for(var index=1;index<values.length;index++){var target="{"+(index-1)+"}";tag=tag.replace(target,values[index])}}elm.text(tag)}}},link:function(scope,elm,attrs){scope.$on("localizeResourcesUpdated",function(){i18nDirective.updateText(elm,attrs.i18n)});attrs.$observe("i18n",function(value){i18nDirective.updateText(elm,attrs.i18n)})}};return i18nDirective}]).directive("i18nAttr",["localize",function(localize){var i18NAttrDirective={restrict:"EAC",updateText:function(elm,token){var values=token.split("|");var tag=localize.getLocalizedString(values[0]);if((tag!==null)&&(tag!==undefined)&&(tag!=="")){if(values.length>2){for(var index=2;index<values.length;index++){var target="{"+(index-2)+"}";tag=tag.replace(target,values[index])}}elm.attr(values[1],tag)}},link:function(scope,elm,attrs){scope.$on("localizeResourcesUpdated",function(){i18NAttrDirective.updateText(elm,attrs.i18nAttr)});attrs.$observe("i18nAttr",function(value){i18NAttrDirective.updateText(elm,value)})}};return i18NAttrDirective}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("LocalStorageService",["localStorageService","$rootScope",function(localStorageService,$rootScope){this.user={};this.user.add=function(key,value){localStorageService.add($rootScope.currentUser.username+"."+key,JSON.stringify(value))};this.user.get=function(key){var result="";try{result=JSON.parse(localStorageService.get($rootScope.currentUser.username+"."+key))}catch(err){}return result};this.user.remove=function(key){localStorageService.remove($rootScope.currentUser.username+"."+key)};this.add=function(key,value){localStorageService.add(key,JSON.stringify(value))};this.get=function(key){var result="";try{result=JSON.parse(localStorageService.get(key))}catch(err){result=localStorageService.get(key)}return result};this.remove=function(key){localStorageService.remove(key)}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("LoggerService",["$http",function($http){var service={};service.log=function(data){return $http({method:"POST",url:"../utilityServices/log.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.logNoAuth=function(data){return $http({method:"POST",url:"../utilityServices/logNoAuth.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("marketingAttributes",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"=",country:"=",customer:"=",metadata:"="},replace:true,templateUrl:"js/customer/partials/marketing-attributes.html",link:function(scope,element,attrs){var handleChange=function(value){if(scope.ngModel&&scope.country&&!scope.metadata.marketingAttributes&&!scope.metadata.marketingValues){MetadataService.getMarketingOptinInformation(scope.country).success(function(response){scope.marketingOptinInformation=response});MetadataService.getMarketingProfileInformation(scope.country).success(function(response){scope.marketingProfileInformation=response})}else{if(scope.ngModel&&scope.country&&scope.metadata.marketingAttributes&&scope.metadata.marketingValues){scope.marketingOptinInformation=[];scope.marketingProfileInformation=[];scope.marketingOptinInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.country,true);scope.marketingProfileInformation=MetadataService.getMarketingOptInOrProfileInformation(scope.metadata,scope.country,false)}}};scope.$watch(function(){return scope.ngModel},handleChange);scope.$watch(function(){return scope.country},handleChange)}}}]).directive("marketingAttribute",[function(){return{restrict:"E",scope:{source:"=",selections:"="},replace:true,template:"<div class='marketingAttr'><span>{{marketingText}}</span>{{selection}}</div>",link:function(scope,element,attrs){var handleChange=function(value,oldValue){if(scope.source){scope.marketingText=scope.source.description;scope.selection="-"}if(scope.source&&scope.selections){angular.forEach(scope.selections,function(selection){if(selection.code==scope.source.code){if(selection.description){scope.selection=selection.description}return}})}};scope.$watch(function(){return scope.source},handleChange);scope.$watch(function(){return scope.selections},handleChange)}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("MenuCtrl",["$rootScope","$scope","$location","$log","$templateCache","UserService","AppConstants","$filter","LocalStorageService","socket","StoreShortcutsService","AppUtils","ReminderService","$timeout",function($rootScope,$scope,$location,$log,$templateCache,UserService,AppConstants,$filter,LocalStorageService,socket,StoreShortcutsService,AppUtils,ReminderService,$timeout){$scope.isLoggedUser=false;$scope.defaultStore;$scope.isFullScreenView=LocalStorageService.get("isFullScreenView");$scope.storeShortcutResult=LocalStorageService.get("agentStoreProfile");$scope.isEditStore=false;$scope.isDeleteStore=false;$scope.isMakeDefaultStore=false;$scope.isDrStoreDisplay=false;$scope.refreshShortcuts=function(){StoreShortcutsService.getShortcuts().success(function(result){$scope.storeShortcutResult=result;angular.forEach($scope.storeShortcutResult,function(enabledCountry){$scope.enabledCountry=enabledCountry;if(enabledCountry.storeType=="COM"){enabledCountry.isEnable=AppUtils.isCommercialStore(enabledCountry.countryCode)}else{enabledCountry.isEnable=AppUtils.isEducationalStore(enabledCountry.countryCode)}});LocalStorageService.add("agentStoreProfile",result)}).error(function(error){console.log(""+error)})};$scope.refreshShortcuts();$scope.updateStore=function(store){$scope.currentStore=store;if(store.storeType=="COM"){$scope.currentStoreName=store.countryCode;$scope.currentStoreLink=store.countryCode}else{$scope.currentStoreName=store.countryCode+" (Edu)";$scope.currentStoreLink=angular.lowercase(store.countryCode)+"-edu"}};if($scope.storeShortcutResult){for(var storeCount=0;storeCount<$scope.storeShortcutResult.length;storeCount++){if($scope.storeShortcutResult[storeCount].defaultStore){$scope.defaultStore=$scope.storeShortcutResult[storeCount];$scope.updateStore($scope.defaultStore);break}}}var watcher1=$rootScope.$on("$routeChangeStart",function(event,next,current){if(typeof(current)!=="undefined"){}});function refreshApp(){var host=document.getElementById("mainView");if(host){var mainDiv=$("#mainView");mainDiv.empty();angular.element(host).empty()}}$scope.currentUser=$rootScope.currentUser;var currentUser;if(typeof socket!=="undefined"){var socketError=false;$scope.$on("SOCKET_CONNECTED",function(){console.log("---PushNotification---App Connected to push notification server");try{if(typeof currentUser!=="undefined"&&typeof $scope.currentUser!=="undefined"&&socketError){socketError=false;sendUserInfoToSocket()}else{subscribeToChannels()}}catch(error){}});$scope.$on("SOCKET_ERROR",function(event,errorObj){socketError=true;console.log("---PushNotification---Error in connecting to push notification server",errorObj);if($scope.isLoggedUser){AppUtils.sendLogToServer("Hendrix Push Notification connection failed, Reason: "+errorObj.message)}});function sendUserInfoToSocket(){if(typeof socket!=="undefined"){currentUser={userID:$scope.currentUser.username.toLowerCase(),serverInfo:configObj.serverInfo};socket.emit("add user",currentUser);console.log("-----Push Notification---- User info sent to server",currentUser)}}function subscribeToChannels(){socket.on(currentUser.serverInfo,function(data){$scope.pushNotificationMessage=data;if($scope.isLoggedUser){$("#pusNotificationModal").modal("show");console.log("---PushNotification--- Server Deployment Msg",data)}$scope.$apply()});socket.on("AdminMessageBroadCast",function(data){$scope.pushNotificationMessage=data;if($scope.isLoggedUser){$("#pusNotificationModal").modal("show");console.log("---PushNotification---AdminMessageBroadCast Data",data)}$scope.$apply()});socket.on("subscribeToGroup",function(data){if($scope.isLoggedUser){angular.forEach(data,function(v){if(v.userID.toLowerCase()==currentUser.userID.toLowerCase()){socket.on(v.groupName,function(grpMsg){$scope.pushNotificationMessage=grpMsg;if($scope.isLoggedUser){$("#pusNotificationModal").modal("show");console.log("---PushNotification to Group: "+v.groupName+" Data: ",grpMsg)}$scope.$apply()})}})}});socket.on("UserUpdated",function(data){console.log("---PushNotification--- Users and Groups updated by Admin");currentUser.serverInfo=configObj.serverInfo;sendUserInfoToSocket()});socket.on("UserRemovedFromGroup",function(data){if(data.userID.toLowerCase()==currentUser.userID.toLowerCase()){console.log("---PushNotification--- User removed from group by Admin");socket.unsubscribe(data.groupName)}$scope.$apply()});socket.on("UserRemovedFromAll",function(data){if(data.userID==currentUser.userID){socket.emit("RemoveUserFromAllGroup",data);console.log("---PushNotification--- User removed from all groups")}$scope.$apply()})}}$scope.openAddReminderPanel=function(){$("#addReminderModal").modal("show")};$scope.navClass=function(page){var currentRoute=$location.path().substring(1)||"dashboard";return page===currentRoute?"active":""};var timer;var isValidUser;timer=setInterval(function(){$scope.isValidLogin()},2000);$scope.logout=function(){deleteCookie("Hendrix-BigIP");UserService.logout();LocalStorageService.add("isValidUser",false);LocalStorageService.remove("agentStoreProfile");console.log("Successfully Logged Out");$scope.$root.refreshRequired=true;worker.postMessage("stop");$location.path("/login")};$scope.screenView=function(){$scope.isFullScreenView=!$scope.isFullScreenView;LocalStorageService.add("isFullScreenView",$scope.isFullScreenView);$scope.setScreenView()};$scope.isValidLogin=function(){isValidUser=LocalStorageService.get("isValidUser");if(isValidUser!=true){$rootScope.returnUrl=null;$scope.isLoggedUser=false;$location.path("/login")}else{if(isValidUser==true){$scope.isLoggedUser=true}}};$scope.settings=function(){$location.path("/setting")};$scope.aboutHendrix=function(){$("#aboutHendrixModal").modal("show");$scope.shortTimeDate=$filter("date")(new Date(),"shortTime");$scope.serverInfo=configObj.hostName+"("+configObj.serverInfo+")/"+configObj.instanceName+" "+new Date()+" "+$scope.shortTimeDate};$scope.closeAboutHendrixModal=function(){$("#aboutHendrixModal").modal("hide")};$scope.$on("event:logoutRequest",function(){console.log("MenuCtrl.event:logoutRequest");$scope.isLoggedUser=false;LocalStorageService.add("isValidUser",false);LocalStorageService.remove("agentStoreProfile")});var watcher2=$scope.$on("event:loginConfirmed",function(e,user){console.log("MenuCtrl.event:loginConfirmed");$scope.isLoggedUser=true;$scope.currentUser=user;$scope.refreshShortcuts();sendUserInfoToSocket()});var watcher3=$scope.$on("event:loginRequired",function(){console.log("MenuCtrl.event:loginRequired");$scope.isLoggedUser=false;localStorage.setItem("ls.isValidUser",false);$location.path("/login")});var watcher4=$scope.$on("event:customerIdentified",function(event,customer){$scope.customerIdentified=true;$scope.customer=customer});$scope.toolItems=[];$scope.setTools=function(){var locallyStoredLanguage=LocalStorageService.get("language");var currentUrl=AppUtils.getApplicationUrl();if(locallyStoredLanguage!="JA"){$scope.toolItems=AppConstants.TOOLS_NONJP}else{$scope.toolItems=AppConstants.TOOLS_JP}};$scope.notSorted=function(obj){if(!obj){return[]}return Object.keys(obj)};$scope.linkHandler=function(label){if(label=="Payment Tokenizer"){var countryCode="US";var cardTypes="Visa,MasterCard,Amex,Jcb";$scope.$parent.launchPaymentTokenizerLink(countryCode,cardTypes)}};$scope.$on("$destroy",function(){watcher1();watcher2();watcher3();watcher4();clearInterval(timer)});if($scope.isFullScreenView==null){$scope.isFullScreenView=true;LocalStorageService.add("isFullScreenView",true)}$scope.setScreenView=function(){if($scope.isFullScreenView){$(".container").css("width","97%");$(".navbar-header").css("marginLeft","30px");$(".cart-holder").css("width","33.5%");$(".cart-holder").css("position","fixed");$(".store-products-panel").css("width","100%")}else{$(".container").css("width","1170px");$(".navbar-header").css("marginLeft","0px");$(".cart-holder").css("width","408px");$(".store-products-panel").css("width","774px")}};$scope.setScreenView();$scope.clearFilter=function($event){if($event){$("#storeLocateButtonPanel button").removeClass("btn-active");$($event.currentTarget).addClass("btn-active")}$scope.storeLocatorSearch="";$scope.commercial={};$scope.education={};$scope.isDrStoreDisplay=false};$scope.setDrStore=function($event){if($event){$("#storeLocateButtonPanel button").removeClass("btn-active");$($event.currentTarget).addClass("btn-active")}$scope.storeLocatorSearch="";$scope.commercial={};$scope.education={};$scope.isDrStoreDisplay=true;$scope.getEnableDrLink()};$scope.getEnableDrLink=function(){angular.forEach(hendrixConfig.drCountries,function(drCountry){var country={code:drCountry.countryCode};if(AppUtils.isLaunchCctDRStoreEnable(country)){drCountry.isDrLinkEnable=true}});$scope.drCountryList=hendrixConfig.drCountries};$(function(){$(".dropdown").hover(function(e){$("#storeSelectorDropDown").removeClass("open");$(this).toggleClass("open");e.preventDefault();return false})});$scope.reminders=[];$scope.todayReminders=[];$scope.getReminders=function(){var dataObj={userID:$scope.currentUser.username.toUpperCase()};ReminderService.loadReminders(dataObj).success(function(response){$scope.reminders=[];$scope.todayReminders=[];if(response.length>0){$scope.reminders=response;for(var i=0;i<$scope.reminders.length;i++){var reminder=$scope.reminders[i];if(moment(reminder.dateTime).isSame(Date.now(),"year")&&moment(reminder.dateTime).isSame(Date.now(),"month")&&moment(reminder.dateTime).isSame(Date.now(),"day")){$scope.todayReminders.push(reminder)}}console.log("Today reminders:",$scope.todayReminders)}}).error(function(error){console.log("Error in loading reminders",error);$scope.showMessage("error",error)})};$scope.getUserAndLoadReminders=function(){$timeout(function(){if(typeof $scope.currentUser=="undefined"){$scope.getUserAndLoadReminders();return}$scope.getReminders()},1000)};$scope.getUserAndLoadReminders();$scope.$on("event:ReloadReminders",function(){$scope.getUserAndLoadReminders()});$scope.goToReminders=function(){window.open("#/reminder","_blank")}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("MessageDto",{number:"",text:"",type:""});var transform=function(data){return $.param(data)};var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("MetadataService",function($http,$location,HxDbFactory,AppConstants){var service={};const DB_STATUS={NEW:"new",SUCCESS:"success",FAILED:"failed"};const STORE_NAMES={META_CASE_STATUSES:"metacaseStatuses",META_CS_CASE_RESULTS:"metacsCaseResults",META_CASE_TYPES:"metacaseTypes",META_PRODUCT_CATEGORIES:"metaproductCategories",TS_CASE_DIRECTION_DTOS:"tsCaseDirectionDtos",TS_CASE_PRIORITY_DTOS:"tsCasePriorityDtos",TS_CASE_STATUS_DTOS:"tsCaseStatusDtos",TS_CASE_ACTIVITY_TYPE_DTOS:"tsCaseActivityTypeDtos",TS_CASE_SUBJECT_DTOS:"tsCaseSubjectDtos",TS_CASE_RESULTS_DTOS:"tsCaseResultsDtos",BUG_SYSTEMS:"bugSystems",CONTRACT_TYPES:"contractTypes",ENTITLEMENT_METHODS:"entitlementMethods",LICENSES:"licenses",METADATA_INFO:"metadataInfo",TS_CASE_SUPPORT_TYPE_DTOS:"tsCaseSupportTypeDtos",PRODUCT_PLATFORMS:"productPlatforms",PRODUCT_LANGUAGES:"productLanguages",MEMO_NOTE_TYPES:"memoNoteTypes",ORDER_TYPES:"orderTypes",RELATIONSHIP_TYPES:"relationshipTypes",CONTACT_TYPES:"contactTypes",TITLES:"titles",LANGUAGES:"languages",CCM_TEAM_CANCELLATION_REASONS:"ccmTeamCancellationReasons",MARKETING_VALUES:"marketingValues",VAT_OPTIONS:"vatOptions",PRODUCT_STATUS_LIST:"productStatusList",ALL_STATES:"allStates",COUNTRIES:"countries",CLASSIFICATIONS:"classifications",ALL_STATES:"allStates",PRODUCT_NAMES:"productNames",ORDER_REASONS:"orderReasons",CREDIT_CARD_TYPES:"creditCardTypes",ORDER_CANCELLATION_REASON:"orderCancellationReasons",ALL_STORES:"allStores",MARKETING_ATTRIBUTES:"marketingAttributes",MARKETING_VALUES:"marketingValues",BILLING_BLOCKING_REASONS:"billingBlockingReasons",DELIVERY_BLOCKING_REASONS:"deliveryBlockingReasons",PRODUCT_EXTERNAL_VERSIONS:"productExternalVersions",PRODUCT_CONFIGURATIONS:"productConfigurations",PRODUCT_MEDIA_TYPES:"productMediaTypes"};const INDEX_NAMES={CODE:"code",ID:"id",STATUS_CODE:"statusCode",PROCT:"proct",DEPARTMENT:"department",TS_CASE_STATUS_ID:"tsCaseStatusId",NAME:"name",CHANGE_ABLE:"changeable",TITLE:"title",VALUE:"value",TYPE:"type",DESCRIPTION:"description",LABEL:"label",ORDER_TYPE:"orderType",COUNTRY_CODE:"countryCode",KEY:"key",STORE_TYPE:"storeType",CLASS_NAME:"className",REGION:"region",REASON:"reason",TEXT:"text",STORE_NAME:"storeName"};service.appDb=null;service.DB_STATUS=DB_STATUS;service.STORE_NAMES=STORE_NAMES;service.INDEX_NAMES=INDEX_NAMES;service.metadataStatus=false;service.isMetadataUptodate=true;service.initializeModule=function(moduleName,callBackFunction){switch(angular.uppercase(moduleName)){case AppConstants.MODULE_SUPER:service.initializeSuperModuleMetadata(callBackFunction);break;case AppConstants.MODULE_SALES:service.initializeSalesMetadata(callBackFunction);break;case angular.uppercase(AppConstants.MODULE_TEAM):service.initializeTeamSubscriptionMetadata(callBackFunction);break;case angular.uppercase(AppConstants.MODULE_JILTEAM):service.initializeJilTeamSubscriptionMetadata(callBackFunction);break;case AppConstants.MODULE_SFDC:service.initializeSFDCMetadata(callBackFunction);break}};service.initializeSuperModuleMetadata=function(initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.ALL_STATES];var count=0;var metadataObject=new Object();service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(metadataObject,DB_STATUS.SUCCESS)}})})}else{initializeCallback(null,DB_STATUS.FAILED)}})};service.initializeSalesMetadata=function(initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.ALL_STATES,STORE_NAMES.TITLES,STORE_NAMES.VAT_OPTIONS,STORE_NAMES.MARKETING_ATTRIBUTES,STORE_NAMES.MARKETING_VALUES,STORE_NAMES.LANGUAGES];var count=0;var metadataObject=new Object();service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(metadataObject,DB_STATUS.SUCCESS)}})})}else{initializeCallback(null,DB_STATUS.FAILED)}})};service.initializeSFDCMetadata=function(initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STATES,STORE_NAMES.TITLES,STORE_NAMES.VAT_OPTIONS,STORE_NAMES.MARKETING_ATTRIBUTES,STORE_NAMES.MARKETING_VALUES,STORE_NAMES.LANGUAGES];var count=0;var metadataObject=new Object();service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(metadataObject,DB_STATUS.SUCCESS)}})})}else{initializeCallback(null,DB_STATUS.FAILED)}})};service.getCompleteMetadata=function(data){return $http({method:"GET",data:data,url:"../metadataService/getCompleteMetadata.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.checkMetadataVersion=function(data){return $http({method:"POST",data:data,transformRequest:transform,url:"../metadataService/isClientCacheUpToDate.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.initializeCaseMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.META_CASE_STATUSES,STORE_NAMES.META_CS_CASE_RESULTS,STORE_NAMES.TS_CASE_DIRECTION_DTOS,STORE_NAMES.TS_CASE_PRIORITY_DTOS,STORE_NAMES.META_CASE_TYPES,STORE_NAMES.META_PRODUCT_CATEGORIES,STORE_NAMES.TS_CASE_STATUS_DTOS,STORE_NAMES.TS_CASE_ACTIVITY_TYPE_DTOS,STORE_NAMES.TS_CASE_SUBJECT_DTOS,STORE_NAMES.LICENSES,STORE_NAMES.TS_CASE_RESULTS_DTOS,STORE_NAMES.TS_CASE_SUPPORT_TYPE_DTOS,STORE_NAMES.BUG_SYSTEMS,STORE_NAMES.PRODUCT_LANGUAGES,STORE_NAMES.PRODUCT_PLATFORMS,STORE_NAMES.PRODUCT_NAMES,STORE_NAMES.ALL_STATES];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeCustomerMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.MEMO_NOTE_TYPES,STORE_NAMES.ORDER_TYPES,STORE_NAMES.RELATIONSHIP_TYPES,STORE_NAMES.CONTACT_TYPES,STORE_NAMES.TITLES,STORE_NAMES.LANGUAGES,STORE_NAMES.CCM_TEAM_CANCELLATION_REASONS,STORE_NAMES.MARKETING_VALUES,STORE_NAMES.VAT_OPTIONS,STORE_NAMES.PRODUCT_STATUS_LIST,STORE_NAMES.COUNTRIES,STORE_NAMES.MARKETING_ATTRIBUTES,STORE_NAMES.ALL_STATES];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeSearchMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.TITLES,STORE_NAMES.LANGUAGES,STORE_NAMES.CONTRACT_TYPES,STORE_NAMES.CONTACT_TYPES,STORE_NAMES.ORDER_TYPES,STORE_NAMES.MEMO_NOTE_TYPES,STORE_NAMES.CLASSIFICATIONS,STORE_NAMES.VAT_OPTIONS,STORE_NAMES.MARKETING_ATTRIBUTES,STORE_NAMES.MARKETING_VALUES];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeDashboardMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.TS_CASE_PRIORITY_DTOS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeNotificationMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.TS_CASE_PRIORITY_DTOS,STORE_NAMES.PRODUCT_NAMES,STORE_NAMES.META_CASE_STATUSES,STORE_NAMES.META_PRODUCT_CATEGORIES,STORE_NAMES.TS_CASE_SUBJECT_DTOS,STORE_NAMES.TS_CASE_STATUS_DTOS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeSettingMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.METADATA_INFO];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeOrderViewMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.ORDER_REASONS,STORE_NAMES.CREDIT_CARD_TYPES];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeTransactionMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.ORDER_REASONS,STORE_NAMES.CREDIT_CARD_TYPES,STORE_NAMES.ORDER_CANCELLATION_REASON,STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STATES,STORE_NAMES.ALL_STORES,STORE_NAMES.MARKETING_ATTRIBUTES,STORE_NAMES.MARKETING_VALUES,STORE_NAMES.BILLING_BLOCKING_REASONS,STORE_NAMES.DELIVERY_BLOCKING_REASONS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeStoreMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.ALL_STATES,STORE_NAMES.TITLES,STORE_NAMES.LANGUAGES,STORE_NAMES.PRODUCT_NAMES,STORE_NAMES.PRODUCT_EXTERNAL_VERSIONS,STORE_NAMES.PRODUCT_PLATFORMS,STORE_NAMES.PRODUCT_LANGUAGES,STORE_NAMES.PRODUCT_CONFIGURATIONS,STORE_NAMES.PRODUCT_MEDIA_TYPES,STORE_NAMES.ORDER_TYPES,STORE_NAMES.ORDER_REASONS,STORE_NAMES.CREDIT_CARD_TYPES,STORE_NAMES.VAT_OPTIONS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeSubscriptionMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.META_CASE_TYPES,STORE_NAMES.META_PRODUCT_CATEGORIES,STORE_NAMES.CREDIT_CARD_TYPES,STORE_NAMES.ORDER_REASONS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeJilTeamSubscriptionMetadata=function(initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.META_PRODUCT_CATEGORIES,STORE_NAMES.META_CASE_TYPES,STORE_NAMES.ORDER_REASONS,STORE_NAMES.ORDER_TYPES];var count=0;var metadataObject=new Object();service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(metadataObject,DB_STATUS.SUCCESS)}})})}else{initializeCallback(metadataObject,DB_STATUS.FAILED)}})};service.initializeTeamMetadata=function(metadataObject,initializeCallback){var storeNameList=[STORE_NAMES.CCM_TEAM_CANCELLATION_REASONS];var count=0;service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(DB_STATUS.SUCCESS)}})})}else{initializeCallback(DB_STATUS.FAILED,service.appDb.db)}})};service.initializeTeamSubscriptionMetadata=function(initializeCallback){var storeNameList=[STORE_NAMES.COUNTRIES,STORE_NAMES.ALL_STORES,STORE_NAMES.CREDIT_CARD_TYPES];var count=0;var metadataObject=new Object();service.setMetadataDb(function(metadataStatus){if(metadataStatus){angular.forEach(storeNameList,function(storeName){service.getAll(storeName,function(resultList){metadataObject[storeName]=resultList;count++;if(count==storeNameList.length){initializeCallback(metadataObject,DB_STATUS.SUCCESS)}})})}else{initializeCallback(metadataObject,DB_STATUS.FAILED)}})};service.setMetadataDb=function(callback){if(service.appDb==null){service.appDb=HxDbFactory.metadataDb;HxDbFactory.openMetadataDb(function(result,dbObject){if(result){if(dbObject.objectStoreNames.length==0){$location.path("/setting")}else{service.metadataStatus=result;service.appDb.db=dbObject;callback(service.metadataStatus)}}})}else{callback(true)}};service.getAll=function(tableName,callback){if(service.appDb.db!=null){HxDbFactory.getAllByStoreName(service.appDb,tableName,callback,function(searchedObjectsList){if(searchedObjectsList){callback(searchedObjectsList)}})}};service.find=function(arrayData,value,compareField,labelField){var result="";angular.forEach(arrayData,function(item){if(item[compareField]==value){result=item[labelField];return}});return result};service.findResult=function(arrayData,value1,value2,compareField1,compareField2,labelField){var result="";angular.forEach(arrayData,function(item){if(item[compareField1]==value1&&item[compareField2]==value2){result=item[labelField];return}});return result};service.getObjectFromSingleValue=function(itemList,field,value){var returnObject=null;angular.forEach(itemList,function(item){if(angular.lowercase(item[field])==angular.lowercase(value)){returnObject=item}});return returnObject};service.getObjectFromTwoValues=function(itemList,fieldOne,fieldTwo,valueOne,valueTwo){var returnObject=null;angular.forEach(itemList,function(item){if(angular.lowercase(item[fieldOne])==angular.lowercase(valueOne)&&angular.lowercase(item[fieldTwo])==angular.lowercase(valueTwo)){returnObject=item}});return returnObject};service.getMetadataList=function(arrayData,value,compareField){var result=[];angular.forEach(arrayData,function(item){if(item[compareField]==value){result.push(item)}});return result};service.findDto=function(arrayData,value,compareField){var result=null;angular.forEach(arrayData,function(item){if(item[compareField]==value){result=item;return}});return result};service.getAllMetadata=function(){return $http({method:"GET",url:"../metadataService/getAllMetadata.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductNames=function(){return $http({method:"GET",url:"../metadataService/getProductNames.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductLanguage=function(){return $http({method:"GET",url:"../metadataService/getProductLanguage.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductPlatforms=function(){return $http({method:"GET",url:"../metadataService/getProductPlatforms.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductExternalVersions=function(){return $http({method:"GET",url:"../metadataService/getProductExternalVersions.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductConfigurations=function(){return $http({method:"GET",url:"../metadataService/getProductConfigurations.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getProductMediaTypes=function(){return $http({method:"GET",url:"../metadataService/getProductMediaTypes.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getTsCaseProductMetadata=function(data){return $http({method:"POST",url:"../metadataService/getTsCaseProductMetadata.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTsCaseProductMetadata=function(data){return $http({method:"POST",url:"../metadataService/getTsCaseProductMetadata.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getStratificationDescriptions=function(){return $http({method:"GET",url:"../metadataService/getStratificationDescriptions.do",cache:true})};service.getClassifications=function(){return $http({method:"GET",url:"../metadataService/getClassifications.do",cache:true})};service.getLanguages=function(){return $http({method:"GET",url:"../metadataService/getLanguages.do",cache:true})};service.getTitles=function(){return $http({method:"GET",url:"../metadataService/getTitles.do",cache:true})};service.getCountrySpecificInfo=function(data){return $http({method:"POST",url:"../metadataService/getCountrySpecificInfo.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,transformResponse:function(data,headers){data=service.filterMarketingOptionsList(angular.fromJson(data));return data},data:data,cache:true})};service.getVatOptions=function(){return $http({method:"GET",url:"../metadataService/getVatOptions.do",cache:true})};service.getMarketingValues=function(){return $http({method:"GET",url:"../metadataService/getMarketingValues.do",cache:true})};service.getMarketingOptinInformation=function(country){return $http({method:"GET",url:"../metadataService/getMarketingOptinInformation.do",transformResponse:function(data,headers){data=service.filterMarketingOptionsList(angular.fromJson(data));return data},params:{country:country},cache:true})};service.getMarketingProfileInformation=function(country){return $http({method:"GET",url:"../metadataService/getMarketingProfileInformation.do",params:{country:country},cache:true})};service.getCountries=function(country){return $http({method:"GET",url:"../metadataService/getCountries.do",cache:true})};service.getCcmTeamCancellationReasons=function(){return $http({method:"GET",url:"../metadataService/getCcmTeamCancellationReasons.do",cache:true})};service.getMarketingOptsObject=function(marketingAttrObj,metadataObject,isOptn){var marketingObject={};marketingObject.code=marketingAttrObj.code;marketingObject.description=marketingAttrObj.description;marketingObject.values=[];angular.forEach(metadataObject.marketingValues,function(attr){if(attr.code==marketingAttrObj.code){marketingObject.values.push(attr)}});if(marketingObject.values.length==2&&isOptn==true){return marketingObject}else{if(isOptn==false){return marketingObject}else{return null}}};var getMarketingClassNameByRegion=function(region){var className="";var marketingClassNames=AppConstants.MARKETING_CLASS_NAME_BY_REGIONS;angular.forEach(marketingClassNames,function(obj,key){if(key==region){className=obj}});return className};service.getMarketingOptInOrProfileInformation=function(metadataObject,countryCode,isOptn){if(!metadataObject&&!metadataObject.countries&&!countryCode){return}var marketingOptInInformation=[];service.filteredOptnInMarketingList=[];service.filteredMarketingAttrObjList=[];var regionForCountry=service.getRegionFromCountry(metadataObject.countries,countryCode);angular.forEach(metadataObject.marketingAttributes,function(marketingAttr){if(marketingAttr.code.indexOf("CONTACT")!=-1&&marketingAttr.code.indexOf("_FAX")==-1&&isOptn==true&&marketingAttr.className==getMarketingClassNameByRegion(regionForCountry)){service.filteredMarketingAttrObjList.push(marketingAttr)}else{if(marketingAttr.code.indexOf("CONTACT")==-1&&isOptn==false&&marketingAttr.className==getMarketingClassNameByRegion(regionForCountry)){service.filteredMarketingAttrObjList.push(marketingAttr)}}});angular.forEach(service.filteredMarketingAttrObjList,function(marketingAttrObj){if(service.getMarketingOptsObject(marketingAttrObj,metadataObject,isOptn)!=null){marketingOptInInformation.push(service.getMarketingOptsObject(marketingAttrObj,metadataObject,isOptn))}});return marketingOptInInformation};service.filterMarketingOptionsList=function(data){var filteredMarketingOptList=[];var optsInInfo=[];if(data.marketingOptinInformation){optsInInfo=data.marketingOptinInformation}else{optsInInfo=data}angular.forEach(optsInInfo,function(opt){if(opt.values&&opt.values.length==2&&opt.code.indexOf("_FAX")==-1){filteredMarketingOptList.push(opt)}});if(data.marketingOptinInformation){data.marketingOptinInformation=filteredMarketingOptList}else{data=filteredMarketingOptList}return data};service.getRegionFromCountry=function(countries,countryCode){if(!countryCode&&!countries){return null}var region="";angular.forEach(countries,function(obj){if(obj.code==countryCode){region=obj.region}});return region};service.getCountryNameFromCountry=function(countries,countryCode){if(!countryCode&&!countries){return null}var name="";angular.forEach(countries,function(obj){if(obj.code==countryCode){name=obj.name}});return name};service.getDefaultVATOptionFromMetadata=function(vatOptions,countryCode){var vatOption=null;angular.forEach(vatOptions,function(option){if(option.code.indexOf(countryCode)>-1){vatOption=option.code}});return vatOption};service.getStatesFromMetadata=function(allStates,countryCode){var states=[];angular.forEach(allStates,function(state){if(state.countryCode==countryCode){states.push(state)}});return states};return service});var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/callback",{templateUrl:"js/callback/partials/callback-view.html",controller:"CallbackController",title:"Callback Scheduler"}).when("/callback/:customerNo",{templateUrl:"js/callback/partials/callback-view.html",controller:"CallbackController",title:"Callback Scheduler"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$routeParams,$locationProvider,$httpProvider){$routeProvider.when("/case/:caseNo",{templateUrl:"js/cases/partials/case-view.html",controller:"CaseController",title:"Case View"}).when("/customer/:customerNo/rel/:relCustomerNo/tsCase/:caseNo",{templateUrl:"js/cases/partials/case-view.html",controller:"CaseCtrl",title:"TS Case"}).when("/customer/:customerNo/tsCase/:caseNo",{templateUrl:"js/cases/partials/case-view.html",controller:"CaseCtrl",title:"TS Case"}).when("/customer/:customerNo/csCase/:caseNo",{templateUrl:"js/cases/partials/case-view.html",controller:"CaseCtrl",title:"CS Case"}).when("/customer/:customerNo/rel/:relCustomerNo/csCase/:caseNo",{templateUrl:"js/cases/partials/case-view.html",controller:"CaseCtrl",title:"CS Case"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/customer/:customerNo",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"}).when("/customer/:customerNo/rel/:relCustomerNo",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"}).when("/customer/:customerNo/rel/:relCustomerNo/:tabView",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"}).when("/customer/:customerNo/rel/:relCustomerNo/:tabView/:subTabView",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"}).when("/customer/:customerNo/:tabView",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"}).when("/customer/:customerNo/:tabView/:subTabView",{templateUrl:"js/customer/partials/customer.html",controller:"CustomerCtrl",title:"Customer"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/v1/customer/:customerAccountID/communication",{templateUrl:"js/customer/communication/partial/communication.html",controller:"CommunicationCtrl",title:"Communication"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/v1/customer/:customerAccountID/services",{templateUrl:"js/customer/customer-services/partial/services.html",controller:"ServicesCtrl",title:"Services"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/v1/customer/:customerAccountID/subscription/team",{templateUrl:"js/customer/subscription/partials/team-subscription-list.html",controller:"TeamSubscriptionListCtrl",title:"Team Subscription List"}).when("/v1/customer/:customerAccountID/subscription/individual",{templateUrl:"js/customer/subscription/partials/individual-subscription-list.html",controller:"IndividualSubscriptionListCtrl",title:"Subscription List"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/v1/customer/:customerAccountID/transaction/commerce",{templateUrl:"js/customer/transaction/partials/commerce-transaction-list.html",controller:"CommerceTransactionListCtrl",title:"Commerce Transaction List"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/dashboard",{templateUrl:"js/dashboard/partials/dashboard.html",controller:"DashboardCtrl",title:"Dashboard"}).when("/dashboard/:tabName",{templateUrl:"js/dashboard/partials/dashboard.html",controller:"DashboardCtrl",title:"Dashboard"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/notification",{templateUrl:"js/notification/partials/notification.html",controller:"NotificationCtrl",title:"Notifications"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/quote/:quoteNo",{templateUrl:"js/quote/quote.html",controller:"SalesQuoteController",title:"Sales Quote View"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/reminder",{templateUrl:"js/reminder/partials/reminders.html",controller:"ReminderController",title:"Reminder"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/sales",{templateUrl:"js/sales/sales.html",controller:"SalesController",title:"Hendrix Direct Sales",reloadOnSearch:false})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/search",{templateUrl:"js/search/partials/search.html",controller:"SearchCtrl",title:"Search"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/sfdc",{templateUrl:"js/sfdc/partials/sfdc-view.html",controller:"SFDCCtrl",title:"SFDC View"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/stock/:webGUID/entitlementID/:entitlementId",{templateUrl:"js/stock/partials/entitlement-view.html",controller:"StockCtrl",title:"Stock View"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/store",{templateUrl:"js/store/common/partials/store.html",controller:"StoreController",title:"Store"}).when("/store/:storeName",{templateUrl:"js/store/common/partials/store.html",controller:"StoreController",title:"Store",reloadOnSearch:true,}).when("/quoteToOrder/:quoteId",{templateUrl:"js/store/common/partials/store.html",controller:"StoreController",title:"Convert Quote To Order"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/subscription/:subscriptionId/:subscriptionAccountId",{templateUrl:"js/subscription/common/partials/subscription.html",controller:"SubscriptionController",title:"Subscription View"}).when("/subscription/:subscriptionId/:subscriptionAccountId/:viewType",{templateUrl:"js/subscription/common/partials/subscription.html",controller:"SubscriptionController",title:"Subscription View"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/team",{templateUrl:"js/team/partials/team.html",controller:"TeamController",title:"Hendrix Team Subscription"})}]);var app=app||angular.module("hxApp",["ngRoute"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/transaction/:transactionNo",{templateUrl:"js/transaction/common/partials/transaction.html",controller:"TransactionController",title:"Transaction View"}).when("/cm",{templateUrl:"js/transaction/common/partials/transaction.html",controller:"TransactionController",title:"Create CM Transaction"}).when("/dm",{templateUrl:"js/transaction/common/partials/transaction.html",controller:"TransactionController",title:"Create DM Transaction"})}]);app.directive("ngListStockAllotments",["Utils",function(Utils){return{restrict:"EA",scope:{records:"="},replace:true,templateUrl:"js/stock/partials/list-stock-allotments.html",link:function(scope,element,attrs){}}}]);app.directive("ngListStockDownloads",["Utils",function(Utils){return{restrict:"EA",scope:{records:"="},replace:true,templateUrl:"js/stock/partials/list-stock-downloads.html",link:function(scope,element,attrs){}}}]);app.directive("ngStockAddFreeLicense",["Utils","StockServices","$rootScope","StockConstants",function(Utils,StockServices,$rootScope,StockConstants){return{restrict:"EA",scope:{customerWebGUID:"=",entitlementId:"=",records:"="},replace:true,templateUrl:"js/stock/partials/stock-add-license.html",link:function(scope,element,attrs){scope.licenseQty;scope.showMessageList=[];scope.isAddbuttonEnable=true;scope.addFreeLicense=function(){scope.showMessageList=[];scope.isAddbuttonEnable=false;StockServices.addLicense({customerGuid:scope.$parent.webGUID,entitlementId:scope.$parent.entitlementId,licenseQty:scope.licenseQty}).success(function(result){scope.showMessageList.push({info:true,error:false,warning:false,text:scope.licenseQty+" licenses credited to the entitlement."});scope.isAddbuttonEnable=true;$rootScope.$broadcast(StockConstants.REFRESH_ENTITLEMENT_DETAIL_EVENT)}).error(function(error){scope.showMessageList.push({info:false,error:true,warning:false,text:scope.licenseQty+" unable to add license check quanity."});scope.isAddbuttonEnable=true})};var handleQuantityChange=function(value){if(value){var temp=parseInt(value);if(temp>0&&temp<=51){scope.isAddbuttonEnable=true}else{scope.isAddbuttonEnable=false}}else{scope.isAddbuttonEnable=false}};scope.$watch(function(){return scope.licenseQty},handleQuantityChange)}}}]);app.directive("ngStockInfo",["Utils",function(Utils){return{restrict:"EA",scope:{records:"="},replace:true,templateUrl:"js/stock/partials/stock-info.html",link:function(scope,element,attrs){}}}]);var app=app||angular.module("hxApp.directive",["ngSanitize"]);app.directive("ngCaseNotes",function(){return{restrict:"E",scope:{source:"="},replace:true,templateUrl:"js/cases/partials/notes.html",link:function(scope,element,attrs){scope.getStatus=function(noteType){if(scope.filteredNotes==noteType){return true}return false};scope.isHTMLView=true;scope.toggleHTMLView=function($event){if(scope.isHTMLView){$(".dvcase-note-html").hide();$(".dvcase-note-html").next().show();$($event.currentTarget).text("Switch to html view")}else{$(".dvcase-note-html").show();$(".dvcase-note-html").next().hide();$($event.currentTarget).text("Switch to text view only")}scope.isHTMLView=!scope.isHTMLView}}}});var app=app||angular.module("hxApp.directive",[]);app.directive("ngNotesTemplates",["NotesTemplatesService",function(NotesTemplatesService){return{restrict:"EA",scope:{selectedTags:"=",customer:"=",actionInsert:"&",actionReplace:"&",selectedTemplate:"="},replace:true,templateUrl:"js/cases/partials/notes-templates-popup.html",link:function(scope,element,attrs){scope.selectedTags=[];scope.availableTags=[];scope.availableNotes=[];scope.loadTags=function(){NotesTemplatesService.getTags().success(function(data,status,headers,config){scope.availableTags=[];angular.forEach(data,function(item){if(item.status&&item.status.toUpperCase()=="ACTIVE"){scope.availableTags=scope.availableTags.concat(item.tagtext.split(","))}});scope.availableTags=scope.availableTags.unique().sort()}).error(function(){})};scope.displayPossibleNotes=function(){scope.selectedTags=scope.selectedTags.filter(function(){return true});if(scope.selectedTags.length==0){scope.availableNotes=[];return}NotesTemplatesService.getTemplatesForTags(encodeURIComponent(scope.selectedTags.join(" "))).success(function(data,status,headers,config){scope.availableNotes=[];scope.tempAvailableNotes=data.sort(function(a,b){if(a.title<b.title){return -1}if(a.title>b.title){return 1}return 0});angular.forEach(scope.tempAvailableNotes,function(item){if(item.status&&item.status.toUpperCase()=="ACTIVE"){scope.availableNotes.push(item)}})}).error(function(){})};scope.getTemplate=function(path){NotesTemplatesService.getTemplate(path).success(function(data,status,headers,config){scope.selectedTemplateData=data;scope.selectedTemplate=NotesTemplatesService.replaceVars(data,scope.customer)}).error(function(){})};scope.showModal=function(){$("body").css("overflow","hidden");element.find("#notesTemplatesModal").modal("show")};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#notesTemplatesModal").modal("hide")};scope.handleInsert=function(){scope.$parent.insertTemplate(scope.selectedTemplate);scope.closeModal()};scope.handleReplace=function(){scope.$parent.replaceTemplate(scope.selectedTemplate);scope.closeModal()};scope.isSelected=function(){return scope.selectedTags.indexOf(($.trim(this.tag)))!=-1};scope.toggleTag=function(){var tagName=this.tag;var index=scope.selectedTags.indexOf(($.trim(tagName)));if(index!=-1){scope.selectedTags.splice(index,1)}else{scope.selectedTags.push(($.trim(tagName)))}scope.displayPossibleNotes()};scope.handleSelectNote=function(){scope.selectedNote=this.note;scope.getTemplate(this.note["jcr:path"])};scope.loadTags()}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("NotesTemplatesService",["$http","Utils",function($http,Utils){var service={};service.getTags=function(){return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:"/content/notestemplate/notes.search.json?q=*&property=tagtext&property=status"}})};service.getTemplatesForTags=function(tags){console.log(tags);return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:"/content/notestemplate/notes.search.json?q="+tags+"&property=title&property=tagtext&property=status"}})};service.getTemplate=function(path){return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:path+".json"}})};service.replaceVars=function(data,customer,order){var note=data.posttext;if(customer){note=note.replace("$customerName",Utils.getNameFromCustomerDto(customer))}return note};return service}]);var app=app||angular.module("hxApp");app.controller("NotificationCtrl",["$scope","$rootScope","$filter","MetadataService","NotificationService","TrackingService","TagCloudService","$location","LocalStorageService","UserService","Utils",function($scope,$rootScope,$filter,MetadataService,NotificationService,TrackingService,TagCloudService,$location,LocalStorageService,UserService,Utils){TrackingService.trackPageView("Notifications","Notifications View");Utils.pageTitle("Notifications");$scope.metadata=new Object();UserService.getCurrentUser().success(function(result){if($rootScope.returnUrl){$rootScope.returnUrl=null}}).error(function(error){console.log("UserService.getCurrentUser() -->"+error);return});MetadataService.initializeNotificationMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;updateMetadata($scope.metadata)});$scope.isLoading=true;$scope.records=[];$scope.statuses=[];$scope.productNames=[];$scope.subProductNames=[];$scope.messages=[];$scope.selectedRow=-1;$scope.viewState="edit";$scope.validEmailList=["adobe.com","agent.teleperformance.com","trans-cosmos.co.kr","teleperformance.com","usa.teleperformance.com","email.247customer.com","247customer.com","mail.teleperformance.com","teleperformance.de","teleperformance.nl","tp-tec.se"];$scope.selectedTags=[];$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.tagCategories=[];$scope.availableTagCategories=[];$scope.selectedTagCategory=[];$scope.selectedTagsForCategory=[];$scope.availbleTagsForCategory=[];$scope.editedCaseTags="";$scope.updateMessages="";var defaultNotification=function(){return jQuery.extend({},{channel:"",transactionType:"ZCSC",priority:"",status:"",result:"",reason:"",product:"",subProduct:"",customerId:"",email:"",inAppSubscription:false,top100:false,tags:[]})};$scope.notification=defaultNotification();$scope.caseTypeFields={};var setFieldsNames=function(caseType){if(caseType=="ZCSC"){return $scope.caseTypeFields={statusCode:"code",statusName:"label",resultCode:"code",resultName:"label",reasonCode:"code",reasonName:"name"}}else{return $scope.caseTypeFields={statusCode:"id",statusName:"value",resultCode:"id",resultName:"value",reasonCode:"id",reasonName:"value"}}};$scope.listNotifications=function(){$scope.isLoading=true;NotificationService.listNotifications().success(function(result){$scope.records=result;$scope.isLoading=false}).error(function(){$scope.isLoading=false;$scope.showMessage("error","Failed to load notifications")})};$scope.listNotifications();$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};var updateMetadata=function(data){if($scope.notification.transactionType=="ZCSC"){$scope.caseTypeFields=setFieldsNames("ZCSC");$scope.statuses=$filter("orderBy")(data.metacaseStatuses,"label");$scope.reasons=$filter("orderBy")($scope.getNewCsCaseCategory(data.metaproductCategories),"name")}else{$scope.caseTypeFields=setFieldsNames("ZCSS");$scope.statuses=$filter("orderBy")(data.tsCaseStatusDtos,"value");$scope.reasons=$filter("orderBy")(data.tsCaseSubjectDtos,"value")}$scope.metadata.productNames=$filter("orderBy")(data.productNames,"name")};$scope.getNewCsCaseCategory=function(data){var tempCategories=[];angular.forEach(data,function(item){if(item.name.indexOf("*")!=0){tempCategories.push(item)}});return tempCategories};$scope.setPriority=function(option){$scope.notification.priority=option};var caseTypeUnbindWatch=$scope.$watch("notification.transactionType",function(newValue,oldValue){if(newValue==oldValue){return}updateMetadata($scope.metadata)});$scope.handleRowSelection=function(idx){$scope.viewState="view";$scope.notification=$scope.records[idx];$scope.selectedRow=idx};$scope.addNew=function(){$scope.$$childTail.notificationEditForm.$setPristine();$scope.viewState="edit";$scope.notification=angular.copy(defaultNotification())};$scope.refresh=function(){$scope.listNotifications()};$scope.isValid=function(){if(!angular.isDefined($scope.notification.email)||$scope.notification.email==""){return false}if(!angular.isDefined($scope.notification.channel)||$scope.notification.channel==""||$scope.notification.channel==undefined){return false}else{var emailAddress=$scope.notification.email.toString();var temp=new Array();temp=emailAddress.split("@");var flag=false;if(temp.length>2){return false}else{for(var i=0;i<$scope.validEmailList.length;i++){if($scope.validEmailList[i].indexOf(temp[1])>=0){flag=true;break}}if(flag==false){return false}}}if(!($scope.notification.channel)){$scope.notification.channel=""}var result=(($scope.notification.email.toString()!=="")&&($scope.notification.channel.toString()!==""))||(($scope.notification.email.toString()!=="")&&($scope.notification.tags.length>0));return result};$scope.save=function(){$scope.notification.channel=$scope.notification.channel.toUpperCase();$scope.notification.tags=$scope.notification.tags.toString();NotificationService.subscribe($scope.notification).success(function(){$scope.showMessage("info","Notification saved");$scope.viewState="view";$scope.listNotifications();$scope.notification.tags=$scope.notification.tags.split(",")}).error(function(){$scope.showMessage("error","Failed to save notification");$scope.listNotifications()})};$scope.handleCancel=function(){$scope.$$childTail.notificationEditForm.$setPristine();if(!$scope.notification.id){$scope.notification=defaultNotification()}else{$scope.notification=angular.copy($scope.backupNotification)}$scope.viewState="view"};$scope.edit=function(){$scope.$$childTail.notificationEditForm.$setPristine();console.log("edit btn2");$scope.viewState="edit";$scope.backupNotification=angular.copy($scope.notification);$scope.notification=angular.copy($scope.notification);$scope.notification.tags=$scope.notification.tags.split(",");$scope.selectedCaseTags=angular.copy($scope.notification.tags)};$scope.openDeleteNotificationModal=function(){$("#deleteNotificationModal").modal("show")};$scope.deleteNotification=function(){$scope.deleteNotificationLoading=true;NotificationService.unsubscribe({id:$scope.notification.id}).success(function(){$scope.deleteNotificationLoading=false;$scope.cancelDeleteNotificationModal();$scope.showMessage("info","Subscription has been removed");$scope.refresh();$scope.addNew();$scope.viewState="view";$scope.listNotifications()}).error(function(){$scope.showMessage("error","Failed to remove subscription");$scope.listNotifications();$scope.cancelDeleteNotificationModal()})};$scope.cancelDeleteNotificationModal=function(){$scope.deleteNotificationLoading=false;$("#deleteNotificationModal").modal("hide")};TagCloudService.getTagCategory().success(function(result){$scope.tagCategory=result.sort(function(a,b){if(a.categorytext<b.categorytext){return -1}if(a.categorytext>b.categorytext){return 1}return 0});angular.forEach($scope.tagCategory,function(item){if(item.status=="ACTIVE"){$scope.availableTagCategories.push(item)}})});$scope.updateTagCloudForCategory=function(){var categoryName=this.tagCategory;var index=$scope.selectedTagCategory.indexOf(($.trim(categoryName.categorytext)));if(index!=-1){$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext)}else{$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext);$scope.populateTagsForCategory(categoryName.categorytext)}};$scope.populateTagsForCategory=function(newValue){$scope.availbleTagsForCategory=[];TagCloudService.getTagsForCategory(newValue).success(function(result){angular.forEach(result,function(item){if(item.status=="ACTIVE"){$scope.availbleTagsForCategory.push(item)}})})};$scope.loadCaseTags=function(){$scope.caseTags=[];$scope.caseTagsCloud=[];TagCloudService.getTagCaseClouds().success(function(result){$scope.caseTagsCloud=result.sort(function(a,b){if(a.tagtext<b.tagtext){return -1}if(a.tagtext>b.tagtext){return 1}return 0});angular.forEach($scope.caseTagsCloud,function(item){$scope.caseTags.push(item.tagtext)});$scope.caseTags=scope.caseTags.unique().sort()}).error(function(){})};$scope.isSavedHistoryOpen=false;$scope.openTagCloud=function(){$scope.updateMessages="";$scope.selectedCaseTags=angular.copy($scope.notification.tags);if(!$scope.isSavedHistoryOpen){$("#tagListContainer").css("display","block");$("#openTagListBtn").css("display","block");$scope.isSavedHistoryOpen=true}else{$("#tagListContainer").css("display","none");$("#openTagListBtn").css("display","none");$scope.isSavedHistoryOpen=false}};$scope.closeTagCloud=function(){$("#tagListContainer").css("display","none");$("#openTagListBtn").css("display","none");$scope.isSavedHistoryOpen=false};$scope.toggleTag=function(){if($scope.selectedCaseTags==undefined||$scope.selectedCaseTags==""){$scope.selectedCaseTags=[]}var tagName=this.tag.tagtext;var index=$scope.selectedCaseTags.indexOf(($.trim(tagName)));if(index!=-1){$scope.selectedCaseTags.splice(index,1)}else{$scope.selectedCaseTags.push(($.trim(tagName)))}$scope.searchCaseTags=$scope.selectedCaseTags.toString()};$scope.isCategorySelected=function(){return $scope.selectedTagCategory.indexOf(($.trim(this.tagCategory.categorytext)))!=-1};$scope.isCategoryTagSelected=function(){return $scope.selectedCaseTags.indexOf(($.trim(this.tag.tagtext)))!=-1};$scope.removeTag=function(){var tagName=this.tag;var index=$scope.selectedCaseTags.indexOf(($.trim(tagName)));if(index!=-1){$scope.selectedCaseTags.splice(index,1)}};$scope.applyCustomeTag=function(){if($("#id_tagtext").val()){var ac=$("#id_tagtext").val().split(",");angular.forEach(ac,function(item){$scope.selectedCaseTags.push(item)})}};$scope.closeTagOpetion=function(){$("#tagListContainer").css("display","none");$("#openTagListBtn").css("display","none");$scope.isSavedHistoryOpen=false;$scope.updateMessages=""};$scope.updateTagOption=function(){$scope.updateMessages="updated";$scope.notification.tags=$scope.selectedCaseTags};$scope.$on("$destroy",function(){caseTypeUnbindWatch()})}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("NotificationService",function($http){var service={};service.listNotifications=function(){return $http({method:"GET",url:"../notifications/list.do?"+Math.random(),headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.subscribe=function(data){return $http({method:"POST",url:"../notifications/subscribe.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.unsubscribe=function(data){return $http({method:"POST",url:"../notifications/unsubscribe.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("OnlineFlexibleTrialProductService",["$http",function($http){var service={};service.getTrialDeviceDetails=function(data){return $http({method:"POST",url:"../oftService/getTactTrialDeviceDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("OrderController",["$scope","$log","$rootScope","$location","$routeParams","$window","$http","TrackingService","AppConstants","AppUtils","StoreUtil","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService","CustomerSubscriptionService","ImsCustomerService","SubscriptionConstants","CommerceServices","CustomerUtil",function($scope,$log,$rootScope,$location,$routeParams,$window,$http,TrackingService,AppConstants,AppUtils,StoreUtil,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService,CustomerSubscriptionService,ImsCustomerService,SubscriptionConstants,CommerceServices,CustomerUtil){TrackingService.trackPageView("Transaction","Order View");$scope.orderTransaction=angular.copy($scope.transaction);$scope.isTransactionComplete=false;$scope.isTransactionOpen=false;$scope.isUpdateOrderDisabled=true;$scope.isMemoBtnEnabled=false;$scope.isDebitMemoBtnEnabled=false;$scope.isExecuteActionShow=false;$scope.isExecuteActionDisabled=true;$scope.isTermsAndConditionsShow=false;$scope.isRetriggerChkBoxDisabled=false;$scope.subscriptionStatusCode="";$scope.newUI=$routeParams.newui=="true"?true:false;$scope.showSubscriptionPod=false;$scope.isAddressUpdated=false;$scope.priceLockMessages=[];$scope.updatedPaymentdetails;$scope.NotModify_billingAddress;$scope.NotModify_shippingAddress;$scope.cancelNonSubscriptionOrderReason={selectedId:null};$scope.triggerJapanesePaymentEmail=false;$scope.triggerJapanesePaymentForm=false;$scope.paymentType;$scope.isTnCAccepted=false;$scope.isTncButtonDisabled=true;$scope.isPaymentFormValid=false;$scope.isTransactionBTWithPUF=false;$scope.priceLockProgress=false;$scope.priceLockSuccess=false;$scope.checkTrackingInfo=function(){if($scope.transaction){if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.transaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.transaction.items&&$scope.transaction.items.length>0){for(var itemCount=0;itemCount<$scope.transaction.items.length;itemCount++){if($scope.transaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.checkDocumentFlow=function(){if($scope.transaction){if($scope.isOnlyEsdOrder||$scope.isOnlySubOrder){return true}return[TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER].indexOf($scope.transaction.transactionType)>-1}return false};$scope.checkOrderActions=function(){if($scope.transaction.actions){if($scope.transaction.actions.length>0){$scope.transactionOrderActionsHistory=$scope.transaction.actions;return true}}return false};$scope.validateButtonVisibility=function(){$scope.isPurchaseOrder=false;$scope.isJpbtCcmOrder=false;if($scope.isSubscriptionOrder&&$scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){$scope.isPurchaseOrder=true;$scope.isSubscriptionEditBtnShow=true}else{if($scope.isSubscriptionOrder){$scope.isSubscriptionEditBtnShow=true;$scope.isNonSubscriptionEditBtnShow=false}else{$scope.isSubscriptionEditBtnShow=false;$scope.isNonSubscriptionEditBtnShow=true;if($scope.isOnlyHardGoodOrder&&$scope.isTransactionOpen){$scope.isModifyOrderBtnShow=true;$scope.isCancelOrderBtnShow=true;$scope.isReturnOrderBtnShow=false}else{$scope.isReturnOrderBtnShow=true;$scope.isModifyOrderBtnShow=false;$scope.isCancelOrderBtnShow=false}}}if(($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)&&OrderUtils.isPuf($scope.transaction.items)){$scope.isJpbtCcmOrder=true}if(!$scope.transaction.refundAllowed){$scope.isMemoBtnEnabled=false;return}angular.forEach($scope.transaction.items,function(productItem){if(productItem.deliveryStatus!=TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){$scope.isMemoBtnEnabled=true}});if($scope.transaction&&$scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.DUMMY_CARD){$scope.isDebitMemoBtnEnabled=true}};$scope.initializeOrderScreen=function(){$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.transaction.items);$scope.isOnlyEsdOrder=OrderUtils.isOnlyEsdOrder($scope.transaction.items);$scope.isOnlySubOrder=OrderUtils.isOnlySubOrder($scope.transaction.items);$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.isDocumentFlowShow=$scope.checkDocumentFlow();$scope.checkOrderActions();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.transaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.transaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.transaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.transaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.transaction);if($scope.transaction.paymentDetails&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.transaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if($scope.cardTypeName==="MC"){$scope.cardTypeName="MasterCard"}}$scope.transactionStatusLabel=TransactionUtil.getStatusLabel($scope.transaction.statusLabel);$scope.isTransactionComplete=OrderUtils.isTransactionComplete($scope.transaction.statusLabel);$scope.isTransactionOpen=OrderUtils.isTransactionOpen($scope.transaction.statusLabel);$scope.isTransactionBTWithPUF=$scope.$parent.isTransactionBTWithPUF;$scope.isTermsAndConditionsShow=false;$scope.validateButtonVisibility()};$scope.getDylanOrderDetails=function(data){var orderNumber=$scope.transaction.externalReferenceNo;if($scope.transaction.externalReferenceNo!=""){TransactionService.dylanOrderDetails(orderNumber).success(function(response){console.log(response);if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_CCM_TEAM_ORDER||$scope.transaction.transactionType==TransactionConstants.TRANSACTION_DYLAN_ORDER){for(var i=0;i<$scope.transaction.items.length;i++){if($scope.transaction.items[i].productType.indexOf(TransactionConstants.DSP_PRODUCT_TYPE)>-1||$scope.transaction.items[i].productType.indexOf(TransactionConstants.SSP_PRODUCT_TYPE)>-1){$scope.showSubscriptionPod=true}}}else{$scope.showSubscriptionPod=false}$scope.commerceOrderStatus=response.status;console.log($scope.commerceOrderStatus);if(response.customer&&response.customer.customerIdentifications){var customerIdentifications=response.customer.customerIdentifications;$scope.subscriptionListRecords=[];for(var i in customerIdentifications){if(customerIdentifications[i].idType===AppConstants.CUSTOMER_WEB_GUID&&$scope.showSubscriptionPod){$scope.customerIdentificationGuid=customerIdentifications[i].idNumber;console.log("Query CustomerSubscriptionService.getSubscriptions",$scope.customerIdentificationGuid);$scope.subscriptionsLoading=true;$scope.locale="";$scope.subscriptionAccountId=$scope.customerIdentificationGuid+"@AdobeID";CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:$scope.subscriptionAccountId,locale:$scope.locale}).success(function(result){$scope.subscriptionsLoading=false;console.log("Success CustomerSubscriptionService.getSubscriptions");for(var subscriptionObj in result){if(result[subscriptionObj].storeOrderNumber===$scope.transaction.externalReferenceNo){result[subscriptionObj].subscriptionAccountId=$scope.customerIdentificationGuid;if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAID)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_GRACE_PAST_DUE&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_INACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED}else{result[subscriptionObj].status=""}}}}}$scope.subscriptionListRecords.push(result[subscriptionObj])}}}).error(function(error){console.log("error",error);$scope.subscriptionsLoading=false})}else{if(customerIdentifications[i].idType===AppConstants.CUSTOMER_WEB_GUID&&$scope.showTeamSubscriptionPod){$scope.teamSubscriptionsLoading=true;$scope.teamSubscriptionProductList=[];$scope.customerGuid=customerIdentifications[i].idNumber;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:"en_us"}).success(function(result,status,headers,config){$scope.teamSubscriptionProductList=CustomerUtil.getTeamSubscriptionList(result,$scope.customerGuid);$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})}}}}}).error(function(errorData){console.log(errorData)})}};if($scope.transaction.statusLabel){$scope.getDylanOrderDetails()}$scope.getApproveEduOrder=function(data){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Approve EDU Order";$scope.isEduOrderStatus=false;var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.approveEduOrder(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been approved successfully.";$scope.isEduOrderStatus=true}).error(function(errorData){console.log(errorData);$scope.isLoading=false})};$scope.getRejectEduOrder=function(data){$("#approveRejectEduOrderModal").modal("show");$scope.EduOrderTitle="Reject EDU Order";$scope.isEduOrderStatus=false;var orderExtRefNo=$scope.transaction.externalReferenceNo;$scope.isLoading=true;TransactionService.rejectEduOrder(orderExtRefNo).success(function(response){console.log(response);$scope.isLoading=false;$scope.approveRejectEduOrderSuccessMessage="The order has been rejected successfully.";$scope.isEduOrderStatus=true}).error(function(errorData){console.log(errorData);$scope.isLoading=false})};$scope.initializeOrderScreen();if($scope.transaction){$scope.isProductCCT=OrderUtils.isCCTProduct($scope.transaction.items[0].productType)}$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.transaction.transactionGuid,transactionNo:$scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.transaction.transactionGuid,transactionNo:$scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.showOrderActions=function(){$scope.showOrderActionsContainer=!$scope.showOrderActionsContainer};$scope.hideOrderActions=function(){$scope.showOrderActionsContainer=false};$scope.openEditBillingView=function(){$scope.isTermsAndConditionsShow=$scope.isTnCAccepted=$scope.isAddressUpdated=false;$scope.$parent.updateLoadingMessage("Locking Transaction");$scope.$parent.showViewLoading();$scope.isUpdateOrderDisabled=true;TransactionService.lockTransaction({guid:$scope.transaction.transactionGuid}).success(function(lockResult){$scope.$parent.hideViewLoading();if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_EDIT_BILLING_EVENT,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,lockResult);if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){$scope.isExecuteActionShow=true}if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE&&OrderUtils.isCcmTeam($scope.transaction.items)){$scope.isRetriggerChkBoxDisabled=true;$scope.termsAndConditionsText="";$scope.checkTnC()}else{if($scope.transaction.paymentDetails.paymentType==PaymentConstants.DUMMY_CARD&&$scope.transaction.reason.code==TransactionConstants.SESI_ORDER_REASON_CODE_ADOBE_MANAGED){$scope.termsAndConditionsText="";$scope.checkTnC()}else{$scope.isRetriggerChkBoxDisabled=false}}$scope.checkOrderActions()}}).error(function(result){$scope.$parent.hideViewLoading()})};$scope.openModifyOrderView=function(){$scope.isUpdateOrderDisabled=true;TransactionService.lockTransaction({guid:$scope.transaction.transactionGuid}).success(function(lockResult){if(lockResult){$scope.$emit(TransactionConstants.TRANSACTION_MODIFY_ORDER_EVENT,TransactionConstants.TRANSACTION_NON_SUBSCRIPTION__ORDER,lockResult)}}).error(function(result){})};$scope.openCreateCreditMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_EVENT)};$scope.openCreateDebitMemoView=function(){$scope.$emit(TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_EVENT)};$scope.openReturnOrderView=function(){$scope.$emit(TransactionConstants.TRANSACTION_ORDER_RETURN_VIEW_EVENT)};$scope.$watch("cancelNonSubscriptionOrderReason.selectedId",function(){if($scope.cancelNonSubscriptionOrderReason.selectedId!=null&&$scope.cancelNonSubscriptionOrderReason.selectedId!=""){$scope.isCancelNonSubscriptionReasonSelected=$scope.cancelNonSubscriptionOrderReason.selectedId}else{$scope.isCancelNonSubscriptionReasonSelected=null}},true);$scope.cancelNonSubscriptionOrder=function(){$scope.cancelNonSubscriptionOrderServiceLoading=true;TransactionService.cancelNonSubscriptionOrder({transactionGuid:$scope.transaction.transactionGuid,cancelReasonCode:$scope.cancelNonSubscriptionOrderReason.selectedId}).success(function(lockResult){$scope.cancelOrderServiceMessage="The Cancel Order Transaction Completed Successfully";$scope.cancelOrderLoading=$scope.cancelNonSubscriptionOrderServiceLoading=false}).error(function(result){$scope.cancelOrderServiceMessage="The Cancel Order Transaction Failed";$scope.cancelOrderLoading=$scope.cancelNonSubscriptionOrderServiceLoading=false})};$scope.showCancelNonSubscriptionOrderModal=function(){$("#cancelNonSubscriptionOrderModal").modal("show");$scope.cancelOrderLoading=true};$scope.closeCancelNonSubscriptionOrderModal=function(){$("#cancelNonSubscriptionOrderModal").modal("hide")};$scope.refreshOrderScreen=function(){location.reload()};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_CANCEL_ADDRESS_UPDATE_EVENT,$scope.NotModify_billingAddress,$scope.NotModify_shippingAddress);$scope.isExecuteActionShow=false;$scope.isRetriggerChkBoxDisabled=false};$scope.$on(TransactionConstants.TRANSACTION_PAYMENT_UPDATE_EVENT,function(event,isPaymentValid,updatedPayment){if(isPaymentValid){$scope.updatedPaymentdetails=updatedPayment}if(AppUtils.showTnCWhenPaymentReset($scope.transaction,$scope.updatedPaymentdetails)){$scope.isTermsAndConditionsShow=true}$scope.isPaymentFormValid=isPaymentValid;$scope.checkEnableOrderButton()});$scope.checkEnableOrderButton=function(){if($scope.isTermsAndConditionsShow){$scope.isUpdateOrderDisabled=!($scope.isPaymentFormValid&&$scope.isTnCAccepted)}else{if(!$scope.isTermsAndConditionsShow){$scope.isUpdateOrderDisabled=!$scope.isPaymentFormValid}}$scope.checkSESIOrderUpdateButtonCheck()};$scope.updateTermsAndConditionsCheck=function(){$scope.isTnCAccepted=true;$scope.checkEnableOrderButton()};$scope.checkSESIOrderUpdateButtonCheck=function(){if($scope.transaction.reason.code==TransactionConstants.SESI_ORDER_REASON_CODE_ADOBE_MANAGED&&$scope.transaction.paymentDetails.paymentType==PaymentConstants.DUMMY_CARD){if($scope.isAddressUpdated&&$scope.isPaymentFormValid&&$scope.isTnCAccepted){$scope.isUpdateOrderDisabled=false}else{$scope.isUpdateOrderDisabled=true}}};$scope.$on(TransactionConstants.TRANSACTION_ADDRESS_UPDATE_EVENT,function(event,addressType,address){$scope.isUpdateOrderDisabled=false;$scope.isAddressUpdated=true;$scope.NotModify_billingAddress=angular.copy($scope.transaction.billingAddress);$scope.NotModify_shippingAddress=angular.copy($scope.transaction.shippingAddress);if(addressType==TransactionConstants.ADDRESS_TYPE_BILLING){$scope.transaction.billingAddress=address}else{if(addressType==TransactionConstants.ADDRESS_TYPE_SHIPPING){$scope.transaction.shippingAddress=address}}$scope.checkSESIOrderUpdateButtonCheck()});$scope.enableActionExecution=function(){if($("#triggerPaymentFormChkbox").prop("checked")||$("#triggerPaymentFormEmailChkbox").prop("checked")){$scope.triggerJapanesePaymentForm=$("#triggerPaymentFormChkbox").prop("checked");$scope.triggerJapanesePaymentEmail=$("#triggerPaymentFormEmailChkbox").prop("checked");$scope.isExecuteActionDisabled=false;return}$scope.isExecuteActionDisabled=true};$scope.updateOrder=function(){if($scope.updatedPaymentdetails){$scope.transaction.paymentDetails=$scope.updatedPaymentdetails}var updateOrderTransaction=angular.copy($scope.transaction);$scope.$parent.shippingModifyBtnShow=$scope.$parent.billingModifyBtnShow=false;$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Update Order Is In Progress",false,false);TransactionService.update(updateOrderTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed",result.messages,true,true);$scope.transaction=angular.copy($scope.originalTransaction)}else{$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Confirmation",result.messages,true,true);$scope.transaction.paymentDetails=result.paymentDetails;if($scope.transaction.paymentDetails.cardType==="MC"){$scope.cardTypeName="MasterCard"}else{if($scope.transaction.paymentDetails.cardType){$scope.cardTypeName=$scope.transaction.paymentDetails.cardType}}$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Update Order Transaction Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.executeAction=function(){var executeOrderTransaction=angular.copy($scope.transaction);executeOrderTransaction.triggerJapanesePaymentEmail=$scope.triggerJapanesePaymentEmail;executeOrderTransaction.triggerJapanesePaymentForm=$scope.triggerJapanesePaymentForm;$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execute Actions","Execute Action Is In Progress",false,false);TransactionService.update(executeOrderTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execution Failed",result.messages,true,true);$scope.transaction=angular.copy($scope.originalTransaction)}else{$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed",result.messages,true,true);$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Execute Action Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.openOrderActionHistoryPreview=function(actionHistoryItem){window.open(actionHistoryItem.previewUrl,"Order Action History","width=1024, height=800, scrollbars=yes")};$scope.checkTnC=function(){if($scope.transaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.transaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){var countryCode="JA";ImsCustomerService.getTncByTemplate({templateName:"tc_ccm_team_com_reg_pp",locale:countryCode}).success(function(result){if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");$scope.termsAndConditionsText=tncText;$scope.isTncButtonDisabled=false}}).error(function(result){AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.transaction.customer.address.country.code+" for SKU = "+$scope.transaction.items[0].sku)})}else{if($scope.transaction.paymentDetails.paymentType==PaymentConstants.DUMMY_CARD&&$scope.transaction.reason.code==TransactionConstants.SESI_ORDER_REASON_CODE_ADOBE_MANAGED){var marketSegment=AppConstants.MARKET_TYPE_COMMERCIAL;if($scope.transaction.edu){marketSegment=AppConstants.MARKET_TYPE_EDUCATIONAL}CommerceServices.searchBySku({sku:$scope.transaction.items[0].sku,country:$scope.transaction.customer.address.country.code,market_segment:marketSegment}).success(function(data,status,headers,config){if(data&&data.sellableItem&&data.sellableItem.terms_and_conditions_service_name){ImsCustomerService.getTncByTemplate({templateName:data.sellableItem.terms_and_conditions_service_name,locale:StoreUtil.getDefaultCountryLanguage($scope.transaction.customer.address.country.code)}).success(function(result){if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");$scope.termsAndConditionsText=tncText;$scope.isTncButtonDisabled=false}}).error(function(result){$scope.termsAndConditionsText="Terms & Conditions Loading Failed ...";$scope.isTncButtonDisabled=false;AppUtils.sendLogToServer("The Java T&C Service Failed in Edit Billing for "+$scope.transaction.customer.address.country.code+" for SKU = "+$scope.transaction.items[0].sku)})}else{$scope.termsAndConditionsText="Terms & Conditions Loading Failed ...";$scope.isTncButtonDisabled=false;AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.transaction.customer.address.country.code+" for SKU = "+$scope.transaction.items[0].sku)}}).error(function(data,status,headers,config){$scope.termsAndConditionsText="Terms & Conditions Loading Failed ...";$scope.isTncButtonDisabled=false;AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.transaction.customer.address.country.code+" for SKU = "+$scope.transaction.items[0].sku)})}}};$scope.showCancelJPOPPendingOrder=function(){var executeOrderTransaction=angular.copy($scope.transaction);$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Cancel Pending Order","Cancel Pending Order Is In Progress",false,false);TransactionService.cancelStoreOrder({orderExtRefNo:executeOrderTransaction.externalReferenceNo}).success(function(result){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed","Order "+executeOrderTransaction.externalReferenceNo+" is cancelled successfully",true,true);$scope.$emit(TransactionConstants.TRANSACTION_CANCEL_JPOP_ORDER_EVENT,true)}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Execute Action Failed, Try Again..."));$("#transactionProgressModal").modal("hide");$scope.transaction=angular.copy($scope.originalTransaction)})};$scope.$watch("$scope.transaction.payerAddress.country.code",function(newValue){$scope.transaction.payerAddress.country.name=MetadataService.getCountryNameFromCountry($scope.metadata.countries,$scope.transaction.payerAddress.country.code)});$scope.refreshTransaction=function(){TransactionService.refreshTransaction({orderNo:$scope.transaction.transactionNumber,transactionGuid:$scope.transaction.transactionGuid}).success(function(result){if(result){location.reload();console.info("refreshTransaction --> TransactionService.refreshTransaction ->",result)}}).error(function(result){console.info("Transaction was not able to refresh properly!");var messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Failed to re-load the transaction");angular.forEach(messages,function(message){message.error=null});$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,messages)})};$window.onbeforeunload=function(){if($scope.transactionView==TransactionConstants.TRANSACTION_EDIT_BILLING_VIEW){$scope.$parent.unlockTransaction();setTimeOut(function(){},100)}};$scope.createDocumentFlowItemWrapper=function(invoiceNum){return jQuery.extend({},{invoice:invoiceNum,documentFlowItemDtos:[]})};$scope.createDocumentFlowItem=function(documentFlowItemDto){return jQuery.extend({},{cc4Digits:documentFlowItemDto.cc4Digits,ccType:documentFlowItemDto.ccType,currency:documentFlowItemDto.currency,description:documentFlowItemDto.description,docDate:documentFlowItemDto.docDate,docNum:documentFlowItemDto.docNum,docPosNo:documentFlowItemDto.docPosNo,docType:documentFlowItemDto.docType,ordItem:documentFlowItemDto.ordItem,orderNo:documentFlowItemDto.orderNo,product:documentFlowItemDto.product,quantity:documentFlowItemDto.quantity,quantityUnit:documentFlowItemDto.quantityUnit,value:documentFlowItemDto.value})};$scope.retriggerEmail=function(documentFlowItemDto){var documentFlowItem=$scope.createDocumentFlowItem(documentFlowItemDto);var documentFlowWrapper=$scope.createDocumentFlowItemWrapper(documentFlowItemDto.docNum);documentFlowWrapper.documentFlowItemDtos.push(documentFlowItem);DocumentFlowService.retriggerEmail(documentFlowWrapper).success(function(result){var messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_INFO_TYPE,"How to pay online email has been sent.");angular.forEach(messages,function(message){message.error=null});$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,messages)}).error(function(result){var messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"How to pay online email has not been sent.");angular.forEach(messages,function(message){message.error=null});$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,messages)})};$scope.applyPriceLock=function(){$scope.priceLockProgress=true;$scope.priceLockSuccess=false;$scope.priceLockMessages=[];TransactionService.priceLockForTransaction($scope.transaction).success(function(result){$scope.priceLockMessages=result;$scope.priceLockProgress=false;$scope.priceLockSuccess=true}).error(function(error){$scope.priceLockProgress=false;$scope.priceLockSuccess=false})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=$scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngOrderInteraction",["TransactionService",function(TransactionService){return{restrict:"EA",scope:{orderid:"=",templatetype:"="},replace:true,templateUrl:"js/transaction/common/partials/transactions-interaction-history.html",link:function(scope,element,attrs){scope.showTransactionHistoryBtn=false;scope.$watch(scope.orderid,function(){if(scope.orderid){scope.showTransactionHistoryBtn=true}});scope.$watch(scope.templatetype,function(){if(scope.templatetype){scope.templatetype=scope.templatetype.split("_").join(" ")}});scope.showTransactionHistoryModal=function(){element.find("#transactionHistoryModal").modal("show");scope.rescale();scope.fetchInteractionHistory();$(window).bind("resize",scope.rescale)};scope.closeTransactionHistoryModal=function(){scope.interactionHistory=[];$("body").css("overflow","auto");element.find("#transactionHistoryModal").modal("hide")};scope.fetchInteractionHistory=function(){scope.interactionHistory=[];scope.isInteractionHistoryLoading=true;scope.showInteractionHistoryMessage=false;TransactionService.getTransactionHistory({transactionId:scope.orderid}).success(function(result){console.log("TransactionService.getTransactionHistory  :: -->"+result);scope.interactionHistory=result;if(scope.interactionHistory==0){scope.interactionHistoryMessage="No records found";scope.showInteractionHistoryMessage=true;scope.isInteractionHistoryLoading=false}scope.isInteractionHistoryLoading=false}).error(function(result){scope.interactionHistoryMessage="There was some error while fetching the history. Please refresh..";scope.showInteractionHistoryMessage=true;scope.isInteractionHistoryLoading=false;console.log("TransactionService.getTransactionHistory  :: -->"+result)})};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};$("#transactionHistoryModal .modal-body").css({height:size.height-300,"max-height":"none","overflow-x":"hidden"})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("OrderReturnController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService){TrackingService.trackPageView("Transaction","Order Return View");$scope.orderReturnReasons=[];$scope.wizardStep=1;$scope.orderReturnTransaction=angular.copy($scope.transaction);$scope.orderReason={selectedId:null};$scope.cancelReason={selectedId:null};angular.forEach($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],function(reasonItem){var orderReasonItem=angular.copy(reasonItem);if(orderReasonItem[MetadataService.INDEX_NAMES.ORDER_TYPE]==TransactionConstants.TRANSACTION_ORDER_RETURN&&orderReasonItem[MetadataService.INDEX_NAMES.LABEL].indexOf("#")<0){$scope.orderReturnReasons.push(orderReasonItem)}});$scope.checkTrackingInfo=function(){if($scope.orderReturnTransaction){if($scope.orderReturnTransaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.orderReturnTransaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.orderReturnTransaction.items&&$scope.orderReturnTransaction.items.length>0){for(var itemCount=0;itemCount<$scope.orderReturnTransaction.items.length;itemCount++){if($scope.orderReturnTransaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.orderReturnTransaction.transactionGuid,transactionNo:$scope.orderReturnTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false})};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.isTransactionCancelable=function(){if($scope.orderReturnTransaction.transactionType==TransactionConstants.TRANSACTION_ORDER_RETURN&&($scope.orderReturnTransaction.statusLabel==TransactionConstants.TRANSACTION_STATUS_OPEN||$scope.orderReturnTransaction.statusLabel==TransactionConstants.TRANSACTION_STATUS_IN_PROCESS)){return true}return false};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.initializeCheckbox=function(){if($scope.orderReturnTransaction.items.length==1){$scope.selectAll=true;angular.forEach($scope.orderReturnTransaction.items,function(productItem){productItem.NewProp_selected=true})}else{$scope.selectAll=false;angular.forEach($scope.orderReturnTransaction.items,function(productItem){productItem.NewProp_selected=false})}};$scope.getTransactionStatus=function(){if(angular.isUndefined($scope.orderReturnTransaction.cancelCodeReason)||$scope.orderReturnTransaction.cancelCodeReason==""){return $scope.orderReturnTransaction.statusLabel}else{return"Cancelled: "+MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_CANCELLATION_REASON],$scope.orderReturnTransaction.cancelCodeReason,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}};$scope.initializeOrderReturnScreen=function(){$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.orderReturnTransaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.orderReturnTransaction.items);$scope.isDocumentFlowShow=false;$scope.isOnlyHardGoodOrder=false;$scope.isHavingHardGoodItem=false;$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.orderReturnTransaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.orderReturnTransaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.transaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.transaction);$scope.isCanceleReturnBtnShow=$scope.isTransactionCancelable();$scope.orderReturnTransaction.reason.label=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],$scope.orderReturnTransaction.reason.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if($scope.orderReturnTransaction.paymentDetails&&$scope.orderReturnTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.orderReturnTransaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}$scope.storeId=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],$scope.orderReturnTransaction.customer.address.country.code,AppConstants.STORE_TYPE_COM,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,MetadataService.INDEX_NAMES.KEY);$scope.transactionStatus=$scope.getTransactionStatus();$scope.initializeCheckbox()};$scope.initializeOrderReturnScreen();$scope.$watch("orderReason.selectedId",function(){if($scope.orderReason.selectedId!=null&&$scope.orderReason.selectedId!=""){$scope.wizardStep=2}},true);$scope.$watch("cancelReason.selectedId",function(){if($scope.cancelReason.selectedId!=null&&$scope.cancelReason.selectedId!=""){$scope.isCancelReasonSelected=$scope.cancelReason.selectedId}else{$scope.isCancelReasonSelected=null}},true);$scope.backStep=function(step){$scope.wizardStep=step;if(step==1){$scope.orderReason.selectedId=""}$scope.transactionErrorMessage=""};$scope.checkProductsValid=function(){var result=false;var minItemSelected=false;var quantityValid=true;var totalItemSelected=0;angular.forEach($scope.orderReturnTransaction.items,function(productItem){if(productItem.NewProp_selected){minItemSelected=true;totalItemSelected++;$scope.selectAll=$scope.orderReturnTransaction.items.length==totalItemSelected?true:false}if(productItem.quantity>productItem.NotModify_quantity){productItem.quantity=productItem.NotModify_quantity}if(!angular.isNumber(productItem.quantity)){quantityValid=false}});if(!minItemSelected){$scope.transactionErrorMessage="Select at least one product item";$scope.selectAll=false}else{if(!quantityValid){$scope.transactionErrorMessage="Enter valid quantity/seat";$scope.selectAll=false}else{$scope.transactionErrorMessage="";result=true}}$("#selectedAllChk").prop("checked",$scope.selectAll);return result};$scope.selectAllItems=function($event){var selectedValue=$($event.target).is(":checked");angular.forEach($scope.orderReturnTransaction.items,function(productItem){if(selectedValue){productItem.NewProp_selected=true}else{productItem.NewProp_selected=false}});$scope.selectAll=selectedValue};$scope.checkItemSelection=function(selectedRowValue,$event){selectedRowValue.NewProp_selected=$($event.target).is(":checked")};$scope.isProductItemQtyEditable=function(productItem){if(productItem.NotModify_quantity==1||!productItem.NewProp_selected){return false}return true};$scope.reviewTransaction=function(){var orderReturnReview=angular.copy($scope.orderReturnTransaction);$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Review","Reviewing the order return items",false,false);orderReturnReview.returnInProgress=true;orderReturnReview.returnReasonCode=$scope.orderReason.selectedId;angular.forEach(orderReturnReview.items,function(productItem){if(productItem.NewProp_selected){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity}else{productItem.toReturn=false;productItem.quantityToReturn=0}});TransactionService.review(orderReturnReview).success(function(result){$("#transactionProgressModal").modal("hide");$scope.orderReturnReviewTransaction=result;$scope.orderReturnMessages=$scope.orderReturnReviewTransaction.messages;angular.forEach($scope.orderReturnReviewTransaction.items,function(productItem){productItem.NewProp_productImg=AppUtils.getProductThumbnailImage(productItem.productName);productItem.NotModify_listPrice=productItem.listPrice});$scope.wizardStep=3}).error(function(result){$("#transactionProgressModal").modal("hide");$scope.transactionErrorMessage="Transaction Review Failed, Try again";$scope.wizardStep=2})};$scope.createOrderReturn=function(){$scope.orderReturnReviewTransaction.returnInProgress=true;$scope.orderReturnReviewTransaction.reason.orderType=TransactionConstants.TRANSACTION_ORDER_RETURN;angular.forEach($scope.orderReturnReviewTransaction.items,function(productItem){productItem.toReturn=true;productItem.quantityToReturn=productItem.quantity});$("#transactionProgressModal").modal("show");$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Processing","Create Order Return Is In Progress",false,false);$scope.orderReturnReviewTransaction.paymentDetails=angular.copy($scope.transaction.paymentDetails);TransactionService.create($scope.orderReturnReviewTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed",result.messages,true,true)}else{var productSku=$scope.orderReturnReviewTransaction.items[0].sku;var returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.orderReturnReviewTransaction.customer.customerNo+"&tempId="+AppConstants.TEMPLATE_RETURN_ORDER+"&productSku="+productSku+"&storeId="+$scope.storeId+"&orderNumber="+result.transactionNumber;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl);$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Confirmation",result.messages,true,true);$scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Transaction Failed","Create Order Return Transaction Failed",true,true)})};$scope.cancelReturnOrder=function(){$scope.cancelReturnOrderServiceLoading=true;TransactionService.cancelReturn({guid:$scope.orderReturnTransaction.transactionGuid,cancelReasonCode:$scope.cancelReason.selectedId}).success(function(result){$scope.cancelReturnOrderServiceMessage="The Cancel Return Transaction Completed Successfully";$scope.cancelReturnOrderLoading=$scope.cancelReturnOrderServiceLoading=false}).error(function(result){$scope.cancelReturnOrderServiceMessage="The Cancel Return Transaction Failed";$scope.cancelReturnOrderLoading=$scope.cancelReturnOrderServiceLoading=false})};$scope.showCancelReturnOrder=function(){$scope.cancelReturnOrderLoading=true;TransactionService.lockTransaction({guid:$scope.orderReturnTransaction.transactionGuid}).success(function(lockResult){$("#cancelReturnOrderModal").modal("show")}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Transaction Lock Is Failing, Try Again"))})};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show")};$scope.closeCancelReturnOrderModal=function(){$("#cancelReturnOrderModal").modal("hide")};$scope.refreshOrderReturn=function(){location.reload()}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("OrderUtils",["$rootScope","TransactionConstants",function($rootScope,TransactionConstants){this.isOnlyHardGoodOrder=function(cartItems){if(cartItems){for(var count=0;cartItems.length>count;count++){if(cartItems[count].productType!=TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return false}}return true}return false};this.isOnlyEsdOrder=function(cartItems){if(cartItems){for(var count=0;cartItems.length>count;count++){if(cartItems[count].productType!=TransactionConstants.ESD_PRODUCT_TYPE){return false}}return true}return false};this.isOnlySubOrder=function(cartItems){if(cartItems){for(var count=0;cartItems.length>count;count++){if(cartItems[count].productType!=TransactionConstants.SUB_PRODUCT_TYPE){return false}}return true}return false};this.isHavingHardGoodItem=function(cartItems){if(cartItems){for(var count=0;cartItems.length>count;count++){if(cartItems[count].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}return false}return false};this.hasOnlyWiredItems=function(cartItems){if(cartItems){for(var itemCount=0;itemCount<cartItems.length;itemCount++){if(TransactionConstants.WIRED_PRODUCTS.indexOf(cartItems[itemCount].productType)<0){return true}}return false}return false};this.isCcmTeam=function(cartItems){if(cartItems){for(var cartCount=0;cartCount<cartItems.length;cartCount++){if(angular.uppercase(cartItems[cartCount].productType)==TransactionConstants.CCM_TEAM_PRODUCT_TYPE||angular.uppercase(cartItems[cartCount].productName)==TransactionConstants.CCM_TEAM_PRODUCT_NAME){return true}}return false}return false};this.isSubscriptionOrder=function(transaction){if(transaction){return transaction.transactionType==TransactionConstants.SUBSCRIPTION_TRANSACTION_TYPE}return false};this.getTrackingInformationList=function(cartItems){var trackingInfoList=[];if(cartItems){angular.forEach(cartItems,function(cartItem){trackingInfoList=trackingInfoList.concat(cartItem.trackingDetails)})}return trackingInfoList};this.isCcmTeamProductType=function(productType){if(productType){return angular.uppercase(productType)==TransactionConstants.CCM_TEAM_PRODUCT_TYPE}return false};this.isCcmTeamProductName=function(productName){if(productName){return angular.uppercase(productName)==TransactionConstants.CCM_TEAM_PRODUCT_NAME}return false};this.isTransactionComplete=function(transactionStatus){if(transactionStatus==TransactionConstants.TRANSACTION_STATUS_COMPLETED){return true}return false};this.isTransactionReleased=function(transactionStatus){if(transactionStatus==TransactionConstants.TRANSACTION_STATUS_RELEASED){return true}return false};this.isTransactionOpen=function(transactionStatus){if(transactionStatus==TransactionConstants.TRANSACTION_STATUS_OPEN){return true}return false};this.isCCTProduct=function(productType){return productType.substring(0,3)==TransactionConstants.CCT_TEAM_PRODUCT_TYPE};this.removePaymentTypeFromColl=function(paymentsMetadata,filterPaymentType){var paymentMethodsColl=[];if(paymentsMetadata&&paymentsMetadata.paymentMethods){paymentMethodsColl=paymentsMetadata.paymentMethods;angular.forEach(paymentMethodsColl,function(paymentMethod,index){if(paymentMethod.code==filterPaymentType){paymentMethodsColl.splice(index,1)}});paymentsMetadata.paymentMethods=paymentMethodsColl;return paymentsMetadata}};this.isPuf=function(items){if(items){for(var cartCount=0;cartCount<items.length;cartCount++){if(items[cartCount].ispuf=="true"){return true}}return false}return false}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("PayerDetailController",["$scope","$log","$rootScope","$location","$routeParams","$filter","StoreConstants","StoreUtil","PayerService","MetadataService","AppUtils",function($scope,$log,$rootScope,$location,$routeParams,$filter,StoreConstants,StoreUtil,PayerService,MetadataService,AppUtils){$scope.selectedCustomerDetailOnPayer;var payerSearchDto=function(){return{customerId:"",orgName:"",countryCode:"US",customerType:2,payerSearch:"X",state:"",city:"",zip:"",address:""}};var defaultAddressDto=function(){return{partnerNo:"",name:"",phone:"",email:"",department:"",company:"",country:defaultCountryDto(),street1:"",street2:"",street3:"",city:"",state:"",stateName:"",postCode:"",addressType:"",poBox:"",addressNo:""}};var defaultCountryDto=function(){return{code:"US",name:"United States",drSiteId:"",drLocale:"",drThemeId:""}};var defaultPayerDto=function(){return{customerNo:"",relCustomerNo:"",bpType:"2",companyName:"",jobTitle:"",department:"",telephone:"",telephoneExt:"",fax:"",faxExt:"",mobileNo:"",mobileExt:"",payer:"X",address:defaultAddressDto()}};$scope.payerMetaStatesByCountry=[];$scope.$on(StoreConstants.STORE_SELECT_CUSTOMER_EVENT,function(event,customerData){$scope.selectedCustomerDetailOnPayer=customerData;$scope.newPayerDetails.address.country.code=customerData.address.country.code;$scope.newPayerDetails.address.country.name=customerData.address.country.name;$scope.searchPayerDto.countryCode=customerData.address.country.code;$scope.searchPayerDto.countryName=customerData.address.country.name;$scope.payerMetaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION)});$scope.payerSearchAddress=defaultAddressDto();$scope.searchPayerDto=payerSearchDto();$scope.isPayerSearchLoading=false;$scope.payerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[];$scope.payerSearchMessages=[];$scope.isUsePayerAddressBtnEnable=true;$scope.proposedFinalAddress;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isEnteredPayerAddressValid=true;$scope.isSuggestedPayerAddressValid=true;$scope.temporaryState="";$scope.proposedTempState="";$scope.newlyCreatedPayerDto;$scope.payerAddress=defaultAddressDto();$scope.newPayerDetails=defaultPayerDto();$scope.searchPayer=function(){if($scope.selectedCustomerDetailOnPayer){$scope.searchPayerDto.countryCode=$scope.selectedCustomerDetailOnPayer.address.country.code;$scope.searchPayerDto.countryName=$scope.selectedCustomerDetailOnPayer.address.country.name}$scope.isPayerSearchLoading=true;$scope.payerSearchMessages=[];$scope.searchPayerDto.address=$scope.payerSearchAddress.street1+$scope.payerSearchAddress.street2+$scope.payerSearchAddress.street3;PayerService.searchPayer($scope.searchPayerDto).success(function(result){$scope.isPayerSearchLoading=false;$scope.payerSearchResults=result.customerSearchResults;$scope.payerSearchMessages=result.messages}).error(function(error){$scope.isPayerSearchLoading=false})};$scope.selectPayer=function(payer){var payerDetail=$scope.convertSearchPayerToPayerDto(payer);$scope.storeOrderReviewTransaction.payerAddress=payerDetail;$scope.$parent.updatePayerDetail(payerDetail);$scope.$parent.goNextFromPayer()};$scope.convertSearchPayerToPayerDto=function(payer){var payerDto=payer.address;payerDto.partnerNo=payer.customerNo;payerDto.company=payer.name;payerDto.name=payer.name;payerDto.phone=payer.telephone;return payerDto};$scope.showNewPayerDetail=function(){$scope.isCreateNewPayerFlowEnable=true;$scope.newPayerDetails=defaultPayerDto();if($scope.selectedCustomerDetailOnPayer){$scope.newPayerDetails.address.country.code=$scope.selectedCustomerDetailOnPayer.address.country.code;$scope.newPayerDetails.address.country.name=$scope.selectedCustomerDetailOnPayer.address.country.name}$scope.metaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION)};$scope.cancelPayerCreation=function(){$scope.isCreateNewPayerFlowEnable=false};$scope.modifyPayerDetail=function(){$scope.isPayerAddressValidationInProgress=false;$scope.isCreateNewPayerFlowEnable=true};$scope.validatePayerAddress=function(){if($scope.newPayerDetails.address.country.code=="JP"){var postalCode=$scope.newPayerDetails.address.postCode;$scope.messages=AppUtils.validatePostalCode(postalCode);if($scope.messages.length>0){return}}$scope.proposedTempState="";angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if($scope.newPayerDetails.address.state==stateItem.id){$scope.temporaryState=stateItem.description}});$scope.showViewLoading();$scope.validateCorrectStreetOption();PayerService.validatePayerAddress($scope.newPayerDetails.address).success(function(result){$scope.hideViewLoading();if(result.finalProposal){result.finalProposal.country=$scope.newPayerDetails.address.country;if(!result.finalProposal.stateName){angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}}$scope.proposedFinalAddress=result.finalProposal;$scope.proposedTempState=$scope.proposedFinalAddress.state;$scope.isEnteredPayerAddressValid=true;$scope.isSuggestedPayerAddressValid=true;if($scope.newPayerDetails.address.country.code=="JP"){$scope.proposedFinalAddress=$scope.newPayerDetails.address}if(result.dsStatus&&result.enteredTaxAddrStatus&&result.suggestedTaxAddrStatus){if(result.dsStatus=="E"&&result.enteredTaxAddrStatus=="E"){$scope.isEnteredPayerAddressValid=false}if(result.suggestedTaxAddrStatus=="E"){$scope.isSuggestedPayerAddressValid=false}}if(result.message!=null){$scope.adddressValidationMessages=[];$scope.adddressValidationMessages.push(result.message)}$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=true}).error(function(error){$scope.hideViewLoading();$scope.isPayerAddressValidationInProgress=false})};$scope.handleValidateOwnPayerAddress=function(){$scope.createNewPayer()};$scope.handleValidateNewPayerAddress=function(){$scope.replaceCorrectStreetNo();$scope.newPayerDetails.address=$scope.proposedFinalAddress;$scope.createNewPayer()};$scope.createNewPayer=function(){$scope.payerAddressValidationInProgress=false;$scope.newlyCreatedPayerDto="";$scope.isPayerAddressValidationInProgress=true;$scope.showViewLoading();PayerService.createPayer($scope.newPayerDetails).success(function(result){$scope.hideViewLoading();$scope.isPayerCreated=true;$scope.newlyCreatedPayerDto=result;$scope.payerCreationMessages=result.messages}).error(function(error){$scope.hideViewLoading()})};$scope.applyCreatedPayer=function(){$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[];$scope.storeOrderReviewTransaction.payerAddress=$scope.newlyCreatedPayerDto;$scope.newlyCreatedPayerDto.name=$scope.newlyCreatedPayerDto.companyName;$scope.$parent.updatePayerDetail($scope.convertSearchPayerToPayerDto($scope.newlyCreatedPayerDto));$scope.$parent.goNextFromPayer()};$scope.gotoPayerSearchScreen=function(){$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[]};$scope.isPayerDetailValid=function(){var result;result=$scope.newPayerDetails.companyName!=""&&$scope.newPayerDetails.address.street1!=""&&$scope.newPayerDetails.address.city!=""&&$scope.newPayerDetails.address.postCode!=""&&$scope.newPayerDetails.address.state!=""&&$scope.newPayerDetails.address.country.code!="";return result};$scope.isValidPayer=function(){return $scope.searchPayerDto.customerId||$scope.searchPayerDto.orgName};$scope.isCorrectStreetOptionVisible=false;$scope.validateCorrectStreetOption=function(){$scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber($scope.customerDetails.address)};$scope.correctStreetNo="";$scope.updateCorrectStreetNo=function(correctStreetNo){$scope.correctStreetNo=correctStreetNo};$scope.replaceCorrectStreetNo=function(){if($scope.correctStreetNo&&$scope.correctStreetNo!=""){$scope.proposedFinalAddress=AppUtils.getReplacedStreet1Address($scope.correctStreetNo,$scope.proposedFinalAddress)}$scope.correctStreetNo=""}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSelectPayer",["$log","$rootScope","$location","$routeParams","$filter","StoreConstants","StoreUtil","PayerService","MetadataService","AppUtils","$app","SalesConstants",function($log,$rootScope,$location,$routeParams,$filter,StoreConstants,StoreUtil,PayerService,MetadataService,AppUtils,$app,SalesConstants){return{restrict:"EA",scope:{metadata:"=",orderServiceDto:"="},replace:true,templateUrl:"js/sales/partials/search-payer.html",link:function($scope,element,attrs){var payerSearchDto=function(){return{customerId:"",orgName:"",countryCode:"US",customerType:2,payerSearch:"X",state:"",city:"",zip:"",address:""}};var defaultAddressDto=function(){return{partnerNo:"",name:"",phone:"",email:"",department:"",company:"",country:defaultCountryDto(),street1:"",street2:"",street3:"",city:"",state:"",stateName:"",postCode:"",addressType:"",poBox:"",addressNo:""}};var defaultCountryDto=function(){return{code:"US",name:"United States",drSiteId:"",drLocale:"",drThemeId:""}};var defaultPayerDto=function(){return{customerNo:"",relCustomerNo:"",bpType:"2",companyName:"",jobTitle:"",department:"",telephone:"",telephoneExt:"",fax:"",faxExt:"",mobileNo:"",mobileExt:"",payer:"X",address:defaultAddressDto()}};$scope.payerMetaStatesByCountry=[];$scope.updatePayerInfo=function(){$scope.newPayerDetails.address.country.code=$scope.orderDto.country;$scope.newPayerDetails.address.country.name=$scope.orderDto.country;$scope.searchPayerDto.countryCode=$scope.orderDto.country;$scope.searchPayerDto.countryName=$scope.orderDto.country;$scope.payerMetaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION)};$scope.payerSearchAddress=defaultAddressDto();$scope.searchPayerDto=payerSearchDto();$scope.isPayerSearchLoading=false;$scope.payerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[];$scope.payerSearchMessages=[];$scope.isUsePayerAddressBtnEnable=true;$scope.proposedFinalAddress;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isEnteredPayerAddressValid=true;$scope.isSuggestedPayerAddressValid=true;$scope.temporaryState="";$scope.proposedTempState="";$scope.newlyCreatedPayerDto;$scope.payerAddress=defaultAddressDto();$scope.newPayerDetails=defaultPayerDto();$scope.openSearchPayer=function(){$scope.isCreateNewPayerFlowEnable=$scope.isPayerAddressValidationInProgress=false;$("#searchPayerModal").modal("show");$scope.orderDto=angular.copy($scope.orderServiceDto);$scope.updatePayerInfo()};$scope.closeSearchPayer=function(){$("#searchPayerModal").modal("hide")};$scope.searchPayer=function(){$scope.searchPayerDto.countryCode=$scope.orderDto.country;$scope.searchPayerDto.countryName=$scope.orderDto.country;$scope.isPayerSearchLoading=true;$scope.payerSearchMessages=[];$scope.searchPayerDto.address=$scope.payerSearchAddress.street1+$scope.payerSearchAddress.street2+$scope.payerSearchAddress.street3;PayerService.searchPayer($scope.searchPayerDto).success(function(result){$scope.isPayerSearchLoading=false;$scope.payerSearchResults=result.customerSearchResults;$scope.payerSearchMessages=result.messages}).error(function(error){$scope.isPayerSearchLoading=false})};$scope.selectPayer=function(payer){var payerDetail=$scope.convertSearchPayerToPayerDto(payer);$rootScope.$broadcast(SalesConstants.SALES_PAYER_SELECT_EVENT,payerDetail);$scope.closeSearchPayer()};$scope.convertSearchPayerToPayerDto=function(payer){var payerDto=payer.address;payerDto.partnerNo=payer.customerNo;payerDto.company=payer.name;payerDto.name=payer.name;payerDto.phone=payer.telephone;return payerDto};$scope.showNewPayerDetail=function(){$scope.isCreateNewPayerFlowEnable=true;$scope.newPayerDetails=defaultPayerDto();$scope.newPayerDetails.address.country.code=$scope.orderDto.country;$scope.newPayerDetails.address.country.name=$scope.orderDto.country;$scope.metaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION)};$scope.cancelPayerCreation=function(){$scope.isCreateNewPayerFlowEnable=false};$scope.modifyPayerDetail=function(){$scope.isPayerAddressValidationInProgress=false;$scope.isCreateNewPayerFlowEnable=true};$scope.validatePayerAddress=function(){if($scope.newPayerDetails.address.country.code=="JP"){var postalCode=$scope.newPayerDetails.address.postCode;$scope.messages=AppUtils.validatePostalCode(postalCode);if($scope.messages.length>0){return}}$scope.proposedTempState="";angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if($scope.newPayerDetails.address.state==stateItem.id){$scope.temporaryState=stateItem.description}});$scope.validateCorrectStreetOption();PayerService.validatePayerAddress($scope.newPayerDetails.address).success(function(result){$app.hideLoading();if(result.finalProposal){result.finalProposal.country=$scope.newPayerDetails.address.country;if(!result.finalProposal.stateName){angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}}$scope.proposedFinalAddress=result.finalProposal;$scope.proposedTempState=$scope.proposedFinalAddress.state;$scope.isEnteredPayerAddressValid=true;$scope.isSuggestedPayerAddressValid=true;if($scope.newPayerDetails.address.country.code=="JP"){$scope.proposedFinalAddress=$scope.newPayerDetails.address}if(result.dsStatus&&result.enteredTaxAddrStatus&&result.suggestedTaxAddrStatus){if(result.dsStatus=="E"&&result.enteredTaxAddrStatus=="E"){$scope.isEnteredPayerAddressValid=false}if(result.suggestedTaxAddrStatus=="E"){$scope.isSuggestedPayerAddressValid=false}}if(result.message!=null){$scope.adddressValidationMessages=[];$scope.adddressValidationMessages.push(result.message)}$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=true}).error(function(error){$app.hideLoading();$scope.isPayerAddressValidationInProgress=false})};$scope.handleValidateOwnPayerAddress=function(){$scope.createNewPayer()};$scope.handleValidateNewPayerAddress=function(){$scope.replaceCorrectStreetNo();$scope.newPayerDetails.address=$scope.proposedFinalAddress;$scope.createNewPayer()};$scope.createNewPayer=function(){$scope.payerAddressValidationInProgress=false;$scope.newlyCreatedPayerDto="";$scope.isPayerAddressValidationInProgress=true;$app.showLoading();PayerService.createPayer($scope.newPayerDetails).success(function(result){$app.hideLoading();$scope.isPayerCreated=true;$scope.newlyCreatedPayerDto=result;$scope.payerCreationMessages=result.messages}).error(function(error){$app.hideLoading()})};$scope.applyCreatedPayer=function(){$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[];$scope.newlyCreatedPayerDto.name=$scope.newlyCreatedPayerDto.companyName;$rootScope.$broadcast(SalesConstants.SALES_PAYER_SELECT_EVENT,$scope.convertSearchPayerToPayerDto($scope.newlyCreatedPayerDto));$scope.closeSearchPayer()};$scope.gotoPayerSearchScreen=function(){$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.isPayerCreated=false;$scope.isCreateNewPayerFlowEnable=false;$scope.isPayerAddressValidationInProgress=false;$scope.adddressValidationMessages=[];$scope.payerCreationMessages=[]};$scope.isPayerDetailValid=function(){var result;result=$scope.newPayerDetails.companyName!=""&&$scope.newPayerDetails.address.street1!=""&&$scope.newPayerDetails.address.city!=""&&$scope.newPayerDetails.address.postCode!=""&&$scope.newPayerDetails.address.state!=""&&$scope.newPayerDetails.address.country.code!="";return result};$scope.isValidPayer=function(){return $scope.searchPayerDto.customerId||$scope.searchPayerDto.orgName};$scope.isCorrectStreetOptionVisible=false;$scope.validateCorrectStreetOption=function(){};$scope.correctStreetNo="";$scope.updateCorrectStreetNo=function(correctStreetNo){$scope.correctStreetNo=correctStreetNo};$scope.replaceCorrectStreetNo=function(){if($scope.correctStreetNo&&$scope.correctStreetNo!=""){$scope.proposedFinalAddress=AppUtils.getReplacedStreet1Address($scope.correctStreetNo,$scope.proposedFinalAddress)}$scope.correctStreetNo=""}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("PayerService",["$http",function($http){var transform=function(data){return $.customParam(data)};var service={};service.searchPayer=function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.createPayer=function(data){return $http({method:"POST",url:"../customerRecordService/createItem.do",data:data})};service.validatePayerAddress=function(data){return $http({method:"POST",url:"../addressValidationService/validatePo.do",data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("PaymentConstants",{CREDIT_CARD_PAYMENT_TYPE:2,DEBIT_CARD_PAYMENT_TYPE:3,CVS_PAYMENT_TYPE:4,BANK_TRANSFER_PAYMENT_TYPE:5,DIRECT_DEBIT_PAYMENT_TYPE:6,PAYPAL_PAYMENT_TYPE:8,IBAN_PAYMENT_TYPE:999,DUMMY_CARD:99,PO_PAYMENT_TYPE:9,PO_MINIMUM_SEAT:1,CREDIT_CARD_ON_FILE_PAYMENT_TYPE:"CC_ON_FILE",CREDIT_CARD_PAYMENT_LABEL:"Credit Card",DEBIT_CARD_PAYMENT_LABEL:"Debit Card",CVS_PAYMENT_LABEL:"CVS",BANK_TRANSFER_PAYMENT_LABEL:"Bank Transfer",PAYPAL_PAYMENT_LABEL:"Paypal",IBAN_PAYMENT_LABEL:"IBAN",PO_PAYMENT_LABEL:"PO Number",PO_PAYMENT_DISPLAY_LABEL:"Purchase Order",DUMMY_CARD_LABEL:"Dummy Card",DIRECT_DEBIT_PAYMENT_LABEL:"Direct Debit",VALID_TOKEN_LENGTH:16,AMERICAN_EXPRESS_TYPE:"AMEX",VISA_TYPE:"VISA",MASTER_CARD_TYPE:"MC",SWITCH_TYPE:"SWCH",SOLO_TYPE:"SOLO",JCB_TYPE:"JCB",DYLAN_MASTER_CARD_TYPE:"MASTER CARD",TOKENIZER_MASTER_CARD_TYPE:"MASTER CARD",PAYMENT_MONTHS:[{code:"01",label:"01"},{code:"02",label:"02"},{code:"03",label:"03"},{code:"04",label:"04"},{code:"05",label:"05"},{code:"06",label:"06"},{code:"07",label:"07"},{code:"08",label:"08"},{code:"09",label:"09"},{code:"10",label:"10"},{code:"11",label:"11"},{code:"12",label:"12"}],PAYMENT_VIEW_TEMPLATE:"js/transaction/payment/partials/payment-details-view.html",PAYMENT_EDIT_TEMPLATE:"js/transaction/payment/partials/payment-details-edit.html",BT_PAYMENT_CONTROL_CODES:[{code:"TO",label:"TO"},{code:"FU",label:"FU"},{code:"TI",label:"TI"},{code:"FO",label:"FO"}],BT_ORDER_VALUE_VALIDATION:9000000,JP_DISABLE_BT_PAYMENT_FOR_CCT_PUF:false,TEAM_CONTRACT_DISABLE_STATUS:"MIGRATING",PAYMENT_COMMERCE_CRM_MAPPING:[{commercePaymentType:"CREDIT_CARD",crmCode:2},{commercePaymentType:"DIRECT_DEBIT",crmCode:6},{commercePaymentType:"PAYPAL",crmCode:8},{commercePaymentType:"BANK_TRANSFER",crmCode:5},{commercePaymentType:"CVS",crmCode:4}]});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("PaymentController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","PaymentService","$filter","features","StoreConstants",function($scope,$log,$rootScope,$location,$routeParams,$timeout,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,PaymentService,$filter,features,StoreConstants){TrackingService.trackPageView("Transaction","Payment View");$scope.paymentTransaction=angular.copy($scope.transaction);$scope.PaymentConstants=PaymentConstants;$scope.TransactionConstants=TransactionConstants;$scope.isTokenReceived=false;$scope.paymentDetails=$scope.paymentTransaction.paymentDetails;$scope.paymentTemplateUrl=PaymentConstants.PAYMENT_VIEW_TEMPLATE;$scope.isUpdatePaymentDisabled=true;$scope.paymentErrorMessage="";$scope.isResetPaymentBtnShow=false;$scope.isPaymentTokenizerShow=$rootScope.currentUser.external;$scope.paymentYears=[];$scope.isPaymentTypeNotMatch=true;$scope.tokenCardTypeName="";$scope.isResetPaymentDisabled=false;$scope.resetPaymentMessage="Payment switch is enable only during renewal window.";$timeout(function(){$(window).on("message",function(event){var eventData;eventData=$.parseJSON(event.originalEvent.data);switch(eventData.type){case"tokenReceived":$scope.populateCreditCard(eventData.value);break;case"tokenLoaded":$("#tokenizer-iframe")[0].contentWindow.postMessage($scope.orderTransaction,window.location.origin);break;case"reset":$scope.resetPaymentView();break;case"tokenError":TrackingService.trackPageView("System","Token Failed: "+$scope.paymentTransaction.customer.address.country.code);AppUtils.sendLogToServer("Payment Token Error : Country - "+$scope.paymentTransaction.customer.address.country.code+", Customer Name - "+$scope.paymentTransaction.customer.firstName+" "+$scope.paymentTransaction.customer.lastName+", Email - "+$scope.paymentTransaction.customer.email+", Customer Number - "+$scope.paymentTransaction.customer.customerNo);break;case"reload":document.getElementById("tokenizer-iframe").src+="";break}})},20);$scope.populateCreditCard=function(tokenData){TrackingService.trackPageView("Transaction","Token Generated");$scope.isPaymentTypeNotMatch=true;$scope.paymentDetails.expiryDate=tokenData.payment_instrument.credit_card_expiry_date_display;var expiryDateContent=$scope.paymentDetails.expiryDate.split("/");if(!$scope.metadata.paymentMetadata){$scope.metadata.paymentMetadata=$scope.getPaymentMetadata()}for(var count=0;count<$scope.metadata.paymentMetadata.creditCardTypes.length;count++){if(($scope.metadata.paymentMetadata.creditCardTypes[count].code==tokenData.payment_instrument.payment_type)||(tokenData.payment_instrument.payment_type==PaymentConstants.TOKENIZER_MASTER_CARD_TYPE)){$scope.paymentDetails.cardType=tokenData.payment_instrument.payment_type==PaymentConstants.TOKENIZER_MASTER_CARD_TYPE?PaymentConstants.MASTER_CARD_TYPE:tokenData.payment_instrument.payment_type;$scope.paymentDetails.cardNumber=tokenData.token_id;$scope.paymentDetails.expiryMonth=expiryDateContent[0];$scope.paymentDetails.expiryYear=expiryDateContent[1];$scope.isPaymentTypeNotMatch=false;break}}$scope.tokenCardTypeName=tokenData.payment_instrument.payment_type;$scope.paymentDetails.expirationDate=tokenData.payment_instrument.credit_card_expire_date;$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_PAYMENT_TYPE;$scope.$apply(function(){$scope.isTokenReceived=true})};$scope.resetPaymentView=function(){$scope.$apply(function(){$scope.isTokenReceived=false})};$scope.resetCreditCardOnFileSelection=function(){angular.forEach($scope.paymentMetadata.paymentInstruments,function(paymentInstrument){paymentInstrument.isSelected=false})};$scope.enableCreditCardPaymentOnFile=function(){$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_ON_FILE_PAYMENT_TYPE;$scope.resetCreditCardOnFileSelection()};$scope.updatePaymentFromFile=function(paymentObject){var paymentOnFile=new Object();paymentOnFile.paymentType=paymentObject.zzpaymentmethod;paymentOnFile.cardType=paymentObject.cctype;paymentOnFile.cardNumber=paymentObject.ccnum;paymentOnFile.cardHolder=paymentObject.accountHolder;paymentOnFile.expiryMonth=paymentObject.cardExpiration.split("/")[0];paymentOnFile.expiryYear=paymentObject.cardExpiration.split("/")[1];paymentOnFile.expirationDate=new Date(Number(paymentOnFile.expiryYear),Number(paymentOnFile.expiryMonth-1),15);paymentOnFile.expiryDate=paymentOnFile.expirationDate;if($scope.paymentTransaction){$scope.paymentTransaction.paymentDetails=paymentOnFile}$scope.resetCreditCardOnFileSelection();paymentObject.isSelected=true;$scope.paymentErrorMessage="";$scope.$emit(TransactionConstants.TRANSACTION_PAYMENT_UPDATE_EVENT,true,paymentOnFile)};$scope.enableEditPayment=function(){TrackingService.trackPageView("Transaction","Payment Edit View");$scope.paymentTemplateUrl=PaymentConstants.PAYMENT_EDIT_TEMPLATE;$scope.paymentDetails.paymentEditable=true;$scope.isTokenReceived=!$scope.isPaymentTokenizerShow;$scope.$emit(TransactionConstants.TRANSACTION_PAYMENT_RESET_EVENT);$scope.paymentDetails={};$scope.paymentDetails.cardHolder=$scope.paymentTransaction.billingAddress.name;$scope.$parent.paymentType=$scope.paymentDetails.paymentType=$scope.defaultPaymentMethodCode;$scope.$parent.isTnCAccepted=false;$scope.$emit(TransactionConstants.TRANSACTION_PAYMENT_UPDATE_EVENT,$scope.paymentTransaction,angular.copy($scope.paymentDetails))};$scope.retriggerPayment=function(){TrackingService.trackPageView("Transaction","Retrigger Payment");$("#paymentRetriggerModal").modal("show");PaymentService.retriggerPayment({transactionNumber:$scope.transaction.transactionNumber,customerNo:$scope.transaction.customer.customerNo,transactionGuid:$scope.transaction.transactionGuid}).success(function(result){if(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,result)}else{$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_INFO_TYPE,"The Retrigger Payment Successfully Completed"))}$scope.closePaymentRetriggerModal()}).error(function(result){$scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Retrigger Payment Transaction Failed"));$scope.closePaymentRetriggerModal()})};$scope.closePaymentRetriggerModal=function(){$("#paymentRetriggerModal").modal("hide")};$scope.validateDirectDebitAccount=function(){$scope.paymentDetails.isIbanValid=false;PaymentService.validateIBANDetail({ibanDetail:$scope.paymentDetails.ibaNumber}).success(function(result){if(AppUtils.isHavingErrorMessage(result)){$scope.ibanValidateMessage=AppUtils.getErrorMessage(result);$scope.paymentDetails.isIbanValid=false}else{$scope.ibanValidateMessage=AppUtils.getSuccessMessage(result);$scope.paymentDetails.isIbanValid=true;$scope.paymentDetails.verifiedIbaNumber=$scope.paymentDetails.ibaNumber}$scope.isIbanMesageShow=true}).error(function(result){$scope.ibanValidateMessage="Not able to validate"})};$scope.cancelPayment=function(){$scope.paymentTemplateUrl=PaymentConstants.PAYMENT_VIEW_TEMPLATE;$scope.isTokenReceived=false;$scope.resetPaymentForms();$scope.$emit(TransactionConstants.TRANSACTION_CANCEL_PAYMENT_UPDATE_EVENT)};$scope.$watch("paymentDetails",function(){$scope.isPaymentFormValid()},true);$scope.resetPaymentForm=function(paymentTypeObject){$scope.paymentDetails.paymentType=paymentTypeObject.code;$scope.$parent.paymentType=$scope.paymentDetails.paymentType};$scope.isPaymentFormValid=function(){var result=false;if($scope.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){result=$scope.validateCreditCardForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_ON_FILE_PAYMENT_TYPE){result=$scope.validateCreditCardOnFileForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){result=$scope.validateDirectDebitForm();$scope.paymentDetails.bankCountry="DE"}else{if($scope.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){result=$scope.validatePoForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result=true;$scope.paymentErrorMessage=""}else{if($scope.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){result=$scope.validateCVSPaymentForm()}else{$scope.paymentErrorMessage="Please enter the required fields"}}}}}}$scope.$emit(TransactionConstants.TRANSACTION_PAYMENT_UPDATE_EVENT,result,angular.copy($scope.paymentDetails))};$scope.validatePoForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.poNumber)||$scope.paymentDetails.poNumber==""){$scope.paymentErrorMessage="PO Number is Required"}else{$scope.paymentErrorMessage="";result=true}return result};$scope.validateCreditCardForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.cardType)||$scope.paymentDetails.cardType==""){$scope.paymentErrorMessage="Card Type Is Required";if($scope.isTokenReceived&&$scope.isPaymentTypeNotMatch&&$scope.tokenCardTypeName!=0){$scope.paymentErrorMessage="The Payment Card Type "+$scope.tokenCardTypeName+"' Is Not Supported For This Country";$scope.isTokenReceived=false}}else{if(!angular.isDefined($scope.paymentDetails.cardNumber)||$scope.paymentDetails.cardNumber==""){$scope.paymentErrorMessage="Token Number Is Required"}else{if(isNaN($scope.paymentDetails.cardNumber)){$scope.paymentErrorMessage="Invalid Characters In Token Number. (Enter Numbers Only.)"}else{if($scope.paymentDetails.cardNumber.toString().length!=PaymentConstants.VALID_TOKEN_LENGTH){$scope.paymentErrorMessage="The Token Number Length Is Invalid"}else{if(!$scope.validateTokenNumber()){$scope.paymentErrorMessage="The Token Number Is Invalid"}else{if(!angular.isDefined($scope.paymentDetails.expiryMonth)||$scope.paymentDetails.expiryMonth==""){$scope.paymentErrorMessage="Expiry Month Is Required"}else{if($scope.paymentDetails.expiryMonth.toString().length>2||isNaN($scope.paymentDetails.expiryMonth)){$scope.paymentErrorMessage="Expiry Month Is Not Valid"}else{if(!angular.isDefined($scope.paymentDetails.expiryYear)||$scope.paymentDetails.expiryYear==""){$scope.paymentErrorMessage="Expiry Year Is Required"}else{if($scope.paymentDetails.expiryYear.toString().length!=4||isNaN($scope.paymentDetails.expiryYear)){$scope.paymentErrorMessage="Expiry Year Is Not Valid"}else{if(!angular.isDefined($scope.paymentDetails.cardHolder)||$scope.paymentDetails.cardHolder==""){$scope.paymentErrorMessage="Cardholder's Name Is Required"}else{$scope.paymentErrorMessage="";result=true}}}}}}}}}}if(!$scope.isPaymentTokenizerShow){$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_PAYMENT_TYPE}if($scope.paymentDetails.expiryYear&&$scope.paymentDetails.expiryMonth){$scope.paymentDetails.expirationDate=new Date(Number($scope.paymentDetails.expiryYear),Number($scope.paymentDetails.expiryMonth),1)}return result};$scope.validateCreditCardOnFileForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.cardType)||$scope.paymentDetails.cardType==""){$scope.paymentErrorMessage="Select One Of The Payment Information"}else{$scope.paymentErrorMessage="";result=true}return result};$scope.validatePOForm=function(){var result;if($scope.paymentDetails.poNumber==""||$scope.paymentDetails.poNumber==undefined){result=false}else{result=true}return result};$scope.validateBankTransferForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.bankKey)||$scope.paymentDetails.bankKey==null||$scope.paymentDetails.bankKey==""){$scope.paymentErrorMessage="Bank Key Is Required"}else{if(!angular.isDefined($scope.paymentDetails.bankName)||$scope.paymentDetails.bankName==null||$scope.paymentDetails.bankName==""){$scope.paymentErrorMessage="Bank Name Is Required"}else{if(!angular.isDefined($scope.paymentDetails.controlCode)||$scope.paymentDetails.controlCode==null||$scope.paymentDetails.controlCode==""){$scope.paymentErrorMessage="Control Code Is Required"}else{if(!angular.isDefined($scope.paymentDetails.bankAccount)||$scope.paymentDetails.bankAccount==null||$scope.paymentDetails.bankAccount==""){$scope.paymentErrorMessage="Bank Account Is Required"}else{if(!angular.isDefined($scope.paymentDetails.accountHolder)||$scope.paymentDetails.accountHolder==null||$scope.paymentDetails.accountHolder==""){$scope.paymentErrorMessage="Account Holder Is Required"}else{$scope.paymentErrorMessage="";result=true}}}}}return result};$scope.validateDirectDebitForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.ibaNumber)||$scope.paymentDetails.ibaNumber==""){$scope.paymentErrorMessage="IBAN Number Is Required"}else{if(!$scope.paymentDetails.isIbanValid||$scope.paymentDetails.verifiedIbaNumber!=$scope.paymentDetails.ibaNumber){$scope.paymentErrorMessage="Validation Of Account Is Required Or IBAN Is Incorrect";$scope.isIbanMesageShow=false}else{if((!angular.isDefined($scope.paymentDetails.mandateId)||$scope.paymentDetails.mandateId=="")&&features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Please select Sepa emandate"}else{if((!angular.isDefined($scope.paymentDetails.bankName)||$scope.paymentDetails.bankName=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Bank Name Is Required"}else{if((!angular.isDefined($scope.paymentDetails.city)||$scope.paymentDetails.city=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="City Is Required"}else{if(!angular.isDefined($scope.paymentDetails.accountHolder)||$scope.paymentDetails.accountHolder==""){$scope.paymentErrorMessage="Account Holder Is Required"}else{$scope.paymentErrorMessage="";$scope.isIbanMesageShow=true;result=true}}}}}}return result};$scope.validateTokenNumber=function(){var cardValue=$scope.paymentDetails.cardNumber;var validTokenCharactersAtFirstIndex="0129";if(validTokenCharactersAtFirstIndex.indexOf(cardValue.toString().charAt(0))<0){return false}if(/[^0-9-\s]+/.test(cardValue)){return false}var nCheck=0,nDigit=0,bEven=false;cardValue=cardValue.replace(/\D/g,"");for(var n=cardValue.length-1;n>=0;n--){var cDigit=cardValue.charAt(n),nDigit=parseInt(cDigit,10);if(bEven){if((nDigit*=2)>9){nDigit-=9}}nCheck+=nDigit;bEven=!bEven}return(nCheck%10)==0};$scope.resetPaymentForms=function(){if($scope.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.paymentDetails.cardType=$scope.paymentDetails.cardNumber=$scope.paymentDetails.expiryMonth=$scope.paymentDetails.expiryYear=$scope.paymentDetails.cardHolder=""}else{if($scope.paymentDetails.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){$scope.paymentDetails.ibaNumber=$scope.paymentDetails.bankName=$scope.paymentDetails.city=$scope.paymentDetails.accountHolder="";$scope.ibanValidateMessage="";$scope.isIbanMesageShow=false}else{if($scope.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){$scope.paymentDetails.ibaNumber=$scope.paymentDetails.bankKey=$scope.paymentDetails.bankName=$scope.paymentDetails.city=$scope.paymentDetails.accountHolder=$scope.paymentDetails.bankCountry=$scope.paymentDetails.bankAccount=$scope.paymentDetails.controlCode=""}else{if($scope.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){$scope.paymentDetails.poNumber=""}}}}};$scope.getPaymentMetadata=function(){var productItems=[];var isStock=false;var totalNumberOfCCMTeamPufSeat=0;angular.forEach($scope.paymentTransaction.items,function(productItem){productItems.push(productItem.productType)});if($scope.paymentTransaction&&$scope.paymentTransaction.items){for(var stockCount=0;stockCount<$scope.paymentTransaction.items.length;stockCount++){isStock=$scope.paymentTransaction.items[stockCount].stockSku;if(isStock){break}}}var paymentRequestMetadataDto={countryCode:$scope.paymentTransaction.customer.address.country.code,transactionType:$scope.paymentTransaction.transactionType,productTypes:productItems,paymentMethodCode:$scope.paymentTransaction.paymentDetails.paymentType,puf:OrderUtils.isPuf($scope.paymentTransaction.items),totalNumberOfCCMTeamPufSeat:totalNumberOfCCMTeamPufSeat,customerNo:$scope.paymentTransaction.customer.customerNo,stock:isStock,minSeatForPO:PaymentConstants.PO_MINIMUM_SEAT,renewalWindow:$scope.paymentTransaction.paymentDetails.inRenewableWindow};PaymentService.getPaymentMetadata(paymentRequestMetadataDto).success(function(result){$scope.paymentMetadata=$scope.metadata.paymentMetadata=result;if($scope.paymentTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){$scope.paymentMetadata=OrderUtils.removePaymentTypeFromColl($scope.paymentMetadata,PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE)}else{if($scope.paymentTransaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){$scope.paymentMetadata=OrderUtils.removePaymentTypeFromColl($scope.paymentMetadata,PaymentConstants.CVS_PAYMENT_TYPE)}}for(var count=0;count<$scope.paymentMetadata.paymentMethods.length;count++){$scope.defaultPaymentMethodCode=$scope.paymentMetadata.paymentMethods[0].code;if($scope.paymentTransaction.paymentDetails.paymentType==$scope.paymentMetadata.paymentMethods[count].code){$scope.defaultPaymentMethodCode=$scope.paymentMetadata.paymentMethods[count].code;break}}var paymentInstruments=[];if($scope.paymentMetadata.paymentInstruments&&$scope.paymentMetadata.paymentInstruments.length>0){angular.forEach($scope.paymentMetadata.paymentInstruments,function(paymentInstrument){if(!paymentInstruments.expired){paymentInstruments.push(paymentInstrument)}})}$scope.paymentMetadata.paymentInstruments=angular.copy(paymentInstruments);return result}).error(function(result){$scope.paymentMetadata=null})};$scope.initializePayment=function(){$scope.resetPaymentForms();$scope.isRetriggerPaymentBtnShow=$scope.paymentTransaction.paymentRetriggerAllowed;if($scope.transactionView==TransactionConstants.TRANSACTION_EDIT_BILLING_VIEW){if($scope.paymentTransaction.paymentDetails.paymentType!=PaymentConstants.PAYPAL_PAYMENT_TYPE){$scope.isResetPaymentBtnShow=true;$scope.isResetPaymentDisabled=false}if(($scope.paymentTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.paymentTransaction.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE)&&!$scope.paymentTransaction.paymentDetails.inRenewableWindow){$scope.isResetPaymentDisabled=true;$scope.resetPaymentMessage="Payment switch is enable only during renewal window. i.e. "+$filter("date")($scope.paymentTransaction.paymentDetails.renewalWindowStartDate,"dd MMM yyyy")+" to "+$filter("date")($scope.paymentTransaction.paymentDetails.renewalWindowEndDate,"dd MMM yyyy")}var currentYear=new Date().getFullYear();for(var yearCount=0;yearCount<11;yearCount++){var yearObject={code:currentYear,label:currentYear.toString()};$scope.paymentYears.push(yearObject);currentYear=currentYear+1}$scope.paymentDetails.cardHolder=$scope.paymentTransaction.billingAddress.name;$scope.getPaymentMetadata()}else{$scope.isResetPaymentBtnShow=false}};$scope.initializePayment();$scope.showRenewalInfo=function(){$('[data-renewal="renewalTooltip"]').tooltip("toggle")}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngCreditCardForm",["$rootScope","$timeout","PaymentConstants","TransactionConstants",function($rootScope,$timeout,PaymentConstants,TransactionConstants){return{restrict:"EA",scope:{paymentDetails:"=",cardTypeName:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/credit-card-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngCreditCardOnFile",["$rootScope","$timeout","PaymentConstants","TransactionConstants",function($rootScope,$timeout,PaymentConstants,TransactionConstants){return{restrict:"EA",scope:{paymentInstrument:"=",cardTypeName:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-credit-card-on-file.html",link:function(scope,element,attrs){}}}]);app.directive("ngDirectDebitForm",["$rootScope","features",function($rootScope,features){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/direct-debit-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngBankTransferForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/bank-transfer-form.html",link:function(scope,element,attrs){if(!scope.viewType){scope.viewType="VIEW"}}}}]);app.directive("ngPaypalForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/paypal-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngCvsForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/cvs-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngPoForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/transaction/payment/partials/payment-forms/po-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngSepaAgreement",["$rootScope","PaymentService","features","StoreConstants","PaymentConstants","SalesPaymentConstants",function($rootScope,PaymentService,features,StoreConstants,PaymentConstants,SalesPaymentConstants){return{restrict:"EA",scope:{mandateId:"=",paymentDetails:"=",hideMandateId:"=",salesOrderNumber:"=",isSalesFlow:"="},replace:true,templateUrl:"js/transaction/payment/partials/sepa_condition.html",link:function(scope,element,attrs){scope.messageText1="Ich ermächtige/ Wir ermächtigen (A) Worldpay, Zahlungen von meinem/ unserem Konto mittels Lastschrift einzuziehen. Zugleich (B) weise ich mein/ weisen wir unser Kreditinstitut an, die von Worldpay auf mein/ unser Konto gezogenen Lastschriften einzulösen.";scope.messageText2="Ich kann/ Wir können innerhalb von acht Wochen, beginnend mit dem Belastungsdatum, die Erstattung des belasteten Betrages verlangen. Es gelten dabei die mit meinem/ unserem Kreditinstitut vereinbarten Bedingungen. Meine/ Unsere Rechte zu dem obigen Mandat sind in einem Merkblatt enthalten, das ich/ wir von meinem/ unserem Kreditinstitut erhalten kann/ können.";scope.isSepaDetailLoading=true;scope.isSepaMandateIdLoadingFail=false;scope.isSepaConditionAccepted=false;scope.$watch("paymentDetails.paymentType",function(){if((scope.paymentDetails&&scope.paymentDetails.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE)&&features.isFeatureEnabled("sepa")){scope.loadSepaMandateId()}});scope.$watch("paymentDetails.confirmedPaymentDetails.paymentType",function(){if((scope.paymentDetails&&scope.paymentDetails.confirmedPaymentDetails&&scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE)&&features.isFeatureEnabled("sepa")){scope.isSepaDetailLoading=false;scope.sepaDetail=scope.sepaDetail||{};scope.sepaDetail.mandateType="Wiederkehrende Zahlung";scope.sepaDetail.mandateId="M-100001148-"+scope.salesOrderNumber+"-S"}});scope.loadSepaMandateId=function(){scope.isSepaMandateIdLoadingFail=false;scope.isSepaDetailLoading=true;scope.sepaDetail=scope.sepaDetail||{};PaymentService.getSepaMandateId({oderGuid:"",processType:"ZCSB",merchantCode:"ADOBETELESALES",orderCode:""}).success(function(result){scope.sepaDetail=result;if(angular.isDefined(scope.sepaDetail)&&angular.isDefined(scope.sepaDetail.mandateType)&&scope.sepaDetail.mandateType=="RECURRING"){scope.sepaDetail.mandateType="Wiederkehrende Zahlung"}scope.isSepaDetailLoading=false;scope.isSepaMandateIdLoadingFail=false}).error(function(error){scope.isLoading=false;scope.isSepaMandateIdLoadingFail=true})};scope.updateSepaCondition=function(){if(scope.isSalesFlow==true||scope.isSalesFlow=="true"){if(scope.isSepaConditionAccepted){scope.paymentDetails.confirmedPaymentDetails.mandateId=scope.sepaDetail.mandateId}else{scope.paymentDetails.confirmedPaymentDetails.mandateId=""}}else{if(scope.isSepaConditionAccepted){scope.paymentDetails.mandateId=scope.sepaDetail.mandateId}else{scope.paymentDetails.mandateId=""}}};scope.toggleClassOnGlyphClick=function(eventTarget){if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-plus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-minus pull-right");$("#collapse"+toggle).collapse("show")}else{if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-minus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}else{if(angular.isNumber(eventTarget)){$("#toggle"+toggle).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}}}}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("PaymentService",["$http",function($http){var service={};service.getPaymentMetadata=function(data){return $http({method:"POST",url:"../metadataService/getPaymentMetadata.do",data:data})};service.retriggerPayment=function(data){return $http({method:"POST",url:"../transactionService/retriggerPayment.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getSepaMandateId=function(data){return $http({method:"POST",url:"../sepaService/getSepaMandateId.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.validateIBANDetail=function(data){return $http({method:"POST",url:"../transactionService/validateIBANDetail.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");var transform=function(data){return $.param(data)};app.factory("PersonalizeDashboardService",["$http",function($http){var service={};service.saveSearch=function(updateFlag,dashboardSearchDto){return $http({method:"POST",url:"../searchPersistenceService/saveSearch.do",headers:{"Content-Type":"application/json"},data:dashboardSearchDto})};service.getSavedSearches=function(){return $http({method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../searchPersistenceService/getSavedSearches.do"})};service.getSavedSearchesByTransactionType=function(data){return $http({method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../searchPersistenceService/getSavedSearchesByTransactionType.do",transformRequest:transform,data:data})};service.performSavedSearch=function(data){return $http({method:"POST",url:"../searchPersistenceService/performSavedSearch.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.deleteSaveSearch=function(data){return $http({method:"POST",url:"../searchPersistenceService/deleteSavedSearch.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("PlanchangeService",["$http",function($http){var service={};service.getChangePlanOffers=function(data){return $http({method:"GET",url:"../subscriptionService/relatedOffers.do",params:{offerId:data.offerId,country:data.country,locale:""}})};service.getChangePlanPreview=function(data){return $http({method:"GET",url:"../subscriptionService/changePlanPreview.do",params:{subscriptionId:data.subscriptionId,offerId:data.offerId,customerGuid:data.customerGuid,locale:"",suppressOfferData:false}})};service.applyPlanChange=function(data){return $http({method:"POST",url:"../subscriptionService/changePlan.do",params:{validationToken:data.validationToken,toSubscriptionOfferId:data.toSubscriptionOfferId,subscriptionId:data.subscriptionId,customerGuid:data.customerGuid,locale:"",asynchronous:"false",planChangeReasonCode:data.reasonCode,isSave:"false",saveReasonCode:""}})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("productDetails",["Utils","MetadataService","ProductService","TeamProductService","CustomerPreviewService","$timeout","PaymentConstants","CartValidator",function(Utils,MetadataService,ProductService,TeamProductService,CustomerPreviewService,$timeout,PaymentConstants,CartValidator){return{restrict:"EA",scope:{productData:"=productdata",uniqueId:"=uniqueid",metadata:"=metadata",refresh:"&",customer:"=customer",productContext:"="},replace:true,templateUrl:"js/customer/partials/product-details.html",link:function(scope,element,attrs){scope.isProductLoading=true;scope.isLoading=false;scope.isTransferButtonDisable=true;scope.selectAll=false;scope.addSeatQuantity=1;scope.canCustomerCancelCcmTeam=false;scope.selectedSeats=[];scope.selectedReCancelSeat;scope.teamInformation=[];scope.seatInformation=[];scope.statusSelection="";scope.addSeatTooltip="";scope.primaryAdminList=[];scope.productStatus={selectedId:null};scope.isPayPoType=false;scope.ccmTeamProductDetails={};scope.disableStatus=PaymentConstants.TEAM_CONTRACT_DISABLE_STATUS;scope.actionCode;scope.isAdminListLoading=false;scope.selectedAdmin;scope.resellerPrimaryContact;scope.resellerSecondryContract;scope.adminList=[];scope.$watch("uniqueId",function(newValue,oldValue){if(newValue){scope.getProductDetails()}scope.ccmSeatMessages=[];scope.transferStatusMessages=[];scope.serviceMessages=[]});scope.$on("RefreshProductDetailsEvent",function(){scope.isProductLoading=true;scope.getProductDetails()});scope.getProductDetails=function(){$("#productDetailsTab a:first").tab("show");scope.isLoadingEvents=false;scope.isEventsLoaded=false;$("#loadButtonContainer").show();scope.isCcmTeam=Utils.isCCMTeam(scope.productData);scope.isProductLoading=true;scope.teamInformation=[];scope.seatInformation=[];scope.isCCE=Utils.isCCE(scope.productData);if(Utils.isOrganization(scope.$parent.customer.bpType)&&scope.productData.regInd=="C"){scope.isCcmTeam=true}if(scope.isCcmTeam){scope.isPayPoType=false;TeamProductService.getTeamProductDetails({partnerId:scope.productData.ownerId,entitlementId:"",componentId:scope.productData.componentId,guid:scope.productData.uniqueId,sku:scope.productData.sku}).success(function(result){console.log("Success -> CCM Team Product Details");scope.ccmTeamProductDetails=result;if(scope.customer&&scope.customer.bpType=="1"){scope.isProductLoading=false}else{scope.getAdminList()}if(scope.ccmTeamProductDetails.contract&&scope.ccmTeamProductDetails.contract.paymentType==9){scope.isPayPoType=true;scope.checked=false}scope.ccmTeamProductDetails.cancelAllowed=true;scope.addSeatTooltip=scope.ccmTeamProductDetails.addAllowed?"":" (CCM Team Contract is not ready to Add Seats/Cancel Seats at this time. Please try again later)";scope.resellerInfoList=[];if(scope.ccmTeamProductDetails.resellerContacts&&scope.ccmTeamProductDetails.resellerContacts.length>0){angular.forEach(scope.ccmTeamProductDetails.resellerContacts,function(resellerContract){if(resellerContract.teamRole=="RESPADMIN"){scope.resellerPrimaryContact=resellerContract}else{if(resellerContract.teamRole=="RESSADMIN"){scope.resellerSecondryContract=resellerContract}}})}angular.forEach(scope.ccmTeamProductDetails.roleInfos,function(roleInfoItem){if(roleInfoItem.teamRole!="DELEGATE"&&roleInfoItem.teamRole!=""){scope.teamInformation.push(roleInfoItem)}else{switch(roleInfoItem.seatStatus){case"ASSIGNED":roleInfoItem.seatStatusId=1;break;case"INVITED":roleInfoItem.seatStatusId=2;break;case"UNASSIGNED":roleInfoItem.seatStatusId=3;break;case"CANCELLED":roleInfoItem.seatStatusId=4;break;case"CANCELLING":roleInfoItem.seatStatusId=5;break}scope.seatInformation.push(roleInfoItem)}if(roleInfoItem.seatStatus&&roleInfoItem.seatStatus!=""&&roleInfoItem.cancelAllowed){scope.ccmTeamProductDetails.cancelAllowed=true}if(!roleInfoItem.cancelAllowed){}})}).error(function(error){console.log("error",error);scope.isProductLoading=false})}else{if(scope.isCCE){ProductService.getCceProductDetails({contractId:scope.productData.uniqueId,offeringCode:scope.productData.offeringCode,marketSegment:scope.productData.marketSegment}).success(function(result){console.log("Success -> CCE Product Deetails");scope.cceProductDetails=result;scope.isProductLoading=false}).error(function(error){console.log("error",error);scope.isProductLoading=false})}else{ProductService.getProductDetails({productGuid:scope.productData.uniqueId,componentId:scope.productData.componentId,regType:scope.productData.regType,partnerId:scope.productData.ownerId,regInd:scope.productData.regInd}).success(function(result){console.log("Success -> Product Deetails");scope.productDetails=result;scope.isProductLoading=false}).error(function(error){console.log("error",error);scope.isProductLoading=false})}}};scope.infoSeatMessage="";scope.checkCancelCheckboxInvisibile=function(teamRowData){if(angular.uppercase(teamRowData.seatStatus)=="CANCELLED"){scope.infoSeatMessage="The seat has been cancelled";return true}else{if(!teamRowData.cancellable||teamRowData.seatId==""){scope.infoSeatMessage="CCM Team Contract is not ready to cancel seats at this time. Please try again later";return true}}scope.infoSeatMessage="";return false};scope.checkReCancelBtnShow=function(seat){if(new Date(seat.termEndDate)<new Date()&&seat.seatStatus=="CANCELLING"){return true}return false};scope.reCancelSeat=function(selectedRowValue){selectedRowValue.isLoading=true;TeamProductService.reCancelSeat({teamId:scope.getTeamId(scope.customer)+"@AdobeOrg",seats:[selectedRowValue.seatId]}).success(function(result){selectedRowValue.isLoading=false;if(result&&result[0]&&result[0].updateSucceeded){selectedRowValue.reCancelMessage="Success"}else{selectedRowValue.reCancelMessage="Failed"}}).error(function(error){selectedRowValue.isLoading=false;if(error&&error[0]&&error[0].seatUpdateFailureReason){selectedRowValue.failureDetails=error[0].seatUpdateFailureReason}else{selectedRowValue.failureDetails="Failed, Try Again..."}selectedRowValue.reCancelMessage="Failed"})};scope.checkSeatSelection=function(selectedRowValue,$event){selectedRowValue.forCancellation=$($event.target).is(":checked");scope.selectedSeats=[];angular.forEach(scope.ccmTeamProductDetails.roleInfos,function(roleInfoItem){if(roleInfoItem.forCancellation==true){scope.selectedSeats.push(roleInfoItem.seatId)}});if(scope.selectedSeats.length==1){scope.cancelText="Cancel 1 Seat"}else{if(scope.selectedSeats.length>1){scope.cancelText="Cancel "+scope.selectedSeats.length+" Seats"}}scope.canCustomerCancelCcmTeam=scope.selectedSeats.length>0?true:false;$("#selectedAllChk").prop("checked",false)};scope.selectAllItems=function($event){var selectedValue=$($event.target).is(":checked");scope.selectedSeats=[];angular.forEach(scope.ccmTeamProductDetails.roleInfos,function(roleInfoItem){if(selectedValue){if(!scope.checkCancelCheckboxInvisibile(roleInfoItem)){roleInfoItem.forCancellation=true;scope.selectedSeats.push(roleInfoItem.seatId);scope.cancelText="Cancel Subscription"}}else{roleInfoItem.forCancellation=false}});scope.canCustomerCancelCcmTeam=scope.selectedSeats.length>0?true:false};scope.showTransferLicenseModal=function(){$("#transferLicenseModal").modal("show")};scope.cancelTransferLicenseModal=function(){$("#transferLicenseModal").modal("hide");scope.isTransferButtonDisable=true;scope.searchFields.customerId=""};scope.searchCustomerId=function(){scope.searchCustomerIdResults=null;scope.searchCustomerResultMessage=null;CustomerPreviewService.search(scope.searchFields).success(function(result){if(result.messages.length>0){scope.searchCustomerResultMessage=result.messages[0]}else{scope.searchCustomerIdResults=result.customerSearchResults[0];scope.isTransferButtonDisable=false}}).error(function(result){scope.isTransferButtonDisable=false})};scope.transferLicense=function(){var transferData={oldCustomerNo:scope.productData.ownerId,newCustomerNo:scope.searchCustomerIdResults.customerNo,serialNo:scope.productData.serialNumber,productGuid:scope.productData.uniqueId};ProductService.transferLicense(transferData).success(function(result){scope.transferStatusMessages=result.messages;scope.transferStatusMessages.text="Product License Transferred Successfully";scope.cancelTransferLicenseModal();$timeout(function(){scope.refresh()},3000)}).error(function(result){scope.transferStatusMessages=[]})};scope.showAddSeatsModal=function(){$("#addSeatsModal").modal("show");scope.checked=false;scope.addSeatTransactionLoading=true;var seats=[];seats.push("1");scope.addSeatsMessages=[];var entitlementObject={entitlementId:scope.ccmTeamProductDetails.products[0].entitlementId,seatIds:seats};TeamProductService.getAddSeatDetails(entitlementObject).success(function(result){console.log("Success -> Add Seat Order Deetails");scope.transactionDetails=result;scope.ccmTeamProductDetails.currencyCode=scope.transactionDetails.currency;scope.ccmTeamProductDetails.eachSeatPrice=Number(scope.transactionDetails.proratedUnitPrice);scope.ccmTeamProductDetails.normalUnitPrice=Number(scope.transactionDetails.normalUnitPrice);scope.ccmTeamProductDetails.existingSeatQty=Number(scope.transactionDetails.quantity);scope.addSeatTransactionLoading=false;scope.addSeatPurchaseLoading=false}).error(function(error){console.log("error",error);scope.addSeatTransactionLoading=false})};scope.checkValidSeatQuantity=function(){if(!(scope.addSeatQuantity>0&&scope.addSeatQuantity<100)){scope.addSeatQuantity=1}};scope.cancelAddSeatsModal=function(){$("#addSeatsModal").modal("hide");scope.addSeatQuantity=1};scope.addSeatsMessages=[];scope.ddMaxValue=54600;scope.isDDOrderLarge=false;scope.$watch("addSeatQuantity",function(value){if(!value){return}scope.checkDDValue()});scope.checkDDValue=function(){var totalExVAT=scope.addSeatQuantity*scope.ccmTeamProductDetails.normalUnitPrice;var isReturn=false;if(totalExVAT>scope.ddMaxValue&&scope.ccmTeamProductDetails.contract.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){scope.addSeatsMessages=Utils.showMessage("error","For orders this large, please use a different payment method.");scope.isDDOrderLarge=true;isReturn=true}else{if(totalExVAT<scope.ddMaxValue&&scope.ccmTeamProductDetails.contract.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){scope.addSeatsMessages=[];scope.isDDOrderLarge=false;isReturn=false}}return isReturn};scope.addSeatPurchase=function(){if(scope.checkDDValue()==true){return}scope.addSeatPurchaseLoading=true;var finalPONumber=null;if(scope.isPayPoType){finalPONumber=scope.ccmTeamProductDetails.contract.poNumber;if(scope.checked){finalPONumber=scope.tempPoNumber}}TeamProductService.purchaseSeat({entitlementId:scope.ccmTeamProductDetails.products[0].entitlementId,componentId:scope.productData.componentId,partner:scope.productData.ownerId,seatCount:scope.addSeatQuantity,poNumber:finalPONumber}).success(function(result){console.log("Success -> Add Seat Purchase");if(result){if(result.length>0&&result[0].success==true&&scope.ccmTeamProductDetails.contract.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result.push(CartValidator.getCartMessage("しばらくしたらお支払い案内メールが送られますので、お客様にその旨お伝えください","success"))}scope.ccmSeatMessages=Utils.showCrmMessage(result)}scope.addSeatsPurchaseResult=result;scope.addSeatPurchaseLoading=false;scope.cancelAddSeatsModal();scope.getProductDetails()}).error(function(error){console.log("error",error);scope.addSeatPurchaseLoading=false;scope.cancelAddSeatsModal()})};scope.showCalculatePenaltyModal=function(){$("#calculatePenaltyModal").modal("show");scope.calculatePenaltyLoading=true;var entitlementObject={entitlementId:scope.ccmTeamProductDetails.products[0].entitlementId,seatIds:scope.selectedSeats};TeamProductService.getCalculatePenaltyDetails(entitlementObject).success(function(result){console.log("Success -> Calculate Penalty Details");scope.ccmCalculatePenaltyMessage=result[0].text;scope.calculatePenaltyLoading=false}).error(function(error){console.log("error",error);scope.calculatePenaltyLoading=false})};scope.hideCalculatePenaltyModal=function(){scope.calculatePenaltyLoading=false;$("#calculatePenaltyModal").modal("hide")};scope.showCancelSubscriptionModal=function(){$("#cancelSubscriptionModal").modal("show");scope.setCancelStep(1)};scope.hideCancelSubscriptionModal=function(){$("#cancelSubscriptionModal").modal("hide");scope.setCancelStep(1)};scope.setCancelStep=function(step){scope.cancelStep=step};scope.getCancelStep=function(){return scope.cancelStep};scope.isSeatsCancelling=false;scope.cancelSeatOrSubscription=function(){scope.isSeatsCancelling=true;var entitlementObject={entitlementId:scope.ccmTeamProductDetails.products[0].entitlementId,seatIds:scope.selectedSeats,cancelReason:scope.cancellationReason,componentId:scope.productData.componentId,partner:scope.productData.ownerId,seats:null,action:"CANCEL"};TeamProductService.cancelSeatOrSubscription(entitlementObject).success(function(result){console.log("Success -> Cancel Seat Or Subscription");var deletedSeats=result;angular.forEach(deletedSeats,function(deletedItem){angular.forEach(scope.ccmTeamProductDetails.roleInfos,function(roleInfoItem){if(roleInfoItem.seatId==deletedItem.seatId){roleInfoItem.forCancellation=true;roleInfoItem.seatStatus=deletedItem.status}});if(deletedSeats.length==1){scope.ccmSeatMessages=Utils.showMessage("info",deletedSeats[0].message)}else{scope.ccmSeatMessages=Utils.showMessage("info","Selected seats are successfully cancelled")}});scope.selectedSeats=[];scope.canCustomerCancelCcmTeam=scope.selectedSeats.length>0?true:false;scope.hideCancelSubscriptionModal();scope.isSeatsCancelling=false}).error(function(error){console.log("error",error);scope.selectedSeats=[];scope.canCustomerCancelCcmTeam=scope.selectedSeats.length>0?true:false;scope.hideCancelSubscriptionModal();scope.isSeatsCancelling=false})};scope.defaultAdminDetails={firstName:"",lastName:"",id:"",email:""};scope.adminDetails={firstName:"",lastName:"",id:"",email:""};scope.isAdminInviteLoading=false;scope.isSendAdminBtnDisabled=false;scope.$watch("scope.adminDetails.email",function(value){if(!value){return}scope.isSendAdminBtnDisabled=(value=="")?true:false});scope.showAdminInviteModal=function(){$("#inviteTeamAdminModal").modal("show");scope.adminDetails=null};scope.sendAdminInviteHandler=function(){scope.isAdminInviteLoading=true;if(scope.ccmTeamProductDetails.contract.contractType=="INDIRECT_ORG"){scope.sendAdminInviteHandlerForIndirectOrg()}else{TeamProductService.inviteAdmins({teamId:scope.getTeamId(scope.customer)+"@AdobeOrg",firstName:scope.adminDetails.firstName,lastName:scope.adminDetails.lastName,email:scope.adminDetails.email}).success(function(result){var showMessageList=[];if(result&&result[0].invitationSuccessful==false){var showMessageList=[];if(result[0].invitationFailureReason=="ALREADY_INVITED"){showMessageList.push({info:false,error:true,warning:false,text:"The admin is already invited"})}else{showMessageList.push({info:false,error:true,warning:false,text:"The admin invite failed due to "+result[0].invitationFailureReason})}scope.ccmSeatMessages=showMessageList;scope.cancelAdminInviteHandler()}else{showMessageList.push({info:true,error:false,warning:false,text:"The admin "+scope.adminDetails.email+" has been invited successfully."});scope.ccmSeatMessages=showMessageList;scope.cancelAdminInviteHandler()}}).error(function(result){console.log("ProductDetailsDirective --> sendAdminInviteHandler --> TeamProductService.inviteAdmins"+result);scope.cancelAdminInviteHandler()})}};scope.sendAdminInviteHandlerForIndirectOrg=function(){TeamProductService.inviteAdminsForIndirectOrg({partnerNo:scope.productData.ownerId,contractId:scope.ccmTeamProductDetails.contract.contractId,firstName:scope.adminDetails.firstName,lastName:scope.adminDetails.lastName,id:scope.adminDetails.id,email:scope.adminDetails.email}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The admin "+scope.adminDetails.email+" has been invited successfully.");scope.cancelAdminInviteHandler()}).error(function(result){console.log("ProductDetailsDirective --> sendAdminInviteHandler --> TeamProductService.inviteAdmins"+result);scope.cancelAdminInviteHandler()})};scope.cancelAdminInviteHandler=function(){scope.adminDetails=angular.copy(scope.defaultAdminDetails);scope.isAdminInviteLoading=false;scope.isSendAdminBtnDisabled=false;$("#inviteTeamAdminModal").modal("hide")};scope.isShowRevokeSeat=true;scope.adminName="";scope.deleteAdminLoading=false;scope.currentRoleInfo={};scope.selectedRoleInfo;scope.showDeleteAdminModal=function(roleInfo){if(roleInfo.invitation&&roleInfo.invitation.typeCode=="CCM_TEAM_INVITE_PRIMARY"){scope.selectedRoleInfo=roleInfo;scope.showChangeOption()}else{scope.adminName=roleInfo.firstName+" "+roleInfo.lastName;scope.currentRoleInfo=roleInfo;$("#deleteTeamAdminModal").modal("show")}};scope.deleteAdminSeatHandler=function(){scope.deleteAdminLoading=true;TeamProductService.deleteAdmin({partnerNo:scope.productData.ownerId,contractId:scope.ccmTeamProductDetails.contract.contractId,firstName:scope.currentRoleInfo.firstName,lastName:scope.currentRoleInfo.lastName,id:scope.currentRoleInfo.adminId,email:scope.currentRoleInfo.smtp}).success(function(result){console.log("TeamProductService --> deleteAdmin --> Success");scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The admin "+scope.currentRoleInfo.smtp+" has been deleted successfully.");scope.cancelDeleteTeamAdminModal();scope.getProductDetails()}).error(function(result){console.log("TeamProductService --> deleteAdmin --> Error :"+result);scope.cancelDeleteTeamAdminModal()})};scope.cancelDeleteTeamAdminModal=function(){scope.adminName="";scope.deleteAdminLoading=false;scope.currentRoleInfo={};$("#deleteTeamAdminModal").modal("hide")};scope.defaultEditAdminDetails={firstName:"",lastName:"",id:"",email:""};scope.editAdminDetails={firstName:"",lastName:"",id:"",email:""};scope.isEditTeamDetailsLoading=false;scope.isEditTeamEnabled=false;scope.deleteAdminDetails={};scope.$watch("editAdminDetails.email",function(value){if(!value){return}scope.isEditTeamEnabled=(value=="")?true:false});scope.showEditTeamAdminModal=function(roleInfo){scope.editAdminDetails.firstName=roleInfo.firstName;scope.editAdminDetails.lastName=roleInfo.lastName;scope.editAdminDetails.id=roleInfo.adminId;scope.editAdminDetails.email=roleInfo.smtp;$("#editTeamAdminModal").modal("show")};scope.sendEditTeamAdmin=function(){scope.isEditTeamDetailsLoading=true;TeamProductService.deleteAdmin({partnerNo:scope.productData.ownerId,contractId:scope.ccmTeamProductDetails.contract.contractId,firstName:scope.editAdminDetails.firstName,lastName:scope.editAdminDetails.lastName,id:scope.editAdminDetails.id,email:scope.editAdminDetails.email}).success(function(result){console.log("TeamProductService --> deleteAdmin --> Success : "+result);scope.inviteDeletedTeamAdmin()}).error(function(result){console.log("TeamProductService --> EditAdmin --> Error :"+result);scope.cancelEditTeamAdminModal()})};scope.inviteDeletedTeamAdmin=function(){TeamProductService.inviteAdmins({partnerNo:scope.productData.ownerId,contractId:scope.ccmTeamProductDetails.contract.contractId,firstName:scope.editAdminDetails.firstName,lastName:scope.editAdminDetails.lastName,id:null,email:scope.editAdminDetails.email}).success(function(result){console.log("TeamProductService --> deleteAdmin --> Success");scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The previous admin has been edited and "+scope.editAdminDetails.email+" has been invited successfully.");scope.cancelEditTeamAdminModal();scope.getProductDetails()}).error(function(result){console.log("TeamProductService --> inviteAdmin --> Error :"+result);scope.cancelEditTeamAdminModal();scope.getProductDetails()})};scope.cancelEditTeamAdminModal=function(){scope.editAdminDetails=angular.copy(scope.editAdminDetails);scope.isEditTeamDetailsLoading=false;scope.isEditTeamEnabled=false;$("#editTeamAdminModal").modal("hide")};scope.defaultEntitlementMaintainObj={entitlementId:null,seatIds:null,cancelReason:null,componentId:null,partner:null,seats:null,action:null};scope.defaultSeatsInfoObj={email:null,status:null,firstName:null,lastName:null,seatId:null,action:null,delegateId:null,message:null,quantity:0,inviteId:null};scope.inviteEntitlementObj={};scope.inviteSeatInfoObj={};scope.isSendSeatBtnDisabled=true;scope.isInviteSeatLoading=false;scope.showInviteSeatModal=function(seatInfo){scope.inviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.inviteSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.inviteSeatInfoObj.status=seatInfo.seatStatus;scope.inviteSeatInfoObj.seatId=seatInfo.seatId;scope.inviteEntitlementObj.entitlementId=seatInfo.entitlementId;scope.inviteEntitlementObj.componentId=scope.productData.componentId;scope.inviteEntitlementObj.ownerId=scope.productData.ownerId;$("#inviteSeatModal").modal("show");scope.isSendSeatBtnDisabled=false};scope.seatInviteHandler=function(){scope.isInviteSeatLoading=true;scope.inviteSeatInfoObj.action="ASSIGN";var seats=[];seats.push(scope.inviteSeatInfoObj);scope.inviteEntitlementObj.seats=seats;TeamProductService.addDelegateDetails({componentId:scope.inviteEntitlementObj.componentId,entitlementId:scope.inviteEntitlementObj.entitlementId,partner:scope.inviteEntitlementObj.ownerId,seatId:scope.inviteSeatInfoObj.seatId,status:scope.inviteSeatInfoObj.status,firstName:scope.inviteSeatInfoObj.firstName,lastName:scope.inviteSeatInfoObj.lastName,email:scope.inviteSeatInfoObj.email,inviteId:scope.inviteSeatInfoObj.inviteId,action:scope.inviteSeatInfoObj.action,quantity:0}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The seat for "+scope.inviteSeatInfoObj.email+" has been invited successfully.");scope.cancelSeatInviteModal();scope.getProductDetails()}).error(function(result){console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelSeatInviteModal()})};scope.cancelSeatInviteModal=function(){scope.inviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.inviteSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.isInviteSeatLoading=false;$("#inviteSeatModal").modal("hide")};scope.revokeEntitlementObj={};scope.revokeSeatInfoObj={};scope.isRevokeSeatLoading=false;scope.showRevokeInvitationModal=function(seatInfo){scope.revokeEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.revokeSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.revokeSeatInfoObj.firstName=seatInfo.firstName;scope.revokeSeatInfoObj.lastName=seatInfo.firstName;scope.revokeSeatInfoObj.email=seatInfo.smtp;scope.revokeSeatInfoObj.inviteId=seatInfo.inviteId;scope.revokeSeatInfoObj.status=seatInfo.seatStatus;scope.revokeSeatInfoObj.seatId=seatInfo.seatId;scope.revokeSeatInfoObj.delegateId=seatInfo.delegateId;scope.revokeEntitlementObj.entitlementId=seatInfo.entitlementId;scope.revokeEntitlementObj.componentId=scope.productData.componentId;scope.revokeEntitlementObj.ownerId=scope.productData.ownerId;$("#revokeInvitedSeatModal").modal("show");scope.isSendSeatBtnDisabled=false};scope.revokeInvitation=function(){scope.isRevokeSeatLoading=true;scope.revokeSeatInfoObj.action="DELETE";var seats=[];seats.push(scope.revokeSeatInfoObj);scope.revokeEntitlementObj.seats=seats;TeamProductService.removeDelegateDetails({componentId:scope.revokeEntitlementObj.componentId,entitlementId:scope.revokeEntitlementObj.entitlementId,partner:scope.revokeEntitlementObj.ownerId,seatId:scope.revokeSeatInfoObj.seatId,status:scope.revokeSeatInfoObj.status,firstName:scope.revokeSeatInfoObj.firstName,lastName:scope.revokeSeatInfoObj.lastName,email:scope.revokeSeatInfoObj.email,inviteId:scope.revokeSeatInfoObj.inviteId,delegateId:scope.revokeSeatInfoObj.delegateId,action:scope.revokeSeatInfoObj.action,quantity:0}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The invited seat for "+scope.revokeSeatInfoObj.email+" has been revoked successfully.");scope.cancelRevokeInvitationModal();scope.getProductDetails()}).error(function(result){console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelRevokeInvitationModal()})};scope.cancelRevokeInvitationModal=function(){scope.revokeEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.revokeSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.isRevokeSeatLoading=false;$("#revokeInvitedSeatModal").modal("hide")};scope.revokeAndInviteEntitlementObj={};scope.revokeAndInviteSeatInfoObj={};scope.isRevokeAndInviteSeatLoading=false;scope.showRevokeInvitationAndInviteModal=function(seatInfo){scope.revokeAndInviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.revokeAndInviteSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.revokeAndInviteSeatInfoObj.firstName=seatInfo.firstName;scope.revokeAndInviteSeatInfoObj.lastName=seatInfo.lastName;scope.revokeAndInviteSeatInfoObj.email=seatInfo.smtp;scope.revokeAndInviteSeatInfoObj.inviteId=seatInfo.inviteId;scope.revokeAndInviteSeatInfoObj.status=seatInfo.seatStatus;scope.revokeAndInviteSeatInfoObj.seatId=seatInfo.seatId;scope.revokeAndInviteEntitlementObj.entitlementId=seatInfo.entitlementId;scope.revokeAndInviteEntitlementObj.componentId=scope.productData.componentId;scope.revokeAndInviteEntitlementObj.ownerId=scope.productData.ownerId;$("#revokeInvitationAndInviteSeatModal").modal("show")};scope.revokeInvitationAndInvite=function(){scope.isRevokeAndInviteSeatLoading=true;scope.revokeAndInviteSeatInfoObj.action="ASSIGN";TeamProductService.updateDelegateDetails({componentId:scope.revokeAndInviteEntitlementObj.componentId,entitlementId:scope.revokeAndInviteEntitlementObj.entitlementId,partner:scope.revokeAndInviteEntitlementObj.ownerId,seatId:scope.revokeAndInviteSeatInfoObj.seatId,status:scope.revokeAndInviteSeatInfoObj.status,firstName:scope.revokeAndInviteSeatInfoObj.firstName,lastName:scope.revokeAndInviteSeatInfoObj.lastName,email:scope.revokeAndInviteSeatInfoObj.email,inviteId:scope.revokeAndInviteSeatInfoObj.inviteId,action:scope.revokeAndInviteSeatInfoObj.action,quantity:0}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The invited seat has been revoked and "+scope.revokeAndInviteSeatInfoObj.email+" has been invited successfully.");scope.cancelRevokeInvitationAndInviteModal();scope.getProductDetails()}).error(function(result){console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelRevokeInvitationAndInviteModal()})};scope.cancelRevokeInvitationAndInviteModal=function(){scope.revokeAndInviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.revokeAndInviteSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.isRevokeAndInviteSeatLoading=false;$("#revokeInvitationAndInviteSeatModal").modal("hide")};scope.removeAssignedSeatEntitlementObj={};scope.removeAssignedSeatInfoObj={};scope.isRemoveAssignedSeatLoading=false;scope.showRemoveExistingUserSeatModal=function(seatInfo){scope.removeAssignedSeatEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.removeAssignedSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.removeAssignedSeatInfoObj.firstName=seatInfo.firstName;scope.removeAssignedSeatInfoObj.lastName=seatInfo.firstName;scope.removeAssignedSeatInfoObj.email=seatInfo.smtp;scope.removeAssignedSeatInfoObj.inviteId=seatInfo.inviteId;scope.removeAssignedSeatInfoObj.status=seatInfo.seatStatus;scope.removeAssignedSeatInfoObj.seatId=seatInfo.seatId;scope.removeAssignedSeatInfoObj.delegateId=seatInfo.delegateId;scope.removeAssignedSeatEntitlementObj.entitlementId=seatInfo.entitlementId;scope.removeAssignedSeatEntitlementObj.componentId=scope.productData.componentId;scope.removeAssignedSeatEntitlementObj.ownerId=scope.productData.ownerId;$("#removeAssignedSeatModal").modal("show")};scope.isReCancelSeatLoading=false;scope.showReCancelUserSeatModal=function(seatInfo){scope.selectedReCancelSeat=seatInfo;$("#removeReCanelSeatModal").modal("show")};scope.cancelReCancelUserSeatModal=function(){scope.isReCancelSeatLoading=false;$("#removeReCanelSeatModal").modal("hide")};scope.reCancelSeatUser=function(){scope.isReCancelSeatLoading=true;TeamProductService.removeUserFromSeat(scope.getTeamId(scope.customer)+"@AdobeOrg",scope.selectedReCancelSeat.seatId).success(function(result){scope.isReCancelSeatLoading=false;scope.ccmSeatMessages=new Array({info:true,error:false,warning:false,text:"The assigned seat for "+scope.selectedReCancelSeat.smtp+" has been removed successfully."});scope.cancelReCancelUserSeatModal();scope.getProductDetails()}).error(function(result){scope.isReCancelSeatLoading=false;scope.ccmSeatMessages=new Array({info:false,error:true,warning:false,text:"The assigned seat for "+scope.selectedReCancelSeat.smtp+" has not removed successfully."});console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelReCancelUserSeatModal()})};scope.removeExistingSeatUser=function(){scope.isRemoveAssignedSeatLoading=true;scope.removeAssignedSeatInfoObj.action="DELETE";var seats=[];seats.push(scope.removeAssignedSeatInfoObj);scope.removeAssignedSeatEntitlementObj.seats=seats;TeamProductService.removeDelegateDetails({componentId:scope.removeAssignedSeatEntitlementObj.componentId,entitlementId:scope.removeAssignedSeatEntitlementObj.entitlementId,partner:scope.removeAssignedSeatEntitlementObj.ownerId,seatId:scope.removeAssignedSeatInfoObj.seatId,status:scope.removeAssignedSeatInfoObj.status,firstName:scope.removeAssignedSeatInfoObj.firstName,lastName:scope.removeAssignedSeatInfoObj.lastName,email:scope.removeAssignedSeatInfoObj.email,inviteId:scope.removeAssignedSeatInfoObj.inviteId,delegateId:scope.removeAssignedSeatInfoObj.delegateId,action:scope.removeAssignedSeatInfoObj.action,quantity:0}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The assigned seat for "+scope.removeAssignedSeatInfoObj.email+" has been removed successfully.");scope.cancelRemoveExistingUserSeatModal();scope.getProductDetails()}).error(function(result){console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelRemoveExistingUserSeatModal()})};scope.cancelRemoveExistingUserSeatModal=function(){scope.removeAssignedSeatEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.removeAssignedSeatInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.isRemoveAssignedSeatLoading=false;$("#removeAssignedSeatModal").modal("hide")};scope.removeAssignedSeatAndInviteEntitlementObj={};scope.removeAssignedSeatAndInviteInfoObj={};scope.isRemoveAssignedSeatAndInviteLoading=false;scope.showRemoveAssignedAndInviteSeatUserModal=function(seatInfo){scope.removeAssignedSeatAndInviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.removeAssignedSeatAndInviteInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.removeAssignedSeatAndInviteInfoObj.firstName=seatInfo.firstName;scope.removeAssignedSeatAndInviteInfoObj.lastName=seatInfo.lastName;scope.removeAssignedSeatAndInviteInfoObj.email=seatInfo.smtp;scope.removeAssignedSeatAndInviteInfoObj.inviteId=seatInfo.inviteId;scope.removeAssignedSeatAndInviteInfoObj.status=seatInfo.seatStatus;scope.removeAssignedSeatAndInviteInfoObj.seatId=seatInfo.seatId;scope.removeAssignedSeatAndInviteInfoObj.delegateId=seatInfo.delegateId;scope.removeAssignedSeatAndInviteEntitlementObj.entitlementId=seatInfo.entitlementId;scope.removeAssignedSeatAndInviteEntitlementObj.componentId=scope.productData.componentId;scope.removeAssignedSeatAndInviteEntitlementObj.ownerId=scope.productData.ownerId;$("#removeAssignedAndInviteSeatModal").modal("show")};scope.removeAssignedAndInviteSeatUser=function(){scope.isRemoveAssignedSeatAndInviteLoading=true;scope.removeAssignedSeatAndInviteInfoObj.action="ASSIGN";var seats=[];seats.push(scope.removeAssignedSeatAndInviteInfoObj);scope.removeAssignedSeatAndInviteEntitlementObj.seats=seats;TeamProductService.removeDelegateDetails({componentId:scope.removeAssignedSeatAndInviteEntitlementObj.componentId,entitlementId:scope.removeAssignedSeatAndInviteEntitlementObj.entitlementId,partner:scope.removeAssignedSeatAndInviteEntitlementObj.ownerId,seatId:scope.removeAssignedSeatAndInviteInfoObj.seatId,status:scope.removeAssignedSeatAndInviteInfoObj.status,firstName:scope.removeAssignedSeatAndInviteInfoObj.firstName,lastName:scope.removeAssignedSeatAndInviteInfoObj.lastName,email:scope.removeAssignedSeatAndInviteInfoObj.email,inviteId:scope.removeAssignedSeatAndInviteInfoObj.inviteId,delegateId:scope.removeAssignedSeatAndInviteInfoObj.delegateId,action:scope.removeAssignedSeatAndInviteInfoObj.action,quantity:0}).success(function(result){scope.ccmSeatMessages=Utils.ccmTeamMessage(result,"The assigned seat has been removed and "+scope.removeAssignedSeatAndInviteInfoObj.email+" has been invited successfully.");scope.cancelRemoveAssignedAndInviteSeatUserModal();scope.getProductDetails()}).error(function(result){console.log("Error --> TeamProductService.addDelegateDetails "+result);scope.cancelRemoveAssignedAndInviteSeatUserModal()})};scope.cancelRemoveAssignedAndInviteSeatUserModal=function(){scope.removeAssignedSeatAndInviteEntitlementObj=angular.copy(scope.defaultEntitlementMaintainObj);scope.removeAssignedSeatAndInviteInfoObj=angular.copy(scope.defaultSeatsInfoObj);scope.isRemoveAssignedSeatAndInviteLoading=false;$("#removeAssignedAndInviteSeatModal").modal("hide")};scope.hideEditProductModal=function(){$("#editProductModal").modal("hide");scope.isProductUpdateLoading=false};scope.showEditProductModal=function(){$("#editProductModal").modal("show");scope.productStatus.selectedId=scope.productDetails.status};scope.updateProduct=function(){var productUpdateData=angular.copy(scope.productDetails);productUpdateData.status=scope.productStatus.selectedId;scope.isProductUpdateLoading=true;ProductService.updateProduct(productUpdateData).success(function(result){scope.serviceMessages=Utils.showMessage("info",Utils.getInformationMessage(result));scope.productDetails.status=scope.productStatus.selectedId;scope.hideEditProductModal()}).error(function(result){scope.serviceMessages=Utils.showMessage("error","Product Update Failed, Please Try Again... ");scope.isProductUpdateLoading=false;scope.hideEditProductModal()})};scope.tempPoNumber="";scope.isPoNumberBlank=false;scope.$watch("tempPoNumber",function(value){scope.isPoNumberBlank=(scope.isPayPoType&&value==undefined&&scope.checked==true)?true:false});scope.$watch("checked",function(value){if(value==true){scope.tempPoNumber=undefined}else{if(value==false){scope.isPoNumberBlank=false;return}}scope.isPoNumberBlank=(scope.isPayPoType&&scope.checked==false&&tempPoNumber==undefined)?false:true});scope.editPoNumber=function(){scope.checked=(scope.checked)?false:true};scope.refresh=function(){scope.$parent.refreshCustomerDetails("products")};scope.isValidForSearch=function(email){var customerEmail=email;if(customerEmail==null||customerEmail==undefined||customerEmail==""){return true}if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length){return true}}return false};scope.isLoadingEvents=false;scope.isEventsLoaded=false;scope.loadSubscriptionEvents=function(){scope.isLoadingEvents=true;$("#loadButtonContainer").hide();var subsDetails=scope.productDetails.productSaasSubDetail;subsDetails.customerId=scope.productData.ownerId;ProductService.getSubscriptionEvents(subsDetails).success(function(response){console.log("Subs Events: ",response);scope.productDetails.saasEvents=response;scope.isEventsLoaded=true;scope.isLoadingEvents=false}).error(function(errorData){scope.serviceMessages=Utils.showMessage("error","Get Subscription Events Failed, Please Try Again... ");console.log("Error in loading subscription events",errorData);scope.isEventsLoaded=true;scope.isLoadingEvents=false})};scope.cancelAddSeatsModal=function(){$("#addSeatsModal").modal("hide");scope.addSeatQuantity=1};scope.changeAdminModal=function(){if(!scope.isSecondryAdminAvailable()){$("#changeAdminModal").modal("show")}else{$("#changePrimaryAdminModelInfo").modal("show")}};scope.isSecondryAdminAvailable=function(){var flag=true;angular.forEach(scope.primaryAdminList,function(roleInfo){if(roleInfo.type=="GRP_ADMIN"){flag=false}});return flag};scope.cancelChangePrimaryAdminModal=function(){$("#changePrimaryAdminModelInfo").modal("hide")};scope.cancelChangeAdminModal=function(){$("#changeAdminModal").modal("hide")};scope.showChangeOption=function(){$("#editInviteAdminAction").modal("show")};scope.cancelChangeOption=function(){$("#editInviteAdminAction").modal("hide")};scope.getAdminList=function(){var teamId=scope.getTeamId(scope.customer)+"@AdobeOrg";TeamProductService.getTeamAdmins({teamId:teamId}).success(function(result){scope.primaryAdminList=result;scope.isLoading=false;scope.isProductLoading=false;scope.cancelChangeAdminModal();scope.cancelChangeOption();scope.updateTeamInfoFromAdminList()}).error(function(error){scope.isAdminListLoading=false;scope.isLoading=false;scope.isProductLoading=false})};scope.getTeamId=function(customer){var teamId="";if(customer&&customer.customerIdentifications){for(var i=0;i<customer.customerIdentifications.length;i++){if(customer.customerIdentifications[i].idType=="ZGUID"){teamId=customer.customerIdentifications[i].idNumber;return teamId}}}return teamId};scope.updateTeamInfoFromAdminList=function(){var isSecondryAdminInvited=false;angular.forEach(scope.primaryAdminList,function(plist){angular.forEach(scope.teamInformation,function(teamInfo){if(plist.email&&plist.email.toUpperCase()==teamInfo.smtp.toUpperCase()){teamInfo.invitation=plist.invitation;if(plist.invitation&&plist.invitation.typeCode=="CCM_TEAM_INVITE_PRIMARY"){isSecondryAdminInvited=true}}})});if(isSecondryAdminInvited){scope.updatePrimaryAdminStatus()}else{scope.resetPrimaryAdminStatus()}};scope.updatePrimaryAdminStatus=function(){angular.forEach(scope.teamInformation,function(teamInfo){if(teamInfo.teamRole=="TEAMPADMIN"){teamInfo.awaitingPrimaryRemoval="T"}})};scope.resetPrimaryAdminStatus=function(){angular.forEach(scope.teamInformation,function(teamInfo){if(teamInfo.teamRole=="TEAMPADMIN"){teamInfo.awaitingPrimaryRemoval="F"}})};scope.confirmAction=function(){switch(scope.actionCode){case"RI":scope.resentPrimaryAdminInvite();break;case"WI":scope.revokePrimaryAdminInvite();break;case"WIRI":scope.withdrawAndRemoveAdmin();break}};scope.resentPrimaryAdminInvite=function(){scope.cancelChangeOption();var emails=[];emails.push(scope.selectedRoleInfo.smtp);scope.isLoading=true;TeamProductService.resendPrimaryAdminInvite({teamId:scope.getTeamId(scope.customer)+"@AdobeOrg",email:scope.selectedRoleInfo.smtp}).success(function(result){scope.getAdminList()}).error(function(error){})};scope.inviteForPrimaryAdmin=function(adminUserId){scope.selectedAdmin=adminUserId;var inviteAdmin=scope.getAdminDetail();scope.cancelChangeAdminModal();var orgGUID=scope.getTeamId(scope.customer);scope.isLoading=true;TeamProductService.sendPrimaryAdminInvite({teamId:orgGUID+"@AdobeOrg",firstName:inviteAdmin.firstName,lastName:inviteAdmin.lastName,email:inviteAdmin.email}).success(function(result){scope.ccmSeatMessages=Utils.showMessage("success","The invitation for primary admin to "+inviteAdmin.email+" has been sent successfully.");scope.getAdminList();if(result.errorMessage){if(result.errorMessage=="PRIMARY_ADMIN_INVITEE_COUNTRY_CONFLICT"){scope.ccmSeatMessages=Utils.showMessage("error","Secondary Admin from a different country can not be invited to be Primary Admin")}else{scope.ccmSeatMessages=Utils.showMessage("error",result.errorMessage)}}}).error(function(error){})};scope.getAdminDetail=function(){var data;for(var i=0;i<scope.primaryAdminList.length;i++){if(scope.primaryAdminList[i].userId==scope.selectedAdmin){data=scope.primaryAdminList[i];break}}return data};scope.revokePrimaryAdminInvite=function(){scope.isLoading=true;scope.cancelChangeOption();TeamProductService.revokePrimaryAdminInvite({invitationCode:scope.selectedRoleInfo.invitation.invitationCode}).success(function(result){scope.getAdminList()}).error(function(error){})};scope.withdrawAndRemoveAdmin=function(){scope.isLoading=true;scope.cancelChangeOption();var orgGUID=scope.getTeamId(scope.customer);TeamProductService.withdrawAndRemoveAdmin({teamId:orgGUID+"@AdobeOrg",email:scope.selectedRoleInfo.smtp}).success(function(result){scope.isProductLoading=true;scope.getProductDetails()}).error(function(error){})}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("ProductDto",{status:"",name:"",version:"",platform:"",language:"",componentId:"",config:"",uniqueId:"",serialNumber:"",recordNumber:"",sku:"",description:"",mediaType:"",price:{},metaName:"",prodType:"",metaType:"",metaPlatform:"",metaLanguage:"",metaConfig:"",classification:"",regType:"",ownerId:"",regInd:"",promoSku:false,teamId:"",teamName:"",teamRole:"",offeringCode:"",cceDesc:"",isSelected:"",educational:false,stock:false,excludeFromHendrix:false,commitTerm:"",allowedOnlyWithCcmt:false,registrationDate:null,marketSegment:"",businessSegment:"",productCode:"",puf:false});var app=app||angular.module("hxApp",["ngRoute"]);app.constant("ProductInformationConstants",{IMAGE_BASE_URL:"http://www.adobe.com/images/shared/product_mnemonics/48x48/",PRODUCT:[{full_name:"Creative Cloud All Apps",name:"CCSN",keywords:"Creative Cloud membership",thumbnail_cayenne_url:"img/products/ccm-ind.png"},{full_name:"Creative Cloud Team",name:"CCMT",keywords:"Creative Cloud Team",thumbnail_cayenne_url:"img/products/ccm-team.png"},{full_name:"Creative Cloud Team",name:"CCLE",keywords:"Creative Cloud Team",thumbnail_cayenne_url:"img/products/ccm-team.png"},{full_name:"Creative Cloud Photography plan",name:"PHLT",keywords:"creative cloud photography",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png"},{full_name:"After Effects CC",name:"AEFT",keywords:"After Effects",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/after-effects-no-shadow-48x48.png"},{full_name:"Dreamweaver CC",name:"DRWV",keywords:"Dreamweaver",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/dreamweaver-no-shadow-48x48.png"},{full_name:"Photoshop CC",name:"PHSP",keywords:"Photoshop",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/photoshop-no-shadow-48x48.png"},{full_name:"Illustrator CC",name:"ILST",keywords:"Illustrator",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/illustrator-no-shadow-48x48.png"},{full_name:"Animate CC",name:"FLPR",keywords:"Animate",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/animate-no-shadow-48x48.png"},{full_name:"inDesign CC",name:"IDSN",keywords:"inDesign",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/indesign-no-shadow-48x48.png"},{full_name:"Adobe Muse CC",name:"MUSE",keywords:"Muse",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/muse-no-shadow-48x48.png"},{full_name:"Photoshop Lightroom CC",name:"LTRM",keywords:"Photoshop Lightroom",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/photoshop-lightroom-no-shadow-48x48.png"},{full_name:"Photoshop Lightroom Bundles",name:"PHLT",keywords:"Photoshop Lightroom",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png"},{full_name:"Adobe Captivate 9",name:"CPTV",keywords:"Captivate",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_captivate9_50x50.png"},{full_name:"Adobe SpeedGrade CC",name:"SPGD",keywords:"SpeedGrade",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/speedgrade-no-shadow-48x48.png"},{full_name:"Adobe Audition CC",name:"AUDT",keywords:"Audition",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/audition-no-shadow-48x48.png"},{full_name:"Edge Animate CC",name:"EDGE",keywords:"Edge Animate",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/edge-animate-no-shadow-48x48.png"},{full_name:"Adobe Prelude CC",name:"PRLD",keywords:"Prelude",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/prelude-no-shadow-48x48.png"},{full_name:"Page Maker",name:"PGMP",keywords:"Page Maker",thumbnail_cayenne_url:"http://www.adobe.com/images/shared/product_mnemonics/48x48/pagemaker-48x48.png"},{full_name:"Font Folio",name:"FF",keywords:"Font Folio",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/store/product_boxshots/50x50/box_fontfolio11_50x50.png"},{full_name:"Adobe ColdFusion Builder (2016 release)",name:"CB",keywords:"ColdFusion Builder",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_CFB_50x50.png"},{full_name:"Adobe ColdFusion Standard Edition (2016 release)",name:"CSTD",keywords:"ColdFusion",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_CF_50x50.png"},{full_name:"Adobe ColdFusion Enterprise Edition (2016 release)",name:"CENT",keywords:"ColdFusion",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_CF_50x50.png"},{full_name:"Director 12",name:"DRCT",keywords:"Director",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product-totems/50x50/totem-director-12-50x50.png"},{full_name:"Adobe Sign",name:"ECHP",keywords:"Adobe Sign",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/esignmanager-icon-webstore-50x50.png"},{full_name:"Adobe Premiere Pro CC",name:"PPRO",keywords:"Adobe Premiere",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/premiere-no-shadow-48x48.png"},{full_name:"Acrobat Professional",name:"APRO",keywords:"Acrobat Professional",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/acrobat-dc-no-shadow-48x48.png"},{full_name:"Acrobat Pro Subs CC",name:"APCC",keywords:"Acrobat Pro",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/acrobat-dc-no-shadow-48x48.png"},{full_name:"Acrobat Pro DC",name:"APAP",keywords:"Acrobat DC",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/acrobat-dc-no-shadow-48x48.png"},{full_name:"Adobe Export PDF",name:"EPDF",keywords:"Export PDF",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/exportpdf-icon-webstore-50x50.png"},{full_name:"Acrobat Standard DC",name:"ACRS",keywords:"Acrobat Standard",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/acrobat-dc-no-shadow-48x48.png"},{full_name:"Acrobat",name:"ACRO",keywords:"Acrobat",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/acrobat-dc-no-shadow-48x48.png"},{full_name:"Adobe Stock Small",name:"STKS",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock Large",name:"STKL",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock Medium",name:"STKM",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock Medium",name:"STSM",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock",name:"STOS",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock Extended License",name:"STEL",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Adobe Stock",name:"CISK",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png"},{full_name:"Creative Cloud All Apps with Adobe Stock",name:"CTSK",keywords:"Adobe Stock",thumbnail_cayenne_url:"img/products/ccm-team.png"},{full_name:"Adobe Stock",name:"STOK",keywords:"Adobe Stock",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/stock-app-noshadow-48x48.png"},{full_name:"Acrobat Pro DC with Adobe Stock",name:"DCSK",keywords:"Acrobat Pro DC",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/acrobatpro-dc-50x50.png"},{full_name:"After Effects with Adobe Stock",name:"AESK",keywords:"After Effects",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/after-effects-no-shadow-48x48.png"},{full_name:"Adobe Audition with Adobe Stock",name:"AUSK",keywords:"Audition",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/audition-no-shadow-48x48.png"},{full_name:"Dreamweaver with Adobe Stock",name:"DWSK",keywords:"Dreamweaver",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/dreamweaver-no-shadow-48x48.png"},{full_name:"Animate CC with Adobe Stock",name:"FPSK",keywords:"Animate",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/animate-no-shadow-48x48.png"},{full_name:"Illustrator with Adobe Stock",name:"ILSK",keywords:"Illustrator",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/illustrator-no-shadow-48x48.png"},{full_name:"InCopy with Adobe Stock",name:"ILSK",keywords:"InCopy",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/incopy-48x48.png"},{full_name:"InDesign with Adobe Stock",name:"IDSK",keywords:"InDesign",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/indesign-no-shadow-48x48.png"},{full_name:"Adobe Muse with Adobe Stock",name:"MUSK",keywords:"Muse",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/muse-no-shadow-48x48.png"},{full_name:"Photoshop with Adobe Stock",name:"PHSK",keywords:"Photoshop",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/photoshop-no-shadow-48x48.png"},{full_name:"Adobe Premiere Pro with Adobe Stock",name:"PRSK",keywords:"Premiere Pro",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/premiere-no-shadow-48x48.png"},{full_name:"Creative Cloud Photography plan with Adobe Stock",name:"PPSK",keywords:"creative cloud photography",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png"},{full_name:"InCopy with Adobe Stock",name:"ICSK",keywords:"InCopy",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/incopy-48x48.png"},{full_name:"Font Folio Education Essentials 11",name:"FFEE",keywords:"Font Folio Essentials",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/store/product_boxshots/50x50/box_fontfolio11_50x50.png"},{full_name:"Adobe Presenter 11",name:"CPTL",keywords:"Adobe Presenter",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_presenter10_50x50.png"},{full_name:"Adobe Presenter Video Express 11",name:"PVX",keywords:"Adobe Presenter Video Express",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_pvx10_50x50.png"},{full_name:"Photoshop Elements & Adobe Premiere Elements",name:"PEPE",keywords:"Photoshop Elements",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_pse15pre15_50x50.png"},{full_name:"Photoshop Elements",name:"PSE",keywords:"Photoshop Elements",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_pse15_50x50.png"},{full_name:"Premiere Elements",name:"PRE",keywords:"Premiere Elements",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_pre15_50x50.png"},{full_name:"Adobe Send & Track",name:"SEND",keywords:"Send & Track",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/send-and-track-icon-webstore-50x50.png"},{full_name:"Story CC Plus",name:"STPL",keywords:"Story",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/adobe-story-48x48.png"},{full_name:"Flash Builder 4.5 for PHP Premium Edition",name:"FBZX",keywords:"Flash Builder",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/store/product_boxshots/50x50/box_flash_builder_45_premium_php_50x50.png"},{full_name:"Flash Builder 4.5 for PHP Standard Edition",name:"FBZS",keywords:"Flash Builder",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/store/product_boxshots/50x50/box_flash_builder_45_premium_php_50x50.png"},{full_name:"Flash Builder 4.5 for PHP Standard Edition",name:"FBZS",keywords:"Flash Builder",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/store/product_boxshots/50x50/box_flash_builder_45_premium_php_50x50.png"},{full_name:"InCopy CC",name:"AICY",keywords:"InCopy",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/incopy-48x48.png"},{full_name:"Adobe RoboHelp",name:"RBHP",keywords:"RoboHelp",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_rh2015_50x50.png"},{full_name:"Adobe RoboHelp Server 10",name:"RBSV",keywords:"RoboHelp Server",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/images/store/product_boxshots/50x50/box_rbsv10_50x50.png"},{full_name:"Adobe PDF Pack",name:"CPDF",keywords:"PDF Pack",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/pdfpack-icon-webstore-50x50.png"},{full_name:"InCopy CCM Team",name:"AICY",keywords:"InCopy",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/pdfpack-icon-webstore-50x50.png"},{full_name:"Behance Talent",name:"BHAN",keywords:"Behance Talent",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/behance-48x48.png"},{full_name:"Adobe FrameMaker",name:"FM",keywords:"Adobe FrameMaker",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_fm2015_50x50.png"},{full_name:"Adobe FrameMaker Publishing Server",name:"FMSV",keywords:"Adobe FrameMaker Publishing Server",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_fmps2015_50x50.png"},{full_name:"Technical Communication Suite",name:"ATST",keywords:"Technical Communication Suite",thumbnail_cayenne_url:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/50x50/box_tcs2015_50x50.png"}],NON_PRODUCT_IMG_SOURCE:"img/products/no-product.png"});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ProductRecordService",["$http","AppConstants","AppUtils","ApiHubRequestDto",function($http,AppConstants,AppUtils,ApiHubRequestDto){var service={};service.fillFromCrm=function(apiHubData,agentId){var apiHubRequestDto=angular.copy(ApiHubRequestDto);apiHubRequestDto.urlKey=AppConstants.API_HUB_URL_KEY_SAP_PRODUCTS_GET_PRODUCTS;apiHubRequestDto.requestBodyType=AppConstants.API_HUB_BODY_TYPE_XML;apiHubRequestDto.queryParameters={agent:agentId};apiHubRequestDto.requestBody=AppUtils.convertJsonToXmlText(apiHubData);return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubRequestDto})};service.fill=function(data){return $http({method:"POST",url:"../productRecordService/fillFromIps.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.fillForCCE=function(data){return $http({method:"POST",url:"../productRecordService/fillByOrg.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.fillForCCEWithIms=function(data){return $http({method:"POST",url:"../productRecordService/fillByOrgAndIms.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.fillForCCEWithImsV1=function(data){return $http({method:"POST",url:"../productRecordService/fillByOrgAndImsV1.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ProductService",["$http",function($http){var service={};service.nonSerialSearch=function(data){return $http({method:"POST",url:"../productService/nonSerialSearch.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getProductDetails=function(data){return $http({method:"POST",url:"../productService/getProductDetail.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getCceProductDetails=function(data){return $http({method:"POST",url:"../ccmEnterpriseProductService/get.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.transferLicense=function(transferData){return $http({method:"GET",url:"../productService/changeProductRegistrationOwner.do",params:{oldCustomerNo:transferData.oldCustomerNo,newCustomerNo:transferData.newCustomerNo,serialNo:transferData.serialNo,productGuid:transferData.productGuid,}})};service.search=function(productSearchData){return $http({method:"POST",url:"../productService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:productSearchData})};service.updateProduct=function(productData){return $http({method:"POST",url:"../productService/updateProduct.do",data:productData})};service.getEntitlementType=function(data){return $http({method:"POST",url:"../productService/getJanusProducts.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getSubscriptionEvents=function(data){return $http({method:"POST",url:"../productService/getSubEvents.do",headers:{"Content-Type":"application/json"},data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngPushMessage",[function(){return{restrict:"EA",replace:true,templateUrl:"js/common/partials/push-message.html",link:function(scope,element,attrs){}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("QuoteController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","TransactionUtil","TransactionConstants","OrderUtils","PaymentConstants","MetadataService","DocumentFlowService","InvoicePreviewService","webGuidFilterFilter","TransactionService","TransactionBuilder",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,TransactionUtil,TransactionConstants,OrderUtils,PaymentConstants,MetadataService,DocumentFlowService,InvoicePreviewService,webGuidFilterFilter,TransactionService,TransactionBuilder){TrackingService.trackPageView("Transaction","Quote View");$scope.quoteTransaction=angular.copy($scope.transaction);$scope.isUpdateOrderDisabled=true;$scope.isConvertToOrderBtnVisible=false;$scope.quoteCancellationReasons=[];$scope.quoteErrorMessage=[];$scope.serverErrorMessage=[];$scope.errorMessageHeader="";$scope.loadingMessage="";$scope.quoteCancellationSuccess=false;$scope.showDangerMessageOn=false;$scope.newQuoteTransactionDto;$scope.showPlaceOrderBtn=false;$scope.showRecreateQuoteBtn=false;$scope.orderStatusMessage="";var defaultCancellationReasonDto=function(){return{code:"16",label:""}};$scope.cancellationReasonDto=defaultCancellationReasonDto();$scope.checkTrackingInfo=function(){if($scope.transaction){if($scope.quoteTransaction.transactionType==TransactionConstants.TRANSACTION_QUOTATION||$scope.quoteTransaction.transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION){return false}if($scope.quoteTransaction.items&&$scope.quoteTransaction.items.length>0){for(var itemCount=0;itemCount<$scope.quoteTransaction.items.length;itemCount++){if($scope.quoteTransaction.items[itemCount].productType==TransactionConstants.HARD_GOOD_PRODUCT_TYPE){return true}}}}return false};$scope.checkOrderActions=function(){if($scope.transaction.actions){if($scope.transaction.actions.length>0){$scope.transactionOrderActionsHistory=$scope.transaction.actions}}};$scope.showOrderActions=function(){$scope.showOrderActionsContainer=!$scope.showOrderActionsContainer};$scope.hideOrderActions=function(){$scope.showOrderActionsContainer=false};$scope.convertToOrder=function(){$location.path("/quoteToOrder/"+$scope.quoteTransaction.transactionNumber);$location.reload()};$scope.resendQuote=function(){$scope.showLoading("Sending email");TransactionService.sendEmailConfirmation({transactionNumber:$scope.quoteTransaction.transactionNumber}).success(function(result){$scope.quoteErrorMessage=result;$scope.hideLoading();$scope.errorMessageHeader="Email Sent Confirmation";$("#errorMessageDialog").modal("show")}).error(function(error){$scope.hideLoading})};$scope.recreateQuote=function(){var newTransactionDto=TransactionBuilder.recreateTransactionFromCancelledOrder($scope.transaction);$scope.showLoading("Reviewing");TransactionService.reviewForRecreate(newTransactionDto).success(function(result){$scope.newQuoteTransactionDto=result;$scope.showDangerMessageOn=false;$scope.quoteTransaction=$scope.newQuoteTransactionDto;$scope.transaction=$scope.newQuoteTransactionDto;$scope.synchProductItemDetail($scope.newQuoteTransactionDto.items,newTransactionDto.items);$scope.showRecreateQuoteBtn=false;$scope.showPlaceOrderBtn=true;$scope.hideLoading();$scope.initializeOrderScreen()}).error(function(error){})};$scope.synchProductItemDetail=function(newProdItems,oldProdItems){angular.forEach(newProdItems,function(newItem){angular.forEach(oldProdItems,function(oldItem){if(newItem.sku==oldItem.sku){newItem.NewProp_productImg=oldItem.NewProp_productImg;newItem.NewProp_productName=oldItem.NewProp_productName}})})};$scope.placeOrder=function(){$scope.newQuoteTransactionDto.recreate=false;$scope.showLoading("Creating quote");TransactionService.create($scope.newQuoteTransactionDto).success(function(result){$scope.showPlaceOrderBtn=false;if(AppUtils.isHavingErrorMessage(result.messages)){$scope.orderStatusMessage="Quote  created with errors - please review. "}else{$scope.orderStatusMessage="Quote Placed Successfully. "}$scope.quoteTransaction=result;$scope.transaction=result;$scope.showRecreateQuoteBtn=false;$scope.showPlaceOrderBtn=false;$scope.hideLoading();$("#quoteStatusModal").modal("show");$scope.initializeOrderScreen()}).error(function(error){})};$scope.closeQuoteStatusModal=function(){$("#quoteStatusModal").modal("hide");$location.path("/transaction/"+$scope.transaction.transactionNumber);$location.reload()};$scope.showLoading=function(message){$scope.loadingMessage=message+"...";$("#quote-loading-modal").modal("show")};$scope.hideLoading=function(){$("#quote-loading-modal").modal("hide")};$scope.showQuoteCancellation=function(){TransactionService.lockTransaction({guid:$scope.quoteTransaction.transactionGuid}).success(function(result){if(AppUtils.isHavingErrorMessage(result)){$scope.quoteErrorMessage=result;$scope.errorMessageHeader="Workflow error";$("#errorMessageDialog").modal("show")}else{$scope.hideLoading();$("#quoteCancellationModal").modal("show")}}).error(function(error){})};$scope.closeErrorDialog=function(){$("#errorMessageDialog").modal("hide")};$scope.confirmQuoteCancellation=function(){$scope.showLoading("Cancelling");TransactionService.cancelNonSubscriptionOrder({transactionGuid:$scope.quoteTransaction.transactionGuid,cancelReasonCode:$scope.cancellationReasonDto.code}).success(function(result){$scope.quoteCancellationSuccess=true;$scope.hideLoading()}).error(function(error){console.log("error : "+error);$scope.quoteCancellationSuccess=false;$scope.serverErrorMessage=error;$scope.hideLoading();$("#serverErrorDialog").modal("show")})};$scope.closeServerErrorDialog=function(){$("#serverErrorDialog").modal("hide")};$scope.closeQuoteCancellationModal=function(){if($scope.quoteCancellationSuccess){$location.path("/transaction/"+$scope.quoteTransaction.transactionNumber);window.location.reload()}$("#quoteCancellationModal").modal("hide")};$scope.checkDocumentFlow=function(){if($scope.transaction){return[TransactionConstants.TRANSACTION_STANDARD_ORDER,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER].indexOf($scope.quoteTransaction.transactionType)>-1}return false};$scope.validateButtonVisibility=function(){if(!OrderUtils.isTransactionComplete($scope.quoteTransaction.statusLabel)){$scope.isConvertToOrderBtnVisible=true}};$scope.getTransactionStatusLabel=function(){if(typeof $scope.quoteTransaction.cancelCodeReason=="undefined"||$scope.quoteTransaction.cancelCodeReason==null||$scope.quoteTransaction.cancelCodeReason.length==0){return TransactionUtil.getStatusLabel($scope.quoteTransaction.statusLabel)}else{$scope.showDangerMessageOn=true;$scope.showRecreateQuoteBtn=true;return"Cancelled: "+MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_CANCELLATION_REASON],$scope.quoteTransaction.cancelCodeReason,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}};$scope.initializeOrderScreen=function(){$scope.isTrackingInfoShow=$scope.checkTrackingInfo();$scope.isDocumentFlowShow=$scope.checkDocumentFlow();$scope.trackingInfoList=OrderUtils.getTrackingInformationList($scope.quoteTransaction.items);$scope.isDeliveryMethodShow=OrderUtils.hasOnlyWiredItems($scope.quoteTransaction.items);$scope.isOnlyHardGoodOrder=OrderUtils.isOnlyHardGoodOrder($scope.quoteTransaction.items);$scope.isHavingHardGoodItem=OrderUtils.isHavingHardGoodItem($scope.quoteTransaction.items);$scope.isCcmTeam=OrderUtils.isCcmTeam($scope.quoteTransaction.items);$scope.isSubscriptionOrder=OrderUtils.isSubscriptionOrder($scope.transaction);$scope.checkOrderActions();$scope.quoteTransaction.reason.label=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],$scope.quoteTransaction.reason.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);$scope.transactionStatusLabel=$scope.getTransactionStatusLabel();$scope.quoteCancellationReasons=$scope.metadata[MetadataService.STORE_NAMES.ORDER_CANCELLATION_REASON];$scope.validateButtonVisibility()};$scope.initializeOrderScreen();$scope.showDocumentFlow=function(){$scope.showDocumentFlowContainer=!$scope.showDocumentFlowContainer;DocumentFlowService.get({guid:$scope.quoteTransaction.transactionGuid,transactionNo:$scope.quoteTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.documentFlowItemDtoList=result}).error(function(result){$scope.isLoading=false});if($scope.isSubscriptionOrder){DocumentFlowService.getBillingPlan({guid:$scope.quoteTransaction.transactionGuid,transactionNo:$scope.quoteTransaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});$scope.billingPlanDtoList=result}).error(function(result){$scope.isLoading=false})}};$scope.hideDocumentFlowContainer=function(){$scope.showDocumentFlowContainer=false};$scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter($scope.headerCustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};$scope.showTrackingInfo=function(){$scope.showTrackingInfoContainer=!$scope.showTrackingInfoContainer};$scope.hideTrackingInfo=function(){$scope.showTrackingInfoContainer=false};$scope.showCancelOrderModal=function(){$("#cancelOrderModal").modal("show")};$scope.closeCancelOrderModal=function(){$("#cancelOrderModal").modal("hide")};$scope.closeOrderEditView=function(){$("#cancelOrderModal").modal("hide");$scope.$emit(TransactionConstants.TRANSACTION_ORDER_VIEW_EVENT,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER)};$scope.updateQuote=function(){$scope.isUpdateTransactionSaving=true;TransactionService.update($scope.transaction).success(function(result){$scope.isUpdateTransactionSaving=false}).error(function(result){$scope.isUpdateTransactionSaving=false})}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngRegisterProduct",["Utils","AppUtils","MetadataService","SerialDecodeService","ProductService","$timeout","APOService","GCService","AppUtils","AppConstants","$rootScope",function(Utils,AppUtils,MetadataService,SerialDecodeService,ProductService,$timeout,APOService,GCService,AppUtils,AppConstants,$rootScope){return{restrict:"EA",scope:{customer:"=",customerdetail:"=",refresh:"&",contactNo:"=contactno"},replace:true,templateUrl:"js/customer/partials/register-product-popup.html",link:function(scope,element,attrs){scope.step=1;scope.antiPiracyNotGenuin;scope.templateName="";scope.apoMessage=[];scope.apoTemplateList=[{id:"hendrix_notification_antipiracy_notgenuine",description:"Send customer confirmation that their product is not genuine"},{id:"hendrix_notification_antipiracy_sendURL",description:"Send customer link to Adobe.com page"}];scope.genuineProductNameList=[{prodName:"Acrobat 8"},{prodName:"Acrobat 9"},{prodName:"Acrobat X"},{prodName:"Acrobat XI"},{prodName:"Acrobat DC"},{prodName:"Photoshop CS5"},{prodName:"Photoshop CS6"},{prodName:"Photoshop CC"}];scope.ccListForProd="agsw1@adobe.com";scope.ccListForNonProd="CSR-QE@adobe.com";scope.customerGuid="";scope.product={productName:null};var defaultAntiPiracySendUrlModal=function(){return jQuery.extend({},{email:"",landingPageUrl:""})};var defaultAntiPiracyNotGenuinModal=function(){return jQuery.extend({},{email:"",productName:"",productSerialNumber:""})};scope.antiPiracySendUrlModel=defaultAntiPiracySendUrlModal();scope.anitPiracyNotGenuinModal=defaultAntiPiracyNotGenuinModal();var handleValueChange=function(value){if(value){scope.customerLink2=Utils.customerLink2(scope.customerNo,scope.contactNo)}};var handleCustomerDetailChange=function(value){if(value){scope.antiPiracySendUrlModel.email=scope.customerdetail.email;scope.anitPiracyNotGenuinModal.email=scope.customerdetail.email;scope.customerGuid=AppUtils.getCustomerWebGUID(scope.customerdetail)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerNo},handleValueChange);scope.$watch(function(){return scope.customerdetail},handleCustomerDetailChange);var loadMetadata=function(){MetadataService.getProductNames().success(function(result){scope.productNames=result});MetadataService.getProductPlatforms().success(function(result){scope.productPlatforms=result});MetadataService.getProductLanguage().success(function(result){scope.productLanguages=result});MetadataService.getProductExternalVersions().success(function(result){scope.productVersions=result});MetadataService.getProductConfigurations().success(function(result){scope.productConfigurations=result})}();scope.showModal=function(){$("body").css("overflow","hidden");element.find("#registerProductModal").modal("show");scope.handleReset()};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#registerProductModal").modal("hide")};scope.updateBtn=function(val){if(val==1){scope.antiPiracyNotGenuin=true}else{scope.antiPiracyNotGenuin=false}};scope.sendEmail=function(val){var data;scope.apoMessage=[];if(val==1){data=scope.anitPiracyNotGenuinModal;scope.templateName="hendrix_notification_antipiracy_notgenuine"}else{data=scope.antiPiracySendUrlModel;scope.templateName="hendrix_notification_antipiracy_sendURL"}if(location.host.toLowerCase().indexOf("hendrixprod")>=0){data.ccList=scope.ccListForProd}else{data.ccList=scope.ccListForNonProd}APOService.sendEmail(data,scope.templateName).success(function(result){scope.apoMessage.push({info:true,error:false,warning:false,text:"email sent successfully"})}).error(function(error){scope.apoMessage.push({info:false,error:true,warning:false,text:"email was not successfully"})})};scope.handleSearch=function(){scope.isSearching=true;scope.messages=[];scope.selectedTabName=element.find("li.active a").first().text();if(scope.selectedTabName=="Serial Number"){SerialDecodeService.decode({serialNumber:scope.product.serialNumber}).success(function(result){scope.isSearching=false;if(result.messages&&result.messages.length>0){scope.messages=Utils.showCrmMessage(result.messages)}else{scope.productsFound=result;scope.step=2}scope.isSearching=false}).error(function(){scope.isSearching=false})}else{ProductService.nonSerialSearch({storeId:"S051",config:scope.product.configuration,mediaType:scope.product.mediaType,sku:scope.product.sku,name:scope.product.productName,platform:scope.product.platform,version:scope.product.version,language:scope.product.language}).success(function(result){if(result.messages&&result.messages.length>0){scope.messages=Utils.showCrmMessage(result.messages)}else{scope.productsFound=result;scope.step=2}scope.isSearching=false}).error(function(){scope.isSearching=false})}};scope.handleGoBack=function(){scope.step--};scope.handleProductSelection=function(idx,row){console.log(idx,row);scope.selectedProduct=row;scope.step++};scope.handleAddProduct=function(){scope.isAddingProduct=true;if(scope.selectedTabName=="Serial Number"){SerialDecodeService.register({customerNo:scope.customer,serialNumber:scope.product.serialNumber}).success(function(result){if(result.messages&&result.messages.length>0){scope.messages=Utils.showCrmMessage(result.messages);if(scope.messages[0].error){$timeout(function(){scope.handleReset()},5000)}else{$timeout(function(){scope.refresh();scope.closeModal()},5000)}}else{scope.refresh();scope.closeModal()}scope.isAddingProduct=false})}else{SerialDecodeService.nonSerialRegister({customerNo:scope.customer,sku:scope.selectedProduct.sku}).success(function(result){if(result.messages&&result.messages.length>0){scope.messages=Utils.showCrmMessage(result.messages);$timeout(function(){scope.refresh();scope.closeModal()},5000)}else{scope.refresh();scope.closeModal()}scope.isAddingProduct=false})}};scope.handleReset=function(){scope.product={};scope.messages=[];scope.step=1};scope.isValid=function(product){if(!product){return false}var selectedTabName=element.find("li.active a").first().text();if(selectedTabName=="Serial Number"&&product.serialNumber){return true}if(selectedTabName=="Multiple conditions"&&product.productName){return true}return false};scope.gidLookupResults;scope.gidLookUpSuccess=false;scope.serialNumberForCase="";scope.isLoading=false;scope.INVALID_DETECTEC_LICENSE_TYPE="Fail";scope.showGIDLookupModal=function(){element.find("#gidLookupModal").modal("show");scope.rescale()};scope.rescale=function rescale(){$("#gidLookupModal .modal-body").css({"max-height":"none","overflow-x":"hidden"})};scope.closeModal=function(){$("body").css("overflow","auto");element.find("#gidLookupModal").modal("hide")};var handleValueChange=function(value){if(value){scope.newCaseCustomerLink=Utils.newCaseCustomerLink(scope.customerdetail.customerNo,scope.contactNo)}};scope.$watch(function(){return scope.contactNo},handleValueChange);scope.$watch(function(){return scope.customerdetail},handleValueChange);scope.lookupGID=function(data){scope.gidLookUpSuccess=false;scope.gidLookupResults=[];scope.isLoading=true;GCService.getGIDDetails({gid:data}).success(function(result){scope.isLoading=false;scope.gidLookupResults=result;scope.isAllProductTempred=angular.isDefined(scope.gidLookupResults.hostfile_entries)&&angular.isArray(scope.gidLookupResults.hostfile_entries)&&scope.gidLookupResults.hostfile_entries.length>0;scope.gidLookupResults.serialStatus={};angular.forEach(scope.gidLookupResults.licenses,function(v){scope.gidLookupResults.serialStatus[v.serial_number]=v.detected_license_type});scope.gidLookUpSuccess=true;angular.forEach(scope.gidLookupResults.installed_products,function(data){data.isTampered=false;angular.forEach(data.binary_file_statuses,function(status){if(!(status.signed=="true")||scope.isAllProductTempred){data.isTampered=true}})});scope.findSerialNumberForCase();console.log(scope.gidLookupResults)}).error(function(result){scope.gidLookUpSuccess=false;scope.isLoading=false})};scope.findSerialNumberForCase=function(){var found=false;scope.isAllProductTempred=(angular.isDefined(scope.gidLookupResults.hostfile_entries)&&angular.isArray(scope.gidLookupResults.hostfile_entries)&&scope.gidLookupResults.hostfile_entries.length>0);angular.forEach(scope.gidLookupResults.installed_products,function(data){data.isTampered=false;data.os=scope.gidLookupResults.os;data.os_version=scope.gidLookupResults.os_version;data.country=scope.gidLookupResults.geography.country_name;data.city=scope.gidLookupResults.geography.region_name;angular.forEach(data.binary_file_statuses,function(status){if(status.signed=="false"||scope.isAllProductTempred){data.isTampered=true}})});angular.forEach(scope.gidLookupResults.licenses,function(v){if(v.detected_license_type==scope.INVALID_DETECTEC_LICENSE_TYPE&&!found){scope.serialNumberForCase=v.serial_number;found=true}});if(!found){angular.forEach(scope.gidLookupResults.installed_products,function(data){angular.forEach(data.binary_file_statuses,function(status){if((!(status.signed=="true")||scope.isAllProductTempred)&&!found){scope.serialNumberForCase=data.serial_numbers[0];found=false}})})}};scope.launchDRStore=function(customer){var drStoreData=new Object();drStoreData.adobeId=scope.customerdetail.adobeId;drStoreData.rengaId=AppUtils.getCustomerWebGUID(customer);drStoreData.locale=scope.customerdetail.address.country.drLocale;drStoreData.themeId=scope.customerdetail.address.country.drThemeId;drStoreData.siteId=scope.customerdetail.address.country.drSiteId;drStoreData.salesRepName=$rootScope.currentUser.username;drStoreData.firstName=scope.customerdetail.firstName;drStoreData.lastName=scope.customerdetail.lastName;drStoreData.street1=scope.customerdetail.address.street1;drStoreData.street2=scope.customerdetail.address.street2;drStoreData.street3=scope.customerdetail.address.street3;drStoreData.city=scope.customerdetail.address.city;drStoreData.state=scope.customerdetail.address.state;drStoreData.postCode=scope.customerdetail.address.postCode;drStoreData.countryCode=scope.customerdetail.address.country.code;drStoreData.countryName=scope.customerdetail.address.country.name;drStoreData.email=scope.customerdetail.email;drStoreData.phoneNumber=scope.customerdetail.telephone;drStoreData.mobileNo=scope.customerdetail.mobileNo;drStoreData.faxPhone=scope.customerdetail.fax;var url="/radon_java_webapp/drstore/index.html";var drStoreWindow=window.open(url,"DRStore","width=900,height=600,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left=0,top=0");drStoreWindow.focus();drStoreWindow.drStoreData=drStoreData};scope.createCSCase=function(rec){var returnCaseTemplateUr;scope.findSerialNumberForCase();returnCaseTemplateUr="/case/newCs?"+scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_GO_CART_CS_CASE_FOR_GID_LOOKUP+"&gid="+scope.gidId+"&gidSN="+rec.serial_numbers[0]+"&serialNumber="+scope.serialNumberForCase;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUr)}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("ReminderController",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","ReminderService","CustomerPreviewService","$timeout","LocalStorageService","Utils",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,ReminderService,CustomerPreviewService,$timeout,LocalStorageService,Utils){TrackingService.trackPageView("Callback","Callback");if($rootScope.returnUrl){$rootScope.returnUrl=null}Utils.pageTitle("Reminder");$scope.isLoading=true;$scope.customer={};$scope.showMessage=function(type,message){$scope.customer.messages=[];$scope.customer.messages.push({info:type=="info",error:type=="error",success:type=="success",text:message})};$scope.reminders=[];$scope.getReminders=function(){$scope.isLoading=true;var dataObj={userID:$scope.currentUser.username.toUpperCase()};ReminderService.loadReminders(dataObj).success(function(response){$scope.isLoading=false;$scope.reminders=response}).error(function(error){console.log("Error in loading reminders",error);$scope.isLoading=false;$scope.showMessage("error",error)})};$scope.openReminderDeleteModal=function(reminderID){$scope.reminderIdToDelete=reminderID;$("#deleteReminderModal").modal("show")};$scope.cancelReminderDeleteModal=function(){$("#deleteReminderModal").modal("hide")};$scope.deleteReminderLoading=false;$scope.deleteReminder=function(){$scope.deleteReminderLoading=true;var reminderID=$scope.reminderIdToDelete;console.log("Reminder to delete",reminderID);var dataObj={id:reminderID,userID:$scope.currentUser.username.toUpperCase()};ReminderService.removeReminder(dataObj).success(function(response){for(var i=0;i<$scope.reminders.length;i++){if($scope.reminders[i].id==reminderID){$scope.reminders.splice(i,1)}}$scope.deleteReminderLoading=false;$scope.cancelReminderDeleteModal();$rootScope.$broadcast("event:ReloadReminders")}).error(function(error){$scope.showMessage("error",error);console.log("Error in removing reminders",response);$scope.deleteReminderLoading=false})};$scope.getUserAndLoadReminders=function(){$timeout(function(){$scope.currentUser=$rootScope.currentUser;if(typeof $scope.currentUser=="undefined"){console.log("username not found");$scope.getUserAndLoadReminders();return}$scope.getReminders()},1000)};$scope.getUserAndLoadReminders();$scope.$on("event:ReminderAdded",function(){$scope.getReminders()});$scope.openAddReminder=function(){$("#addReminderModal").modal("show")}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ReminderService",["socket","$q","$http",function(socket,$q,$http){var service={};service.addReminder=function(data){return $http({method:"POST",url:"../reminderService/addReminder.do",data:data})};service.loadReminders=function(data){return $http({method:"GET",url:"../reminderService/getReminders.do?antiCache="+new Date().getTime().toString()})};service.removeReminder=function(data){return $http({method:"POST",url:"../reminderService/deleteReminder.do?reminderId="+data.id})};return service}]);"use strict";var app=app||angular.module("hxApp.services");app.directive("removeWhenFeature",function(features){return{restrict:"A",scope:{removeWhenFeature:"@removeWhenFeature"},link:function(scope,element){if((features.isFeatureEnabled(scope.removeWhenFeature))){element.remove()}}}});"use strict";var app=app||angular.module("hxApp.services");app.directive("requireFeature",function(features){return{restrict:"A",scope:{requireFeature:"@requireFeature"},link:function(scope,element){if(!(features.isFeatureEnabled(scope.requireFeature))){element.remove()}}}});app.directive("salesSelector",["$rootScope","SalesUtil","AppUtils","LocalStorageService","AppConstants","SalesConstants","$location","$timeout",function($rootScope,SalesUtil,AppUtils,LocalStorageService,AppConstants,SalesConstants,$location,$timeout){return{restrict:"EA",scope:{catalogRequestDto:"=",disableProductType:"=",isDrEnable:"="},replace:true,templateUrl:"js/sales/catalog/sales-selector-directive.html",link:function($scope,element,attrs){$scope.AppConstants=AppConstants;$scope.isLoaded=true;$scope.isReset=false;$scope.isCatalogView=true;$scope.$on(SalesConstants.SALES_RESET_CATALOG_SELECTOR_EVENT,function(event,catalogRequest){$scope.isReset=true;$scope.catalogRequestDto.country=catalogRequest.country;$scope.catalogRequestDto.marketSegment=catalogRequest.marketSegment;$scope.catalogRequestDto.modelCode=catalogRequest.modelCode;$scope.isLoaded=false;$timeout(function(){$scope.isLoaded=true},200)});$scope.$watch("catalogRequestDto.country",function(newValue,oldValue){$scope.salesMerketSegmentList=_.uniqBy(_.filter($scope.salesCountryList,{countryCode:$scope.catalogRequestDto.country}),"storeType");$scope.catalogRequestDto.countryName=$scope.salesMerketSegmentList.length>0?$scope.salesMerketSegmentList[0].country:$scope.catalogRequestDto.countryName;$scope.$parent.changeCountryChange(false);$scope.updateUrl()});$scope.$watch("catalogRequestDto.marketSegment",function(newValue,oldValue){$scope.updateUrl()});$scope.$watch("catalogRequestDto.modelCode",function(newValue,oldValue){if(newValue){}});$scope.$watch("catalogRequestDto.serviceCommitment",function(newValue,oldValue){if(newValue){}});$scope.getProductCatalogs=function(){$rootScope.$broadcast(SalesConstants.SALES_INVOKE_CATALOG_EVENT)};$scope.checkDrCountry=function(){if($scope.catalogRequestDto.country){var item=_.find($scope.salesCountryList,["countryCode",$scope.catalogRequestDto.country]);if(item){$scope.catalogRequestDto.isDrStore=item.isEnable?false:true;$rootScope.$broadcast(SalesConstants.SALES_DR_COUNTRY_SELECT_EVENT)}}};$scope.initializeSelectors=function(){$scope.salesCountryList=angular.copy(LocalStorageService.get("agentStoreProfile"));if(hendrixConfig&&hendrixConfig.drCountries){angular.forEach(_.sortBy(hendrixConfig.drCountries,"country"),function(drCountry){var country={code:drCountry.countryCode};if(AppUtils.isLaunchCctDRStoreEnable(country)){drCountry.country=drCountry.country.indexOf("(DR)")>0?drCountry.country:drCountry.country+" (DR)";$scope.salesCountryList.push(drCountry)}})}$scope.salesCountryUniqueList=_.sortBy(_.uniqBy(_.filter($scope.salesCountryList),"countryCode"),"country");if($scope.catalogRequestDto.country){var item=_.find($scope.salesCountryList,["countryCode",$scope.catalogRequestDto.country]);if(!item){$scope.catalogRequestDto.country="US"}}$scope.salesMerketSegmentList=_.filter($scope.salesCountryList,{countryCode:$scope.catalogRequestDto.country});if($scope.catalogRequestDto.serviceCommitment){if($scope.catalogRequestDto.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_YEAR&&$scope.catalogRequestDto.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_YEAR_PREPAID){$scope.catalogRequestDto.serviceCommitment=SalesConstants.SERVICE_COMMITMENT_M2M}}if($scope.catalogRequestDto.billingFrequency){if($scope.catalogRequestDto.billingFrequency!="ANNUAL"){$scope.catalogRequestDto.billingFrequency="MONTHLY"}}$scope.checkDrCountry();$scope.getProductCatalogs()};$scope.updateUrl=function(){$scope.checkDrCountry();$location.url(SalesUtil.replaceSalesPath($scope.catalogRequestDto));if($scope.isReset){$scope.isReset=false}else{$rootScope.$broadcast(SalesConstants.SALES_CHECK_CART_FOR_CATALOG_EVENT)}};$scope.initializeSelectors();$scope.skuSearchView=function(){$scope.isCatalogView=false;$scope.searchSku="";$rootScope.$broadcast(SalesConstants.SALES_SKU_SEARCH_CLEAR_PRODUCTS_EVENT,$scope.isCatalogView)};$scope.catalogView=function(){$scope.isCatalogView=true;$scope.$parent.catalogProducts=[];$scope.getProductCatalogs()};$scope.getSkuSearch=function(){$rootScope.$broadcast(SalesConstants.SALES_SKU_SEARCH_EVENT,$scope.searchSku)}}}}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesCatalogController",["$scope","$rootScope","SalesConstants","SalesServices","SalesUtil","AppUtils","$app","MetadataService","$http","StoreConstants","AppConstants","CustomerSubscriptionService","JilServices","features",function($scope,$rootScope,SalesConstants,SalesServices,SalesUtil,AppUtils,$app,MetadataService,$http,StoreConstants,AppConstants,CustomerSubscriptionService,JilServices,features){$scope.isSalesCatalogServiceLoading=true;$scope.isCommerceServiceLoading=$scope.isContractCartServiceLoading=false;$scope.salesCatalogCart={};$scope.ifCountryOrMarketOrProductTypeChange=false;$scope.catalogLanguageFilter="";$scope.isCatalogView=true;$scope.AppUtils=AppUtils;$scope.$on(SalesConstants.SALES_INVOKE_CATALOG_EVENT,function(event){$scope.getProductCatalogs()});$scope.$on(SalesConstants.SALES_SKU_SEARCH_CLEAR_PRODUCTS_EVENT,function(event,isCatalogView){$scope.catalogProducts=[];$scope.isCatalogView=isCatalogView});$scope.$on(SalesConstants.SALES_CHECK_CART_FOR_CATALOG_EVENT,function(event){$scope.checkCartForCatalogRequest()});$scope.$on(SalesConstants.SALES_VALIDATE_CATALOG_EVENT,function(event){$scope.validateCatalog()});$scope.$on(SalesConstants.SALES_CUSTOMER_RESET_EVENT,function(event){if($scope.orderServiceDto&&$scope.orderServiceDto["user-id"]){delete $scope.orderServiceDto["user-id"];$scope.orderServiceDto["order-id"]=$scope.orderServiceDto["order-number"]=""}$scope.initiateCreateOrder()});$scope.$on(SalesConstants.SALES_CHECK_PURCHASE_ELIGIBILITY_EVENT,function(event){$scope.checkProductForOrderCreation()});$scope.$on(SalesConstants.SALES_INITIATE_ORDER_EVENT,function(event){$scope.initiateCreateOrder()});$scope.$on(SalesConstants.SALES_SKU_SEARCH_EVENT,function(event,sku){$scope.getSkuSearch(sku)});$scope.checkCartForCatalogRequest=function(){if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.country&&$scope.catalogRequestDto.country!=$scope.selectedCustomerDetails.country){$scope.ifCountryOrMarketOrProductTypeChange=true;$scope.showSalesResetCart();return}if($scope.salesCatalogCartItems.length>0){if($scope.catalogRequestDto.country!=$scope.cartRequestDto.country||$scope.catalogRequestDto.marketSegment!=$scope.cartRequestDto.marketSegment||$scope.catalogRequestDto.modelCode!=$scope.cartRequestDto.modelCode){$scope.ifCountryOrMarketOrProductTypeChange=true;$scope.showSalesResetCart();return}}if($scope.catalogProducts&&$scope.catalogProducts.length>0){if($scope.catalogProducts[0].country!=$scope.cartRequestDto.country||$scope.catalogProducts[0].marketSegment!=$scope.cartRequestDto.marketSegment||$scope.catalogProducts[0].modelCode!=$scope.cartRequestDto.modelCode){$scope.catalogProducts=[]}}};$scope.getSkuSearch=function(sku){$scope.catalogProducts=[];if(sku.length){$scope.isSalesCatalogServiceLoading=true;$scope.isSalesCatalogServiceFailed=false;SalesServices.getOfferBySku({country:$scope.catalogRequestDto.country,marketSegment:$scope.catalogRequestDto.marketSegment,sku:sku}).success(function(result,status,headers,config){$scope.isSalesCatalogServiceLoading=false;$scope.isSalesCatalogServiceFailed=false;console.log(result);if(result&&result.subscriptionOffers){$scope.catalogFilteredProducts=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers,$scope.skuFilterList);angular.forEach($scope.catalogFilteredProducts,function(catalogProduct){$scope.catalogProducts.push(catalogProduct);if(catalogProduct.cartQtyLimit==1){catalogProduct.qtyList=[{qtyIndex:1,qtyValue:1}]}else{var qtyDDList=[];for(var count=0;count<catalogProduct.cartQtyLimit;count++){qtyDDList.push({qtyIndex:count+1,qtyValue:count+1})}catalogProduct.qtyList=qtyDDList}});var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_SDS,AppConstants.SERVICE_INVOKE_SKU_SEARCH,true,result);messageObject.Functionality="SKU Search";messageObject.Total_Products=$scope.catalogProducts.length;messageObject.Country=$scope.catalogRequestDto.country;messageObject.Market_Segment=$scope.catalogRequestDto.marketSegment;AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.catalogProducts=null}$scope.validateCatalog()}).error(function(result,status,headers,config){console.log(result);$scope.isSalesCatalogServiceLoading=false;$scope.isSalesCatalogServiceFailed=true;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_SDS,AppConstants.SERVICE_INVOKE_SKU_SEARCH,false,result);messageObject.Functionality="SKU Search";messageObject.Country=$scope.catalogRequestDto.country;messageObject.Market_Segment=$scope.catalogRequestDto.marketSegment;AppUtils.sendLogToServer(messageObject,status,headers,config)})}};$scope.getProductCatalogs=function(){$scope.isCatalogView=true;if($scope.salesCatalogCartItems.length>0){if($scope.catalogRequestDto.country!=$scope.cartRequestDto.country||$scope.catalogRequestDto.marketSegment!=$scope.cartRequestDto.marketSegment||$scope.catalogRequestDto.modelCode!=$scope.cartRequestDto.modelCode){$scope.ifCountryOrMarketOrProductTypeChange=true;$scope.showSalesResetCart();return}else{$scope.ifCountryOrMarketOrProductTypeChange=false}}else{$scope.ifCountryOrMarketOrProductTypeChange=false}$scope.catalogProducts=[];$scope.isSalesCatalogServiceLoading=true;if($scope.catalogRequestDto.serviceCommitment==SalesConstants.SERVICE_COMMITMENT_YEAR_PREPAID){$scope.catalogRequestDto.billingFrequency="ANNUAL"}else{if($scope.catalogRequestDto.serviceCommitment==SalesConstants.SERVICE_COMMITMENT_M2M){$scope.catalogRequestDto.billingFrequency="MONTHLY"}else{$scope.catalogRequestDto.billingFrequency=""}}$scope.isSalesCatalogServiceFailed=false;SalesServices.getProductsCatalog(SalesUtil.getCatalogRequestDto($scope.catalogRequestDto)).success(function(result,status,headers,config){$scope.isSalesCatalogServiceLoading=false;$scope.isSalesCatalogServiceFailed=false;if(result&&result.subscriptionOffers){$scope.catalogProducts=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers,$scope.skuFilterList);angular.forEach($scope.catalogProducts,function(catalogProduct){if(catalogProduct.cartQtyLimit==1){catalogProduct.qtyList=[{qtyIndex:1,qtyValue:1}]}else{var qtyDDList=[];for(var count=0;count<catalogProduct.cartQtyLimit;count++){qtyDDList.push({qtyIndex:count+1,qtyValue:count+1})}catalogProduct.qtyList=qtyDDList}});var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_SDS,AppConstants.SERVICE_INVOKE_GET_PRODUCT_CATALOG,true,result);messageObject.Functionality=($scope.catalogRequestDto.isDrStore?"DR ":"")+"Product Catalog - Product Selection";messageObject.Total_Products=$scope.catalogProducts.length;AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.catalogProducts=null}$scope.validateCatalog()}).error(function(result,status,headers,config){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_SDS,AppConstants.SERVICE_INVOKE_GET_PRODUCT_CATALOG,false,result);messageObject.Functionality=($scope.catalogRequestDto.isDrStore?"DR ":"")+"Product Catalog - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.isSalesCatalogServiceLoading=false;$scope.isSalesCatalogServiceFailed=true;$scope.catalogProducts=null})};$scope.addProductToCart=function(cartItem){var isItemFound=false;if(cartItem.businessSegment==SalesConstants.CATALOG_BUSINESS_CODE_INDIVIDUAL||cartItem.businessSegment==SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT){for(var itemCount=0;itemCount<$scope.salesCatalogCartItems.length;itemCount++){if(cartItem.materialId==$scope.salesCatalogCartItems[itemCount].materialId){isItemFound=true;break}}if(!isItemFound){cartItem.addToCartState=SalesConstants.ADD_TO_CART_ADDED;$scope.salesCatalogCartItems.push(cartItem)}}$scope.validateCatalog();if($scope.salesCatalogCartItems&&$scope.salesCatalogCartItems.length>0){$scope.initiateCreateOrder()}};$scope.updateSalesCart=function(cartItem){$scope.validateCatalog();if($scope.orderServiceDto&&(($scope.orderServiceDto["order-id"]&&!$scope.isCommerceServiceLoading)||($scope.orderServiceDto.cartId&&!$scope.isContractCartServiceLoading))){$scope.initiateCreateOrder()}else{if($scope.orderServiceDto&&(($scope.orderServiceDto.items&&$scope.orderServiceDto.items.length>0)||($scope.orderServiceDto.cartItems&&$scope.orderServiceDto.cartItems.length>0))){$scope.refreshCreateOrder()}}};$scope.validateCatalog=function(){$scope.cartRequestDto.country=$scope.catalogRequestDto.country;$scope.cartRequestDto.marketSegment=$scope.catalogRequestDto.marketSegment;$scope.cartRequestDto.modelCode=$scope.catalogRequestDto.modelCode;var isCommercialProduct=false,isEducationalProduct=false,isTeamProduct=false,isIndividualProduct=false,isOneYearPrepaid=false,isMonthlyPaid=false,isYearlyPaid=false;if($scope.salesCatalogCartItems.length>0){isCommercialProduct=$scope.salesCatalogCartItems[0].marketSegment==SalesConstants.MARKET_TYPE_COMMERCIAL?true:false;isEducationalProduct=$scope.salesCatalogCartItems[0].marketSegment==SalesConstants.MARKET_TYPE_EDUCATIONAL?true:false;if($scope.salesCatalogCartItems[0].businessSegment==SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT){isTeamProduct=true;$scope.$parent.isTeamSubscription=true}else{if($scope.salesCatalogCartItems[0].businessSegment==SalesConstants.CATALOG_BUSINESS_CODE_INDIVIDUAL){isIndividualProduct=true;$scope.$parent.isTeamSubscription=false}}if($scope.salesCatalogCartItems[0].serviceCommitment==SalesConstants.SERVICE_COMMITMENT_YEAR_PREPAID){isOneYearPrepaid=true}else{if($scope.salesCatalogCartItems[0].serviceCommitment==SalesConstants.SERVICE_COMMITMENT_M2M){isMonthlyPaid=true}else{if($scope.salesCatalogCartItems[0].serviceCommitment==SalesConstants.SERVICE_COMMITMENT_YEAR||$scope.salesCatalogCartItems[0].serviceCommitment==SalesConstants.SERVICE_COMMITMENT_FULL_YEAR){isYearlyPaid=true}else{isOneYearPrepaid=isMonthlyPaid=isYearlyPaid=false}}}}else{angular.forEach($scope.catalogProducts,function(catalogItem){catalogItem.addToCartState=SalesConstants.ADD_TO_CART_ENABLE})}angular.forEach($scope.catalogProducts,function(catalogProduct){if(isCommercialProduct&&catalogProduct.marketSegment!=SalesConstants.MARKET_TYPE_COMMERCIAL){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains Commercial Product(s), Educational products are not allowed"}else{if(isEducationalProduct&&catalogProduct.marketSegment!=SalesConstants.MARKET_TYPE_EDUCATIONAL){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains Educational Product(s), Commercial products are not allowed"}else{if(isTeamProduct&&catalogProduct.businessSegment!=SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains Team Product(s), Individual products are not allowed"}else{if(isIndividualProduct&&catalogProduct.businessSegment!=SalesConstants.CATALOG_BUSINESS_CODE_INDIVIDUAL){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains Individual Product(s), Team products are not allowed"}else{if(isOneYearPrepaid&&catalogProduct.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_YEAR_PREPAID){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains One-year, Prepaid product(s). Month-to-Month & One-year products are not allowed"}else{if(isMonthlyPaid&&catalogProduct.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_M2M){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains Month-to-Month product(s). One-year & One-year, Prepaid products are not allowed"}else{if(isYearlyPaid&&(catalogProduct.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_YEAR&&catalogProduct.serviceCommitment!=SalesConstants.SERVICE_COMMITMENT_FULL_YEAR)){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains One-year product(s). Month-to-Month & One-year, prepaid products are not allowed"}else{if(!catalogProduct.price){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Price is not available, please check the other product"}else{catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_ENABLE}}}}}}}}if($scope.salesCatalogCartItems.length>0){for(var cartItemCount=0;cartItemCount<$scope.salesCatalogCartItems.length;cartItemCount++){if(catalogProduct.materialId==$scope.salesCatalogCartItems[cartItemCount].materialId||catalogProduct.offerId==$scope.salesCatalogCartItems[cartItemCount].offerId){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_ADDED;continue}}for(var cartItemCount=0;cartItemCount<$scope.salesCatalogCartItems.length;cartItemCount++){if(catalogProduct.productCode==$scope.salesCatalogCartItems[cartItemCount].productCode){if($scope.salesCatalogCartItems[cartItemCount].isPromo&&catalogProduct.isPromo!=$scope.salesCatalogCartItems[cartItemCount].isPromo){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains promotional "+$scope.salesCatalogCartItems[cartItemCount].name+". Standard "+catalogProduct.name+" product is not allowed"}else{if(!$scope.salesCatalogCartItems[cartItemCount].isPromo&&catalogProduct.isPromo!=$scope.salesCatalogCartItems[cartItemCount].isPromo){catalogProduct.addToCartState=SalesConstants.ADD_TO_CART_DISABLE;catalogProduct.addToCartTitleMessage="Cart contains standard "+$scope.salesCatalogCartItems[cartItemCount].name+". Promotional "+catalogProduct.name+" product is not allowed"}}}}}})};$scope.calculateTotal=function(){$scope.salesCatalogCart.storeCartPriceTotal=0;$scope.salesCatalogCart.storeCartQtyTotal=0;if($scope.salesCatalogCartItems.length==0){$scope.orderServiceDto["base-total"]=0}angular.forEach($scope.orderServiceDto.items,function(cartItem){$scope.salesCatalogCart.storeCartPriceTotal=$scope.salesCatalogCart.storeCartPriceTotal+(Number(cartItem.price.displayPrice)*cartItem.qtySelected);$scope.salesCatalogCart.storeCartQtyTotal=Number($scope.salesCatalogCart.storeCartQtyTotal+cartItem.qtySelected);$scope.salesCatalogCart.storeCartCurrencySymbol=cartItem.currency.iso3code})};$scope.removeSalesCartItem=function(cartItemIndex){var removedCartItem=$scope.salesCatalogCartItems[cartItemIndex];$scope.salesCatalogCartItems.splice(cartItemIndex,1);if($scope.salesCatalogCartItems.length==0){$scope.orderServiceDto.items=[];if(!$scope.isDRStoreFlow){$scope.orderServiceDto["base-total"]=0;$scope.orderServiceDto["discount-total-with-tax"]=0}$scope.resetSalesCart()}else{$scope.refreshCreateOrder(removedCartItem)}};$scope.hideSalesResetCart=function(){$("#resetSalesCartModal").modal("hide");$scope.catalogRequestDto.country=$scope.cartRequestDto.country;$scope.catalogRequestDto.marketSegment=$scope.cartRequestDto.marketSegment;$scope.catalogRequestDto.modelCode=$scope.cartRequestDto.modelCode;$rootScope.$broadcast(SalesConstants.SALES_RESET_CATALOG_SELECTOR_EVENT,$scope.catalogRequestDto)};$scope.showSalesResetCart=function(){$("#resetSalesCartModal").modal("show")};$scope.resetSalesCart=function(){$scope.salesCatalogCartItems=[];if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.country&&angular.uppercase($scope.selectedCustomerDetails.country)!=angular.uppercase($scope.catalogRequestDto.country)){$scope.resetCustomer();location.reload(true)}if($scope.orderServiceDto&&$scope.orderServiceDto.items){$scope.orderServiceDto.items=[];if($scope.orderServiceDto.country!=$scope.catalogRequestDto.country||$scope.orderServiceDto["market-segment"]!=$scope.catalogRequestDto.marketSegment){$scope.catalogProducts=[];$scope.getProductCatalogs();$scope.orderServiceDto.cartId="";$scope.orderServiceDto.cartItem=[];$scope.orderServiceDto.country="";$scope.orderServiceDto.links=[];$scope.orderServiceDto.savings={};$scope.orderServiceDto.subTotal={};$scope.orderServiceDto.total={};$scope.orderServiceDto.currency={}}}$("#resetSalesCartModal").modal("hide");$scope.validateCatalog()};$scope.initiateCountryChange=function(){$("#resetSalesCartModal").modal("hide");setTimeout(function(){$("#countryChangeModal").modal("show");$scope.selectedCustomerDetails.rengaId=$scope.selectedCustomerDetails.userId;$rootScope.$broadcast("InitiateCountryChangeValidations",$scope.selectedCustomerDetails)},500)};$scope.$on("CHANGE_COUNTRY_MODEL_CANCEL",function(){$scope.hideSalesResetCart()});$scope.initiateCreateOrder=function(){if($scope.salesCatalogCartItems.length>0&&((!$scope.orderServiceDto["order-id"]&&!$scope.isCommerceServiceLoading)&&(!$scope.orderServiceDto.cartId&&!$scope.isContractCartServiceLoading))){$app.showLoading("Initializing Cart");var orderServiceDetailsObject={customer:$scope.selectedCustomerDetails,cartItems:$scope.salesCatalogCartItems,agentInfo:$rootScope.currentUser,goCartId:$scope.gid,countryInfo:$scope.catalogRequestDto};MetadataService.getCountrySpecificInfo({countryCode:orderServiceDetailsObject.countryInfo.country}).success(function(result){$scope.metadata.countrySpecificInfo=result});var initialOrderServiceDto;if($scope.isQuoteToOrder){initialOrderServiceDto=$scope.orderServiceDto}else{initialOrderServiceDto=SalesUtil.getInitialOrderServiceDto(orderServiceDetailsObject,$scope.orderServiceDto)}if($scope.isDRStoreFlow){$scope.isContractCartServiceLoading=true;initialOrderServiceDto=SalesUtil.getInitialOrderServiceDto(orderServiceDetailsObject,$scope.orderServiceDto);var contractCartDto=SalesUtil.getContractCartServiceDtoFromOrderServiceDto(initialOrderServiceDto);contractCartDto.lastModifiedById=$rootScope.currentUser.username;if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.userGuid){contractCartDto.ownerId=$scope.selectedCustomerDetails.userGuid;contractCartDto.ownerEmail=$scope.selectedCustomerDetails.email}else{contractCartDto.ownerId=$rootScope.currentUser.username}JilServices.createContractCart(contractCartDto).success(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();result=SalesUtil.getOrderServiceDtoFromContractCartServiceDto(result,initialOrderServiceDto);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,true,result);messageObject.Functionality="Initiating DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result)}).error(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,false,$.isPlainObject(result)?result:initialOrderServiceDto,salesErrorMessage);messageObject.Functionality="Initiating DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}else{$scope.isCommerceServiceLoading=true;SalesServices.createViaCommerce(initialOrderServiceDto).success(function(result,status,headers,config){$scope.isCommerceServiceLoading=false;$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Initiating Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result)}).error(function(result,status,headers,config){$scope.isCommerceServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:initialOrderServiceDto,salesErrorMessage);messageObject.Functionality="Initiating Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}}else{$scope.refreshCreateOrder()}};$scope.refreshCreateOrder=function(removedCartItem){if($scope.orderServiceDto&&$scope.salesCatalogCartItems.length>0&&(($scope.orderServiceDto["order-id"]&&!$scope.isCommerceServiceLoading)||($scope.orderServiceDto.cartId&&!$scope.isContractCartServiceLoading))){$app.showLoading("Updating Cart");var orderServiceDetailsObject={customer:$scope.selectedCustomerDetails,cartItems:$scope.salesCatalogCartItems,agentInfo:$rootScope.currentUser,goCartId:"",countryInfo:$scope.catalogRequestDto};var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify(SalesUtil.getInitialOrderServiceDto(orderServiceDetailsObject,$scope.orderServiceDto))};if($scope.isDRStoreFlow){var refreshOrderServiceDto=SalesUtil.getInitialContractCartServiceDto(orderServiceDetailsObject,$scope.orderServiceDto,removedCartItem);$scope.isContractCartServiceLoading=true;var contractCartDto=SalesUtil.getContractCartServiceDtoFromOrderServiceDto(refreshOrderServiceDto);contractCartDto.lastModifiedById=$rootScope.currentUser.username;if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.userGuid){contractCartDto.ownerId=$scope.selectedCustomerDetails.userGuid;contractCartDto.ownerEmail=$scope.selectedCustomerDetails.email}else{contractCartDto.ownerId=$rootScope.currentUser.username}JilServices.updateContractCart(contractCartDto).success(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();result=SalesUtil.getOrderServiceDtoFromContractCartServiceDto(result,$scope.orderServiceDto);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,true,result);messageObject.Functionality="Refreshing DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result)}).error(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,false,$.isPlainObject(result)?result:initialOrderServiceDto,salesErrorMessage);messageObject.Functionality="Refreshing DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}else{$scope.isCommerceServiceLoading=true;SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();$scope.isCommerceServiceLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Refreshing Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.validateCatalog();SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result)}).error(function(result,status,headers,config){$scope.isCommerceServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Refreshing Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}}};$scope.checkProductForOrderCreation=function(){if($scope.isCustomerInUrlValid&&$scope.customerId&&$scope.catalogRequestDto.modelCode==SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT){var validationInput={locale:"EN_US",customerGuid:$scope.customerId};$scope.checkPurchaseEligibilityInJil(validationInput)}else{$scope.isDRStoreFlow?$scope.processContractCart():$scope.checkCreateOrder()}};$scope.$on(SalesConstants.SALES_CHECK_CREATE_ORDER_EVENT,function(){if($scope.isQuoteToOrder){$scope.initiateCreateOrder();$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP);$rootScope.$broadcast("UpdateCustomerDetails",{custromerDetails:angular.copy($scope.selectedCustomerDetails),isCustomerInUrlValid:$scope.isCustomerInUrlValid,isQuoteAddressUpdateRequired:$scope.isQuoteAddressUpdateRequired,initializeWizard:false})}else{$scope.checkCreateOrder()}});$scope.checkCreateOrder=function(){if($scope.orderServiceDto&&$scope.salesCatalogCartItems.length>0&&$scope.orderServiceDto["order-id"]){$app.showLoading("Initializing Order");$scope.isQuote=false;$scope.initializeWizardHeaders($scope.isCustomerInUrlValid);var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};$scope.isCommerceServiceLoading=true;SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();$scope.isCommerceServiceLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Initializing Order - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result);if($scope.isCustomerInUrlValid){$scope.$parent.updateOrderService(result,SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)}else{$scope.$parent.updateOrderService(result,SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP)}}).error(function(result,status,headers,config){$app.hideLoading();$scope.isCommerceServiceLoading=false;var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Order Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Initializing Order - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}};$scope.processContractCart=function(){if($scope.orderServiceDto&&$scope.salesCatalogCartItems.length>0&&$scope.orderServiceDto.cartId){$scope.isContractCartServiceLoading=true;$app.showLoading("Processing Cart");var contractCartDto=SalesUtil.getContractCartServiceDtoFromOrderServiceDto($scope.orderServiceDto);contractCartDto.lastModifiedById=$rootScope.currentUser.username;if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.userGuid){contractCartDto.ownerId=$scope.selectedCustomerDetails.userGuid;contractCartDto.ownerEmail=$scope.selectedCustomerDetails.email}else{contractCartDto.ownerId=$rootScope.currentUser.username}JilServices.updateContractCart(contractCartDto).success(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();result=SalesUtil.getOrderServiceDtoFromContractCartServiceDto(result,$scope.orderServiceDto);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,true,result);messageObject.Functionality="Processing DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.$parent.updateOrderService(result,SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP)}).error(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,false,$.isPlainObject(result)?result:initialOrderServiceDto,salesErrorMessage);messageObject.Functionality="Processing DR Cart - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}};$scope.checkCreateQuote=function(){$app.showLoading("Initializing Quote");$scope.orderServiceDto.type="QUOTE";$scope.initiateQuoteFlow();var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};$scope.isCommerceServiceLoading=true;SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();$scope.isCommerceServiceLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Initializing Quote - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result);if($scope.isCustomerInUrlValid){$scope.$parent.updateOrderService(result,SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)}else{$scope.$parent.updateOrderService(result,SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP)}}).error(function(result,status,headers,config){$app.hideLoading();$scope.isCommerceServiceLoading=false;var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Quote Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Initializing Quote - Product Selection";AppUtils.sendLogToServer(messageObject,status,headers,config);if(headers&&headers()&&headers()["x-adobe-status"]){$scope.salesCatalogCartItems=[]}$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.isValidForChangeCountry=function(){if(angular.isDefined($scope.selectedCustomerDetails.country)){var customerCountry=$scope.selectedCustomerDetails.country.toLowerCase();if(features.isFeatureEnabled("cbc_teamflow")){return customerCountry!==$scope.catalogRequestDto.country.toLowerCase()&&AppUtils.isCommercialStore(customerCountry)&&AppUtils.isEducationalStore(customerCountry)&&$scope.isCustomerInUrlValid&&!$scope.catalogRequestDto.isDrStore&&$scope.selectedCustomerDetails.userId&&$scope.selectedCustomerDetails.email}else{return customerCountry!==$scope.catalogRequestDto.country.toLowerCase()&&AppUtils.isCommercialStore(customerCountry)&&AppUtils.isEducationalStore(customerCountry)&&$scope.isCustomerInUrlValid&&!$scope.catalogRequestDto.isDrStore&&$scope.selectedCustomerDetails.userId&&$scope.selectedCustomerDetails.email&&$scope.catalogRequestDto.modelCode===SalesConstants.CATALOG_BUSINESS_CODE_INDIVIDUAL}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("SalesCatalogDto",{name:"",longName:"",description:"",primaryImage:"",smallImage:"",bigImage:"",platformCode:"",version:"",languageCode:"",billingFrequency:"",currency:{},price:{},productCode:"",productKey:"",materialId:"",businessSegment:"",commitmentTerm:{},cartQuantityLimit:1});var app=app||angular.module("hxApp",["ngRoute"]);app.constant("SalesConstants",{SALES_INVOKE_CATALOG_EVENT:"SALES_INVOKE_CATALOG_EVENT",SALES_CHECK_CART_FOR_CATALOG_EVENT:"SALES_CHECK_CART_FOR_CATALOG_EVENT",SALES_RESET_CATALOG_SELECTOR_EVENT:"SALES_RESET_CATALOG_SELECTOR_EVENT",STORE_CREATE_NEW_CUSTOMER_EVENT:"STORE_CREATE_NEW_CUSTOMER_EVENT",SALES_PAYMENT_INITIALIZE_EVENT:"SALES_PAYMENT_INITIALIZE_EVENT",SALES_PAYMENT_REVIEW_EVENT:"SALES_PAYMENT_REVIEW_EVENT",SALES_TNC_INITIALIZE_EVENT:"SALES_TNC_INITIALIZE_EVENT",SALES_PLACE_ORDER_VIEW_EVENT:"SALES_PLACE_ORDER_VIEW_EVENT",SALES_ADD_PERPETUAL_PRODUCT_EVENT:"SALES_ADD_PERPETUAL_PRODUCT_EVENT",SALES_GET_NEW_CUSTOMER_EVENT:"SALES_GET_NEW_CUSTOMER_EVENT",SALES_QUOTE_REVIEW_EVENT:"SALES_QUOTE_REVIEW_EVENT",SALES_INITIATE_ORDER_EVENT:"SALES_INITIATE_ORDER_EVENT",SALES_CHECK_PURCHASE_ELIGIBILITY_EVENT:"SALES_CHECK_PURCHASE_ELIGIBILITY_EVENT",SALES_SKU_SEARCH_EVENT:"SALES_SKU_SEARCH_EVENT",SALES_PAYER_SELECT_EVENT:"SALES_PAYER_SELECT_EVENT",SALES_VALIDATE_CATALOG_EVENT:"SALES_VALIDATE_CATALOG_EVENT",SALES_CUSTOMER_RESET_EVENT:"SALES_CUSTOMER_RESET_EVENT",SALES_DR_COUNTRY_SELECT_EVENT:"SALES_DR_COUNTRY_SELECT_EVENT",SALES_SELECT_CUSTOMER_FROM_URL_EVENT:"SALES_SELECT_CUSTOMER_FROM_URL_EVENT",SALES_CATALOG_CREATE_ORDER_EVENT:"SALES_CATALOG_CREATE_ORDER_EVENT",SALES_INITIATE_ADD_SEAT_PRODUCT_EVENT:"SALES_INITIATE_ADD_SEAT_PRODUCT_EVENT",SALES_CONTINUE_ORDER_FLOW_EVENT:"SALES_CONTINUE_ORDER_FLOW_EVENT",SALES_BILLING_MISMATCHED_EVENT:"SALES_BILLING_MISMATCHED_EVENT",SALES_PURCHASE_ELIGIBILITY_ERROR_EVENT:"SALES_PURCHASE_ELIGIBILITY_ERROR_EVENT",SALES_CHECK_CREATE_ORDER_EVENT:"SALES_CHECK_CREATE_ORDER_EVENT",SALES_CHECK_ELIGIBILITY_VIA_COMMERCE:"SALES_CHECK_ELIGIBILITY_VIA_COMMERCE",SALES_TWO_TEAM_SUBSCRIPTIONS_FOUND:"SALES_TWO_TEAM_SUBSCRIPTIONS_FOUND",SALES_DIRECT_SALES:"DIRECT_SALES",SALES_SKU_SEARCH_EVENT:"SALES_SKU_SEAR_EVENT",SALES_SKU_SEARCH_CLEAR_PRODUCTS_EVENT:"SALES_SKU_SEARCH_CLEAR_PRODUCTS_EVENT",SALES_DR_CUSTOMER_SEARCH_EVENT:"SALES_DR_CUSTOMER_SEARCH_EVENT",SALES_WIZARD_PRODUCT_CATALOG_STEP:1,SALES_WIZARD_SELECT_CUSTOMER_STEP:2,SALES_WIZARD_CUSTOMER_DETAILS_STEP:3,SALES_WIZARD_NEW_CUSTOMER_STEP:7,SALES_WIZARD_PAYMENT_STEP:4,SALES_WIZARD_TNC_STEP:5,SALES_WIZARD_PLACE_ORDER_STEP:6,ADD_TO_CART_ENABLE:"ENABLE",ADD_TO_CART_DISABLE:"DISABLE",ADD_TO_CART_ADDED:"ADDED",CATALOG_BUSINESS_CODE_INDIVIDUAL:"INDIVIDUAL",CATALOG_BUSINESS_CODE_TEAM_DIRECT:"TEAM_DIRECT",CATALOG_BUSINESS_CODE_PERPETUAL:"PERPETUAL",MARKET_TYPE_COMMERCIAL:"COM",MARKET_TYPE_EDUCATIONAL:"EDU",PRODUCT_TYPE_DSP:"DSP",PRODUCT_TYPE_TEAM:"TEAM",PRODUCT_TYPE_ESD:"ESD",PRODUCT_TYPE_HGD:"HGD",SERVICE_COMMITMENT_YEAR_PREPAID:"YEAR_PREPAID",SERVICE_COMMITMENT_M2M:"MONTH",SERVICE_COMMITMENT_YEAR:"YEAR",SERVICE_COMMITMENT_FULL_YEAR:"FULL_YEAR",COUNTRIES_LOCALE:"US:EN,JA:JP,FR:FR,DE:DE",PAYMENT_CREDIT_CARD_TYPE:"CREDIT_CARD",PAYMENT_CREDIT_CARD_LABEL:"Credit Card",PAYMENT_DIRECT_DEBIT_TYPE:"DIRECT_DEBIT",PAYMENT_DIRECT_DEBIT_LABEL:"Direct Debit",PAYMENT_PAYPAL_TYPE:"PAYPAL",PAYMENT_PAYPAL_LABEL:"Paypal",PAYMENT_BANK_TRANSFER_TYPE:"BANK_TRANSFER",PAYMENT_BANK_TRANSFER_LABEL:"Bank Transfer",PAYMENT_CVS_TYPE:"CVS",PAYMENT_CVS_LABEL:"CVS",PAYMENT_PO_TYPE:"PO",PAYMENT_PO_LABEL:"Purchase Order",SAVED_PAYMENT_INSTRUMENT:"SAVED_PAYMENT_INSTRUMENT",ORDER_STATUS_IN_PTOGRESS:"IN_PROGRESS",ORDER_STATUS_SUBMIT:"SUBMITTED",INDIVIDUAL_PRODUCT_IMAGE:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png",TEAM_PRODUCT_IMAGE:"https://wwwimages2.adobe.com/content/dam/Adobe/images/shared/product_mnemonics/48x48/creativecloud-no-shadow-48x48.png",SDS_CHANNEL_HENDRIX:"hdx_offers",TNC_TEMPLATE_NAME_FOR_PO_PAYMENT:"tc_ccm_team_com_reg_po"});var app=app||angular.module("hxApp",["ngRoute"]);app.value("SalesContractCartRequestDto",{country:"",cartItems:[]});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesController",["$scope","$rootScope","$location","$routeParams","$app","$interpolate","AppUtils","AppConstants","SalesConstants","CatalogRequestDto","SalesUtil","MetadataService","SalesServices","ImsCustomerService","SFDCUtil","SFDCService","SFDCConstants","$q","CustomerSubscriptionService","CustomerPreviewService",function($scope,$rootScope,$location,$routeParams,$app,$interpolate,AppUtils,AppConstants,SalesConstants,CatalogRequestDto,SalesUtil,MetadataService,SalesServices,ImsCustomerService,SFDCUtil,SFDCService,SFDCConstants,$q,CustomerSubscriptionService,CustomerPreviewService){$scope.messages=[];$scope.wizardHeaderList=[];$scope.wizardStep=1;$scope.catalogRequestDto=angular.copy(CatalogRequestDto);$scope.cartRequestDto=angular.copy(CatalogRequestDto);$scope.sales=new Object();$scope.SalesConstants=SalesConstants;$scope.isSalesViewValid=$scope.isDRStoreFlow=$scope.isPaymentValid=$scope.isTermsAndConditionsAccepted=$scope.isTeamSubscription=$scope.isQuote=$scope.isQuoteToOrder=$scope.isCustomerInUrlValid=false;$scope.salesCatalogCartItems=[];$scope.orderServiceDto=new Object();$scope.paymentDetailsForSelection=new Object();$scope.selectedPaymentMethod;$scope.selectedCustomerDetails=new Object();$scope.selectedPayerDetails=new Object();$scope.customerDto;$scope.AppUtils=AppUtils;$scope.searchingCustomerInCrm=false;$scope.salesErrorMessage={title:"",errors:[]};$scope.salesConfig=_.has(hendrixConfig,"sales")?hendrixConfig.sales:{};$scope.customerOldCountry="";$scope.storeName=angular.uppercase($routeParams.store);$scope.customerId=$routeParams.id;$scope.productType=angular.uppercase($routeParams.productType);$scope.quoteId=$routeParams.quote;$scope.isCountryChange=false;$scope.enableAll=$routeParams.enableAll&&$routeParams.enableAll=="true"?true:false;$scope.gid=$routeParams.gid;$scope.serialNumberForCase=$routeParams.serialNumber;$scope.commitment=angular.uppercase($routeParams.commitment);$scope.billing=angular.uppercase($routeParams.billing);$scope.isSFDCFLow=angular.isDefined($routeParams.asynchId)&&$routeParams.asynchId.length>0?true:false;$scope.isSFDCCustomerNew=angular.isDefined($routeParams.isNewCustomer)&&$routeParams.isNewCustomer=="true"?true:false;$scope.sfdcCustomerAddress;$scope.saccountID=$routeParams.saccountID;$scope.scontactID=$routeParams.scontactID;$scope.sopportunityID=$routeParams.sopportunityID;$scope.asynchId=$routeParams.asynchId;$scope.isSFDCAddressUpdateDone=false;$scope.isQuoteAddressUpdateRequired=false;$scope.$on(SalesConstants.SALES_DR_COUNTRY_SELECT_EVENT,function(event){$scope.isDRStoreFlow=$scope.catalogRequestDto.isDrStore;$scope.initializeWizardHeaders($scope.isCustomerInUrlValid)});if($scope.isSFDCFLow&&$scope.customerId&&$scope.customerId.length>0){$scope.catalogFilter="team";AppUtils.sendLogToServer("SFDC:Catalog flow loaded for SFDC opportunity: "+$scope.sopportunityID+",accountId:"+$scope.saccountID+",contactID:"+$scope.scontactID+",asynchId:"+$scope.asynchId)}$scope.loadSFDCDetail=function(){var accountQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_ACCOUNT_QUERY,$routeParams.saccountID);var contactQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_CONTACT_QUERY,$routeParams.scontactID);var parallelCalls=[];parallelCalls.push(SFDCService.loadAccount({accountQuery:accountQuery}).success(function(result){$scope.accountDetails=result.records[0];AppUtils.sendLogToServer("SFDC:Catalog flow:: account loaded: "+$routeParams.saccountID)}).error(function(error){$scope.isLoadingAccount=false}));parallelCalls.push(SFDCService.loadContact({contactQuery:contactQuery}).success(function(result){$scope.contactDetails=result.records[0];$scope.isHendrixAccountLoading=true;AppUtils.sendLogToServer("SFDC:Catalog flow:: contact loaded: "+$routeParams.scontactID)}).error(function(error){$scope.isLoadingContact=false}));$q.all(parallelCalls).then(function(value){$scope.sfdcCustomerAddress=SFDCUtil.getCustomerDto($scope.accountDetails,$scope.contactDetails,null);if(!$scope.isSFDCAddressUpdateDone&&angular.isDefined($scope.selectedCustomerDetails.userId)&&$scope.selectedCustomerDetails.userId.length>0){$scope.selectedCustomerDetails.address=$scope.sfdcCustomerAddress.address;$scope.selectedCustomerDetails.companyName=$scope.accountDetails.Name}AppUtils.sendLogToServer("SFDC:Catalog flow:: SFDC detail loaded for opportunity and contact "+$routeParams.scontactID)},function(reason){console.log("All call fail");AppUtils.sendLogToServer("SFDC:Catalog flow:: load contact and account detail error ")})};if($scope.isSFDCFLow&&$scope.customerId&&$scope.customerId.length>0){$scope.loadSFDCDetail()}AppUtils.initializeModule(AppConstants.MODULE_SALES,function(metadataObject,moduleStatus){$scope.metadata=metadataObject;if(moduleStatus==AppConstants.MODULE_INIT_METADATA_SUCCESS){console.info("Sales Module Metadata Loaded Successfully");$scope.processModule()}else{if(moduleStatus==AppConstants.MODULE_INIT_METADATA_FAILED){console.error("Error loading metadata in Sales Module")}else{console.error("Sales Module - Unexpected Error, Please reload the application")}}});$scope.processModule=function(){SalesServices.getOrderExceptions().success(function(result){$scope.orderServiceExceptions=result}).error(function(result){});SalesServices.getSkuFilterList().success(function(result){$scope.skuFilterList=result}).error(function(result){});if($scope.quoteId&&$scope.quoteId.length>5){if(!isNaN($scope.quoteId)){SalesServices.getCrmQuote({guid:"",number:$scope.quoteId,subscriptionId:""}).success(function(result,status,headers,config){if(result&&result.transactionType==AppConstants.TRANSACTION_TYPE_SUBSCRIPTION_QUOTE){$scope.orderServiceDto=SalesUtil.getOrderServiceDtoFromTransactionDto(result);$scope.orderServiceDto.telesales.agent.id=$rootScope.currentUser.username;$scope.orderServiceDto.telesales.agent["first-name"]=$rootScope.currentUser.firstName;$scope.orderServiceDto.telesales.agent["last-name"]=$rootScope.currentUser.lastName;var customerObj={email:result.customer.adobeId};ImsCustomerService.getItem(customerObj).success(function(result,status,headers,config){if(!$.isArray(result)&&result.userId){$scope.orderServiceDto["user-id"]=result.userId.replace(/@AdobeID/i,"")}$scope.processQuote()}).error(function(error,status,headers,config){$scope.processQuote()})}else{$scope.orderServiceDto={};$scope.checkSalesView()}}).error(function(result,status,headers,config){$scope.orderServiceDto={};$scope.checkSalesView()})}else{SalesServices.getQuoteDetails($scope.quoteId).success(function(result,status,headers,config){$scope.orderServiceDto=SalesUtil.getOrderServiceDtoFromQuoteDto(result,$rootScope.currentUser);$scope.catalogRequestDto.country=$scope.orderServiceDto.country;$scope.catalogRequestDto.marketSegment=$scope.orderServiceDto["market-segment"];$scope.productType=$scope.catalogRequestDto.modelCode=SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT;if(_.has($scope.orderServiceDto,"payment-instrument.billing-address.contact.primary-email")){var customerObj={email:$scope.orderServiceDto["payment-instrument"]["billing-address"]["contact"]["primary-email"]};ImsCustomerService.getItem(customerObj).success(function(result,status,headers,config){if(!$.isArray(result)&&result.userId){$scope.orderServiceDto["user-id"]=result.userId.replace(/@AdobeID/i,"")}$scope.processQuote()}).error(function(error,status,headers,config){$scope.processQuote()})}else{$scope.processQuote()}}).error(function(result,status,headers,config){$scope.orderServiceDto={};$scope.checkSalesView()})}}else{$location.search("quote",null);$scope.isQuoteToOrder=false;$scope.checkSalesView()}};$scope.processQuote=function(){if($scope.orderServiceDto.status==AppConstants.ORDER_SERVICE_IN_PROGRESS){$scope.storeName=$scope.orderServiceDto.country+($scope.orderServiceDto["market-segment"]=="EDU"?"-EDU":"");$scope.customerId=$scope.orderServiceDto["user-id"]?$scope.orderServiceDto["user-id"]:"";$scope.isQuoteToOrder=true;var itemCount=0;$scope.salesCatalogCartItems=[];angular.forEach($scope.orderServiceDto.items,function(item){if(item["offer-id"]){SalesServices.getOfferByOfferId({country:$scope.orderServiceDto.country,marketSegment:$scope.orderServiceDto["market-segment"],offerId:item["offer-id"]}).success(function(result,status,headers,config){itemCount=itemCount+1;if(result){item.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0];if(item.cartInfo.cartQtyLimit==1){item.cartInfo.qtyList=[{qtyIndex:1,qtyValue:1}]}else{var qtyDDList=[];for(var count=0;count<item.cartInfo.cartQtyLimit;count++){qtyDDList.push({qtyIndex:count+1,qtyValue:count+1})}item.cartInfo.qtyList=qtyDDList}$scope.salesCatalogCartItems.push(item.cartInfo)}if(itemCount==$scope.orderServiceDto.items.length){$scope.checkSalesView()}}).error(function(result,status,headers,config){item.cartInfo=null})}else{SalesServices.getOfferBySku({country:$scope.orderServiceDto.country,marketSegment:$scope.orderServiceDto["market-segment"],sku:item.sku.id,locale:"en_US"}).success(function(result,status,headers,config){itemCount=itemCount+1;if(result){item.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0];if(item.cartInfo.cartQtyLimit==1){item.cartInfo.qtyList=[{qtyIndex:1,qtyValue:1}]}else{var qtyDDList=[];for(var count=0;count<item.cartInfo.cartQtyLimit;count++){qtyDDList.push({qtyIndex:count+1,qtyValue:count+1})}item.cartInfo.qtyList=qtyDDList}$scope.salesCatalogCartItems.push(item.cartInfo)}if(itemCount==$scope.orderServiceDto.items.length){$scope.checkSalesView()}}).error(function(result,status,headers,config){item.cartInfo=null})}})}else{if($scope.orderServiceDto.status==AppConstants.ORDER_SERVICE_SUBMITTED){}else{$scope.checkSalesView()}}};$scope.checkSalesView=function(){$scope.isSalesViewValid=$scope.isValid();if($scope.isSalesViewValid){if($scope.customerId&&$scope.customerId.length>1){var regEmail=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(regEmail.test($scope.customerId)){$scope.initializeWizardHeaders("false");$app.hideLoading()}else{var customerDetailsRequestObj={guid:$scope.customerId,authSrc:"AdobeID"};ImsCustomerService.getCustomerProfileByGuid(customerDetailsRequestObj).success(function(response){if(response.error||response.account_type!="type1"||angular.uppercase(response.countryCode)!=angular.uppercase($scope.catalogRequestDto.country)){$scope.isCustomerInUrlValid=false;$location.search("id","");$scope.selectedCustomerDetails={}}else{$scope.isCustomerInUrlValid=true;if($scope.isQuoteToOrder){$scope.isQuoteAddressUpdateRequired=true}$scope.selectedCustomerDetails=SalesUtil.getCustomerDetailsData(true,response);if($scope.isSFDCFLow&&angular.isDefined($scope.sfdcCustomerAddress)&&angular.isDefined($scope.sfdcCustomerAddress.address)){$scope.selectedCustomerDetails.address=$scope.sfdcCustomerAddress.address;$scope.selectedCustomerDetails.companyName=$scope.accountDetails.Name;$scope.isSFDCAddressUpdateDone=true}}$scope.initializeWizardHeaders($scope.isCustomerInUrlValid);$app.hideLoading()}).error(function(errorData){$scope.isCustomerInUrlValid=false;console.log("Error in getting customer details",errorData);$scope.initializeWizardHeaders($scope.isCustomerInUrlValid);$app.hideLoading()})}}else{$scope.isCustomerInUrlValid=false;$scope.initializeWizardHeaders($scope.isCustomerInUrlValid);$app.hideLoading()}}};$scope.isValid=function(){var storeCountryCode=$scope.storeName?$scope.storeName.substring(0,2):AppConstants.COUNTRY_CODE_US;var storeType=$scope.storeName?$scope.storeName.indexOf("EDU")==3?AppConstants.MARKET_TYPE_EDUCATIONAL:AppConstants.MARKET_TYPE_COMMERCIAL:AppConstants.MARKET_TYPE_COMMERCIAL;var countryMetadata=_.find($scope.metadata.countries,["code",storeCountryCode]);var storeMetadata=_.find($scope.metadata.allStores,{countryCode:storeCountryCode,storeType:storeType});$scope.catalogRequestDto.country=storeCountryCode;$scope.catalogRequestDto.marketSegment=storeType;if($scope.isSFDCFLow){$scope.catalogRequestDto.modelCode=$scope.productType?angular.uppercase($scope.productType):AppConstants.PRODUCTS_MODEL_CODE_TEAM_DIRECT}else{$scope.catalogRequestDto.modelCode=$scope.productType?angular.uppercase($scope.productType):AppConstants.PRODUCTS_MODEL_CODE_INDIVIDUAL}$scope.catalogRequestDto.serviceCommitment=$scope.commitment?angular.uppercase($scope.commitment):"YEAR_PREPAID";$scope.catalogRequestDto.billingFrequency=$scope.billing?angular.uppercase($scope.billing):"ANNUAL";if(countryMetadata){if(countryMetadata.selling&&(storeType==AppConstants.MARKET_TYPE_COMMERCIAL?AppUtils.isCommercialStore(countryMetadata.code):AppUtils.isEducationalStore(countryMetadata.code))){$scope.currentStore=SalesUtil.getCurrentStoreData($scope.storeName,countryMetadata,storeMetadata);return true}else{if(_.find(hendrixConfig.drCountries,["countryCode",$scope.catalogRequestDto.country])){var drData=_.find(hendrixConfig.drCountries,["countryCode",$scope.catalogRequestDto.country]);$scope.currentStore=SalesUtil.getCurrentDrStoreData($scope.storeName,countryMetadata,drData);return true}else{$scope.messages=$app.getMessages(AppConstants.ALERT_MESSAGE_ERROR_TYPE,"Store Is Currently Not Available For This Country");return false}}}else{$scope.messages=$app.getMessages(AppConstants.ALERT_MESSAGE_ERROR_TYPE,"Store Is Invalid.");return false}return true};$scope.reInitializeWizardHeaders=function(isCustomerInUrlValid){$scope.isCustomerInUrlValid=isCustomerInUrlValid;$scope.wizardHeaderList=[];if($scope.isQuoteToOrder){if(!$scope.isCustomerInUrlValid){$scope.wizardHeaderList.push({title:"Search Customer",stepNumber:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP})}$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}else{$scope.wizardHeaderList.push({title:"Product Selection",stepNumber:SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP});if($scope.sales.customer||$scope.isCustomerInUrlValid){$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});if($scope.isQuote){$scope.wizardHeaderList.push({title:"Place Quote",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}else{$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}}else{$scope.wizardHeaderList.push({title:"Search Customer",stepNumber:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP});$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});if($scope.isQuote){$scope.wizardHeaderList.push({title:"Place Quote",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}else{$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}}}};$scope.initializeWizardHeaders=function(isCustomerInUrlValid){$scope.isCustomerInUrlValid=isCustomerInUrlValid;$scope.wizardHeaderList=[];if($scope.isQuoteToOrder&&$scope.salesCatalogCartItems.length>0){if(!$scope.isCustomerInUrlValid){$scope.wizardHeaderList.push({title:"Search Customer",stepNumber:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP})}$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP});if($scope.isCustomerInUrlValid){$rootScope.$broadcast(SalesConstants.SALES_CHECK_PURCHASE_ELIGIBILITY_EVENT)}else{$rootScope.$broadcast(SalesConstants.SALES_INITIATE_ORDER_EVENT);$scope.setWizardStep(SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP)}}else{if($scope.isDRStoreFlow){$scope.wizardHeaderList.push({title:"Product Selection",stepNumber:SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP});if(!$scope.isCustomerInUrlValid){$scope.wizardHeaderList.push({title:"Search Customer",stepNumber:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP})}}else{$scope.wizardHeaderList.push({title:"Product Selection",stepNumber:SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP});if($scope.sales.customer||$scope.isCustomerInUrlValid){$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});if($scope.isQuote){$scope.wizardHeaderList.push({title:"Place Quote",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}else{$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}}else{$scope.wizardHeaderList.push({title:"Search Customer",stepNumber:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP});$scope.wizardHeaderList.push({title:"Billing Details",stepNumber:SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP});if($scope.isQuote){$scope.wizardHeaderList.push({title:"Place Quote",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}else{$scope.wizardHeaderList.push({title:"Payment",stepNumber:SalesConstants.SALES_WIZARD_PAYMENT_STEP});$scope.wizardHeaderList.push({title:"T&C",stepNumber:SalesConstants.SALES_WIZARD_TNC_STEP});$scope.wizardHeaderList.push({title:"Place Order",stepNumber:SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP})}}}}};$scope.setWizardStep=function(stepNumber){if(stepNumber){$scope.wizardStep=stepNumber}};$scope.initiateQuoteFlow=function(){$scope.isQuote=true;$scope.initializeWizardHeaders($scope.isCustomerInUrlValid)};$scope.updateOrderService=function(orderService,wizardStep){$scope.orderServiceDto=orderService;$scope.paymentDetailsForSelection=angular.copy(SalesUtil.getPaymentDetails($scope.orderServiceDto));if(!$scope.selectedPaymentMethod){$scope.selectedPaymentMethod=$scope.paymentDetailsForSelection.paymentInstruments[0]}$scope.setWizardStep(wizardStep);if(wizardStep==SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP){$rootScope.$broadcast(SalesConstants.SALES_CATALOG_CREATE_ORDER_EVENT)}else{if(wizardStep==SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP){$scope.orderServiceDto["user-id"]=$scope.selectedCustomerDetails.userId.replace(/@AdobeID/i,"");$rootScope.$broadcast("UpdateCustomerDetails",{custromerDetails:angular.copy($scope.selectedCustomerDetails),isCustomerInUrlValid:$scope.isCustomerInUrlValid})}else{if(wizardStep==SalesConstants.SALES_WIZARD_TNC_STEP){$rootScope.$broadcast(SalesConstants.SALES_TNC_INITIALIZE_EVENT)}}}};$scope.updateSelectCustomer=function(customerData){$scope.orderServiceDto["user-id"]=customerData.rengaId.replace(/@AdobeID/i,"")};$scope.updateCustomer=function(customerData){$scope.orderServiceDto["payment-instrument"]["billing-address"]=SalesUtil.getCustomerDto(customerData);$scope.orderServiceDto["user-id"]=customerData.userId.replace(/@AdobeID/i,"");if($scope.isQuote){$rootScope.$broadcast(SalesConstants.SALES_QUOTE_REVIEW_EVENT)}else{$scope.setWizardStep(SalesConstants.SALES_WIZARD_PAYMENT_STEP);$rootScope.$broadcast(SalesConstants.SALES_PAYMENT_INITIALIZE_EVENT)}};$scope.updatePaymentValidStatus=function(isPaymentValid){$scope.isPaymentValid=isPaymentValid};$scope.updateSelectedPaymentMethod=function(paymentMethod){$scope.selectedPaymentMethod=angular.copy(paymentMethod)};$scope.reviewPayment=function(){$rootScope.$broadcast(SalesConstants.SALES_PAYMENT_REVIEW_EVENT)};$scope.updateTermsAndConditions=function(status){$scope.isTermsAndConditionsAccepted=status;if(status){$rootScope.$broadcast(SalesConstants.SALES_PLACE_ORDER_VIEW_EVENT);$scope.setWizardStep(SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP)}};$scope.goBackFromSearchCustomer=function(){$scope.wizardStep=SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP};$scope.goNextFromSearchCustomer=function(){$scope.wizardStep=SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP};$scope.goBackFromCustomerDetail=function(){$scope.wizardStep=$scope.isCustomerInUrlValid?SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP:SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP};$scope.goBackFromPaymentDetail=function(){$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)};$scope.goBackFromTnC=function(){$scope.setWizardStep(SalesConstants.SALES_WIZARD_PAYMENT_STEP)};$scope.goBackFromPlaceOrder=function(){$scope.isQuote?$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP):$scope.setWizardStep(SalesConstants.SALES_WIZARD_TNC_STEP)};$scope.showSalesMessagesModal=function(errorMessages){$scope.salesErrorMessage=errorMessages;$("#salesMessagesModal").modal("show")};$scope.closeSalesMessagesModal=function(){$scope.salesErrorMessage="";$("#salesMessagesModal").modal("hide")};$scope.showResetCustomer=function(){$("#salesResetCustomerModal").modal("show")};$scope.hideResetCustomer=function(){$("#salesResetCustomerModal").modal("hide")};$scope.hideDrSuccessCart=function(){$("#drCartSuccessModal").modal("hide")};$scope.showDrSuccessResetCart=function(){$("#drCartSuccessModal").modal("show")};$scope.gotoSalesCatalogFromDr=function(){location.reload()};$scope.gotoHendrixHome=function(){$location.path("/search")};$scope.gotoCustomerDetail=function(){var url="/customer/"+$scope.customerNoForDr;window.open(AppUtils.getApplicationUrl()+url+"/subscriptions")};$scope.resetCustomer=function(){$scope.setWizardStep(SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP);$scope.selectedCustomerDetails=new Object();$scope.isCustomerInUrlValid=false;if($scope.orderServiceDto&&$scope.orderServiceDto["user-id"]){delete $scope.orderServiceDto["user-id"];delete $scope.orderServiceDto["order-id"];delete $scope.orderServiceDto["order-number"]}SalesUtil.removeParameterFromUrl("id");$scope.initializeWizardHeaders($scope.isCustomerInUrlValid);$scope.hideResetCustomer();$rootScope.$broadcast(SalesConstants.SALES_CUSTOMER_RESET_EVENT)};$scope.getMessageLoggingObject=function(sourceSystem,serviceCategory,isSuccess,result,errors){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL_SDS&&serviceCategory==AppConstants.SERVICE_INVOKE_GET_PRODUCT_CATALOG){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL_SDS;messageObject.Country=$scope.catalogRequestDto.country+" - "+$scope.catalogRequestDto.countryName;messageObject.Market_Segment=$scope.catalogRequestDto.marketSegment;messageObject.Product_Type=$scope.catalogRequestDto.modelCode;messageObject.Commitment=$scope.catalogRequestDto.serviceCommitment;messageObject.Billing=$scope.catalogRequestDto.billingFrequency;messageObject.Test_Customer_Name=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.displayName:"";messageObject.Customer_Country=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.country:"";messageObject.Test_Customer_Email=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.email:"";messageObject.Customer_Guid=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.userId:""}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_COMMERCE&&serviceCategory==AppConstants.SERVICE_INVOKE_ORDER_SERVICE){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Product_Type=$scope.catalogRequestDto.modelCode;messageObject.Commitment=$scope.catalogRequestDto.serviceCommitment;messageObject.Billing=$scope.catalogRequestDto.billingFrequency;messageObject.Test_Customer_Name=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.displayName:"";messageObject.Customer_Country=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.country:"";messageObject.Test_Customer_Email=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.email:"";if(isSuccess){messageObject.Customer_Guid=result["user-id"]?result["user-id"]:"";messageObject.Country=result.country+" - "+$scope.catalogRequestDto.countryName;messageObject.Market_Segment=result["market-segment"];messageObject.Currency_Code=result["currency-code"];messageObject.Order_ID=result["order-id"];messageObject.Order_Number=result["order-number"];messageObject.Order_Date=result["order-date"];messageObject.Order_Status=result.status;messageObject.Order_Type=result.type;messageObject.Order_Total_Without_Tax=result["base-total"];messageObject.Order_Total_With_Tax=result["base-total-with-tax"];messageObject.Order_Total_Tax=result["total-tax"];messageObject.Go_Cart_Id=result.telesales["go-cart-id"];angular.forEach(result.items,function(orderItemValue,key){var itemKeyName="Order_Item_"+(key+1)+"_";messageObject[itemKeyName+"Sku"]=orderItemValue.sku.id;messageObject[itemKeyName+"Product_Code"]=orderItemValue.sku["sap-product-code"];messageObject[itemKeyName+"Service_Plan"]=orderItemValue.sku["service-plan"];messageObject[itemKeyName+"Price_Without_Tax"]=orderItemValue["unit-price"];messageObject[itemKeyName+"Price_With_Tax"]=orderItemValue["unit-price-with-tax"];messageObject[itemKeyName+"Qty"]=orderItemValue.quantity;messageObject[itemKeyName+"Tax"]=orderItemValue["total-tax"]})}else{messageObject.Customer_Guid=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.userId:"";messageObject.Country=(result.country?result.country:"")+" - "+$scope.catalogRequestDto.countryName;messageObject.Market_Segment=result["market-segment"]?result["market-segment"]:"";messageObject.Currency_Code=result["currency-code"]?result["currency-code"]:"";messageObject.Order_ID=result["order-id"]?result["order-id"]:"";messageObject.Order_Number=result["order-number"]?result["order-number"]:"";messageObject.Order_Date=result["order-date"]?result["order-date"]:"";messageObject.Order_Status=result.status?result.status:"";messageObject.Order_Type=result.type?result.type:"";messageObject.Order_Total_Without_Tax=result["base-total"]?result["base-total"]:"";messageObject.Order_Total_With_Tax=result["base-total-with-tax"]?result["base-total-with-tax"]:"";messageObject.Order_Total_Tax=result["total-tax"]?result["total-tax"]:"";angular.forEach(result.items,function(orderItemValue,key){var itemKeyName="Order_Item_"+(key+1)+"_";messageObject[itemKeyName+"Sku"]=orderItemValue.sku.id;messageObject[itemKeyName+"Product_Code"]=orderItemValue.sku["sap-product-code"];messageObject[itemKeyName+"Service_Plan"]=orderItemValue.sku["service-plan"];messageObject[itemKeyName+"Price_Without_Tax"]=orderItemValue["unit-price"];messageObject[itemKeyName+"Price_With_Tax"]=orderItemValue["unit-price-with-tax"];messageObject[itemKeyName+"Qty"]=orderItemValue.quantity;messageObject[itemKeyName+"Tax"]=orderItemValue["total-tax"]});if(errors.errors&&errors.errors.length>0){messageObject.Error_Title=errors.title}angular.forEach(errors.errors,function(error,key){var itemKeyName="Exception_Reason_"+(key+1)+"_";messageObject[itemKeyName+"Code"]=error.code;messageObject[itemKeyName+"Text"]=error.descriptionText;messageObject[itemKeyName+"Description"]=error.description})}if(result&&result.items){angular.forEach(result.items,function(orderItem,key){var itemKeyName="Order_Item_"+(key+1)+"_";if($scope.orderServiceDto&&$scope.orderServiceDto.items){for(var itemCount=0;itemCount<$scope.orderServiceDto.items.length;itemCount++){if($scope.orderServiceDto.items[itemCount].cartInfo&&orderItem.sku.id==$scope.orderServiceDto.items[itemCount].cartInfo.materialId){messageObject[itemKeyName+"Product_Name"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.longName:"";messageObject[itemKeyName+"Offer_ID"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.offerId:"";messageObject[itemKeyName+"Product_Key"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.productKey:"";messageObject[itemKeyName+"Product_Tags"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.tags:"";break}}}})}else{if($scope.orderServiceDto&&$scope.orderServiceDto.items){for(var itemCount=0;itemCount<$scope.orderServiceDto.items.length;itemCount++){var itemKeyName="Order_Item_"+(itemCount+1)+"_";messageObject[itemKeyName+"Product_Name"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.longName:"";messageObject[itemKeyName+"Offer_ID"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.offerId:"";messageObject[itemKeyName+"Product_Key"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.productKey:"";messageObject[itemKeyName+"Product_Tags"]=$scope.orderServiceDto.items[itemCount].cartInfo?$scope.orderServiceDto.items[itemCount].cartInfo.tags:""}}}}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_ANYWARE&&serviceCategory==AppConstants.SERVICE_INVOKE_TOKEN_GENERATE){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_ANYWARE;messageObject.Functionality="Placing Order - Token Generation";messageObject.Test_Customer_Name=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.displayName:"";messageObject.Customer_Country=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.country:"";messageObject.Test_Customer_Email=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.email:"";messageObject.Customer_Guid=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.userId:"";if(isSuccess&&result&&result.value&&result.value.payment_instrument){messageObject.Payment_Currency_Code=result.value.currency_code;messageObject.Test_Payment_Token=result.value.token_id;messageObject.Payment_Category=result.value.payment_instrument.payment_category;messageObject.Payment_Type=result.value.payment_instrument.payment_type;messageObject.Test_Payment_Expiry_Date=result.value.payment_instrument.credit_card_expiry_date_display}}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL_DR&&serviceCategory==AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL_DR;messageObject.Product_Type=$scope.catalogRequestDto.modelCode;messageObject.Commitment=$scope.catalogRequestDto.serviceCommitment;messageObject.Billing=$scope.catalogRequestDto.billingFrequency;messageObject.Customer_Country=$scope.selectedCustomerDetails?$scope.selectedCustomerDetails.country:""}}}}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};$scope.changeCountryChange=function(status){$scope.isCountryChange=status};$scope.messages=[];$scope.showMessage=function(type,message){$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.checkPurchaseEligibilityInJil=function(validationInput){$app.showLoading("Checking Purchase Eligibility");$scope.messages=[];CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:validationInput.customerGuid,locale:validationInput.locale}).success(function(response){$app.hideLoading();var teamSubscriptions=response;if(teamSubscriptions.length>0&&!$scope.isCountryChange){if(teamSubscriptions.length>1){console.log("Can't add product. Two team subscriptions found. Please contact Hendrix support");$scope.showMessage("error","Can't add product. Two team subscriptions found. Please contact Hendrix support")}else{var teamMarketSegment=teamSubscriptions[0].marketSegment.toUpperCase()==="COMMERCIAL"?"COM":"EDU";var isMarketSegmentMatched=teamMarketSegment===$scope.catalogRequestDto.marketSegment;var isBillingFrequencyUnknown=_.every(_.map($scope.orderServiceDto.items,"cartInfo"),function(cartItem){return teamSubscriptions[0].billingInfo.billingFrequency.toUpperCase()==="UNKNOWN"});var isBillingFrequencyMatched=_.every(_.map($scope.orderServiceDto.items,"cartInfo"),function(cartItem){return teamSubscriptions[0].billingInfo.billingFrequency.toUpperCase()===cartItem.billingFrequency.toUpperCase()});if(!isMarketSegmentMatched){console.log("Market Segment not matched");$scope.showMessage("error","Can't add product, market segment not matched with existing team subscription")}if(isBillingFrequencyUnknown){console.log("UNKNOWN billing frequency found");$scope.showMessage("error","Customer has team contract which is under processing state. Add Seat/product not allowed at this point of time . Please try after some time")}else{if(!isBillingFrequencyMatched){console.log("Billing frequency not matched");$scope.showMessage("error","Can't add product, billing frequency not matched with existing team subscription")}}if(isBillingFrequencyMatched&&isMarketSegmentMatched&&!isBillingFrequencyUnknown){console.log("Billing frequency & market segment matched");var addSeatProductObj={teamId:teamSubscriptions[0].id,customerGuid:validationInput.customerGuid,actionType:"seat",productData:_.map($scope.orderServiceDto.items,"cartInfo"),teamSubscription:teamSubscriptions[0],source:SalesConstants.SALES_DIRECT_SALES};if(addSeatProductObj.teamSubscription.isDrContract){addSeatProductObj.customerDetails=$scope.selectedCustomerDetails;$rootScope.$broadcast("InitiateAddDrSeatSalesProduct",addSeatProductObj)}else{$rootScope.$broadcast("InitiateAddSeatProduct",addSeatProductObj)}}}}else{console.log("continue direct sales flow");if($scope.isDRStoreFlow){var drStoreWindow;var url="";angular.forEach($scope.orderServiceDto.links,function(link){if(link.rel=="checkout_agent"){url=link.href}});var left=(screen.width/2)-(900/2);var top=(screen.height/2)-(800/2);drStoreWindow=window.open(url,"DR Store","width=900,height=800,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left="+left+",top="+top);drStoreWindow.focus();$scope.showDrSuccessResetCart();if($scope.orderServiceDto.hasOwnProperty("user-id")&&angular.isDefined($scope.orderServiceDto["user-id"])&&$scope.orderServiceDto["user-id"].length>0){$scope.searchCustomer($scope.orderServiceDto["user-id"])}else{$scope.searchCustomer($scope.orderServiceDto.ownerId.split("@")[0])}}else{if($scope.wizardStep===SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP){$rootScope.$broadcast(SalesConstants.SALES_CHECK_CREATE_ORDER_EVENT)}else{if($scope.wizardStep===SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP){$rootScope.$broadcast(SalesConstants.SALES_CHECK_ELIGIBILITY_VIA_COMMERCE,validationInput)}else{if($scope.wizardStep===SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP){$rootScope.$broadcast(SalesConstants.SALES_CHECK_CREATE_ORDER_EVENT)}}}}}}).error(function(error){$scope.showMessage("error","Error while calling JIL to check purchase eligibility");$app.hideLoading()})};$scope.updateOldCountryInfo=function(country){$scope.customerOldCountry=country};$scope.updateQuoteAddressFlag=function(){$scope.isQuoteAddressUpdateRequired=false};$scope.loadCustomerDetailsFromCRM=function(){};$scope.searchCustomer=function(rengaId){$scope.searchingCustomerInCrm=true;$scope.searchFields={idNumber:rengaId,customerType:1,authSrc:"AdobeID"};CustomerPreviewService.search($scope.searchFields).success(function(result){if(angular.isDefined(result.customerSearchResults[0].customerNo)&&result.customerSearchResults[0].customerNo!==""){$scope.customerNoForDr=result.customerSearchResults[0].customerNo;$scope.searchingCustomerInCrm=false}else{console.log("Customer not found in CRM");$scope.searchCustomerInProgress=false}}).error(function(error){$scope.searchingCustomerInCrm=false})}}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesCustomerController",["$scope","SalesConstants","SalesServices","SalesUtil",function($scope,SalesConstants,SalesServices,SalesUtil){$scope.createNewCustomer=function(customer,nextStep){}}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesCustomerDetailsController",["$scope","SalesConstants","SalesServices","SalesUtil","AppUtils","AppConstants","CustomerPreviewService","ImsCustomerService","$rootScope","AddressValidationService","ImsNewCustomerDto","IMSSecondryClientService","$app","MetadataService","$filter","CustomerConstants","features","PaymentConstants",function($scope,SalesConstants,SalesServices,SalesUtil,AppUtils,AppConstants,CustomerPreviewService,ImsCustomerService,$rootScope,AddressValidationService,ImsNewCustomerDto,IMSSecondryClientService,$app,MetadataService,$filter,CustomerConstants,features,PaymentConstants){console.log("Customer Details called");$scope.isAddressValidationVisible=false;$scope.isUseAddressOwnBtn=true;$scope.isUseAddressNewBtn=true;$scope.isNewCustomerVisible=false;$scope.imsMessages=[];$scope.isCreateNewIMSCustomerSuccess=false;$scope.newCustomerDetails=angular.copy(ImsNewCustomerDto);$scope.newIMSCustomerCreateResult;$scope.isVATTypeMismatched=true;$scope.showVatOptions=false;$scope.isCustomerCountryJp=false;$scope.showGSTOptions=false;$scope.gstRegxPattern=/^\d{2,3}-?\d{3}-?\d{3}$/;$scope.isGSTFormatValid=true;$scope.selectedIndex=0;$scope.defaultValidationFields=["firstName","lastName","city","state","postCode","country","email"];$scope.editBillingValidations=_.has(hendrixConfig,"unifiedCheckout")?hendrixConfig.unifiedCheckout.editBillingAddressValidations:{};$scope.$on(SalesConstants.SALES_SELECT_CUSTOMER_FROM_URL_EVENT,function(event){if($scope.customerEmailId){$scope.selectNewImsCustomer($scope.customerEmailId)}});$rootScope.$on("UpdateCustomerDetails",function(event,custromerDetails){$scope.customerObj=custromerDetails.custromerDetails;if(custromerDetails.isQuoteAddressUpdateRequired&&$scope.isQuoteToOrder){SalesUtil.getCustomerDetailsFromQuote($scope.orderServiceDto,$scope.customerObj);$scope.updateQuoteAddressFlag()}if($scope.isDRStoreFlow){$rootScope.$broadcast(SalesConstants.SALES_DR_CUSTOMER_SEARCH_EVENT,custromerDetails);$scope.setWizardStep(SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP);return}$scope.isCustomerInUrlValid=custromerDetails.isCustomerInUrlValid;console.log("Customer Details",$scope.customerObj);$scope.isNewCustomerVisible=false;$scope.isCustomerCountryJp=false;if($scope.customerObj){$scope.customerDetails=$scope.customerObj;if(!$scope.isCustomerInUrlValid){$scope.selectedCustomerDetails=angular.copy($scope.customerDetails);$scope.$parent.$parent.selectedCustomerDetails=$scope.selectedCustomerDetails;SalesUtil.addParameterToUrl("id",$scope.customerDetails.customerGuid);$scope.isCustomerInUrlValid=true;$scope.reInitializeWizardHeaders($scope.isCustomerInUrlValid)}if(!angular.isDefined($scope.customerDetails.address.country.code)||$scope.customerDetails.address.country.code.length==0){$scope.customerDetails.address.country.code=$scope.customerDetails.country}if($scope.customerDetails&&$scope.customerDetails.address&&$scope.customerDetails.address.country&&$scope.customerDetails.address.country.code=="JP"){$scope.isCustomerCountryJp=true}if($scope.isCountryChange&&features.isFeatureEnabled("countrychange")){$scope.updateOldCountryInfo($scope.customerDetails.address.country.code);console.log("Modifying customer details for country change");$scope.customerDetails.address={country:{code:$scope.catalogRequestDto.country}}}if($scope.metadata||$scope.metadata.countrySpecificInfo){MetadataService.getCountrySpecificInfo({countryCode:$scope.catalogRequestDto.country}).success(function(result){$scope.metadata.countrySpecificInfo=result;$scope.metaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.countrySpecificInfo=$scope.metadata.countrySpecificInfo;if($scope.isCustomerInUrlValid){$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)}$scope.updateStateName($scope.customerDetails.address.state)})}else{$scope.metaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.countrySpecificInfo=$scope.metadata.countrySpecificInfo;if($scope.isCustomerInUrlValid){$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)}}}$scope.getBillingValidationObj()});$scope.$watch("selectedPaymentMethod",function(value){$scope.getBillingValidationObj()});$scope.getBillingValidationObj=function(){if(angular.isUndefined($scope.customerDetails)){return}if(angular.isUndefined($scope.selectedPaymentMethod)||angular.isUndefined($scope.selectedPaymentMethod.paymentType)||angular.isUndefined($scope.customerDetails.address.country.code)||angular.isUndefined($scope.isTeamSubscription)){$scope.requiredFields=$scope.defaultValidationFields}var validatonParams={countryCode:$scope.customerDetails.address.country.code.toLowerCase(),paymentMethod:$scope.getCRMPaymentTypeCode($scope.selectedPaymentMethod?$scope.selectedPaymentMethod.paymentType:"CREDIT_CARD"),productType:$scope.isTeamSubscription?"TEAM":"INDIVIDUAL"};console.log("Billing validation parameters\n",validatonParams);$scope.billingValidationFields=_.find($scope.editBillingValidations,function(obj){if(obj.countryCodes.indexOf(validatonParams.countryCode)!==-1&&obj.paymentMethods.indexOf(validatonParams.paymentMethod)!==-1&&obj.productType===validatonParams.productType){return obj}});if(angular.isDefined($scope.billingValidationFields)){$scope.requiredFields=$scope.billingValidationFields.requiredFieldsCommerceFlow;console.log("billingValidationFields\n",$scope.billingValidationFields)}else{$scope.requiredFields=$scope.defaultValidationFields;if($scope.isTeamSubscription){$scope.requiredFields.push("companyName")}console.log("No config found for billingValidationFields, applying default validations")}console.log("Required Fields are\n",$scope.requiredFields)};$scope.getCRMPaymentTypeCode=function(commercePaymentType){var paymentMapping=_.find(PaymentConstants.PAYMENT_COMMERCE_CRM_MAPPING,{commercePaymentType:commercePaymentType});if(angular.isDefined(paymentMapping)){return paymentMapping.crmCode}else{console.log("Payment CRM mapping not found for "+commercePaymentType)}};$rootScope.$on("NewCustomerEvent",function(event,customerObj){console.log("New Customer Details",customerObj);$scope.isNewCustomerVisible=true;$scope.isAddressValidationVisible=false;$scope.isCreateNewIMSCustomerSuccess=false;$scope.newCustomerDetails=angular.copy(ImsNewCustomerDto);$scope.newCustomerDetails.person.countryCode=$scope.catalogRequestDto.country;$scope.imsMessages=[];$scope.setWizardStep(SalesConstants.SALES_WIZARD_CUSTOMER_DETAILS_STEP)});$scope.isCustomerDetailValid=function(customer){var returnResult=true;$scope.isGSTFormatValid=true;if(!customer){return false}if(customer.taxInfo&&customer.taxInfo.taxType&&customer.taxInfo.taxType==CustomerConstants.GST_NZ_CODE){if(angular.isDefined(customer.taxInfo.taxNumber)&&customer.taxInfo.taxNumber.length>0){returnResult=$scope.gstRegxPattern.test(customer.taxInfo.taxNumber);if(!returnResult){$scope.isGSTFormatValid=false}}}else{if(customer.taxInfo&&customer.taxInfo.taxType&&!customer.taxInfo.taxNumber){returnResult=false;return returnResult}else{if(customer.taxInfo&&!customer.taxInfo.taxType&&customer.taxInfo.taxNumber){returnResult=false;return returnResult}}}return returnResult&&$scope.isFormValid(customer)};$scope.isFormValid=function(form){var validationResult=[];if(angular.isDefined($scope.requiredFields)&&$scope.requiredFields.length){for(var i=0;i<$scope.requiredFields.length;i++){validationResult.push((angular.isDefined(form[$scope.requiredFields[i]])&&form[$scope.requiredFields[i]]!=="")||(angular.isDefined(form.address[$scope.requiredFields[i]])&&form.address[$scope.requiredFields[i]]!==""))}if(_.includes(validationResult,false)){return false}else{return true}}};$scope.isRequired=function(field){return _.includes($scope.requiredFields,field)};$scope.isValid=function(customer){var nameRegex=/^[0-9A-Za-z?\s]{1,}[\.]{0,1}[0-9A-Za-z?\-'.,&\s]{0,}$/;var returnResult=true;if(!customer){returnResult=false;return returnResult}if(!customer.person.firstName||!customer.person.lastName){returnResult=false;return returnResult}if(angular.uppercase(customer.address.country.code)!=="JP"&&(!nameRegex.test(customer.person.firstName)||!nameRegex.test(customer.person.lastName))){returnResult=false;return returnResult}if(customer&&customer.country&&!angular.isDefined(customer.country)){returnResult=false;return returnResult}var customerEmail=$("#newCustomerEmail").val();if(!customerEmail||customerEmail==""){returnResult=false;return returnResult}if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){returnResult=false;return returnResult}}return returnResult};$scope.$watch("customerDetails.address.state",function(newValue){$scope.updateStateName(newValue)});$scope.updateStateName=function(newValue){if(angular.isDefined(newValue)&&angular.isDefined($scope.countrySpecificInfo)){angular.forEach($scope.countrySpecificInfo.statesByCountry,function(stateItem){if(newValue==stateItem.id){$scope.customerDetails.address.stateName=stateItem.description}})}};$scope.createNewImsCustomer=function(newCustomer){$scope.imsMessages=[];$scope.newIMSCustomerCreateResult=null;var imsNewCustomerDTO=angular.copy(ImsNewCustomerDto);imsNewCustomerDTO.person.firstName=newCustomer.person.firstName;imsNewCustomerDTO.person.lastName=newCustomer.person.lastName;imsNewCustomerDTO.person.countryCode=newCustomer.person.countryCode;imsNewCustomerDTO.person.email=newCustomer.person.email;$app.showLoading("Creating Customer");IMSSecondryClientService.createPerson(imsNewCustomerDTO).success(function(result){$app.hideLoading();$scope.imsMessages=AppUtils.getSingleMessage("success","Customer create successfully GUID"+result.guid);$scope.newIMSCustomerCreateResult=result;$scope.isCreateNewIMSCustomerSuccess=true;$scope.selectNewImsCustomer(imsNewCustomerDTO.person.email)}).error(function(error){$app.hideLoading();$scope.imsMessages=AppUtils.getSingleMessage("error",error.error_description);$scope.isCreateNewIMSCustomerSuccess=false})};$rootScope.$on(SalesConstants.SALES_GET_NEW_CUSTOMER_EVENT,function(event,customerObj){$scope.selectNewImsCustomer($scope.customerDetails)});$scope.selectNewImsCustomer=function(emailId){var customerObj={email:emailId};$scope.imsNewSearchResult={};ImsCustomerService.getItem(customerObj).success(function(response){$scope.imsNewSearchResult=response;$scope.imsNewSearchResult.dataSource="IMS";$scope.isNewCustomerVisible=false;$rootScope.$broadcast("UpdateCustomerDetails",{custromerDetails:angular.copy($scope.imsNewSearchResult),isCustomerInUrlValid:false})}).error(function(errorData){$scope.imsNewSearchResult={}})};$scope.validateAddress=function(customerDetails){$scope.adddressValidationMessages=[];console.log("Validating Address Details",customerDetails);$scope.customerAddressDto=customerDetails.address;$scope.customerDetails=customerDetails;$scope.isAddressValidationVisible=true;if($scope.customerAddressDto.country.code=="US"||$scope.customerAddressDto.country.code=="CA"){$scope.showCountryTaxableMessage=true}else{$scope.showCountryTaxableMessage=false}if($scope.customerAddressDto.country.code=="JP"){var postalCode=$scope.customerDetails.address.postCode;$scope.customerErrorMessages=AppUtils.validatePostalCode(postalCode);if($scope.customerErrorMessages.length>0){$scope.adddressValidationMessages=$scope.customerErrorMessages;return}}$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:0.4});$scope.validateCorrectStreetOption();$app.showLoading("Validating Address");AddressValidationService.validate($scope.customerAddressDto).success(function(result){$app.hideLoading();$scope.isAddressValidationVisible=true;result.finalProposal.country.name=$scope.customerDetails.address.country.name;$("#originalAddress").css({opacity:1});$("#postalStandardSerivceAddress").css({opacity:1});if(result.finalProposal){if(!result.finalProposal.stateName){angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}}$scope.suggestedAddress=result.finalProposal;$scope.isEnteredAddressValid=true;$scope.isSuggestedAddressValid=true;if($scope.customerAddressDto.country.code=="JP"){$scope.suggestedAddress=$scope.customerDetails.address}if(result.dsStatus&&result.enteredTaxAddrStatus&&result.suggestedTaxAddrStatus){if(result.dsStatus=="E"||result.enteredTaxAddrStatus=="E"){$scope.isEnteredAddressValid=false;$("#originalAddress").css({opacity:0.4})}if(result.suggestedTaxAddrStatus=="E"||$scope.isSuggestedAddressEmpty($scope.suggestedAddress)){$scope.isSuggestedAddressValid=false;$("#postalStandardSerivceAddress").css({opacity:0.4})}}if(result.message!=null){$scope.adddressValidationMessages.push(result.message)}}).error(function(result){$app.hideLoading();$scope.isAddressValidationVisible=false;$scope.isEnteredAddressValid=false;$scope.isSuggestedAddressValid=false})};$scope.validateCorrectStreetOption=function(){$scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber($scope.customerDetails.address)};$scope.editCustomerDetails=function(){$scope.isAddressValidationVisible=false;$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:1});$scope.isUseAddressOwnBtn=$scope.isUseAddressNewBtn=true};$scope.resetAddressSelection=function(){$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:1});$scope.isUseAddressOwnBtn=$scope.isUseAddressNewBtn=true};$scope.isSuggestedAddressEmpty=function(address){var isAddressEmpty=false;if(address.addressNo==""&&address.city==""&&(address.country&&address.country.code=="")&&address.district==""&&address.homeCity==""&&address.postCode==""&&address.state==""&&address.street1==""&&address.street2==""&&address.street3==""){isAddressEmpty=true}return isAddressEmpty};$scope.handleAddressUpdate=function(customerAddress){$scope.customerDetails.address=customerAddress;$scope.updateCustomer($scope.customerDetails)};$scope.handleValidateOwnAddress=function(){$scope.handleAddressUpdate($scope.customerDetails.address);$scope.isUseAddressNewBtn=false;$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:1});$scope.isQuote?$scope.setWizardStep(SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP):$scope.setWizardStep(SalesConstants.SALES_WIZARD_PAYMENT_STEP)};$scope.handleValidateNewAddress=function(){$scope.replaceCorrectStreetNo();$scope.handleAddressUpdate($scope.suggestedAddress);$scope.isUseAddressOwnBtn=false;$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:0.4});$scope.isQuote?$scope.setWizardStep(SalesConstants.SALES_WIZARD_PLACE_ORDER_STEP):$scope.setWizardStep(SalesConstants.SALES_WIZARD_PAYMENT_STEP)};$scope.isCorrectStreetOptionVisible=false;$scope.validateCorrectStreetOption=function(){$scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber($scope.customerDetails.address)};$scope.correctStreetNo="";$scope.updateCorrectStreetNo=function(correctStreetNo){$scope.correctStreetNo=correctStreetNo};$scope.replaceCorrectStreetNo=function(){if($scope.correctStreetNo&&$scope.correctStreetNo!=""){$scope.suggestedAddress=AppUtils.getReplacedStreet1Address($scope.correctStreetNo,$scope.suggestedAddress)}$scope.correctStreetNo=""};$scope.$watch("customerDetails.address.country.code",function(value){if(!value){return}$scope.checkVatDisplay();$scope.checkGSTDisplay()});$scope.checkGSTDisplay=function(){$scope.showGSTOptions=false;if($scope.customerDetails.address.country.code.toUpperCase()=="NZ"){$scope.customerDetails.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;$scope.showGSTOptions=true}};$scope.checkVatDisplay=function(){$scope.showVatOptions=false;angular.forEach($scope.metadata.vatOptions,function(vatItem){if($scope.customerDetails.address.country.code&&!$scope.showVatOptions){if(vatItem.code.indexOf($scope.customerDetails.address.country.code)!=-1){$scope.showVatOptions=true}}})};$scope.$watch("customerDetails.taxInfo.taxType",function(value){if(!$scope.customerDetails){return}if($scope.customerDetails.taxInfo&&$scope.customerDetails.address.country&&$scope.metadata.vatOptions){$scope.isVATTypeMismatched=(MetadataService.getDefaultVATOptionFromMetadata($scope.metadata.vatOptions,$scope.customerDetails.address.country.code)!=$scope.customerDetails.taxInfo.taxType)?true:false}});$scope.resetDefaultVatType=function(){if($scope.customerDetails.taxInfo&&$scope.customerDetails.address.country){$scope.customerDetails.taxInfo.taxType=MetadataService.getDefaultVATOptionFromMetadata($scope.metadata.vatOptions,$scope.customerDetails.address.country.code)}};$scope.clearVat=function(){if($scope.customerDetails.taxInfo){$scope.customerDetails.taxInfo.taxType="";$scope.customerDetails.taxInfo.taxNumber=""}};$scope.updatePaymentMethod=function(paymentMethod,itemIndex){$scope.selectedIndex=itemIndex;$scope.updateSelectedPaymentMethod(paymentMethod)}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("SalesCustomerDto",{firstName:"",lastName:"",email:"",customerGuid:"",phone:"",country:"",address:"",userId:"",taxInfo:{taxNumber:"",taxType:""}});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesCustomerSelectController",["$scope","$app","$location","SalesConstants","SalesServices","SalesUtil","AppUtils","AppConstants","CustomerPreviewService","ImsCustomerService","ImsCustomerDto","$rootScope","JilServices","features",function($scope,$app,$location,SalesConstants,SalesServices,SalesUtil,AppUtils,AppConstants,CustomerPreviewService,ImsCustomerService,ImsCustomerDto,$rootScope,JilServices,features){$scope.isSearchLoading=false;$scope.customerSearchResults=[];$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",externalRef:"",customerType:"1"};$scope.$on(SalesConstants.SALES_CATALOG_CREATE_ORDER_EVENT,function(event){$scope.resetFormFields()});$scope.$on(SalesConstants.SALES_DR_CUSTOMER_SEARCH_EVENT,function(event,customerData){$scope.customerSearchResults=[];var customerObj={email:customerData.custromerDetails.email};$scope.searchFields.customerId=customerData.custromerDetails.email;$scope.searchFields.firstName=customerData.custromerDetails.firstName;$scope.searchFields.lastName=customerData.custromerDetails.lastName;ImsCustomerService.getItem(customerObj).success(function(response){$scope.isSearchLoading=false;if(!$.isArray(response)&&response.userId){$scope.customerSearchResults.push(SalesUtil.getCustomerResultDto(true,response))}}).error(function(errorData){$scope.isSearchLoading=false;$scope.customerSearchResults=[]})});$scope.isSearchValid=function(){if($scope.searchFields.firstName&&$scope.searchFields.lastName){return true}return false};$scope.resetFormFields=function(){$scope.searchFields={firstName:"",lastName:"",customerId:""};$scope.customerSearchResults=[]};$scope.handleFocus=function(el){if(el=="lastName"||el=="firstName"){$scope.searchFields.customerId=""}else{$scope.searchFields.firstName=$scope.searchFields.lastName=""}};$scope.searchCustomer=function(){$scope.isSearchLoading=true;$scope.customerSearchResults=[];var regEmail=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(regEmail.test($scope.searchFields.customerId)){var customerObj={email:$scope.searchFields.customerId};ImsCustomerService.getItem(customerObj).success(function(response){$scope.isSearchLoading=false;if(!$.isArray(response)&&response.userId){$scope.customerSearchResults.push(SalesUtil.getCustomerResultDto(true,response))}}).error(function(errorData){$scope.isSearchLoading=false;$scope.customerSearchResults=[]})}else{var orderNumberReg=/^[a-zA-Z]{1}/;var searchFieldsRequest=angular.copy($scope.searchFields);if(searchFieldsRequest.firstName&&searchFieldsRequest.lastName){searchFieldsRequest.customerId=searchFieldsRequest.transactionNo=searchFieldsRequest.externalRef=""}else{if(orderNumberReg.test(searchFieldsRequest.customerId)){searchFieldsRequest.externalRef=$scope.searchFields.customerId;searchFieldsRequest.firstName=searchFieldsRequest.lastName=searchFieldsRequest.customerId=searchFieldsRequest.transactionNo=""}else{if((searchFieldsRequest.customerId.length==9&&searchFieldsRequest.customerId.indexOf("3")>=0)||searchFieldsRequest.customerId.length==10&&searchFieldsRequest.customerId.indexOf("03")>=0){searchFieldsRequest.firstName=searchFieldsRequest.lastName=searchFieldsRequest.externalRef=searchFieldsRequest.transactionNo=""}else{if((searchFieldsRequest.customerId.length==8&&searchFieldsRequest.customerId.indexOf("5")>=0)||(searchFieldsRequest.customerId.length==9&&searchFieldsRequest.customerId.indexOf("05")>=0)||searchFieldsRequest.customerId.length==10&&searchFieldsRequest.customerId.indexOf("005")>=0){searchFieldsRequest.transactionNo=$scope.searchFields.customerId;searchFieldsRequest.firstName=searchFieldsRequest.lastName=searchFieldsRequest.externalRef=searchFieldsRequest.customerId=""}}}}CustomerPreviewService.search(searchFieldsRequest).success(function(result){$scope.isSearchLoading=false;if(result&&result.customerSearchResults.length>0){angular.forEach(result.customerSearchResults,function(customer){$scope.customerSearchResults.push(SalesUtil.getCustomerResultDto(false,customer))})}}).error(function(result){$scope.isSearchLoading=false;$scope.customerSearchResults=[]})}};$scope.selectCustomer=function(selectedCustomer){$scope.updateSelectCustomer(selectedCustomer);$scope.isCustomerInUrlValid=false;if(selectedCustomer&&$scope.catalogRequestDto.modelCode==SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT&&!$scope.isQuote){var validationInput={locale:"EN_US",customerGuid:selectedCustomer.rengaId};$scope.checkPurchaseEligibilityInJil(validationInput)}else{$scope.checkPurchaseEligibilityInCommerce()}};$scope.selectCustomerAndProcessCart=function(selectedCustomer){if($scope.orderServiceDto&&$scope.orderServiceDto.cartId&&!$scope.isContractCartServiceLoading){$scope.isContractCartServiceLoading=true;$app.showLoading("Updating Cart");var contractCartDto=SalesUtil.getContractCartServiceDtoFromOrderServiceDto($scope.orderServiceDto);contractCartDto.lastModifiedById=$rootScope.currentUser.username;if(selectedCustomer&&(selectedCustomer.rengaGuid||selectedCustomer.rengaId)){contractCartDto.ownerId=selectedCustomer.rengaGuid?selectedCustomer.rengaGuid:(selectedCustomer.rengaId+"@AdobeID");contractCartDto.ownerEmail=selectedCustomer.email}else{contractCartDto.ownerId=$rootScope.currentUser.username}JilServices.updateContractCart(contractCartDto).success(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();result=SalesUtil.getOrderServiceDtoFromContractCartServiceDto(result,$scope.orderServiceDto);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,true,result);messageObject.Functionality="Processing DR Cart - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.selectCustomer(selectedCustomer)}).error(function(result,status,headers,config){$scope.isContractCartServiceLoading=false;$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Cart Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL_DR,AppConstants.SERVICE_INVOKE_CONTRACT_CART_SERVICE,false,$.isPlainObject(result)?result:initialOrderServiceDto,salesErrorMessage);messageObject.Functionality="Processing DR Cart - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.showSalesMessagesModal(salesErrorMessage)})}};$scope.$on(SalesConstants.SALES_CHECK_ELIGIBILITY_VIA_COMMERCE,function(event,data){$scope.checkPurchaseEligibilityInCommerce()});$scope.changeToCustomerStore=function(customer){$location.search("store",customer.countryCode);$location.search("id",customer.rengaId);location.reload(true)};$scope.checkPurchaseEligibilityInCommerce=function(){$app.showLoading("Checking Cart Eligibility");var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Checking Cart Eligibility - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result);$app.showLoading("Initializing Customer");var customerDetailsRequestObj={guid:$scope.orderServiceDto["user-id"],authSrc:"AdobeID"};ImsCustomerService.getCustomerProfileByGuid(customerDetailsRequestObj).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_IMS_RENGA,true,result);messageObject.Functionality="Initializing Customer - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.selectedCustomer=SalesUtil.getCustomerDetailsData(true,result);$rootScope.$broadcast("UpdateCustomerDetails",{custromerDetails:angular.copy($scope.selectedCustomer),isCustomerInUrlValid:$scope.isCustomerInUrlValid})}).error(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_IMS_RENGA,false,result);messageObject.Functionality="Initializing Customer - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Initializing Customer Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Initializing Customer - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.createNewImsCustomer=function(customer,nextStep){var customerObj=angular.copy(ImsCustomerDto);$rootScope.$broadcast("NewCustomerEvent",customerObj)};$scope.openCountryChange=function(customer,$event){$("#countryChangeModal").modal("show");$rootScope.$broadcast("InitiateCountryChangeValidations",customer)};$scope.$on("COUNTRY_CHANGE_MODAL_PROCEED",function(event,customerFromChangeCountry){$scope.changeCountryChange(true);if($scope.wizardStep==SalesConstants.SALES_WIZARD_PRODUCT_CATALOG_STEP){$rootScope.$broadcast(SalesConstants.SALES_INVOKE_CATALOG_EVENT)}else{if($scope.wizardStep==SalesConstants.SALES_WIZARD_SELECT_CUSTOMER_STEP){$scope.selectCustomer(customerFromChangeCountry)}}});$scope.isCountryChangeAllowed=function(selectedCustomer){if(angular.isDefined(selectedCustomer)){var customerCountry=selectedCustomer.countryCode.toLowerCase();if(features.isFeatureEnabled("cbc_teamflow")){return customerCountry!==$scope.catalogRequestDto.country.toLowerCase()&&AppUtils.isCommercialStore(customerCountry)&&AppUtils.isEducationalStore(customerCountry)&&!$scope.catalogRequestDto.isDrStore&&selectedCustomer.rengaId&&selectedCustomer.email}else{return customerCountry!==$scope.catalogRequestDto.country.toLowerCase()&&AppUtils.isCommercialStore(customerCountry)&&AppUtils.isEducationalStore(customerCountry)&&!$scope.catalogRequestDto.isDrStore&&selectedCustomer.rengaId&&selectedCustomer.email&&$scope.catalogRequestDto.modelCode===SalesConstants.CATALOG_BUSINESS_CODE_INDIVIDUAL}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSalesCartView",["$rootScope","SalesConstants","ValidateCouponService",function($rootScope,SalesConstants,ValidateCouponService){return{restrict:"EA",scope:{orderServiceDto:"="},replace:true,templateUrl:"js/sales/common/sales-cart-review.html",link:function($scope,element,attrs){$scope.SalesConstants=SalesConstants}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("SalesDto",{"market-segment":"COM",status:"IN_PROGRESS",country:"US","user-id":"52B84411577CF2437F000101",telesales:{agent:{id:"HSAT1_NA","first-name":"HSAT1_NA","last-name":""},"go-cart-id":""},"payment-instrument":{"billing-address":{contact:{"last-name":"IMS","first-name":"Megharaj","primary-phone":"415 832 2000","primary-email":"megharaj+ims@adobetest.com"},street1:"625 Townsend St",street2:"",street3:"",street4:"",city:"San Francisco",country:{name:"United States",code:"US"},"postal-code":"94103-4907","state-province":{name:"San Francisco",code:"CA"}}},items:[{quantity:1,sku:{id:"65230453"}}]});var app=app||angular.module("hxApp",["ngRoute"]);app.constant("SalesPaymentConstants",{CREDIT_CARD_PAYMENT_TYPE:"CREDIT_CARD",DEBIT_CARD_PAYMENT_TYPE:3,CVS_PAYMENT_TYPE:"CVS",BANK_TRANSFER_PAYMENT_TYPE:"BANK_TRANSFER",DIRECT_DEBIT_PAYMENT_TYPE:"DIRECT_DEBIT",PAYPAL_PAYMENT_TYPE:"PAYPAL",PURCHASE_ORDER_PAYMENT_TYPE:"PO",IBAN_PAYMENT_TYPE:999,DUMMY_CARD:99,PO_PAYMENT_TYPE:9,PO_MINIMUM_SEAT:3,SAVED_PAYMENT_INSTRUMENT:"SAVED_PAYMENT_INSTRUMENT",CREDIT_CARD_PAYMENT_LABEL:"Credit Card",DEBIT_CARD_PAYMENT_LABEL:"Debit Card",CVS_PAYMENT_LABEL:"CVS",BANK_TRANSFER_PAYMENT_LABEL:"Bank Transfer",PAYPAL_PAYMENT_LABEL:"Paypal",IBAN_PAYMENT_LABEL:"IBAN",PO_PAYMENT_LABEL:"PO Number",PO_PAYMENT_DISPLAY_LABEL:"Purchase Order",DUMMY_CARD_LABEL:"Dummy Card",DIRECT_DEBIT_PAYMENT_LABEL:"Direct Debit",VALID_TOKEN_LENGTH:16,AMERICAN_EXPRESS_TYPE:"AMEX",VISA_TYPE:"VISA",MASTER_CARD_TYPE:"MC",COMMERCE_MASTER_CARD_TYPE:"MASTERCARD",SWITCH_TYPE:"SWCH",SOLO_TYPE:"SOLO",JCB_TYPE:"JCB",DYLAN_MASTER_CARD_TYPE:"MASTER CARD",TOKENIZER_MASTER_CARD_TYPE:"MASTER CARD",PAYMENT_MONTHS:[{code:"01",label:"01"},{code:"02",label:"02"},{code:"03",label:"03"},{code:"04",label:"04"},{code:"05",label:"05"},{code:"06",label:"06"},{code:"07",label:"07"},{code:"08",label:"08"},{code:"09",label:"09"},{code:"10",label:"10"},{code:"11",label:"11"},{code:"12",label:"12"}],PAYMENT_VIEW_TEMPLATE:"js/transaction/payment/partials/payment-details-view.html",PAYMENT_EDIT_TEMPLATE:"js/transaction/payment/partials/payment-details-edit.html",BT_PAYMENT_CONTROL_CODES:[{code:"TO",label:"TO"},{code:"FU",label:"FU"},{code:"TI",label:"TI"},{code:"FO",label:"FO"}],BT_ORDER_VALUE_VALIDATION:9000000,JP_DISABLE_BT_PAYMENT_FOR_CCT_PUF:false});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesPaymentController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","StoreConstants","StoreUtil","SalesPaymentConstants","AppUtils","SalesServices","SalesDto","PaymentService","TrackingService","TransactionConstants","$app","SalesConstants","SalesUtil","AppConstants","features",function($scope,$log,$rootScope,$location,$routeParams,$timeout,StoreConstants,StoreUtil,SalesPaymentConstants,AppUtils,SalesServices,SalesDto,PaymentService,TrackingService,TransactionConstants,$app,SalesConstants,SalesUtil,AppConstants,features){$scope.SalesPaymentConstants=SalesPaymentConstants;$scope.SalesConstants=SalesConstants;$scope.paymentErrorMessage="";$scope.$on(SalesConstants.SALES_PAYMENT_INITIALIZE_EVENT,function(event){$scope.initializePaymentForms()});$scope.$on(SalesConstants.SALES_PAYMENT_REVIEW_EVENT,function(event){$scope.reviewPaymentDetails()});$scope.$on(SalesConstants.SALES_PAYER_SELECT_EVENT,function(event,payerDetails){$scope.paymentDetails.confirmedPaymentDetails.payerId=payerDetails.partnerNo;$scope.$parent.selectedPayerDetails=payerDetails});$scope.$watch("paymentDetails.confirmedPaymentDetails",function(){$scope.isPaymentFormValid()},true);var tokenizerFunction=function(){$(window).on("message",function(event){var eventData;eventData=$.parseJSON(event.originalEvent.data);switch(eventData.type){case"tokenReceived":$scope.populateCreditCard(eventData.value);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_ANYWARE,AppConstants.SERVICE_INVOKE_TOKEN_GENERATE,true,eventData);AppUtils.sendLogToServer(messageObject);break;case"tokenLoaded":$("#tokenizer-iframe")[0].contentWindow.postMessage($scope.transactionAddress,window.location.origin);break;case"reset":$scope.resetPaymentView();break;case"tokenError":TrackingService.trackPageView("System","Token Failed: "+$scope.catalogRequestDto.country);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_ANYWARE,AppConstants.SERVICE_INVOKE_TOKEN_GENERATE,false,eventData);AppUtils.sendLogToServer(messageObject);break;case"reload":document.getElementById("tokenizer-iframe").src+="";break}});tokenizerFunction=function(){}};$scope.initializePaymentForms=function(){$app.showLoading("Initializing Payment");var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Initializing Payment - Payment";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result);$scope.paymentDetails=angular.copy(SalesUtil.getPaymentDetails($scope.orderServiceDto));$scope.paymentDetails.confirmedPaymentDetails.paymentType=$scope.selectedPaymentMethod.paymentType;$scope.resetPaymentForms();$scope.isPaymentFormValid()}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Payment Initializing Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Initializing Payment - Payment";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.goBackFromPaymentDetail();$scope.showSalesMessagesModal(salesErrorMessage)});$scope.isPaymentTokenizerShow=$rootScope.currentUser.external;if($scope.isPaymentTokenizerShow){tokenizerFunction()}};$scope.populateCreditCard=function(tokenData){TrackingService.trackPageView("Store","Token Success: "+$scope.currentStore.countryName);$scope.isPaymentTypeNotMatch=true;$scope.paymentDetails.confirmedPaymentDetails.expiryDate=tokenData.payment_instrument.credit_card_expiry_date_display;var expiryDateContent=$scope.paymentDetails.confirmedPaymentDetails.expiryDate.split("/");for(var count=0;count<$scope.paymentDetails.creditCardTypes.length;count++){if(($scope.paymentDetails.creditCardTypes[count].type==tokenData.payment_instrument.payment_type)||(tokenData.payment_instrument.payment_type==SalesPaymentConstants.TOKENIZER_MASTER_CARD_TYPE)){$scope.paymentDetails.confirmedPaymentDetails.cardType=tokenData.payment_instrument.payment_type==SalesPaymentConstants.TOKENIZER_MASTER_CARD_TYPE?SalesPaymentConstants.COMMERCE_MASTER_CARD_TYPE:tokenData.payment_instrument.payment_type;$scope.paymentDetails.confirmedPaymentDetails.cardNumber=tokenData.token_id;$scope.paymentDetails.confirmedPaymentDetails.expiryMonth=expiryDateContent[0];$scope.paymentDetails.confirmedPaymentDetails.expiryYear=expiryDateContent[1];$scope.isPaymentTypeNotMatch=false;break}}$scope.tokenCardTypeName=tokenData.payment_instrument.payment_type;$scope.paymentDetails.confirmedPaymentDetails.expirationDate=tokenData.payment_instrument.credit_card_expire_date;$scope.paymentDetails.confirmedPaymentDetails.paymentType=SalesConstants.PAYMENT_CREDIT_CARD_TYPE;$scope.$apply(function(){$scope.isTokenReceived=true})};$scope.resetPaymentView=function(){$scope.$apply(function(){$scope.isTokenReceived=false})};$scope.isPaymentFormValid=function(){var result=false;if(!$scope.paymentDetails||!$scope.paymentDetails.confirmedPaymentDetails){return result}if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.CREDIT_CARD_PAYMENT_TYPE){result=$scope.validateCreditCardForm()}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.SAVED_PAYMENT_INSTRUMENT){result=$scope.validateSavedPaymentInstrument()}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){result=$scope.validateDirectDebitForm();$scope.paymentDetails.bankCountry="DE"}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.PURCHASE_ORDER_PAYMENT_TYPE){result=$scope.validatePoForm()}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result=$scope.validateBankTransferForm()}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.CVS_PAYMENT_TYPE){result=$scope.validateCVSPaymentForm()}else{if($scope.paymentDetails.confirmedPaymentDetails.paymentType==SalesPaymentConstants.PO_PAYMENT_TYPE){result=$scope.validatePoForm()}else{$scope.paymentErrorMessage="Please enter the required fields"}}}}}}}$scope.$parent.updatePaymentValidStatus(result)};$scope.validateCreditCardForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.cardType)||$scope.paymentDetails.confirmedPaymentDetails.cardType==""){$scope.paymentErrorMessage="Card Type Is Required";if($scope.isTokenReceived&&$scope.isPaymentTypeNotMatch){$scope.paymentErrorMessage="The Payment Card Type "+$scope.tokenCardTypeName+"' Is Not Supported For This Country";$scope.isTokenReceived=false}}else{if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.cardNumber)||$scope.paymentDetails.confirmedPaymentDetails.cardNumber==""){$scope.paymentErrorMessage="Token Number Is Required"}else{if(isNaN($scope.paymentDetails.confirmedPaymentDetails.cardNumber)){$scope.paymentErrorMessage="Invalid Characters In Token Number. (Enter Numbers Only.)"}else{if($scope.paymentDetails.confirmedPaymentDetails.cardNumber.toString().length!=SalesPaymentConstants.VALID_TOKEN_LENGTH){$scope.paymentErrorMessage="The Token Number Length Is Invalid"}else{if(!SalesUtil.validateTokenNumber($scope.paymentDetails.confirmedPaymentDetails.cardNumber)){$scope.paymentErrorMessage="The Token Number Is Invalid"}else{if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.expiryMonth)||$scope.paymentDetails.confirmedPaymentDetails.expiryMonth==""){$scope.paymentErrorMessage="Expiry Month Is Required"}else{if($scope.paymentDetails.confirmedPaymentDetails.expiryMonth.toString().length>2||isNaN($scope.paymentDetails.confirmedPaymentDetails.expiryMonth)){$scope.paymentErrorMessage="Expiry Month Is Not Valid"}else{if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.expiryYear)||$scope.paymentDetails.confirmedPaymentDetails.expiryYear==""){$scope.paymentErrorMessage="Expiry Year Is Required"}else{if($scope.paymentDetails.confirmedPaymentDetails.expiryYear.toString().length!=4||isNaN($scope.paymentDetails.confirmedPaymentDetails.expiryYear)){$scope.paymentErrorMessage="Expiry Year Is Not Valid"}else{$scope.paymentErrorMessage="";result=true}}}}}}}}}if(!$scope.isPaymentTokenizerShow){$scope.paymentDetails.confirmedPaymentDetails.expirationDate=new Date(Number($scope.paymentDetails.expiryYear),Number($scope.paymentDetails.expiryMonth-1),1);$scope.paymentDetails.confirmedPaymentDetails.paymentType=SalesPaymentConstants.CREDIT_CARD_PAYMENT_TYPE}if($scope.paymentDetails.confirmedPaymentDetails.expiryYear&&$scope.paymentDetails.confirmedPaymentDetails.expiryMonth){$scope.paymentDetails.confirmedPaymentDetails.expirationDate=new Date(Date.UTC(Number($scope.paymentDetails.confirmedPaymentDetails.expiryYear),Number($scope.paymentDetails.confirmedPaymentDetails.expiryMonth-1),10))}return result};$scope.validateDirectDebitForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.ibaNumber)||$scope.paymentDetails.confirmedPaymentDetails.ibaNumber==""){$scope.paymentErrorMessage="IBAN Number Is Required"}else{if(!$scope.paymentDetails.confirmedPaymentDetails.isIbanValid||$scope.paymentDetails.confirmedPaymentDetails.verifiedIbaNumber!=$scope.paymentDetails.confirmedPaymentDetails.ibaNumber){$scope.paymentErrorMessage="Validation Of Account Is Required Or IBAN Is Incorrect";$scope.isIbanMesageShow=false;$scope.paymentDetails.confirmedPaymentDetails.isIbanValid=false;$scope.ibanValidateMessage=""}else{if((!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.mandateId)||$scope.paymentDetails.confirmedPaymentDetails.mandateId=="")&&features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Please select Sepa emandate"}else{if((!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.bankName)||$scope.paymentDetails.confirmedPaymentDetails.bankName=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Bank Name Is Required"}else{if((!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.city)||$scope.paymentDetails.confirmedPaymentDetails.city=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="City Is Required"}else{$scope.paymentErrorMessage="";$scope.isIbanMesageShow=true;result=true}}}}}return result};$scope.validateDirectDebitAccount=function(){PaymentService.validateIBANDetail({ibanDetail:$scope.paymentDetails.confirmedPaymentDetails.ibaNumber}).success(function(result){if(AppUtils.isHavingErrorMessage(result)){$scope.ibanValidateMessage=AppUtils.getErrorMessage(result);$scope.paymentDetails.confirmedPaymentDetails.isIbanValid=false}else{$scope.ibanValidateMessage=AppUtils.getSuccessMessage(result);$scope.paymentDetails.confirmedPaymentDetails.isIbanValid=true;$scope.paymentDetails.confirmedPaymentDetails.verifiedIbaNumber=$scope.paymentDetails.confirmedPaymentDetails.ibaNumber}$scope.isIbanMesageShow=true}).error(function(result){$scope.ibanValidateMessage="Not able to validate"})};$scope.validatePoForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.poNumber)||$scope.paymentDetails.confirmedPaymentDetails.poNumber==""){$scope.paymentErrorMessage="PO Number is Required"}else{if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.billingEmail)||$scope.paymentDetails.confirmedPaymentDetails.billingEmail==""){$scope.paymentErrorMessage="Payer Billing Email is Required"}else{if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.payerId)||$scope.paymentDetails.confirmedPaymentDetails.payerId==""){$scope.paymentErrorMessage="Payer ID is Required, Please search & select Payer"}else{$scope.paymentErrorMessage="";result=true}}}return result};$scope.validateCVSPaymentForm=function(){$scope.paymentErrorMessage="";return true};$scope.validateBankTransferForm=function(){$scope.paymentErrorMessage="";return true};$scope.validateSavedPaymentInstrument=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.confirmedPaymentDetails.cardType)||$scope.paymentDetails.confirmedPaymentDetails.cardType==""){$scope.paymentErrorMessage="Select One Of The Payment Information"}else{$scope.paymentErrorMessage="";result=true}return result};$scope.resetPaymentForms=function(paymentMethod){if(paymentMethod){$scope.paymentDetails.confirmedPaymentDetails.paymentType=paymentMethod.paymentType}$scope.paymentDetails.confirmedPaymentDetails.cardType=$scope.paymentDetails.confirmedPaymentDetails.cardNumber=$scope.paymentDetails.confirmedPaymentDetails.expiryMonth=$scope.paymentDetails.confirmedPaymentDetails.expiryYear="";$scope.paymentDetails.confirmedPaymentDetails.ibaNumber=$scope.paymentDetails.confirmedPaymentDetails.bankName=$scope.paymentDetails.confirmedPaymentDetails.city=$scope.paymentDetails.confirmedPaymentDetails.accountHolder="";$scope.ibanValidateMessage="";$scope.isIbanMesageShow=false;$scope.paymentDetails.confirmedPaymentDetails.ibaNumber=$scope.paymentDetails.confirmedPaymentDetails.bankKey=$scope.paymentDetails.confirmedPaymentDetails.bankName=$scope.paymentDetails.confirmedPaymentDetails.city=$scope.paymentDetails.accountHolder=$scope.paymentDetails.confirmedPaymentDetails.bankCountry=$scope.paymentDetails.confirmedPaymentDetails.bankAccount=$scope.paymentDetails.confirmedPaymentDetails.controlCode="";$scope.paymentDetails.confirmedPaymentDetails.poNumber="";$scope.paymentDetails.confirmedPaymentDetails.bankTransferNumber=""};$scope.resetPaymentTabPanes=function(){$("#salesPaymentContainer .nav-tabs li").removeClass("active");$("#salesPaymentContainer .tab-pane").removeClass("active");$("#salesPaymentContainer .nav-tabs:first-child").addClass("active");$("#salesPaymentContainer .tab-pane:first-child").addClass("active")};$scope.reviewPaymentDetails=function(){$app.showLoading("Validating Payment");if($scope.paymentDetails.confirmedPaymentDetails.paymentType!=SalesPaymentConstants.SAVED_PAYMENT_INSTRUMENT){SalesUtil.getPaymentInstrument($scope.paymentDetails.confirmedPaymentDetails,$scope.orderServiceDto["payment-instrument"])}var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Validating Payment - Payment";AppUtils.sendLogToServer(messageObject,status,headers,config);SalesUtil.updateCartInformation(result,$scope.salesCatalogCartItems);$scope.updateOrderService(result,SalesConstants.SALES_WIZARD_TNC_STEP)}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Validating Payment Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Validating Payment - Payment";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.enableSavedPaymentInstrument=function(){$scope.paymentDetails.confirmedPaymentDetails.paymentType=SalesPaymentConstants.SAVED_PAYMENT_INSTRUMENT;$scope.resetSavedPaymentInstrument()};$scope.resetSavedPaymentInstrument=function(){angular.forEach($scope.paymentDetails.savedPaymentInstruments,function(paymentInstrument){paymentInstrument.isSelected=false})};$scope.updateSavedPaymentDetails=function(paymentObject){SalesUtil.getSavedPaymentInstrument(paymentObject,$scope.orderServiceDto["payment-instrument"]);$scope.paymentDetails.confirmedPaymentDetails.cardType=paymentObject.type;$scope.resetSavedPaymentInstrument();paymentObject.isSelected=true;$scope.paymentErrorMessage="";$scope.$parent.updatePaymentValidStatus(true);$scope.reviewPaymentDetails()}}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesPlaceOrderController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","SalesServices","$app","SalesConstants","SalesUtil","AppUtils","AppConstants","SFDCService","SFDCConstants","features",function($scope,$log,$rootScope,$location,$routeParams,$timeout,SalesServices,$app,SalesConstants,SalesUtil,AppUtils,AppConstants,SFDCService,SFDCConstants,features){$scope.isOrderConfirmed=$scope.isQuoteConfirmed=false;$scope.orderConfimationDto;$scope.errorMessages;$scope.$on(SalesConstants.SALES_PLACE_ORDER_VIEW_EVENT,function(event){$scope.placeOrderViewDto=angular.copy($scope.orderServiceDto);$scope.updatePlaceOrderView()});$scope.$on(SalesConstants.SALES_QUOTE_REVIEW_EVENT,function(event){$scope.reviewQuoteForCreation()});$scope.updatePlaceOrderView=function(){if($scope.placeOrderViewDto["payment-instrument"]){if($scope.placeOrderViewDto["payment-instrument"]["category"]=="BANK"||$scope.placeOrderViewDto["payment-instrument"]["category"]=="OFFLINE"){$scope.placeOrderViewDto["payment-instrument"]["category"]=$scope.placeOrderViewDto["payment-instrument"]["type"]}}};$scope.reviewQuoteForCreation=function(){$app.showLoading("Reviewing Customer");var orderServiceRequestDto={orderId:$scope.orderServiceDto["order-id"],orderJson:JSON.stringify($scope.orderServiceDto)};SalesServices.updateOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Reviewing Quote - Place Quote";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Quote Reviewing Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Reviewing Quote - Place Quote";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.goBackFromPlaceOrder();$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.placeOrder=function(){if($scope.isQuote){$scope.placeQuote();return}$app.showLoading("Placing Order");$scope.orderDto=angular.copy($scope.orderServiceDto);$scope.orderDto.status=SalesConstants.ORDER_STATUS_SUBMIT;angular.forEach($scope.orderDto.items,function(item){delete item.cartInfo;delete item.isTncDataSuccess;delete item.isTncLoading;delete item.termsAndConditionsAccepted;delete item.newText});var orderServiceRequestDto={orderId:$scope.orderDto["order-id"],orderJson:JSON.stringify($scope.orderDto)};SalesServices.placeOrder(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();$scope.updateSFDCOpportunityDetail(result);if(angular.isDefined(result.telesales["go-cart-id"])&&result.telesales["go-cart-id"].length>0){$timeout(function(){var productSku=result.items[0].sku.id;var returnCaseTemplateUrl="/case/newCs?customerNo="+result["user-id"]+"&tempId="+AppConstants.TEMPLATE_GO_CART_CS_CASE+"&productSku="+productSku+"&orderNumber="+result["order-number"]+"&gid="+result.telesales["go-cart-id"]+"&gidSN="+$scope.serialNumberForCase;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl,"_blank")},1000)}$scope.orderConfimationDto=result;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Placing Order - Place Order";messageObject.Payment_Token_Number=result["payment-instrument"]?result["payment-instrument"]["credit-card-number"]:"";messageObject.Payment_Category=result["payment-instrument"]?result["payment-instrument"]["category"]:"";messageObject.Payment_Type=result["payment-instrument"]?result["payment-instrument"]["type"]:"";messageObject.Payment_Is_Saved=result["payment-instrument"]?result["payment-instrument"]["is-saved"]:"";messageObject.Payment_Token_Number_Masked=result["payment-instrument"]?result["payment-instrument"]["credit-card-number-masked"]:"";AppUtils.sendLogToServer(messageObject,status,headers,config);if($scope.isQuoteToOrder){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Placing Order - Quote To Order";messageObject.Quote_Number=$scope.quoteId;messageObject.Payment_Token_Number=result["payment-instrument"]?result["payment-instrument"]["credit-card-number"]:"";messageObject.Payment_Category=result["payment-instrument"]?result["payment-instrument"]["category"]:"";messageObject.Payment_Type=result["payment-instrument"]?result["payment-instrument"]["type"]:"";messageObject.Payment_Is_Saved=result["payment-instrument"]?result["payment-instrument"]["is-saved"]:"";messageObject.Payment_Token_Number_Masked=result["payment-instrument"]?result["payment-instrument"]["credit-card-number-masked"]:"";AppUtils.sendLogToServer(messageObject,status,headers,config);if(!isNaN($scope.quoteId)){SalesServices.updateQuoteFromOrder({orderNumber:$scope.orderConfimationDto["order-number"],quoteNumber:$scope.quoteId}).success(function(result,status,headers,config){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Functionality="Place Order - Quote Update";messageObject.Order_Number=$scope.orderConfimationDto["order-number"];messageObject.Quote_Number=$scope.quoteId;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Functionality="Place Order - Quote Update";messageObject.Order_Number=$scope.orderConfimationDto["order-number"];messageObject.Quote_Number=$scope.quoteId;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})}}if($scope.isCountryChange&&features.isFeatureEnabled("countrychange")){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Placing Order - Country Change";messageObject.Old_Country=$scope.customerOldCountry;messageObject.New_Country=result.country;messageObject.Payment_Token_Number=result["payment-instrument"]?result["payment-instrument"]["credit-card-number"]:"";messageObject.Payment_Category=result["payment-instrument"]?result["payment-instrument"]["category"]:"";messageObject.Payment_Type=result["payment-instrument"]?result["payment-instrument"]["type"]:"";messageObject.Payment_Is_Saved=result["payment-instrument"]?result["payment-instrument"]["is-saved"]:"";messageObject.Payment_Token_Number_Masked=result["payment-instrument"]?result["payment-instrument"]["credit-card-number-masked"]:"";AppUtils.sendLogToServer(messageObject,status,headers,config)}$scope.isOrderConfirmed=true}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Order Placement Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);if($scope.isSFDCFLow){messageObject.Functionality="SFDC FLow,Placing Order - Place Order"}else{messageObject.Functionality="Placing Order - Place Order"}if($scope.isCountryChange&&features.isFeatureEnabled("countrychange")){messageObject.Functionality="Placing Order - Country Change";messageObject.Old_Country=$scope.customerOldCountry;messageObject.New_Country=$scope.orderServiceDto.country}AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.updateSFDCOpportunityDetail=function(result){var messageObject={Source_System:SFDCConstants.SOURCE_SYSTEM_SFDC};if($scope.isSFDCFLow){if(angular.isDefined(result["order-number"])&&result["order-number"].length>0){SFDCService.updateSFDCOpportunityDetail({oppID:$scope.sopportunityID,process:"AbdApi.UpdateOpportunity",message:"success",order:{orderId:result["order-number"],asynchId:$scope.asynchId}}).success(function(result,status,headers,config){messageObject.Functionality="Update Opportunity - New Sales Order";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=result.message;messageObject.info="success";messageObject.transaction=$scope.orderConfimationDto["order-number"];AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){messageObject.Functionality="Update Opportunity  Error- New  Sales Order";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message="Error on service :"+error.toString();messageObject.info="success";AppUtils.sendLogToServer(messageObject,status,headers,config)})}else{messageObject.Functionality="Opportunity Conversion issue (new sales flow)-  place order not successful(transaction number not generated)";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="Ecommerce order not processed";messageObject.message=result.message;messageObject.info="fail";AppUtils.sendLogToServer(messageObject)}}};$scope.placeQuote=function(){$app.showLoading("Placing Quote");$scope.orderDto=angular.copy($scope.orderServiceDto);angular.forEach($scope.orderDto.items,function(item){delete item.cartInfo;delete item.isTncDataSuccess;delete item.isTncLoading;delete item.termsAndConditionsAccepted;delete item.newText});var orderServiceRequestDto={orderId:$scope.orderDto["order-id"],orderJson:JSON.stringify($scope.orderDto)};SalesServices.placeQuote(orderServiceRequestDto).success(function(result,status,headers,config){$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,true,result);messageObject.Functionality="Placing Quote - Place Quote";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.isQuoteConfirmed=true;$scope.orderConfimationDto=result}).error(function(result,status,headers,config){$app.hideLoading();var salesErrorMessage=SalesUtil.getOrderServiceErrorMessages("Order Placement Error(s)",result,$scope.orderServiceExceptions,headers,$scope.isCustomerInUrlValid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE,AppConstants.SERVICE_INVOKE_ORDER_SERVICE,false,$.isPlainObject(result)?result:$scope.orderServiceDto,salesErrorMessage);messageObject.Functionality="Placing Quote - Place Quote";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.showSalesMessagesModal(salesErrorMessage)})};$scope.goToOrderView=function(){var orderViewUrl="/transaction/"+$scope.orderConfimationDto["order-number"]+"?commerce=true";window.open(AppUtils.getApplicationUrl()+orderViewUrl)};$scope.goToQuoteView=function(){var quoteViewUrl="/quote/"+$scope.orderConfimationDto["order-number"];window.open(AppUtils.getApplicationUrl()+quoteViewUrl)};$scope.restartStore=function(){location.reload(true)};$scope.goToLegacyStore=function(){var legacyStoreUrl="/store/"+$scope.catalogRequestDto.country;window.open(AppUtils.getApplicationUrl()+legacyStoreUrl)}}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesQuoteController",["$scope","$rootScope","$location","$routeParams","$app","AppUtils","AppConstants","SalesConstants","SalesUtil","SalesServices","ImsCustomerService","CommerceServices","$timeout",function($scope,$rootScope,$location,$routeParams,$app,AppUtils,AppConstants,SalesConstants,SalesUtil,SalesServices,ImsCustomerService,CommerceServices,$timeout){$scope.quoteSearchResults=[];$scope.quoteTransactionNotFoundMessage="";$scope.isLoading=true;$scope.quoteSearchFields={quoteNumber:""};$scope.quoteNumber=$routeParams.quoteNo;$scope.quoteSearchFields.quoteNumber=$scope.quoteNumber;$scope.initializeQuote=function(){SalesServices.searchQuotes($scope.quoteSearchFields).success(function(result,status,headers,config){$scope.isLoading=false;$scope.quoteTransactionNotFoundMessage="";if(result&&result.order&&result.order.length>0){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Search Quotes";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.quoteDetail=result.order[0];if($scope.quoteDetail.items&&$scope.quoteDetail.items.length>0){angular.forEach($scope.quoteDetail.items,function(quoteItem){if(quoteItem["offer-id"]){SalesServices.getOfferByOfferId({country:$scope.quoteDetail.country,marketSegment:$scope.quoteDetail["market-segment"],offerId:quoteItem["offer-id"]}).success(function(result,status,headers,config){if(result){quoteItem.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0]}}).error(function(result,status,headers,config){item.cartInfo=null})}else{SalesServices.getOfferBySku({country:$scope.quoteDetail.country,marketSegment:$scope.quoteDetail["market-segment"],sku:quoteItem.sku.id}).success(function(result,status,headers,config){if(result){quoteItem.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0]}}).error(function(result,status,headers,config){item.cartInfo=null})}})}}else{$scope.quoteTransactionNotFoundMessage="Quote not found."}}).error(function(result,status,headers,config){$scope.isLoading=false;$scope.quoteTransactionNotFoundMessage="Quote not found.";var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quote View - Search Quotes";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.convertToOrder=function(quote){var url="/sales?store="+angular.uppercase(quote.country);if(quote["market-segment"]!=AppConstants.STORE_TYPE_COM){url=url+"-EDU"}$location.url(url+"&quote="+quote["order-number"])};$scope.resendQuote=function(quote){$scope.isResendQuoteLoading=true;$("#resendQuoteModal").modal("show");$scope.resendQuoteMessage="";SalesServices.resendQuote({quoteId:quote["order-id"],email:quote["payment-instrument"]["billing-address"]["contact"]["primary-email"],lang:"en"}).success(function(result,status,headers,config){if(result){$scope.resendQuoteMessage=result.message;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Resend Quotes";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Quote_ID=quote["order-id"];messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.resendQuoteMessage="Resending Quote Email Failed";var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Resend Quotes";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Quote_ID=quote["order-id"];messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}$scope.isResendQuoteLoading=false}).error(function(result,status,headers,config){$scope.resendQuoteMessage="Resending Quote Email Failed";$scope.isResendQuoteLoading=false;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Resend Quotes";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Quote_ID=quote["order-id"];messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.hideResendQuote=function(quote){$scope.isResendQuoteLoading=false;$("#resendQuoteModal").modal("hide");$scope.resendQuoteMessage=""};$scope.openDeleteQuote=function(){$scope.isDeleteQuoteConfirmation=true;$("#deleteQuoteModal").modal("show")};$scope.deleteQuote=function(){$scope.isDeleteQuoteConfirmation=false;$scope.isDeleteQuoteLoading=true;$scope.deleteQuoteMessage="";CommerceServices.deleteQuote({orderId:$scope.quoteDetail["order-id"]}).success(function(result,status,headers,config){$scope.isDeleteQuoteLoading=false;$scope.deleteQuoteMessage="Delete Quote Is Successful";$scope.isDeleteQuoteSuccess=true;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Delete Quote";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Quote_ID=$scope.quoteDetail["order-id"];messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.deleteQuoteMessage="Delete Quote Is Not Successful";$scope.isDeleteQuoteLoading=false;$scope.isDeleteQuoteSuccess=false;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Quotes View - Delete Quote";messageObject.Quote_Number=$scope.quoteNumber;messageObject.Quote_ID=$scope.quoteDetail["order-id"];messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.hideDeleteQuote=function(quote){$scope.isDeleteQuoteConfirmation=$scope.isDeleteQuoteLoading=false;$("#deleteQuoteModal").modal("hide");$scope.deleteQuoteMessage="";if($scope.isDeleteQuoteSuccess){$location.url("/search")}};$scope.openPdfView=function(quote){var pdfViewWindow;var url=hendrixConfig.endpoints.commerceanyware+"/quotes/"+quote["order-id"]+"?lang=en";var left=(screen.width/2)-(900/2);var top=(screen.height/2)-(800/2);pdfViewWindow=window.open(url,"QuotePdfView","width=900,height=800,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left="+left+",top="+top);pdfViewWindow.focus()};$scope.initializeQuote()}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("SalesRequestDto",{"market-segment":"COM",status:"IN_PROGRESS",country:"US",type:"NEW_ORDER",telesales:{agent:{id:"","first-name":"","last-name":""},"go-cart-id":""},"payment-instrument":{},items:[]});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SalesServices",["$http",function($http){var service={};service.getProductsCatalog=function(data){return $http({method:"POST",url:"../subscriptionService/getSubscriptionOfferings.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getSkuFilterList=function(){return $http({method:"GET",cache:true,url:"../hx5/json/catalog-filter.json"})};service.getOfferBySku=function(data){return $http({method:"POST",url:"../salesService/getOfferBySku.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getOfferByOfferId=function(data){return $http({method:"POST",url:"../salesService/getOfferByOfferId.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getPerpetualProductsCatalog=function(){return $http({method:"GET",cache:true,url:"../hx5/json/perpetual-products.json"})};service.hasQualifyingCCEntitlementForStock=function(data){return $http({method:"POST",url:"../productService/hasQualifyingCCEntitlementForStock.do",data:data})};service.createViaCommerce=function(data){return $http({method:"POST",url:"../transactionService/createViaCommerce.do",headers:{"Content-Type":"application/json;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},data:data})};service.updateOrder=function(data){return $http({method:"POST",url:"../transactionService/updateOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.placeOrder=function(data){return $http({method:"POST",url:"../transactionService/placeOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.placeQuote=function(data){return $http({method:"POST",url:"../transactionService/placeOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},transformRequest:transform,data:data})};service.createPerson=function(data){return $http({method:"POST",url:"../imsSecondaryClientService/createPerson.do",headers:{"Content-Type":"application/json",Accept:"*/*"},data:data})};service.getOrderExceptions=function(){return $http({method:"GET",cache:true,url:"../hx5/json/order-exceptions.json"})};service.validateIBANDetail=function(data){return $http({method:"POST",url:"../transactionService/validateIBANDetail.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getQuoteDetails=function(quoteNumber){return $http({method:"GET",url:"../transactionService/getQuote.do",params:{quoteNumber:quoteNumber}})};service.getCrmQuote=function(data){return $http({method:"POST",url:"../transactionService/getTransaction.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.createDRCart=function(data){return $http({method:"POST",url:"../salesService/createContractCart.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"*/*"},transformRequest:transform,data:data})};service.updateDRCart=function(data){return $http({method:"POST",url:"../salesService/updateContractCart.do",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"*/*"},transformRequest:transform,data:data})};service.updateQuoteFromOrder=function(data){return $http({method:"POST",url:"../transactionService/updateQuoteFromOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.searchQuotes=function(searchData){var apiHubData={urlKey:"commerce-quote-searchQuotes",queryParameters:{"order-type":"QUOTE","order-number":searchData.quoteNumber,email:searchData.quoteEmail,"company-name":searchData.quoteCompanyName}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.resendQuote=function(data){var apiHubData={urlKey:"commerce-quote-resendQuote",pathVariables:{"order-id":data.quoteId},requestBody:{requestor:data.email,languageCode:data.lang},requestBodyType:"application/json"};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.searchByOfferId=function(searchData){var apiHubData={urlKey:"commerce-quote-searchQuotes",queryParameters:{"order-type":"QUOTE","order-number":searchData.quoteNumber,email:searchData.quoteEmail,"company-name":searchData.quoteCompanyName}};return $http({method:"POST",url:"../apihub/processRequest.do",header:{"Content-Type":"application/json"},data:apiHubData})};service.getStoreAnywareEndpoint=function(){return $http({method:"POST",url:"../salesService/getStoreAnywareEndpoint.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformResponse:function(data,headers){return data},responseType:"text"})};return service}]);var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("SalesTncController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","StoreConstants","StoreUtil","SalesPaymentConstants","AppUtils","SalesServices","SalesDto","PaymentService","TrackingService","TransactionConstants","$app","$http","SalesConstants","SalesUtil","ImsCustomerService","StoreTransactionService","CommerceServices",function($scope,$log,$rootScope,$location,$routeParams,$timeout,StoreConstants,StoreUtil,SalesPaymentConstants,AppUtils,SalesServices,SalesDto,PaymentService,TrackingService,TransactionConstants,$app,$http,SalesConstants,SalesUtil,ImsCustomerService,StoreTransactionService,CommerceServices){$scope.$on(SalesConstants.SALES_TNC_INITIALIZE_EVENT,function(event){$scope.initializeTncContent()});$scope.initializeTncContent=function(){$app.showLoading("Initializing T&C");if(!$scope.orderServiceDto.items||$scope.orderServiceDto.items.length==0){$app.hideLoading();return}var tncSuccessCount=0;angular.forEach($scope.orderServiceDto.items,function(tncItem){tncItem.isTncLoading=tncItem.isTncDataSuccess=true;tncItem.cartInfo.name=_.has(tncItem,"cartInfo.name")?tncItem.cartInfo["name"]:"";if(tncItem.cartInfo.tncTemplateName){var language=StoreUtil.getDefaultCountryLanguage($scope.catalogRequestDto.country);if(angular.uppercase($scope.catalogRequestDto.country)=="FI"||angular.uppercase($scope.catalogRequestDto.country)=="NO"){language="EN"}var tncTemplate=tncItem.cartInfo.tncTemplateName;if($scope.selectedPaymentMethod.paymentType==SalesPaymentConstants.PURCHASE_ORDER_PAYMENT_TYPE||($scope.selectedPaymentMethod.paymentType==SalesPaymentConstants.BANK_TRANSFER_PAYMENT_TYPE)&&$scope.isTeamSubscription){tncTemplate=SalesConstants.TNC_TEMPLATE_NAME_FOR_PO_PAYMENT}ImsCustomerService.getTncByTemplate({templateName:tncTemplate,locale:language}).success(function(result){tncSuccessCount=tncSuccessCount+1;if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText}tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true;if(tncSuccessCount==$scope.orderServiceDto.items.length){$app.hideLoading()}}).error(function(result){tncItem.isTncLoading=false;tncItem.isTncDataSuccess=false;$app.hideLoading();AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.catalogRequestDto.countryName+"("+$scope.catalogRequestDto.country+") for SKU = "+tncItem.sku.id)})}else{CommerceServices.searchBySku({sku:tncItem.sku.id,country:$scope.catalogRequestDto.country,market_segment:$scope.catalogRequestDto.marketSegment}).success(function(data,status,headers,config){if(data&&data.sellableItem&&data.sellableItem.terms_and_conditions_service_name){var language=StoreUtil.getDefaultCountryLanguage($scope.catalogRequestDto.country);if(angular.uppercase($scope.catalogRequestDto.country)=="FI"||angular.uppercase($scope.catalogRequestDto.country)=="NO"){language="EN"}var tncTemplate=$scope.selectedPaymentMethod.payementType==SalesPaymentConstants.PURCHASE_ORDER_PAYMENT_TYPE?SalesConstants.TNC_TEMPLATE_NAME_FOR_PO_PAYMENT:AppUtils.checkSKUForPredefinedTemplate()?"tc_cm_complete_anu":data.sellableItem.terms_and_conditions_service_name;ImsCustomerService.getTncByTemplate({templateName:tncTemplate,locale:language}).success(function(result){tncSuccessCount=tncSuccessCount+1;if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText}tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true;if(tncSuccessCount==$scope.orderServiceDto.items.length){$app.hideLoading()}}).error(function(result){tncItem.isTncLoading=false;tncItem.isTncDataSuccess=false;$app.hideLoading();AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.catalogRequestDto.countryName+"("+$scope.catalogRequestDto.country+") for SKU = "+tncItem.sku.id)})}else{tncItem.isTncLoading=tncItem.isTncDataSuccess=false;$app.hideLoading();AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.catalogRequestDto.countryName+"("+$scope.catalogRequestDto.country+") for SKU = "+tncItem.sku.id)}}).error(function(result,status,headers,config){tncItem.isTncDataSuccess=false;tncItem.isTncLoading=false;$app.hideLoading();AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.catalogRequestDto.countryName+"("+$scope.catalogRequestDto.country+") for SKU = "+tncItem.sku.id)})}})};$scope.reloadTnc=function(tncItem){tncItem.isTncLoading=tncItem.isTncDataSuccess=true;var language=StoreUtil.getDefaultCountryLanguage($scope.catalogRequestDto.country);if(angular.uppercase($scope.catalogRequestDto.country)=="FI"||angular.uppercase($scope.catalogRequestDto.country)=="NO"){language="EN"}StoreTransactionService.getTncBySku({sku:tncItem.sku.id,storeId:$scope.currentStore.storeKey,language:language}).success(function(result){var tncText=result;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText;tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true}).error(function(result){tncItem.isTncLoading=tncItem.isTncDataSuccess=false;AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.catalogRequestDto.countryName+"("+$scope.catalogRequestDto.country+") for SKU = "+tncItem.sku.id)})};$scope.updateTermsAndConditionsAsTrue=function(termsAndConditions,collapseId){termsAndConditions.termsAndConditionsAccepted=true;$scope.toggleTnCPanel(collapseId);$scope.updateTermsAndConditionsStatus()};$scope.collapseTnCPanel=function(collapseId){$("#collapse"+collapseId).collapse("toggle")};$scope.toggleTnCPanel=function(collapseId){$scope.toggleClassName(collapseId);$scope.collapseTnCPanel(collapseId);collapseId--;$scope.collapseTnCPanel(collapseId)};$scope.updateTermsAndConditionsStatus=function(){for(var count=0;count<$scope.orderServiceDto.items.length;count++){if(!$scope.orderServiceDto.items[count].termsAndConditionsAccepted){$scope.$parent.updateTermsAndConditions(false);break}else{if(count==$scope.orderServiceDto.items.length-1){$scope.$parent.updateTermsAndConditions(true)}}}};$scope.toggleClassName=function(eventTarget){for(var toggle=0;toggle<$scope.orderServiceDto.items.length;toggle++){if(eventTarget===toggle){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-minus pull-right")}else{if(angular.isNumber(eventTarget)){$("#toggle"+toggle).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right")}}}};$scope.toggleClassOnGlyphClick=function(eventTarget){for(var toggle=0;toggle<$scope.orderServiceDto.items.length;toggle++){if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-plus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-minus pull-right");$("#collapse"+toggle).collapse("show")}else{if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-minus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}else{if(angular.isNumber(eventTarget)){$("#toggle"+toggle).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}}}}};$scope.goToOrderPlacement=function(){$scope.$parent.updateTermsAndConditions(true)}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("SalesUtil",["$rootScope","$location","$routeParams","CatalogProductDto","ImsCustomerDto","StoreDto","AddressDto","SalesCustomerDto","AppConstants","SalesConstants","SalesDto","SalesRequestDto","SalesContractCartRequestDto","CustomerRequestDto","AppUtils","SalesPaymentConstants","CustomerConstants",function($rootScope,$location,$routeParams,CatalogProductDto,ImsCustomerDto,StoreDto,AddressDto,SalesCustomerDto,AppConstants,SalesConstants,SalesDto,SalesRequestDto,SalesContractCartRequestDto,CustomerRequestDto,AppUtils,SalesPaymentConstants,CustomerConstants){this.getSalesCatalogProducts=function(products,skuFilterList){var catalogProducts=[];angular.forEach(products,function(product){var catalogProductDto=angular.copy(CatalogProductDto);catalogProductDto.name=_.has(product,"material.data.localizedData[0].name")?!_.isNull(product.material["data"]["localizedData"][0]["name"])?product.material["data"]["localizedData"][0]["name"]:"":"";catalogProductDto.longName=_.has(product,"material.data.localizedData[0].longDescription")?!_.isNull(product.material["data"]["localizedData"][0]["longDescription"])?product.material["data"]["localizedData"][0]["longDescription"]:"":"";catalogProductDto.description=_.has(product,"description")?!_.isNull(product.description)?product.description:"":"";catalogProductDto.pricePoint=_.has(product,"pricePoint")?!_.isNull(product.pricePoint)?product.pricePoint:"":"";catalogProductDto.primaryImage=_.has(product,"material.data.detail.primaryImageUrl")?product.material["data"]["detail"]["primaryImageUrl"]!=null?"https://wwwimages2.adobe.com"+product.material["data"]["detail"]["primaryImageUrl"]:SalesConstants.INDIVIDUAL_PRODUCT_IMAGE:SalesConstants.INDIVIDUAL_PRODUCT_IMAGE;catalogProductDto.smallImage=_.has(product,"material.data.detail.images[0].url")?"https://wwwimages2.adobe.com"+product.material["data"]["detail"]["images"][0]["url"]:SalesConstants.INDIVIDUAL_PRODUCT_IMAGE;catalogProductDto.bigImage=_.has(product,"material.data.detail.images[2].url")?"https://wwwimages2.adobe.com"+product.material["data"]["detail"]["images"][2]["url"]:SalesConstants.INDIVIDUAL_PRODUCT_IMAGE;catalogProductDto.offerId=_.has(product,"id")?product.id:"";catalogProductDto.materialId=_.has(product,"countryMaterialMap[0].materialId")?product.countryMaterialMap[0]["materialId"]:"";catalogProductDto.businessSegment=_.has(product,"businessSegment")?product.businessSegment:"";catalogProductDto.country=_.has(product,"countryMaterialMap[0].country")?product.countryMaterialMap[0]["country"]:"";catalogProductDto.marketSegment=_.has(product,"marketSegment[0]")?product.marketSegment[0]:"";catalogProductDto.productCode=_.has(product,"productCode")?product.productCode:"";catalogProductDto.productKey=_.has(product,"ordering.data.productKey")?product.ordering["data"]["productKey"]:"";catalogProductDto.productType=catalogProductDto.businessSegment==SalesConstants.CATALOG_BUSINESS_CODE_TEAM_DIRECT?SalesConstants.PRODUCT_TYPE_TEAM:SalesConstants.PRODUCT_TYPE_DSP;catalogProductDto.platformCode=_.has(product,"material.data.platformCode")?product.material["data"]["platformCode"]:"";catalogProductDto.version=_.has(product,"material.data.version")?product.material["data"]["version"]:"";catalogProductDto.languageCode=_.has(product,"material.data.languageCode")?product.material["data"]["languageCode"]:"";catalogProductDto.billingFrequency=_.has(product,"billing.data.billingFrequency")?product.billing["data"]["billingFrequency"]:"";catalogProductDto.serviceCommitment=_.has(product,"ordering.data.serviceCommitment")?product.ordering["data"]["serviceCommitment"]:"";catalogProductDto.currency=_.has(product,"pricing.data.countryPriceData[0].currency")?product.pricing["data"]["countryPriceData"][0]["currency"]:"";catalogProductDto.price=_.has(product,"pricing.data.countryPriceData[0].priceMap.price")?product.pricing["data"]["countryPriceData"][0]["priceMap"]["price"]:"";catalogProductDto.promo=_.has(product,"promotion")?product.promotion["data"]:"";catalogProductDto.commitmentTerm=_.has(product,"commitment.data")?product.commitment["data"]:"";catalogProductDto.tags=_.has(product,"tags")?product.tags.toString():"";catalogProductDto.channels=_.has(product,"channels")?product.channels:"";catalogProductDto.cartQtyLimit=_.has(product,"ordering.data.cartQuantityLimit")?product.ordering["data"]["cartQuantityLimit"]:1;catalogProductDto.qtySelected=1;catalogProductDto.addToCartState=SalesConstants.ADD_TO_CART_ENABLE;catalogProductDto.tncTemplateName=_.has(product,"termsAndConditions.href")?AppUtils.getParameterByName("service_name",product.termsAndConditions["href"]):"";catalogProductDto.isFMF=catalogProductDto.tags.indexOf("FMF_PROMO")!=-1?true:false;if(catalogProductDto.pricePoint.indexOf("PROMO_")!=-1||catalogProductDto.tags.indexOf("PROMO")!=-1||catalogProductDto.isFMF||angular.lowercase(catalogProductDto.productKey).indexOf("promo")!=-1){catalogProductDto.isPromo=true}else{catalogProductDto.isPromo=false}if(catalogProductDto.tags.indexOf("STOCK_BUNDLE")!=-1){catalogProductDto.isStock=true}else{catalogProductDto.isStock=false}catalogProductDto.name+=catalogProductDto.businessSegment==AppConstants.PRODUCTS_MODEL_CODE_TEAM_DIRECT?" Team":"";catalogProductDto.isTeam=catalogProductDto.businessSegment==AppConstants.PRODUCTS_MODEL_CODE_TEAM_DIRECT;var skuFilterFound=false;if(skuFilterList&&skuFilterList.length>0){for(var skuCount=0;skuCount<skuFilterList.length;skuCount++){if(skuFilterList[skuCount].countries.indexOf(catalogProductDto.country)!=-1&&catalogProductDto.marketSegment==skuFilterList[skuCount].marketSegment&&catalogProductDto.materialId==skuFilterList[skuCount].sku){skuFilterFound=true;break}}}if(catalogProductDto.tags.indexOf("OVERAGE")==-1&&catalogProductDto.tags.indexOf("THIRD_PARTY")==-1&&catalogProductDto.tags.indexOf("STOCK_ON_DEMAND")==-1&&!skuFilterFound&&catalogProductDto.channels.indexOf("hdx_offers")!=-1){catalogProducts.push(catalogProductDto)}});return catalogProducts};this.getCustomerResultDto=function(isImsData,customer){var customerDto={};if(isImsData&&angular.lowercase(customer.account_type)=="type1"){customerDto.rengaId=customer.userId.replace(/@AdobeID/i,"");customerDto.rengaGuid=customer.userId;customerDto.accountType=_.has(customer,"account_type")?customer.account_type:"";customerDto.firstName=_.has(customer,"first_name")?customer.first_name:"";customerDto.lastName=_.has(customer,"last_name")?customer.last_name:"";customerDto.email=_.has(customer,"email")?customer.email:"";customerDto.telephone=_.has(customer,"phoneNumber")?customer.phoneNumber:"";if(_.has(customer,"address.mail_to")&&angular.isDefined(customer.address)&&angular.isDefined(customer["address.mail_to"])){customerDto.address={street1:customer["address.mail_to"]["line1"],street2:customer["address.mail_to"]["line2"],street3:customer["address.mail_to"]["line3"],city:customer["address.mail_to"]["city"],stateName:customer["address.mail_to"]["stateProv"],postCode:customer["address.mail_to"]["postalZip"],countryCode:customer["address.mail_to"]["countryCode"],countryName:customer["address.mail_to"]["countryCode"]};customerDto.countryCode=_.has(customer,"countryCode")?customer.countryCode:""}else{if(customer.address){var addressList=customer.address.split(",");customerDto.address={street1:addressList[1].replace(/null/gi,""),street2:"",street3:"",city:addressList[2],stateName:addressList[3],postCode:addressList[5],countryCode:addressList[6],countryName:addressList[6]}}}customerDto.countryCode=_.has(customer,"countryCode")?customer.countryCode:""}else{customerDto.rengaId=customer.rengaGuid.replace(/@AdobeID/i,"");customerDto.accountType="";customerDto.firstName=_.has(customer,"firstName")?customer.firstName:"";customerDto.lastName=_.has(customer,"lastName")?customer.lastName:"";customerDto.email=_.has(customer,"adobeId")?customer.adobeId:"";customerDto.telephone=_.has(customer,"mobilePhone")?customer.mobilePhone:"";customerDto.address={street1:_.has(customer,"address.street1")?customer.address["street1"]:"",street2:_.has(customer,"address.street2")?customer.address["street2"]:"",street3:_.has(customer,"address.street3")?customer.address["street3"]:"",city:_.has(customer,"address.city")?customer.address["city"]:"",stateName:_.has(customer,"address.stateName")?customer.address["stateName"]:"",postCode:_.has(customer,"address.postCode")?customer.address["postCode"]:"",countryCode:_.has(customer,"address.country.code")?customer.address["country"]["code"]:"",countryName:_.has(customer,"address.country.name")?customer.address["country"]["name"]:""};customerDto.countryCode=_.has(customer,"address.country.code")?customer.address["country"]["code"]:""}return customerDto};this.getCurrentStoreData=function(storeName,country,store){var storeCountry=angular.uppercase(storeName);var storeDto=angular.copy(StoreDto);if(storeCountry==country.code){storeDto.selling=country.selling}if(storeCountry==store.countryCode){storeDto.countryCode=store.countryCode;storeDto.countryName=store.countryName;storeDto.storeKey=store.key;storeDto.region=store.regionId;storeDto.storeName=storeName;storeDto.crmStoreName=store.storeName;storeDto.storeType=store.storeType;storeDto.storeTypeName=store.storeType==AppConstants.STORE_TYPE_COM?AppConstants.STORE_TYPE_COMMERCIAL:AppConstants.STORE_TYPE_EDUCATIONAL;storeDto.isEduStore=store.storeType==AppConstants.STORE_TYPE_COM?false:true;storeDto.locale=this.getCountryLocale(store.countryCode)}return storeDto};this.getCurrentDrStoreData=function(storeName,country,store){var storeCountry=angular.uppercase(storeName);var storeDto=angular.copy(StoreDto);if(storeCountry==country.code){storeDto.selling=country.selling}if(storeCountry==store.countryCode){storeDto.countryCode=store.countryCode;storeDto.countryName=store.country;storeDto.storeKey="";storeDto.region=country.region;storeDto.storeName=storeName;storeDto.crmStoreName=store.name;storeDto.storeType=store.storeType;storeDto.storeTypeName=store.storeType==AppConstants.STORE_TYPE_COM?AppConstants.STORE_TYPE_COMMERCIAL:AppConstants.STORE_TYPE_EDUCATIONAL;storeDto.isEduStore=store.storeType==AppConstants.STORE_TYPE_COM?false:true;storeDto.locale=store.locale}return storeDto};this.getCountryLocale=function(countryCode){var defaultLocale="EN";if(angular.uppercase(SalesConstants.COUNTRIES_LOCALE).indexOf(countryCode)>=0){defaultLocale=SalesConstants.COUNTRIES_LOCALE.substr(SalesConstants.COUNTRIES_LOCALE.indexOf(countryCode)+3,2)}return defaultLocale};this.getCustomerDetailsData=function(isImsData,customerObj){var customerDetails=angular.copy(SalesCustomerDto);var addressDto=angular.copy(AddressDto);if(isImsData){customerDetails.firstName=customerObj.first_name;customerDetails.lastName=customerObj.last_name;customerDetails.displayName=customerObj.displayName;customerDetails.email=customerObj.email;customerDetails.customerGuid=customerObj.userId.replace(/@AdobeID/i,"");customerDetails.phone=customerObj.phoneNumber;customerDetails.country=customerObj.countryCode;customerDetails.address=this.getAddressDtoFromImsAddress(customerObj);customerDetails.userId=customerObj.userId.replace(/@AdobeID/i,"");customerDetails.userGuid=customerObj.userId;if(angular.isDefined(customerObj.countryCode)&&customerObj.countryCode.length>0){customerDetails.address.country.code=customerObj.countryCode}}else{customerDetails.firstName=_.has(customerObj,"firstName")?customerObj.firstName:"";customerDetails.lastName=_.has(customerObj,"lastName")?customerObj.lastName:"";customerDetails.displayName=customerDetails.firstName+" "+customerDetails.lastName;customerDetails.email=_.has(customerObj,"email")?customerObj.email:"";customerDetails.customerGuid=customerObj.userId.replace(/@AdobeID/i,"");customerDetails.phone=_.has(customerObj,"mobileNo")?customerObj.mobileNo:"";addressDto.street1=_.has(customerObj,"address.street1")?customerObj.address["street1"]:"";addressDto.street2=_.has(customerObj,"address.street2")?customerObj.address["street2"]:"";addressDto.street3=_.has(customerObj,"address.street3")?customerObj.address["street3"]:"";addressDto.city=_.has(customerObj,"address.city")?customerObj.address["city"]:"";addressDto.state=_.has(customerObj,"address.state")?customerObj.address["state"]:"";addressDto.stateName=_.has(customerObj,"address.stateName")?customerObj.address["stateName"]:"";addressDto.postCode=_.has(customerObj,"address.postCode")?customerObj.address["postCode"]:"";addressDto.country.code=_.has(customerObj,"address.country.code")?customerObj.address["country"]["code"]:"";addressDto.country.name=_.has(customerObj,"address.country.name")?customerObj.address["country"]["name"]:"";customerDetails.address=addressDto;customerDetails.country=_.has(customerObj,"address.country.code")?customerObj.address["country"]["code"]:"";customerDetails.companyName=_.has(customerObj,"companyName")?customerObj.companyName:"";customerDetails.userId=customerObj.userId.replace(/@AdobeID/i,"");customerDetails.phoneticLastName=_.has(customerObj,"phoneticLastName")?customerObj.phoneticLastName:"";customerDetails.phoneticFirstName=_.has(customerObj,"phoneticFirstName")?customerObj.phoneticFirstName:"";customerDetails.phoneticCompanyName=_.has(customerObj,"phoneticCompanyName")?customerObj.phoneticCompanyName:"";customerDetails.wardVillage=_.has(customerObj,"homeCity")?customerObj.homeCity:"";customerDetails.taxInfo=_.has(customerObj,"taxInfo")?customerObj.taxInfo:""}return customerDetails};this.getAddressDtoFromImsAddress=function(imsCustomer){var imsAddress=imsCustomer.address;var addressDto=angular.copy(AddressDto);if(_.has(imsCustomer,"address.mail_to")&&angular.isDefined(imsCustomer.address)&&angular.isDefined(imsCustomer["address.mail_to"])){addressDto.city=imsCustomer["address.mail_to"]["city"];addressDto.state=imsCustomer["address.mail_to"]["stateProv"];addressDto.postCode=imsCustomer["address.mail_to"]["postalZip"];addressDto.country.code=imsCustomer["address.mail_to"]["countryCode"];addressDto.street1=imsCustomer["address.mail_to"]["line1"];addressDto.street2=imsCustomer["address.mail_to"]["line2"];addressDto.street3=imsCustomer["address.mail_to"]["line3"]}else{if(angular.isDefined(imsAddress)&&imsAddress.length>0){var detailList=imsAddress.split(",");addressDto.city=detailList.length>2?detailList[2].trim().replace(/null/g,"").trim():"";try{addressDto.state=angular.isDefined(detailList[3].trim())?detailList[3].trim().split(".")[1].replace(/null/g,"").trim():""}catch(e){addressDto.state="";console.log("State is not valid")}addressDto.postCode=detailList.length>5?detailList[5].trim().replace(/null/g,"").trim():"";addressDto.country.code=detailList.length>6?detailList[6].trim().replace(/null/g,"").trim():"";addressDto.street1=detailList[1].trim().replace(/null/g,"")}}return addressDto};this.getInitialOrderServiceDto=function(orderServiceObject,orderServiceResultDto){var orderServiceDto;if(orderServiceObject){orderServiceDto=angular.copy(SalesRequestDto);if(orderServiceObject.countryInfo){orderServiceDto.country=orderServiceObject.countryInfo.country;orderServiceDto["market-segment"]=orderServiceObject.countryInfo.marketSegment}if(orderServiceObject.customer){if(orderServiceObject.customer.userId){orderServiceDto["user-id"]=orderServiceObject.customer.userId.replace(/@AdobeID/i,"")}}if(orderServiceObject.agentInfo){orderServiceDto.telesales.agent.id=orderServiceObject.agentInfo.username;orderServiceDto.telesales.agent["first-name"]=orderServiceObject.agentInfo.firstName;orderServiceDto.telesales.agent["last-name"]=orderServiceObject.agentInfo.lastName}if(orderServiceObject.goCartId){orderServiceDto.telesales["go-cart-id"]=orderServiceObject.goCartId}if(orderServiceObject.cartItems){var promoCodes=[];angular.forEach(orderServiceObject.cartItems,function(cartItem){orderServiceDto.items.push({quantity:Number(cartItem.qtySelected),sku:{id:cartItem.materialId},"offer-id":cartItem.offerId?cartItem.offerId:""});if(cartItem.promo){promoCodes.push({"promotion-code":cartItem.promo.extendedPromoCode})}});if(promoCodes.length>0){orderServiceDto.promotions=promoCodes}}}if(orderServiceResultDto["order-id"]&&orderServiceDto["market-segment"]==orderServiceResultDto["market-segment"]){orderServiceDto["order-id"]=orderServiceResultDto["order-id"];orderServiceDto["order-number"]=orderServiceResultDto["order-number"]}if(orderServiceResultDto["quote-id"]){orderServiceDto["quote-id"]=orderServiceResultDto["quote-id"]}if(orderServiceResultDto&&orderServiceResultDto.telesales&&orderServiceResultDto.telesales["go-cart-id"]){orderServiceDto.telesales["go-cart-id"]=orderServiceResultDto.telesales["go-cart-id"]}return orderServiceDto};this.getOrderServiceDtoFromTransactionDto=function(transactionDto){var orderServiceDto;if(transactionDto){orderServiceDto=angular.copy(SalesRequestDto);if(transactionDto.customer){orderServiceDto.country=transactionDto.customer.address.country.code;orderServiceDto["market-segment"]=transactionDto.edu?"EDU":"COM"}if(transactionDto.items){angular.forEach(transactionDto.items,function(orderItem){orderServiceDto.items.push({quantity:Number(orderItem.quantity),sku:{id:orderItem.sku}})})}}return orderServiceDto};this.getInitialContractCartServiceDto=function(orderServiceObject,orderServiceResultDto,removeOrderItem){var orderServiceDto;if(orderServiceObject){if(orderServiceResultDto){orderServiceDto=angular.copy(orderServiceResultDto)}else{orderServiceDto=angular.copy(SalesRequestDto)}if(orderServiceObject.cartItems&&orderServiceObject.cartItems.length>0){for(var cartItemCount=0;cartItemCount<orderServiceObject.cartItems.length;cartItemCount++){var cartItemFound=false;for(var itemCount=0;itemCount<orderServiceDto.cartItems.length;itemCount++){if(orderServiceObject.cartItems[cartItemCount].offerId==orderServiceDto.cartItems[itemCount].offerId){orderServiceDto.cartItems[itemCount].quantity=Number(orderServiceObject.cartItems[cartItemCount].qtySelected);cartItemFound=true}}if(!cartItemFound){orderServiceDto.cartItems.push({quantity:Number(orderServiceObject.cartItems[cartItemCount].qtySelected),offerId:orderServiceObject.cartItems[cartItemCount].offerId})}}}if(removeOrderItem){for(var itemCount=0;itemCount<orderServiceDto.cartItems.length;itemCount++){if(removeOrderItem.offerId==orderServiceDto.cartItems[itemCount].offerId){orderServiceDto.cartItems.splice(itemCount,1)}}}}return orderServiceDto};this.getContractCartServiceDtoFromOrderServiceDto=function(orderServiceDto){var contractCartDto;if(orderServiceDto.cartId){contractCartDto=angular.copy(orderServiceDto)}else{contractCartDto=angular.copy(SalesContractCartRequestDto);contractCartDto.country=orderServiceDto.country;if(orderServiceDto.items&&orderServiceDto.items.length>0){angular.forEach(orderServiceDto.items,function(orderItem){var cartDto=new Object();cartDto.quantity=Number(orderItem.quantity);cartDto.offerId=orderItem["offer-id"];if(orderItem.id){cartDto.id=orderItem.id}contractCartDto.cartItems.push(cartDto)})}}if(contractCartDto.items){delete contractCartDto.items}if(contractCartDto["user-id"]){delete contractCartDto["user-id"]}return contractCartDto};this.getOrderServiceDtoFromContractCartServiceDto=function(contractCartDto,orderServiceDto){if(contractCartDto&&orderServiceDto){orderServiceDto=angular.copy(contractCartDto);orderServiceDto.items=angular.copy(contractCartDto.cartItems)}return orderServiceDto};this.getOrderServiceDtoFromQuoteDto=function(quoteDto,agentInfo){var orderServiceDto;if(quoteDto){orderServiceDto=angular.copy(SalesRequestDto);orderServiceDto["quote-id"]=quoteDto["order-id"];orderServiceDto["user-id"]=quoteDto["user-id"];orderServiceDto.country=quoteDto.country;orderServiceDto["market-segment"]=quoteDto["market-segment"];orderServiceDto.items=quoteDto.items;orderServiceDto["payment-instrument"]=quoteDto["payment-instrument"];orderServiceDto.telesales.agent.id=agentInfo.username;orderServiceDto.telesales.agent["first-name"]=agentInfo.firstName;orderServiceDto.telesales.agent["last-name"]=agentInfo.lastName;delete orderServiceDto["order-id"];delete orderServiceDto["order-number"]}return orderServiceDto};this.getPaymentDetails=function(orderServiceDto){var paymentDetails=new Object();if(orderServiceDto["available-payment-instruments"]){var paymentInstruments=[];angular.forEach(orderServiceDto["available-payment-instruments"],function(paymentInstrument){var paymentTypeFound=false;for(var paymentTypeCount=0;paymentTypeCount<paymentInstruments.length;paymentTypeCount++){if(paymentInstruments[paymentTypeCount].paymentType==paymentInstrument.category){paymentTypeFound=true;paymentInstruments[paymentTypeCount].cardTypes.push({type:paymentInstrument.type,isSaved:paymentInstrument["is-saved"],isDisabled:paymentInstrument["is-disabled"]});continue}}if(!paymentTypeFound&&paymentInstrument.category!=SalesConstants.PAYMENT_PAYPAL_TYPE){var paymentObject={};if(paymentInstrument.category==SalesConstants.PAYMENT_CREDIT_CARD_TYPE){paymentObject={paymentType:paymentInstrument.category,paymentLabel:SalesConstants.PAYMENT_CREDIT_CARD_LABEL,cardTypes:[{type:paymentInstrument.type,isSaved:paymentInstrument["is-saved"],isDisabled:paymentInstrument["is-disabled"]}]}}else{if(paymentInstrument.type==SalesConstants.PAYMENT_DIRECT_DEBIT_TYPE){paymentObject={paymentType:paymentInstrument.type,paymentLabel:SalesConstants.PAYMENT_DIRECT_DEBIT_LABEL,isSaved:paymentInstrument["is-saved"],isDisabled:paymentInstrument["is-disabled"],disabledReasonCode:_.has(paymentInstrument,"disabled-reason-code")?paymentInstrument["disabled-reason-code"]:"",mandateId:paymentInstrument["mandate-id"]}}else{if(paymentInstrument.type==SalesConstants.PAYMENT_BANK_TRANSFER_TYPE){paymentObject={paymentType:paymentInstrument.type,paymentLabel:SalesConstants.PAYMENT_BANK_TRANSFER_LABEL,isSaved:paymentInstrument["is-saved"],isDisabled:paymentInstrument["is-disabled"],disabledReasonCode:_.has(paymentInstrument,"disabled-reason-code")?paymentInstrument["disabled-reason-code"]:""}}else{if(paymentInstrument.type==SalesConstants.PAYMENT_CVS_TYPE){paymentObject={paymentType:paymentInstrument.type,paymentLabel:SalesConstants.PAYMENT_CVS_LABEL,isSaved:paymentInstrument["is-saved"],isDisabled:paymentInstrument["is-disabled"],disabledReasonCode:_.has(paymentInstrument,"disabled-reason-code")?paymentInstrument["disabled-reason-code"]:""}}else{if(paymentInstrument.type==SalesConstants.PAYMENT_PO_TYPE){var enableAll=$routeParams.enableAll&&$routeParams.enableAll=="true"?true:false;paymentObject={paymentType:paymentInstrument.type,paymentLabel:SalesConstants.PAYMENT_PO_LABEL,isSaved:paymentInstrument["is-saved"],isDisabled:enableAll?paymentInstrument["is-disabled"]:true,disabledReasonCode:"NOT_ENABLED"}}}}}}if(paymentObject.paymentLabel==SalesConstants.PAYMENT_CREDIT_CARD_LABEL){paymentInstruments.unshift(paymentObject)}else{paymentInstruments.push(paymentObject)}}});paymentDetails.paymentInstruments=paymentInstruments;for(var paymentTypeCount=0;paymentTypeCount<paymentInstruments.length;paymentTypeCount++){if(paymentInstruments[paymentTypeCount].paymentType==SalesConstants.PAYMENT_CREDIT_CARD_TYPE){paymentDetails.creditCardTypes=paymentInstruments[paymentTypeCount].cardTypes;break}}}else{paymentDetails.paymentInstruments=[]}if(orderServiceDto["saved-payment-instruments"]){paymentDetails.savedPaymentInstruments=orderServiceDto["saved-payment-instruments"]}else{paymentDetails.savedPaymentInstruments=[]}var paymentYears=[];var currentYear=new Date().getFullYear();for(var yearCount=0;yearCount<11;yearCount++){var yearObject={code:currentYear,label:currentYear.toString()};paymentYears.push(yearObject);currentYear=currentYear+1}paymentDetails.paymentYears=paymentYears;var paymentMonths=[{code:"01",label:"01"},{code:"02",label:"02"},{code:"03",label:"03"},{code:"04",label:"04"},{code:"05",label:"05"},{code:"06",label:"06"},{code:"07",label:"07"},{code:"08",label:"08"},{code:"09",label:"09"},{code:"10",label:"10"},{code:"11",label:"11"},{code:"12",label:"12"}];paymentDetails.paymentMonths=paymentMonths;paymentDetails.confirmedPaymentDetails={cardNumber:"",paymentType:SalesPaymentConstants.CREDIT_CARD_PAYMENT_TYPE,expiryMonth:"",expiryYear:""};return paymentDetails};this.getCustomerDto=function(customerDetails){var customerDto=angular.copy(CustomerRequestDto);customerDto.contact["first-name"]=customerDetails.firstName;customerDto.contact["last-name"]=customerDetails.lastName;customerDto.contact["primary-phone"]=customerDetails.phone;customerDto.contact["primary-email"]=customerDetails.email;customerDto.contact["secondary-email"]=customerDetails.billingContactEmail?customerDetails.billingContactEmail:"";customerDto.contact["company-name"]=customerDetails.companyName?customerDetails.companyName:"";if(angular.uppercase(customerDetails.country)=="JP"){customerDto.contact["pronunciation-last-name"]=customerDetails.phoneticLastName?customerDetails.phoneticLastName:"";customerDto.contact["pronunciation-first-name"]=customerDetails.phoneticFirstName?customerDetails.phoneticFirstName:"";customerDto.contact["pronunciation-company-name"]=customerDetails.phoneticCompanyName?customerDetails.phoneticCompanyName:""}if(customerDetails.taxInfo&&customerDetails.taxInfo.taxNumber){customerDto.contact["vat-id"]=customerDetails.taxInfo.taxNumber}customerDto.street1=customerDetails.address.street1;customerDto.street2=customerDetails.address.street2;customerDto.street3=customerDetails.address.street3;customerDto.street4=customerDetails.wardVillage?customerDetails.wardVillage:"";customerDto.city=customerDetails.address.city;customerDto.country.name=customerDetails.address.country.name;customerDto.country.code=customerDetails.address.country.code;customerDto["postal-code"]=customerDetails.address.postCode;customerDto["state-province"]["name"]=customerDetails.address.stateName;customerDto["state-province"]["code"]=customerDetails.address.state;return customerDto};this.getCustomerDetailsFromQuote=function(quoteDetails,customerDto){if(quoteDetails&&quoteDetails["payment-instrument"]&&quoteDetails["payment-instrument"]["billing-address"]){customerDto.firstName=quoteDetails["payment-instrument"]["billing-address"]["contact"]["first-name"];customerDto.lastName=quoteDetails["payment-instrument"]["billing-address"]["contact"]["last-name"];customerDto.phone=quoteDetails["payment-instrument"]["billing-address"]["contact"]["primary-phone"];customerDto.companyName=quoteDetails["payment-instrument"]["billing-address"]["contact"]["company-name"];if(quoteDetails.country=="US"&&quoteDetails["payment-instrument"]["billing-address"]["postal-code"]!=customerDto.address.postCode){customerDto.address.street1=customerDto.address.street2=customerDto.address.street3="";customerDto.address.city="";customerDto.address.state=customerDto.address.stateName="";customerDto.address.postCode=quoteDetails["payment-instrument"]["billing-address"]["postal-code"]}}};this.getCustomerDetailsFromOrderService=function(orderServiceDetails){var customerDto=new Object();if(orderServiceDetails&&orderServiceDetails["payment-instrument"]&&orderServiceDetails["payment-instrument"]["billing-address"]){customerDto.firstName=orderServiceDetails["payment-instrument"]["billing-address"]["contact"]["first-name"];customerDto.lastName=orderServiceDetails["payment-instrument"]["billing-address"]["contact"]["last-name"];customerDto.email=orderServiceDetails["payment-instrument"]["billing-address"]["contact"]["primary-email"];customerDto.phone=orderServiceDetails["payment-instrument"]["billing-address"]["contact"]["primary-phone"];customerDto.companyName=orderServiceDetails["payment-instrument"]["billing-address"]["contact"]["company-name"];customerDto.address=new Object();customerDto.address.postCode=orderServiceDetails["payment-instrument"]["billing-address"]["postal-code"]}return customerDto};this.getPaymentInstrument=function(currentPaymentDetails,paymentInstrument){if(currentPaymentDetails.paymentType==SalesConstants.PAYMENT_CREDIT_CARD_TYPE){paymentInstrument.category=SalesConstants.PAYMENT_CREDIT_CARD_TYPE;paymentInstrument["credit-card-number"]=currentPaymentDetails.cardNumber;paymentInstrument["credit-card-expire-date"]=currentPaymentDetails.expirationDate?currentPaymentDetails.expirationDate.toISOString():"";paymentInstrument.type=currentPaymentDetails.cardType}else{if(currentPaymentDetails.paymentType==SalesConstants.PAYMENT_DIRECT_DEBIT_TYPE){paymentInstrument.category="BANK";paymentInstrument["bank-account"]=currentPaymentDetails.ibaNumber;paymentInstrument["bank-city"]=currentPaymentDetails.city;paymentInstrument["bank-name"]=currentPaymentDetails.bankName;paymentInstrument["account-holder-name"]=currentPaymentDetails.accountHolder;paymentInstrument["mandate-id"]=currentPaymentDetails.mandateId;paymentInstrument.type=SalesConstants.PAYMENT_DIRECT_DEBIT_TYPE}else{if(currentPaymentDetails.paymentType==SalesConstants.PAYMENT_CVS_TYPE){paymentInstrument.category="OFFLINE";paymentInstrument.type=SalesConstants.PAYMENT_CVS_TYPE}else{if(currentPaymentDetails.paymentType==SalesConstants.PAYMENT_BANK_TRANSFER_TYPE){paymentInstrument.category="OFFLINE";paymentInstrument.type=SalesConstants.PAYMENT_BANK_TRANSFER_TYPE}else{if(currentPaymentDetails.paymentType==SalesConstants.PAYMENT_PO_TYPE){paymentInstrument.category="PO";paymentInstrument.type=SalesConstants.PAYMENT_PO_TYPE;paymentInstrument["purchase-order-number"]=currentPaymentDetails.poNumber;paymentInstrument["payer-id"]=currentPaymentDetails.payerId}}}}}};this.getSavedPaymentInstrument=function(savedPayment,paymentInstrument){if(savedPayment.category==SalesConstants.PAYMENT_CREDIT_CARD_TYPE){paymentInstrument.category=SalesConstants.PAYMENT_CREDIT_CARD_TYPE;paymentInstrument.type=savedPayment.type;paymentInstrument["credit-card-number-masked"]=savedPayment["credit-card-number-masked"];paymentInstrument["credit-card-short-number"]=savedPayment["credit-card-short-number"];paymentInstrument["credit-card-expire-date"]=savedPayment["credit-card-expire-date"];paymentInstrument["is-saved"]=savedPayment["is-saved"]}};this.validateTokenNumber=function(tokenNumber){var cardValue=tokenNumber;var validTokenCharactersAtFirstIndex="0129";if(validTokenCharactersAtFirstIndex.indexOf(cardValue.toString().charAt(0))<0){return false}if(/[^0-9-\s]+/.test(cardValue)){return false}var nCheck=0,nDigit=0,bEven=false;cardValue=cardValue.replace(/\D/g,"");for(var n=cardValue.length-1;n>=0;n--){var cDigit=cardValue.charAt(n),nDigit=parseInt(cDigit,10);if(bEven){if((nDigit*=2)>9){nDigit-=9}}nCheck+=nDigit;bEven=!bEven}return(nCheck%10)==0};this.updateCartInformation=function(orderServiceDto,cartItems){if(orderServiceDto&&orderServiceDto.items&&orderServiceDto.items.length>0){var itemsToRemove=[];for(var itemCount=0;itemCount<orderServiceDto.items.length;itemCount++){var orderItem=orderServiceDto.items[itemCount];if(cartItems&&cartItems.length>0){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){var cartItem=cartItems[cartItemCount];if((orderItem.sku&&orderItem.sku.id&&orderItem.sku.id==cartItem.materialId)||(orderItem["offer-id"]&&orderItem["offer-id"]==cartItem.offerId)||(orderItem.offerId&&orderItem.offerId==cartItem.offerId)){orderItem.cartInfo=cartItem;if(orderServiceDto.promotions&&orderServiceDto.promotions.length>0){for(var promotionCount=0;promotionCount<orderServiceDto.promotions.length;promotionCount++){if(orderItem.cartInfo.promo&&orderItem.cartInfo.promo["extendedPromoCode"]==orderServiceDto.promotions[promotionCount]["promotion-code"]){orderItem.cartInfo.promoStatus=orderServiceDto.promotions[promotionCount]}}}}}}if(orderItem["line-item-status"]&&orderItem["line-item-status"]["reason-code"]&&angular.uppercase(orderItem["line-item-status"]["reason-code"])!="ELIGIBLE"&&angular.uppercase(orderItem["line-item-status"]["reason-code"])!="ELIGIBLE_UPGRADE"){if(orderItem["line-item-status"]["reason-sellable-item"]&&orderItem["line-item-status"]["reason-sellable-item"]["id"]){itemsToRemove.push(orderItem["line-item-status"]["reason-sellable-item"]["id"])}}}if(itemsToRemove.length>0){for(var count=0;count<itemsToRemove.length;count++){for(var itemCount=0;itemCount<orderServiceDto.items.length;itemCount++){if(orderServiceDto.items[itemCount].sku.id==itemsToRemove[count]){orderServiceDto.items.splice(itemCount,1)}}for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].materialId==itemsToRemove[count]){cartItems.splice(cartItemCount,1)}}}$rootScope.$broadcast(SalesConstants.SALES_VALIDATE_CATALOG_EVENT)}}};this.isOrderHavingErrorMessage=function(orderServiceResult){var havingErrorMessage=false;if(orderServiceResult){for(var count=0;count<orderServiceResult.items.length;count++){if(orderServiceResult.items[count].type){havingErrorMessage=true;break}}}return havingErrorMessage};this.getOrderServiceErrorMessages=function(title,orderServiceResult,exceptionsList,headers,isCustomerIdentified){var salesErrorMessage={title:title?title:"Error Details",errors:[]};try{orderServiceResult=angular.fromJson(orderServiceResult);if(headers&&headers()&&headers()["x-adobe-status"]){for(var orderServiceExceptionCount=0;orderServiceExceptionCount<exceptionsList.length;orderServiceExceptionCount++){if(headers()["x-adobe-status"].replace("[","").replace("]","")==exceptionsList[orderServiceExceptionCount].code){salesErrorMessage.errors.push({code:exceptionsList[orderServiceExceptionCount].code,description:exceptionsList[orderServiceExceptionCount].hendrixErrorMessage,descriptionText:""})}}}if(!salesErrorMessage.errors||salesErrorMessage.errors.length==0){salesErrorMessage.errors.push({code:headers()["x-adobe-status"].replace("[","").replace("]",""),description:"We’re sorry, a system error occurred. Please contact Hendrix support.",descriptionText:""})}if(orderServiceResult.items){for(var count=0;count<orderServiceResult.items.length;count++){if(orderServiceResult.items[count]["line-item-status"]&&orderServiceResult.items[count]["line-item-status"]["reason-code"]!="ELIGIBLE"&&orderServiceResult.items[count]["line-item-status"]["reason-code"]!="ELIGIBLE_UPGRADE"){var errorCodeFound=false;for(var orderServiceExceptionCount=0;orderServiceExceptionCount<exceptionsList.length;orderServiceExceptionCount++){if(orderServiceResult.items[count]["line-item-status"]["reason-code"]==exceptionsList[orderServiceExceptionCount].code){var productNameAndSku=_.has(orderServiceResult.items[count]["line-item-status"],"reason-sellable-item")?orderServiceResult.items[count]["line-item-status"]["reason-sellable-item"]["id"]:"";var description=productNameAndSku+" - ";if(isCustomerIdentified&&exceptionsList[orderServiceExceptionCount].hendrixErrorMessageForCustomer){description+=exceptionsList[orderServiceExceptionCount].hendrixErrorMessageForCustomer}else{description+=exceptionsList[orderServiceExceptionCount].hendrixErrorMessage}salesErrorMessage.errors.push({code:orderServiceResult.items[count]["line-item-status"]["reason-code"],description:description,descriptionText:""});errorCodeFound=true}}if(!errorCodeFound){salesErrorMessage.errors.push({code:orderServiceResult.items[count]["line-item-status"]["reason-code"],description:"We’re sorry, a system error occurred. Please contact Hendrix support.",descriptionText:""})}}}}}catch(err){if(headers&&headers()&&headers()["x-adobe-status"]){for(var orderServiceExceptionCount=0;orderServiceExceptionCount<exceptionsList.length;orderServiceExceptionCount++){if(headers()["x-adobe-status"].replace("[","").replace("]","")==exceptionsList[orderServiceExceptionCount].code){salesErrorMessage.errors.push({code:exceptionsList[orderServiceExceptionCount].code,description:exceptionsList[orderServiceExceptionCount].hendrixErrorMessage,descriptionText:orderServiceResult})}}}if(!salesErrorMessage.errors||salesErrorMessage.errors.length==0){salesErrorMessage.errors.push({code:headers()?headers()["x-adobe-status"]?headers()["x-adobe-status"].replace("[","").replace("]",""):"":"",description:"We’re sorry, a system error occurred. Please contact Hendrix support.",descriptionText:orderServiceResult})}}return salesErrorMessage};this.replaceSalesPath=function(catalogRequest){var currentPath=$location.url();var newSalesPath="";if(currentPath.indexOf("?")==-1){newSalesPath=currentPath+"?store="+angular.uppercase(catalogRequest.country)+(catalogRequest.marketSegment!="COM"?"-EDU":"")}else{$location.search("store",angular.uppercase(catalogRequest.country)+(catalogRequest.marketSegment!="COM"?"-EDU":""));newSalesPath=$location.url()}return newSalesPath};this.removeParameterFromUrl=function(paramName){$location.search(paramName,null)};this.addParameterToUrl=function(paramName,paramValue){var currentPath=$location.url();var newSalesPath="";if(currentPath.indexOf("?")==-1){newSalesPath=currentPath+"?"+paramName+"="+paramValue}else{newSalesPath=currentPath+"&"+paramName+"="+paramValue}$location.url(newSalesPath)};this.getCatalogRequestDto=function(catalogData){var catalogRequestData=angular.copy(AppUtils.assignDefaultEmptyValue(catalogData));if(catalogRequestData.isDrStore){catalogRequestData.tags="CCT_DR"}else{catalogRequestData.tags=""}delete catalogRequestData.isDrStore;return catalogRequestData}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("SearchCtrl",["$scope","$rootScope","$routeParams","$filter","$location","$timeout","CustomerPreviewService","TransactionService","StoreTransactionService","CaseRecordService","ProductRecordService","ContractService","Utils","LocalStorageService","TrackingService","MetadataService","AppConstants","CustomerSubscriptionService","AppUtils","SalesServices","SalesUtil",function SearchCtrl($scope,$rootScope,$routeParams,$filter,$location,$timeout,CustomerPreviewService,TransactionService,StoreTransactionService,CaseRecordService,ProductRecordService,ContractService,Utils,LocalStorageService,TrackingService,MetadataService,AppConstants,CustomerSubscriptionService,AppUtils,SalesServices,SalesUtil){TrackingService.trackPageView("Search","Search");Utils.pageTitle("Customer Search");$scope.loadingMessage="";$scope.onlineQuoteId=null;$scope.isCustomerSearch=true;$scope.enableQuote=$routeParams.enableQuote&&$routeParams.enableQuote=="true"?true:false;var isValidUser=LocalStorageService.get("isValidUser");if(isValidUser){if($rootScope.returnUrl&&decodeURIComponent($rootScope.returnUrl).indexOf("/login")==-1&&decodeURIComponent($rootScope.returnUrl).indexOf("/search")==-1){$location.path(decodeURIComponent($rootScope.returnUrl));return}}else{if(!isValidUser){$location.path("/login");return}}var customerDetailsFields=["idNumber","email","firstName","lastName","phoneticFirstName","phoneticLastName","phoneticCompanyName","orgName","telephone","address","city","state","zip","countryCode"];var uniqueIdFields=["customerId","externalRef","transactionNo","connectUrl","serialNo","idType"];$scope.metadata=new Object();$scope.isSearchViewValid=false;MetadataService.initializeSearchMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;$scope.isSearchViewValid=true});$scope.checkDbStatus=function(){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){return true}else{$scope.showMessage("error","Failed to load metadata");return false}};$scope.form=0;$scope.searchState=0;$scope.isLoading=false;$scope.messages=[];$scope.previousUniqueElement;$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:"",customerType:"1",authSrc:""};$scope.quoteSearchFields={quoteEmail:"",quoteNumber:"",quoteCompanyName:""};$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.restoreFromCache=function(){var localStorageSearchResults=LocalStorageService.user.get("search.results");if(localStorageSearchResults){try{$scope.searchState=1;$scope.results=localStorageSearchResults;$scope.searchFields={};$scope.messages=LocalStorageService.user.get("search.messages");$scope.lastResultTime=LocalStorageService.user.get("search.lastResultTime")}catch(err){}}else{$scope.searchState=0;$scope.results=[];$scope.searchFields={};$scope.messages=[];$scope.lastResultTime=undefined}$scope.updatePersonOrgRecordCount();$scope.checkDefaultLanguage();$scope.isLoading=false};$scope.checkDefaultLanguage=function(){angular.forEach($scope.results,function(item){var defaultLanguageCode=Utils.getDefaultCountriesLanguage(item.address.country.code);item.isCountryLanguageMismatch=angular.uppercase(defaultLanguageCode)!=angular.uppercase(item.language)?true:false;if(defaultLanguageCode.length!=2){item.isCountryLanguageMismatch=false}item.defaultCountryLanguage=defaultLanguageCode})};$scope.updatePersonOrgRecordCount=function(){var personalRecordCount=0;var orgRecordCount=0;for(var count=0;count<$scope.results.length;count++){if($scope.results[count].hasOwnProperty("name")){$scope.results[count].isOrg=true;orgRecordCount+=1}else{$scope.results[count].isOrg=false;personalRecordCount+=1}}$scope.personalRecordCount=personalRecordCount;$scope.orgRecordCount=orgRecordCount};$scope.clearCache=function(){LocalStorageService.user.remove("search.messages");LocalStorageService.user.remove("search.results")};$scope.$on("event:loginConfirmed",function(e,user){});$scope.customerLink=Utils.customerLink;$scope.search=function(){$scope.isCustomerSearch?$scope.doCustomerSearch():$scope.doQuoteSearch()};$scope.doCustomerSearch=function(){$scope.isLoading=true;loadedTabs=[];var regEx=/^[0-9A-Fa-f]{24}/;var idNumber=$scope.searchFields.idNumber;if($scope.searchFields.idNumber&&$scope.searchFields.idNumber.indexOf("@")<0&&regEx.test($scope.searchFields.idNumber)){$scope.searchFields.idNumber=idNumber;$scope.searchFields.authSrc="AdobeID"}else{if($scope.searchFields.idNumber&&$scope.searchFields.idNumber.indexOf("@")>=0){if(regEx.test(idNumber.split("@")[0])){$scope.searchFields.idNumber=idNumber.split("@")[0];$scope.searchFields.authSrc=idNumber.split("@")[1]}}}CustomerPreviewService.search($scope.searchFields).success(function(result){$scope.isLoading=false;$scope.searchState=1;$scope.messages=result.messages;$scope.results=result.customerSearchResults;$scope.lastResultTime=new Date();angular.forEach($scope.results,function(item){item.isCommercialStoreSellable=AppUtils.isCommercialStore(item.address.country.code);item.isEducationalStoreSellable=AppUtils.isEducationalStore(item.address.country.code)});if($scope.results.length>0){}else{if($scope.searchFields.idNumber!=""||$scope.searchFields.email!=""){$scope.showMessage("error","No results found. Please search again.");$scope.clearCache()}else{$scope.clearCache()}}$scope.updatePersonOrgRecordCount();$scope.checkDefaultLanguage()}).error(function(result){$scope.isLoading=false;$scope.messages=result.messages;$scope.results=null;$scope.updatePersonOrgRecordCount()})};$scope.doQuoteSearch=function(){$scope.quoteSearchResults=[];$scope.quoteTransactionNotFoundMessage="";$scope.isLoading=true;SalesServices.searchQuotes($scope.quoteSearchFields).success(function(result,status,headers,config){$scope.isLoading=false;$scope.quoteTransactionNotFoundMessage="";if(result&&result.order&&result.order.length>0){var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Search Quotes - Search Quotes";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.quoteSearchResults=result.order;angular.forEach($scope.quoteSearchResults,function(searchItem){if(searchItem.items&&searchItem.items.length>0){angular.forEach(searchItem.items,function(quoteItem){if(quoteItem["offer-id"]){SalesServices.getOfferByOfferId({country:searchItem.country,marketSegment:searchItem["market-segment"],offerId:quoteItem["offer-id"]}).success(function(result,status,headers,config){if(result){quoteItem.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0]}}).error(function(result,status,headers,config){item.cartInfo=null})}else{SalesServices.getOfferBySku({country:searchItem.country,marketSegment:searchItem["market-segment"],sku:quoteItem.sku.id}).success(function(result,status,headers,config){if(result){quoteItem.cartInfo=SalesUtil.getSalesCatalogProducts(result.subscriptionOffers)[0]}}).error(function(result,status,headers,config){item.cartInfo=null})}})}})}else{$scope.quoteTransactionNotFoundMessage="Quote not found."}}).error(function(){$scope.isLoading=false;$scope.quoteTransactionNotFoundMessage="Quote not found.";var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Search Quotes - Search Quotes";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseQuoteItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseQuoteItems"+indexId).removeClass().addClass(accordionClassName)};$scope.convertToOrder=function(quote){var url="/sales?store="+angular.uppercase(quote.country);if(quote["market-segment"]!=AppConstants.STORE_TYPE_COM){url=url+"-EDU"}$location.url(url+"&quote="+quote["order-number"])};$scope.resendQuote=function(quote){$scope.isResendQuoteLoading=true;$("#resendQuoteModal").modal("show");$scope.resendQuoteMessage="";SalesServices.resendQuote({quoteId:quote["order-id"],email:quote["payment-instrument"]["billing-address"]["contact"]["primary-email"],lang:"en"}).success(function(result,status,headers,config){if(result){$scope.resendQuoteMessage=result.message}else{$scope.resendQuoteMessage="Resending Quote Email Failed"}$scope.isResendQuoteLoading=false;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Search Quotes - Resend Quotes";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.resendQuoteMessage="Resending Quote Email Failed";$scope.isResendQuoteLoading=false;var messageObject=new Object();messageObject.Source_System=AppConstants.SOURCE_SYSTEM_COMMERCE;messageObject.Functionality="Search Quotes - Resend Quotes";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.hideResendQuote=function(quote){$scope.isResendQuoteLoading=false;$("#resendQuoteModal").modal("hide");$scope.resendQuoteMessage=""};$scope.openQuoteView=function(quote){$location.url("/quote/"+quote["order-number"])};$scope.openPdfView=function(quote){var pdfViewWindow;var url=hendrixConfig.endpoints.commerceanyware+"/quotes/"+quote["order-id"]+"?lang=en";var left=(screen.width/2)-(900/2);var top=(screen.height/2)-(800/2);pdfViewWindow=window.open(url,"QuotePdfView","width=900,height=800,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left="+left+",top="+top);pdfViewWindow.focus()};$scope.checkQuoteToOrder=function(){$scope.searchByQuoteNumber($scope.quoteSearchFields.quoteNumber)};$scope.updateRecordByIndex=function(newRecord,itemIndex){$scope.results[itemIndex]=newRecord;console.log(newRecord,"new record updated at index: "+itemIndex)};$scope.resetFields=function(){$scope.searchFields={email:"",firstName:"",lastName:"",phoneticFirstName:"",phoneticLastName:"",phoneticCompanyName:"",companyName:"",telephone:"",address:"",city:"",state:"",zip:"",countryCode:"",customerId:"",externalRef:"",transactionNo:"",connectUrl:"",serialNo:"",idType:"",idNumber:""};$scope.quoteSearchFields={quoteNumber:"",quoteEmail:"",quoteCompanyName:""};$scope.transactionNotFoundMessage=null};$scope.handleResetButton=function(){$scope.resetFields();$scope.clearCache();$scope.results=[];$scope.messages=[];$scope.lastResultTime=null};$scope.getLastResultTime=function(){if(!$scope.lastResultTime){return}return moment($scope.lastResultTime).fromNow()};$scope.isButtonVisible=function(value){return value};$scope.handleFocus=function(el){if($scope.previousUniqueElement!=el){if(customerDetailsFields.indexOf(el)!=-1){$scope.resetFieldsFromArray(uniqueIdFields)}else{$scope.resetFields()}}};$scope.handleFocusOut=function(el){$scope.previousUniqueElement=el};$scope.isValidForSearch=function(){if($scope.isCustomerSearch){if(!$scope.searchFields){return false}if($scope.searchFields.idNumber||$scope.searchFields.email||$scope.searchFields.orgName){return true}if($scope.getValidFields(customerDetailsFields)>=2||$scope.getValidFields(uniqueIdFields)>0){return true}}else{if(!$scope.quoteSearchFields){return false}if($scope.quoteSearchFields.quoteNumber||$scope.quoteSearchFields.quoteEmail||$scope.quoteSearchFields.quoteCompanyName){return true}}return false};$scope.getValidFields=function(fields){var validFields=0;for(var prop in $scope.searchFields){if($scope.searchFields[prop]&&fields.indexOf(prop)!=-1){validFields++}}return validFields};$scope.resetFieldsFromArray=function(fields){for(var prop in $scope.searchFields){if($scope.searchFields[prop]&&fields.indexOf(prop)!=-1){$scope.searchFields[prop]=""}}};$scope.searchByTransactionId=function(){$scope.isLoading=true;$scope.transactionNotFoundMessage=null;CustomerPreviewService.findCustomerByTransactionOrCase($scope.searchFields.transactionNo).success(function(result){$scope.isLoading=false;if(result&&result.caseDto){var link=Utils.linkToCaseView(result.caseDto.caseNumber,result.caseDto.transType,result.caseDto.customerId,result.caseDto.contactId);$location.path(link)}else{if(result&&result.transactionDto){$scope.$root.transaction=result.transactionDto;$location.path(Utils.linkToTransactionView(result.transactionDto.transactionNumber))}else{$scope.transactionNotFoundMessage="Transaction or case number is not found."}}}).error(function(){$scope.isLoading=false;$scope.transactionNotFoundMessage="Transaction or case number is not found."})};$scope.searchByQuoteNumber=function(quoteNumber){$scope.loadingMessage="Searching Quote, Please wait...";$scope.showViewLoading();AppUtils.sendLogToServer("Online Quote Search Initiated: Online Quote ID - "+quoteNumber);StoreTransactionService.getQuoteDetails(quoteNumber).success(function(result,status,headers,config){$scope.hideViewLoading();if(result&&result.items&&result.items.length>0){AppUtils.sendLogToServer("Online Quote Found in Search: Online Quote ID - "+result["order-number"]+", Country - "+result.country);$scope.$root.onlineQuoteResult=result;var url="/store/"+angular.lowercase(result.country);if(result["market-segment"]!=AppConstants.STORE_TYPE_COM){url=url+"-edu"}$location.url(url+"?onlinequote="+result["order-number"])}else{AppUtils.sendLogToServer("Online Quote Found With Errors: Online Quote ID - "+quoteNumber+", Country - "+result.country);$scope.transactionNotFoundMessage="The online quote does not have any products"}}).error(function(result,status,headers,config){AppUtils.sendLogToServer("Online Quote Search Error: Online Quote ID - "+quoteNumber);$scope.hideViewLoading();$scope.transactionNotFoundMessage="Online quote is not found."})};$scope.goToTransactionBYRefNumber=function(){$location.path(Utils.linkToTransactionView($scope.searchFields.externalRef))};$scope.showViewLoading=function(){$("#customer-search-loading-modal").modal("show")};$scope.hideViewLoading=function(){$("#customer-search-loading-modal").modal("hide")};$scope.TEAM="team";$scope.INDIVIDUAL="individual";$scope.subTab=$routeParams.subTabView;$scope.teamProductsCrm=null;$scope.subscriptionlists=null;$scope.loadTeamProducts=function(){console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isTeamSubscriptionLoading=true;if($scope.customer.bpType=="2"){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}if(!$scope.isFillForCCEWithImsCalled){$scope.isFillForCCEWithImsCalled=true;ProductRecordService.fillForCCEWithIms({customerNo:$scope.contactId,orgId:$scope.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:true}).success(function(result){$scope.isTeamSubscriptionLoading=false;$scope.teamProductsCrm=result;$scope.isFillForCCEWithImsCalled=false}).error(function(error){$scope.isTeamSubscriptionLoading=false;$scope.isFillForCCEWithImsCalled=false;$("#subscriptions").html(error)})}}else{if(!$scope.isFillFromCrmCalled){$scope.isFillFromCrmCalled=true;ProductRecordService.fillFromCrm({customerNo:$scope.customerNo,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:"true"}).success(function(result){$scope.teamProductsCrm=result;$scope.isTeamSubscriptionLoading=false;$scope.isFillFromCrmCalled=false}).error(function(error){$scope.isTeamSubscriptionLoading=false;$scope.isFillFromCrmCalled=false;$("#subscriptions").html(error)})}}};$scope.changeSubscriptionBtnSelection=function(imsCustomer){if($scope.subTab==$scope.TEAM||(!$scope.subTab&&$scope.selectedTab&&imsCustomer&&Utils.getCustomerTypeFromImsDetail(imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM)){$scope.subTab=$scope.TEAM;$location.skipReload().path(AppUtils.replaceCustomerPath($scope.subTab,$scope.TEAM)).replace();$scope.triggerBtnName="#teamSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName);if(!$scope.teamProductsCrm){$scope.loadTeamProducts()}}else{if($scope.subTab==$scope.INDIVIDUAL||(!$scope.subTab&&$scope.selectedTab&&imsCustomer&&Utils.getCustomerTypeFromImsDetail(imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){$scope.subTab=$scope.INDIVIDUAL;$location.skipReload().path(AppUtils.replaceCustomerPath($scope.subTab,$scope.INDIVIDUAL)).replace();$scope.triggerBtnName="#individualSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName);if(!$scope.subscriptionlists){$scope.loadSubscriptions()}}}};var loadTab=function(selectedTab,subTab){$scope.subTab=subTab;$scope.selectedTab=selectedTab;$scope.triggerBtnName="";var currentTabReference="#customerDocTabs a[data-target='#"+selectedTab+"']";$(currentTabReference).tab("show");if($scope.subTab&&selectedTab=="products"){if($scope.subTab==$scope.ENTERPRISE||(!$scope.subTab&&$scope.customer&&$scope.customer.enterpriseId==true)){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ENTERPRISE)).replace();$scope.triggerBtnName="#enterpriseProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.ALL){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ALL;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ALL)).replace();$scope.triggerBtnName="#allProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.PERPETUAL)).replace();$scope.triggerBtnName="#perpetualProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}}else{if(selectedTab=="subscriptions"){$scope.changeSubscriptionBtnSelection($scope.imsCustomer)}}if($scope.tabs.indexOf(selectedTab)!=-1){return}$scope.tabs.push(selectedTab);switch(selectedTab){case"products":$scope.loadProducts=function(){console.log("Query ProductRecordService.fill",$scope.customerNo);$scope.isLoadingProductsCrm=true;if($scope.customer.bpType=="2"){var imsOrg="";if($scope.imsCustomer&&$scope.imsCustomer.serviceAccounts&&$scope.imsCustomer.serviceAccounts.length>0){imsOrg=$scope.imsCustomer.serviceAccounts[0].ownerGuid}if(!$scope.isOrgfillForCCEWithImsCalled){$scope.isOrgfillForCCEWithImsCalled=true;var isInDirectFlag="true";if($scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithIms({customerNo:$scope.contactId,orgId:$scope.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:$scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");$scope.isLoadingProductsCrm=false;$scope.productsCrm=result;$scope.isOrgfillForCCEWithImsCalled=false;if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.perpetualProducts=result}else{if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){$scope.enterpriseProducts=result}else{$scope.allCrmProducts=result}}}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$scope.isOrgfillForCCEWithImsCalled=false;$("#products").html(error)})}}else{var isInDirectFlag="true";if($scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillFromCrm({customerNo:$scope.customerNo,startIndex:0,numberOfRows:100,prodType:$scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("success ProductRecordService.fill");$scope.isLoadingProductsCrm=false;if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){$scope.perpetualProducts=result}else{if($scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){$scope.enterpriseProducts=result}else{$scope.allCrmProducts=result}}$scope.productsCrm=result}).error(function(error){console.log("error",error);$scope.isLoadingProductsCrm=false;$("#products").html(error)})}};if($scope.subTab==$scope.ENTERPRISE||(!$scope.subTab&&$scope.customer&&$scope.customer.enterpriseId==true)){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ENTERPRISE)).replace();$scope.triggerBtnName="#enterpriseProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.ALL){$scope.refreshProductType=AppConstants.PRODUCT_TYPE_ALL;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.ALL)).replace();$scope.triggerBtnName="#allProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{$scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.PERPETUAL)).replace();$scope.triggerBtnName="#perpetualProductsListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}$scope.loadProducts();break;case"subscriptions":if($scope.subTab==$scope.TEAM||(!$scope.subTab&&Utils.getCustomerTypeFromImsDetail($scope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM)){$scope.loadTeamProducts();$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.TEAM)).replace();$scope.triggerBtnName="#teamSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}else{if($scope.subTab==$scope.INDIVIDUAL||(!$scope.subTab&&Utils.getCustomerTypeFromImsDetail($scope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND)){$scope.loadSubscriptions();$location.skipReload().path(AppUtils.replaceCustomerPath(selectedTab,$scope.INDIVIDUAL)).replace();$scope.triggerBtnName="#individualSubscriptionListBtn";$scope.triggerClickInBtnGrp($scope.triggerBtnName)}}break}};$scope.refreshSubscriptions=function(subscriptionType){if(subscriptionType==$scope.TEAM){$scope.subTab=$scope.TEAM;$scope.teamProductsCrm=null}else{$scope.subTab=$scope.INDIVIDUAL;$scope.subscriptionlists=null}$scope.tabs.splice($scope.tabs.indexOf("subscriptions"),1);loadTab("subscriptions",$scope.subTab)};$scope.enableCustomerSearch=function(){$scope.isCustomerSearch=true};$scope.enableQuoteSearch=function(){$scope.isCustomerSearch=false}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSearchItem",["$rootScope","$timeout","$filter","CustomerPreviewService","TransactionService","CaseRecordService","StockServices","ProductRecordService","ContractService","ImsCustomerService","TransactionUtil","CustomerRecordService","CustomerSubscriptionService","AppConstants","AppUtils","CustomerTransactionService","Utils","CustomerConstants","SubscriptionConstants","OnlineFlexibleTrialProductService","CustomerUtil","CAHService","TeamConstants","TeamUtil",function($rootScope,$timeout,$filter,CustomerPreviewService,TransactionService,CaseRecordService,StockServices,ProductRecordService,ContractService,ImsCustomerService,TransactionUtil,CustomerRecordService,CustomerSubscriptionService,AppConstants,AppUtils,CustomerTransactionService,Utils,CustomerConstants,SubscriptionConstants,OnlineFlexibleTrialProductService,CustomerUtil,CAHService,TeamConstants,TeamUtil){return{restrict:"EA",scope:{row:"=",metadata:"=",searchIndex:"=",enableDr:"=",results:"="},replace:true,templateUrl:"js/search/partials/search-item.html",link:function(scope,element,attrs){scope.isExpanded=false;scope.AppConstants=AppConstants;scope.cacheCustomer;scope.customerContextType;scope.imsCustomerDetail;scope.CustomerConstants=CustomerConstants;scope.churnCustomerContextType=false;scope.isMiniviewLoad=false;scope.toggleExpandView=function(){scope.isExpanded=!scope.isExpanded;if(scope.isExpanded){scope.searchItemDetailSrc="js/search/partials/search-item-detail.html"}else{$(".expand i",element).removeClass("icon-chevron-up").addClass("icon-chevron-down");scope.searchItemDetailSrc=""}};scope.expandView=function(){scope.isExpanded=true;scope.searchItemDetailSrc="js/search/partials/search-item-detail.html"};var handleValueChange=function(value){if(value&&value.length==1){scope.toggleExpandView()}if(scope.row.bpType!=="2"&&scope.row.email===""&&(scope.row.rengaGuid===""||angular.isUndefined(scope.row.rengaGuid))){scope.row.isOldPartner=true}};scope.$watch(function(){return scope.results},handleValueChange);scope.detailReady=function(){$timeout(function(){if(!scope.row.name){$(".searchResultTabs a:first",element).remove()}$(".searchResultListItemDetail",element).show("fast")},100);$(".expand i",element.parent()).removeClass("icon-chevron-down").addClass("icon-chevron-up");scope.isMiniviewLoad=true;scope.loadImsDetail(scope.row)};scope.removeActiveStyle=function(){$("#relatedOrg").removeClass("active");var tabRelatedOrgContentId="#relatedOrg-"+scope.row.customerNo;$(tabRelatedOrgContentId).removeClass("active");var tabSubscriptionsOrgContentId="#subscriptions-"+scope.row.customerNo;$(tabSubscriptionsOrgContentId).addClass("active")};scope.loadRelatedOrg=function(val){scope.getCustomerRelatedOrgWithoutLocking(val.customer,val.contextType)};scope.loadRelatedOrgDetail=function(val){scope.getCustomerRelatedOrgWithoutLocking(val.customer,val.contextType)};scope.getCustomerRelatedOrgWithoutLocking=function(customer,customerType){var companyName=customer.name;var customerNo=customer.customerNo;var customerEmail=customer.email;scope.isRengaSearch=false;if(customer.searchResultType!==AppConstants.SEARCH_RESULT_TYPE_IMS){CustomerPreviewService.getCustomerRelatedOrgWithoutLocking({customerNo:customerNo,customerType:customerType,viewMode:""}).success(function(result){scope.row.messages=result.messages;if(result.bpType){if(scope.row.subscriptions){scope.row.subscriptions.bpType=result.bpType}else{scope.row.subscriptions=[];scope.row.subscriptions.bpType=result.bpType}if(scope.row.products){scope.row.products.bpType=result.bpType}else{scope.row.products=[];scope.row.products.bpType=result.bpType}}scope.row.isDRStoreSellable=AppUtils.isLaunchDRStoreEnable(result.address.country);scope.row.isDRCctStoreSellable=AppUtils.isLaunchCctDRStoreEnable(result.address.country);scope.row.address.country=result.address.country;if(companyName){scope.row.contacts=[];var contactRecords=result.contacts;for(var count=0;count<contactRecords.length;count++){for(var contactCount=0;contactCount<scope.metadata.contactTypes.length;contactCount++){if(contactRecords[count].contactType==scope.metadata.contactTypes[contactCount].department){contactRecords[count].contactTypeName=scope.metadata.contactTypes[contactCount].description;break}}}scope.row.contacts.records=contactRecords}else{scope.row.relatedOrg=[];var relatedOrgRecords=result.relatedOrganizations;for(var count=0;count<relatedOrgRecords.length;count++){for(var classificationCount=0;classificationCount<scope.metadata.classifications.length;classificationCount++){if(relatedOrgRecords[count].classification==scope.metadata.classifications[classificationCount].code){relatedOrgRecords[count].classificationName=scope.metadata.classifications[classificationCount].description;relatedOrgRecords.isOrgLinkDisabled=false;break}}angular.forEach(result.messages,function(message){angular.forEach(relatedOrgRecords,function(relOrg){if(message.text.indexOf(parseInt(relOrg.id))>-1){relOrg.isOrgLinkDisabled=true}else{relOrg.isOrgLinkDisabled=false}})});angular.forEach(result.customerRelations,function(item){if(item.partner1==relatedOrgRecords[count].id){if(item.contactType=="CC4E"){scope.row.customerRole="CCE";relatedOrgRecords[count].contactType="CCE"}if(item.contactType=="ENT"){relatedOrgRecords[count].contactType="ENT";relatedOrgRecords[count].contactTypeEntitlements="Get Entitlement"}else{relatedOrgRecords[count].contactType="";relatedOrgRecords[count].contactTypeName="";relatedOrgRecords[count].contactTypeEntitlements=""}if(item.contactRole){relatedOrgRecords[count].contactTypeName=item.contactRole}}})}scope.row.relatedOrg.records=relatedOrgRecords}angular.forEach(result.customerIdentifications,function(item){if(item.idType=="ZGUID"){scope.row.webGUID=item.idNumber;return}});scope.row.memos=[];var memoNotes=result.memoNotes;for(var count=0;count<memoNotes.length;count++){for(var memoTypeCount=0;memoTypeCount<scope.metadata.memoNoteTypes.length;memoTypeCount++){if(memoNotes[count].type==scope.metadata.memoNoteTypes[memoTypeCount].id){memoNotes[count].typeName=scope.metadata.memoNoteTypes[memoTypeCount].value;break}}}scope.row.memos.records=memoNotes;scope.row.displayCreateContact=true}).error(function(error){scope.row.error=true})}else{scope.isRengaSearch=true}};scope.loadImsDetail=function(customer){ImsCustomerService.getCustomerOrganizations({guid:scope.row.rengaGuid}).success(function(result){scope.loadCustomerOrganizationFromIMS(customer,result)}).error(function(error){scope.loadCustomerOrganizationFromIMS(customer,error)})};scope.loadCustomerOrganizationFromIMS=function(customer,customerOrgFromIms){var companyName=customer.name;var customerNo=customer.customerNo;var customerEmail=customer.adobeId?customer.adobeId:customer.email;var customerType=CustomerConstants.CUSTOMER_CONTEXT_ALL;var isEnterPriseOrg=Utils.isEnterPriseOrgExist(customerOrgFromIms);var imsGetItemObj;if(scope.row.enterpriseId){imsGetItemObj={email:customerEmail,authSrc:customerEmail.split("@")[1]}}else{imsGetItemObj={email:customerEmail}}ImsCustomerService.getItem(imsGetItemObj).success(function(result){scope.row.services=result;if(!scope.row.services){scope.row.services=[]}if(customer&&customer.enterpriseId==true&&!customer.isOrg){customerType=CustomerConstants.CUSTOMER_CONTEXT_ENT}else{if(result.account_type=="type1"&&isEnterPriseOrg==true){customerType=CustomerConstants.CUSTOMER_CONTEXT_ENT;scope.row.type1EntCustomer=true}else{if(!customer.isOrg){customerType=Utils.getCustomerTypeFromImsDetail(result)}}}scope.imsCustomerDetail=result;if(customerType==CustomerConstants.CUSTOMER_CONTEXT_IND&&scope.isMiniviewLoad&&!customer.isOrg){scope.handleTabShown("subscriptions",scope.row);$("#subscriptions").addClass("active");$("#relatedOrg").removeClass("active");var tabRelatedOrgContentId="#relatedOrg-"+scope.row.customerNo;$(tabRelatedOrgContentId).removeClass("active");var tabSubscriptionsOrgContentId="#subscriptions-"+scope.row.customerNo;$(tabSubscriptionsOrgContentId).addClass("active")}else{if(scope.isMiniviewLoad){$(".searchResultTabs a:first",element).tab("show");scope.handleTabShown("relatedOrg",scope.row)}}scope.customerContextType=customerType;scope.getCustomerRelatedOrgWithoutLocking(customer,customerType,"");scope.isMiniviewLoad=false;scope.row.services.serviceAccounts=result.serviceAccounts;scope.row.services.emailVerified=result.emailVerified=="true";scope.row.services.records=scope.row.services.serviceAccounts;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){scope.row.services.serviceCode=item.serviceCode;scope.row.services.serviceStatus=item.serviceStatus;scope.row.services.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){scope.row.services.serviceStorage=item.params[imsCount].pv+" GB"}}}}})}angular.forEach(scope.row.services.records,function(item){if(item.params){for(var imsItemCount=0;imsItemCount<item.params.length;imsItemCount++){if(item.params[imsItemCount].pn=="storage_quota"){item.serviceStorage=item.params[imsItemCount].pv+" GB"}}}})}).error(function(result){scope.isLoading=false;scope.getCustomerRelatedOrgWithoutLocking(customer,CustomerConstants.CUSTOMER_CONTEXT_ALL,"")})};scope.$on("loadIndividualSubscriptionTab",function(event,result){if(scope.results&&angular.isArray(scope.results)&&scope.results.length>1){if(scope.row.rengaGuid==result.rengaGuid&&!scope.isExpanded){scope.expandView();var tabRelatedOrgContentId="#relatedOrg-"+scope.row.customerNo;$(tabRelatedOrgContentId).removeClass("active");$timeout(function(){var contentList=["contacts","relatedOrg","transactions","cases","products","contracts","memos","services","stock"];scope.churnCustomerContextType=true;scope.handleTabShown("subscriptions",scope.row);var subTab="#searchResultTabs-"+scope.row.customerNo;$(subTab).find("#subscriptions").addClass("active");$("#subscriptions").addClass("active");$("#relatedOrg").removeClass("active");$("#searchContact").removeClass("active");$("#searchTransaction").removeClass("active");$("#searchCases").removeClass("active");$("#searchProduct").removeClass("active");$("#searchContracts").removeClass("active");$("#searchMemo").removeClass("active");$("#searchServices").removeClass("active");$("#searchStock").removeClass("active");angular.forEach(contentList,function(content){var tabid="#"+content+"-"+scope.row.customerNo;$(tabid).removeClass("active")});$(subTab).find("#relatedOrg").removeClass("active");var tabRelatedOrgContentId="#relatedOrg-"+scope.row.customerNo;$(tabRelatedOrgContentId).removeClass("active");var tabSubscriptionsOrgContentId="#subscriptions-"+scope.row.customerNo;$(tabSubscriptionsOrgContentId).addClass("active")},1000)}}else{if(scope.results&&angular.isArray(scope.results)&&scope.results.length==1){var contentList=["contacts","relatedOrg","transactions","cases","products","contracts","memos","services","stock"];scope.churnCustomerContextType=true;scope.handleTabShown("subscriptions",scope.row);$("#subscriptions").addClass("active");$("#relatedOrg").removeClass("active");$("#searchContact").removeClass("active");$("#searchTransaction").removeClass("active");$("#searchCases").removeClass("active");$("#searchProduct").removeClass("active");$("#searchContracts").removeClass("active");$("#searchMemo").removeClass("active");$("#searchServices").removeClass("active");$("#searchStock").removeClass("active");angular.forEach(contentList,function(content){var tabid="#"+content+"-"+scope.row.customerNo;$(tabid).removeClass("active")});var tabRelatedOrgContentId="#relatedOrg-"+scope.row.customerNo;$(tabRelatedOrgContentId).removeClass("active");var tabSubscriptionsOrgContentId="#subscriptions-"+scope.row.customerNo;$(tabSubscriptionsOrgContentId).addClass("active")}}});scope.handleTabShown=function(tabName,customer){var companyName=customer.name;var customerNo=customer.customerNo;var customerEmail=customer.email;scope.cacheCustomer=angular.copy(customer);switch(tabName){case"contacts":case"relatedOrg":if(!scope.isMiniviewLoad){scope.loadImsDetail(customer)}break;case"transactions":scope.loadTransactions=function(){scope.isTransactionLoading=true;scope.row.ordersViewType=0;TransactionService.fill({customerNo:customerNo,startIndex:0,numberOfRows:15}).success(function(result){scope.row.transactions=[];var transactionsResult=result;for(var count=0;count<transactionsResult.length;count++){for(var orderTypeCount=0;orderTypeCount<scope.metadata.orderTypes.length;orderTypeCount++){if(transactionsResult[count].transType==scope.metadata.orderTypes[orderTypeCount].proct){transactionsResult[count].transTypeName=scope.metadata.orderTypes[orderTypeCount].type;break}}if(!transactionsResult[count].transTypeName){transactionsResult[count].transTypeName=TransactionUtil.getTransactionTypeName(transactionsResult[count].transType)}}scope.row.transactions.records=transactionsResult;scope.isTransactionLoading=false}).error(function(error){scope.row.error=true;scope.isTransactionLoading=false;$rootScope.$broadcast("showCrmTransactionErrorMessage")})};scope.loadDylanOrders=function(){scope.isTransactionLoading=true;scope.row.ordersViewType=1;console.log("Query CustomerTransactionService.getDylanOrders",scope.row.webGUID);CustomerTransactionService.getAllStoreOrders(scope.row.webGUID).success(function(result){console.log("success CustomerTransactionService.getDylanOrders");scope.dylanOrdersList=[];if(result!=""){var dylanResult=result.order;outer:for(var count=0;count<dylanResult.length;count++){dylanResult[count].creationDate=dylanResult[count]["order-date"];dylanResult[count].type="Order";for(var transactionCount=0;transactionCount<scope.row.transactions.records.length;transactionCount++){try{if(dylanResult[count]["order-number"]==scope.row.transactions.records[transactionCount].externalReferenceNo){dylanResult.splice(count,1);count=-1;continue outer}}catch(error){}}}scope.row.dylanOrdersList=dylanResult}else{console.log("No dylan orders",result)}scope.isTransactionLoading=false}).error(function(error){scope.row.dylanOrdersList=[];$rootScope.$broadcast("showTransactionErrorMessage");console.log("error",error);scope.isTransactionLoading=false})};scope.loadNotProcessedDylanOrders=function(){console.log("Query CustomerTransactionService.getAllStoreOrders");scope.row.ordersViewType=2;scope.isTransactionLoading=true;CustomerTransactionService.getAllStoreOrders(scope.row.webGUID).success(function(result){console.log("suceess CustomerTransactionService.getAllStoreOrders");scope.row.storeOrderList=[];angular.forEach(result.order,function(order){if(order.status=="UNAUTHORIZED"||order.status=="CANCELLED"){scope.row.storeOrderList.push(order)}});scope.isTransactionLoading=false}).error(function(error){console.log("error",error);scope.row.storeOrderList=[];scope.isTransactionLoading=false})};scope.loadTransactions();break;case"cases":CaseRecordService.fill({customerNo:customerNo,startIndex:0,numberOfRows:15}).success(function(result){scope.row.cases=[];scope.row.cases.records=result}).error(function(error){scope.row.error=true});break;case"products":scope.refreshProductList();break;case"subscriptions":if(!scope.row.subscriptions){scope.row.subscriptions=[]}scope.checkWebGuidAvailable=function(){$timeout(function(){if(typeof scope.row.webGUID=="undefined"){scope.checkWebGuidAvailable();return}else{if(typeof scope.row.webGUID!=="undefined"){if(scope.customerContextType===CustomerConstants.CUSTOMER_CONTEXT_IND||scope.churnCustomerContextType){scope.loadIndividualSubscriptions()}else{scope.loadJilTeamSubscriptions()}}}},500)};scope.checkWebGuidAvailable();break;case"contracts":ContractService.fill({customerNo:customerNo,startIndex:0,numberOfRows:15}).success(function(result){scope.row.contracts=[];scope.row.contracts.records=result}).error(function(error){scope.row.error=true});break;case"services":break;case"stock":console.log("Query customer entitlements",customer.customerGUID);var customerGUID=scope.row.webGUID;StockServices.getStockCustomerEntitlements({customerGuid:customerGUID+"@AdobeID"}).success(function(result){console.log("successfully pulled entitlement from stock API");scope.row.entitlements=result}).error(function(error){console.log("error",error);$("#stock").html(error)});break}};scope.addReminder=function(customer){$rootScope.$broadcast(AppConstants.ADD_REMINDER_EVENT,customer)};scope.broadcastCustomerId=function(customer){console.log("Selected Customer : "+customer.customerNo);scope.$root.$broadcast("event:customerIdentified",customer)};scope.isCreatingCRMCustomer=false;scope.createCrmRecord=function(customer,$event){var customerData={adobeId:customer.email,enterpriseId:customer.enterpriseId,customerNo:customer.customerNo};scope.isCreatingCRMCustomer=true;CustomerRecordService.createCrmRecord(customerData).success(function(response){console.log("CRM record service data:",response);console.log("Index : "+scope.searchIndex);var isNotAdminMsg;$.grep(response.messages,function(message){if(message.type=="E"&&message.number==""){isNotAdminMsg=message}});if(typeof isNotAdminMsg!=="undefined"){scope.isCreatingCRMCustomer=false;scope.$parent.showMessage("error",isNotAdminMsg.text);$($event.target).hide()}else{scope.$parent.updateRecordByIndex(response,scope.searchIndex);scope.isCreatingCRMCustomer=true}scope.isRengaSearch=false}).error(function(errorData){console.log("Error in CRM record service:",errorData);scope.$parent.showMessage("error","Error in creating customer in CRM");scope.isCreatingCRMCustomer=false})};scope.launchDRStore=function(customer){var drStoreData=new Object();drStoreData.adobeId=customer.adobeId;drStoreData.rengaId=customer.webGUID;drStoreData.locale=customer.address.country.drLocale;drStoreData.themeId=customer.address.country.drThemeId;drStoreData.siteId=customer.address.country.drSiteId;drStoreData.salesRepName=$rootScope.currentUser.username;drStoreData.firstName=customer.firstName;drStoreData.lastName=customer.lastName;drStoreData.street1=customer.address.street1;drStoreData.street2=customer.address.street2;drStoreData.street3=customer.address.street3;drStoreData.city=customer.address.city;drStoreData.state=customer.address.state;drStoreData.postCode=customer.address.postCode;drStoreData.countryCode=customer.address.country.code;drStoreData.countryName=customer.address.country.name;drStoreData.email=customer.email;drStoreData.phoneNumber=customer.telephone;drStoreData.mobileNo=customer.mobileNo;drStoreData.faxPhone=customer.fax;var url="/radon_java_webapp/drstore/index.html";var drStoreWindow=window.open(url,"DRStore","width=900,height=600,toolbar=0,menubar=0,location=0,status=0,scrollbars=1,resizable=1,left=0,top=0");drStoreWindow.focus();drStoreWindow.drStoreData=drStoreData};scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.loadIndividualSubscriptions=function(){$timeout(function(){scope.row.subscriptions.loading=true;scope.row.subscriptions.viewType=scope.VIEW_TYPE_INDIVIDUAL;$("#teamSubscriptionListBtn").removeClass("active");$("#individualSubscriptionListBtn").addClass("active");$("#trialBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");scope.locale=scope.row.defaultCountryLanguage+"_"+scope.row.address.country.code;scope.subscriptionAccountId=scope.row.webGUID+"@AdobeID";console.log("locale",scope.locale);console.log("subscriptionAccountId",scope.subscriptionAccountId);console.log("Customer Info inside subscription tab",scope.row.webGUID);CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:scope.subscriptionAccountId,locale:scope.locale}).success(function(result){scope.row.subscriptions.records=result;scope.loadCAHGUIDetails();scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length;if(scope.row.subscriptions.teamRecords){scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length+scope.row.subscriptions.teamRecords.length+(angular.isDefined(scope.row.subscriptions.trialRecords)&&angular.isArray(scope.row.subscriptions.trialRecords[0]["newmachines"])?scope.row.subscriptions.trialRecords[0]["newmachines"].length:0)}for(i=0;i<scope.row.subscriptions.records.length;i++){scope.row.subscriptions.records[i].formatedPurchaseDate=scope.row.subscriptions.records[i].contract.termStartDate;scope.row.subscriptions.records[i].ageing=moment().diff(new Date(scope.row.subscriptions.records[i].formatedPurchaseDate),"days");scope.row.subscriptions.records[i].locale=scope.locale;scope.row.subscriptions.records[i].subscriptionAccountId=scope.row.webGUID;scope.row.subscriptions.records[i]["backupstoreOrderNumber"]=scope.row.subscriptions.records[i].storeOrderNumber;if(scope.row.subscriptions.records[i].paymentStatus.toUpperCase()!=SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){scope.row.subscriptions.records[i].storeOrderNumber=scope.row.subscriptions.records[i].contract.externalContractId}scope.row.subscriptions.records[i].productName=scope.row.subscriptions.records[i].localizedLongProductDescriptor}}).error(function(error){console.log("error",error);scope.row.error=true;scope.row.subscriptions.records={};scope.row.subscriptions.error=error})},500)};scope.loadTeamSubscriptions=function(){$timeout(function(){scope.row.subscriptions.viewType=scope.VIEW_TYPE_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialBtn").removeClass("active");$("#teamSubscriptionListBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");scope.row.subscriptions.teamLoading=true;console.log("Query ProductRecordService.fill",scope.row.customerNo);scope.row.isFillFromCrmCalled=true;ProductRecordService.fillFromCrm({customerNo:scope.row.customerNo,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:"true"}).success(function(result){scope.row.subscriptions.teamRecords=result;scope.row.subscriptions.totalRecords=scope.row.subscriptions.teamRecords.length;if(scope.row.subscriptions.records){scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length+scope.row.subscriptions.teamRecords.length+(angular.isDefined(scope.row.subscriptions.trialRecords)&&angular.isDefined(scope.row.subscriptions.trialRecords[0]["newmachines"])&&angular.isArray(scope.row.subscriptions.trialRecords[0]["newmachines"])?scope.row.subscriptions.trialRecords[0]["newmachines"].length:0)}scope.row.subscriptions.teamLoading=false;scope.loadTeamContract()}).error(function(error){scope.row.subscriptions.totalRecords="";scope.row.subscriptions.teamLoading=false;scope.row.subscriptions.error=error;$("#subscriptions").html(error)})},500)};scope.loadTeamContract=function(){$timeout(function(){scope.customerGuid=scope.row.webGUID;scope.locale=scope.row.defaultCountryLanguage+"_"+scope.row.address.country.code;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){scope.row.subscriptions.teamJILResult=result;scope.loadCAHContractDetails(result)}).error(function(result,status,headers,config){var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Search Customer - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config)})},500)};scope.loadCAHContractDetails=function(value){if(angular.isDefined(value)&&angular.isArray(value)&&value.length>0){CAHService.getCAHContractDetail(value[0].programContractId).success(function(result,status,headers,config){var data={cahdetail:result,contractdetail:value};$rootScope.$broadcast("initiateCAHContractDetail",data);$rootScope.$broadcast("loadedCAHGUIDDetail",result);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for individual";messageObject.Result="SUCCESS";messageObject.Flow="Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$rootScope.$broadcast("initiateCAHContractDetailFailed",error);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - contract base api call for individual";messageObject.Result="FAILED";messageObject.Flow="Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})}else{$rootScope.$broadcast("stopCAHLoading","")}};scope.loadCAHGUIDetails=function(value){CAHService.getCAHGUIDDetail(scope.row.webGUID).success(function(result,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetail",result);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="SUCCESS";messageObject.Flow="Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$rootScope.$broadcast("loadedCAHGUIDDetail",error);var messageObject={Source_System:"CAH"};messageObject.Functionality="CAH - guid base api call for individual";messageObject.Result="ERROR";messageObject.Flow="Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})};scope.loadJilTeamSubscriptions=function(){$timeout(function(){scope.row.subscriptions.viewType=scope.VIEW_TYPE_JIL_TEAM;$("#individualSubscriptionListBtn").removeClass("active");$("#trialBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").addClass("active");scope.row.subscriptions.jilTeamLoading=true;scope.row.subscriptions.jilTeamRecords=[];scope.customerGuid=scope.row.webGUID;scope.locale=scope.row.defaultCountryLanguage+"_"+scope.row.address.country.code;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){scope.jilTeamAdminRecords=CustomerUtil.getTeamSubscriptionList(result,scope.customerGuid);var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Search Customer - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config);CustomerSubscriptionService.getTeamSubscriptionListByDelegate({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Search Customer - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config);scope.delegateCount=result.length;scope.delegateSearchCount=1;if(result&&result.length>=1){angular.forEach(result,function(team){CustomerSubscriptionService.getTeamSubscriptionDetails({customerGuid:scope.customerGuid,teamId:team.teamId,locale:scope.locale}).success(function(resultDetails,status,headers,config){var delegateDetails=[];if(scope.jilTeamAdminRecords.length&&scope.delegateSearchCount==1){scope.row.subscriptions.jilTeamRecords.push(scope.jilTeamAdminRecords)}if(scope.delegateCount==scope.delegateSearchCount){scope.row.subscriptions.jilTeamLoading=false}else{scope.delegateSearchCount++}delegateDetails.push(resultDetails);scope.jilTeamDelegateRecords=CustomerUtil.getTeamSubscriptionList(delegateDetails,scope.customerGuid);if(scope.jilTeamAdminRecords.length&&scope.jilTeamAdminRecords[0].teamId!=scope.jilTeamDelegateRecords[0].teamId){scope.row.subscriptions.jilTeamRecords.push(scope.jilTeamDelegateRecords)}else{if(!scope.jilTeamAdminRecords.length&&scope.jilTeamDelegateRecords.length){scope.row.subscriptions.jilTeamRecords.push(scope.jilTeamDelegateRecords)}}scope.row.subscriptions.totalRecords=scope.row.subscriptions.jilTeamRecords.length;scope.teamRecordslength=_.has(scope.row.subscriptions,"teamRecords")?scope.row.subscriptions.teamRecords.length?scope.row.subscriptions.teamRecords.length:0:0;if(scope.row.subscriptions.records){scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length+(angular.isDefined(scope.row.subscriptions.jilTeamRecords)&&angular.isArray(scope.row.subscriptions.jilTeamRecords)?scope.row.subscriptions.jilTeamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.teamRecords)&&angular.isArray(scope.row.subscriptions.teamRecords)?scope.row.subscriptions.teamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.trialRecords)&&angular.isDefined(scope.row.subscriptions.trialRecords[0]["newmachines"])&&angular.isArray(scope.row.subscriptions.trialRecords[0]["newmachines"])?scope.row.subscriptions.trialRecords[0]["newmachines"].length:0)}var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,resultDetails);messageObject.Functionality="Search Customer - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(resultDetails,status,headers,config){scope.row.subscriptions.totalRecords="";scope.row.subscriptions.jilTeamLoading=false;var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,resultDetails);messageObject.Functionality="Search Customer - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})})}else{scope.row.subscriptions.jilTeamLoading=false;if(scope.jilTeamAdminRecords.length){scope.row.subscriptions.jilTeamRecords.push(scope.jilTeamAdminRecords);scope.row.subscriptions.totalRecords=scope.row.subscriptions.jilTeamRecords.length;if(scope.row.subscriptions.records){scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length+(angular.isDefined(scope.row.subscriptions.jilTeamRecords)&&angular.isArray(scope.row.subscriptions.jilTeamRecords)?scope.row.subscriptions.jilTeamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.teamRecords)&&angular.isArray(scope.row.subscriptions.teamRecords)?scope.row.subscriptions.teamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.trialRecords)&&angular.isDefined(scope.row.subscriptions.trialRecords[0]["newmachines"])&&angular.isArray(scope.row.subscriptions.trialRecords[0]["newmachines"])?scope.row.subscriptions.trialRecords[0]["newmachines"].length:0)}}else{scope.row.subscriptions.totalRecords=""}}}).error(function(result,status,headers,config){scope.row.subscriptions.jilTeamLoading=false;if(scope.jilTeamAdminRecords.length){scope.row.subscriptions.jilTeamRecords.push(scope.jilTeamAdminRecords);scope.row.subscriptions.totalRecords=scope.row.subscriptions.jilTeamRecords.length;if(scope.row.subscriptions.records){scope.row.subscriptions.totalRecords=scope.row.subscriptions.records.length+(angular.isDefined(scope.row.subscriptions.jilTeamRecords)&&angular.isArray(scope.row.subscriptions.jilTeamRecords)?scope.row.subscriptions.jilTeamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.teamRecords)&&angular.isArray(scope.row.subscriptions.teamRecords)?scope.row.subscriptions.teamRecords.length:0)+(angular.isDefined(scope.row.subscriptions.trialRecords)&&angular.isDefined(scope.row.subscriptions.trialRecords[0]["newmachines"])&&angular.isArray(scope.row.subscriptions.trialRecords[0]["newmachines"])?scope.row.subscriptions.trialRecords[0]["newmachines"].length:0)}}else{scope.row.subscriptions.totalRecords="";scope.row.subscriptions.teamError=TeamUtil.standardErrorMessage(result)}var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Search Customer - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(result,status,headers,config){scope.row.subscriptions.jilTeamLoading=false;scope.row.subscriptions.totalRecords="";if(status==504){scope.row.subscriptions.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. Please check the subscription after 5 minutes before attempting to reprocess.")}else{scope.row.subscriptions.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load team subscription.")}var messageObject=scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Search Customer - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config)})},500)};scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};scope.loadTrialProduct=function(){$timeout(function(){scope.row.subscriptions.viewType=scope.VIEW_TYPE_TRIAL;$("#individualSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#trialBtn").addClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");scope.row.subscriptions.trialLoading=true;console.log("Query trial product",scope.row.customerNo);OnlineFlexibleTrialProductService.getTrialDeviceDetails({customerGuid:scope.row.webGUID+"@AdobeID",filterType:""}).success(function(result){scope.row.subscriptions.trialRecords=result;scope.row.subscriptions.trialLoading=false;var tempArray=[];if(!angular.isArray(scope.row.subscriptions.trialRecords[0].machines)){var machineArray=[];machineArray.push(scope.row.subscriptions.trialRecords[0].machines);scope.row.subscriptions.trialRecords[0].machines=machineArray}if(angular.isArray(scope.row.subscriptions.trialRecords[0].machines)){var applicationArray=[];angular.forEach(scope.row.subscriptions.trialRecords[0].machines,function(machine){applicationArray=[];if(!angular.isArray(machine.applications)){applicationArray.push(machine.applications);machine.applications=applicationArray}})}if(scope.row.subscriptions.trialRecords&&scope.row.subscriptions.trialRecords[0]&&scope.row.subscriptions.trialRecords[0].machines&&scope.row.subscriptions.trialRecords[0].machines.applications){scope.row.subscriptions.totalRecords=scope.row.subscriptions.trialRecords[0].machines.applications.length}var allApplication=[];angular.forEach(scope.row.subscriptions.trialRecords[0].machines,function(machine){angular.forEach(machine.applications,function(app){app.machine_id=machine.machine_id;allApplication.push(app)})});scope.row.subscriptions.trialRecords[0]["newmachines"]=angular.copy(allApplication);if(angular.isDefined(allApplication)&&angular.isArray(allApplication)){scope.row.subscriptions.totalRecords=(angular.isDefined(scope.row.subscriptions.records)&&angular.isArray(scope.row.subscriptions.records)?scope.row.subscriptions.records.length:0)+(angular.isDefined(scope.row.subscriptions.teamRecords)&&angular.isArray(scope.row.subscriptions.records)?scope.row.subscriptions.teamRecords.length:0)+allApplication.length}}).error(function(error){scope.row.subscriptions.totalRecords="";scope.row.subscriptions.trialLoading=false;scope.row.subscriptions.error=error;$("#subscriptions").html(error)})},500)};scope.refreshSubscriptions=function(){scope.row.subscriptions.totalRecords=0;if(scope.row.subscriptions.viewType===scope.VIEW_TYPE_TEAM){scope.row.subscriptions.teamRecords=null;scope.loadTeamSubscriptions()}else{if(scope.row.subscriptions.viewType===scope.VIEW_TYPE_JIL_TEAM){scope.row.subscriptions.jilTeamRecords=null;scope.row.subscriptions.teamError="";scope.loadJilTeamSubscriptions()}else{if(scope.row.subscriptions.viewType===scope.VIEW_TYPE_TRIAL){scope.row.subscriptions.trialRecords=null;scope.loadTrialProduct()}else{scope.row.subscriptions.records=null;scope.loadIndividualSubscriptions()}}}};scope.refreshProductList=function(bRefresh){if(!scope.row.products){scope.row.products=[]}if(bRefresh){scope.row.products.records=[]}ProductRecordService.fillFromCrm({customerNo:scope.row.customerNo,startIndex:0,numberOfRows:100,prodType:"IBASE"}).success(function(result){scope.row.products.records=result}).error(function(error){scope.row.products.records=[];scope.row.products.error=error;scope.row.error=true})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSelfHelp",["SelfHelpService","$filter",function(SelfHelpService,$filter){return{restrict:"EA",scope:{customerCase:"=",searchString:"=",triggerInsert:"&"},replace:true,templateUrl:"js/cases/partials/self-help-popup.html",link:function(scope,element,attrs){scope.displaySearchResult=false;scope.nextIndex=1;scope.updateSearchString=function(){if(scope.customerCase.product!=null){scope.searchString=scope.customerCase.product.product.metaName+" "+$filter("productLabelFilter")(scope.customerCase.product.product)+" "}if(scope.customerCase.caseDescription!=null){scope.searchString+=scope.customerCase.caseDescription}};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};var offset=40;var offsetBody=150;var newSize=offset*2};scope.showModal=function(){scope.updateSearchString();scope.performSearch();element.find("#selfHelpModal").modal("show");scope.rescale();$(window).bind("resize",scope.rescale)};scope.closeModal=function(){element.find("#selfHelpModal").modal("hide")};scope.performSearch=function(){scope.isLoadingResult=true;scope.displaySearchResult=false;scope.searchResults=[];SelfHelpService.search(1,scope.searchString).success(function(result){scope.searchResults=result;scope.isLoadingResult=false;scope.updateNextIndex(result)}).error(function(){scope.isLoadingResult=false})};scope.handleSelectResult=function(){scope.selectedResult=this.result;scope.isLoadingResult=true;SelfHelpService.openPage(scope.selectedResult.link).success(function(result){var resultParsed=SelfHelpService.parse(result,scope.selectedResult.link);scope.selfHelpContent=resultParsed.data;scope.isLoadingResult=false;scope.displaySearchResult=true}).error(function(){scope.isLoadingResult=false})};scope.handleBackToResults=function(){scope.displaySearchResult=false};scope.handleInsertUrl=function(link){scope.triggerInsert()(link);scope.closeModal()};scope.$watch("customerCase",function(value){if(!value){return}if(value){scope.updateSearchString()}});scope.handleLoadMore=function(){scope.isLoadingResult=true;scope.displaySearchResult=false;SelfHelpService.search(scope.nextIndex,scope.searchString).success(function(result){scope.searchResults.items=scope.searchResults.items.concat(result.items);scope.isLoadingResult=false;scope.updateNextIndex(result)}).error(function(){scope.isLoadingResult=false})};scope.updateNextIndex=function(result){if(result.queries&&result.queries.nextPage){scope.nextIndex=result.queries.nextPage[0].startIndex}else{scope.nextIndex=-1}}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SelfHelpService",["$http","Utils",function($http,Utils){var service={};service.search=function(startIndex,query){return $http({method:"POST",url:"../googleSearchService/google-search.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{query:encodeURIComponent(query),index:startIndex}})};service.openPage=function(link){return $http({method:"POST",url:"../sp/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:link}})};service.parse=function(data,url){var response={};response.data="Error";try{try{data=data.replace('<?xml version="1.0" encoding="utf-8"?>',"").trim();var meta=$(data).find("meta[http-equiv^='refresh']");if(meta){var refreshUrl=meta.attr("content");if(refreshUrl!=null){console.log("REFRESH FOUND");var matches=refreshUrl.match(/(http|www)\S+/i);if(matches!=null){return response}}}}catch(err2){data="Error"}var kbDocHTML=$(data).find(".parsys").html();var kbTitle=data.match(/<title>((.*?(\n))?.*?)<\/title>/im)[1];response.docTitle=kbTitle;data=$(kbDocHTML);$(data).find("img").not("[src^='http'],[src^='https']").each(function(){$(this).attr("src",function(index,value){var value2=service.urlResolve(url,value);return value2})});$(data).find("a").not("[href^='#'],[href=''],[href^='http'],[href^='https']").each(function(){$(this).attr("href",function(index,value){if(typeof value==="undefined"){return null}var value3=service.urlResolve(url,value);console.log("fixing: "+value+">>"+value3);return value3})});$(data).find("a").attr("target","_blank").on("click",service.anchorClickHandler)}catch(err){console.log(err)}response.data=data?data:"";return response};service.urlResolve=function(locationUrl,url){if(locationUrl==null||url==null){return url}if(url.indexOf("http://")===0||url.indexOf("https://")===0){return url}if(url.charAt(0)==="/"){return service.urlExtractDomainUrl(locationUrl)+url}return locationUrl.substr(0,locationUrl.lastIndexOf("/")+1)+url};service.urlExtractDomainUrl=function(locationUrl){return locationUrl.match(/(^https?\:\/\/[^\/?#]+)(?:[\/?#]|$)/i)[1]};service.anchorClickHandler=function(event){var url=$(this).attr("href");console.log("click handler:"+url);if(url.indexOf("#")==0){event.preventDefault();return false}event.preventDefault();if((url.indexOf("kb")>=0||url.indexOf("helpx")>=0||url.indexOf("devnet")>=0)&&(url.indexOf("adobe")>=0)){return false}window.open(url,"_blank");return false};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SerialDecodeService",["$http",function($http){var service={};service.decode=function(data){return $http({method:"POST",url:"../serialDecodeService/decode.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.nonSerialRegister=function(data){return $http({method:"POST",url:"../serialDecodeService/nonSerialRegister.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.register=function(data){return $http({method:"POST",url:"../serialDecodeService/register.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.cancel=function(data){return $http({method:"POST",url:"../serialDecodeService/cancel.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("ServicesCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","Utils","ImsCustomerService",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,Utils,ImsCustomerService){TrackingService.trackPageView("Services","Services");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Services");$scope.customerAccountID=$routeParams.customerAccountID;var customerSearchObj={guid:$scope.customerAccountID.split("@")[0],authSrc:$scope.customerAccountID.split("@")[1]};$scope.customer={};ImsCustomerService.getCustomerProfileByGuid(customerSearchObj).then(function(response){if(angular.isDefined(response.data.error)){$scope.customer.messages=Utils.showMessage("error","Customer is not valid");$scope.isLoading=false;return}$scope.imsCustomer=response.data;var result=response.data;if(result.serviceAccounts){angular.forEach(result.serviceAccounts,function(item){if(item.serviceCode=="creative_cloud"){$scope.imsCustomer.serviceCode=item.serviceCode;$scope.imsCustomer.serviceStatus=item.serviceStatus;$scope.imsCustomer.serviceLevel=item.serviceLevel;if(item.params){for(var imsCount=0;imsCount<item.params.length;imsCount++){if(item.params[imsCount].pn=="storage_quota"){$scope.imsCustomer.serviceStorage=item.params[imsCount].pv+" GB"}}}}})}angular.forEach($scope.imsCustomer.serviceAccounts,function(item){if(item.params){for(var imsItemCount=0;imsItemCount<item.params.length;imsItemCount++){if(item.params[imsItemCount].pn=="storage_quota"){item.serviceStorage=item.params[imsItemCount].pv+" GB"}}}});$scope.isLoading=false},function(error){console.log("IMS details load failed");$scope.customer.messages.push(Utils.showMessage("error","Customer is not valid"));$scope.isLoading=false})}]);app.controller("SettingCtrl",["$scope","$route","$rootScope","$routeParams","$location","$timeout","MetadataService","TrackingService","LocalStorageService","HxDbFactory","IndexedDbFactory","Utils",function($scope,$route,$rootScope,$routeParams,$location,$timeout,MetadataService,TrackingService,LocalStorageService,HxDbFactory,IndexedDbFactory,Utils){TrackingService.trackPageView("User","Setting");var isValidUser=LocalStorageService.get("isValidUser");if(!isValidUser){$location.path("/login")}else{$rootScope.$broadcast("event:ping")}Utils.pageTitle("User Settings");$scope.showProgressBar;$scope.metadataTaskTitle;$scope.metadata=new Object();$scope.metadataUpdatedOn;$scope.showMetadataModal=function(metadataDb){$scope.metadataTaskTitle="Initiating Metadata Service";$scope.showProgressBar=true;$("#metadataModal").modal("show");$timeout(function(){$scope.loadMetadata(metadataDb)},3000)};$scope.closeMetadataModal=function(){$("#metadataModal").modal("hide");var sessionRtrnUrl=decodeURIComponent(window.sessionStorage.returnUrl);var temporarySFDCURL=decodeURIComponent(window.sessionStorage.returnUrlSFDC);if((angular.isDefined(temporarySFDCURL)&&temporarySFDCURL&&temporarySFDCURL!=""&&temporarySFDCURL.indexOf("/sfdc")==0)||(angular.isDefined($routeParams.apq_Id)&&$routeParams.apq_Id.length>0)){$timeout(function(){$location.path("/sfdc")},1000)}else{if(sessionRtrnUrl.indexOf("/login")==-1&&sessionRtrnUrl.indexOf("undefined")==-1){$rootScope.returnUrl=sessionRtrnUrl;window.sessionStorage.clear()}if($rootScope.returnUrl&&decodeURIComponent($rootScope.returnUrl).indexOf("/login")==-1){$location.path(decodeURIComponent($rootScope.returnUrl))}else{$location.path("/search")}}};$scope.loadMetadata=function(metadataDb){$scope.metadataTaskTitle="Accessing Metadata Service - please wait...";MetadataService.getCompleteMetadata().success(function(result){$scope.metadataTaskTitle="Metadata Service Response Received";var metadataResult=result;if(metadataResult.timestamp){var metadataInfo=[{timestamp:metadataResult.timestamp,lang:metadataResult.localeCode}];metadataResult.metadataInfo=metadataInfo}for(var key in metadataResult){if(angular.isObject(metadataResult[key])){switch(key){case"tsCaseMetadataDto":for(var tsCaseKey in metadataResult[key]){metadataResult[tsCaseKey]=metadataResult[key][tsCaseKey]}delete metadataResult[key];break;case"caseMetadataDto":for(var caseKey in metadataResult[key]){metadataResult["meta"+caseKey]=metadataResult[key][caseKey]}delete metadataResult[key];break;case"registeredProductMetadata":for(var registerKey in metadataResult[key]){metadataResult["registered"+registerKey]=metadataResult[key][registerKey]}delete metadataResult[key];break}}}var count=5;var redirectWithin3seconds=function(){if(count<4){$scope.metadataTaskTitle="Switching to HDX5 in "+count+" seconds...";$scope.showProgressBar=true}count-=1;if(count<=-1){$scope.showProgressBar=false;$scope.closeMetadataModal()}else{$timeout(redirectWithin3seconds,1000)}};$scope.metadataTaskTitle="Creating Metadata in Client System";HxDbFactory.implementDbs(metadataDb,metadataResult,function(isSuccess){if(isSuccess){$timeout(function(){$scope.metadataTaskTitle="Metadata Created Successfully In The Client System";$scope.showProgressBar=false;MetadataService.isMetadataUptodate=true;$scope.getMetadata();redirectWithin3seconds()},1000)}});$timeout(function(){if($scope.showProgressBar){window.location.reload()}},60000)}).error(function(error){$scope.showProgressBar=false;$scope.metadataTaskTitle="Metadata Service Response Failed, Please Try Again..."})};HxDbFactory.openMetadataDb(function(result,dbObject){HxDbFactory.initDbName();if(result){if(dbObject.objectStoreNames.length==0){dbObject.close();if(HxDbFactory.metadataDb){$scope.showMetadataModal(HxDbFactory.metadataDb)}}else{if(MetadataService.isMetadataUptodate==false){$scope.reloadMetadata()}else{$scope.getMetadata()}}}});$scope.showDeleteMetadataModal=function(appDb){$scope.metadataTaskTitle="Initiating Metadata Deletion";$scope.showProgressBar=true;$("#deleteMetadataModal").modal("show");$scope.deleteMetadata()};$scope.closeDeleteMetadataModal=function(){$("#deleteMetadataModal").modal("hide")};$scope.showAndCloseDeleteMetadataModal=function(status){$timeout(function(){if(status==HxDbFactory.DB_STATUS.SUCCESS){$scope.metadataTaskTitle="Metadata Deleted Successfully"}else{$scope.metadataTaskTitle="We are not able to delete due to some issues, Please delete the metadata manually"}$scope.showProgressBar=false},1000);$scope.showProgressBar=false};$scope.deleteMetadata=function(){$scope.showProgressBar=true;$scope.metadataTaskTitle="Deleting Metadata";$timeout(function(){$scope.metadataTaskTitle="Metadata Deleted Successfully In The Client System";$scope.showProgressBar=false},30000);HxDbFactory.deleteMetadataDb(function(resultType){$timeout(function(){$scope.metadataTaskTitle="Metadata Deleted Successfully In The Client System";$scope.showProgressBar=false},1000)})};$scope.reloadMetadata=function(){$scope.metadataTaskTitle="Reloading Metadata In The Client System";$scope.showProgressBar=true;$("#reloadMetadataModal").modal("show");HxDbFactory.deleteMetadataDb(function(resultType){});$timeout(function(){if(HxDbFactory.metadataDb.name){$scope.closeReloadMetadataModal();window.location.reload()}},4000)};$scope.closeReloadMetadataModal=function(){$("#reloadMetadataModal").modal("hide")};$scope.getMetadata=function(){MetadataService.initializeSettingMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus;$timeout(function(){$scope.metadataUpdatedOn=$scope.metadata.metadataInfo[0].timestamp},1000)})}}]);app=app||angular.directive("hxApp.directive",[]);app.directive("ngSfdcAccount",["$rootScope",function($rootScope){return{restrict:"EA",scope:{accountDetails:"=",isLoadingAccountError:"=",isAccountNotFound:"="},replace:true,templateUrl:"js/sfdc/partials/sfdc-account-view.html",link:function(scope,element,attrs){scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("SFDCConstants",{SFDC_ACCOUNT_QUERY:"SELECT BillingCity,BillingCountry,BillingPostalCode,BillingState,BillingStreet,Industry_Category__c,Name FROM Account WHERE Id = '{1}'",SFDC_CONTACT_QUERY:"SELECT Id,Email,FirstName,HomePhone,LastName,MobilePhone,Salutation FROM Contact WHERE Id = '{1}'",SFDC_OPPORTUNITY_QUERY:"SELECT Id,GST_ID__c,VAT_ID__c FROM Opportunity WHERE Id = '{1}'",SOURCE_SYSTEM_SFDC:"SFDC",SERVICE_INVOKE_GET_ACCOUNT:"SERVICE_INVOKE_GET_ACCOUNT",SERVICE_INVOKE_GET_OPPORTUNITY:"SERVICE_INVOKE_GET_OPPORTUNITY",SERVICE_INVOKE_GET_CONTACT:"SERVICE_INVOKE_GET_CONTACT"});app=app||angular.directive("hxApp.directive",[]);app.directive("ngSfdcContact",["$rootScope",function($rootScope){return{restrict:"EA",scope:{contactDetails:"=",isLoadingContactError:"=",isContactNotFound:"="},replace:true,templateUrl:"js/sfdc/partials/sfdc-contact-view.html",link:function(scope,element,attrs){scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("SFDCCtrl",["$scope","$rootScope","$routeParams","SFDCConstants","SFDCUtil","SFDCService","ImsCustomerService","CustomerPreviewService","UserService","SalesUtil","AppUtils","AppConstants","$app","$q","$location","CustomerRecordService",function($scope,$rootScope,$routeParams,SFDCConstants,SFDCUtil,SFDCService,ImsCustomerService,CustomerPreviewService,UserService,SalesUtil,AppUtils,AppConstants,$app,$q,$location,CustomerRecordService){$scope.isLoadingAccount=true;$scope.isLoadingContact=true;$scope.isLoadingOpportunity=true;$scope.isLoadingAccountError=false;$scope.isLoadingContactError=false;$scope.isLoadingOpportunityError=false;$scope.isAccountNotFound=false;$scope.isContactNotFound=false;$scope.isOpportunityNotFound=false;$scope.isSearchLoading=false;$scope.isHendrixAccountLoading=false;$scope.isContactExist=false;$scope.isCustomerExistInCrm=true;$scope.isCustomerExistInIms=true;$scope.accountID=$routeParams.accountID;$scope.contactID=$routeParams.contactID;$scope.opportunityID=$routeParams.opportunityID;$scope.asynchId=$routeParams.apq_Id;$scope.isNewCustomer=false;$scope.isCreatingCRMCustomer=false;$scope.AppConstants=AppConstants;window.sessionStorage.returnUrlSFDC=encodeURIComponent($location.path());UserService.getCurrentUser().success(function(result){$scope.initialize();if($rootScope.returnUrl){$rootScope.returnUrl=null}}).error(function(error){console.log("UserService.getCurrentUser() -->"+error);return});$scope.accountDetails;$scope.contactDetails;$scope.opportunityDetails;$scope.loadCustomerCreatePopup={};$scope.defaultCustomer={};$scope.loadCustomerCreatePopup.updateCreateDetail=function(customer){customer.rengaGuid=customer.userId.split("@")[0];$scope.customerSearchResults.push(customer);$scope.isNewCustomer=true;AppUtils.sendLogToServer("SFDC:Created customer in CRM and  IMS :, userID = "+customer.userId+",CustomerNo ="+customer.customerNo)};$scope.placeOrder=function(customer){var returnCaseTemplateUrl="/store/"+customer.address.country.code.toLowerCase()+"?customer="+customer.customerNo+"&saccountID="+$scope.accountID+"&scontactID="+$scope.contactID+"&sopportunityID="+$scope.opportunityID+"&asynchId="+$scope.asynchId+"&isNewCustomer="+true;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:"",customerType:"1",authSrc:""};$scope.initializeMetadata=function(){AppUtils.initializeModule(AppConstants.MODULE_SFDC,function(metadataObject,moduleStatus){$scope.metadata=metadataObject;if(moduleStatus==AppConstants.MODULE_INIT_METADATA_SUCCESS){console.info("SFDC Module Metadata Loaded Successfully");$scope.searchCustomer($scope.contactDetails.Email);$app.hideLoading()}else{if(moduleStatus==AppConstants.MODULE_INIT_METADATA_FAILED){console.error("Error loading metadata in SFDC Module")}else{console.error("SFDC Module - Unexpected Error, Please reload the application")}}})};$scope.initialize=function(){var accountQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_ACCOUNT_QUERY,$scope.accountID);var contactQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_CONTACT_QUERY,$scope.contactID);var opportunityQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_OPPORTUNITY_QUERY,$scope.opportunityID);var parallelCalls=[];parallelCalls.push(SFDCService.loadAccount({accountQuery:accountQuery}).success(function(result,status,headers,config){$scope.isLoadingAccount=false;$scope.accountDetails=result.records[0];if(result&&result.records.length<=0){$scope.isAccountNotFound=true}var messageObject=$scope.getMessageLoggingObject(SFDCConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_ACCOUNT,true,result);messageObject.Functionality="Load SFDC Account";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isLoadingAccount=false;$scope.isLoadingAccountError=true;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_ACCOUNT,false,error);AppUtils.sendLogToServer(messageObject,status,headers,config)}));parallelCalls.push(SFDCService.loadContact({contactQuery:contactQuery}).success(function(result,status,headers,config){$scope.isLoadingContact=false;$scope.contactDetails=result.records[0];if(result&&result.records.length<=0){$scope.isContactNotFound=true}$scope.isHendrixAccountLoading=true;var messageObject=$scope.getMessageLoggingObject(SFDCConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_CONTACT,true,result);messageObject.Functionality="Load SFDC Contact";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isLoadingContact=false;$scope.isLoadingContactError=true;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_CONTACT,false,error);AppUtils.sendLogToServer(messageObject,status,headers,config)}));parallelCalls.push(SFDCService.loadOpportunity({opportunityQuery:opportunityQuery}).success(function(result,status,headers,config){$scope.isLoadingOpportunity=false;$scope.opportunityDetails=result.records[0];if(result&&result.records.length<=0){$scope.isOpportunityNotFound=true}var messageObject=$scope.getMessageLoggingObject(SFDCConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_OPPORTUNITY,true,result);messageObject.Functionality="Load SFDC Opportunity";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isLoadingOpportunity=false;$scope.isLoadingOpportunityError=true;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_SFDC,SFDCConstants.SERVICE_INVOKE_GET_OPPORTUNITY,false,error);AppUtils.sendLogToServer(messageObject,status,headers,config)}));$q.all(parallelCalls).then(function(value){console.log("All call successfull");if($scope.isLoadingContactError||$scope.isContactNotFound){$scope.isSearchLoading=false;$scope.isHendrixAccountLoading=false}else{$scope.initializeMetadata()}},function(reason){console.log("All call fail");$scope.isSearchLoading=false;$scope.isHendrixAccountLoading=false})};$scope.searchCustomer=function(customerId){$scope.isSearchLoading=true;$scope.imsSearchResults=[];$scope.customerSearchResults=[];var regEmail=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(regEmail.test(customerId)){$scope.searchIMSCustomer(customerId)}else{$scope.isCustomerExistInIms=true}};$scope.searchIMSCustomer=function(customerId){var customerObj={email:customerId};ImsCustomerService.getItem(customerObj).success(function(response){$scope.isSearchLoading=false;if(!$.isArray(response)&&response.userId){$scope.imsSearchResults.push(SalesUtil.getCustomerResultDto(true,response));$scope.searchCRMCustomer(response.userId)}else{$scope.isHendrixAccountLoading=false;$scope.isCustomerExistInIms=false;$scope.isCustomerExistInCrm=false;$scope.defaultCustomer=SFDCUtil.getCustomerDto($scope.accountDetails,$scope.contactDetails,$scope.opportunityDetails);$scope.loadCustomerCreatePopup.openModal($scope.defaultCustomer)}}).error(function(errorData){$scope.isSearchLoading=false;$scope.customerSearchResults=[];$scope.isHendrixAccountLoading=false})};$scope.searchCRMCustomer=function(customerId){var regEx=/^[0-9A-Fa-f]{24}/;var searchFieldsRequest=angular.copy($scope.searchFields);if(customerId&&customerId.indexOf("@")>=0){if(regEx.test(customerId.split("@")[0])){searchFieldsRequest.idNumber=customerId.split("@")[0];searchFieldsRequest.authSrc=customerId.split("@")[1]}}CustomerPreviewService.search(searchFieldsRequest).success(function(result){$scope.customerSearchResults=result.customerSearchResults;$scope.isHendrixAccountLoading=false}).error(function(result){$scope.isSearchLoading=false;$scope.isHendrixAccountLoading=false;$scope.isCustomerExistInCrm=false;$scope.customerSearchResults=[]})};$scope.createCrmRecord=function(customer,$event){var customerData={adobeId:customer.email,enterpriseId:customer.enterpriseId,customerNo:customer.customerNo};$scope.isCreatingCRMCustomer=true;AppUtils.sendLogToServer("Create Record in CRM from SFDC flow - "+customer.email);CustomerRecordService.createCrmRecord(customerData).success(function(response){console.log("CRM record service data:",response);console.log("Index : "+$scope.searchIndex);var isNotAdminMsg;$.grep(response.messages,function(message){if(message.type=="E"&&message.number==""){isNotAdminMsg=message;AppUtils.sendLogToServer("SFDC:Create CRM Record  failed for customer Email: "+customer.email+",Reason:"+message.text)}});if(typeof isNotAdminMsg!=="undefined"){$scope.isCreatingCRMCustomer=false;$scope.$parent.showMessage("error",isNotAdminMsg.text);$($event.target).hide();AppUtils.sendLogToServer("SFDC:Create CRM Record  failed for customer Email: "+customer.email+",Reason:"+message.text)}else{$scope.updateRecordByIndex(response,$scope.searchIndex);$scope.isCreatingCRMCustomer=false;AppUtils.sendLogToServer("SFDC :Create CRM Record  success for customer Email: "+customer.email)}$scope.isRengaSearch=false}).error(function(errorData){console.log("Error in CRM record service:",errorData);$scope.$parent.showMessage("error","Error in creating customer in CRM");$scope.isCreatingCRMCustomer=false;AppUtils.sendLogToServer("SFDC :Create CRM Record service failed for customer Email: "+errorData)})};$scope.updateRecordByIndex=function(newRecord,itemIndex){$scope.customerSearchResults[0]=newRecord;console.log(newRecord,"new record updated at index: "+itemIndex)};$scope.getMessageLoggingObject=function(sourceSystem,serviceCategory,isSuccess,result,errors){var messageObject=new Object();if(sourceSystem==SFDCConstants.SOURCE_SYSTEM_SFDC&&serviceCategory==SFDCConstants.SERVICE_INVOKE_GET_ACCOUNT){messageObject.Source_System=SFDCConstants.SOURCE_SYSTEM_SFDC;messageObject.Industry_Category__c=$scope.accountDetails.Industry_Category__c;messageObject.BillingCountry=$scope.accountDetails.BillingCountry}if(sourceSystem==SFDCConstants.SOURCE_SYSTEM_SFDC&&serviceCategory==SFDCConstants.SERVICE_INVOKE_GET_OPPORTUNITY){messageObject.Source_System=SFDCConstants.SOURCE_SYSTEM_SFDC;messageObject.OpportunityID=$scope.opportunityID}if(sourceSystem==SFDCConstants.SOURCE_SYSTEM_SFDC&&serviceCategory==SFDCConstants.SERVICE_INVOKE_GET_CONTACT){messageObject.Source_System=SFDCConstants.SOURCE_SYSTEM_SFDC;messageObject.Id=$scope.contactDetails.Id;messageObject.FirstName=$scope.contactDetails.FirstName}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject}}]);app=app||angular.directive("hxApp.directive",[]);app.directive("ngSfdcOpportunity",["$rootScope",function($rootScope){return{restrict:"EA",scope:{opportunityDetails:"=",accountDetails:"=",isLoadingOpportunityError:"=",isOpportunityNotFound:"="},replace:true,templateUrl:"js/sfdc/partials/sfdc-opportunity-view.html",link:function(scope,element,attrs){scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)}}}}]);app=app||angular.directive("hxApp.directive",[]);app.directive("ngSfdcCustomerSearch",["$rootScope",function($rootScope){return{restrict:"EA",scope:{results:"=",metadata:"="},replace:true,templateUrl:"js/sfdc/partials/sfdc-search-item.html",link:function(scope,element,attrs){}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SFDCService",["socket","$q","$http",function(socket,$q,$http){var service={};service.loadAccount=function(data){return $http({method:"POST",url:"../sfdcService/getSFDCAccountDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.loadContact=function(data){return $http({method:"POST",url:"../sfdcService/getSFDCContactDetail.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.loadOpportunity=function(data){return $http({method:"POST",url:"../sfdcService/getSFDCOpportunityDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.updateSFDCOpportunityDetail=function(data){return $http({method:"POST",url:"../sfdcService/updateSFDCOpportunityDetail.do",headers:{"Content-Type":"application/json;charset=UTF-8",Accept:"text/plain;charset=UTF-8"},data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("SFDCUtil",["$rootScope","$location","CrmCustomerDto","AddressDto",function($rootScope,$location,CrmCustomerDto,AddressDto){var TEMPLATE={};TEMPLATE.UTIL={formatLinkString:function(){var args=[].slice.call(arguments);if(this.toString()!="[object Object]"){args.unshift(this.toString())}var pattern=new RegExp("{([1-"+args.length+"])}","g");return String(args[0]).replace(pattern,function(match,index){return args[index]})}};this.getQuery=function(queryString,queryId){return TEMPLATE.UTIL.formatLinkString(queryString,queryId)};this.getCustomerDto=function(account,contact,opportunity){var customer=angular.copy(CrmCustomerDto);var address=angular.copy(AddressDto);if(angular.isDefined(contact)){customer.firstName=contact.FirstName;customer.lastName=contact.LastName;customer.email=contact.Email;customer.phone=contact.HomePhone}if(opportunity!=null&&angular.isDefined(opportunity)){if(opportunity.hasOwnProperty("VAT_ID__c")){customer.taxNumber=opportunity.VAT_ID__c}}if(angular.isDefined(account)){address.city=account.BillingCity;address.country.code=account.BillingCountry;address.postCode=account.BillingPostalCode;address.state=account.BillingState;address.street1=account.BillingStreet}customer.address=address;return customer}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("onlySingleByte",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){if(inputValue==undefined){return""}var modifiedData="";try{modifiedData=decodeURIComponent(escape(inputValue))}catch(error){modifiedData=inputValue.slice(0,-1)}if(modifiedData!=inputValue){modelCtrl.$setViewValue(modifiedData);modelCtrl.$render()}return modifiedData})}}});var app=app||angular.module("hxApp.directive",[]);app.directive("skuConfigurator",["$rootScope","StoreConstants","SkuSearchService","AppUtils","StoreUtil",function($rootScope,StoreConstants,SkuSearchService,AppUtils,StoreUtil){return{restrict:"EA",scope:{skuList:"=",catalogProduct:"=",currentStore:"=",skuCurrency:"="},replace:true,templateUrl:"js/store/common/partials/sku-configurator.html",link:function(scope,element,attrs){scope.StoreConstants=StoreConstants;scope.configDistribution={};scope.configVersion={};scope.configTerm={};scope.configPlatform={};scope.configLanguage={};scope.configDelivery={};scope.selectedSku={};scope.isCrmPriceLoading=false;scope.configuratorChanged=function(){};scope.$watch("configDistributionFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configDistribution=scope.configDistributionFiltered[0]}});scope.$watch("configDistribution.distributionMethod.distributionMethod",function(newValue,oldValue){scope.configVersionFiltered=[];scope.configTermFiltered=[];scope.configPlatformFiltered=[];scope.configLanguageFiltered=[];scope.configDeliveryFiltered=[];scope.configVersion="";scope.configTerm="";scope.configPlatform="";scope.configLanguage="";scope.configDelivery="";scope.selectedSku=[]});scope.$watch("configVersionFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configVersion=scope.configVersionFiltered[0]}});scope.$watch("configTermFiltered[0].id",function(newValue,oldValue){if(newValue&&scope.configTermFiltered.length==1){scope.configTerm=scope.configTermFiltered[0]}});scope.$watch("configTermFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configTerm=scope.configTermFiltered[0]}});scope.$watch("configPlatformFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configPlatform=scope.configPlatformFiltered[0]}});scope.$watch("configPlatform",function(newValue,oldValue){scope.configLanguage="";scope.selectedSku=[]});scope.$watch("configLanguageFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configLanguage=scope.configLanguageFiltered[0]}});scope.$watch("configDeliveryFiltered.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.configDelivery=scope.configDeliveryFiltered[0]}});scope.$watch("finalSku.length",function(newValue,oldValue){if(newValue&&newValue==1){scope.selectedSku=scope.finalSku[0]}});scope.$watch("finalSku[0].id",function(newValue,oldValue){if(newValue&&scope.finalSku.length==1){scope.selectedSku=scope.finalSku[0]}});scope.$watch("selectedSku.id",function(newValue,oldValue){if(newValue&&newValue!=oldValue){scope.catalogProduct.crmData=null}else{return}if(scope.catalogProduct.skuList&&scope.catalogProduct.skuList.length==1){scope.checkCrmPriceAndAdd(scope.catalogProduct.skuList[0])}});scope.checkCrmPriceAndAdd=function(skuData){if(scope.catalogProduct.crmData&&skuData.id==scope.catalogProduct.crmData.sku&&scope.catalogProduct.crmData.excludeFromHendrix){scope.addProductFromCatalog(scope.catalogProduct.crmData);return}var requestProductSearchDto=new Object();requestProductSearchDto.storeId=scope.currentStore.storeKey;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};crmSearchObject.sku=skuData.id;requestProductSearchDto.criteria=crmSearchObject;scope.isCrmPriceLoading=true;SkuSearchService.search(requestProductSearchDto).success(function(result){if(result&&result.length==1){scope.catalogProduct.crmData=result[0];scope.catalogProduct.crmData.productImg=AppUtils.getProductThumbnailImageFromCrmDescription(scope.catalogProduct.crmData.description);scope.catalogProduct.crmData.name=StoreUtil.getSkuProductName(scope.catalogProduct.crmData.name,scope.catalogProduct.crmData.description);if(!scope.catalogProduct.crmData.excludeFromHendrix&&scope.catalogProduct.crmData.price.listPrice!="0"){scope.addProductFromCatalog(scope.catalogProduct.crmData)}}scope.isCrmPriceLoading=false}).error(function(result){scope.catalogProduct.crmData=null;scope.isCrmPriceLoading=false})};scope.addProductFromCatalog=function(crmProduct){$rootScope.$broadcast(StoreConstants.STORE_CRM_ADD_TO_CART_EVENT,crmProduct)}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("SkuSearchController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","StoreUtil","StoreConstants","SkuSearchService",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,StoreUtil,StoreConstants,SkuSearchService){$scope.isSkuSearchLoading=false;$scope.isSearchBySkuView=true;$scope.isOnlineQuoteSearchBySku=false;$scope.onlineQuoteSkuIndex=0;$scope.crmSearchObject={name:"",sku:"",language:"",mediaType:"",version:"",platform:"",config:""};$scope.$on(StoreConstants.STORE_SKU_SEARCH_FROM_URL_EVENT,function(event){if($scope.sku){$scope.crmSearchObject.sku=$scope.sku;$scope.crmSearch();$scope.$parent.toggleSkuSearchView()}});$scope.$on(StoreConstants.STORE_ONLINE_QUOTE_SKU_SEARCH_EVENT,function(event){$scope.isOnlineQuoteSearchBySku=true;$scope.onlineQuoteSkuIndex=0;if($scope.onlineQuoteResult.items){$scope.$parent.toggleSkuSearchView();$rootScope.$broadcast(StoreConstants.STORE_ONLINE_QUOTE_SEARCH_BY_ONE_SKU_EVENT)}});$scope.$on(StoreConstants.STORE_ONLINE_QUOTE_SEARCH_BY_ONE_SKU_EVENT,function(event){if($scope.onlineQuoteResult.items.length>$scope.onlineQuoteSkuIndex){$scope.$parent.showQuoteViewLoading("Processing "+($scope.onlineQuoteSkuIndex+1)+" of "+$scope.onlineQuoteResult.items.length+" items, Please wait...");$scope.crmSearchObject.sku=$scope.onlineQuoteResult.items[$scope.onlineQuoteSkuIndex].sku.id;$scope.addToCart=true;$scope.crmSearch()}else{$scope.isOnlineQuoteSearchBySku=false;$scope.onlineQuoteSkuIndex=0;$scope.addToCart=false;$scope.$parent.hideQuoteViewLoading();$scope.$parent.toggleSkuSearchView()}});$scope.crmSearch=function(){$scope.isSkuSearchLoading=true;$scope.crmSearchResult;$scope.crmSearchObjectRequest=angular.copy($scope.crmSearchObject);if($scope.isSearchBySkuView){$scope.crmSearchObjectRequest.name=$scope.crmSearchObjectRequest.language=$scope.crmSearchObjectRequest.mediaType=$scope.crmSearchObjectRequest.version=$scope.crmSearchObjectRequest.platform=$scope.crmSearchObjectRequest.config=null}else{for(var key in $scope.crmSearchObjectRequest){if($scope.crmSearchObjectRequest[key]==""){$scope.crmSearchObjectRequest[key]=null}}$scope.crmSearchObjectRequest.sku=null}var requestProductSearchDto=new Object();requestProductSearchDto.storeId=$scope.currentStore.storeKey;requestProductSearchDto.criteria=$scope.crmSearchObjectRequest;SkuSearchService.search(requestProductSearchDto).success(function(result){TrackingService.trackPageView("Store","Sku Search: "+$scope.currentStore.countryName);$scope.crmSearchResult=[];$scope.isSkuSearchLoading=false;$scope.ccmTeamFound=false;$scope.skuRestrctionFound=false;$scope.storeFound=false;$scope.crmSearchResult=result;angular.forEach($scope.crmSearchResult,function(crmProduct){crmProduct.productImg=AppUtils.getProductThumbnailImageFromCrmDescription(crmProduct.description);crmProduct.name=StoreUtil.getSkuProductName(crmProduct.name,crmProduct.description);if(crmProduct.description.indexOf("PPUH")>=0||crmProduct.description.indexOf("ERR01")>=0||crmProduct.description.indexOf("EER01")>=0||crmProduct.description.indexOf("ERR12")>=0||crmProduct.description.indexOf("EER12")>=0||crmProduct.excludeFromHendrix){crmProduct.skuRestrctionFound=true;crmProduct.toolTip=StoreConstants.SKU_NOT_SOLD_TOOLTIP}else{if(crmProduct.prodType.toUpperCase()==StoreConstants.HARD_GOOD_PRODUCT_TYPE&&(crmProduct.description.toUpperCase().indexOf("FF")>=0||crmProduct.description.toUpperCase().indexOf("PGMP")>=0||crmProduct.description.indexOf("DOCST")>=0||crmProduct.description.indexOf("DVSET")>=0)){crmProduct.skuRestrctionFound=false;crmProduct.toolTip=StoreConstants.NOT_SOLD_TOOLTIP}else{if(crmProduct.prodType.toUpperCase()==StoreConstants.HARD_GOOD_PRODUCT_TYPE){crmProduct.skuRestrctionFound=true;crmProduct.toolTip=StoreConstants.HARDGOOD_NOT_SOLD_TOOLTIP}else{if(crmProduct.educational!=$scope.currentStore.isEduStore){crmProduct.skuRestrctionFound=true;crmProduct.toolTip=$scope.currentStore.isEduStore?StoreConstants.COMMERCIAL_SKU_NOT_VALID_TOOLTIP:StoreConstants.EDUCATIONAL_SKU_NOT_VALID_TOOLTIP}}}}if(!StoreUtil.isSKUSellableBeforeSKUSearch(crmProduct.sku)){crmProduct.skuRestrctionFound=true;crmProduct.toolTip=StoreConstants.NOT_SOLD_OLD_STORE_TOOLTIP}$scope.skuRestrctionFound=crmProduct.skuRestrctionFound});if($scope.crmSearchResult.length==1&&$scope.addToCart&&!$scope.skuRestrctionFound){if($scope.isOnlineQuoteSearchBySku){$scope.crmSearchResult[0].quantity=$scope.onlineQuoteResult.items[$scope.onlineQuoteSkuIndex].quantity;$scope.onlineQuoteResult.items[$scope.onlineQuoteSkuIndex].productName=$scope.crmSearchResult[0].name}$scope.addProductFromCrmSearch($scope.crmSearchResult[0])}if($scope.isOnlineQuoteSearchBySku&&$scope.skuRestrctionFound){$scope.onlineQuoteResult.items[$scope.onlineQuoteSkuIndex].isSkuError=true}else{$scope.onlineQuoteResult.items[$scope.onlineQuoteSkuIndex].isSkuError=false}$scope.addToCart=false;$scope.$parent.hideViewLoading();if($scope.isOnlineQuoteSearchBySku){$scope.onlineQuoteSkuIndex+=1;$rootScope.$broadcast(StoreConstants.STORE_ONLINE_QUOTE_SEARCH_BY_ONE_SKU_EVENT)}}).error(function(result){$scope.crmSearchResult=[]})};$scope.resetSkuSearchForm=function(){$scope.crmSearchObject={name:"",sku:"",language:"",mediaType:"",version:"",platform:"",config:""};$scope.crmSearchResult=[]};$scope.updateSkuViewFlag=function(isSkuView){$scope.isSearchBySkuView=isSkuView};$scope.crmSearchAndAdd=function(){$scope.addToCart=true;$scope.crmSearch()};$scope.addProductFromCrmSearch=function(crmProduct){$rootScope.$broadcast(StoreConstants.STORE_CRM_ADD_TO_CART_EVENT,crmProduct)}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SkuSearchService",["$http",function($http){var service={};service.search=function(data){return $http({method:"POST",url:"../productService/search.do",data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("socket",["$rootScope",function($rootScope){var socket;if(typeof pushServiceUrl!="undefined"&&pushServiceUrl!=""){var domain=extractDomain(pushServiceUrl);var options={protocol:"https",hostname:domain,secure:true,port:443,rejectUnauthorized:false};socket=socketCluster.connect(options);socket.on("connect",function(){$rootScope.$broadcast("SOCKET_CONNECTED")});socket.on("error",function(errorObj){$rootScope.$broadcast("SOCKET_ERROR",errorObj)})}return{on:function(eventName,callback){if(typeof socket!=="undefined"){if(!socket.isSubscribed(eventName)){console.log(eventName+" -- Subscribed successfully.");socket.subscribe(eventName).watch(callback)}}},emit:function(eventName,data,callback){if(typeof socket!=="undefined"){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){if(callback){callback.apply(socket,args)}})})}},unsubscribe:function(channelName){if(typeof socket!=="undefined"){socket.unsubscribe(channelName)}},isConnected:function(){if(typeof socket!=="undefined"){return socket.connected}}};function extractDomain(url){var domain;if(url.indexOf("://")>-1){domain=url.split("/")[2]}else{domain=url.split("/")[0]}domain=domain.split(":")[0];return domain}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("StockConstants",{REFRESH_ENTITLEMENT_DETAIL_EVENT:"refreshEntitlementDetail"});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("StockCtrl",["$rootScope","$scope","$filter","$location","$routeParams","StockServices","StockConstants",function($rootScope,$scope,$filter,$location,$routeParams,StockServices,StockConstants){$scope.entitlementId=$routeParams.entitlementId;$scope.webGUID=$routeParams.webGUID;$scope.tabs=[];$scope.isLoadingDownloads=true;$scope.isLoadingAllotments=true;$scope.generalInfo=[];console.log("Query customer entitlements",$scope.webGUID);$rootScope.$on(StockConstants.REFRESH_ENTITLEMENT_DETAIL_EVENT,function(){$scope.loadCustomerEntitlementsDetail();$scope.loadAllotmentList()});$scope.loadCustomerEntitlementsDetail=function(){StockServices.getStockCustomerEntitlements({customerGuid:$scope.webGUID}).success(function(result){console.log("successfully pulled entitlement from stock API");$scope.entitlements=$scope.getGeneralInfoForEntitlementId(result,$scope.entitlementId);$scope.handleTabShown("allotments")}).error(function(error){console.log("error",error);$("#stock").html(error)})};$scope.loadCustomerEntitlementsDetail();$scope.getGeneralInfoForEntitlementId=function(records,eid){var ac=[];angular.forEach(records[0].entitlements,function(rec){if(rec.entitlement_id==eid){ac.push(rec)}});return ac};$scope.handleTabShown=function(tabName){loadTab(tabName)};$scope.loadAllotmentList=function(){StockServices.getAllotmentList({entitlementId:$scope.entitlementId}).success(function(result){$scope.allotmentList=result.allotments;$scope.isLoadingAllotments=false}).error(function(result){$scope.isLoadingAllotments=false})};$scope.loadDownloadList=function(){StockServices.getDownloadList({entitlementId:$scope.entitlementId}).success(function(result){if(result&&result.nb_pages==0){$scope.downloadList=[];$scope.isLoadingDownloads=false}else{$scope.downloadList=result.downloads;$scope.isLoadingDownloads=false}}).error(function(error){$scope.isLoadingDownloads=false})};var loadTab=function(selectedTab){if($scope.tabs.indexOf(selectedTab)!=-1){return}$scope.tabs.push(selectedTab);switch(selectedTab){case"allotments":$scope.loadAllotmentList();break;case"downloads":$scope.loadDownloadList();break}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("StockServices",["$http",function($http){var service={};service.getStockCustomerEntitlements=function(data){return $http({method:"GET",url:"../stockService/getCustomerDetails.do?customerGuid="+data.customerGuid,data:data})};service.getAllotmentList=function(data){return $http({method:"GET",url:"../stockService/getAllotmentList.do?entitlementId="+data.entitlementId,data:data})};service.getDownloadList=function(data){return $http({method:"GET",url:"../stockService/getDownloadList.do?entitlementId="+data.entitlementId,data:data})};service.addLicense=function(data){return $http({method:"POST",url:"../stockService/addLicense.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("StoreCartController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","TrackingService","AppConstants","AppUtils","StoreUtil","StoreConstants","MetadataService","CartValidator",function($scope,$log,$rootScope,$location,$routeParams,$timeout,TrackingService,AppConstants,AppUtils,StoreUtil,StoreConstants,MetadataService,CartValidator){$scope.cart=new Object();$scope.cartItems=[];$scope.storeCartTotal=0;$scope.storeCurrency="USD";$scope.cartMessage={text:"Cart Is Empty",info:true,success:false,error:false};$scope.isCartMessageShow=true;$scope.$on(StoreConstants.STORE_CRM_ADD_TO_CART_EVENT,function(event,crmProduct){$scope.processCartItem(crmProduct);if(crmProduct){$scope.storeCurrency=crmProduct.price.currency}});var stickerStick=$timeout(function(){var s=$(".sticker");var s1=$(".sticker1");if($scope.isFullScreenView){$(".cart-holder").css("width","530px");$(".store-products-panel").css("width","100%");$(".store-product-filter-actions").css("width","auto")}$(window).scroll(function(){var windowpos=$(window).scrollTop();if(windowpos>=100&&windowpos>=$(".sticker").position().top){s.addClass("stick");s1.addClass("stick1");if($scope.isFullScreenView){$(".store-products-panel").css("width","64%");$(".store-product-filter-actions").css("width","63.6%")}else{$(".store-product-filter-actions").css("width","770px")}}else{s.removeClass("stick");s1.removeClass("stick1");if($scope.isFullScreenView){$(".store-products-panel").css("width","100%");$(".store-product-filter-actions").css("width","auto")}else{$(".store-product-filter-actions").css("width","770px")}}})},0);$scope.$on("$destroy",function(){$timeout.cancel(stickerStick)});$scope.processCartItem=function(cartItem){$scope.cartMessage=CartValidator.isCartItemValid($scope.metadata,$scope.cartItems,cartItem);$scope.isCartMessageShow=$scope.isOnlineQuoteCartMessageShow=true;$scope.updateStoreCart()};$scope.removeStoreCartItem=function(cartItemIndex){$scope.cartItems.splice(cartItemIndex,1);$scope.updateStoreCart();$scope.cartMessage=CartValidator.getCartMessage("Cart Item Removed Successfully","success");$scope.isCartMessageShow=true};$scope.updateStoreCart=function(){$scope.cart.items=$scope.cartItems;$scope.storeCartTotal=0;angular.forEach($scope.cartItems,function(cartItem){$scope.storeCartTotal=$scope.storeCartTotal+(cartItem.price.listPrice*cartItem.quantity)});$scope.$parent.updateCart($scope.cart);$timeout(function(){$scope.isCartMessageShow=false},10000)};$scope.resetOnlineQuoteMessage=function(){$scope.isOnlineQuoteCartMessageShow=false};$scope.hideResetCart=function(){$("#resetCartModal").modal("hide")};$scope.showResetCart=function(){$("#resetCartModal").modal("show")};$scope.resetCart=function(){$scope.cartItems=[];$scope.updateStoreCart();$scope.resetOnlineQuoteMessage();$scope.hideResetCart()}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("StoreConstants",{TRANSACTION_NON_SUBSCRIPTION__ORDER:"ZCOR",TRANSACTION_SUBSCRIPTION_ORDER:"ZCSB",TRANSACTION_ORDER:"ORDER",TRANSACTION_QUOTE:"QUOTE",TRANSACTION_FOC:"FOC",TRANSACTION_FOC_WITH_FREE_SHIPPING:"ZCKL",TRANSACTION_FOC_WITH_PAID_SHIPPING:"ZCOR",HARD_GOOD_PRODUCT_TYPE:"HGD",ESD_PRODUCT_TYPE:"ESD",DSP_PRODUCT_TYPE:"DSP",CCM_TEAM_PRODUCT_TYPE:"CCMT",SUB_PRODUCT_TYPE:"SUB",SSP_PRODUCT_TYPE:"SSP",EDUCATIONAL_STORE_TYPE:"EDU",COMMERCIAL_STORE_TYPE:"COM",EDUCATIONAL_STORE_NAME:"Educational",COMMERCIAL_STORE_NAME:"Commercial",COUNTRIES_LOCALE:"US:EN,JA:JP,FR:FR,DE:DE",RECORDS_DEFAULT_COUNTRIES_LANGUAGE:"AD:ES,AE:EN,AF:EN,AG:EN,AI:EN,AL:EN,AM:EN,AN:EN,AO:EN,AQ:EN,AR:ES,AS:EN,AT:DE,AU:EN,AW:EN,AZ:EN,BA:EN,BB:EN,BD:EN,BE:NL,BF:EN,BG:EN,BH:EN,BI:EN,BJ:EN,BM:EN,BN:EN,BO:EN,BR:PT,BS:EN,BT:EN,BV:EN,BW:EN,BY:EN,BZ:EN,CA:EN,CC:EN,CF:EN,CG:EN,CH:DE,CI:EN,CK:EN,CL:ES,CM:EN,CN:EN,CO:ES,CR:EN,CS:EN,CU:EN,CV:EN,CX:EN,CY:EN,CZ:CS,DE:DE,DJ:EN,DK:DA,DM:EN,DO:EN,DZ:EN,EC:EN,EE:EN,EG:EN,EH:EN,ER:EN,ES:ES,ET:EN,FI:FI,FJ:EN,FK:EN,FM:EN,FO:DA,FR:FR,FX:FR,GA:EN,GB:EN,GD:EN,GE:EN,GF:FR,GH:EN,GI:EN,GL:EN,GM:EN,GN:EN,GP:EN,GQ:EN,GR:EN,GS:EN,GT:EN,GU:EN,GW:EN,GY:EN,HK:EN,HM:EN,HN:EN,HR:EN,HT:EN,HU:EN,ID:EN,IE:EN,IL:HE,IM:EN,IN:EN,IO:EN,IQ:EN,IR:EN,IS:EN,IT:IT,JM:EN,JO:EN,JP:JA,KE:EN,KG:EN,KH:EN,KI:EN,KM:EN,KN:EN,KP:EN,KR:EN,KV:EN,KW:EN,KY:EN,KZ:EN,LA:EN,LB:EN,LC:EN,LI:DE,LK:EN,LR:EN,LS:EN,LT:EN,LU:FR,LV:EN,LY:EN,MA:FR,MC:FR,MD:EN,ME:EN,MG:EN,MH:EN,MK:EN,ML:EN,MM:EN,MN:EN,MO:EN,MP:EN,MQ:EN,MR:EN,MS:EN,MT:EN,MU:EN,MV:EN,MW:EN,MX:ES,MY:EN,MZ:EN,NA:EN,NC:EN,NE:EN,NF:EN,NG:EN,NI:EN,NL:NL,NO:NO,NP:EN,NR:EN,NU:EN,NZ:EN,OM:EN,PA:EN,PE:ES,PF:FR,PG:EN,PH:EN,PK:EN,PL:PL,PM:EN,PN:EN,PR:EN,PS:EN,PT:PT,PW:EN,PY:EN,QA:EN,RE:EN,RO:EN,RS:EN,RU:RU,RW:EN,SA:EN,SB:EN,SC:EN,SD:EN,SE:SV,SG:EN,SH:EN,SI:EN,SJ:EN,SK:CZ,SL:EN,SM:IT,SN:EN,SO:EN,SR:EN,SS:EN,ST:EN,SV:EN,SY:EN,SZ:EN,TC:EN,TD:EN,TF:FR,TG:EN,TH:EN,TJ:EN,TK:EN,TL:EN,TM:EN,TN:EN,TO:EN,TP:EN,TR:TR,TT:EN,TV:EN,TW:EN,TZ:EN,UA:RU,UG:EN,UM:EN,US:EN,UY:EN,UZ:EN,VA:IT,VC:EN,VE:EN,VG:EN,VI:EN,VN:EN,VU:EN,WF:EN,WS:EN,XM:EN,YE:EN,YT:EN,YU:EN,ZA:EN,ZM:EN,ZR:EN,ZW:EN",STORE_INVOKE_CATALOG_EVENT:"STORE_INVOKE_CATALOG_EVENT",STORE_CATALOG_ADD_TO_CART_EVENT:"STORE_CATALOG_ADD_TO_CART_EVENT",STORE_SKU_SEARCH_FROM_URL_EVENT:"STORE_SKU_SEARCH_FROM_URL_EVENT",STORE_SELECT_CUSTOMER_FROM_URL_EVENT:"STORE_SELECT_CUSTOMER_FROM_URL_EVENT",STORE_CRM_ADD_TO_CART_EVENT:"STORE_CRM_ADD_TO_CART_EVENT",STORE_SELECT_CUSTOMER_EVENT:"STORE_SELECT_CUSTOMER_EVENT",STORE_CREATE_NEW_CUSTOMER_EVENT:"STORE_CREATE_NEW_CUSTOMER_EVENT",STORE_ADDRESS_VALIDATION_UPDATE_EVENT:"STORE_ADDRESS_VALIDATION_UPDATE_EVENT",STORE_PAYMENT_INITIALIZE_EVENT:"STORE_PAYMENT_INITIALIZE_EVENT",STORE_PAYMENT_REVIEW_EVENT:"STORE_PAYMENT_REVIEW_EVENT",STORE_UPDATE_DELIVERY_METHOD_EVENT:"STORE_UPDATE_DELIVERY_METHOD_EVENT",STORE_ORDER_PLACEMENT_EVENT:"STORE_ORDER_PLACEMENT_EVENT",STORE_ADD_PRODUCTS_EVENT:"STORE_ADD_PRODUCTS_EVENT",STORE_QUOTE_TO_ORDER_EVENT:"STORE_QUOTE_TO_ORDER_EVENT",STORE_ONLINE_QUOTE_EVENT:"STORE_ONLINE_QUOTE_EVENT",STORE_ONLINE_QUOTE_SKU_SEARCH_EVENT:"STORE_ONLINE_QUOTE_SKU_SEARCH_EVENT",STORE_ONLINE_QUOTE_SEARCH_BY_ONE_SKU_EVENT:"STORE_ONLINE_QUOTE_SEARCH_BY_ONE_SKU_EVENT",STORE_SELECT_DELIVERY_METHOD_EVENT:"STORE_SELECT_DELIVERY_METHOD_EVENT",UPDATE_DELIVERY_METHOD_TO_TRANSACTION_EVENT:"STORE_SELECT_DELIVERY_METHOD_EVENT",LOAD_DELIVERY_METHOD_FOR_REGION:"LOAD_DELIVERY_METHOD_FOR_REGION",STORE_CREATE_NEW_CUSTOMER_UPDATE_EVENT:"STORE_CREATE_NEW_CUSTOMER_UPDATE_EVENT",STORE_CUSTOMER_IN_URL_IS_VALID:"STORE_CUSTOMER_IN_URL_IS_VALID",QUOTE_UPDATE_DELIVERY_DETAIL:"QUOTE_UPDATE_DELIVERY_DETAIL",PROMO_CODE_APPLIED_ON_LINE_ITEM:"PROMO_CODE_APPLIED_ON_LINE_ITEM",PROMO_CODE_REMOVED_ON_LINE_ITEM:"PROMO_CODE_REMOVED_ON_LINE_ITEM",NOT_SOLD_TOOLTIP:"This product cannot be sold to the customers country.",NOT_SOLD_OLD_STORE_TOOLTIP:"This product cannot be sold on this store ,please try new FMF store",HARDGOOD_NOT_SOLD_TOOLTIP:"This hardgood product cannot be sold to the customers country.",SKU_NOT_SOLD_TOOLTIP:"This SKU is not sellable through Hendrix",COMMERCIAL_SKU_NOT_VALID_TOOLTIP:"This is commercial SKU and is not sellable in educational store",EDUCATIONAL_SKU_NOT_VALID_TOOLTIP:"This is educational SKU and is not sellable in commercial store",WIZARD_PRODUCT_PROCESS:1,WIZARD_CUSTOMER_PROCESS:2,WIZARD_CUSTOMER_DETAILS_PROCESS:3,WIZARD_PAYMENT_PROCESS:4,WIZARD_TERMS_AND_CONDITIONS_PROCESS:5,WIZARD_ORDER_PLACEMENT_PROCESS:6,WIZARD_ADD_PRODUCTS_PROCESS:7,WIZARD_ADD_PAYER_PROCESS:8,PO_PAYMENT_TYPE:9,ADOBE_STOCK_PRODUCT_CODES:"STKS, STKL, CISK, CTSK, STOK",WIZARD_DELIVERY_METHOD_PROCESS:10,SKU_FILTER_DISTRIBUTION_METHOD:"DistributionMethod",SKU_FILTER_FULFILLMENT_METHOD:"FullfillmentMethod",SKU_FILTER_TERM_TYPE:"PlanType",SKU_FILTER_BY_SKU:"SKU",DISABLE_CCMI_ELIGIBILITY_CHECK_FOR_SMALL_ANNUAL_STOCK:true,ECOM_SKU_DATA_API_URL:"https://store1.adobe.com/svcs/products",ECOM_SKU_DATA_API_URL_IN_STAGE:"https://store1.stage.adobe.com/svcs/products",ECOM_SKU_DETAILS_API_URL:"https://store1.adobe.com/svcs/sellableitems/",ECOM_SKU_DETAILS_API_URL_IN_STAGE:"https://store1.stage.adobe.com/svcs/sellableitems/"});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("StoreController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","AppConstants","AppUtils","StoreUtil","OrderUtils","StoreConstants","Utils","PaymentConstants","MetadataService","StoreShortcutsService","StoreCustomerService","StoreTransactionService","$sce","SFDCService","$q","SFDCUtil","SFDCConstants",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,AppConstants,AppUtils,StoreUtil,OrderUtils,StoreConstants,Utils,PaymentConstants,MetadataService,StoreShortcutsService,StoreCustomerService,StoreTransactionService,$sce,SFDCService,$q,SFDCUtil,SFDCConstants){TrackingService.trackPageView("Store","Store View");Utils.pageTitle("Store");$scope.StoreConstants=StoreConstants;$scope.isStoreValid=false;$scope.isCreateQuote=false;$scope.isCreateOrder=true;$scope.isOnlyOneCustomerFound=false;$scope.isSkuSearchView=false;$scope.isCustomerHasContract=false;$scope.isZcorProductFound=false;$scope.isPaymentValid=false;$scope.isTermsAndConditionsAccepted=false;$scope.isQuoteToOrder=false;$scope.adobeStockTnC="";$scope.marketingAttributesEdit=false;$scope.isFOCOrderWithFreeShipping=false;$scope.isFOCOrderWithPaidShipping=false;$scope.isOnlineQuoteValid=false;$scope.isOnlineQuoteServiceLoading=false;$scope.isCustomerLocked=false;$scope.isCustomerAddressEmpty=false;$scope.customerLockedText;$scope.isAdobeStock=false;$scope.isDylan=false;$scope.disableAddProductToCustomerBtn=false;$scope.sellableInCustomerCountry;$scope.gid=$routeParams.gid;$scope.serialNumberForCase=$routeParams.serialNumber;$scope.isFOCwithPaidShippingEnable=true;$scope.enableDeliveryDetailUpdate=true;var timer;$scope.dbStatus=MetadataService.DB_STATUS.NEW;$scope.wizardStep=StoreConstants.WIZARD_PRODUCT_PROCESS;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.currentStore={countryCode:"US",countryName:"United States",key:"S051",regionId:"NA",storeName:"US",crmStoreName:"CRM-US",storeType:"COM",storeTypeName:"Commercial"};$scope.loadingMessage="Loading";$scope.quoteLoadingMessage="Loading";$scope.reviewCheckoutErrorMessage="";$scope.metadata=new Object();$scope.storeDeliveryMethodDetail;$scope.setStoreType;$scope.storeCart;$scope.selectedCustomer;$scope.selectedCustomerDetails=new Object();$scope.paymentDetails;$scope.termsAndConditionsDetails;$scope.customerContractDetailMessage;$scope.customerCreationStatusMessage;$scope.storeTransaction=new Object();$scope.storeTransactionResult=new Object();$scope.storeTransactionReviewResult=new Object();$scope.quoteTransaction;$scope.transactionAddress=new Object();$scope.transactionAddress.transactionOnly=false;$scope.cartHasItems=false;$scope.storeName=angular.lowercase($routeParams.storeName);$scope.quoteId=angular.lowercase($routeParams.quoteId);$scope.storeType=angular.lowercase($routeParams.type);$scope.customerId=angular.lowercase($routeParams.customer);$scope.isCustomerInUrlValid=$scope.customerId?true:false;$scope.sku=angular.lowercase($routeParams.sku);$scope.addToCart=angular.lowercase($routeParams.addToCart)=="true"?true:false;$scope.dylan=angular.lowercase($routeParams.dylan)=="true"?true:false;$scope.isDylan=$scope.dylan;$scope.onlineQuoteId=$routeParams.onlinequote;$scope.onlineQuoteResult;$scope.onlineQuoteMessage="";$scope.isSFDCFLow=angular.isDefined($routeParams.asynchId)&&$routeParams.asynchId.length>0?true:false;$scope.isSFDCCustomerNew=angular.isDefined($routeParams.isNewCustomer)&&$routeParams.isNewCustomer=="true"?true:false;$scope.sfdcCustomerAddress;$scope.saccountID=$routeParams.saccountID;$scope.scontactID=$routeParams.scontactID;$scope.sopportunityID=$routeParams.sopportunityID;$scope.asynchId=$routeParams.asynchId;if($scope.isSFDCFLow){$scope.catalogFilter="team";AppUtils.sendLogToServer("SFDC:Catalog flow loaded for SFDC opportunity: "+$scope.sopportunityID+",accountId:"+$scope.saccountID+",contactID:"+$scope.scontactID+",asynchId:"+$scope.asynchId)}$scope.jpBannerText="<p><span>2015年10月1日以降のご請求分から消費税が課税されます。 </span><span><a target='_blank' href='https://www.adobe.com/go/jptax2015' class='alert-link'><span>詳しくはこちらから。</span></a></span></p>";$scope.jpBannerFilteredText=$sce.trustAsHtml($scope.jpBannerText);if(angular.lowercase($routeParams.addToCartBySku)){$scope.sku=angular.lowercase($routeParams.addToCartBySku);$scope.addToCart=true}$scope.loadSFDCDetail=function(){var accountQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_ACCOUNT_QUERY,$routeParams.saccountID);var contactQuery=SFDCUtil.getQuery(SFDCConstants.SFDC_CONTACT_QUERY,$routeParams.scontactID);var parallelCalls=[];parallelCalls.push(SFDCService.loadAccount({accountQuery:accountQuery}).success(function(result){$scope.accountDetails=result.records[0];AppUtils.sendLogToServer("SFDC:Catalog flow:: account loaded: "+$routeParams.saccountID)}).error(function(error){$scope.isLoadingAccount=false}));parallelCalls.push(SFDCService.loadContact({contactQuery:contactQuery}).success(function(result){$scope.contactDetails=result.records[0];$scope.isHendrixAccountLoading=true;AppUtils.sendLogToServer("SFDC:Catalog flow:: contact loaded: "+$routeParams.scontactID)}).error(function(error){$scope.isLoadingContact=false}));$q.all(parallelCalls).then(function(value){$scope.sfdcCustomerAddress=SFDCUtil.getCustomerDto($scope.accountDetails,$scope.contactDetails,null);AppUtils.sendLogToServer("SFDC:Catalog flow:: SFDC detail loaded for opportunity and contact "+$routeParams.scontactID)},function(reason){console.log("All call fail");AppUtils.sendLogToServer("SFDC:Catalog flow:: load contact and account detail error ")})};if($scope.isSFDCFLow){$scope.loadSFDCDetail()}Utils.pageTitle("Store [ "+angular.uppercase($scope.storeName)+" ]");if($scope.storeType){if($scope.storeType=="edu"){$location.url("/store/"+$scope.storeName+"-"+$scope.storeType);return}else{$location.url("/store/"+$scope.storeName);return}}$scope.catalogProductCount=0;$scope.jemOrderDto;$scope.JemProductSaveMessages=[];$scope.initiateOrder=function(){$scope.isFOCOrderWithFreeShipping=false;$scope.isFOCOrderWithPaidShipping=false;if($scope.storeTransaction&&$scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType){$scope.storeTransaction.paymentDetails.paymentType=""}$scope.marketingAttributesEdit=true;$scope.isCreateOrder=true;$scope.isCreateQuote=false;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.goToCustomer()};$scope.initiateQuote=function(){if($scope.storeTransaction&&$scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType){$scope.storeTransaction.paymentDetails.paymentType=""}$scope.isFOCOrderWithFreeShipping=false;$scope.isFOCOrderWithPaidShipping=false;$scope.isCreateOrder=false;$scope.isCreateQuote=true;$scope.salesTransactonType=StoreConstants.TRANSACTION_QUOTE;$scope.goToCustomer()};$scope.initiateFOCWithPaidShipping=function(){if($scope.storeTransaction&&$scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType){$scope.storeTransaction.paymentDetails.paymentType=""}$scope.isCreateOrder=false;$scope.isCreateQuote=false;$scope.isFOCOrderWithFreeShipping=false;$scope.isFOCOrderWithPaidShipping=true;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.goToCustomer()};$scope.initiateFOCWithFreeShipping=function(){if($scope.storeTransaction&&$scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType){$scope.storeTransaction.paymentDetails.paymentType=""}$scope.isCreateOrder=false;$scope.isCreateQuote=false;$scope.isFOCOrderWithPaidShipping=false;$scope.isFOCOrderWithFreeShipping=true;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.goToCustomer()};$scope.goToCustomer=function(){$scope.wizardStep=$scope.isCustomerInUrlValid?StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS:StoreConstants.WIZARD_CUSTOMER_PROCESS;if($scope.isSFDCCustomerNew){$scope.selectedCustomerDetails.address=$scope.sfdcCustomerAddress.address}if($scope.selectedCustomerDetails&&($scope.selectedCustomerDetails.enterpriseId||$scope.selectedCustomerDetails.bpType=="2")){$("#orgModal").modal("show")}if($scope.isCustomerInUrlValid){$scope.$broadcast(StoreConstants.STORE_CUSTOMER_IN_URL_IS_VALID,$scope.selectedCustomerDetails)}};$scope.showModalsForCustomerInUrl=function(){if($scope.selectedCustomerDetails&&($scope.selectedCustomerDetails.enterpriseId||$scope.selectedCustomerDetails.bpType=="2")){$("#orgModal").modal("show")}if($scope.selectedCustomerDetails&&$scope.selectedCustomerDetails.address&&$scope.selectedCustomerDetails.address.country){var userCountry=$scope.selectedCustomerDetails.address.country;$scope.countryMismatch="Country Of The Customer Does Not Match With The Current Store. Do You Want To Change Store Or Customer?";if(userCountry.code&&userCountry.code.toLowerCase()!=$scope.currentStore.countryCode.toLowerCase()){var customerCountryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,userCountry.code);if(!customerCountryMetadata.selling){$scope.sellableInCustomerCountry=false;$scope.countryMismatch="Customer belongs to Digital River store. Please go to customer details and launch DR store."}else{$scope.sellableInCustomerCountry=true}$("#countryMismatchModal").modal("show")}}};$scope.closeOrgModal=function(){$("#orgModal").modal("hide");$scope.wizardStep=StoreConstants.WIZARD_PRODUCT_PROCESS};$scope.closeCountryMismatchAndChangeCustomer=function(){$location.path("/store/"+$scope.storeName);$location.search("");$location.reload()};$scope.closeCountryMismatchAndChangeStore=function(customerId){$location.path("/store/"+$scope.selectedCustomerDetails.address.country.code.toLowerCase());$location.search("customer",customerId);$location.reload()};$scope.closeCountryMismatchAndOpenCustomer=function(customerId){$location.url("/customer/"+customerId);return};$scope.toggleSkuSearchView=function(){$scope.isSkuSearchView=!$scope.isSkuSearchView};$scope.updateCart=function(cart){if(cart.items.length>0){$scope.cartHasItems=true}else{$scope.cartHasItems=false}$scope.storeCart=cart;$scope.isZcorProductFound=StoreUtil.isOnlyHavingZcor(cart.items);$scope.isOnlyHardGoodProductFound=StoreUtil.isOnlyHavingHardGood(cart.items);$scope.deliveryMethodShouldBeEnable=StoreUtil.deliveryMethodShouldEnable(cart.items);$scope.isFOCwithPaidShippingEnable=StoreUtil.isOnlyHavingHDGProductInCart(cart.items);$scope.isStock=StoreUtil.isOnlyHavingStock(cart.items);$scope.isCCMT=StoreUtil.isCcmTeam(cart.items);$scope.isOnlyCCMT=StoreUtil.isOnlyHavingCCMT(cart.items);$scope.isAllowedOnlyWithCcmt=StoreUtil.isAllowedOnlyWithCcmt(cart.items);$scope.isCCMIProductFound=StoreUtil.isOnlyCCMI(cart.items);$scope.isDSPProducFound=StoreUtil.isDSPProductFound(cart.items);$scope.isSAWithStockRestrcition=StoreUtil.SAWithStockRestriction(cart.items);$scope.hasAdobeStockSmallOrLargeDSP=StoreUtil.hasAdobeStockSmallOrLageDSP(cart.items);$scope.isCreateNewCustomerAllowed=StoreUtil.isCreateNewCustomerAllowed(cart.items);$scope.isAdobeStock=StoreUtil.isAdobeStock(cart.items)};$scope.goNextFromSelectCustomer=function(){$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS};$scope.goBackFromSelectCustomer=function(){$scope.wizardStep=StoreConstants.WIZARD_PRODUCT_PROCESS};$scope.updateSelectedCustomer=function(customer){$scope.selectedCustomer=angular.copy(customer)};$scope.goNextToPayment=function(){$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS};$scope.goNextToOrderPlacement=function(){if($scope.isFOCOrderWithFreeShipping){$scope.isPlaceOrderButtonEnabled=true}$scope.wizardStep=StoreConstants.WIZARD_ORDER_PLACEMENT_PROCESS};$scope.goBackFromCustomerDetail=function(){$scope.wizardStep=$scope.isCustomerInUrlValid?StoreConstants.WIZARD_PRODUCT_PROCESS:StoreConstants.WIZARD_CUSTOMER_PROCESS};$scope.updateSelectedCustomerDetails=function(customerDetails){$scope.selectedCustomerDetails=angular.copy(customerDetails);$rootScope.$broadcast(StoreConstants.STORE_SELECT_CUSTOMER_EVENT,customerDetails)};$scope.updateCustomerLockInformation=function(customerLockInfo){if(customerLockInfo&&customerLockInfo.length>0&&customerLockInfo[0].type=="E"&&customerLockInfo[0].number=="38"){$scope.isCustomerLocked=true;$scope.customerLockedText=customerLockInfo[0].text}else{$scope.isCustomerLocked=false;$scope.customerLockedText=""}};$scope.goToNextFromDeliveryMethod=function(){$scope.setDeliveryEnableStatus(true);if($scope.isFOCOrderWithFreeShipping){$scope.isPlaceOrderButtonEnabled=true}$rootScope.$broadcast(StoreConstants.STORE_UPDATE_DELIVERY_METHOD_EVENT)};$scope.getDeliveryEnableStatus=function(){return $scope.enableDeliveryDetailUpdate};$scope.setDeliveryEnableStatus=function(val){$scope.enableDeliveryDetailUpdate=val};$scope.goNextFromPayment=function(){if($scope.isQuoteToOrder&&$scope.storeTransaction&&$scope.storeTransaction.transactionType==StoreConstants.TRANSACTION_NON_SUBSCRIPTION__ORDER){$scope.isZcorProductFound=true}if($scope.isZcorProductFound){$scope.isPlaceOrderButtonEnabled=true;$scope.wizardStep=StoreConstants.WIZARD_ORDER_PLACEMENT_PROCESS}else{if($scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){$scope.wizardStep=StoreConstants.WIZARD_ADD_PAYER_PROCESS}else{$scope.isPlaceOrderButtonEnabled=false;$scope.wizardStep=StoreConstants.WIZARD_TERMS_AND_CONDITIONS_PROCESS}}};$scope.goBackFromPaymentDetail=function(){if($scope.deliveryMethodShouldBeEnable&&$scope.isCreateOrder){$scope.wizardStep=StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS}else{if($scope.deliveryMethodShouldBeEnable&&$scope.isFOCOrderWithPaidShipping){$scope.wizardStep=StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS}else{$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS}}};$scope.getStoreTransaction=function(){return $scope.storeTransaction};$scope.updateStoreTransaction=function(transaction){$scope.storeTransaction=angular.copy(transaction);$scope.storeTransaction.goCartID=$scope.gid;if($scope.transactionAddress.billingAddress){$scope.storeTransaction.billingAddress=$scope.transactionAddress.billingAddress;if(!$scope.transactionAddress.transactionOnly){$scope.storeTransaction.customer.billingAddress=$scope.transactionAddress.billingAddress}$scope.storeTransaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeTransaction.billingAddress.country.code,$scope.storeTransaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.storeTransaction.billingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeTransaction.billingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.transactionAddress.shippingAddress){$scope.storeTransaction.shippingAddress=$scope.transactionAddress.shippingAddress;if(!$scope.transactionAddress.transactionOnly){$scope.storeTransaction.customer.shippingAddress=$scope.transactionAddress.shippingAddress}$scope.storeTransaction.shippingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeTransaction.shippingAddress.country.code,$scope.storeTransaction.shippingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.storeTransaction.shippingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeTransaction.shippingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeTransaction.billingAddress){$scope.storeTransaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeTransaction.billingAddress.country.code,$scope.storeTransaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}StoreUtil.updateTransactionFlags($scope.storeTransaction);angular.forEach($scope.storeTransaction.items,function(product){product.productImg=AppUtils.getProductThumbnailImageFromCrmDescription(product.productName);product.newProductName=AppUtils.getProductNameFromCrmProductName(product.productName)});$scope.storeTransaction.description=StoreUtil.getUpdateDescription($scope.currentStore,transaction)};$scope.updateOrderReason=function(orderReason){$scope.storeTransaction.reason.code=orderReason};$scope.updateCustomerTransactionBillingAddress=function(customerAddress,isBilling){$scope.transactionAddress.transactionOnly=false;if(customerAddress&&isBilling){$scope.transactionAddress.billingAddress=customerAddress}else{if(customerAddress&&!isBilling){$scope.transactionAddress.shippingAddress=customerAddress}}};$scope.updateTransactionBillingAddress=function(customerAddress,isBilling){$scope.transactionAddress.transactionOnly=true;if(customerAddress&&isBilling){$scope.transactionAddress.billingAddress=customerAddress}else{if(customerAddress&&!isBilling){$scope.transactionAddress.shippingAddress=customerAddress}}};$scope.updateTransactionAddressDetails=function(customerAddress){$scope.transactionAddress.billingAddress=$scope.transactionAddress.shippingAddress=customerAddress};$scope.setDeliveryMethod=function(){$rootScope.$broadcast(StoreConstants.STORE_SELECT_DELIVERY_METHOD_EVENT)};$scope.reviewPayment=function(){$scope.updateStoreTransactionWithPayment();$rootScope.$broadcast(StoreConstants.STORE_PAYMENT_REVIEW_EVENT)};$scope.transactionReviewUpdate=function(transaction){$scope.storeTransactionReviewResult=transaction};$scope.updatePaymentDetails=function(isPaymentValid,paymentDetails,isCreditCardOnFile){$scope.isPaymentValid=isPaymentValid;$scope.paymentDetails=angular.copy(paymentDetails);if(isPaymentValid&&isCreditCardOnFile){$scope.reviewPayment()}};$scope.updateStoreTransactionWithPayment=function(){$scope.storeTransaction.paymentDetails=angular.copy($scope.paymentDetails);if($scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.storeTransaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}};$scope.updateTermsAndConditionsText=function(termsAndConditionsContent){$scope.storeTransaction.termsAndConditionsContent=termsAndConditionsContent;$scope.adobeStockTnC=termsAndConditionsContent;$scope.goNextFromPayment()};$scope.goNextFromTermsAndConditions=function(){$scope.isPlaceOrderButtonEnabled=true;$scope.finalUpdateTransaction();$scope.wizardStep=StoreConstants.WIZARD_ORDER_PLACEMENT_PROCESS;$scope.validatePlaceOrderButton()};$scope.updateStoreTransactionWithPayment=function(){$scope.storeTransaction.paymentDetails=angular.copy($scope.paymentDetails);if($scope.storeTransaction.paymentDetails&&$scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){$scope.cardTypeName=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],$scope.storeTransaction.paymentDetails.cardType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}};$scope.goNextFromTermsAndConditions=function(){$scope.isPlaceOrderButtonEnabled=true;$scope.finalUpdateTransaction();$scope.wizardStep=StoreConstants.WIZARD_ORDER_PLACEMENT_PROCESS;$scope.validatePlaceOrderButton()};$scope.goBackFromTnC=function(){if($scope.storeTransaction&&$scope.storeTransaction.paymentDetails&&($scope.storeTransaction.paymentDetails.paymentType==9)){$scope.wizardStep=StoreConstants.WIZARD_ADD_PAYER_PROCESS}else{$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS}};$scope.updateTermsAndConditions=function(status,termsAndConditions){$scope.isTermsAndConditionsAccepted=status;$scope.termsAndConditionsDetails=angular.copy(termsAndConditions)};$scope.goBackFromReviewCheckout=function(){if($scope.isCreateQuote&&!$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS}else{if($scope.isCreateQuote&&$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS}else{if($scope.isZcorProductFound&&!$scope.isFOCOrderWithFreeShipping&&!$scope.isFOCOrderWithPaidShipping){$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS}else{if($scope.isFOCOrderWithFreeShipping&&$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS}else{if($scope.isFOCOrderWithPaidShipping&&$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS}else{if($scope.isFOCOrderWithFreeShipping&&!$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS}else{if($scope.isFOCOrderWithPaidShipping&&!$scope.deliveryMethodShouldBeEnable){$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS}else{$scope.wizardStep=StoreConstants.WIZARD_TERMS_AND_CONDITIONS_PROCESS}}}}}}}};$scope.placeNewOrder=function(){$rootScope.$broadcast(StoreConstants.STORE_ORDER_PLACEMENT_EVENT)};$scope.updateSFDCOpportunityDetail=function(isOrder,message){var messageObject={Source_System:SFDCConstants.SOURCE_SYSTEM_SFDC};if($scope.isSFDCFLow){if(isOrder){if(angular.isDefined($scope.storeTransactionResult.transactionNumber)&&$scope.storeTransactionResult.transactionNumber.length>0){SFDCService.updateSFDCOpportunityDetail({oppID:$scope.sopportunityID,process:"AbdApi.UpdateOpportunity",message:$scope.storeTransactionResult.messages&&$scope.storeTransactionResult.messages.length>=0?$scope.storeTransactionResult.messages[0].text:"",order:{orderId:$scope.storeTransactionResult.transactionNumber,asynchId:$scope.asynchId}}).success(function(result,status,headers,config){messageObject.Functionality="Update Opportunity - New Order";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=result.message;messageObject.info=message;messageObject.transaction=$scope.storeTransactionResult.transactionNumber;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){messageObject.Functionality="Update Opportunity - New Order";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message="Error on service :"+error.toString();messageObject.info=message;AppUtils.sendLogToServer(messageObject)})}else{messageObject.Functionality="Opportunity Conversion issue (old sales flow)-  place order not successful(transaction number not generated)";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="SAP CRM order not processed";messageObject.message=message;messageObject.info="fail";AppUtils.sendLogToServer(messageObject)}}else{SFDCService.updateSFDCOpportunityDetail({oppID:$scope.sopportunityID,process:"AbdApi.UpdateOpportunity",message:message,order:{orderId:"",asynchId:$scope.asynchId}}).success(function(result,status,headers,config){messageObject.Functionality="Update Opportunity - Add Product";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=result.message;messageObject.info=message;AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){messageObject.Functionality="Update Opportunity - Add Product";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;messageObject.opportunityID=$scope.sopportunityID;messageObject.process="AbdApi.UpdateOpportunity";messageObject.message=error.toString();messageObject.info=message;AppUtils.sendLogToServer(messageObject,status,headers,config)})}}};$scope.placeOrderComplete=function(transaction){$scope.storeTransactionResult=angular.copy(transaction);var transactionType=$scope.isCreateQuote?"Quote":"Order";var stockVarOmniture="",numberOfSeats=0;for(var count=0;count<$scope.storeTransactionResult.items.length;count++){numberOfSeats=numberOfSeats+Number($scope.storeTransactionResult.items[count].quantity);if($scope.storeTransactionResult.items[count].stockSku){stockVarOmniture="Stock "}}$scope.updateSFDCOpportunityDetail(true);var purchaseTypeStr=$scope.isOnlineQuoteValid?"Initial Purchase (Online Quote Id -"+$scope.onlineQuoteId+"): "+stockVarOmniture+transactionType:"Initial Purchase: "+stockVarOmniture+transactionType;if($scope.storeTransactionResult.transactionNumber){if(AppUtils.isHavingErrorMessage(transaction.messages)){if($scope.isSFDCFLow){AppUtils.sendLogToServer("SFDC Flow,"+purchaseTypeStr+" Placed Successfully With Errors, Transaction Number - "+$scope.storeTransactionResult.transactionNumber+", Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo+", Total Seats - "+numberOfSeats)}$scope.orderStatusMessage=transactionType+" created with errors - please review. ";TrackingService.trackPageView("Store","Store: "+stockVarOmniture+transactionType+" Success With Errors: "+$scope.currentStore.countryName);AppUtils.sendLogToServer(purchaseTypeStr+" Placed Successfully With Errors, Transaction Number - "+$scope.storeTransactionResult.transactionNumber+", Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo+", Total Seats - "+numberOfSeats)}else{if($scope.isSFDCFLow){AppUtils.sendLogToServer("SFDC Flow,"+purchaseTypeStr+" Placed Successfully, Transaction Number - "+$scope.storeTransactionResult.transactionNumber+", Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo+", Total Seats - "+numberOfSeats)}$scope.orderStatusMessage=transactionType+" Placed Successfully. ";TrackingService.trackPageView("Store","Store: "+stockVarOmniture+transactionType+" Success: "+$scope.currentStore.countryName);AppUtils.sendLogToServer(purchaseTypeStr+" Placed Successfully, Transaction Number - "+$scope.storeTransactionResult.transactionNumber+", Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo+", Total Seats - "+numberOfSeats)}}else{if($scope.isSFDCFLow){AppUtils.sendLogToServer("SFDC Flow,"+purchaseTypeStr+" Not Placed Successfully, Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo)}$scope.orderStatusMessage=transactionType+" Not Placed Successfully. ";TrackingService.trackPageView("Store","Store: "+stockVarOmniture+transactionType+" Failed: "+$scope.currentStore.countryName);AppUtils.sendLogToServer(purchaseTypeStr+" Not Placed Successfully, Store Name - "+$scope.currentStore.countryName+", Customer Id - "+$scope.storeTransactionResult.customer.customerNo)}};$scope.validatePlaceOrderButton=function(){if($scope.storeTransaction&&$scope.storeTransaction.isCcmTeamTransaction&&$scope.isCreateOrder){if(!angular.isDefined($scope.storeTransaction.teamName)||$scope.storeTransaction.teamName==null||$scope.storeTransaction.teamName==""){$scope.isPlaceOrderButtonEnabled=false;$scope.reviewCheckoutErrorMessage="Team Name Is Required"}else{if((!angular.isDefined($scope.storeTransaction.billingAddress.email)||$scope.storeTransaction.billingAddress.email==null||$scope.storeTransaction.billingAddress.email=="")&&$scope.storeTransaction.paymentDetails.paymentType==StoreConstants.PO_PAYMENT_TYPE){$scope.isPlaceOrderButtonEnabled=false}else{$scope.isPlaceOrderButtonEnabled=true;$scope.reviewCheckoutErrorMessage=""}}}else{if($scope.isCreateQuote){$scope.isPlaceOrderButtonEnabled=true;$scope.reviewCheckoutErrorMessage=""}else{$scope.reviewCheckoutErrorMessage=""}}};$scope.goBackFromAddProduct=function(){$scope.wizardStep=StoreConstants.WIZARD_PRODUCT_PROCESS};$scope.goNextFromPayer=function(){$scope.wizardStep=StoreConstants.WIZARD_TERMS_AND_CONDITIONS_PROCESS};$scope.goBackFromPayer=function(){$scope.wizardStep=StoreConstants.WIZARD_PAYMENT_PROCESS};$scope.updatePayerDetail=function(payer){$scope.storeTransaction.payerAddress=angular.copy(payer);$scope.storeTransaction.payerAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeTransaction.payerAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);$scope.storeTransaction.payerAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeTransaction.payerAddress.country.code,$scope.storeTransaction.payerAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)};$scope.setWizardStep=function(step){if($scope.wizardStep>step){$scope.wizardStep=step}else{if(($scope.wizardStep==StoreConstants.WIZARD_PAYMENT_PROCESS||$scope.wizardStep==StoreConstants.WIZARD_ORDER_PLACEMENT_PROCESS)&&step==StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS){$scope.wizardStep=step}}};$scope.goToWizardStep=function(step){$scope.wizardStep=step};$scope.finalUpdateTransaction=function(){$scope.storeTransaction.paymentDetails=angular.copy($scope.paymentDetails);$scope.storeTransaction.termsAndConditionsList=angular.copy($scope.termsAndConditionsDetails);angular.forEach($scope.storeTransaction.items,function(product){product.productImg=AppUtils.getProductThumbnailImageFromCrmDescription(product.productName);product.newProductName=AppUtils.getProductNameFromCrmProductName(product.productName)});$scope.storeTransaction.goCartID=$scope.gid;StoreUtil.updateTransactionFlags($scope.storeTransaction)};$scope.showViewLoading=function(){$("#view-loading-modal").modal("show")};$scope.hideViewLoading=function(){$("#view-loading-modal").modal("hide")};$scope.showQuoteViewLoading=function(message){$scope.quoteLoadingMessage=message;$("#quote-view-loading-modal").modal("show")};$scope.hideQuoteViewLoading=function(){$scope.quoteLoadingMessage="";$("#quote-view-loading-modal").modal("hide")};$scope.toggleMinimizePanel=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className)};$scope.$watch("storeTransaction.teamName",function(){$scope.validatePlaceOrderButton()},true);$scope.$watch("storeTransaction.billingAddress.email",function(){$scope.validatePlaceOrderButton()},true);$scope.closeOrderStatusModal=function(){$scope.unlockCustomer()};$scope.hideOrderStatusModalDetail=function(){if($scope.storeTransactionResult.transactionNumber){$("#orderStatusModal").modal("hide");$location.path("/store/"+$scope.storeName);$location.search("");window.location.reload()}else{$("#orderStatusModal").modal("hide")}};$scope.unlockCustomer=function(){StoreCustomerService.customerLock({customerNo:$scope.storeTransactionResult.customer.customerNo,flag:"U"}).success(function(result){console.log("Customer unlocked");$scope.hideOrderStatusModalDetail()}).error(function(err){console.log("Customer unlock failed"+err);$scope.hideOrderStatusModalDetail()})};$scope.closeOrderReviewModal=function(){$("#orderStatusModal").modal("hide")};$scope.closeStandAloneCCMTModal=function(){$("#standAloneCCMTModal").modal("hide");$scope.goToWizardStep(StoreConstants.WIZARD_PRODUCT_PROCESS)};$scope.closeCustomerContractModal=function(){$("#customerContractModal").modal("hide");$scope.goToWizardStep(StoreConstants.WIZARD_PRODUCT_PROCESS)};$scope.showCustomerContractModal=function(message){$scope.customerContractDetailMessage=message;$("#customerContractModal").modal("show")};$scope.showResetCustomer=function(){$("#resetCustomerModal").modal("show")};$scope.hideResetCustomer=function(){$("#resetCustomerModal").modal("hide")};$scope.resetCustomer=function(){$scope.wizardStep=StoreConstants.WIZARD_PRODUCT_PROCESS;$scope.selectedCustomerDetails=new Object();$scope.selectedCustomer=new Object();$scope.resetFlag();$scope.hideResetCustomer()};$scope.resetFlag=function(){$scope.isFOCOrderWithFreeShipping=false;$scope.isFOCOrderWithPaidShipping=false;$scope.isCustomerHasContract=false;$scope.isCreateQuote=false;$scope.isCreateOrder=true;$scope.isCustomerInUrlValid=false;$scope.storeTransaction=new Object()};$scope.updateLoadingMessage=function(message){$scope.loadingMessage=message+"..."};$scope.updateCustomerContract=function(val){$scope.isCustomerHasContract=val};$scope.addProductToExistingCustomer=function(){$rootScope.$broadcast(StoreConstants.STORE_ADD_PRODUCTS_EVENT)};$scope.showHideAddProductBtn=function(val){$scope.disableAddProductToCustomerBtn=val};$scope.invokeQuoteTransaction=function(){$scope.isStoreValid=true;Utils.pageTitle("Store [ Quote To Order ]");$scope.updateLoadingMessage("Loading Quote");$scope.showViewLoading();$rootScope.$broadcast(StoreConstants.STORE_QUOTE_TO_ORDER_EVENT)};$scope.updateQuoteTransaction=function(transaction){$scope.quoteTransaction=angular.copy(transaction);if(!StoreUtil.isQuoteTransaction($scope.quoteTransaction.transactionType)){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"This is not a Quote Transaction. Click <a href='#/transaction/"+$scope.quoteTransaction.transactionNumber+"'>"+$scope.quoteTransaction.transactionNumber+"</a> to Open Transaction ");$scope.isStoreValid=false;$scope.hideViewLoading()}else{if(OrderUtils.isTransactionComplete($scope.quoteTransaction.statusLabel)){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_INFO_TYPE,"The Quote To Order Is Already Completed. Click <a href='#/transaction/"+$scope.quoteTransaction.transactionNumber+"'>"+$scope.quoteTransaction.transactionNumber+"</a> to Open Transaction ");$scope.isStoreValid=false;$scope.hideViewLoading()}else{$scope.initializeQuoteToOrderScreen()}}};$scope.initializeQuoteToOrderScreen=function(){$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS;$scope.salesTransactonType=StoreConstants.TRANSACTION_ORDER;$scope.customerId=$scope.quoteTransaction.customer.customerNo;$scope.storeName=$scope.quoteTransaction.customer.address.country.code;$scope.isZcorProductFound=StoreUtil.isOnlyHavingZcorFromQuoteOrder($scope.quoteTransaction.items);$scope.deliveryMethodShouldBeEnable=StoreUtil.deliveryMethodShouldEnableForOrderFlow($scope.quoteTransaction.items);$scope.isOnlyHardGoodProductFound=$scope.deliveryMethodShouldBeEnable;var storeCountry=$scope.storeName.substring(0,2);var storeType=$scope.quoteTransaction.edu?StoreConstants.EDUCATIONAL_STORE_TYPE:StoreConstants.COMMERCIAL_STORE_TYPE;var countryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,storeCountry);var storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,storeCountry,storeType);$scope.currentStore=StoreUtil.getCurrentStoreData($scope.storeName,countryMetadata,storeMetadata);MetadataService.getCountrySpecificInfo({countryCode:$scope.currentStore.countryCode}).success(function(result){$scope.metadata.countrySpecificInfo=result;if($scope.customerId){$rootScope.$broadcast(StoreConstants.STORE_SELECT_CUSTOMER_FROM_URL_EVENT)}})};MetadataService.initializeStoreMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus});$scope.initializeStoreScreen=function(){var storeCountry=$scope.storeName.substring(0,2);var marketSeg=$scope.storeName.indexOf("edu")==3?StoreConstants.EDUCATIONAL_STORE_TYPE:StoreConstants.COMMERCIAL_STORE_TYPE;var storeType=$scope.setStoreType||marketSeg;var countryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,storeCountry);var storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,storeCountry,storeType);if(!storeMetadata){$scope.isStoreValid=false;$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,storeType+" store is not available for this region. Click <a href='#/store/"+storeCountry+"'>"+countryMetadata.name+" commercial</a> to load commercial store. ")}else{$scope.currentStore=StoreUtil.getCurrentStoreData(storeCountry,countryMetadata,storeMetadata);if($scope.isCustomerInUrlValid){$scope.$broadcast(StoreConstants.STORE_SELECT_CUSTOMER_FROM_URL_EVENT,$scope.customerId);$scope.$broadcast(StoreConstants.STORE_CUSTOMER_IN_URL_IS_VALID,$scope.selectedCustomerDetails)}$rootScope.$broadcast(StoreConstants.STORE_INVOKE_CATALOG_EVENT);if($scope.onlineQuoteId){$scope.checkOnlineQuote()}if($scope.sku){$rootScope.$broadcast(StoreConstants.STORE_SKU_SEARCH_FROM_URL_EVENT)}MetadataService.getCountrySpecificInfo({countryCode:$scope.currentStore.countryCode}).success(function(result){$scope.metadata.countrySpecificInfo=result;if($scope.customerId){$rootScope.$broadcast(StoreConstants.STORE_SELECT_CUSTOMER_FROM_URL_EVENT)}});Utils.pageTitle("Store [ "+$scope.currentStore.countryName+" ]");$scope.hideViewLoading()}};$scope.checkOnlineQuote=function(){if($rootScope.onlineQuoteResult&&$scope.onlineQuoteId==$scope.onlineQuoteResult["order-number"]){$scope.updateOnlineQuoteResult($rootScope.onlineQuoteResult);$scope.showQuoteViewLoading("Processing Online Quote, Please wait...");$scope.processOnlineQuote()}else{$scope.showQuoteViewLoading("Finding Online Quote, Please wait...");StoreTransactionService.getOnlineQuote($scope.onlineQuoteId).success(function(result){$scope.hideQuoteViewLoading();if(result&&result.items&&result.items.length>0){AppUtils.sendLogToServer("Online Quote Found in Search: Online Quote ID - "+$scope.onlineQuoteId+", Country - "+result.country);$scope.updateOnlineQuoteResult(result);$scope.processOnlineQuote()}else{AppUtils.sendLogToServer("Online Quote Found With Errors: Online Quote ID - "+$scope.onlineQuoteId+", Country - "+result.country);$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The online quote does not have any products")}}).error(function(){AppUtils.sendLogToServer("Online Quote Search Error: Online Quote ID - "+$scope.onlineQuoteId);$scope.hideQuoteViewLoading();$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"This is not a valid online quote, Please check again...")})}};$scope.processOnlineQuote=function(){if($scope.onlineQuoteResult&&angular.lowercase($scope.onlineQuoteResult.country)==angular.lowercase($scope.currentStore.countryCode)){$rootScope.$broadcast(StoreConstants.STORE_ONLINE_QUOTE_SKU_SEARCH_EVENT)}else{var url="/store/"+angular.lowercase($scope.onlineQuoteResult.country);if($scope.onlineQuoteResult["market-segment"]!=AppConstants.STORE_TYPE_COM){url=url+"-edu"}$location.url(url+"?onlinequote="+$scope.onlineQuoteId);location.reload(true)}};$scope.displayOnlineQuoteDetails=function(){$scope.isOnlineQuoteServiceLoading=true;if(!$rootScope.onlineQuoteResult||$scope.onlineQuoteId!=$rootScope.onlineQuoteResult["order-number"]){StoreTransactionService.getQuoteDetails($scope.onlineQuoteId).success(function(result){$scope.isOnlineQuoteServiceLoading=false;$scope.updateOnlineQuoteResult(result);$scope.isOnlineQuoteCountryValid(result);if(result&&result.items&&result.items.length>0){AppUtils.sendLogToServer("Online Quote Found For Non Supported Country In Hendrix: Online Quote ID - "+$scope.onlineQuoteId+", Country - "+result.country)}else{AppUtils.sendLogToServer("Online Quote Found With Errors For Non Supported Country In Hendrix: Online Quote ID - "+$scope.onlineQuoteId+", Country - "+result.country)}}).error(function(){$scope.isOnlineQuoteServiceLoading=false;AppUtils.sendLogToServer("Online Quote Search Error Non Supported Country In Hendrix : Online Quote ID - "+$scope.onlineQuoteId)})}else{$scope.isOnlineQuoteServiceLoading=false;$scope.updateOnlineQuoteResult($rootScope.onlineQuoteResult);$scope.isOnlineQuoteCountryValid($rootScope.onlineQuoteResult)}};$scope.isOnlineQuoteCountryValid=function(onlineQuoteData){var storeCountryName=onlineQuoteData.country;var storeType=onlineQuoteData["market-segment"]=="COM"?StoreConstants.EDUCATIONAL_STORE_TYPE:StoreConstants.COMMERCIAL_STORE_TYPE;var countryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,storeCountryName);var storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,storeCountryName,storeType);if(countryMetadata){if(countryMetadata.selling&&(storeType==StoreConstants.COMMERCIAL_STORE_TYPE?AppUtils.isCommercialStore(countryMetadata.code):AppUtils.isEducationalStore(countryMetadata.code))){var url="/store/"+angular.lowercase(storeCountryName);if(onlineQuoteData["market-segment"]!=AppConstants.STORE_TYPE_COM){url=url+"-edu"}$location.url(url+"?onlinequote="+$scope.onlineQuoteId);location.reload(true)}}};$scope.processStore=function(){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){console.info("Store Metadata Initialized Successfully");if($rootScope.returnUrl){$rootScope.returnUrl=null}if($scope.isQuoteToOrder){TrackingService.trackPageView("Store","Store: Quote To Order");$scope.invokeQuoteTransaction();clearInterval(timer)}else{var storeCountryName=$scope.storeName.substring(0,2);var storeType=$scope.storeName.indexOf("edu")==3?StoreConstants.EDUCATIONAL_STORE_TYPE:StoreConstants.COMMERCIAL_STORE_TYPE;var countryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,storeCountryName);var storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,storeCountryName,storeType);if(countryMetadata){if(countryMetadata.selling&&(storeType==StoreConstants.COMMERCIAL_STORE_TYPE?AppUtils.isCommercialStore(countryMetadata.code):AppUtils.isEducationalStore(countryMetadata.code))){TrackingService.trackPageView("Store","Store: "+storeMetadata.countryName);$scope.isStoreValid=true;$scope.initializeStoreScreen()}else{if($scope.onlineQuoteId){$scope.displayOnlineQuoteDetails()}$scope.$apply(function(){if($scope.onlineQuoteId){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Store is currently not available for this country ("+countryMetadata.name+"). Order needs to be completed by the customer on adobe.com – offer to walk the customer through the purchase process")}else{$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Store Is Currently Not Available For This Country")}})}}else{$scope.$apply(function(){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Store Is Invalid.")})}clearInterval(timer)}}};$scope.updateOnlineQuoteResult=function(data){$scope.onlineQuoteResult=data;$scope.isOnlineQuoteValid=true};$scope.$on(StoreConstants.STORE_CREATE_NEW_CUSTOMER_UPDATE_EVENT,function(event,creationStatusMessage){$("#customerCreationStatusModal").modal("show");$scope.customerCreationStatusMessage=creationStatusMessage});$scope.closeCustomerCreationStatusModal=function(){$scope.customerCreationStatusMessage="";$("#customerCreationStatusModal").modal("hide")};if(!$scope.storeName){if($scope.quoteId){$scope.wizardStep=StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS;$scope.isQuoteToOrder=true;timer=setInterval(function(){$scope.processStore();$scope.updateLoadingMessage("Loading Quote");$scope.showViewLoading()},500)}else{$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Store Is Not Valid")}}else{timer=setInterval(function(){$scope.processStore()},500)}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("StoreCustomerController",["$scope","$log","$rootScope","$location","$routeParams","StoreConstants","MetadataService","CartValidator","PaymentConstants","StoreCustomerService","StoreUtil","AppUtils","AppConstants","CustomerRecordService",function($scope,$log,$rootScope,$location,$routeParams,StoreConstants,MetadataService,CartValidator,PaymentConstants,StoreCustomerService,StoreUtil,AppUtils,AppConstants,CustomerRecordService){$scope.isCustomerCountryJp=false;$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:"",customerType:"1"};$scope.searchedCustomer;$scope.productSubscription="";$scope.isCustomerSearchLoading=false;$scope.AppConstants=AppConstants;$scope.$on(StoreConstants.STORE_SELECT_CUSTOMER_FROM_URL_EVENT,function(event){if($scope.customerId){$scope.getCustomerFullDetails($scope.customerId)}});$scope.$on(StoreConstants.STORE_CUSTOMER_IN_URL_IS_VALID,function(event){if($scope.selectedCustomerDetails){$scope.goToCustomerAddDetails($scope.selectedCustomerDetails)}});var defaultJemOrderDto=function(){return{id:"",contractType:"",extContractId:"",annivDay:"",annivDate:"",nextAnnivDate:"",origEntityeid:"",enrolleeId:"",contStartDt:"",contEndDt:"",curr:"",totalValue:"",jemOrderItems:[],puftype:"",paymentType:"",poNumber:""}};var defaultJemOrderItemDto=function(){return{orderedProd:"",description:"",numberInt:"",quantity:"",quantityUnit:"",listPrice:"",grossValue:"",adjPrice:"",adjGrossValue:"",zprdtype:"",startDate:new Date(),endDate:new Date(),ispuf:""}};$scope.toggleMinimize=function($event){$scope.$parent.toggleMinimizePanel($event)};$scope.resetCustomerDetails=function(){$scope.searchFields.idNumber="";$scope.searchFields.firstName="";$scope.searchFields.lastName=""};$scope.resetCustomerId=function(){$scope.searchFields.customerId=""};$scope.searchCustomer=function(){$scope.isCustomerSearchLoading=true;StoreCustomerService.searchCustomer($scope.searchFields).success(function(result){$scope.isCustomerSearchLoading=false;$scope.customerSearchResults=result.customerSearchResults;if($scope.customerSearchResults.length){angular.forEach($scope.customerSearchResults,function(customerData){var customerCountryMetadata;if(customerData&&customerData.address&&customerData.address.country&&customerData.address.country.code){customerCountryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,customerData.address.country.code);if(!customerCountryMetadata.selling){customerData.sellableInCustomerCountry=false}else{customerData.sellableInCustomerCountry=true}}})}if($scope.customerSearchResults.length==1){if($scope.$parent.isCustomerInUrlValid){$scope.$parent.isCustomerInUrlValid=true}$scope.$parent.isOnlyOneCustomerFound=true}else{$scope.$parent.isCustomerInUrlValid=false;$scope.$parent.isOnlyOneCustomerFound=false}}).error(function(result){$scope.$parent.isCustomerInUrlValid=false;$scope.customerSearchResults=[]})};$scope.isValidCustomerSearch=function(){return($scope.searchFields.customerId&&!isNaN(Number($scope.searchFields.customerId)))||$scope.searchFields.idNumber||($scope.searchFields.firstName&&$scope.searchFields.lastName)};$scope.getSelectedCustomerDetail=function(customer,nextStep){if(customer&&customer.address){$scope.isCustomerCountryJp=customer.address.country.code=="JP"?true:false;$scope.$parent.updateSelectedCustomer(customer);$scope.getCustomerFullDetails(customer.customerNo,nextStep)}};$scope.getCartItemAsJemOrderItemDto=function(){var defaultJemOrderDtoObj=defaultJemOrderDto();if($scope.storeCart&&$scope.storeCart.items){angular.forEach($scope.storeCart.items,function(item){var defaultJemOrderItemObj=defaultJemOrderItemDto();defaultJemOrderItemObj.ispuf=item.puf?"X":"";defaultJemOrderItemObj.quantity=item.quantity;defaultJemOrderItemObj.description=item.description;defaultJemOrderItemObj.orderedProd=item.sku;defaultJemOrderItemObj.zprdtype=item.prodType;defaultJemOrderItemObj.listPrice=item.price.listPrice;defaultJemOrderItemObj.productCode=item.productCode;defaultJemOrderDtoObj.jemOrderItems.push(defaultJemOrderItemObj)})}return defaultJemOrderDtoObj};$scope.changeToCustomerStore=function(customer){$location.path("/store/"+customer.address.country.code.toLowerCase());$location.search("customer",customer.customerNo);$location.reload()};$scope.selectCustomer=function(customer,nextStep){$scope.searchedCustomer=customer;$scope.$parent.JemProductSaveMessages=[];$scope.isCustomerSearchLoading=false;$scope.$parent.selectedCustomerDetails.firstName=customer.firstName;$scope.$parent.selectedCustomerDetails.lastName=customer.lastName;$scope.$parent.selectedCustomerDetails.customerNo=customer.customerNo;$scope.$parent.updateLoadingMessage("Loading Customer");$scope.$parent.showViewLoading();$scope.goToCustomerAddDetails(customer,nextStep)};$scope.goToCustomerAddDetails=function(customer,nextStep){$scope.$parent.updateCustomerContract(false);if($scope.isCCMT){$scope.isCustomerSearchLoading=false;$scope.updateLoadingMessage("Checking contract");$scope.$parent.showViewLoading();StoreCustomerService.reviewJemOrder(customer.customerNo,$scope.getCartItemAsJemOrderItemDto()).success(function(result){$scope.$parent.updateLoadingMessage("Loading Customer");$scope.isCustomerSearchLoading=false;$scope.$parent.jemOrderDto=result;$scope.$parent.JemProductSaveMessages=[];$scope.$parent.showHideAddProductBtn(false);var _jemOrderDto=result;var isCustomerHavingContract=(_jemOrderDto.id!="")?true:false;$scope.$parent.updateCustomerContract(isCustomerHavingContract);var isCartContainsPufProduct;var isCartHavingNonPufTeamProduct;if(StoreUtil.isConflictContractExist(result.messages)){$scope.$parent.hideViewLoading();$scope.showCustomerContractModal(result.messages[0].text)}if(StoreUtil.isConflictSKUExist(result.jemOrderItems)){$scope.$parent.showHideAddProductBtn(true)}if($scope.storeCart&&$scope.storeCart.items){isCartContainsPufProduct=StoreUtil.isCartContainsPUFProducts($scope.storeCart.items);isCartHavingNonPufTeamProduct=StoreUtil.isCartContainsNonTeamPUFProducts($scope.storeCart.items)}var isCustomerHavingPufContract=(_jemOrderDto.puftype&&_jemOrderDto.puftype=="Y"&&isCustomerHavingContract)?true:false;var isCustomerHavingNonPufContract=(_jemOrderDto.puftype&&_jemOrderDto.puftype=="N"&&isCustomerHavingContract)?true:false;if(isCustomerHavingContract){if(isCustomerHavingPufContract&&isCartHavingNonPufTeamProduct){$scope.$parent.hideViewLoading();$scope.showCustomerContractModal("This customer already has a Team purchase with Paid Up Front subscription. Therefore, you cannot add monthly-Billed product.")}else{if(isCustomerHavingNonPufContract&&isCartContainsPufProduct){$scope.$parent.hideViewLoading();$scope.showCustomerContractModal("This customer already has a Team purchase with Monthly-Billed subscription. Therefore, you cannot add Paid Up Front product.")}else{if(result.migrationStatus==PaymentConstants.TEAM_CONTRACT_DISABLE_STATUS){$scope.$parent.hideViewLoading();$scope.showCustomerContractModal("Customer contract is  in MIGRATION status try later")}else{$scope.$parent.hideViewLoading();$scope.$parent.goToWizardStep(StoreConstants.WIZARD_ADD_PRODUCTS_PROCESS);$scope.$parent.isCustomerHasContract=true;$scope.updateCartItemWithMoreDetail(result)}}}}else{if($scope.isOnlyCCMT){$scope.$parent.isCustomerHasContract=false;$scope.getSelectedCustomerDetail(customer,nextStep)}}}).error(function(error){$scope.$parent.hideViewLoading()})}else{if($scope.isDSPProducFound){StoreCustomerService.hasQualifyingCCEntitlementForStock({customerNo:customer.customerNo,personGUID:"",productDtos:$scope.storeCart.items}).success(function(result){if(result.ccmiSubscriptionExists==true||result.ccmiSubscriptionExists=="true"){$scope.$parent.hideViewLoading();$scope.showCustomerContractModal(result.messages[0].text)}else{if($scope.hasAdobeStockSmallOrLargeDSP){if(StoreConstants.DISABLE_CCMI_ELIGIBILITY_CHECK_FOR_SMALL_ANNUAL_STOCK||(result.eligibilityFound==true||result.eligibilityFound=="true")){$scope.getSelectedCustomerDetail(customer,nextStep)}else{$scope.$parent.hideViewLoading();$scope.showCustomerContractModal(result.messages[0].text)}}else{$scope.getSelectedCustomerDetail(customer,nextStep)}}}).error(function(error){})}else{$scope.getSelectedCustomerDetail(customer,nextStep)}}};$scope.updateCartItemWithMoreDetail=function(jemOrderDto){jemOrderDto.grossValue=0;angular.forEach(jemOrderDto.jemOrderItems,function(jemOrderItem){angular.forEach($scope.storeCart.items,function(cartItem){if(jemOrderItem.orderedProd==cartItem.sku){cartItem.adjGrossValue=jemOrderItem.adjGrossValue;cartItem.adjPrice=jemOrderItem.adjPrice;cartItem.grossValue=jemOrderItem.grossValue;cartItem.listPrice=jemOrderItem.listPrice;cartItem.currencyCode=jemOrderDto.curr;cartItem.adjPrice=jemOrderItem.adjPrice;cartItem.listPrice=jemOrderItem.listPrice;cartItem.conflictSKU=jemOrderItem.conflictSKU}});jemOrderDto.grossValue=jemOrderDto.grossValue+Number(jemOrderItem.grossValue)})};$scope.$on(StoreConstants.STORE_ADD_PRODUCTS_EVENT,function(event){$scope.addProductToCustomer()});$scope.addProductToCustomer=function(){var numberOfSeats=0;angular.forEach($scope.$parent.jemOrderDto.jemOrderItems,function(item){numberOfSeats=numberOfSeats+Number(item.quantity);if(item.startDate==null||item.startDate.length==0){item.startDate=new Date()}if(item.endDate==null||item.endDate.length==0){item.endDate=new Date()}});$scope.updateLoadingMessage("Adding Product");$scope.$parent.showViewLoading();var purchaseTypeStr=$scope.isOnlineQuoteValid?"Initial Purchase (Online Quote Id -"+$scope.onlineQuoteId+"): ":"Initial Purchase: ";StoreCustomerService.saveJemOrder($scope.selectedCustomerDetails.customerNo,$scope.$parent.jemOrderDto).success(function(result){AppUtils.sendLogToServer(purchaseTypeStr+" Add Product Placed Successfully, Store Name - "+$scope.currentStore.countryName+", Contract Id - "+$scope.$parent.jemOrderDto.extContractId+", Customer Id - "+$scope.selectedCustomerDetails.customerNo+", Total Seats - "+numberOfSeats);$scope.$parent.showHideAddProductBtn(true);$scope.$parent.updateLoadingMessage("Loading");$scope.$parent.hideViewLoading();$scope.$parent.JemProductSaveMessages=result.messages;if(result&&result.messages&&result.messages.length>0){$scope.$parent.updateSFDCOpportunityDetail(false,"result: "+result.messages[0].text+" Store Name - "+$scope.currentStore.countryName+", Contract Id - "+$scope.$parent.jemOrderDto.extContractId+", Customer Id - "+$scope.selectedCustomerDetails.customerNo+", Total Seats - "+numberOfSeats);if(result.messages[0].success==true&&$scope.$parent.jemOrderDto.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result.messages.push(CartValidator.getCartMessage("しばらくしたらお支払い案内メールが送られますので、お客様にその旨お伝えください","info"))}}}).error(function(error){AppUtils.sendLogToServer(purchaseTypeStr+" Add Product Not Placed Successfully, Store Name - "+$scope.currentStore.countryName+", Contract Id - "+$scope.$parent.jemOrderDto.extContractId+", Customer Id - "+$scope.selectedCustomerDetails.customerNo);$scope.$parent.showHideAddProductBtn(true);$scope.$parent.updateSFDCOpportunityDetail(false," Add Product Not Placed Successfully, Store Name - "+$scope.currentStore.countryName+", Contract Id - "+$scope.$parent.jemOrderDto.extContractId+", Customer Id - "+$scope.selectedCustomerDetails.customerNo);$scope.$parent.updateLoadingMessage("Loading");$scope.$parent.hideViewLoading()})};$scope.getCustomerFullDetails=function(customerNo,nextStep){var customerRequestObject=new Object();customerRequestObject.customerNo=customerNo;StoreCustomerService.getCustomerDetails(customerRequestObject).success(function(result){$scope.$parent.hideViewLoading();if(result&&result.address&&(!result.address.street1||!result.address.city||!result.address.state)){$scope.$parent.isCustomerAddressEmpty=true}else{$scope.$parent.isCustomerAddressEmpty=false}$scope.$parent.updateSelectedCustomerDetails(result);if(result&&(result.enterpriseId||result.bpType=="2")){$scope.isCustomerSearchLoading=false}else{if(nextStep){$scope.$parent.goToWizardStep(StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS)}}$scope.$parent.showModalsForCustomerInUrl()}).error(function(result){console.log("error")})};$scope.createNewCustomer=function(customer,nextStep){$scope.defaultCustomer={allowSurveyInOutput:false,blocked:false,marketingValues:null,locked:false,address:{country:{code:null}},bpType:"1",customerNo:"",updateLegacy:false,legacy:false,taxInfo:{taxType:"",taxNumber:""}};$scope.newCustomer=angular.copy($scope.defaultCustomer);$scope.newCustomer.address.country.code=$scope.currentStore.countryCode;$scope.newCustomer.address.country.name=$scope.currentStore.countryName;$rootScope.$broadcast(StoreConstants.STORE_SELECT_CUSTOMER_EVENT,$scope.newCustomer);$scope.$parent.goToWizardStep(StoreConstants.WIZARD_CUSTOMER_DETAILS_PROCESS);$rootScope.$broadcast(StoreConstants.STORE_CREATE_NEW_CUSTOMER_EVENT,true)};$scope.closeSubsciptionExistsModal=function(){$("#subscriptionExistsModal").modal("hide");$scope.$parent.goToWizardStep(StoreConstants.WIZARD_PRODUCT_PROCESS)};$scope.showSubsciptionExistsModal=function(){$("#subscriptionExistsModal").modal("show")};$scope.showMessage=function(type,message){$scope.messages=[];$scope.messages.push({info:type=="info",error:type=="error",text:message})};$scope.updateRecordByIndex=function(newRecord,itemIndex){$scope.customerSearchResults[itemIndex]=newRecord;$scope.$parent.hideViewLoading();console.log(newRecord,"new record updated at index: "+itemIndex)};$scope.createCrmRecord=function(customer,$index){$scope.searchIndex=$index;var customerData={adobeId:customer.email,enterpriseId:customer.enterpriseId,customerNo:customer.customerNo};$scope.$parent.updateLoadingMessage("Creating in CRM");$scope.$parent.showViewLoading();CustomerRecordService.createCrmRecord(customerData).success(function(response){console.log("CRM record service data:",response);console.log("Index : "+$scope.searchIndex);var isNotAdminMsg;$.grep(response.messages,function(message){if(message.type=="E"&&message.number==""){isNotAdminMsg=message}});if(typeof isNotAdminMsg!=="undefined"){$scope.showMessage("error",isNotAdminMsg.text)}else{$scope.updateRecordByIndex(response,$scope.searchIndex);$scope.searchCustomer()}}).error(function(errorData){console.log("Error in CRM record service:",errorData);$scope.showMessage("error","Error in creating customer in CRM");$scope.$parent.hideViewLoading()})}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("StoreCustomerDetailsController",["$scope","$log","$rootScope","$location","$routeParams","$filter","StoreConstants","StoreCustomerService","AddressValidationService","MetadataService","CustomerRecordService","Utils","AppUtils","ImsCustomerService","CustomerConstants",function($scope,$log,$rootScope,$location,$routeParams,$filter,StoreConstants,StoreCustomerService,AddressValidationService,MetadataService,CustomerRecordService,Utils,AppUtils,ImsCustomerService,CustomerConstants){$scope.customerDetails=new Object();$scope.customer=new Object();$scope.isCustomerModified=false;$scope.isAddressValidationVisible=false;$scope.isUseAddressOwnBtn=$scope.isUseAddressNewBtn=true;$scope.isMarketingValuesUpdated=false;$scope.orderConfirmationView=true;$scope.isNewCustomerInitiated=false;$scope.taxRefresh=false;$scope.showGSTOptions=false;$scope.gstRegxPattern=/^\d{2,3}-?\d{3}-?\d{3}$/;$scope.isGSTFormatValid=true;$scope.marketingViewCreationComplete=function(){$('input[name="marketing-checkbox"]').bootstrapSwitch({onText:"Yes",offText:"No",size:"mini",onSwitchChange:switchChangeHandler})};var switchChangeHandler=function(event,state){if(event.target.dataset.object){var selectedOption=angular.fromJson(event.target.dataset.object);angular.forEach($scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.code==selectedOption.code&&state==false){marketingOptInItem.values[0].selected="no";marketingOptInItem.values[1].selected="";marketingOptInItem.selected="no"}if(marketingOptInItem.code==selectedOption.code&&state==true){marketingOptInItem.values[0].selected="";marketingOptInItem.values[1].selected="yes";marketingOptInItem.selected="yes"}});$scope.checkAllSelection()}else{if(state!=null){if(state==false){$scope.unSelectNoValue="no";$scope.unSelectYesValue=""}else{$scope.unSelectNoValue="";$scope.unSelectYesValue="yes"}angular.forEach($scope.marketingOptinInformation,function(marketingOptInItem){if(state==false){$('input[name="marketing-checkbox"]').bootstrapSwitch("state",false);marketingOptInItem.values[0].selected="no";marketingOptInItem.values[1].selected="";marketingOptInItem.selected="no"}else{if(state==true){$('input[name="marketing-checkbox"]').bootstrapSwitch("state",true);marketingOptInItem.values[0].selected="";marketingOptInItem.values[1].selected="yes";marketingOptInItem.selected="yes"}}})}}};$scope.$watch("customerDetails",function(newValue,oldValue){if(oldValue.hasOwnProperty("customerNo")){$scope.isCustomerModified=true}},true);$scope.$watch("customerDetails",function(newValue,oldValue){if($scope.customerDetails.address&&$scope.customerDetails.address.country&&$scope.customerDetails.address.country.code){$scope.checkVatDisplay();$scope.checkGSTDisplay()}},true);$scope.checkVatDisplay=function(){$scope.showVatOptions=false;angular.forEach($scope.metadata.vatOptions,function(vatItem){if($scope.customer.address.country&&$scope.customer.address.country.code&&!$scope.showVatOptions){if(vatItem.code.indexOf($scope.customer.address.country.code)!=-1){$scope.showVatOptions=true}}})};$scope.$watch("customerDetails.address.state",function(newValue){if(angular.isDefined(newValue)&&angular.isDefined($scope.countrySpecificInfo)){angular.forEach($scope.countrySpecificInfo.statesByCountry,function(stateItem){if(newValue==stateItem.id){$scope.customerDetails.address.stateName=stateItem.description}})}});$scope.showCountryTaxableMessage=false;$scope.isSuggestedAddressEmpty=function(address){var isAddressEmpty=false;if(address.addressNo==""&&address.city==""&&(address.country&&address.country.code=="")&&address.district==""&&address.homeCity==""&&address.postCode==""&&address.state==""&&address.street1==""&&address.street2==""&&address.street3==""){isAddressEmpty=true}return isAddressEmpty};$scope.validateCustomerDetails=function(){if($scope.customerDetails.address.country.code=="US"||$scope.customerDetails.address.country.code=="CA"){$scope.showCountryTaxableMessage=true}else{$scope.showCountryTaxableMessage=false}if($scope.customerDetails.address.country.code=="JP"){var postalCode=$scope.customerDetails.address.postCode;$scope.customerErrorMessages=AppUtils.validatePostalCode(postalCode);if($scope.customerErrorMessages.length>0){return}}$scope.saveMarketingInformation();$scope.suggestedAddress;$scope.$parent.updateLoadingMessage("Validating Address");$scope.$parent.showViewLoading();if(!$scope.isNewCustomerInitiated){StoreCustomerService.customerLock({customerNo:$scope.customerDetails.customerNo,flag:"L"}).success(function(result){$scope.$parent.updateCustomerLockInformation(result)}).error(function(){})}$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:0.4});$scope.validateCorrectStreetOption();AddressValidationService.validate($scope.customerDetails.address).success(function(result){$scope.$parent.hideViewLoading();$scope.isAddressValidationVisible=true;result.finalProposal.country.name=$scope.customerDetails.address.country.name;$("#originalAddress").css({opacity:1});$("#postalStandardSerivceAddress").css({opacity:1});if(result.finalProposal){if(!result.finalProposal.stateName){angular.forEach($scope.metadata.countrySpecificInfo.statesByCountry,function(stateItem){if(result.finalProposal.state==stateItem.id){result.finalProposal.stateName=stateItem.description}})}}$scope.suggestedAddress=result.finalProposal;$scope.isEnteredAddressValid=true;$scope.isSuggestedAddressValid=true;if($scope.customerDetails.address.country.code=="JP"){$scope.suggestedAddress=$scope.customerDetails.address}if(result.dsStatus&&result.enteredTaxAddrStatus&&result.suggestedTaxAddrStatus){if(result.dsStatus=="E"||result.enteredTaxAddrStatus=="E"){$scope.isEnteredAddressValid=false;$("#originalAddress").css({opacity:0.4})}if(result.suggestedTaxAddrStatus=="E"||$scope.isSuggestedAddressEmpty($scope.suggestedAddress)){$scope.isSuggestedAddressValid=false;$("#postalStandardSerivceAddress").css({opacity:0.4})}}if(result.message!=null){$scope.adddressValidationMessages=[];$scope.adddressValidationMessages.push(result.message)}}).error(function(result){$scope.isAddressValidationVisible=false;$scope.isEnteredAddressValid=false;$scope.isSuggestedAddressValid=false})};$scope.editCustomerDetails=function(){$scope.isAddressValidationVisible=false;$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:1});$scope.isUseAddressOwnBtn=$scope.isUseAddressNewBtn=true};$scope.resetAddressSelection=function(){$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:1});$scope.isUseAddressOwnBtn=$scope.isUseAddressNewBtn=true};$scope.UpdateCustomerProfileBillingAddress=function(checked){$scope.isBillingAddress=checked};$scope.UpdateCustomerProfileShippingAddress=function(checked){$scope.isShippingAddress=checked};$scope.handleAddressUpdate=function(customerAddress){customerAddress.name=$scope.customerDetails.firstName+" "+$scope.customerDetails.lastName;customerAddress.phone=$scope.customerDetails.telephone;customerAddress.email=$scope.customerDetails.email;$scope.$parent.selectedCustomerDetails.firstName=$scope.customerDetails.firstName;$scope.$parent.selectedCustomerDetails.lastName=$scope.customerDetails.lastName;$scope.$parent.selectedCustomerDetails.customerNo=$scope.customerDetails.customerNo;$scope.$parent.selectedCustomerDetails.address=customerAddress;$scope.customerDetails.address=customerAddress;var editCustomerAddress=angular.copy($scope.customerDetails);if($scope.isBillingAddress||$scope.isShippingAddress){editCustomerAddress.address=customerAddress}else{editCustomerAddress.address=$scope.customerOriginalData.address}if($scope.taxRefresh){editCustomerAddress.refreshBuffer=true}else{editCustomerAddress.refreshBuffer=false}$scope.taxRefresh=false;if(($scope.taxInfoUpdated||$scope.isMarketingValuesUpdated||$scope.isBillingAddress||$scope.isShippingAddress)&&$scope.customerDetails.customerNo){StoreCustomerService.updateItem(editCustomerAddress).success(function(data){$scope.customerDetails=data;if(!$scope.isBillingAddress&&!$scope.isShippingAddress){$scope.customerDetails.address=customerAddress}$scope.isMarketingValuesUpdated=false}).error(function(data){console.log("StoreCustomerDetailsControler --> handleAddressUpdate --> ERROR while updating customer address",data)})}if(!$scope.isBillingAddress&&!$scope.isShippingAddress&&!$scope.isOnlyHardGoodProductFound){$scope.$parent.updateTransactionBillingAddress(customerAddress,true)}if(!$scope.isBillingAddress&&!$scope.isShippingAddress&&$scope.isOnlyHardGoodProductFound){$scope.$parent.updateTransactionBillingAddress(customerAddress,false)}if($scope.isBillingAddress){$scope.$parent.updateCustomerTransactionBillingAddress(customerAddress,true)}if($scope.isShippingAddress){$scope.$parent.updateCustomerTransactionBillingAddress(customerAddress,false)}$scope.updateTransactionAddressDetails(customerAddress)};$scope.handleValidateOwnAddress=function(){$scope.handleAddressUpdate($scope.customerDetails.address);$scope.isUseAddressNewBtn=false;$("#postalStandardSerivceAddress").css({opacity:0.4});$("#originalAddress").css({opacity:1});$scope.goToNextStep()};$scope.handleValidateNewAddress=function(){$scope.replaceCorrectStreetNo();$scope.handleAddressUpdate($scope.suggestedAddress);$scope.isUseAddressOwnBtn=false;$("#postalStandardSerivceAddress").css({opacity:1});$("#originalAddress").css({opacity:0.4});$scope.goToNextStep()};$scope.goToNextStep=function(){if($scope.isNewCustomerInitiated==true){$scope.createNewCustomerForStore()}else{$rootScope.$broadcast(StoreConstants.STORE_ADDRESS_VALIDATION_UPDATE_EVENT,$scope.customerDetails)}};$scope.marketingProfile0={};$scope.marketingProfile1={};$scope.marketingProfile2={};$scope.marketingProfile3={};$scope.marketingProfile4={};$scope.marketingProfile5={};$scope.resetMarketingInfo=function(){$scope.marketingProfile0={};$scope.marketingProfile1={};$scope.marketingProfile2={};$scope.marketingProfile3={};$scope.marketingProfile4={};$scope.marketingProfile5={};$scope.customerDetails.marketingValues=[];$scope.selectedMarkeitngInformation=[];$scope.selectedMarkeitngProfile=[]};$scope.checkAllSelection=function(){var noCount=0;var yesCount=0;angular.forEach($scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.selected=="no"){noCount++}if(marketingOptInItem.selected=="yes"){yesCount++}if(noCount==$scope.marketingOptinInformation.length){$('input[name="marketing-checkbox"]').bootstrapSwitch("state",false)}if(yesCount==$scope.marketingOptinInformation.length){$('input[name="marketing-checkbox"]').bootstrapSwitch("state",true)}})};$scope.checkMarketingInfo=function(){$scope.unSelectNoValue="";$scope.unSelectYesValue="";angular.forEach($scope.customerDetails.marketingValues,function(customerMarketingOptInItem){angular.forEach($scope.marketingOptinInformation,function(marketingOptInItem){if(customerMarketingOptInItem.code==marketingOptInItem.code){if(customerMarketingOptInItem.value==marketingOptInItem.values[0].value){marketingOptInItem.values[0].selected="no";marketingOptInItem.selected="no"}if(customerMarketingOptInItem.value==marketingOptInItem.values[1].value){marketingOptInItem.values[1].selected="yes";marketingOptInItem.selected="yes"}}});$scope.checkAllSelection();for(var i=0;i<$scope.marketingProfileInformation.length;i++){var marketingProfileItem=$scope.marketingProfileInformation[i];if(customerMarketingOptInItem.code==marketingProfileItem.code){if(customerMarketingOptInItem.description!=null||customerMarketingOptInItem.value!=""){switch(i){case 0:$scope.marketingProfile0.value=customerMarketingOptInItem.value;break;case 1:$scope.marketingProfile1.value=customerMarketingOptInItem.value;break;case 2:$scope.marketingProfile2.value=customerMarketingOptInItem.value;break;case 3:$scope.marketingProfile3.value=customerMarketingOptInItem.value;break;case 4:$scope.marketingProfile4.value=customerMarketingOptInItem.value;break;case 5:$scope.marketingProfile5.value=customerMarketingOptInItem.value;break}}}}})};$scope.saveMarketingInformation=function(){$scope.isMarketingSaving=true;$scope.selectedMarkeitngInformation=[];angular.forEach($scope.marketingOptinInformation,function(marketingOptInItem){if(marketingOptInItem.values&&marketingOptInItem.values[0].selected=="no"){var objectToPushNo=angular.copy(marketingOptInItem.values[0]);delete objectToPushNo.selected;$scope.selectedMarkeitngInformation.push(objectToPushNo)}else{if(marketingOptInItem.values&&marketingOptInItem.values[1].selected=="yes"){var objectToPushYes=angular.copy(marketingOptInItem.values[1]);delete objectToPushYes.selected;$scope.selectedMarkeitngInformation.push(objectToPushYes)}}});$scope.selectedMarkeitngProfile=[];angular.forEach($scope.marketingProfileInformation,function(marketingProfileItem){angular.forEach(marketingProfileItem.values,function(marketingProfileOptionItem){if($scope.marketingProfile0&&$scope.marketingProfile0.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile0.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if($scope.marketingProfile1&&$scope.marketingProfile1.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile1.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if($scope.marketingProfile2&&$scope.marketingProfile2.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile2.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if($scope.marketingProfile3&&$scope.marketingProfile3.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile3.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if($scope.marketingProfile4&&$scope.marketingProfile4.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile4.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}else{if($scope.marketingProfile5&&$scope.marketingProfile5.value!=""&&marketingProfileOptionItem.value==$scope.marketingProfile5.value){$scope.selectedMarkeitngProfile.push(marketingProfileOptionItem)}}}}}}})});$scope.customerDetails.marketingValues=$.merge($scope.selectedMarkeitngInformation,$scope.selectedMarkeitngProfile);$scope.isMarketingSaving=false;$scope.$watch("customerDetails.marketingValues",function(newValue,oldValue){if(!angular.equals(newValue,oldValue)&&$scope.$parent.marketingAttributesEdit){$scope.marketingValuesAltered()}},true)};$scope.$watch("customerDetails.taxInfo",function(newValue,oldValue){if(!angular.equals(newValue,oldValue)){$scope.taxInfoUpdated=true;$scope.taxRefresh=true}else{$scope.taxInfoUpdated=false;$scope.taxRefresh=false}},true);$scope.marketingValuesAltered=function(){$scope.isMarketingValuesUpdated=true};$scope.checkGSTDisplay=function(){$scope.showGSTOptions=false;if($scope.customer.address.country.code.toUpperCase()=="NZ"){$scope.customerDetails.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;$scope.showGSTOptions=true}};$scope.isValid=function(customer){var returnResult=false;$scope.isGSTFormatValid=true;if(!customer){returnResult=false;return returnResult}if(customer.address&&customer.address.country&&(customer.address.state==""||customer.address.country.code=="")){returnResult=false;return returnResult}if(!customer.firstName||!customer.lastName||(customer.address&&(customer.address.postCode==""||!customer.address.city||!customer.address.state))){returnResult=false;return returnResult}if(customer.address.postCode&&customer.address.postCode.length<=4&&(customer.address.country.code=="US"||customer.address.country.code=="CA")){returnResult=false;return returnResult}var customerEmail=$("#editCustomerEmail").val();if(!customerEmail||customerEmail==""){returnResult=false;return returnResult}if(customerEmail&&customerEmail!=""){var atPosition=customerEmail.indexOf("@");var dotPosition=customerEmail.lastIndexOf(".");if(atPosition<1||dotPosition<atPosition+2||dotPosition+2>=customerEmail.length||dotPosition+10<customerEmail.length){returnResult=false;return returnResult}}returnResult=!(AppUtils.getAddressInvalidStatus(customer.address,$scope.isCountryJP));try{if($scope.customer&&$scope.customer.address&&$scope.customer.address.country&&$scope.customer.address.country.code&&$scope.customer.address.country.code.toUpperCase()=="NZ"){$scope.customer.taxInfo.taxType=CustomerConstants.GST_NZ_CODE;$scope.showGSTOptions=true}}catch(e){console.log(e)}if(customer.taxInfo&&customer.taxInfo.taxType&&customer.taxInfo.taxType==CustomerConstants.GST_NZ_CODE){if(angular.isDefined(customer.taxInfo.taxNumber)&&customer.taxInfo.taxNumber.length>0){returnResult=$scope.gstRegxPattern.test(customer.taxInfo.taxNumber);if(!returnResult){$scope.isGSTFormatValid=returnResult}}}else{if(customer.taxInfo&&customer.taxInfo.taxType&&!customer.taxInfo.taxNumber){return returnResult=false}else{if(customer.taxInfo&&!customer.taxInfo.taxType&&customer.taxInfo.taxNumber){return returnResult=false}}}return returnResult};$scope.$on(StoreConstants.STORE_SELECT_CUSTOMER_EVENT,function(event,customerData){$scope.resetMarketingInfo();$scope.customerDetails=angular.copy(customerData);$scope.customerOriginalData=angular.copy(customerData);$scope.$parent.selectedCustomer=$scope.customerDetails;$scope.metaTitles=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.TITLES],MetadataService.INDEX_NAMES.VALUE);$scope.metaLanguages=$filter("orderBy")($scope.metadata[MetadataService.STORE_NAMES.LANGUAGES],MetadataService.INDEX_NAMES.DESCRIPTION);$scope.metaStatesByCountry=$filter("orderBy")($scope.metadata.countrySpecificInfo.statesByCountry,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.countrySpecificInfo=$scope.metadata.countrySpecificInfo;$scope.marketingOptinInformation=$scope.metadata.countrySpecificInfo.marketingOptinInformation;$scope.marketingProfileInformation=$scope.metadata.countrySpecificInfo.marketingProfileInformation;$scope.customerDetails.defaultCountryLanguage=Utils.getDefaultCountriesLanguage($scope.customerDetails.address.country.code);if($scope.customerDetails.defaultCountryLanguage&&$scope.customerDetails.outputLanguage){$scope.customerDetails.isCountryLanguageMismatch=$scope.customerDetails.defaultCountryLanguage.toUpperCase()!=$scope.customerDetails.outputLanguage.toUpperCase()?true:false}if($scope.customerDetails.defaultCountryLanguage.length!=2){$scope.customerDetails.isCountryLanguageMismatch=false}$scope.customer=angular.copy($scope.$parent.selectedCustomer);if($scope.isOnlyHardGoodProductFound){$scope.isShippingAddress=true;$scope.isBillingAddress=false}else{$scope.isShippingAddress=false;$scope.isBillingAddress=true}$scope.checkMarketingInfo();$scope.customerErrorMessages=[];$scope.isAddressValidationVisible=false;$scope.isNewCustomerInitiated=false;if($scope.customerDetails.address.country&&$scope.customerDetails.address.country.code=="JP"){$scope.isCustomerCountryJp=true}else{$scope.isCustomerCountryJp=false}});$scope.$watch("customerDetails.outputLanguage",function(newValue,oldValue){if(!$scope.customerDetails){return}if(!newValue){return $scope.customerDetails.isCountryLanguageMismatch=true}$scope.customerDetails.outputLanguage=newValue;$scope.customerDetails.isCountryLanguageMismatch=$scope.customerDetails.defaultCountryLanguage.toUpperCase()!=$scope.customerDetails.outputLanguage.toUpperCase()?true:false});$scope.$on(StoreConstants.STORE_CREATE_NEW_CUSTOMER_EVENT,function(event,isNewCustomer){$scope.isNewCustomerInitiated=isNewCustomer;$scope.customerDetails.outputLanguage=$scope.customerDetails.defaultCountryLanguage});$scope.customerErrorMessages=[];$scope.createNewCustomerForStore=function(){$scope.isNewCustomerCreated=false;$scope.saveMarketingInformation();$scope.$parent.updateLoadingMessage("Creating New Customer");$scope.$parent.showViewLoading();if($scope.customerDetails.taxInfo&&angular.isDefined($scope.customerDetails.taxInfo.taxNumber)&&$scope.customerDetails.taxInfo.taxNumber.length==0){$scope.customerDetails.taxInfo.taxType=""}CustomerRecordService.createItem($scope.customerDetails).success(function(result){$scope.customerDetails=result;$scope.$parent.updateSelectedCustomerDetails(result);$scope.isNewCustomerCreated=true;$rootScope.$broadcast(StoreConstants.STORE_ADDRESS_VALIDATION_UPDATE_EVENT,$scope.customerDetails);$rootScope.$broadcast(StoreConstants.STORE_CREATE_NEW_CUSTOMER_UPDATE_EVENT,result.messages[0].text);$scope.$parent.hideViewLoading()}).error(function(result){$scope.$parent.hideViewLoading();if(result&&result.messages&&result.messages.length>0){$scope.editCustomerDetails();$scope.customerErrorMessages=result.messages}$scope.isNewCustomerCreated=false})};$scope.resetPassword=function(){$scope.$parent.updateLoadingMessage("Resetting password..");$scope.$parent.showViewLoading();ImsCustomerService.resetPassword({email:$scope.customerDetails.email,language:$scope.customerDetails.defaultCountryLanguage}).success(function(result){console.log("Success -> Password Reset Email");if(result.status=="UNKNOWN"){$scope.customerErrorMessages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){$scope.customerErrorMessages=Utils.showMessage("info","Password reset email sent successfully")}else{$scope.customerErrorMessages=Utils.showMessage("error","Password Reset Email failed")}}$scope.$parent.hideViewLoading()}).error(function(error){$scope.$parent.hideViewLoading();$scope.customerErrorMessages=Utils.showMessage("info","Password Reset Email failed");console.log("error",error)})};$scope.verifyEmail=function(){$scope.$parent.updateLoadingMessage("Verifying Email..");$scope.$parent.showViewLoading();ImsCustomerService.verifyEmail({email:$scope.customerDetails.email}).success(function(result){console.log("Success -> Email Verification Service");if(result.status=="UNKNOWN"){$scope.customerErrorMessages=Utils.showMessage("info","User email does not exist in the system")}else{if(result.status=="EMAIL_SENT"){$scope.customerErrorMessages=Utils.showMessage("info","Email Verification Email Sent Successfully")}else{if(result.status=="EMAIL_NOT_SENT_ALREADY_VERIFIED"){$scope.customerErrorMessages=Utils.showMessage("info","Email is already verified in the system")}else{$scope.customerErrorMessages=Utils.showMessage("error","Email verification email failed")}}}$scope.$parent.hideViewLoading()}).error(function(error){console.log("error",error);$scope.customerErrorMessages=Utils.showMessage("error","Email verification email failed");$scope.$parent.hideViewLoading()})};$scope.isVATTypeMismatched=false;$scope.$watch("customerDetails.taxInfo.taxType",function(value){if(!$scope.customerDetails){return}if($scope.customerDetails.taxInfo&&$scope.customerDetails.address.country&&$scope.metadata.vatOptions){$scope.isVATTypeMismatched=(MetadataService.getDefaultVATOptionFromMetadata($scope.metadata.vatOptions,$scope.customerDetails.address.country.code)!=$scope.customerDetails.taxInfo.taxType)?true:false}});$scope.resetDefaultVatType=function(){if($scope.customerDetails.taxInfo&&$scope.customerDetails.address.country){$scope.customerDetails.taxInfo.taxType=MetadataService.getDefaultVATOptionFromMetadata($scope.metadata.vatOptions,$scope.customerDetails.address.country.code)}};$scope.clearVat=function(){if($scope.customerDetails.taxInfo){$scope.customerDetails.taxInfo.taxType="";$scope.customerDetails.taxInfo.taxNumber=""}};$scope.isCorrectStreetOptionVisible=false;$scope.validateCorrectStreetOption=function(){$scope.isCorrectStreetOptionVisible=AppUtils.isValidHouseNumber($scope.customerDetails.address)};$scope.correctStreetNo="";$scope.updateCorrectStreetNo=function(correctStreetNo){$scope.correctStreetNo=correctStreetNo};$scope.replaceCorrectStreetNo=function(){if($scope.correctStreetNo&&$scope.correctStreetNo!=""){$scope.suggestedAddress=AppUtils.getReplacedStreet1Address($scope.correctStreetNo,$scope.suggestedAddress)}$scope.correctStreetNo=""}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("StoreCustomerService",["$http",function($http){var transform=function(data){return $.customParam(data)};var service={searchCustomer:function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},getCustomerDetails:function(data){return $http({method:"POST",url:"../customerRecordService/getItem.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data,transformResponse:function(data,headerGetters){try{data=angular.fromJson(data);if(data.billingAddress==null){data.billingAddress=data.address}if(data.shippingAddress==null){data.shippingAddress=data.address}}catch(err){console.log("Fail to convert into JSON object")}return data}})},updateItem:function(data){return $http({method:"POST",url:"../customerRecordService/updateItem.do",data:data})},customerLock:function(data){return $http({method:"POST",url:"../customerRecordService/customerLock.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})},ccmiSubscription:function(customerNo,guid){return $http({method:"POST",url:"../productService/hasCcmiSubscription.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{customerNo:customerNo,personGuid:guid}})},hasQualifyingCCEntitlementForStock:function(data){return $http({method:"POST",url:"../productService/hasQualifyingCCEntitlementForStock.do",data:data})},reviewJemOrder:function(customer,jemOrderDto){return $http({data:{customerNo:customer,jemOrderItems:jemOrderDto.jemOrderItems},method:"POST",url:"../transactionService/reviewJemOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform})},saveJemOrder:function(customer,jemOrderDto){return $http({data:{customerNo:customer,id:jemOrderDto.id,contractType:jemOrderDto.contractType,extContractId:jemOrderDto.extContractId,annivDay:jemOrderDto.annivDay,annivDate:jemOrderDto.annivDate,nextAnnivDate:jemOrderDto.nextAnnivDate,origEntityeid:jemOrderDto.origEntityeid,enrolleeId:jemOrderDto.enrolleeId,contStartDt:jemOrderDto.contStartDt,contEndDt:jemOrderDto.contEndDt,curr:jemOrderDto.curr,totalValue:jemOrderDto.totalValue,jemOrderItems:jemOrderDto.jemOrderItems,puftype:jemOrderDto.puftype,paymentType:jemOrderDto.paymentType,poNumber:jemOrderDto.poNumber},method:"POST",url:"../transactionService/saveJemOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform})}};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngStoreCreditCardForm",["$rootScope","$timeout","PaymentConstants","TransactionConstants",function($rootScope,$timeout,PaymentConstants,TransactionConstants){return{restrict:"EA",scope:{paymentDetails:"=",cardTypeName:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-credit-card-form.html",link:function(scope,element,attrs){if(angular.uppercase(scope.cardTypeName)=="AMERICAN EXPRESS"){scope.cardTypeName="AMEX"}}}}]);app.directive("ngStoreCreditCardOnFile",["$rootScope","$timeout","PaymentConstants","TransactionConstants",function($rootScope,$timeout,PaymentConstants,TransactionConstants){return{restrict:"EA",scope:{paymentInstrument:"=",cardTypeName:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-credit-card-on-file.html",link:function(scope,element,attrs){}}}]);app.directive("ngStoreDirectDebitForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-direct-debit-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngStoreBankTransferForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-bank-transfer-form.html",link:function(scope,element,attrs){if(!scope.viewType){scope.viewType="VIEW"}}}}]);app.directive("ngStorePaypalForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-paypal-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngStoreCvsForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-cvs-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngStorePoForm",["$rootScope",function($rootScope){return{restrict:"EA",scope:{paymentDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/payment-forms/store-po-form.html",link:function(scope,element,attrs){}}}]);app.directive("ngStoreCart",["$rootScope","StoreConstants","ValidateCouponService",function($rootScope,StoreConstants,ValidateCouponService){return{restrict:"EA",scope:{cartTransaction:"=",customerDetails:"=",viewType:"="},replace:true,templateUrl:"js/store/transaction/partials/store-cart-review.html",link:function($scope,element,attrs){$scope.StoreConstants=StoreConstants;$scope.validateCoupon=function(val,index,scope){ValidateCouponService.validateCoupon({couponCode:val}).success(function(result){element.find("#payment"+index+"promoEditMessage").hide();element.find("#payment"+index+"promoView").hide();if(result.messages&&result.messages.length>0&&result.messages[0].type=="W"){element.find("#payment"+index+"promoEditMessage").show()}else{if(result.messages&&result.messages.length>0&&result.messages[0].type=="S"){element.find("#payment"+index+"promoView").show();element.find("#payment"+index+"promoEditContent").hide();element.find("#payment"+index+"promoView").find("#message").html(result.couponCode+":"+result.campaignName+" "+result.campaignDesc)}}}).error(function(error){})};$scope.applyCoupon=function(couponCode,item,scope){item.promoCode=couponCode;$rootScope.$broadcast(StoreConstants.PROMO_CODE_APPLIED_ON_LINE_ITEM,item)};$scope.removeAppliedPromo=function(cartItem){$rootScope.$broadcast(StoreConstants.PROMO_CODE_REMOVED_ON_LINE_ITEM,cartItem)};$scope.resetPromo=function(index){element.find("#payment"+index+"promoView").hide();element.find("#payment"+index+"promoEditContent").show();element.find("#payment"+index+"promoView").find("#message").html("")}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("StoreDto",{selling:true,countryCode:"",countryName:"",storeKey:"",region:"",storeName:"",crmStoreName:"",storeType:"",storeTypeName:"",isEduStore:false,locale:""});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("StorePaymentController",["$scope","$log","$rootScope","$location","$routeParams","$timeout","StoreConstants","StoreUtil","PaymentConstants","AppUtils","PaymentService","TrackingService","TransactionConstants","features",function($scope,$log,$rootScope,$location,$routeParams,$timeout,StoreConstants,StoreUtil,PaymentConstants,AppUtils,PaymentService,TrackingService,TransactionConstants,features){$scope.PaymentConstants=PaymentConstants;$scope.orderTransaction;$scope.paymentYears=[];$scope.isPaymentTokenizerShow=false;$scope.paymentDetails=new Object();$scope.isPaymentTypeNotMatch=true;$scope.tokenCardTypeName="";$scope.paymentErrorMessage="";$scope.populateCreditCard=function(tokenData){TrackingService.trackPageView("Store","Token Success: "+$scope.currentStore.countryName);$scope.isPaymentTypeNotMatch=true;$scope.paymentDetails.expiryDate=tokenData.payment_instrument.credit_card_expiry_date_display;var expiryDateContent=$scope.paymentDetails.expiryDate.split("/");if(!$scope.metadata.paymentMetadata){$scope.metadata.paymentMetadata=$scope.getStorePaymentMetadata()}for(var count=0;count<$scope.metadata.paymentMetadata.creditCardTypes.length;count++){if(($scope.metadata.paymentMetadata.creditCardTypes[count].code==tokenData.payment_instrument.payment_type)||(tokenData.payment_instrument.payment_type==PaymentConstants.TOKENIZER_MASTER_CARD_TYPE)){$scope.paymentDetails.cardType=tokenData.payment_instrument.payment_type==PaymentConstants.TOKENIZER_MASTER_CARD_TYPE?PaymentConstants.MASTER_CARD_TYPE:tokenData.payment_instrument.payment_type;$scope.paymentDetails.cardNumber=tokenData.token_id;$scope.paymentDetails.expiryMonth=expiryDateContent[0];$scope.paymentDetails.expiryYear=expiryDateContent[1];$scope.isPaymentTypeNotMatch=false;break}}$scope.tokenCardTypeName=tokenData.payment_instrument.payment_type;$scope.paymentDetails.expirationDate=tokenData.payment_instrument.credit_card_expire_date;$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_PAYMENT_TYPE;$scope.$apply(function(){$scope.isTokenReceived=true})};$scope.resetPaymentView=function(){$scope.$apply(function(){$scope.isTokenReceived=false})};$scope.enableCreditCardPaymentOnFile=function(){$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_ON_FILE_PAYMENT_TYPE;$scope.resetCreditCardOnFileSelection()};$scope.updatePaymentFromFile=function(paymentObject){var paymentOnFile=new Object();paymentOnFile.paymentType=paymentObject.zzpaymentmethod;paymentOnFile.cardType=paymentObject.cctype;paymentOnFile.cardNumber=paymentObject.ccnum;paymentOnFile.cardHolder=paymentObject.accountHolder;paymentOnFile.expiryMonth=paymentObject.cardExpiration.split("/")[0];paymentOnFile.expiryYear=paymentObject.cardExpiration.split("/")[1];paymentOnFile.expirationDate=new Date(Number(paymentOnFile.expiryYear),Number(paymentOnFile.expiryMonth-1),15);paymentOnFile.expiryDate=paymentOnFile.expirationDate;if($scope.orderTransaction){$scope.orderTransaction.paymentDetails=paymentOnFile}$scope.resetCreditCardOnFileSelection();paymentObject.isSelected=true;$scope.paymentErrorMessage="";$scope.$parent.updatePaymentDetails(true,paymentOnFile,true)};$scope.resetCreditCardOnFileSelection=function(){angular.forEach($scope.paymentMetadata.paymentInstruments,function(paymentInstrument){paymentInstrument.isSelected=false})};$scope.resetPaymentForms=function(paymentMethod){if(paymentMethod){$scope.paymentDetails.paymentType=paymentMethod.code}$scope.paymentDetails.cardType=$scope.paymentDetails.cardNumber=$scope.paymentDetails.expiryMonth=$scope.paymentDetails.expiryYear=$scope.paymentDetails.cardHolder="";$scope.paymentDetails.ibaNumber=$scope.paymentDetails.bankName=$scope.paymentDetails.city=$scope.paymentDetails.accountHolder="";$scope.ibanValidateMessage="";$scope.isIbanMesageShow=false;$scope.paymentDetails.ibaNumber=$scope.paymentDetails.bankKey=$scope.paymentDetails.bankName=$scope.paymentDetails.city=$scope.paymentDetails.accountHolder=$scope.paymentDetails.bankCountry=$scope.paymentDetails.bankAccount=$scope.paymentDetails.controlCode="";$scope.paymentDetails.poNumber="";$scope.paymentDetails.bankTransferNumber=""};$scope.resetPaymentTabPanes=function(){$("#payment-details-edit .nav-tabs:first-child").addClass("active");$("#payment-details-edit .tab-pane").removeClass("active");$("#payment-details-edit .tab-pane:first-child").addClass("active");$("#payment-details-edit .nav-tabs #ccof").removeClass("active")};$scope.$watch("paymentDetails",function(){$scope.isPaymentFormValid()},true);$scope.isPaymentFormValid=function(){var result=false;if($scope.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_PAYMENT_TYPE){result=$scope.validateCreditCardForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.CREDIT_CARD_ON_FILE_PAYMENT_TYPE){result=$scope.validateCreditCardOnFileForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.DIRECT_DEBIT_PAYMENT_TYPE){result=$scope.validateDirectDebitForm();$scope.paymentDetails.bankCountry="DE"}else{if($scope.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE){result=$scope.validatePoForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result=$scope.validateBankTransferForm()}else{if($scope.paymentDetails.paymentType==PaymentConstants.CVS_PAYMENT_TYPE){result=$scope.validateCVSPaymentForm()}else{$scope.paymentErrorMessage="Please enter the required fields"}}}}}}if($scope.orderTransaction){$scope.orderTransaction.paymentDetails=$scope.paymentDetails}$scope.$parent.updatePaymentDetails(result,$scope.paymentDetails)};$scope.validateCVSPaymentForm=function(){var result;$scope.paymentErrorMessage="";result=true;return result};$scope.validateBankTransferForm=function(){var result=false,isPufItem=false,isCcmTeam=false;angular.forEach($scope.orderTransaction.items,function(productItem){if(productItem.productType==TransactionConstants.CCM_TEAM_PRODUCT_TYPE){isCcmTeam=true}if(productItem.ispuf=="true"){isPufItem=true}});if(isCcmTeam&&isPufItem&&Number($scope.orderTransaction.totalValue)>PaymentConstants.BT_ORDER_VALUE_VALIDATION){$scope.paymentErrorMessage="For orders this large, please use a different Payment Method."}else{$scope.paymentErrorMessage="";result=true}return result};$scope.validateDirectDebitForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.ibaNumber)||$scope.paymentDetails.ibaNumber==""){$scope.paymentErrorMessage="IBAN Number Is Required"}else{if(!$scope.paymentDetails.isIbanValid||$scope.paymentDetails.verifiedIbaNumber!=$scope.paymentDetails.ibaNumber){$scope.paymentErrorMessage="Validation Of Account Is Required Or IBAN Is Incorrect";$scope.isIbanMesageShow=false}else{if((!angular.isDefined($scope.paymentDetails.mandateId)||$scope.paymentDetails.mandateId=="")&&features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Please select Sepa emandate"}else{if((!angular.isDefined($scope.paymentDetails.bankName)||$scope.paymentDetails.bankName=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="Bank Name Is Required"}else{if((!angular.isDefined($scope.paymentDetails.city)||$scope.paymentDetails.city=="")&&!features.isFeatureEnabled("sepa")){$scope.paymentErrorMessage="City Is Required"}else{if(!angular.isDefined($scope.paymentDetails.accountHolder)||$scope.paymentDetails.accountHolder==""){$scope.paymentErrorMessage="Account Holder Is Required"}else{$scope.paymentErrorMessage="";$scope.isIbanMesageShow=true;result=true}}}}}}return result};$scope.validateCreditCardForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.cardType)||$scope.paymentDetails.cardType==""){$scope.paymentErrorMessage="Card Type Is Required";if($scope.isTokenReceived&&$scope.isPaymentTypeNotMatch){$scope.paymentErrorMessage="The Payment Card Type "+$scope.tokenCardTypeName+"' Is Not Supported For This Country";$scope.isTokenReceived=false}}else{if(!angular.isDefined($scope.paymentDetails.cardNumber)||$scope.paymentDetails.cardNumber==""){$scope.paymentErrorMessage="Token Number Is Required"}else{if(isNaN($scope.paymentDetails.cardNumber)){$scope.paymentErrorMessage="Invalid Characters In Token Number. (Enter Numbers Only.)"}else{if($scope.paymentDetails.cardNumber.toString().length!=PaymentConstants.VALID_TOKEN_LENGTH){$scope.paymentErrorMessage="The Token Number Length Is Invalid"}else{if(!$scope.validateTokenNumber()){$scope.paymentErrorMessage="The Token Number Is Invalid"}else{if(!angular.isDefined($scope.paymentDetails.expiryMonth)||$scope.paymentDetails.expiryMonth==""){$scope.paymentErrorMessage="Expiry Month Is Required"}else{if($scope.paymentDetails.expiryMonth.toString().length>2||isNaN($scope.paymentDetails.expiryMonth)){$scope.paymentErrorMessage="Expiry Month Is Not Valid"}else{if(!angular.isDefined($scope.paymentDetails.expiryYear)||$scope.paymentDetails.expiryYear==""){$scope.paymentErrorMessage="Expiry Year Is Required"}else{if($scope.paymentDetails.expiryYear.toString().length!=4||isNaN($scope.paymentDetails.expiryYear)){$scope.paymentErrorMessage="Expiry Year Is Not Valid"}else{if(!angular.isDefined($scope.paymentDetails.cardHolder)||$scope.paymentDetails.cardHolder==""){$scope.paymentErrorMessage="Cardholder's Name Is Required"}else{$scope.paymentErrorMessage="";result=true}}}}}}}}}}if(!$scope.isPaymentTokenizerShow){$scope.paymentDetails.expirationDate=new Date(Number($scope.paymentDetails.expiryYear),Number($scope.paymentDetails.expiryMonth-1),1);$scope.paymentDetails.paymentType=PaymentConstants.CREDIT_CARD_PAYMENT_TYPE}if($scope.paymentDetails.expiryYear&&$scope.paymentDetails.expiryMonth){$scope.paymentDetails.expirationDate=new Date(Number($scope.paymentDetails.expiryYear),Number($scope.paymentDetails.expiryMonth-1),1)}return result};$scope.validateCreditCardOnFileForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.cardType)||$scope.paymentDetails.cardType==""){$scope.paymentErrorMessage="Select One Of The Payment Information"}else{$scope.paymentErrorMessage="";result=true}return result};$scope.validateDirectDebitAccount=function(){$scope.paymentDetails.isIbanValid=false;PaymentService.validateIBANDetail({ibanDetail:$scope.paymentDetails.ibaNumber}).success(function(result){if(AppUtils.isHavingErrorMessage(result)){$scope.ibanValidateMessage=AppUtils.getErrorMessage(result);$scope.paymentDetails.isIbanValid=false}else{$scope.ibanValidateMessage=AppUtils.getSuccessMessage(result);$scope.paymentDetails.isIbanValid=true;$scope.paymentDetails.verifiedIbaNumber=$scope.paymentDetails.ibaNumber}$scope.isIbanMesageShow=true}).error(function(result){$scope.ibanValidateMessage="Not able to validate"})};$scope.validatePoForm=function(){var result=false;if(!angular.isDefined($scope.paymentDetails.poNumber)||$scope.paymentDetails.poNumber==""){$scope.paymentErrorMessage="PO Number is Required"}else{$scope.paymentErrorMessage="";result=true}return result};$scope.validateTokenNumber=function(){var cardValue=$scope.paymentDetails.cardNumber;var validTokenCharactersAtFirstIndex="0129";if(validTokenCharactersAtFirstIndex.indexOf(cardValue.toString().charAt(0))<0){return false}if(/[^0-9-\s]+/.test(cardValue)){return false}var nCheck=0,nDigit=0,bEven=false;cardValue=cardValue.replace(/\D/g,"");for(var n=cardValue.length-1;n>=0;n--){var cDigit=cardValue.charAt(n),nDigit=parseInt(cDigit,10);if(bEven){if((nDigit*=2)>9){nDigit-=9}}nCheck+=nDigit;bEven=!bEven}return(nCheck%10)==0};$scope.getStorePaymentMetadata=function(){$scope.resetPaymentTabPanes();if(!$scope.storeOrderTransaction.customer){$scope.storeOrderTransaction=$scope.$parent.getStoreTransaction()}var productItems=[];var isPufItem=false;var totalNumberOfCCMTeamPufSeat=0;var isStock=false;if($scope.orderTransaction&&$scope.orderTransaction.items){if($scope.isQuoteToOrder){angular.forEach($scope.orderTransaction.items,function(productItem){if(productItem.ispuf=="true"&&productItem.productType=="CCMT"){totalNumberOfCCMTeamPufSeat=totalNumberOfCCMTeamPufSeat+productItem.quantity}if(productItem.ispuf=="true"){isPufItem=true}if(!isStock){isStock=productItem.stockSku}productItems.push(productItem.productType)})}else{if($scope.storeCart){angular.forEach($scope.orderTransaction.items,function(productItem){if(productItem.ispuf=="true"&&productItem.productType=="CCMT"){totalNumberOfCCMTeamPufSeat=totalNumberOfCCMTeamPufSeat+productItem.quantity}if(productItem.ispuf=="true"){isPufItem=true}if(!isStock){isStock=productItem.stockSku}productItems.push(productItem.productType)})}else{angular.forEach($scope.orderTransaction.items,function(productItem){productItems.push(productItem.productType)})}}}else{if($scope.$parent.storeTransaction.items){angular.forEach($scope.orderTransaction.items,function(productItem){productItems.push(productItem.productType)})}else{console.error("Product Items Not Found, Not Able To Get Payment Metadata")}}var paymentRequestMetadataDto={countryCode:$scope.storeOrderTransaction.customer.address.country.code,transactionType:$scope.storeOrderTransaction.transactionType,productTypes:productItems,paymentMethodCode:0,puf:isPufItem,totalNumberOfCCMTeamPufSeat:totalNumberOfCCMTeamPufSeat,customerNo:$scope.storeTransaction.customer.customerNo,stock:isStock,minSeatForPO:PaymentConstants.PO_MINIMUM_SEAT};PaymentService.getPaymentMetadata(paymentRequestMetadataDto).success(function(result){if(PaymentConstants.JP_DISABLE_BT_PAYMENT_FOR_CCT_PUF){try{if(paymentRequestMetadataDto.countryCode.toUpperCase()=="JP"&&paymentRequestMetadataDto.productTypes&&(paymentRequestMetadataDto.productTypes[0]=="CCMT"||paymentRequestMetadataDto.productTypes[0]=="CCT")){for(var index=0;index<result.paymentMethods.length;index++){if(result.paymentMethods[index].code==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result.paymentMethods.splice(index,1)}}}}catch(err){}}$scope.paymentMetadata=$scope.metadata.paymentMetadata=result;for(var count=0;count<$scope.paymentMetadata.paymentMethods.length;count++){$scope.defaultPaymentMethodCode=$scope.paymentMetadata.paymentMethods[0].code;$scope.paymentDetails.paymentType=$scope.defaultPaymentMethodCode;break}var paymentInstruments=[];if($scope.paymentMetadata.paymentInstruments&&$scope.paymentMetadata.paymentInstruments.length>0){angular.forEach($scope.paymentMetadata.paymentInstruments,function(paymentInstrument){if(!paymentInstruments.expired){paymentInstruments.push(paymentInstrument)}})}$scope.paymentMetadata.paymentInstruments=angular.copy(paymentInstruments);$scope.$parent.$parent.$parent.$parent.hideViewLoading()}).error(function(result){$scope.paymentMetadata=null})};$scope.initializePayment=function(){$scope.$parent.$parent.$parent.$parent.updateLoadingMessage("Initializing Payment");$scope.$parent.$parent.$parent.$parent.showViewLoading();tokenizerFunction();var currentYear=new Date().getFullYear();for(var yearCount=0;yearCount<11;yearCount++){var yearObject={code:currentYear,label:currentYear.toString()};$scope.paymentYears.push(yearObject);currentYear=currentYear+1}$scope.isPaymentTokenizerShow=$rootScope.currentUser.external;$scope.getStorePaymentMetadata()};$scope.$on(StoreConstants.STORE_PAYMENT_INITIALIZE_EVENT,function(event,transactionData){if(transactionData){$scope.orderTransaction=angular.copy(transactionData)}else{$scope.orderTransaction=angular.copy($scope.$parent.storeTransaction)}$scope.paymentDetails.cardHolder=$scope.orderTransaction.customer.firstName+" "+$scope.orderTransaction.customer.lastName;$timeout(function(){$scope.initializePayment()},1000)});var tokenizerFunction=function(){$(window).on("message",function(event){var eventData;eventData=$.parseJSON(event.originalEvent.data);switch(eventData.type){case"tokenReceived":$scope.populateCreditCard(eventData.value);break;case"tokenLoaded":$("#tokenizer-iframe")[0].contentWindow.postMessage($scope.transactionAddress,window.location.origin);break;case"reset":$scope.resetPaymentView();break;case"tokenError":TrackingService.trackPageView("System","Token Failed: "+$scope.currentStore.countryName);AppUtils.sendLogToServer("Payment Token Error : Country - "+$scope.currentStore.countryName+", Customer Name - "+$scope.orderTransaction.customer.firstName+" "+$scope.orderTransaction.customer.lastName+", Email - "+$scope.orderTransaction.customer.email+", Customer Number - "+$scope.orderTransaction.customer.customerNo);break;case"reload":document.getElementById("tokenizer-iframe").src+="";break}});tokenizerFunction=function(){}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngStoreSelector",["$timeout","StoreShortcutsService","Utils","$location","AppUtils",function($timeout,StoreShortcutsService,Utils,$location,AppUtils){return{restrict:"EA",replace:true,templateUrl:"js/store/common/partials/store-selector.html",link:function($scope,element,attrs){$scope.storeSelectorMessages=[];$(element).mouseenter(function(e){$(element).addClass("open");e.preventDefault();return false});$(element).mouseleave(function(e){$(element).removeClass("open");e.preventDefault();return false});$scope.resetEdit=function(){$scope.isEditStore=false;$scope.isDeleteStore=false;$scope.storeSelectorMessages=[];if(!$scope.isStoreUpdated){$scope.refreshShortcuts()}};$scope.editStore=function(){$scope.storeSelectorMessages=[];$scope.isEditStore=!$scope.isEditStore;if($scope.isDrStoreDisplay){$scope.isDrStoreDisplay=false;$("#allBtn").addClass("btn-active")}$scope.getStores()};$scope.removeStoreItem=function(storeItem){$scope.isDeleteStore=true;for(var i=0;i<$scope.storeShortcutResult.length;i++){if(storeItem.name==$scope.storeShortcutResult[i].name&&storeItem.countryCode==$scope.storeShortcutResult[i].countryCode){console.log("Store to remove",storeItem.country);$scope.storeShortcutResult.splice(i,1);break}}};$scope.makeAsDefaultStore=function($event){$scope.isMakeDefaultStore=true};$scope.addStore=function(){};$scope.isStoreUpdated=false;$scope.isLoading=false;$scope.saveStoreChanges=function(){$scope.storeSelectorMessages=[];$scope.isLoading=true;$scope.storeListToUpdate=$scope.getUpdatedStoreList();StoreShortcutsService.updateShortcuts($scope.storeListToUpdate).success(function(response){console.log("Updated Stores",response);angular.forEach($scope.storeListToUpdate,function(enabledCountry){$scope.enabledCountry=enabledCountry;if(enabledCountry.storeType=="COM"){enabledCountry.isEnable=AppUtils.isCommercialStore(enabledCountry.countryCode)}else{enabledCountry.isEnable=AppUtils.isEducationalStore(enabledCountry.countryCode)}});$scope.isLoading=false;$scope.isStoreUpdated=true;$scope.isEditStore=false;$scope.storeShortcutResult=$scope.storeListToUpdate;$scope.storeSelectorMessages=Utils.showMessage("success","Stores saved.")}).error(function(error){$scope.isLoading=false;console.log("Error in updating stores",error);$scope.resetEdit();$scope.storeSelectorMessages=Utils.showMessage("error","Error in updating stores. Please try again")})};$scope.cancelStoreEdit=function(){$scope.isEditStore=!$scope.isEditStore;$scope.resetEdit()};$scope.closeStoreActions=function(){$scope.storeSelectorMessages=[];$("#storeSelectorDropDown").removeClass("open")};$scope.goToStore=function(store){$(element).removeClass("open");window.location.reload()};$scope.getStores=function(){$scope.isLoading=true;$scope.allStoreShortcutResult=[];StoreShortcutsService.getStores().success(function(result){$scope.allStoreShortcutResult=result;for(var i=0;i<$scope.allStoreShortcutResult.length;i++){$scope.allStoreShortcutResult[i].isSelected=false;for(var j=0;j<$scope.storeShortcutResult.length;j++){if($scope.allStoreShortcutResult[i].storeName==$scope.storeShortcutResult[j].name&&$scope.allStoreShortcutResult[i].countryCode==$scope.storeShortcutResult[j].countryCode){$scope.allStoreShortcutResult[i].isSelected=true;break}}}$scope.isLoading=false}).error(function(error){console.log("Error in loading stores",error);$scope.isLoading=false})};$scope.getUpdatedStoreList=function(){var i=$scope.allStoreShortcutResult.length;while(i--){$scope.allStoreShortcutResult[i].country=$scope.allStoreShortcutResult[i].countryName;$scope.allStoreShortcutResult[i].name=$scope.allStoreShortcutResult[i].storeName;if($scope.allStoreShortcutResult[i].isSelected==false){$scope.allStoreShortcutResult.splice(i,1)}else{delete $scope.allStoreShortcutResult[i].isSelected}}return $scope.allStoreShortcutResult}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("StoreShortcutsService",["$http",function($http){var service={};service.getShortcuts=function(){return $http({method:"POST",url:"../storeShortcutsService/getShortcuts.do?"+Math.random(),headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.updateShortcuts=function(data){return $http({method:"POST",url:"../storeShortcutsService/updateShortcuts.do?"+Math.random(),data:data})};service.getStores=function(data){return $http({method:"POST",url:"../storeShortcutsService/getStores.do?"+Math.random(),headers:{"Content-Type":"application/x-www-form-urlencoded"},cache:true})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("StoreTransactionController",["$scope","$log","$rootScope","$location","$routeParams","StoreConstants","StoreUtil","$http","AppUtils","AppConstants","$timeout","StoreTransactionService","MetadataService","ImsCustomerService","PaymentConstants","CommerceServices",function($scope,$log,$rootScope,$location,$routeParams,StoreConstants,StoreUtil,$http,AppUtils,AppConstants,$timeout,StoreTransactionService,MetadataService,ImsCustomerService,PaymentConstants,CommerceServices){$scope.storeOrderTransaction;$scope.storeOrderReviewTransaction;$scope.orderReasons;$scope.orderReasonCode={selectedId:null};$scope.customerDataReceived;$scope.isPromoApplied=false;$scope.isPromoAppliedRemoved=false;$scope.promoItem;$scope.$on(StoreConstants.STORE_ADDRESS_VALIDATION_UPDATE_EVENT,function(event,customerData){$scope.customerDataReceived=customerData;if(($scope.isFOCOrderWithFreeShipping||$scope.isFOCOrderWithPaidShipping)&&$scope.deliveryMethodShouldBeEnable){$scope.goToWizardStep(StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS);$rootScope.$broadcast(StoreConstants.LOAD_DELIVERY_METHOD_FOR_REGION,$scope.$parent.transactionAddress)}else{if($scope.isCreateQuote&&$scope.deliveryMethodShouldBeEnable){$scope.goToWizardStep(StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS);$rootScope.$broadcast(StoreConstants.LOAD_DELIVERY_METHOD_FOR_REGION,$scope.$parent.transactionAddress)}else{if($scope.isZcorProductFound&&$scope.deliveryMethodShouldBeEnable){$scope.goToWizardStep(StoreConstants.WIZARD_DELIVERY_METHOD_PROCESS);$rootScope.$broadcast(StoreConstants.LOAD_DELIVERY_METHOD_FOR_REGION,$scope.$parent.transactionAddress)}else{$scope.constructAndReviewTransactionDetail()}}}});$rootScope.$on(StoreConstants.UPDATE_DELIVERY_METHOD_TO_TRANSACTION_EVENT,function(event,deliveryDetail){$scope.storeDeliveryMethodDetail=deliveryDetail;$scope.constructAndReviewTransactionDetail()});$rootScope.$on(StoreConstants.PROMO_CODE_APPLIED_ON_LINE_ITEM,function(event,promoItem){$scope.isPromoApplied=true;$scope.promoItem=promoItem;$scope.constructAndReviewTransactionDetail()});$rootScope.$on(StoreConstants.PROMO_CODE_REMOVED_ON_LINE_ITEM,function(event,promoRemovedItem){$scope.isPromoAppliedRemoved=true;$scope.promoRemovedItem=promoRemovedItem;$scope.constructAndReviewTransactionDetail()});$scope.constructAndReviewTransactionDetail=function(){$scope.customerDetails=angular.copy($scope.customerDataReceived);if(!$scope.isQuoteToOrder){if($scope.isPromoApplied){angular.forEach($scope.storeCart.items,function(storeItem){if(storeItem.sku==$scope.promoItem.sku){storeItem.promoCode=$scope.promoItem.promoCode;$scope.isPromoApplied=false}})}if($scope.isPromoAppliedRemoved){angular.forEach($scope.storeCart.items,function(storeItem){if(storeItem.sku==$scope.promoRemovedItem.sku){storeItem.promoCode="";$scope.isPromoAppliedRemoved=false}})}}if($scope.isQuoteToOrder){if($scope.isPromoApplied){angular.forEach($scope.quoteTransaction.items,function(quoteItem){if(quoteItem.sku==$scope.promoItem.sku){quoteItem.promoCode=$scope.promoItem.promoCode;$scope.isPromoApplied=false}})}if($scope.isPromoAppliedRemoved){angular.forEach($scope.quoteTransaction.items,function(quoteItem){if(quoteItem.sku==$scope.promoRemovedItem.sku){quoteItem.promoCode="";$scope.isPromoAppliedRemoved=false}})}$scope.storeOrderTransaction=StoreUtil.convertQuoteToOrderTransaction($scope.quoteTransaction)}else{$scope.storeOrderTransaction=StoreUtil.createDefaultTransaction($scope.customerDetails,$scope.storeCart)}if($scope.deliveryMethodShouldBeEnable){$scope.storeOrderTransaction.deliveryIndication=$scope.storeDeliveryMethodDetail.deliveryIndication;$scope.storeOrderTransaction.deliveryMethod=$scope.storeDeliveryMethodDetail.label;$scope.storeOrderTransaction.deliveryMethodCode=$scope.storeDeliveryMethodDetail.partner}if($scope.isFOCOrderWithFreeShipping){$scope.storeOrderTransaction.transactionType=StoreConstants.TRANSACTION_FOC_WITH_FREE_SHIPPING}else{if($scope.isFOCOrderWithPaidShipping){$scope.storeOrderTransaction.transactionType=StoreConstants.TRANSACTION_FOC_WITH_PAID_SHIPPING;$scope.storeOrderTransaction.freeOfCharge=true}else{$scope.storeOrderTransaction.transactionType=StoreUtil.getTransactionType($scope.metadata.orderTypes,$scope.storeOrderTransaction.items[0].productType,$scope.$parent.salesTransactonType)}}if($scope.$parent.isSFDCFLow){if(angular.isDefined($scope.$parent.accountDetails)&&$scope.$parent.accountDetails.Name){$scope.storeOrderTransaction.teamName=$scope.$parent.accountDetails.Name}}$scope.orderReasons=MetadataService.getMetadataList($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],$scope.storeOrderTransaction.transactionType,MetadataService.INDEX_NAMES.ORDER_TYPE);$scope.storeOrderTransaction.isCcmTeamTransaction=StoreUtil.isCcmTeamOrder($scope.storeOrderTransaction.items);$scope.storeOrderTransaction.isSubscriptionTransaction=StoreUtil.isSubscription($scope.storeOrderTransaction.transactionType);$scope.storeOrderTransaction.isAdobeStock=StoreUtil.isAdobeStock($scope.storeOrderTransaction.items);$scope.$parent.updateStoreTransaction($scope.storeOrderTransaction);$scope.reviewTransactionBeforePayment()};$scope.$on(StoreConstants.STORE_PAYMENT_REVIEW_EVENT,function(event){$scope.updateLoadingMessage("Reviewing Payment");$scope.$parent.showViewLoading();$scope.reviewTransactionWithPayment()});$scope.$on(StoreConstants.STORE_QUOTE_TO_ORDER_EVENT,function(event){$scope.getQuoteTransaction()});$scope.getQuoteTransaction=function(){StoreTransactionService.getTransaction({guid:"",number:$scope.quoteId}).success(function(result){$scope.$parent.updateQuoteTransaction(result)}).error(function(result){})};$scope.checkTermsAndConditions=function(){if(!$scope.storeTransaction.termsAndConditionsList||$scope.storeTransaction.termsAndConditionsList.length==0){return}$scope.updateLoadingMessage("Loading T&C");$scope.$parent.showViewLoading();var tncSuccessCount=0;angular.forEach($scope.storeTransaction.termsAndConditionsList,function(tncItem){tncItem.isTncLoading=tncItem.isTncDataSuccess=true;if(($scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE||$scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.DEBIT_CARD_PAYMENT_TYPE||$scope.storeTransaction.paymentDetails.paymentType==PaymentConstants.PO_PAYMENT_TYPE)&&$scope.storeTransaction.items[0].ispuf=="true"&&$scope.storeOrderTransaction.isCcmTeamTransaction){ImsCustomerService.getTncByTemplate({templateName:AppUtils.getTemplateName($scope.storeTransaction,$scope.currentStore),locale:StoreUtil.getDefaultCountryLanguage($scope.currentStore.countryCode)}).success(function(result){tncSuccessCount=tncSuccessCount+1;if(result!=""){var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText}tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true;if(tncSuccessCount==$scope.storeTransaction.termsAndConditionsList.length){$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("")}}).error(function(result){tncItem.isTncLoading=false;tncItem.isTncDataSuccess=false;$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("");AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.currentStore.countryName+"("+$scope.currentStore.crmStoreName+") for SKU = "+tncItem.productId)})}else{CommerceServices.searchBySku({sku:tncItem.productId,country:$scope.currentStore.countryCode,market_segment:$scope.currentStore.storeType}).success(function(data,status,headers,config){if(data&&data.sellableItem&&data.sellableItem.terms_and_conditions_service_name){ImsCustomerService.getTncByTemplate({templateName:AppUtils.checkSKUForPredefinedTemplate()?"tc_cm_complete_anu":data.sellableItem.terms_and_conditions_service_name,locale:StoreUtil.getDefaultCountryLanguage($scope.currentStore.countryCode)}).success(function(result){tncSuccessCount=tncSuccessCount+1;var tncText=result.tc[0].text;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText;tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true;if(tncSuccessCount==$scope.storeTransaction.termsAndConditionsList.length){$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("")}}).error(function(result){tncItem.isTncLoading=false;tncItem.isTncDataSuccess=false;$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("");AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.currentStore.countryName+"("+$scope.currentStore.crmStoreName+") for SKU = "+tncItem.productId)})}else{tncItem.isTncLoading=tncItem.isTncDataSuccess=false;$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("");AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.currentStore.countryName+"("+$scope.currentStore.crmStoreName+") for SKU = "+tncItem.productId)}}).error(function(data,status,headers,config){tncItem.isTncDataSuccess=false;tncItem.isTncLoading=false;$scope.$parent.hideViewLoading();$scope.updateLoadingMessage("");AppUtils.sendLogToServer("The eCommerce Template API Failed for "+$scope.currentStore.countryName+"("+$scope.currentStore.crmStoreName+") for SKU = "+tncItem.productId)})}})};$scope.reloadTnc=function(tncItem){tncItem.isTncLoading=tncItem.isTncDataSuccess=true;StoreTransactionService.getTncBySku({sku:tncItem.productId,storeId:$scope.currentStore.storeKey,language:StoreUtil.getDefaultCountryLanguage($scope.currentStore.countryCode)}).success(function(result){var tncText=result;var strRegEx_cs_support=/<a/gi;var strRegEx_support=/<\/a/gi;tncText=tncText.replace(strRegEx_cs_support,"<span");tncText=tncText.replace(strRegEx_support,"</span");tncItem.newText=tncText;tncItem.isTncLoading=false;tncItem.isTncDataSuccess=true}).error(function(result){tncItem.isTncLoading=tncItem.isTncDataSuccess=false;AppUtils.sendLogToServer("The Java T&C Service Failed for "+$scope.currentStore.countryName+"("+$scope.currentStore.crmStoreName+") for SKU = "+tncItem.productId)})};$scope.reviewTransactionBeforePayment=function(){$scope.updateLoadingMessage("Reviewing Details");$scope.$parent.showViewLoading();if($scope.$parent.isFOCOrderWithFreeShipping||$scope.$parent.isCreateQuote){$scope.storeTransaction.paymentDetails.cardHolder="";$scope.storeTransaction.paymentDetails.paymentType=""}StoreTransactionService.review($scope.storeTransaction).success(function(result){$scope.$parent.hideViewLoading();if(StoreUtil.isTransactionHavingErrorMessage(result.messages)){$("#orderReviewModal").modal("show");$scope.$parent.transactionReviewUpdate(result)}else{if($scope.isFOCOrderWithFreeShipping){$scope.storeOrderReviewTransaction=angular.copy(result);StoreUtil.updateSkuDataToCrmItems($scope.storeTransaction.items,$scope.storeOrderReviewTransaction.items);if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.country){$scope.storeOrderReviewTransaction.billingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.billingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.stateName){$scope.storeOrderReviewTransaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.billingAddress.country.code,$scope.storeOrderReviewTransaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.country){$scope.storeOrderReviewTransaction.shippingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.stateName){$scope.storeOrderReviewTransaction.shippingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,$scope.storeOrderReviewTransaction.shippingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}$scope.$parent.updateStoreTransaction($scope.storeOrderReviewTransaction);$scope.goNextToOrderPlacement()}else{$scope.storeOrderReviewTransaction=angular.copy(result);StoreUtil.updateSkuDataToCrmItems($scope.storeTransaction.items,$scope.storeOrderReviewTransaction.items);if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.country){$scope.storeOrderReviewTransaction.billingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.billingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.stateName){$scope.storeOrderReviewTransaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.billingAddress.country.code,$scope.storeOrderReviewTransaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}if($scope.$parent.deliveryMethodShouldBeEnable){if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.country){$scope.storeOrderReviewTransaction.shippingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.stateName){$scope.storeOrderReviewTransaction.shippingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,$scope.storeOrderReviewTransaction.shippingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}}$scope.$parent.updateStoreTransaction($scope.storeOrderReviewTransaction);$rootScope.$broadcast(StoreConstants.STORE_PAYMENT_INITIALIZE_EVENT,$scope.$parent.storeOrderTransaction);if($scope.isCreateQuote){$scope.goNextToOrderPlacement()}else{$scope.goNextToPayment()}}}}).error(function(result){console.log(result)})};$scope.reviewTransactionWithPayment=function(){StoreTransactionService.review($scope.storeTransaction).success(function(result){if(StoreUtil.isTransactionHavingErrorMessage(result.messages)){$("#orderReviewModal").modal("show");$scope.$parent.transactionReviewUpdate(result)}else{$scope.storeOrderReviewTransaction=angular.copy(result);StoreUtil.updateSkuDataToCrmItems($scope.storeTransaction.items,$scope.storeOrderReviewTransaction.items);$scope.storeOrderReviewTransaction.paymentDetails=angular.copy($scope.$parent.storeTransaction.paymentDetails);if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.country){$scope.storeOrderReviewTransaction.billingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.billingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.billingAddress&&$scope.storeOrderReviewTransaction.billingAddress.stateName){$scope.storeOrderReviewTransaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.billingAddress.country.code,$scope.storeOrderReviewTransaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}if($scope.$parent.deliveryMethodShouldBeEnable){if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.country){$scope.storeOrderReviewTransaction.shippingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME)}if($scope.storeOrderReviewTransaction.shippingAddress&&$scope.storeOrderReviewTransaction.shippingAddress.stateName){$scope.storeOrderReviewTransaction.shippingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.storeOrderReviewTransaction.shippingAddress.country.code,$scope.storeOrderReviewTransaction.shippingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}}$scope.$parent.hideViewLoading();$scope.$parent.updateStoreTransaction($scope.storeOrderReviewTransaction);$scope.checkTermsAndConditions();$scope.$parent.goNextFromPayment()}}).error(function(result){console.log(result)})};$scope.toggleClassName=function(eventTarget){for(var toggle=0;toggle<$scope.storeOrderReviewTransaction.termsAndConditionsList.length;toggle++){if(eventTarget===toggle){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-minus pull-right")}else{if(angular.isNumber(eventTarget)){$("#toggle"+toggle).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right")}}}};$scope.toggleClassOnGlyphClick=function(eventTarget){for(var toggle=0;toggle<$scope.storeOrderReviewTransaction.termsAndConditionsList.length;toggle++){if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-plus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-minus pull-right");$("#collapse"+toggle).collapse("show")}else{if(eventTarget===toggle&&$("#toggle"+eventTarget).find("i").first().hasClass("glyphicon-minus")){$("#toggle"+eventTarget).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}else{if(angular.isNumber(eventTarget)){$("#toggle"+toggle).find("i").first().removeClass().addClass("glyphicon glyphicon-plus pull-right");$("#collapse"+toggle).collapse("hide")}}}}};$scope.$watch("orderReasonCode.selectedId",function(){if($scope.orderReasonCode.selectedId!=null&&$scope.orderReasonCode.selectedId!=""){$scope.$parent.updateOrderReason($scope.orderReasonCode.selectedId)}},true);$scope.updateTermsAndConditionsAsTrue=function(termsAndConditions,collapseId){termsAndConditions.termsAndConditionsAccepted=true;$scope.toggleTnCPanel(collapseId);$scope.updateTermsAndConditionsStatus()};$scope.collapseTnCPanel=function(collapseId){$("#collapse"+collapseId).collapse("toggle")};$scope.toggleTnCPanel=function(collapseId){$scope.toggleClassName(collapseId);$scope.collapseTnCPanel(collapseId);collapseId--;$scope.collapseTnCPanel(collapseId)};$scope.updateTermsAndConditionsStatus=function(){for(var count=0;count<$scope.storeTransaction.termsAndConditionsList.length;count++){if(!$scope.storeTransaction.termsAndConditionsList[count].termsAndConditionsAccepted){$scope.storeTransaction.termsAndConditionsAccepted=false;$scope.$parent.updateTermsAndConditions(false,$scope.storeTransaction.termsAndConditionsList);break}else{if(count==$scope.storeTransaction.termsAndConditionsList.length-1){$scope.storeTransaction.termsAndConditionsAccepted=true;$scope.$parent.updateTermsAndConditions(true,$scope.storeTransaction.termsAndConditionsList);$scope.$parent.goNextFromTermsAndConditions()}}}};$scope.$on(StoreConstants.STORE_ORDER_PLACEMENT_EVENT,function(event){$scope.placeOrder()});$scope.placeOrder=function(){if($scope.isCreateQuote){$scope.updateLoadingMessage("Placing Quote")}else{$scope.updateLoadingMessage("Placing Order")}$scope.$parent.showViewLoading();if($scope.isQuoteToOrder){StoreUtil.convertQuoteToOrderTransactionFromReview($scope.storeTransaction,$scope.quoteTransaction)}if($scope.orderReasonCode.selectedId!=""){$scope.storeTransaction.reason.code=$scope.orderReasonCode.selectedId}StoreTransactionService.create($scope.storeTransaction).success(function(result){$scope.$parent.placeOrderComplete(result);$scope.$parent.hideViewLoading();$("#orderStatusModal").modal("show");if(angular.isDefined($scope.storeTransaction.goCartID)&&$scope.storeTransaction.goCartID.length>0){$timeout(function(){var productSku=$scope.storeTransaction.items[0].sku;var returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.storeTransaction.customer.customerNo+"&tempId="+AppConstants.TEMPLATE_GO_CART_CS_CASE+"&productSku="+productSku+"&orderNumber="+result.transactionNumber+"&gid="+$scope.storeTransaction.goCartID+"&gidSN="+$scope.serialNumberForCase;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl,"_blank")},1000)}}).error(function(result){console.log(result)})}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("StoreTransactionService",["$http",function($http){var service={};service.review=function(data){return $http({method:"POST",url:"../transactionService/review.do",data:data})};service.create=function(data){return $http({method:"POST",url:"../transactionService/create.do",data:data})};service.getTransaction=function(data){return $http({method:"POST",url:"../transactionService/getTransaction.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTncBySku=function(data){return $http({method:"POST",url:"../transactionService/getTermsAndConditionsBySku.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,transformResponse:function(data,headers){return data},responseType:"text",data:data})};service.getTncByTemplate=function(data){return $http({method:"POST",url:"../transactionService/getTermsAndConditionsByTemplateName.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,transformResponse:function(data,headers){return data},responseType:"text",data:data})};service.getQuoteDetails=function(quoteId){return $http({method:"GET",url:"../transactionService/getOnlineQuote.do",params:{onlineQuoteId:quoteId}})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("StoreUtil",["$rootScope","StoreConstants","TransactionConstants","PaymentConstants","TransactionBuilder","CatalogProductDto","CatalogProductSkuDto","StoreDto","AppUtils",function($rootScope,StoreConstants,TransactionConstants,PaymentConstants,TransactionBuilder,CatalogProductDto,CatalogProductSkuDto,StoreDto,AppUtils){this.getCurrentStoreData=function(storeName,country,store){var storeCountry=angular.uppercase(storeName);var storeDto=angular.copy(StoreDto);if(storeCountry==country.code){storeDto.selling=country.selling}if(storeCountry==store.countryCode){storeDto.countryCode=store.countryCode;storeDto.countryName=store.countryName;storeDto.storeKey=store.key;storeDto.region=store.regionId;storeDto.storeName=storeName;storeDto.crmStoreName=store.storeName;storeDto.storeType=store.storeType;storeDto.storeTypeName=store.storeType==StoreConstants.COMMERCIAL_STORE_TYPE?StoreConstants.COMMERCIAL_STORE_NAME:StoreConstants.EDUCATIONAL_STORE_NAME;storeDto.isEduStore=store.storeType==StoreConstants.COMMERCIAL_STORE_TYPE?false:true;storeDto.locale=this.getCountryLocale(store.countryCode)}return storeDto};this.getCountryLocale=function(countryCode){var defaultLocale="EN";if(angular.uppercase(StoreConstants.COUNTRIES_LOCALE).indexOf(countryCode)>=0){defaultLocale=StoreConstants.COUNTRIES_LOCALE.substr(StoreConstants.COUNTRIES_LOCALE.indexOf(countryCode)+3,2)}return defaultLocale};this.getDefaultCountryLanguage=function(countryCode){var defaultLocale="EN";if(angular.uppercase(StoreConstants.RECORDS_DEFAULT_COUNTRIES_LANGUAGE).indexOf(angular.uppercase(countryCode)+":")>=0){defaultLocale=StoreConstants.RECORDS_DEFAULT_COUNTRIES_LANGUAGE.substr(StoreConstants.RECORDS_DEFAULT_COUNTRIES_LANGUAGE.indexOf(countryCode.toUpperCase()+":")+3,2)}return defaultLocale};this.getStoreDylanCatalogProducts=function(products){var catalogProducts=[];angular.forEach(products,function(product){var catalogProductDto=angular.copy(CatalogProductDto);catalogProductDto.name=product.NAME;catalogProductDto.uniqueIdentifier=product.PATH;catalogProductDto.boxImage="http://www.adobe.com/"+product.BOXSHOTTHUMBNAIL;catalogProductDto.configuratorImage="http://www.adobe.com/"+product.BOXSHOT;catalogProducts.push(catalogProductDto)});return catalogProducts};this.isSKUSellableBeforeSKUSearch=function(sku){if(!angular.isDefined(sku)){return true}var notSearchableSKUFromOLDStore=["65260661","65260753","65260754","65260755","65260757"];if(notSearchableSKUFromOLDStore.indexOf(sku)>0){return false}else{return true}};this.getStoreCatalogProducts=function(products,currentStore){if(!currentStore.locale){currentStore.locale="EN"}var catalogProducts=[];var currentUrl=AppUtils.getApplicationUrl();var currentDate=moment(new Date());angular.forEach(products,function(product){if(product.startDate&&product.endDate){var productStartDate=moment(product.startDate);var productEndDate=moment(product.endDate);var startDateDifference=currentDate.diff(productStartDate,"minutes");var endDateDifference=currentDate.diff(productEndDate,"minutes");if(startDateDifference>0&&endDateDifference<=0&&(product.environment.indexOf("all")>-1||currentUrl.indexOf(product.environment)>-1)){var catalogProductDto=angular.copy(CatalogProductDto);catalogProductDto.name=product.name[angular.lowercase(currentStore.locale)];catalogProductDto.description=product.description[angular.lowercase(currentStore.locale)];catalogProductDto.categoryPath=product.categoryPath;catalogProductDto.filterIndex=product.filterIndex;catalogProductDto.enable=product.enable;catalogProductDto.inStore=product.inStore;catalogProductDto.sellableCountries=product.sellableCountries;catalogProductDto.restricted=product.restricted;catalogProductDto.img=product.img.indexOf("http")==-1?"https://wwwimages2.adobe.com/content/dam/Adobe/images/"+product.img:product.img;catalogProductDto.isTeam=product.filterIndex.indexOf("team")!=-1?true:false;if(product.img.indexOf("ccm-team.png")>0){catalogProductDto.img=product.img}if(product.environment==""){product.environment="all"}if(catalogProductDto.enable&&catalogProductDto.sellableCountries.indexOf(currentStore.countryCode)>-1){catalogProducts.push(catalogProductDto)}}}else{var catalogProductDto=angular.copy(CatalogProductDto);catalogProductDto.name=product.name[angular.lowercase(currentStore.locale)];catalogProductDto.description=product.description[angular.lowercase(currentStore.locale)];catalogProductDto.categoryPath=product.categoryPath;catalogProductDto.filterIndex=product.filterIndex;catalogProductDto.enable=product.enable;catalogProductDto.inStore=product.inStore;catalogProductDto.sellableCountries=product.sellableCountries;catalogProductDto.restricted=product.restricted;catalogProductDto.img=product.img.indexOf("http")==-1?"https://wwwimages2.adobe.com/content/dam/Adobe/images/"+product.img:product.img;catalogProductDto.isTeam=product.filterIndex.indexOf("team")!=-1?true:false;if(product.img.indexOf("ccm-team.png")>0){catalogProductDto.img=product.img}if(catalogProductDto.enable&&catalogProductDto.sellableCountries.indexOf(currentStore.countryCode)>-1){catalogProducts.push(catalogProductDto)}}});return catalogProducts};this.getStoreCatalogSkuProducts=function(productSkus){var catalogProductSkus=[];angular.forEach(productSkus,function(productSku){var catalogProductSkuDto=angular.copy(CatalogProductSkuDto);catalogProductSkuDto.name=productSku.NAME;catalogProductSkuDto.sku=productSku.SKU;catalogProductSkuDto.platform=productSku.PLATFORM;catalogProductSkuDto.fulfillmentMethod=productSku.FULFILLMENT_METHOD;catalogProductSkuDto.language=productSku.LANGUAGE;catalogProductSkuDto.termType=productSku.TERM_TYPE;catalogProductSkuDto.termTypeLabel=productSku.TERM_TYPE_LABEL;catalogProductSkuDto.distributionType=productSku.DISTRIBUTION_METHOD;catalogProductSkuDto.distributionTypeLabel=productSku.DISTRIBUTION_METHOD_LABEL;catalogProductSkus.push(catalogProductSkuDto)});return catalogProductSkus};this.createDefaultTransaction=function(customer,cart){return TransactionBuilder.create(customer,cart)};this.convertQuoteToOrderTransaction=function(quoteTransaction){var orderTransaction=angular.copy(quoteTransaction);orderTransaction.transactionNumber=null;orderTransaction.referenceTransactionGuid=quoteTransaction.transactionGuid;orderTransaction.referenceTransactionNumber=quoteTransaction.transactionNumber;for(var count=0;count<quoteTransaction.items.length;count++){orderTransaction.items[count].referenceItemGuid=quoteTransaction.items[count].id;orderTransaction.items[count].id=null}return orderTransaction};this.convertQuoteToOrderTransactionFromReview=function(reviewTransaction,quoteTransaction){reviewTransaction.transactionNumber=null;reviewTransaction.referenceTransactionGuid=quoteTransaction.transactionGuid;reviewTransaction.status="E0005";reviewTransaction.referenceTransactionNumber=quoteTransaction.transactionNumber};this.getTransactionType=function(orderTypeMetadata,productType,processType){if(typeof(processType)==="undefined"){processType=TransactionConstants.TRANSACTION_ORDER}var transactionType=TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER;for(var transactionCount=0;transactionCount<orderTypeMetadata.length;transactionCount++){if(orderTypeMetadata[transactionCount].prdtype==productType&&orderTypeMetadata[transactionCount].type==processType){return orderTypeMetadata[transactionCount].proct}}return transactionType};this.getProductTypeFromTransactionItems=function(transactionItems){angular.forEach(transactionItems,function(transactionItem){return transactionItem.productType})};this.isCartContainsPUFProducts=function(cartItems){var isPUFItemAvailable=false;angular.forEach(cartItems,function(item){if(item.puf&&item.prodType=="CCMT"){isPUFItemAvailable=true;return isPUFItemAvailable}});return isPUFItemAvailable};this.isCartContainsNonTeamPUFProducts=function(cartItems){var isNonPUFTeamItemAvailable=false;angular.forEach(cartItems,function(item){if(!item.puf&&item.prodType=="CCMT"){isNonPUFTeamItemAvailable=true;return isNonPUFTeamItemAvailable}});return isNonPUFTeamItemAvailable};this.getDummyPaymentDetails=function(){return TransactionBuilder.createDummyPayment()};this.isOnlyHavingZcor=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].prodType=="ESD"||cartItems[cartItemCount].prodType=="HGD"){return true}}return false};this.isOnlyHavingHardGood=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].prodType=="HGD"){return true}}return false};this.deliveryMethodShouldEnable=function(cartItems){var isHardGoodProductFound=false;var isESDProductFound=false;var flag=false;for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if((cartItems[cartItemCount].prodType=="HGD")){isHardGoodProductFound=true}if((cartItems[cartItemCount].prodType=="ESD")){isESDProductFound=true}}if(isHardGoodProductFound){flag=true}return flag};this.deliveryMethodShouldEnableForOrderFlow=function(cartItems){var isHardGoodProductFound=false;var isESDProductFound=false;var flag=false;for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if((cartItems[cartItemCount].productType=="HGD")){isHardGoodProductFound=true}if((cartItems[cartItemCount].productType=="ESD")){isESDProductFound=true}}if(isHardGoodProductFound){flag=true}return flag};this.isOnlyHavingHDGProductInCart=function(cartItems){var isHardGoodProductFound=false;var isESDProductFound=false;var flag=false;for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if((cartItems[cartItemCount].prodType=="HGD")){isHardGoodProductFound=true}if((cartItems[cartItemCount].prodType=="ESD")){isESDProductFound=true}}if(isHardGoodProductFound&&isESDProductFound){flag=false}if(isHardGoodProductFound&&!isESDProductFound){flag=true}return flag};this.isOnlyHavingStock=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].stock){return true}}return false};this.isOnlyCCMI=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].description.indexOf("CISK")>-1||cartItems[cartItemCount].description.indexOf("CCSN")>-1){return true}}return false};this.isDSPProductFound=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].prodType=="DSP"){return true}}return false};this.hasAdobeStockSmallOrLageDSP=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].stock&&cartItems[cartItemCount].allowedOnlyWithCcmt&&cartItems[cartItemCount].prodType=="DSP"){return true}}return false};this.isOnlyHavingZcorFromQuoteOrder=function(cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].productType=="ESD"||cartItems[cartItemCount].productType=="HGD"){return true}}return false};this.isCcmTeam=function(cartItems){if(cartItems&&cartItems.length>0){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE){return true}}}return false};this.isCreateNewCustomerAllowed=function(cartItems){var flag=true;if(cartItems&&(cartItems.length==1||cartItems.length==2)){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if((cartItems[cartItemCount].stock&&cartItems[cartItemCount].allowedOnlyWithCcmt)){flag=false;if(StoreConstants.DISABLE_CCMI_ELIGIBILITY_CHECK_FOR_SMALL_ANNUAL_STOCK){if(cartItems[cartItemCount].prodType==StoreConstants.DSP_PRODUCT_TYPE){flag=true}}}else{flag=true;return flag}}}return flag};this.SAWithStockRestriction=function(cartItems){var isSAWithStock=false;if(cartItems&&cartItems.length>0){var cartProduct,productNames={};for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){var cartProductName=cartItems[cartItemCount].name;var find=" ";var replaceBy=new RegExp(find,"g");cartProductName=cartProductName.replace(replaceBy,"");if(cartProductName.indexOf("+")>0){cartProduct=cartProductName.split("+");if(!productNames[cartProduct[0]]){productNames[cartProduct[0]]=true}else{isSAWithStock=true}}else{if(productNames[cartProductName]){isSAWithStock=true}else{if(!productNames[cartProductName]){productNames[cartProductName]=true}}}}}return isSAWithStock};this.isOnlyHavingCCMT=function(cartItems){if(cartItems&&cartItems.length>0){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){var allowedOnlyWithCcmtPropertiesAvailbale=false;if(cartItems[cartItemCount].prodType==StoreConstants.CCM_TEAM_PRODUCT_TYPE&&!allowedOnlyWithCcmtPropertiesAvailbale){return true}}}return false};this.isCcmTeamOrder=function(cartItems){if(cartItems&&cartItems.length>0){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){var allowedOnlyWithCcmtPropertiesAvailbale=cartItems[cartItemCount].allowedOnlyWithCcmt;if(allowedOnlyWithCcmtPropertiesAvailbale===undefined||allowedOnlyWithCcmtPropertiesAvailbale===null){allowedOnlyWithCcmtPropertiesAvailbale=false}if(cartItems[cartItemCount].productType==StoreConstants.CCM_TEAM_PRODUCT_TYPE&&!allowedOnlyWithCcmtPropertiesAvailbale){return true}}}return false};this.isAllowedOnlyWithCcmt=function(cartItems){if(cartItems&&cartItems.length>0){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount].allowedOnlyWithCcmt){return true}}}return false};this.isSubscription=function(transactionType){return transactionType==StoreConstants.TRANSACTION_SUBSCRIPTION_ORDER};this.updateTransactionFlags=function(storeTransaction){storeTransaction.isCcmTeamTransaction=this.isCcmTeamOrder(storeTransaction.items);storeTransaction.isSubscriptionTransaction=this.isSubscription(storeTransaction.transactionType)};this.updateSkuDataToCrmItems=function(cartItems,crmProductItems){angular.forEach(crmProductItems,function(crmProduct){angular.forEach(cartItems,function(cartItem){if(cartItem.sku==crmProduct.sku){crmProduct.language=cartItem.language;crmProduct.platform=cartItem.platform;crmProduct.version=cartItem.version;crmProduct.config=cartItem.config;if(cartItem&&cartItem.promoCode&&cartItem.promoCode.length>0){crmProduct.promoCode=cartItem.promoCode}}})})};this.isQuoteTransaction=function(transactionType){if(transactionType==TransactionConstants.TRANSACTION_STANDARD_QUOTATION||transactionType==TransactionConstants.TRANSACTION_QUOTATION){return true}return false};this.isAdobeStock=function(cartItems){if(cartItems&&cartItems.length){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if(cartItems[cartItemCount]&&cartItems[cartItemCount].stock){return true}}}return false};this.validStockSKU=function(sku,cartItems){for(var cartItemCount=0;cartItemCount<cartItems.length;cartItemCount++){if((cartItems[cartItemCount].sku==sku)&&cartItems[cartItemCount].stock){return true}}return false};this.isTransactionHavingErrorMessage=function(messagesList){var havingErrorMessage=false;angular.forEach(messagesList,function(message){if(message.type=="E"){havingErrorMessage=true}});return havingErrorMessage};this.getSkuProductName=function(productName,description){var productDescription=angular.lowercase(description);if(productDescription.indexOf("promo")!=-1){productName=productName+" Promo"}return productName};this.getUpdateDescription=function(storeType,transaction){var description=storeType;description=description.storeType+","+transaction.currencyCode+""+transaction.subtotal;angular.forEach(transaction.items,function(item){description=description+","+item.productType+"-"+getProductNameCode(item.productName)});return description};function getProductNameCode(str){var productNameCode;var ac=str.split(",",1);productNameCode=ac[0];return productNameCode}this.filterSkusFromHendrix=function(currentStore,catalogProduct,skuList){var finalSkuList=[];angular.forEach(skuList,function(sku){if(sku.fullfillmentMethod.fullfillmentMethod=="STOCK_OVERAGE"||sku.fullfillmentMethod.fullfillmentMethod=="STOCK_DEMAND"){}else{if(catalogProduct.restricted&&catalogProduct.restricted.length>0){var restrictionValid=false;for(var catalogCountryCount=0;catalogCountryCount<catalogProduct.restricted.length;catalogCountryCount++){if(angular.isDefined(catalogProduct.restricted[catalogCountryCount][currentStore.countryCode])){var restrictedKeys=catalogProduct.restricted[catalogCountryCount][currentStore.countryCode].keys.split(",");for(var keyCount=0;keyCount<restrictedKeys.length;keyCount++){var keyItem=restrictedKeys[keyCount];var keyItemName=keyItem.split(":")[0];var keyItemValue=keyItem.split(":")[1];if(keyItemName&&(keyItemName==StoreConstants.SKU_FILTER_DISTRIBUTION_METHOD||keyItemName==StoreConstants.SKU_FILTER_TERM_TYPE||keyItemName==StoreConstants.SKU_FILTER_FULFILLMENT_METHOD||keyItemName==StoreConstants.SKU_FILTER_BY_SKU)){if(sku.distributionMethod&&sku.distributionMethod.distributionMethod&&keyItemValue&&(keyItemValue==sku.distributionMethod.distributionMethod)){restrictionValid=true}if(sku.olsServiceCommitment&&sku.olsServiceCommitment.name&&keyItemValue&&(keyItemValue==sku.olsServiceCommitment.name)){restrictionValid=true}if(sku.fullfillmentMethod&&sku.fullfillmentMethod.fullfillmentMethod&&keyItemValue&&(keyItemValue==sku.fullfillmentMethod.fullfillmentMethod)){restrictionValid=true}if(sku.id&&keyItemValue&&(keyItemValue==sku.id)){restrictionValid=true}}}}}if(!restrictionValid){finalSkuList.push(sku)}}else{finalSkuList.push(sku)}}});return finalSkuList};this.filterSkus=function(products,categoryPath,curentStore){var finalSkuList=[];angular.forEach(products,function(product){if(product.product.detail.categoryPath==categoryPath&&product.product.detail.storeName==curentStore.crmStoreName){finalSkuList.push(product.product.skus)}});return finalSkuList};this.initializeDataForConfigurator=function(skuList){angular.forEach(skuList,function(sku){if(sku.olsServiceCommitment.name=="YEAR"){sku.olsServiceCommitment.name="ONE_YEAR"}if(sku.fullfillmentMethod.fullfillmentMethod=="ACBT"&&sku.olsServiceCommitment.name=="NONE"){sku.olsServiceCommitment.name=sku.termType.termType;sku.olsServiceCommitment.description=sku.termType.termLabel}})};this.isConflictSKUExist=function(skuList){var flag=false;for(var i=0,len=skuList.length;i<len;i++){if(skuList[i].conflictSKU.length>0){flag=true;break}}return flag};this.isConflictContractExist=function(messages){var flag=false;if(angular.isDefined(messages)&&angular.isArray(messages)&&messages.length>0){for(var i=0,len=messages.length;i<len;i++){if((messages[i].number==104||messages[i].number==105)&&messages[i].type=="E"){flag=true;break}}}return flag}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("stratificationText",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}MetadataService.getStratificationDescriptions().success(function(response){angular.forEach(response,function(item){if(value==item.id){scope.value=item.value;return}})})})}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("SubscriptionConstants",{SUBSCRIPTION_STATUS_ACTIVE:"ACTIVE",SUBSCRIPTION_STATUS_OPEN:"OPEN",SUBSCRIPTION_STATUS_INACTIVE:"INACTIVE",SUBSCRIPTION_STATUS_PROCESSING:"PROCESSING",SUBSCRIPTION_STATUS_SUSPENDED:"SUSPENDED",SUBSCRIPTION_STATUS_RETRY:"RETRY",SUBSCRIPTION_STATUS_CLOSED:"CLOSED",SUBSCRIPTION_STATUS_SUSPENDED30:"SUSPENDED30",SUBSCRIPTION_STATUS_STOPPED:"STOPPED",SUBSCRIPTION_STATUS_PENDING_PAYMENT:"PENDING_PAYMENT",SUBSCRIPTION_STATUS_PAID:"PAID",SUBSCRIPTION_STATUS_GRACE_PAST_DUE:"GRACE_PAST_DUE",SUBSCRIPTION_STATUS_PAST_DUE:"PAST_DUE",SUBSCRIPTION_STATUS_CANCELLING:"CANCELLING",SUBSCRIPTION_STATUS_CANCELLED:"CANCELLED",SUBSCRIPTION_STATUS_MSG_PENDING_PAYMENT:"Pending Payment",SUBSCRIPTION_STATUS_MSG_PAID:"Paid",SUBSCRIPTION_STATUS_MSG_GRACE_PAST_DUE:"Grace Past Due",SUBSCRIPTION_STATUS_MSG_PAST_DUE:"Past Due",SUBSCRIPTION_STATUS_MSG_CANCELLING:"Cancelling",SUBSCRIPTION_STATUS_MSG_CANCELLED:"Cancelled",SUBSCRIPTION_TRANSACTION_TYPE_PURCHASE:"PURCHASE",SUBSCRIPTION_SOURCE_TYPE_CREDIT_CARD:"CREDIT_CARD",SUBSCRIPTION_SOURCE_TYPE_PURCHASE_ORDER:"PURCHASE_ORDER",SUBSCRIPTION_SOURCE_TYPE_PAYPAL:"PAYPAL",SUBSCRIPTION_SOURCE_TYPE_DIRECT_DEBIT:"DIRECT_DEBIT",SUBSCRIPTION_SOURCE_TYPE_OFFLINE:"OFFLINE",SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE:"REDEMPTION_CODE",SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE_STUDENT:"REDEMPTION_CODE_STUDENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_DIGITAL_RIVER_PAYMENT:"VENDOR_DIGITAL_RIVER_PAYMENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_APPLE_PAYMENT:"VENDOR_APPLE_PAYMENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_GOOGLE_PAYMENT:"VENDOR_GOOGLE_PAYMENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_AMAZON_PAYMENT:"VENDOR_AMAZON_PAYMENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED_PAYMENT:"VENDOR_MANAGED_PAYMENT",SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED:"VENDOR",SUBSCRIPTION_SOURCE_SYSTEM_JEM:"JEM",SUBSCRIPTION_SOURCE_SYSTEM_RSM:"RSM",SUBSCRIPITON_EXTERNAL_REF_NUMBER:"External Ref. Number",SUBSCRIPTION_CONTRACT_ID:"Contract ID",SUBSCRIPTION_ADOBE_STORE:"Adobe Store",SUBSCRIPTION_ADOBE_MANAGED:"Adobe Managed",SUBSCRIPTION_UNMANAGED:"Unmanaged",SUBSCRIPTION_UNMANAGED_APPLE:"Apple / Itunes",SUBSCRIPTION_UNMANAGED_DR:"Digital River",SUBSCRIPTION_UNMANAGED_AMAZON:"Amazon",SUBSCRIPTION_ANDRD:"Android",SUBSCRIPTION_MASTER_CARD:"MasterCard",SUBSCRIPTION_MASTERCARD:"Master Card",SUBSCRIPTION_VISA:"Visa",SUBSCRIPTION_AMEX:"Amex",SUBSCRIPTION_DISCOVER:"Discover",SUBSCRIPTION_JCB:"JCB",SUBSCRIPTION_BT:"BT",SUBSCRIPTION_CVS:"CVS",SUBSCRIPTION_DD:"DD",SUBSCRIPTION_PAYPAL:"PayPal",MESSAGE_ERROR_TYPE:"error",MESSAGE_INFO_TYPE:"info",MESSAGE_WARNING_TYPE:"warning",MESSAGE_SUCCESS_TYPE:"success",MESSAGE_ERROR_TYPE_CODE:"E",MESSAGE_INFO_TYPE_CODE:"I",MESSAGE_WARNING_TYPE_CODE:"W",MESSAGE_SUCCESS_TYPE_CODE:"S",STORE_COMMERCIAL_TYPE:"COM",STORE_EDUCATIONAL_TYPE:"EDU",SUBS_PLAN_CHANGE_REASON:"1",SUBS_PLAN_CHANGE_PLANS:"2",SUBS_PLAN_CHANGE_PREVIEW:"3",SUBS_PLAN_CHANGE_TNC:"4",SUBS_PLAN_CHANGE_FINAL:"5",SUBSCRIPTION_IDENTIFICATION_LABEL:"ZGUID",JP_COUNTRY_CODE:"JP",BANK_TRANSFER_PAYMENT_LABEL:"BT",SUBS_CREDIT_DAYS_REASON:"1",SUBS_CREDIT_DAYS_SAVE:"2",SUBS_CREDIT_DAYS_FINAL:"3",SUBS_CREDIT_DAYS_REASON_SC30:"SC30",SUBS_CREDIT_DAYS_REASON_SC60:"SC60",SUBS_CREDIT_DAYS_REASON_SC30_DESC:"Self-Cancellation 30 Days Extension",SUBS_CREDIT_DAYS_REASON_SC60_DESC:"Self-Cancellation 60 Days Extension",CREDIT_DAYS_CREDIT_REASON_SI:"Service Interruption",CREDIT_DAYS_CREDIT_REASON_TD:"Technical Difficulty",CREDIT_DAYS_CREDIT_REASON_GG:"Goodwill Gesture",CREDIT_DAYS_CREDIT_REASON_CS:"Customer Retention",SUBS_CREDIT_DAYS_REASON_OTHER:"Others",CREDIT_DAYS_SAVE_REASON_ONE_MONTH:"Gave One Month Extension",CREDIT_DAYS_SAVE_REASON_TWO_MONTH:"Gave Two Months Extension",CREDIT_DAYS_SAVE_REASON_MORE:"Gave More than Two Months Extension",CREDIT_DAYS_TRANSACTION_TYPE:"CREDIT",PROMO_DURATION_WEEKS:"WEEKS",PROMO_DURATION_MONTHS:"MONTHS",PROMO_DURATION_WEEK:"WEEK",PROMO_DURATION_MONTH:"MONTH",CREDIT_DAYS_MAX_LIMIT:"93",SUBSCRIPTION_STATUS_TEMPLATES:[{name:"OPEN",code:"OPEN",description:"Internal status. The subscription is in the process of getting created."},{name:"ACTIVE",code:"ACTIVE",description:"Subscription is currently active and recurring billing is active."},{name:"STOPPED",code:"STOPPED",description:"Subscription is active until the next billing date. Billing though, is on hold."},{name:"SUSPENDED",code:"SUSPENDED",description:"Subscription is in grace period. Recurring billing failed (either due to an issue or manual stop on billing)."},{name:"SUSPENDED30",code:"SUSPENDED30",description:"Subscription is inactive. Recurring billing failed (either due to an issue or manual stop on billing)."},{name:"CLOSED",code:"CLOSED",description:"Subscription is closed. Cannot be re-activated."},{name:"INACTIVE",code:"INACTIVE",description:"Subscription is inactive. Cannot be re-activated."}],SUBSCRIPTION_PAYMENT_STATUS_TEMPLATES:[{name:"PAID",code:"PAID",description:"Payment authorized and confirmation has been received by the system."},{name:"PENDING_PAYMENT",code:"PENDING_PAYMENT",description:"Subscription payment awaiting purchase authorization. Adobe is waiting for a payment; customer is not in grace period yet. Can change whenever there is a payment confirmation or grace period logic."},{name:"GRACE_PAST_DUE",code:"GRACE_PAST_DUE",description:"Adobe waited for payment and it did not come. Customer is in grace period now. Can change whenever there is a payment confirmation."},{name:"PAST_DUE",code:"PAST_DUE",description:"This status is set at the end of the 'Grace Past Due' period. Customer's grace period is over - will not have access to the subscription."},{name:"CANCELLING",code:"CANCELLING",description:"This status is set when the subscription is set to be 'Cancelled'.  The actual cancellation will occur at the end of the current payment period."},{name:"CANCELLED",code:"CANCELLED",description:"Subscription has been cancelled. Customer will not have access to the subscription."}],SUBSCRIPTION_CONTRACT_STATUS_TEMPLATES:[{name:"ACTIVE",code:"ACTIVE",description:"Contract is active."},{name:"INACTIVE",code:"INACTIVE",description:"Contract has been closed permanently."}]});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("SubscriptionController",["$scope","$rootScope","$location","$routeParams","TrackingService","SubscriptionConstants","Utils","AppUtils","AppConstants","features","MetadataService","SubscriptionService","PlanchangeService","PaymentConstants","TransactionConstants","SubscriptionUtil","TransactionService",function($scope,$rootScope,$location,$routeParams,TrackingService,SubscriptionConstants,Utils,AppUtils,AppConstants,features,MetadataService,SubscriptionService,PlanchangeService,PaymentConstants,TransactionConstants,SubscriptionUtil,TransactionService){TrackingService.trackPageView("Subscription","Subscription View");$scope.headeredit=false;$scope.unidentifyshow=true;$scope.BACK_TO_SUBSCRIPTION_DETAILS="BACK_TO_SUBSCRIPTION_DETAILS";$scope.SubscriptionConstants=SubscriptionConstants;$scope.PaymentConstants=PaymentConstants;$scope.TransactionConstants=TransactionConstants;$scope.dbStatus=MetadataService.DB_STATUS.NEW;$scope.metadata=new Object();$scope.metadata.subscriptionMetadata=new Object();$scope.subscriptionId=$routeParams.subscriptionId;$scope.customerGuid=$routeParams.subscriptionAccountId;$scope.isCountryChange=(angular.isDefined($routeParams.countryChange)&&$routeParams.countryChange=="true")?true:false;$scope.showSaveSubscriptionAlert=false;$scope.editEmail=false;$scope.emailUpdateMessage="";$scope.emailUpdateSuccess=false;$scope.emailUpdateFailed=false;$scope.showEmailErrorMsg=true;$scope.taxExemptStatus="";$scope.selectedSubscriptionSaveReason;$scope.saveSubscriptionNote;$scope.isSubscriptionSaved=false;$scope.selectedReason="";$scope.selectedCreditReason="";$scope.selectedDays="";$scope.modalMessages="";var errorDetails={};$scope.storeMetadata={};Utils.pageTitle("Subscription [ "+$scope.subscriptionId+" ]");$scope.isLoading=true;$scope.loadingCustomer=true;$scope.isSubscriptionViewValid=true;$scope.isCancelSubscriptionView=false;$scope.disableDropdown=false;$scope.showPaymentDetails=true;$scope.isChangePlanTncButtonDisabled=true;$scope.sesiSubscription=false;$scope.jemSubscriptionMsg=false;$scope.isPromoPeriod=false;var timer;$scope.headerCustomer=new Object();$scope.headerCustomer.isLoading=true;$scope.subscriptionDetails;$scope.originalSubscriptionResult;$scope.customerDetails;$scope.subscriptionType;$scope.transaction=new Object();$scope.transaction.paymentDetails=new Object();$scope.transactionLabel=SubscriptionConstants.SUBSCRIPITON_EXTERNAL_REF_NUMBER;$scope.selectedChangePlan;MetadataService.initializeSubscriptionMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus});$scope.isCountryChangeFLow=function(){return features.isFeatureEnabled("countrychange")&&$scope.isCountryChange};$scope.initializeSubscriptionScreen=function(){$scope.store_type=$scope.subscriptionDetails.marketSegment;console.log($scope.store_type);$scope.countryMetadata=MetadataService.getObjectFromSingleValue($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],MetadataService.INDEX_NAMES.CODE,$scope.countryCode);$scope.storeMetadata=MetadataService.getObjectFromTwoValues($scope.metadata[MetadataService.STORE_NAMES.ALL_STORES],MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.STORE_TYPE,$scope.countryMetadata.code,$scope.store_type);$scope.updateProductImage($scope.subscriptionDetails,$scope.subscriptionDetails.sellableItemSku);SubscriptionService.getSubscriptionMetadata().success(function(result){$scope.metadata.subscriptionMetadata=result}).error(function(result){});if(angular.uppercase($routeParams.viewType)=="CANCELSUBSCRIPTION"&&$scope.subscriptionDetails.isSubscriptionCancelBtnShow){$scope.isCancelSubscriptionView=true}else{$scope.isCancelSubscriptionView=false}};$scope.getCustomerDetails=function(customerGuid){SubscriptionService.getCustomerSearch({customerGuid:customerGuid}).success(function(searchResult){$scope.customerGuid=customerGuid;$scope.customerDetails=searchResult.customerSearchResults[0];AppUtils.loadCustomer($scope.customerDetails.customerNo,$scope.customerDetails.email,$scope.headerCustomer)}).error(function(){$scope.messages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Failed to load customer details")})};$scope.isSavedSubscription=function(subscriptionId){SubscriptionService.isSavedSubscription(subscriptionId).success(function(result){$scope.isSubscriptionSaved=result.STATUS}).error(function(result){})};$scope.searchBySubscriptionId=function(subscriptionId,customerGuid){$scope.isSavedSubscription(subscriptionId);if(typeof $routeParams.CreditDays!=="undefined"&&typeof $routeParams.Reason!=="undefined"){$scope.selectedDays=$routeParams.CreditDays;$scope.selectedCreditReason=$routeParams.Reason;$scope.disableDropdown=true}SubscriptionService.getSubscriptionDetails({subscriptionId:subscriptionId,subscriptionAccountId:customerGuid,locale:""}).success(function(result){timer=setInterval(function(){$scope.subscriptionDetailsFunction(result)},500)}).error(function(result){$scope.isLoading=false;$scope.messages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Failed to load subscription details")})};$scope.subscriptionDetailsFunction=function(result){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){clearInterval(timer);$scope.isLoading=false;if(angular.isObject(result)){$scope.subscriptionDetails=result;$scope.originalSubscriptionResult=angular.copy($scope.subscriptionDetails);$scope.subscriptionDetails.productName=$scope.subscriptionDetails.localizedLongProductDescriptor;$scope.subscriptionDetails.isAddCreditAvailable=true;if(!_.has($scope.subscriptionDetails,"promoData")){$scope.subscriptionDetails.promoData=""}else{var extendedPromoDetail=$scope.subscriptionDetails.promoData.extendedPromoCode.split(":");if(extendedPromoDetail[2].toUpperCase()=="7DAYTRIAL"){var currentDate=moment(new Date());var subCreationDate=moment(new Date($scope.subscriptionDetails.contract.termStartDate));var promoEndDate=moment(subCreationDate,"DD-MM-YYYY").add(7,"days");var endDateDifference=currentDate.diff(promoEndDate,"minutes");if(endDateDifference<0){$scope.isPromoPeriod=true}}if(_.has($scope.subscriptionDetails,"offerPricingData.countryPriceData[0].priceList.price[0].priceWithoutTax")&&_.has($scope.subscriptionDetails,"offerPricingData.countryPriceData[0].priceList.price[0].priceWithTax")&&_.has($scope.subscriptionDetails,"offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithTax")&&_.has($scope.subscriptionDetails,"offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithoutTax")){$scope.subscriptionDetails.offerPricingData.countryPriceData[0].priceList.price[0].priceWithoutTax=$scope.subscriptionDetails.offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithoutTax;$scope.subscriptionDetails.offerPricingData.countryPriceData[0].priceList.price[0].priceWithTax=$scope.subscriptionDetails.offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithTax}}if($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo!==null&&typeof $scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.address!="undefined"){$scope.countryCode=$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.address.country.countryCode}else{if($scope.subscriptionDetails.offerPricingData&&$scope.subscriptionDetails.offerPricingData.countryPriceData[0].country){$scope.countryCode=$scope.subscriptionDetails.offerPricingData.countryPriceData[0].country}else{$scope.countryCode=""}}if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAID)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE}else{if($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_GRACE_PAST_DUE&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED}else{if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30}else{if(($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_INACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED}else{if($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING&&$scope.subscriptionDetails.contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){$scope.subscriptionDetails.status=SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED}else{$scope.subscriptionDetails.status=""}}}}}$scope.getCustomerDetails($scope.customerGuid);if($scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30){$scope.subscriptionDetails.isSubscriptionStartBtnShow=true}else{$scope.subscriptionDetails.isSubscriptionStartBtnShow=false}if(($scope.countryCode==SubscriptionConstants.JP_COUNTRY_CODE&&$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase()=="OFFLINE")||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){$scope.subscriptionDetails.isSubscriptionChangePlanBtnShow=false}else{$scope.subscriptionDetails.isSubscriptionChangePlanBtnShow=true}if($scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PROCESSING){$scope.subscriptionDetails.isSubscriptionCancelBtnShow=true}else{$scope.subscriptionDetails.isSubscriptionCancelBtnShow=false}if(($scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30)&&$scope.subscriptionDetails.paymentStatus.toUpperCase()!=SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){$scope.subscriptionDetails.isSubscriptionAddCreditBtnShow=true}else{$scope.subscriptionDetails.isSubscriptionAddCreditBtnShow=false}if(!$scope.subscriptionDetails.isResumeAvailable&&($scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING||$scope.subscriptionDetails.paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)){$scope.subscriptionDetails.isAddCreditAvailable=false}if(($scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE||$scope.subscriptionDetails.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PROCESSING)&&!$scope.isSubscriptionSaved){$scope.subscriptionDetails.isSubscriptionSavedBtnShow=true}else{$scope.subscriptionDetails.isSubscriptionSavedBtnShow=false}if($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase().indexOf(SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED)!=-1){$scope.subscriptionDetails.isSubscriptionAddCreditBtnShow=false;$scope.subscriptionDetails.isSubscriptionCancelBtnShow=false;$scope.subscriptionDetails.isSubscriptionSavedBtnShow=false;$scope.subscriptionDetails.isSubscriptionChangePlanBtnShow=false;$scope.subscriptionDetails.isSubscriptionStartBtnShow=false}if($scope.subscriptionDetails.contract.termStartDate){$scope.subscriptionDetails.purchaseDate=new Date($scope.subscriptionDetails.contract.termStartDate.toString().substring(0,10));$scope.subscriptionDetails.purchaseDate.setHours($scope.subscriptionDetails.contract.termStartDate.toString().substring(11,13));$scope.subscriptionDetails.purchaseDate.setMinutes($scope.subscriptionDetails.contract.termStartDate.toString().substring(14,16));$scope.subscriptionDetails.purchaseDate.setSeconds($scope.subscriptionDetails.contract.termStartDate.toString().substring(17,19))}else{$scope.subscriptionDetails.purchaseDate=""}if($scope.subscriptionDetails.billingInfo.nextBillingDate){$scope.subscriptionDetails.nextBillingDate=new Date($scope.subscriptionDetails.billingInfo.nextBillingDate.toString().substring(0,10));$scope.subscriptionDetails.nextBillingDate.setHours($scope.subscriptionDetails.billingInfo.nextBillingDate.toString().substring(11,13));$scope.subscriptionDetails.nextBillingDate.setMinutes($scope.subscriptionDetails.billingInfo.nextBillingDate.toString().substring(14,16));$scope.subscriptionDetails.nextBillingDate.setSeconds($scope.subscriptionDetails.billingInfo.nextBillingDate.toString().substring(17,19))}else{$scope.subscriptionDetails.nextBillingDate=""}if($scope.subscriptionDetails.contract.anniversaryDate){$scope.subscriptionDetails.SubExpirationDate=new Date($scope.subscriptionDetails.contract.anniversaryDate.toString().substring(0,10));$scope.subscriptionDetails.SubExpirationDate.setHours($scope.subscriptionDetails.contract.anniversaryDate.toString().substring(11,13));$scope.subscriptionDetails.SubExpirationDate.setMinutes($scope.subscriptionDetails.contract.anniversaryDate.toString().substring(14,16));$scope.subscriptionDetails.SubExpirationDate.setSeconds($scope.subscriptionDetails.contract.anniversaryDate.toString().substring(17,19))}else{$scope.subscriptionDetails.SubExpirationDate=""}$scope.subscriptionDetails.productImg=AppUtils.getProductThumbnailImage($scope.subscriptionDetails.productName);if($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE_STUDENT||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_DIGITAL_RIVER_PAYMENT||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_APPLE_PAYMENT||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_GOOGLE_PAYMENT||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_AMAZON_PAYMENT||$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED_PAYMENT){$scope.sesiSubscription=true}$scope.subscriptionDetails.backupstoreOrderNumber=$scope.subscriptionDetails.storeOrderNumber;if($scope.subscriptionDetails.paymentStatus.toUpperCase()!=SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT){$scope.subscriptionDetails.storeOrderNumber=$scope.subscriptionDetails.contract.externalContractId;$scope.transactionLabel=SubscriptionConstants.SUBSCRIPTION_CONTRACT_ID}$scope.getAccountDetailsBySubscriptionId($scope.subscriptionId);$scope.processsubscriptionDetails();$scope.paymentInfoDetails=SubscriptionUtil.getPaymentType($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo);$scope.cardTypeName=$scope.paymentInfoDetails.cardTypeName;$scope.transaction.paymentDetails=$scope.paymentInfoDetails;if($scope.transaction.paymentDetails.paymentType==0||$scope.transaction.paymentDetails.cardTypeName==""){$scope.showPaymentDetails=false;$scope.subscriptionDetails.isSubscriptionChangePlanBtnShow=false}if($scope.selectedDays!==""&&$scope.selectedCreditReason!==""){if(!$scope.subscriptionDetails.isSubscriptionAddCreditBtnShow){$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_WARNING_TYPE,"Add Credit Days feature is not available for subscriptions in status "+$scope.subscriptionDetails.status.toUpperCase())}$scope.creditDays()}if($scope.isCountryChangeFLow()){$scope.subscriptionDetails.isSubscriptionCancelBtnShow=true;if(angular.uppercase($routeParams.viewType)=="CANCELSUBSCRIPTION"&&$scope.subscriptionDetails.isSubscriptionCancelBtnShow){$scope.isCancelSubscriptionView=true}}}else{$scope.messages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,result+" This subscription is not valid.")}}};$scope.processsubscriptionDetails=function(){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){console.info("Subscription Metadata Initialized Successfully");clearInterval(timer);if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.initializeSubscriptionScreen()}};if(typeof $scope.subscriptionId!="undefined"&&typeof $scope.customerGuid!="undefined"){$scope.searchBySubscriptionId($scope.subscriptionId,$scope.customerGuid)}$scope.getAccountDetailsBySubscriptionId=function(subscriptionGuid){$scope.loadingActionHistory=true;if(!$scope.sesiSubscription){$scope.transactionHistory="";$scope.transactionMessages="";$scope.jemSubscriptionMsg=true}SubscriptionService.getSubscriptionIdByGuid({subscriptionId:subscriptionGuid}).success(function(result){subscriptionAccountId=result.SubscriptionId;SubscriptionService.getActionHistory({subscriptionAccountId:subscriptionAccountId,subscriptionGuid:subscriptionGuid}).success(function(result){$scope.accountDetails=result;for(var notes in $scope.accountDetails){var accountNotes=$scope.accountDetails[notes].note;if(accountNotes&&(accountNotes.contains("With Refund")||accountNotes.contains("With Fee"))){var transactionNumberSearch=accountNotes.split(" ");var transactionNo="";for(var i in transactionNumberSearch){if($.isNumeric(transactionNumberSearch[i])){transactionNo=transactionNumberSearch[i];break}}var hrefLink="#/transaction/"+transactionNo;$scope.accountDetails[notes].note=$scope.accountDetails[notes].note.replace(transactionNo,"<a target='_blank' href='"+hrefLink+"' class='actionHistoryTransactionNo'>"+transactionNo+"</a>")}else{if(accountNotes&&(accountNotes.contains("New Order"))){var transactionNumberSearch=accountNotes.split(" ");orderNumber=transactionNumberSearch[3];var hrefLink="#/transaction/"+orderNumber;$scope.accountDetails[notes].note=$scope.accountDetails[notes].note.replace(orderNumber,"<a target='_blank' href='"+hrefLink+"' class='actionHistoryTransactionNo'>"+orderNumber+"</a>")}}}$scope.loadingActionHistory=false}).error(function(){$scope.accountDetails="";$scope.loadingActionHistory=false;$scope.accountMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_WARNING_TYPE,"Service unavailable! Action history cannot be displayed at this time!")})}).error(function(errorResult){$scope.accountDetails="";$scope.loadingActionHistory=false;$scope.accountMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_WARNING_TYPE,"Service unavailable! Action history cannot be displayed at this time!");AppUtils.sendLogToServer("SubscriptionIdByGuid Failed:"+errorResult.MESSAGE)})};$scope.getSubscriptionTransactions=function(subscriptionId){$scope.loadingTransactionHistory=true;SubscriptionService.getSubscriptionTransactions({subscriptionId:subscriptionId}).success(function(result){if(result.TOTALROWS){$scope.transactionHistory=result.DATA;$scope.loadingTransactionHistory=false}}).error(function(result){$scope.transactionHistory="";$scope.transactionMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_WARNING_TYPE,"Service unavailable! Transaction history cannot be displayed at this time!")})};$scope.updateProductImage=function(item,SKU){var requestProductSearchDto=new Object();requestProductSearchDto.storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};crmSearchObject.sku=SKU;requestProductSearchDto.criteria=crmSearchObject;SubscriptionService.search(requestProductSearchDto).success(function(result){if(result&&result.length==1){$scope.crmData=result[0];item.productImg=AppUtils.getProductThumbnailImageFromCrmDescription($scope.crmData.description)}}).error(function(result){item.productImg="img/products/no-product.png"})};$scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)};$scope.refreshSubscriptionDetails=function(){$("#startSubscriptionModal").modal("hide");$("#changePlanModal").modal("hide");$("#creditDaysModal").modal("hide");$("#transactionHistoryModal").modal("hide");$("#editBiilingSubscriptionModal").modal("hide");$("#saveSubscriptionModal").modal("hide");$location.$$search={};$location.$$compose();$location.path("/subscription/"+$scope.subscriptionId+"/"+$scope.customerGuid);location.reload()};$scope.restartSubscription=function(){$scope.isStartSubscriptionProcessing=false;$scope.modalMessages="";$("#startSubscriptionModal").modal("show")};$scope.closeStartSubscriptionModal=function(){$scope.isStartSubscriptionProcessing=false;$("#startSubscriptionModal").modal("hide")};$scope.startSubscription=function(){$scope.isStartSubscriptionProcessing=true;$scope.startSubscriptionProcessSuccess="";$scope.modalMessages="";SubscriptionService.startSubscription({subscriptionId:$scope.subscriptionId,customerGuid:$scope.customerGuid,locale:$scope.subscriptionDetails.contract.preferredLanguage}).success(function(result,status){if(status==200){console.log("Success SubscriptionService startSubscription "+result);$scope.isStartSubscriptionProcessing=false;$scope.startSubscriptionProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_SUCCESS_TYPE,"Successfully restarted the subscription.")}}).error(function(result){console.log("startSubscription error : "+result);$scope.isStartSubscriptionProcessing=false;$scope.startSubscriptionProcessSuccess=false;errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message)})};$scope.changePlan=function(){console.log("Inside change plan");$scope.modalMessages="";$scope.isServicePlansLoading=true;$("#changePlanModal").modal("show");$scope.offerType="Standard";if($scope.subscriptionDetails.offerId.startsWith("non_sds")){$scope.isServicePlansLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_INFO_TYPE,"There are no plans available for upgrade or downgrade.")}else{SubscriptionService.getSubscriptionMetadata().success(function(result){$scope.metadata.subscriptionMetadata=result;$scope.getChangePlanReason=$scope.metadata.subscriptionMetadata.change_plan_reason;PlanchangeService.getChangePlanOffers({offerId:$scope.subscriptionDetails.offerId,country:$scope.countryCode}).success(function(result){$scope.getServicePlans=SubscriptionUtil.getChangePlanOfferDetails(result.relatedOffers);if($scope.getServicePlans.length>0){console.log("Success PlanchangeService getServicePlans "+result);$scope.isServicePlansLoading=false;$scope.wizardStep=SubscriptionConstants.SUBS_PLAN_CHANGE_REASON;$scope.isValidReason=false;$scope.isValidPlan=false}else{console.log("getChangePlanOffers : "+result);$scope.isServicePlansLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_INFO_TYPE,"There are no plans available for upgrade or downgrade.")}}).error(function(errorResult){console.log("getChangePlanOffers : "+errorResult);errorDetails=SubscriptionUtil.standardErrorMessage(errorResult);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message)})}).error(function(result){})}};$scope.closeChangePlanModal=function(){$("#changePlanModal").modal("hide");$scope.selectedReason="";$scope.selectedPlan="";$scope.modalMessages="";$scope.stockValidationMsg=""};$scope.$watch("selectedReason",function(){if($scope.selectedReason!=null&&$scope.selectedReason!=""){$scope.reasonCodeValidate()}},true);$scope.reasonCodeValidate=function(){console.log($scope.selectedReason);if($scope.selectedReason!==""){$scope.wizardStep=SubscriptionConstants.SUBS_PLAN_CHANGE_PLANS;$scope.isValidReason=true}};$scope.planOptions=function(plan){$scope.selectedPlan=plan.sku;$scope.selectedChangePlan=plan;console.log("selectedPlan "+$scope.selectedPlan);console.log("currentPlanSku "+$scope.currentPlanSku);$scope.stockValidationMsg="";if($scope.selectedPlan!==""){$scope.isValidPlan=true;$scope.isChangePlanPreviewLoading=true;if(plan.displayPrice==""){plan.stockValidationMsg=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Incomplete offer information. Switch is not possible!");return}var requestProductSearchDto=new Object();$scope.crmData=new Object();requestProductSearchDto.storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var crmSearchObject={name:null,sku:null,language:null,mediaType:null,version:null,platform:null,config:null};crmSearchObject.sku=$scope.selectedPlan;requestProductSearchDto.criteria=crmSearchObject;SubscriptionService.search(requestProductSearchDto).success(function(result){if(result&&result.length==1){$scope.crmData=result[0];if($scope.crmData.stock&&$scope.subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory.toUpperCase()=="DIRECT_DEBIT"){plan.stockValidationMsg=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Can not process an Adobe Stock upgrade plan as payment type is Direct Debit. A standalone Adobe Stock plan may be purchase from Hendrix instead.")}else{$scope.wizardStep=SubscriptionConstants.SUBS_PLAN_CHANGE_PREVIEW;PlanchangeService.getChangePlanPreview({subscriptionId:$scope.subscriptionId,offerId:plan.offerId,customerGuid:$scope.customerGuid}).success(function(result){if(angular.isObject(result)){console.log("Success getChangePlanPreview "+result);$scope.isChangePlanPreviewLoading=false;$scope.changePlanPreviewDetails=result;if(typeof $scope.changePlanPreviewDetails.offer.material.data=="undefined"||typeof $scope.changePlanPreviewDetails.offer.material.data.detail=="undefined"){$scope.changePlanPreviewDetails.productImg="img/products/no-product.png"}else{$scope.changePlanPreviewDetails.productImg="https://wwwimages2.adobe.com"+$scope.changePlanPreviewDetails.offer.material.data.detail.primaryImageUrl}if($scope.changePlanPreviewDetails.cancellation.refund.amount.price.priceWithTax){$scope.showRefundMsg="Refund: As per the calculation, a refund amount of "+$scope.changePlanPreviewDetails.cancellation.refund.amount.price.priceWithoutTax+" "+$scope.changePlanPreviewDetails.cancellation.refund.amount.currency.iso3Code+" (exclusive of tax) / "+$scope.changePlanPreviewDetails.cancellation.refund.amount.price.priceWithTax+" "+$scope.changePlanPreviewDetails.cancellation.refund.amount.currency.iso3Code+" (inclusive of tax) will be credited to the payment medium registered."}else{$scope.showRefundMsg="Refund: There will be no refund for this subscription switch"}$scope.paymentInfoDetails=SubscriptionUtil.getPaymentType($scope.subscriptionDetails.billingInfo.paymentInstrumentInfo);$scope.cardTypeName=$scope.paymentInfoDetails.cardTypeName;$scope.transaction.paymentDetails=$scope.paymentInfoDetails;AppUtils.sendLogToServer("Standalone change plan preview success - Subscription GUID : "+$scope.subscriptionId+"Customer GUID : "+$scope.customerGuid+"New Subscription Offer ID:"+plan.offerId)}}).error(function(result){console.log("getChangePlanPreview : "+result);errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);AppUtils.sendLogToServer("Standalone change plan preview failed - Subscription GUID : "+$scope.subscriptionId+"Customer GUID : "+$scope.customerGuid+"New Subscription Offer ID:"+plan.offerId)})}}}).error(function(result){$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Failed to load SKU search.");AppUtils.sendLogToServer("Standalone change plan preview failed - Failed to load SKU search. SKU : "+$scope.selectedPlan)})}};$scope.updatePlan=function(){$scope.wizardStep=SubscriptionConstants.SUBS_PLAN_CHANGE_FINAL;$scope.isServicePlansLoading=true;$scope.isUpdateChangePlanLoading=true;$scope.isUpdateChangePlanSuccess=false;$scope.validationToken=$scope.changePlanPreviewDetails.cancellation.validationToken;$scope.toSubscriptionOfferId=$scope.changePlanPreviewDetails.offerId;console.log($scope.validationToken+" "+$scope.toSubscriptionOfferId+" "+$scope.subscriptionId+" "+$scope.selectedReason+" "+$scope.customerGuid);PlanchangeService.applyPlanChange({validationToken:$scope.validationToken,toSubscriptionOfferId:$scope.toSubscriptionOfferId,subscriptionId:$scope.subscriptionId,reasonCode:$scope.selectedReason,customerGuid:$scope.customerGuid}).success(function(result){if(angular.isObject(result)){console.log("Success change plan service"+result);$scope.isUpdateChangePlanLoading=false;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_SUCCESS_TYPE,"Successfully changed the subscription plan.");$scope.isUpdateChangePlanSuccess=true;AppUtils.sendLogToServer("Standalone change plan success: Subscription GUID :"+$scope.subscriptionId+", Customer GUID : "+$scope.customerGuid+", New Subscription Offer ID :"+$scope.toSubscriptionOfferId+"ReasonCode:"+$scope.selectedReason)}}).error(function(result){console.log("applyPlanChange : "+result);errorDetails=SubscriptionUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);AppUtils.sendLogToServer("Standalone change plan failed: Subscription GUID :"+$scope.subscriptionId+", Customer GUID : "+$scope.customerGuid+", New Subscription Offer ID :"+$scope.toSubscriptionOfferId+"ReasonCode:"+$scope.selectedReason)})};$scope.createTSCase=function(subscriptionDetails){var tenureDate=angular.isDefined(subscriptionDetails.contract.termStartDate)==true?subscriptionDetails.contract.termStartDate.split("T")[0]:"";var returnCaseTemplateUrl="/case/newTs?customerNo="+$scope.customerDetails.customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&subId="+subscriptionDetails.id+"&contextType=INDIVIDUAL&customerGuid="+$scope.customerGuid+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate);window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.createCSCase=function(subscriptionDetails){var tenureDate=angular.isDefined(subscriptionDetails.contract.termStartDate)==true?subscriptionDetails.contract.termStartDate.split("T")[0]:"";var returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.customerDetails.customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&subId="+subscriptionDetails.id+"&contextType=INDIVIDUAL&customerGuid="+$scope.customerGuid+"&tenureDate="+SubscriptionUtil.DateConvertToCrmFormat(tenureDate);window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.creditDays=function(){$scope.isCreditDaysLoading=true;$scope.isApplyCreditSuccess=false;$scope.showNote=false;$scope.note="";if($routeParams.Reason==undefined){$scope.selectedCreditReason=""}if($routeParams.CreditDays==undefined){$scope.selectedDays=""}$scope.selectedSaveReason="";$scope.noCreditDays=[];for(var i=1;i<=SubscriptionConstants.CREDIT_DAYS_MAX_LIMIT;i++){$scope.noCreditDays.push({value:i})}$("#creditDaysModal").modal("show");$scope.creditReasons=[];$scope.creditReasons.push({reasonCode:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_SI,reasonDesc:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_SI});$scope.creditReasons.push({reasonCode:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_TD,reasonDesc:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_TD});$scope.creditReasons.push({reasonCode:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_GG,reasonDesc:SubscriptionConstants.CREDIT_DAYS_CREDIT_REASON_GG});$scope.creditReasons.push({reasonCode:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_OTHER,reasonDesc:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_OTHER});if($scope.disableDropdown){$scope.creditReasons.push({reasonCode:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_SC30,reasonDesc:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_SC30_DESC});$scope.creditReasons.push({reasonCode:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_SC60,reasonDesc:SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_SC60_DESC})}$scope.isCreditDaysLoading=false;$scope.wizardStep=SubscriptionConstants.SUBS_CREDIT_DAYS_REASON};$scope.isFormValidated=function(){if($scope.selectedCreditReason!==SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_OTHER){return $scope.selectedCreditReason&&$scope.selectedDays}else{return $scope.selectedCreditReason&&$scope.selectedDays&&$scope.note}};$scope.validateReasonSelected=function(){if($scope.selectedCreditReason==SubscriptionConstants.SUBS_CREDIT_DAYS_REASON_OTHER){$scope.showNote=true}else{$scope.showNote=false}};$scope.closeCreditDaysModal=function(){$scope.modalMessages="";$("#creditDaysModal").modal("hide")};$scope.applyCredit=function(){console.log($scope.selectedDays);console.log($scope.selectedCreditReason);console.log($scope.customerGuid);console.log($scope.note);$scope.selectedSaveReason="";$scope.isSave=false;$scope.wizardStep=SubscriptionConstants.SUBS_CREDIT_DAYS_FINAL;$scope.isUpdateCreditDaysLoading=true;$scope.isCreditDaysLoading=true;$scope.isApplyCreditSuccess=false;var creditDaysData={customerGuid:$scope.customerGuid,orderNo:$scope.subscriptionDetails.contract.externalContractId,subscriptionAccountID:$scope.subscriptionId,note:$scope.note,isSave:false,saveReasonCode:"",reasonCode:$scope.selectedCreditReason,creditDays:$scope.selectedDays};SubscriptionService.addCreditDays(creditDaysData).success(function(result){$scope.isCreditDaysLoading=false;if(result){if(AppUtils.isHavingErrorMessage(result)){$scope.isApplyCreditSuccess=false;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Failed to load applyCredit");AppUtils.sendLogToServer("Standalone apply credit days failed : Subscription GUID - "+$scope.subscriptionId+" , Customer GUID - "+$scope.customerGuid+", Days -"+$scope.selectedDays)}else{$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_SUCCESS_TYPE,"Successfully applied the credit.");AppUtils.sendLogToServer("Standalone apply credit days success : Subscription GUID - "+$scope.subscriptionId+" , Customer GUID - "+$scope.customerGuid+", Days -"+$scope.selectedDays);$scope.isApplyCreditSuccess=true;$scope.isUpdateCreditDaysLoading=false}}}).error(function(result){$scope.isCreditDaysLoading=false;console.log("applyCredit : "+result);$scope.isApplyCreditSuccess=false;$scope.modalMessages=AppUtils.getSingleMessage(SubscriptionConstants.MESSAGE_ERROR_TYPE,"Failed to load applyCredit");AppUtils.sendLogToServer("Standalone apply credit days failed : Subscription GUID - "+$scope.subscriptionId+" , Customer GUID - "+$scope.customerGuid+", Days -"+$scope.selectedDays)})};$scope.saveSubscription=function(){$scope.showSavingSubscription=true;var subscriptionDetails={subscriptionAccountID:$scope.subscriptionId,saveReasonCode:$scope.selectedSubscriptionSaveReason,customerGuid:$scope.customerGuid,note:$scope.saveSubscriptionNote,eccContractId:$scope.subscriptionDetails.contract.externalContractId,productCode:$scope.subscriptionDetails.productCode};SubscriptionService.saveSubscription(subscriptionDetails).success(function(result){$scope.showSaveSubscriptionAlert=true;if(result.STATUS){$scope.isSubscriptionSaved=true;$scope.showSaveSubscriptionAlertMessage={saveSubscriptionMsgType:"success",saveSubscriptionMsgText:"Subscription saved successfully."}}else{$scope.showSaveSubscriptionAlertMessage={saveSubscriptionMsgType:"failed",saveSubscriptionMsgText:"Failed to save the subscription, please try again."}}}).error(function(result){$scope.showSaveSubscriptionAlert=true;$scope.showSaveSubscriptionAlertMessage={saveSubscriptionMsgType:"failed",saveSubscriptionMsgText:"Connection error. Failed to save the subscription, please try again."}})};$scope.cancelSubscription=function(){if($location.path().indexOf("cancel")==-1){$location.skipReload().path($location.path()+"/cancelsubscription").replace()}$scope.isCancelSubscriptionView=true};$scope.showSaveSubscriptionModal=function(){$("#saveSubscriptionModal").modal("show")};$scope.closeSaveSubscriptionModal=function(){$scope.showSavingSubscription=false;$scope.modalMessages="";$("#saveSubscriptionModal").modal("hide")};$scope.$on($scope.BACK_TO_SUBSCRIPTION_DETAILS,function(event,messages){$scope.isCancelSubscriptionView=false});$scope.getTnc=function(){$scope.wizardStep=SubscriptionConstants.SUBS_PLAN_CHANGE_TNC};$scope.tncStatus=function(isTnCLoaded){$scope.isChangePlanTncButtonDisabled=!isTnCLoaded}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSubscriptionMessages",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{source:"=",modalSource:"="},replace:true,templateUrl:"js/subscription/common/partials/subscription-messages.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants}}}]);app.directive("ngSubscriptionStatus",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{status:"="},replace:true,templateUrl:"js/subscription/common/partials/subscription-status.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants}}}]);app.directive("ngSubscriptionPaymentStatus",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{paymentStatus:"="},replace:true,templateUrl:"js/subscription/common/partials/subscription-payment-status.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants}}}]);app.directive("ngSubscriptionContractStatus",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{contractStatus:"="},replace:true,templateUrl:"js/subscription/common/partials/subscription-contract-status.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants}}}]);app.directive("ngSubscriptionSourceType",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{sourceType:"="},replace:true,templateUrl:"js/subscription/common/partials/subscription-source-type.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants}}}]);app.directive("ngPromoStatus",["$location","SubscriptionConstants",function(location,SubscriptionConstants){return{restrict:"EA",scope:{promoCode:"="},replace:true,templateUrl:"js/subscription/common/partials/promo-status.html",link:function($scope,element,attrs){$scope.SubscriptionConstants=SubscriptionConstants;$scope.$watch("promoCode",function(){if($scope.promoCode&&$scope.promoCode.termValue&&$scope.promoCode.termUnit&&($scope.promoCode.termUnit.toUpperCase()==$scope.SubscriptionConstants.PROMO_DURATION_WEEK||$scope.promoCode.termUnit.toUpperCase()==$scope.SubscriptionConstants.PROMO_DURATION_WEEKS)){$scope.titleDetails=$scope.promoCode.termValue+" Week(s)"}else{if($scope.promoCode&&$scope.promoCode.termValue&&$scope.promoCode.termUnit&&($scope.promoCode.termUnit.toUpperCase()==$scope.SubscriptionConstants.PROMO_DURATION_MONTH||$scope.promoCode.termUnit.toUpperCase()==$scope.SubscriptionConstants.PROMO_DURATION_MONTHS)){$scope.titleDetails=$scope.promoCode.termValue+" Month(s)"}else{if($scope.promoCode&&$scope.promoCode.termUnit&&$scope.promoCode.termValue){$scope.titleDetails=$scope.promoCode.termValue+" "+$scope.promoCode.termUnit}}}})}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("SubscriptionService",["$http",function($http){var service={};var transform=function(data){return $.param(data)};service.getSubscriptionDetails=function(data){return $http({method:"GET",url:"../subscriptionService/getSubscriptionDetails.do",params:{subscriptionId:data.subscriptionId,subscriptionAccountId:data.subscriptionAccountId+"@AdobeID",locale:data.locale,displayPromoData:true}})};service.search=function(data){return $http({method:"POST",url:"../productService/search.do",data:data})};service.getActionHistory=function(data){return $http({method:"GET",url:"../csuiService/getSubscriptionNotes.do",params:{subscriptionAccountId:data.subscriptionAccountId,subscriptionGuid:data.subscriptionGuid}})};service.getSubscriptionIdByGuid=function(data){return $http({method:"GET",url:"../csuiService/getSubscriptionIdByGuid.do",params:{subscriptionGuid:data.subscriptionId}})};service.getCustomerSearch=function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",params:{idNumber:data.customerGuid}})};service.getCustomerDetailsByCustomerNo=function(data){return $http({method:"GET",url:"../customerPreviewService/getCustomerWithoutLocking.do",params:{customerNo:data.customerNo}})};service.getCustomerEmailByOrderNo=function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:transform,data:data})};service.startSubscription=function(data){return $http({method:"POST",url:"../subscriptionService/resumeSubscription.do",params:{subscriptionId:data.subscriptionId,customerGuid:data.customerGuid,locale:data.locale}})};service.addCreditDays=function(data){return $http({method:"POST",url:"../teamProductService/addCreditDays.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.isSavedSubscription=function(data){return $http({method:"GET",url:"../csuiService/isSavedSubscription.do",params:{subscriptionAccountID:data}})};service.saveSubscription=function(data){return $http({method:"GET",url:"../csuiService/saveSubscription.do",params:{subscriptionAccountID:data.subscriptionAccountID,saveReasonCode:data.saveReasonCode,customerGuid:data.customerGuid,note:data.note,eccContractId:data.eccContractId,productCode:data.productCode}})};service.getSubscriptionMetadata=function(){return $http({method:"GET",cache:true,url:"../hx5/json/subscription-metadata.json"})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("SubscriptionUtil",["$rootScope","$routeParams","SubscriptionConstants","CancelSubscriptionDto","ChangePlanDto","AppUtils",function($rootScope,$routeParams,SubscriptionConstants,CancelSubscriptionDto,ChangePlanDto,AppUtils){this.getPaymentType=function(creditCardInfo){console.log(creditCardInfo.CCTYPE);paymentDetails=new Object();if(creditCardInfo.paymentCategory.toUpperCase()=="CREDIT_CARD"){if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="VISA"){paymentDetails.cardTypeName="VISA"}else{if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="MASTER_CARD"){paymentDetails.cardTypeName="MasterCard"}else{if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="AMEX"){paymentDetails.cardTypeName="American Express"}else{if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="JCB"){paymentDetails.cardTypeName="JCB"}else{if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="Switch"){paymentDetails.cardTypeName="Switch"}else{paymentDetails.cardTypeName=""}}}}}paymentDetails.paymentType=2;paymentDetails.cardHolder=creditCardInfo.accountHolderName;paymentDetails.cardNumber=creditCardInfo.maskedAccountNumber;paymentDetails.expirationDate=creditCardInfo.expiryDate}else{if(creditCardInfo.paymentCategory.toUpperCase()=="DIRECT_CREDIT"){paymentDetails.cardTypeName="Debit Card";paymentDetails.paymentType=3}else{if(creditCardInfo.paymentCategory.toUpperCase()=="DIRECT_DEBIT"){paymentDetails.cardTypeName="DD";paymentDetails.paymentType=6;paymentDetails.ibaNumber=creditCardInfo.maskedAccountNumber;paymentDetails.accountHolder=creditCardInfo.accountHolderName}else{if(creditCardInfo.paymentCategory.toUpperCase()=="OFFLINE"){if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="CVS"){paymentDetails.cardTypeName="CVS";paymentDetails.paymentType=4}else{if(creditCardInfo.paymentType&&creditCardInfo.paymentType.toUpperCase()=="BANKTRANSFER"){paymentDetails.cardTypeName="Bank Transfer";paymentDetails.paymentType=5;paymentDetails.accountHolder=creditCardInfo.accountHolderName}}paymentDetails.bankTransferNumber=""}else{if(creditCardInfo.paymentCategory.toUpperCase()=="PAYPAL"){paymentDetails.cardTypeName="PayPal";paymentDetails.paymentType=8;paymentDetails.paypalEmail=creditCardInfo.payerId}else{if(creditCardInfo.paymentCategory=="PO"){paymentDetails.cardTypeName="PO";paymentDetails.paymentType=9;paymentDetails.poNumber=""}else{paymentDetails.cardTypeName="";paymentDetails.paymentType=0}}}}}}return paymentDetails};this.getSubscriptionDto=function(subscriptionDetails){var subscriptionDto=angular.copy(CancelSubscriptionDto);subscriptionDto.id=subscriptionDetails.id;subscriptionDto.productName=subscriptionDetails.localizedLongProductDescriptor;subscriptionDto.sourceType=subscriptionDetails.billingInfo.paymentInstrumentInfo.paymentCategory;subscriptionDto.orderNumber=subscriptionDetails.storeOrderNumber;subscriptionDto.customerNo="";subscriptionDto.sku=subscriptionDetails.sellableItemSku;subscriptionDto.termType=subscriptionDetails.contract.commitmentTerm;subscriptionDto.billingFrequency=subscriptionDetails.billingInfo.billingFrequency;if(typeof subscriptionDetails.offerPricingData=="undefined"||typeof subscriptionDetails.offerPricingData.countryPriceData[0]=="undefined"||typeof subscriptionDetails.offerPricingData.countryPriceData[0].priceList=="undefined"||typeof subscriptionDetails.offerPricingData.countryPriceData[0].priceList.price[0]=="undefined"){subscriptionDto.currencyCode="";subscriptionDto.billingPriceWithTax="";subscriptionDto.billingPriceWithoutTax=""}else{subscriptionDto.currencyCode=subscriptionDetails.offerPricingData.countryPriceData[0].currency.iso3code;subscriptionDto.billingPriceWithTax=subscriptionDetails.offerPricingData.countryPriceData[0].priceList.price[0].priceWithTax;subscriptionDto.billingPriceWithoutTax=subscriptionDetails.offerPricingData.countryPriceData[0].priceList.price[0].priceWithoutTax}if(!_.has(subscriptionDetails,"billingInfo.nextBillingDate")||!subscriptionDetails.billingInfo.nextBillingDate){subscriptionDto.nextBillingDate=""}else{subscriptionDto.nextBillingDate=new Date(subscriptionDetails.billingInfo.nextBillingDate.toString().substring(0,10));subscriptionDto.nextBillingDate.setHours(subscriptionDetails.billingInfo.nextBillingDate.toString().substring(11,13));subscriptionDto.nextBillingDate.setMinutes(subscriptionDetails.billingInfo.nextBillingDate.toString().substring(14,16));subscriptionDto.nextBillingDate.setSeconds(subscriptionDetails.billingInfo.nextBillingDate.toString().substring(17,19))}subscriptionDto.purchaseDate=new Date(subscriptionDetails.contract.termStartDate.toString().substring(0,10));subscriptionDto.purchaseDate.setHours(subscriptionDetails.contract.termStartDate.toString().substring(11,13));subscriptionDto.purchaseDate.setMinutes(subscriptionDetails.contract.termStartDate.toString().substring(14,16));subscriptionDto.purchaseDate.setSeconds(subscriptionDetails.contract.termStartDate.toString().substring(17,19));subscriptionDto.subExpirationDate=new Date(subscriptionDetails.contract.anniversaryDate.toString().substring(0,10));subscriptionDto.subExpirationDate.setHours(subscriptionDetails.contract.anniversaryDate.toString().substring(11,13));subscriptionDto.subExpirationDate.setMinutes(subscriptionDetails.contract.anniversaryDate.toString().substring(14,16));subscriptionDto.subExpirationDate.setSeconds(subscriptionDetails.contract.anniversaryDate.toString().substring(17,19));subscriptionDto.status=subscriptionDetails.status;subscriptionDto.paymentStatus=subscriptionDetails.paymentStatus;subscriptionDto.subscriptionAccountId=$routeParams.subscriptionAccountId;subscriptionDto.isCancelAvailable=subscriptionDetails.isCancelAvailable;subscriptionDto.isResumeAvailable=subscriptionDetails.isResumeAvailable;subscriptionDto.isChangePlanAvailable=subscriptionDetails.isChangePlanAvailable;if(_.has(subscriptionDetails,"promoData")&&subscriptionDetails.promoData!=""){subscriptionDto.promoData=subscriptionDetails.promoData;if(_.has(subscriptionDetails,"offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithTax")&&_.has(subscriptionDetails,"offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithoutTax")){subscriptionDto.billingPriceWithoutTax=subscriptionDetails.offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithoutTax;subscriptionDto.billingPriceWithTax=subscriptionDetails.offerPricingData.countryPriceData[0].priceMap.price.orginalPriceWithTax}}else{subscriptionDto.promoData=""}return subscriptionDto};this.standardErrorMessage=function(errorResult){var errorDetails={};var splitedMessage=[];if(errorResult.errorMessage&&errorResult.errorMessage.toUpperCase()=="RELATED_OFFERS_NOT_FOUND"){errorDetails.type=SubscriptionConstants.MESSAGE_INFO_TYPE;errorDetails.message="There are no plans available for upgrade or downgrade."}else{if(errorResult.errorMessage&&errorResult.errorMessage.toUpperCase()=="SUBSCRIPTION_CHANGE_STATUS_INVALID_ADDRESS"){errorDetails.type=SubscriptionConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Subscription Change Status Invalid Address"}else{if(errorResult.errorMessage&&errorResult.errorMessage.toUpperCase()=="ECC_PREVIEW_CANCEL_ERROR"){errorDetails.type=SubscriptionConstants.MESSAGE_ERROR_TYPE;errorDetails.message="ECC preview service is not yet available."}else{if(errorResult.errorMessage&&errorResult.errorMessage.toUpperCase()=="SUBSCRIPTION_NOT_RESUMABLE"){errorDetails.type=SubscriptionConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Subscription is not resumable."}else{errorDetails.type=SubscriptionConstants.MESSAGE_ERROR_TYPE;errorDetails.message="";if(errorResult.errorMessage){splitedMessage=errorResult.errorMessage.split("_");angular.forEach(splitedMessage,function(item){errorDetails.message=errorDetails.message+" "+item.toLowerCase().replace(/\b(\s\w|^\w)/g,function(txt){return txt.toUpperCase()})})}else{errorDetails.message="The service failed to get data, please try again..."}}}}}return errorDetails};this.getChangePlanOfferDetails=function(relatedOfferDetails){var offerDtoList=[];var offerType="";var standardCount=0,customerCareCount=0;angular.forEach(relatedOfferDetails,function(relatedItem){if(relatedItem.relatedOfferType=="DOWNGRADE"||relatedItem.relatedOfferType=="UPGRADE"){offerType="Standard"}else{offerType=relatedItem.relatedOfferType}angular.forEach(relatedItem.subscriptionOffers,function(offerItem){var changePlanOfferDto=angular.copy(ChangePlanDto);changePlanOfferDto.sku=offerItem.countryMaterialMap[0].materialId;changePlanOfferDto.productName=offerItem.material.data.localizedData[0].longDescription;changePlanOfferDto.languageCode=_.has(offerItem,"material.data.languageCode")?offerItem.material["data"]["languageCode"]:"";if(typeof offerItem.pricing.data.countryPriceData[0].priceList=="undefined"){changePlanOfferDto.displayPrice=""}else{changePlanOfferDto.displayPrice=offerItem.pricing.data.countryPriceData[0].priceList.price[0].displayPrice}changePlanOfferDto.currencyCode=offerItem.pricing.data.countryPriceData[0].currency.iso3code;changePlanOfferDto.offerId=offerItem.id;changePlanOfferDto.term=offerItem.commitment.data.termUnit;changePlanOfferDto.offerType=offerType;if(offerItem.termsAndConditions&&offerItem.termsAndConditions["href"]){changePlanOfferDto.tncTemplateName=AppUtils.getParameterByName("service_name",offerItem.termsAndConditions["href"])}if(offerItem.marketSegment){changePlanOfferDto.marketSegment=offerItem.marketSegment[0]}if(offerType==="Standard"){standardCount++}else{customerCareCount++}offerDtoList.push(changePlanOfferDto)})});offerDtoList.standardCount=standardCount;offerDtoList.customerCareCount=customerCareCount;return offerDtoList};this.DateConvertToCrmFormat=function(tenureDate){var tenureDateConverted=new Date(tenureDate);tenureDateConverted.setHours(0);tenureDateConverted.setMinutes(0);tenureDateConverted.setSeconds(0);tenureDate=Number(tenureDateConverted);return tenureDate}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngSubTaxLabel",["CustomerConstants",function(CustomerConstants){return{restrict:"E",scope:{countryCode:"="},replace:false,template:"<span>{{taxLabel}}</span>",link:function(scope,element,attrs){scope.taxLabel="Sub total (ex VAT)";scope.$watch("countryCode",function(value){if(!value||!angular.isDefined(value)){return}scope.updateLabel()});scope.updateLabel=function(){if(scope.countryCode==CustomerConstants.NEWZEALAND_COUNTRY_CODE||scope.countryCode==CustomerConstants.AUSTRALIA_COUNTRY_CODE){scope.taxLabel="Sub total (ex GST)"}};scope.updateLabel()}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("SuperController",["$rootScope","$scope","AppUtils","AppConstants",function($rootScope,$scope,AppUtils,AppConstants){}]);var app=app||angular.module("hxApp.directive",[]);app.directive("switchSelector",function(){return{require:"ngModel",link:function(scope,element,attrs){scope.$watch(attrs.ngModel,function(data){if(data.selected=="yes"){$(element).bootstrapSwitch("state",true)}else{$(element).bootstrapSwitch("state",false)}})}}});app.controller("TagCaseController",["$rootScope","$scope","$timeout","TrackerService","Utils","LocalStorageService","TagCloudService","PersonalizeDashboardService","DashboardConstants",function($rootScope,$scope,$timeout,TrackerService,Utils,LocalStorageService,TagCloudService,PersonalizeDashboardService,DashboardConstants){$scope.selectedTags=[];$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit="";$scope.message="";$scope.showSavedSearch=false;$scope.tagCategories=[];$scope.availableTagCategories=[];$scope.selectedTagCategory=[];$scope.statusFilters=[{name:"Open",value:"OPEN"},{name:"In Process",value:"INPR"},{name:"Completed",value:"COMP"}];$scope.selectedTagsForCategory=[];$scope.availbleTagsForCategory=[];$scope.savedDashboardSearchList=[];$scope.isEditMode=false;$scope.performedSearch=false;$scope.endDate="";$scope.performedSearchDto="";var currentAgent="";$scope.selectedTabFromURL;$scope.currentUSerLoaded=false;unbindCurrentUser=$scope.$watch(function(){return $scope.currentUser},function(value){if(!value){return}$scope.defaultUser=$scope.currentUser;$scope.currentUSerLoaded=true;if($scope.selectedTabFromURL==DashboardConstants.DASHBOARD_CASE_LABEL){setTimeout($scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions),3000);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});var defaultDashboard=function(){return jQuery.extend({},{id:null,ownerId:"",searchId:"",agentIds:"",description:"",scope:"",type:"",filterOptionsDto:{startDate:"",endDate:"",tags:"",maxResults:"",statuses:"OPEN,INPR"},defaultSearch:false})};var defaultFilterOption=function(){return jQuery.extend({},{maxResults:200,tags:"",statuses:"OPEN,INPR",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")})};$scope.dashboardSearchDto=defaultDashboard();var d=new Date();d.setTime((d.getTime()+86400*1000*1));$scope.agents="";$scope.filterOptions={maxResults:200,tags:"",statuses:"OPEN,INPR",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")};$scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}$scope.filterOptions.startDate=result.toString("dddd, MMMM, yyyy");$scope.startDate=result};$scope.customerLink=Utils.customerLink;$scope.intervalSelection=4;$scope.updateInterval($scope.intervalSelection);$scope.handleIntervalChange=function(){$scope.updateInterval($scope.intervalSelection);$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleIntervalChangeFromCriteria=function(){$scope.updateInterval($scope.intervalSelection)};$scope.isSelected=function(){return $scope.selectedCaseTags.indexOf(($.trim(this.tag)))!=-1};$scope.isSelectedTag=function(){return $scope.selectedCaseTags.length>0};$scope.toggleTag=function(){if(typeof($scope.selectedCaseTags)=="undefined"||$scope.selectedCaseTags==""){$scope.selectedCaseTags=[]}var tagName=this.tag.tagtext;var index=$scope.selectedCaseTags.indexOf(($.trim(tagName)));if(index!=-1){$scope.selectedCaseTags.splice(index,1)}else{$scope.selectedCaseTags.push(($.trim(tagName)))}$scope.searchCaseTags=$scope.selectedCaseTags.toString()};$scope.isCategorySelected=function(){return $scope.selectedTagCategory.indexOf(($.trim(this.tagCategory.categorytext)))!=-1};$scope.isCategoryTagSelected=function(){return $scope.selectedCaseTags.indexOf(($.trim(this.tag.tagtext)))!=-1};$scope.handleMyDashboardButton=function(){$scope.removedSaveSearchCriteria()};$scope.handlePopupSaveButton=function(){$("#agentsSelection2").modal("hide");if($scope.isEditMode){$scope.performedSearchDto=$scope.dashboardSearchDto}$scope.isEditMode=false;$scope.performedSearch=false;$scope.filterOptions.tags=$scope.searchCaseTags.toString();$scope.filterOptions.statuses=$scope.selectedStatusFilters.toString();$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handlePerformSaveSerach=function(){$scope.isTagLoading=true;$scope.tagrecords=[];$scope.performedSearch=true;$scope.performedSearchDto=this.rec;$scope.agents=$scope.performedSearchDto.agentIds;$scope.intervalSelection=this.rec.scope;$scope.updateInterval($scope.intervalSelection);$scope.searchCaseTags=this.rec.filterOptionsDto.tags.split(",");$scope.filterOptions.tags=this.rec.filterOptionsDto.tags.toString();$scope.filterOptions.statuses=this.rec.filterOptionsDto.statuses.toString();$scope.filterOptions.maxResults=this.rec.filterOptionsDto.maxResults;$scope.dashboardSearchDto=this.rec;PersonalizeDashboardService.performSavedSearch({id:this.rec.id}).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(error){$scope.isTagLoading=false;console.log("Personalize Save Search Failed");$scope.isTagLoading=false})};$scope.handleDeleteSaveSerach=function(){if(this.rec.id==$scope.performedSearchDto.id){$scope.removedSaveSearchCriteria()}PersonalizeDashboardService.deleteSaveSearch({id:this.rec.id}).success(function(result){console.log("Saved search record deleted !!");$scope.getSavedPersonalizeSearch()}).error(function(error){console.log("Saved search record deletion failed !!")})};$scope.removedSaveSearchCriteria=function(){$scope.performedSearchDto="";$scope.dashboardSearchDto=defaultDashboard();$scope.filterOptions=defaultFilterOption();$scope.beforeDialog=$scope.defaultUser.username;$scope.agents=$scope.defaultUser.username;$scope.intervalSelection=4;$scope.updateInterval($scope.intervalSelection);$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.tagrecords=[];$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleSearchSaveButton=function(){$scope.dashboardSearchDto.id=null;$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions)};$scope.handleSearchModifyButton=function(){$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions);$scope.message=[]};$scope.handleClosePopup=function(){$scope.agents=$scope.beforeDialog;$("#agentsSelection2").modal("hide")};$scope.handleAgentsChangeButton=function(){if($scope.performedSearchDto){$scope.handleEditSearchFromDashboard();return}else{if($scope.isEditMode&&!$scope.performedSearch){$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.filterOptions=defaultFilterOption();$scope.agents=$scope.defaultUser.username;$scope.dashboardSearchDto=defaultDashboard();$scope.intervalSelection=4}}$scope.message=[];$scope.isEditMode=false;$scope.beforeDialog=$scope.agents;$scope.selectedCaseTags=$scope.filterOptions.tags.split(",");$scope.searchCaseTags=$scope.filterOptions.tags.split(",");$scope.selectedStatusFilters=$scope.filterOptions.statuses===""?[]:$scope.filterOptions.statuses.split(",");$scope.changedRecordLimit=$scope.filterOptions.maxResults;$("#agentsSelection2").css("z-index",1999);$("#agentsSelection2").modal("show")};$scope.handleRefresh=function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.exportDashboard=function(){var csvData=[];var data=$scope.filtered;for(var i=0;i<$scope.filtered.length;i++){var dataObj={};dataObj["Case Number"]=data[i].caseNumber;dataObj["Case Type"]=data[i].transTypeLabel;dataObj["Transaction Type"]=data[i].transType;dataObj["Creation Date"]=new Date(data[i].creationDate);dataObj["Modified Date"]=new Date(data[i].lastModifiedDate);dataObj.OCA=data[i].ocard;dataObj["Case Type"]=data[i].transTypeLabel;dataObj["Customer Name"]=data[i].customerName;dataObj["Customer Number"]=data[i].customerNumber;dataObj["Contact Name"]=data[i].contactFullName;dataObj["Contact Number"]=data[i].contact;dataObj["Bp Type"]=data[i].bpType;var description;try{description=decodeURIComponent(escape(data[i].description))}catch(error){description=unescape(encodeURIComponent(data[i].description))}dataObj.Description=description;dataObj["Reason/Subject"]=data[i].reasonLabel;dataObj["Product Name"]=data[i].productName;dataObj["Product Code"]=data[i].productCode;dataObj.Tags=data[i].tags;dataObj.Priority=getPriorityLabel(data[i].priority);dataObj.Status=data[i].status;dataObj.Statuses=data[i].statuses;dataObj.Owner=data[i].caseOwner.firstName+" "+data[i].caseOwner.lastName;dataObj["Employee Responsible"]=data[i].caseEmployeeResponsible.firstName+" "+data[i].caseEmployeeResponsible.lastName;dataObj["Attachment Flag"]=data[i].attachmentFlag;csvData.push(dataObj)}JSONToCSVConvertor(csvData,"My Dashboard",true);csvData=data=[]};function getPriorityLabel(priorityCode){var priorityLabel=priorityCode;if(typeof $scope.metadata.tsCasePriorityDtos!=="undefined"){angular.forEach($scope.metadata.tsCasePriorityDtos,function(item){if(item.priority==priorityCode){priorityLabel=item.value}})}return priorityLabel}unbindWatcher1=$scope.$watch(function(){return $scope.defaultUser},function(value){if(!value){return}currentAgent=value.username;$scope.agents=value.username});$scope.unbindTabClickWatcher=$rootScope.$on(DashboardConstants.DASHBOARD_OPEN_CASES_TAB_EVENT,function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions);$scope.unbindTabClickWatcher()});$scope.unbindWatcher3=$scope.$watch(function(){return $scope.openTab},function(value){if(!value){return}$scope.selectedTabFromURL=value;if((value==DashboardConstants.DASHBOARD_CASE_LABEL)&&$scope.currentUSerLoaded){setTimeout($scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions),3000);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});$scope.handleCollapseList=function(){$(".row .inner").addClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","collapse")};$scope.handleExpandList=function(){$(".row .inner").removeClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","")};var checkListItemState=function(){$timeout(function(){var listItemState=LocalStorageService.user.get("dashboard.listitem.state");if(listItemState&&listItemState=="collapse"){$scope.handleCollapseList()}},100)};$scope.updateTaggedOrders=function(agents,filterOptions){$scope.loadCaseTags();$scope.tagrecords=[];$scope.isTagLoading=true;TrackerService.getOpenCases(agents,filterOptions).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(){$scope.isTagLoading=false;$scope.tagrecords=[]})};$scope.getSavedPersonalizeSearch=function(){PersonalizeDashboardService.getSavedSearchesByTransactionType({transactionType:"CASE"}).success(function(result){$scope.savedDashboardSearchList=result.sort(function(a,b){if(a.description<b.description){return -1}if(a.description>b.description){return 1}return 0})}).error(function(error){console.log("ERROR"+error)})};$scope.getSavedPersonalizeSearch();$scope.saveSearchCriteria=function(agents,filterOptions){$scope.dashboardSearchDto.filterOptionsDto.maxResults=$scope.filterOptions.maxResults;$scope.dashboardSearchDto.filterOptionsDto.tags=$scope.searchCaseTags.toString();$scope.dashboardSearchDto.filterOptionsDto.statuses=$scope.selectedStatusFilters.toString();$scope.dashboardSearchDto.filterOptionsDto.startDate=$scope.startDate;$scope.dashboardSearchDto.filterOptionsDto.endDate=new Date().getTime();$scope.dashboardSearchDto.agentIds=$scope.agents.split(",");$scope.dashboardSearchDto.ownerId=$scope.defaultUser.username;$scope.dashboardSearchDto.scope=$scope.intervalSelection;$scope.dashboardSearchDto.searchId=$scope.dashboardSearchDto.description;$scope.dashboardSearchDto.type="CASE";PersonalizeDashboardService.saveSearch(false,$scope.dashboardSearchDto).success(function(result){var obj=[];obj.push(result);$scope.message=obj;$scope.getSavedPersonalizeSearch()}).error(function(error){var obj=[];obj.push(error);$scope.message=obj})};$scope.isSavedHistoryOpen=false;$scope.showSaveSearchHistory=function(){if(!$scope.isSavedHistoryOpen){$("#savedSearchListContainer").css("display","block");$("#searchListBtn").css("right","150px");$scope.isSavedHistoryOpen=true}else{$("#savedSearchListContainer").css("display","none");$("#searchListBtn").css("right","-59px");$scope.isSavedHistoryOpen=false}};$scope.editSaveSearchCriteria=function(){$scope.handleEditCriteria(angular.copy(this.rec))};$scope.handleEditSearchFromDashboard=function(){$scope.handleEditCriteria($scope.performedSearchDto)};$scope.handleEditCriteria=function(rec){$scope.isEditMode=true;$scope.performedSearch=false;$scope.message=[];$scope.dashboardSearchDto=defaultDashboard();$scope.dashboardSearchDto=rec;$scope.beforeDialog=rec.agentIds;$scope.agents=rec.agentIds.toString();$scope.intervalSelection=$scope.dashboardSearchDto.scope;$scope.updateInterval($scope.dashboardSearchDto.scope);$scope.selectedCaseTags=rec.filterOptionsDto.tags.split(",");$scope.searchCaseTags=rec.filterOptionsDto.tags.split(",");$scope.selectedStatusFilters=rec.filterOptionsDto.statuses?rec.filterOptionsDto.statuses.split(","):[];$scope.changedRecordLimit=rec.filterOptionsDto.maxResults;$("#agentsSelection2").css("z-index",1999);$("#agentsSelection2").modal("show")};TagCloudService.getTagCategory().success(function(result){if(typeof(result)=="undefined"||result==null||result.length==0){return}$scope.tagCategory=result.sort(function(a,b){if(a.categorytext<b.categorytext){return -1}if(a.categorytext>b.categorytext){return 1}return 0});angular.forEach($scope.tagCategory,function(item){if(item.status=="ACTIVE"){$scope.availableTagCategories.push(item)}})});$scope.updateTagCloudForCategory=function(){var categoryName=this.tagCategory;var index=$scope.selectedTagCategory.indexOf(($.trim(categoryName.categorytext)));if(index!=-1){$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext)}else{$scope.selectedTagCategory.splice(0,$scope.selectedTagCategory.length);$scope.selectedTagCategory.push(categoryName.categorytext);$scope.populateTagsForCategory(categoryName.categorytext)}};$scope.selectedStatusFilters=[];$scope.selectFilters=function(status){if($scope.selectedStatusFilters.indexOf(status)===-1){$scope.selectedStatusFilters.push(status)}else{$scope.selectedStatusFilters.splice($scope.selectedStatusFilters.indexOf(status),1)}};$scope.isStatusSelected=function(){return $scope.selectedStatusFilters.indexOf(($.trim(this.status.value)))!==-1};$scope.populateTagsForCategory=function(newValue){$scope.availbleTagsForCategory=[];TagCloudService.getTagsForCategory(newValue).success(function(result){angular.forEach(result,function(item){if(item.status=="ACTIVE"){$scope.availbleTagsForCategory.push(item)}})})};$scope.loadCaseTags=function(){$scope.caseTags=[];$scope.caseTagsCloud=[];TagCloudService.getTagCaseClouds().success(function(result){if(typeof(result)=="undefined"||result==null||result.length==0){return}$scope.caseTagsCloud=result.sort(function(a,b){if(a.tagtext<b.tagtext){return -1}if(a.tagtext>b.tagtext){return 1}return 0});angular.forEach($scope.caseTagsCloud,function(item){$scope.caseTags.push(item.tagtext)});$scope.caseTags=$scope.caseTags.unique().sort()}).error(function(){})};var unbindWatcher2=$scope.$watch("agents",function(value){if(!value){if($scope.currentUser&&$scope.currentUser!=undefined){value=$scope.currentUser.username}}Utils.pageTitle("Dashboard [ "+value+" ]")});$scope.getStatusColor=function(rec){return Utils.getStatusColor(rec.status)};$scope.$on("$destroy",function(){unbindWatcher1();unbindWatcher2()})}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TagCloudService",function($http){var service={};service.getTagCaseClouds=function(){return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:"/content/notestemplate/casetags.tags.json?q=*&property=tagtext&property=description"}})};service.getTagCategory=function(){return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:"content/notestemplate/tagcategory.category.json?q=*&property=categorytext&property=description&property=status"}})};service.getTagsForCategory=function(category){console.log(category);return $http({method:"POST",url:"../notesTemplates/getUrl.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:{address:"content/notestemplate/casetags.tags.json?q="+category+"&property=category&property=status&property=tagtext"}})};return service});app.controller("TagOrderController",["$rootScope","$scope","$timeout","TrackerService","Utils","LocalStorageService","TagCloudService","PersonalizeDashboardService","DashboardConstants",function($rootScope,$scope,$timeout,TrackerService,Utils,LocalStorageService,TagCloudService,PersonalizeDashboardService,DashboardConstants){$scope.changedRecordLimit="";$scope.message="";$scope.showSavedSearch=false;$scope.savedDashboardSearchList=[];$scope.isEditMode=false;$scope.performedSearch=false;$scope.endDate="";$scope.performedSearchDto="";var currentAgent="";$scope.selectedTabFromURL;$scope.currentUSerLoaded=false;unbindCurrentUser=$scope.$watch(function(){return $scope.currentUser},function(value){if(!value){return}$scope.defaultUser=$scope.currentUser;$scope.currentUSerLoaded=true;if($scope.selectedTabFromURL==DashboardConstants.DASHBOARD_ORDER_LABEL){$scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});var defaultDashboard=function(){return jQuery.extend({},{id:null,ownerId:"",searchId:"",agentIds:"",description:"",scope:"",type:"",filterOptionsDto:{startDate:"",endDate:"",tags:"",maxResults:""},defaultSearch:false})};var defaultFilterOption=function(){return jQuery.extend({},{maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")})};$scope.dashboardSearchDto=defaultDashboard();var d=new Date();d.setTime((d.getTime()+86400*1000*1));$scope.agents="";$scope.filterOptions={maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")};$scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}$scope.filterOptions.startDate=result.toString("dddd, MMMM, yyyy");$scope.startDate=result};$scope.customerLink=Utils.customerLink;$scope.intervalSelection=5;$scope.updateInterval($scope.intervalSelection);$scope.handleIntervalChange=function(){$scope.updateInterval($scope.intervalSelection);$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleIntervalChangeFromCriteria=function(){$scope.updateInterval($scope.intervalSelection)};$scope.handleMyDashboardButton=function(){$scope.removedSaveSearchCriteria()};$scope.handlePopupSaveButton=function(){$("#orderAgentsSelectionPopup").modal("hide");if($scope.isEditMode){$scope.performedSearchDto=$scope.dashboardSearchDto}$scope.isEditMode=false;$scope.performedSearch=false;$scope.filterOptions.tags=$scope.searchCaseTags.toString();$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handlePerformSaveSerach=function(){$scope.isTagLoading=true;$scope.tagrecords=[];$scope.performedSearch=true;$scope.performedSearchDto=this.rec;$scope.agents=$scope.performedSearchDto.agentIds;$scope.intervalSelection=this.rec.scope;$scope.updateInterval($scope.intervalSelection);$scope.searchCaseTags=this.rec.filterOptionsDto.tags.split(",");$scope.filterOptions.tags=this.rec.filterOptionsDto.tags.toString();$scope.filterOptions.maxResults=this.rec.filterOptionsDto.maxResults;$scope.dashboardSearchDto=this.rec;PersonalizeDashboardService.performSavedSearch({id:this.rec.id}).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(error){$scope.isTagLoading=false;console.log("Personalize Save Search Failed");$scope.isTagLoading=false})};$scope.handleDeleteSaveSerach=function(){if(this.rec.id==$scope.performedSearchDto.id){$scope.removedSaveSearchCriteria()}PersonalizeDashboardService.deleteSaveSearch({id:this.rec.id}).success(function(result){console.log("Saved search record deleted !!");$scope.getSavedPersonalizeSearch()}).error(function(error){console.log("Saved search record deletion failed !!")})};$scope.removedSaveSearchCriteria=function(){$scope.performedSearchDto="";$scope.dashboardSearchDto=defaultDashboard();$scope.filterOptions=defaultFilterOption();$scope.beforeDialog=$scope.currentUser.username;$scope.agents=$scope.currentUser.username;$scope.intervalSelection=4;$scope.updateInterval($scope.intervalSelection);$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.tagrecords=[];$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleSearchSaveButton=function(){$scope.dashboardSearchDto.id=null;$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions)};$scope.handleSearchModifyButton=function(){$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions);$scope.message=[]};$scope.handleClosePopup=function(){$scope.agents=$scope.beforeDialog;$("#orderAgentsSelectionPopup").modal("hide")};$scope.handleAgentsChangeButton=function(){if($scope.performedSearchDto){$scope.handleEditSearchFromDashboard();return}else{if($scope.isEditMode&&!$scope.performedSearch){$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.filterOptions=defaultFilterOption();$scope.agents=$scope.defaultUser.username;$scope.dashboardSearchDto=defaultDashboard();$scope.intervalSelection=4}}$scope.message=[];$scope.isEditMode=false;$scope.beforeDialog=$scope.agents;$scope.selectedCaseTags=$scope.filterOptions.tags.split(",");$scope.searchCaseTags=$scope.filterOptions.tags.split(",");$scope.changedRecordLimit=$scope.filterOptions.maxResults;$("#orderAgentsSelectionPopup").css("z-index",1999);$("#orderAgentsSelectionPopup").modal("show")};$scope.handleRefresh=function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.exportDashboard=function(){var csvData=[];var data=$scope.filtered;for(var i=0;i<$scope.filtered.length;i++){var dataObj={};dataObj["Order Number"]=data[i].id;dataObj["Order Type"]=data[i].type;dataObj["Transaction Type"]=data[i].transType;dataObj["Creation Date"]=new Date(data[i].creationDate);dataObj["Modified Date"]=new Date(data[i].lastModifiedDate);dataObj.OCA=data[i].ocard;dataObj["Customer Name"]=data[i].customerName;dataObj["Customer Number"]=data[i].customerId;dataObj["Agent username"]=data[i].agent.username;dataObj["Agent name"]=data[i].agent.firstName+" "+data[i].agent.lastName;var description;try{description=decodeURIComponent(escape(data[i].description))}catch(error){description=unescape(encodeURIComponent(data[i].description))}dataObj.Description=description;dataObj.Status=data[i].status;csvData.push(dataObj)}JSONToCSVConvertor(csvData,"My Dashboard",true);csvData=data=[]};function getPriorityLabel(priorityCode){var priorityLabel=priorityCode;if(typeof $scope.metadata.tsCasePriorityDtos!=="undefined"){angular.forEach($scope.metadata.tsCasePriorityDtos,function(item){if(item.priority==priorityCode){priorityLabel=item.value}})}return priorityLabel}unbindWatcher1=$scope.$watch(function(){return $scope.defaultUser},function(value){if(!value){return}currentAgent=value.username;$scope.agents=value.username});$scope.unbindTabClickWatcher=$rootScope.$on(DashboardConstants.DASHBOARD_OPEN_ORDERS_TAB_EVENT,function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions);$scope.unbindTabClickWatcher();$scope.unbindWatcher3()});$scope.unbindWatcher3=$scope.$watch(function(){return $scope.openTab},function(value){if(!value){return}$scope.selectedTabFromURL=value;if((value==DashboardConstants.DASHBOARD_ORDER_LABEL)&&$scope.currentUSerLoaded){$scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});$scope.handleCollapseList=function(){element.find(".row .inner").addClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","collapse")};$scope.handleExpandList=function(){element.find(".row .inner").removeClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","")};var checkListItemState=function(){$timeout(function(){var listItemState=LocalStorageService.user.get("dashboard.listitem.state");if(listItemState&&listItemState=="collapse"){$scope.handleCollapseList()}},100)};$scope.updateTaggedOrders=function(agents,filterOptions){$scope.tagrecords=[];$scope.isTagLoading=true;TrackerService.getOpenOrders(agents,filterOptions).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(){$scope.isTagLoading=false;$scope.tagrecords=[]})};$scope.getSavedPersonalizeSearch=function(){PersonalizeDashboardService.getSavedSearchesByTransactionType({transactionType:"ORDER"}).success(function(result){$scope.savedDashboardSearchList=result.sort(function(a,b){if(a.description<b.description){return -1}if(a.description>b.description){return 1}return 0})}).error(function(error){console.log("ERROR"+error)})};$scope.getSavedPersonalizeSearch();$scope.saveSearchCriteria=function(agents,filterOptions){$scope.dashboardSearchDto.filterOptionsDto.maxResults=$scope.filterOptions.maxResults;$scope.dashboardSearchDto.filterOptionsDto.tags=$scope.searchCaseTags.toString();$scope.dashboardSearchDto.filterOptionsDto.startDate=$scope.startDate;$scope.dashboardSearchDto.filterOptionsDto.endDate=new Date().getTime();$scope.dashboardSearchDto.agentIds=$scope.agents.split(",");$scope.dashboardSearchDto.ownerId=$scope.currentUser.username;$scope.dashboardSearchDto.scope=$scope.intervalSelection;$scope.dashboardSearchDto.searchId=$scope.dashboardSearchDto.description;$scope.dashboardSearchDto.type="ORDER";PersonalizeDashboardService.saveSearch(false,$scope.dashboardSearchDto).success(function(result){var obj=[];obj.push(result);$scope.message=obj;$scope.getSavedPersonalizeSearch()}).error(function(error){var obj=[];obj.push(error);$scope.message=obj})};$scope.isSavedHistoryOpen=false;$scope.showSaveSearchHistory=function(){if(!$scope.isSavedHistoryOpen){$("#orderSavedSearchListContainer").css("display","block");$("#orderSearchListBtn").css("right","150px");$scope.isSavedHistoryOpen=true}else{$("#orderSavedSearchListContainer").css("display","none");$("#orderSearchListBtn").css("right","-59px");$scope.isSavedHistoryOpen=false}};$scope.editSaveSearchCriteria=function(){$scope.handleEditCriteria(angular.copy(this.rec))};$scope.handleEditSearchFromDashboard=function(){$scope.handleEditCriteria($scope.performedSearchDto)};$scope.handleEditCriteria=function(rec){$scope.isEditMode=true;$scope.performedSearch=false;$scope.message=[];$scope.dashboardSearchDto=defaultDashboard();$scope.dashboardSearchDto=rec;$scope.beforeDialog=rec.agentIds;$scope.agents=rec.agentIds.toString();$scope.intervalSelection=$scope.dashboardSearchDto.scope;$scope.updateInterval($scope.dashboardSearchDto.scope);$scope.changedRecordLimit=rec.filterOptionsDto.maxResults;$("#orderAgentsSelectionPopup").css("z-index",1999);$("#orderAgentsSelectionPopup").modal("show")};var unbindWatcher2=$scope.$watch("agents",function(value){if(!value){if($scope.currentUser&&$scope.currentUser!=undefined){value=$scope.defaultUser.username}}Utils.pageTitle("Dashboard [ "+value+" ]")});$scope.getStatusColor=function(rec){return Utils.getStatusColor(rec.status)};$scope.$on("$destroy",function(){unbindWatcher1();unbindWatcher2()})}]);app.controller("TagQuoteController",["$rootScope","$scope","$timeout","TrackerService","Utils","LocalStorageService","TagCloudService","PersonalizeDashboardService","DashboardConstants",function($rootScope,$scope,$timeout,TrackerService,Utils,LocalStorageService,TagCloudService,PersonalizeDashboardService,DashboardConstants){$scope.selectedTags=[];$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit="";$scope.message="";$scope.showSavedSearch=false;$scope.tagCategories=[];$scope.availableTagCategories=[];$scope.selectedTagCategory=[];$scope.selectedTagsForCategory=[];$scope.availbleTagsForCategory=[];$scope.savedDashboardSearchList=[];$scope.isEditMode=false;$scope.performedSearch=false;$scope.endDate="";$scope.performedSearchDto="";var currentAgent="";$scope.selectedTabFromURL;$scope.currentUSerLoaded=false;unbindCurrentUser=$scope.$watch(function(){return $scope.currentUser},function(value){if(!value){return}$scope.defaultUser=$scope.currentUser;$scope.currentUSerLoaded=true;if($scope.selectedTabFromURL==DashboardConstants.DASHBOARD_QUOTE_LABEL){$scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});var defaultDashboard=function(){return jQuery.extend({},{id:null,ownerId:"",searchId:"",agentIds:"",description:"",scope:"",type:"",filterOptionsDto:{startDate:"",endDate:"",tags:"",maxResults:""},defaultSearch:false})};var defaultFilterOption=function(){return jQuery.extend({},{maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")})};$scope.dashboardSearchDto=defaultDashboard();var d=new Date();d.setTime((d.getTime()+86400*1000*1));$scope.agents="";$scope.filterOptions={maxResults:200,tags:"",startDate:undefined,endDate:d.toString("dddd, MMMM, yyyy")};$scope.updateInterval=function(interval){interval=interval.toString();var result=new Date();switch(interval){case"1":result.setDate(result.getDate()-1);break;case"2":result.setDate(result.getDate()-4);break;case"3":result.setDate(result.getDate()-8);break;case"4":result.setDate(result.getDate()-14);break;case"5":result.setMonth(result.getMonth()-1);break;case"6":result.setMonth(result.getMonth()-3);break;case"7":result.setMonth(result.getMonth()-6);break;case"8":result.setYear(result.getYear()-1);break;case"9":result=new Date(1970,0,1);break}$scope.filterOptions.startDate=result.toString("dddd, MMMM, yyyy");$scope.startDate=result};$scope.customerLink=Utils.customerLink;$scope.intervalSelection=5;$scope.updateInterval($scope.intervalSelection);$scope.handleIntervalChange=function(){$scope.updateInterval($scope.intervalSelection);$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleIntervalChangeFromCriteria=function(){$scope.updateInterval($scope.intervalSelection)};$scope.handleMyDashboardButton=function(){$scope.removedSaveSearchCriteria()};$scope.handlePopupSaveButton=function(){$("#quoteAgentsSelectionPopup").modal("hide");if($scope.isEditMode){$scope.performedSearchDto=$scope.dashboardSearchDto}$scope.isEditMode=false;$scope.performedSearch=false;$scope.filterOptions.tags=$scope.searchCaseTags.toString();$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handlePerformSaveSerach=function(){$scope.isTagLoading=true;$scope.tagrecords=[];$scope.performedSearch=true;$scope.performedSearchDto=this.rec;$scope.agents=$scope.performedSearchDto.agentIds;$scope.intervalSelection=this.rec.scope;$scope.updateInterval($scope.intervalSelection);$scope.searchCaseTags=this.rec.filterOptionsDto.tags.split(",");$scope.filterOptions.tags=this.rec.filterOptionsDto.tags.toString();$scope.filterOptions.maxResults=this.rec.filterOptionsDto.maxResults;$scope.dashboardSearchDto=this.rec;PersonalizeDashboardService.performSavedSearch({id:this.rec.id}).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(error){$scope.isTagLoading=false;console.log("Personalize Save Search Failed");$scope.isTagLoading=false})};$scope.handleDeleteSaveSerach=function(){if(this.rec.id==$scope.performedSearchDto.id){$scope.removedSaveSearchCriteria()}PersonalizeDashboardService.deleteSaveSearch({id:this.rec.id}).success(function(result){console.log("Saved search record deleted !!");$scope.getSavedPersonalizeSearch()}).error(function(error){console.log("Saved search record deletion failed !!")})};$scope.removedSaveSearchCriteria=function(){$scope.performedSearchDto="";$scope.dashboardSearchDto=defaultDashboard();$scope.filterOptions=defaultFilterOption();$scope.beforeDialog=$scope.currentUser.username;$scope.agents=$scope.currentUser.username;$scope.intervalSelection=4;$scope.updateInterval($scope.intervalSelection);$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.tagrecords=[];$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.handleSearchSaveButton=function(){$scope.dashboardSearchDto.id=null;$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions)};$scope.handleSearchModifyButton=function(){$scope.filterOptions.maxResults=$scope.changedRecordLimit;$scope.saveSearchCriteria($scope.agents,$scope.filterOptions);$scope.message=[]};$scope.handleClosePopup=function(){$scope.agents=$scope.beforeDialog;$("#quoteAgentsSelectionPopup").modal("hide")};$scope.handleAgentsChangeButton=function(){if($scope.performedSearchDto){$scope.handleEditSearchFromDashboard();return}else{if($scope.isEditMode&&!$scope.performedSearch){$scope.selectedCaseTags=[];$scope.searchCaseTags=[];$scope.changedRecordLimit=200;$scope.filterOptions=defaultFilterOption();$scope.agents=$scope.defaultUser.username;$scope.dashboardSearchDto=defaultDashboard();$scope.intervalSelection=4}}$scope.message=[];$scope.isEditMode=false;$scope.beforeDialog=$scope.agents;$scope.selectedCaseTags=$scope.filterOptions.tags.split(",");$scope.searchCaseTags=$scope.filterOptions.tags.split(",");$scope.changedRecordLimit=$scope.filterOptions.maxResults;$("#quoteAgentsSelectionPopup").css("z-index",1999);$("#quoteAgentsSelectionPopup").modal("show")};$scope.handleRefresh=function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions)};$scope.exportDashboard=function(){var csvData=[];var data=$scope.filtered;for(var i=0;i<$scope.filtered.length;i++){var dataObj={};dataObj["Quote Number"]=data[i].transactionNumber;dataObj["Creation Date"]=new Date(data[i].creationDate);dataObj["Modified Date"]=new Date(data[i].lastModifiedDate);dataObj.OCA=data[i].ocard;dataObj["Customer Name"]=data[i].customerName;dataObj["Customer Number"]=data[i].customerId;dataObj["Agent Username"]=data[i].agent.username;dataObj["Agent Name"]=data[i].agent.firstName+" "+data[i].agent.lastName;var description;try{description=decodeURIComponent(escape(data[i].description))}catch(error){description=unescape(encodeURIComponent(data[i].description))}dataObj.Description=description;dataObj.Quantity=data[i].quantity;dataObj.Status=data[i].status;csvData.push(dataObj)}JSONToCSVConvertor(csvData,"My Dashboard",true);csvData=data=[]};function getPriorityLabel(priorityCode){var priorityLabel=priorityCode;if(typeof $scope.metadata.tsCasePriorityDtos!=="undefined"){angular.forEach($scope.metadata.tsCasePriorityDtos,function(item){if(item.priority==priorityCode){priorityLabel=item.value}})}return priorityLabel}unbindWatcher1=$scope.$watch(function(){return $scope.defaultUser},function(value){if(!value){return}currentAgent=value.username;$scope.agents=value.username});$scope.unbindTabClickWatcher=$rootScope.$on(DashboardConstants.DASHBOARD_OPEN_QUOTES_TAB_EVENT,function(){$scope.updateTaggedOrders($scope.agents,$scope.filterOptions);$scope.unbindTabClickWatcher();$scope.unbindWatcher3()});$scope.unbindWatcher3=$scope.$watch(function(){return $scope.openTab},function(value){if(!value){return}$scope.selectedTabFromURL=value;if((value==DashboardConstants.DASHBOARD_QUOTE_LABEL)&&$scope.currentUSerLoaded){$scope.updateTaggedOrders($scope.currentUser.username,$scope.filterOptions);$scope.unbindWatcher3();$scope.unbindTabClickWatcher()}});$scope.handleCollapseList=function(){element.find(".row .inner").addClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","collapse")};$scope.handleExpandList=function(){element.find(".row .inner").removeClass("collapsedRow");LocalStorageService.user.add("dashboard.listitem.state","")};var checkListItemState=function(){$timeout(function(){var listItemState=LocalStorageService.user.get("dashboard.listitem.state");if(listItemState&&listItemState=="collapse"){$scope.handleCollapseList()}},100)};$scope.updateTaggedOrders=function(agents,filterOptions){$scope.tagrecords=[];$scope.isTagLoading=true;TrackerService.getOpenQuotes(agents,filterOptions).success(function(result){$scope.tagrecords=result;$scope.isTagLoading=false}).error(function(){$scope.isTagLoading=false;$scope.tagrecords=[]})};$scope.getSavedPersonalizeSearch=function(){PersonalizeDashboardService.getSavedSearchesByTransactionType({transactionType:"QUOTE"}).success(function(result){$scope.savedDashboardSearchList=result.sort(function(a,b){if(a.description<b.description){return -1}if(a.description>b.description){return 1}return 0})}).error(function(error){console.log("ERROR"+error)})};$scope.getSavedPersonalizeSearch();$scope.saveSearchCriteria=function(agents,filterOptions){$scope.dashboardSearchDto.filterOptionsDto.maxResults=$scope.filterOptions.maxResults;$scope.dashboardSearchDto.filterOptionsDto.tags=$scope.searchCaseTags.toString();$scope.dashboardSearchDto.filterOptionsDto.startDate=$scope.startDate;$scope.dashboardSearchDto.filterOptionsDto.endDate=new Date().getTime();$scope.dashboardSearchDto.agentIds=$scope.agents.split(",");$scope.dashboardSearchDto.ownerId=$scope.currentUser.username;$scope.dashboardSearchDto.scope=$scope.intervalSelection;$scope.dashboardSearchDto.searchId=$scope.dashboardSearchDto.description;$scope.dashboardSearchDto.type="QUOTE";PersonalizeDashboardService.saveSearch(false,$scope.dashboardSearchDto).success(function(result){var obj=[];obj.push(result);$scope.message=obj;$scope.getSavedPersonalizeSearch()}).error(function(error){var obj=[];obj.push(error);$scope.message=obj})};$scope.isSavedHistoryOpen=false;$scope.showSaveSearchHistory=function(){if(!$scope.isSavedHistoryOpen){$("#quoteSavedSearchListContainer").css("display","block");$("#quoteSearchListBtn").css("right","150px");$scope.isSavedHistoryOpen=true}else{$("#quoteSavedSearchListContainer").css("display","none");$("#quoteSearchListBtn").css("right","-59px");$scope.isSavedHistoryOpen=false}};$scope.editSaveSearchCriteria=function(){$scope.handleEditCriteria(angular.copy(this.rec))};$scope.handleEditSearchFromDashboard=function(){$scope.handleEditCriteria($scope.performedSearchDto)};$scope.handleEditCriteria=function(rec){$scope.isEditMode=true;$scope.performedSearch=false;$scope.message=[];$scope.dashboardSearchDto=defaultDashboard();$scope.dashboardSearchDto=rec;$scope.beforeDialog=rec.agentIds;$scope.agents=rec.agentIds.toString();$scope.intervalSelection=$scope.dashboardSearchDto.scope;$scope.updateInterval($scope.dashboardSearchDto.scope);$scope.selectedCaseTags=rec.filterOptionsDto.tags.split(",");$scope.searchCaseTags=rec.filterOptionsDto.tags.split(",");$scope.changedRecordLimit=rec.filterOptionsDto.maxResults;$("#quoteAgentsSelectionPopup").css("z-index",1999);$("#quoteAgentsSelectionPopup").modal("show")};var unbindWatcher2=$scope.$watch("agents",function(value){if(!value){if($scope.currentUser&&$scope.currentUser!=undefined){value=$scope.currentUser.username}}Utils.pageTitle("Dashboard [ "+value+" ]")});$scope.getStatusColor=function(rec){return Utils.getStatusColor(rec.status)};$scope.$on("$destroy",function(){unbindWatcher1();unbindWatcher2()})}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTaxLabel",["CustomerConstants",function(CustomerConstants){return{restrict:"E",scope:{countryCode:"=",taxInfo:"=",showGstNumber:"="},replace:false,template:"<span>{{taxLabel}}</span>",link:function(scope,element,attrs){scope.taxLabel="Tax/VAT";scope.$watch("countryCode",function(value){if(!value||!angular.isDefined(value)){return}scope.updateLabel()});scope.updateLabel=function(){if(scope.countryCode==CustomerConstants.NEWZEALAND_COUNTRY_CODE||scope.countryCode==CustomerConstants.AUSTRALIA_COUNTRY_CODE){if(scope.taxInfo&&scope.taxInfo.taxNumber&&scope.taxInfo.taxNumber.length>0&&!(angular.isDefined(scope.showGstNumber)&&scope.showGstNumber==false)){scope.taxLabel="Tax/GST("+scope.taxInfo.taxNumber+")"}else{scope.taxLabel="Tax/GST"}}};scope.updateLabel()}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TeamActionHistoryService",["$http",function($http){var service={};service.logActionHistoryForAddDrSeat=function(data){return $http({method:"POST",url:"../csuiService/subscription.do",data:data})};service.logActionHistoryForAddDrProduct=function(data){return $http({method:"POST",url:"../csuiService/subscription.do",data:data})};service.logActionHistoryForCancelDrSeat=function(data){return $http({method:"POST",url:"../csuiService/subscription.do",data:data})};service.logActionHistoryForCancelDrContract=function(data){return $http({method:"POST",url:"../csuiService/subscription.do",data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TeamAddSeatPriceDto",{provisionedSubTotal:"",currentPriceWithTax:"",currentPriceWithoutTax:"",currentQuantity:"",oneUnitPriceWithTax:"",oneUnitPriceWithoutTax:""});var app=app||angular.module("hxApp.directive",[]);app.constant("TeamConstants",{MESSAGE_ERROR_TYPE:"error",MESSAGE_INFO_TYPE:"info",MESSAGE_WARNING_TYPE:"warning",MESSAGE_SUCCESS_TYPE:"success",MESSAGE_PRIMARY_ALREADY_AVAILABLE:"An invitation for primary admin is open. Please revoke the existing invite and try again!",MESSAGE_NO_SECONDARY:"Please ensure the team has a secondary admin before initiating primary admin change!",PAYMENT_CC:"CREDIT_CARD",PAYMENT_DC:"DIRECT_CREDIT",PAYMENT_DD:"DIRECT_DEBIT",PAYMENT_OFFLINE:"OFFLINE",PAYMENT_PAYPAL:"PAYPAL",PAYMENT_PO:"PURCHASE_ORDER",PAYMENT_TYPE_CC:"Credit Card",PAYMENT_TYPE_DC:"Direct Credit",PAYMENT_TYPE_DD:"Direct Debit",PAYMENT_TYPE_OFFLINE:"Bank Transfer",PAYMENT_TYPE_PAYPAL:"PayPal",PAYMENT_TYPE_PO:"Purchase Order",ADMIN_VIEW_TYPE:"admin",CONTRACT_VIEW_TYPE:"contract",PRODUCT_VIEW_TYPE:"product",SEAT_VIEW_TYPE:"seat",TEAM_UNKNOWN:"UNKNOWN",IN_PROCESS:"In Process",TEAM_BILLING_FREQUENCY_ANNUAL:"ANNUAL",ALREADY_INVITED:"ALREADY_INVITED",PRIMARY_ADMIN_INVITEE_COUNTRY_CONFLICT:"PRIMARY_ADMIN_INVITEE_COUNTRY_CONFLICT",PRIMARY_ADMIN_FOR_ANOTHER_DIRECT_TEAM:"PRIMARY_ADMIN_FOR_ANOTHER_DIRECT_TEAM",OAUTH_TOKEN_IS_NOT_VALID:"Oauth token is not valid",UNSUPPORTED_TEAM_TYPE:"UNSUPPORTED_TEAM_TYPE",JEM_SERVER_ERROR:"JEM_SERVER_ERROR",PURCHASE_ORDER_NUMBER_IS_REQUIRED:"PURCHASE_ORDER_NUMBER_IS_REQUIRED",INVALID_PRODUCT_CODE:"INVALID_PRODUCT_CODE",SEAT_ALREADY_REQUESTED_FOR_DELETION:"SEAT_ALREADY_REQUESTED_FOR_DELETION",PAYMENT_STATUS_PENDING_PAYMENT:"PENDING_PAYMENT",PAYMENT_STATUS_PAID:"PAID",PAYMENT_STATUS_GRACE_PAST_DUE:"GRACE_PAST_DUE",PAYMENT_STATUS_PAST_DUE:"PAST_DUE",PAYMENT_STATUS_CANCELLING:"CANCELLING",PAYMENT_STATUS_CANCELLED:"CANCELLED",PAYMENT_STATUS_ACTIVE:"ACTIVE",PAYMENT_STATUS_ABNORMAL_TERM_DATE:"ABNORMAL_TERM_DATE",PAYMENT_STATUS_MSG_PENDING_PAYMENT:"Pending Payment",PAYMENT_STATUS_MSG_PAID:"Paid",PAYMENT_STATUS_MSG_GRACE_PAST_DUE:"Grace Past Due",PAYMENT_STATUS_MSG_PAST_DUE:"Past Due",PAYMENT_STATUS_MSG_CANCELLING:"Cancelling",PAYMENT_STATUS_MSG_CANCELLED:"Cancelled",PAYMENT_STATUS_MSG_ACTIVE:"Active",PAYMENT_STATUS_MSG_ABNORMAL_TERM_DATE:"Abnormal Term Date",RENEWAL_STATE_NON_RENEWAL:"NON_RENEWAL",RENEWAL_STATE_RENEWAL:"RENEWAL",RENEWAL_STATE_BEFORE_ANNIVERSARY_DATE:"BEFORE_ANNIVERSARY_DATE",RENEWAL_STATE_NON_RENEWAL_TXT:"Non Renewal",RENEWAL_STATE_RENEWAL_TXT:"Renewal",RENEWAL_STATE_BEFORE_ANNIVERSARY_DATE_TXT:"Before Anniversary Date",DELEGATE_STATUS_UNASSIGNED:"UNASSIGNED",DELEGATE_STATUS_ASSIGNED:"ASSIGNED",DELEGATE_STATUS_INVITED:"INVITED",ADMIN_TYPE_PRIMARY:"PRIMARY_ADMIN",ADMIN_TYPE_GROUP:"GRP_ADMIN",ADMIN_TYPE_INVITED:"INVITED",INVITATION_TYPE:"MEMBER",CONTRACT_TYPE_INDIRECT:"INDIRECT",CONTRACT_TYPE_DIRECT:"DIRECT",CASE_TYPE_TS:"TS",CASE_TYPE_CS:"CS",CASE_TYPE_EDU:"Edu",CASE_TYPE_RETURN:"Return",CASE_TYPE_ENTERPRISE:"Enterprise",TEAM_INVITE_PRIMARY:"CCM_TEAM_INVITE_PRIMARY",INITIALIZE_DM_TRANSACTION:"INITIALIZE_DM_TRANSACTION",INITIALIZE_CM_TRANSACTION:"INITIALIZE_CM_TRANSACTION",CREATE_DEBIT_MEMO_EVENT_FAILED:"CREATE_DEBIT_MEMO_EVENT_FAILED",CREATE_CREDIT_MEMO_EVENT_FAILED:"CREATE_CREDIT_MEMO_EVENT_FAILED",DEBIT_MEMO_VIEW_LOADED:"DEBIT_MEMO_VIEW_LOADED",CREDIT_MEMO_VIEW_LOADED:"CREDIT_MEMO_VIEW_LOADED",CREATE_DEBIT_MEMO_EVENT_SUCCESS:"CREATE_DEBIT_MEMO_EVENT_SUCCESS",CREATE_CREDIT_MEMO_EVENT_SUCCESS:"CREATE_CREDIT_MEMO_EVENT_SUCCESS",SAVE_MIGRATION_PATH_UNAVAILABLE:"SAVE MIGRATION PATH UNAVAILABLE",SAVE_OTHER_MANDATORY_TEXT:"OTHER REASON",CANCEL_SELECTION_WITH_PENALTY:"1",CANCEL_SELECTION_WITHOUT_FEE:"2",CANCEL_SELECTION_WITH_REFUND:"3",CANCEL_SELECTION_SAVE:"4",TRANSACTION_CREDIT_MEMO:"ZCCR",SELF_CANCELLATION_CM_REASON_CODE:"SCC",SELF_CANCELLATION_DM_REASON_CODE:"SCD",WIZARD_STEP_CANCEL_SEAT_REASON:"1",WIZARD_STEP_CANCEL_SEAT_LISTS:"2",WIZARD_STEP_CANCEL_CRITERIA:"3",WIZARD_STEP_DEBIT_MEMO:"4",WIZARD_STEP_DEBIT_MEMO_CONFIRM:"5",WIZARD_STEP_REFUND_REASON:"6",WIZARD_STEP_CREDIT_MEMO:"7",WIZARD_STEP_CREDIT_MEMO_CONFIRM:"8",WIZARD_STEP_WITHOUT_FEE_REASON:"9",WIZARD_STEP_WITHOUT_FEE_CONFIRM:"10",WIZARD_STEP_SAVE_MOVE_TO_CCT:"11",WIZARD_STEP_SAVE_MOVE_TO_CCT_CONFIRM:"12",WIZARD_STEP_SAVE_OTHERS_PREVIEW:"13",WIZARD_STEP_SAVE_OTHERS:"14",WIZARD_STEP_SAVE_OTHERS_CONFIRM:"15",WIZARD_STEP_PREVIEW_DR_CANCELLATION:"16",WIZARD_STEP_PREVIEW_DR_CONFIRMATION:"17",TEAM_PAYMENT_STATUS_TEMPLATES:[{name:"PAID",code:"PAID",description:"Seat is provisioned and paid for."},{name:"PENDING_PAYMENT",code:"PENDING_PAYMENT",description:"Seat is provisioned, but awaiting payment."},{name:"GRACE_PAST_DUE",code:"GRACE_PAST_DUE",description:"Seats is active but in grace period for payment."},{name:"PAST_DUE",code:"PAST_DUE",description:"Seats is active but payment is past due."},{name:"CANCELLING",code:"CANCELLING",description:"Seat is active now but will be cancelled on next billing date."},{name:"CANCELLED",code:"CANCELLED",description:"Seat is cancelled (inactive)."},{name:"ABNORMAL_TERM_DATE",code:"ABNORMAL_TERM_DATE",description:"Inconsistent payment info. Please reach out to JEM support"}],TEAM_STATUS_TEMPLATES:[{name:"PAID",code:"PAID",description:"All seats are active & paid for."},{name:"PENDING_PAYMENT",code:"PENDING_PAYMENT",description:"All seats are active but awaiting payment."},{name:"GRACE_PAST_DUE",code:"GRACE_PAST_DUE",description:"All seats are active but in grace period for payment."},{name:"PAST_DUE",code:"PAST_DUE",description:"All seats are active but payment is past due."},{name:"CANCELLING",code:"CANCELLING",description:"Seats are active now but will be cancelled on next billing date."},{name:"CANCELLED",code:"CANCELLED",description:"All seats are cancelled (inactive)."},{name:"ACTIVE",code:"ACTIVE",description:"Some of the seats are active."},{name:"ABNORMAL_TERM_DATE",code:"ABNORMAL_TERM_DATE",description:"Inconsistent payment info. Please reach out to JEM support"}]});var app=app||angular.module("hxApp",["ngRoute","ngSanitize"]);app.controller("TeamController",["$scope","$routeParams","$rootScope","$app","$interpolate","$location","AppUtils","AppConstants","MetadataService","ImsCustomerService","TeamUtil","TeamConstants","TeamService","PaymentConstants","TransactionConstants","$q","TeamProductService","SubscriptionService","$app","DrTeamAddSeatDto","DrTeamService","DrTeamCartItemDto","AddDRSeatDto","DrTeamCancelContractDto","DrTeamCancelLicenseDto","TeamActionHistoryService","ActionHistoryDto",function($scope,$routeParams,$rootScope,$app,$interpolate,$location,AppUtils,AppConstants,MetadataService,ImsCustomerService,TeamUtil,TeamConstants,TeamService,PaymentConstants,TransactionConstants,$q,TeamProductService,SubscriptionService,$app,DrTeamAddSeatDto,DrTeamService,DrTeamCartItemDto,AddDRSeatDto,DrTeamCancelContractDto,DrTeamCancelLicenseDto,TeamActionHistoryService,ActionHistoryDto){$scope.messages="";$scope.PaymentConstants=PaymentConstants;$scope.TransactionConstants=TransactionConstants;$scope.TeamConstants=TeamConstants;$scope.inviteAdminFirstName="";$scope.inviteAdminLastName="";$scope.inviteAdminEmail="";$scope.invitationMessage="";$scope.inviteDelegateFirstName="";$scope.inviteDelegateLastName="";$scope.inviteDelegateEmail="";$scope.invitationDelegateMessage="";$scope.isCustomerHeaderLoading=true;$scope.showPaymentDetails=false;$scope.isInviteAdminProcessing=false;$scope.isShowSeatDetails=false;$scope.isAddProduct=true;$scope.isCancellingDRSeatInProgress=false;$scope.transaction={};$scope.transaction.paymentDetails={};$scope.metadata=new Object();$scope.metadata.subscriptionMetadata=new Object();$scope.cancelReason={};$scope.cancelReason.selectedId="";$scope.isCsCaseExists="Yes";$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isSaveOthersCsCaseExist=true;$scope.isDRContractCancellingProcessing=false;$scope.isCancelContractPreviewLoading=false;$scope.isContractCancellationSuccess=false;$scope.teamId=$routeParams.teamId;$scope.customerGuid=$routeParams.customerGuid;$scope.rengaId=$scope.customerGuid.split("@")[0];$scope.locale="en_US";$scope.offerId=_.has($routeParams,"offerId")?$routeParams.offerId:"";$scope.viewType=_.has($routeParams,"viewType")?$routeParams.viewType:"product";AppUtils.initializeModule(AppConstants.MODULE_JILTEAM,function(metadataObject,moduleStatus){$scope.metadata=metadataObject;if(moduleStatus==AppConstants.MODULE_INIT_METADATA_SUCCESS){console.info("Jil Team Module Metadata Loaded Successfully");$scope.processModule()}else{if(moduleStatus==AppConstants.MODULE_INIT_METADATA_FAILED){console.error("Error loading metadata in Jil Team Module")}else{console.error("Team Module - Unexpected Error, Please reload the application")}}$scope.initializeCaseCategories()});$scope.initializeCaseCategories=function(){$scope.caseCategories=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.META_PRODUCT_CATEGORIES],function(item){if(item.name.indexOf("*")!=0&&item.code=="Y06"){$scope.caseCategories.push(item)}});$scope.creditMemoReturnReasons=[];angular.forEach($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],function(reasonItem){var cmReasonItem=angular.copy(reasonItem);if(cmReasonItem[MetadataService.INDEX_NAMES.ORDER_TYPE]==TeamConstants.TRANSACTION_CREDIT_MEMO){if(cmReasonItem.code==TeamConstants.SELF_CANCELLATION_CM_REASON_CODE){}else{$scope.creditMemoReturnReasons.push(cmReasonItem)}}});SubscriptionService.getSubscriptionMetadata().success(function(result){$scope.metadata.subscriptionMetadata=result}).error(function(result){})};$scope.processModule=function(){$scope.updateView($scope.viewType);$scope.customerHeaderDetails();$scope.TeamSubscriptionDetails();$scope.actionHistory()};$scope.customerHeaderDetails=function(){$scope.isCustomerHeaderLoading=true;var customerDetailsRequestObj={guid:$scope.rengaId,authSrc:"AdobeID"};ImsCustomerService.getCustomerProfileByGuid(customerDetailsRequestObj).success(function(result,status,headers,config){$scope.isCustomerHeaderLoading=false;$scope.customerDetails=TeamUtil.getCustomerHeaderDetails(result);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_IMS_RENGA,true,result);messageObject.Functionality="Team Subscription - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isCustomerHeaderLoading=false;$scope.messagesForCustomer=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load customer details.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_IMS_RENGA,false,result);messageObject.Functionality="Team Subscription - Search Customer";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.TeamSubscriptionDetails=function(){var teamDetailsRequestObj={customerGuid:$scope.rengaId,teamId:$scope.teamId,locale:$scope.locale};TeamService.getTeamSubscriptionDetails(teamDetailsRequestObj).success(function(result,status,headers,config){if(angular.isObject(result)){$scope.teamDetails=TeamUtil.getTeamDetails(result,$scope.rengaId);$scope.getCustomerNoFromCRM($scope.teamDetails);if($scope.offerId!=""){$scope.selectProduct($scope.offerId)}$scope.isProductShow=false;$scope.isRolesShow=true;if($scope.teamDetails.marketSegment=="COMMERCIAL"||$scope.teamDetails.marketSegment=="EDUCATION"){$scope.isAddProduct=false}if($scope.teamDetails.type.toUpperCase()==TeamConstants.CONTRACT_TYPE_INDIRECT){$scope.isAddProduct=true}var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Fetch Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.messages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"This team subscription is not valid.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Fetch Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}$app.hideLoading()}).error(function(result,status,headers,config){if(status==504){$scope.messages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. Please check the subscription after 5 minutes before attempting to reprocess.")}else{$scope.messages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load team subscription details")}$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Fetch Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.actionHistory=function(){$scope.actionHistoryLoading=true;$scope.actionHistoryList="";TeamService.actionHistory({teamId:$scope.teamId.split("@")[0]}).success(function(result,status,headers,config){$scope.actionHistoryList=result;$scope.actionHistoryLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE_DB,true,result);messageObject.Functionality="Team Subscription - Fetch Action History Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.actionHistoryMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load action history");$scope.actionHistoryLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_COMMERCE_DB,false,result);messageObject.Functionality="Team Subscription - Fetch Action History Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getCustomerNoFromCRM=function(teamDetails){$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:$scope.rengaId,customerType:"1",authSrc:"AdobeID"};TeamService.search($scope.searchFields).success(function(result,status,headers,config){if(result&&result.customerSearchResults&&result.customerSearchResults.length==1){$scope.customerNo=result.customerSearchResults[0].customerNo;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,true,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.customerNo="";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,false,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.checkIsAddSeatAvailable=function(offerId){var isAddSeatNotAvailable=false;if($scope.teamDetails.billingFrequency==TeamConstants.TEAM_UNKNOWN){isAddSeatNotAvailable=true}if($scope.teamDetails.type.toUpperCase()==TeamConstants.CONTRACT_TYPE_INDIRECT){isAddSeatNotAvailable=true}if(!$scope.teamDetails.isEditable){isAddSeatNotAvailable=true}return isAddSeatNotAvailable};$scope.filterSeatDetails=function(seatList){function CustomDelegateStatusOrder(item){switch(item){case"ASSIGNED":return 1;case"INVITED":return 2;case"UNASSIGNED":return 3}}var filteredSeatList=[];angular.forEach(seatList,function(item){filteredSeatList.push(item)});filteredSeatList.sort(function(a,b){return(CustomDelegateStatusOrder(a.delegateStatus)>CustomDelegateStatusOrder(b.delegateStatus)?1:-1)});return filteredSeatList};$scope.selectProduct=function(offerId){TeamUtil.addParameterToUrl("offerId",offerId);$scope.seatListForDelete=[];$scope.seatListForCancel=[];$scope.teamDetails.isAddSeatNotAvailable=false;if(offerId!=""){$scope.isNoSeatAvailableForDelete=false;$scope.isNoSeatAvailableForCancel=false;$scope.productDetails=_.filter(_.uniqBy($scope.teamDetails.seatDetails,_.property("offerId")),{offerId:offerId})[0];$scope.productData=_.filter(_.uniqBy($scope.teamDetails.seatDetails,_.property("offerId")),{offerId:offerId});$scope.seatDetails=_.filter($scope.teamDetails.seatDetails,{offerId:offerId});$scope.productData[0].totalSeats=$scope.getSeats(offerId);if($scope.teamDetails.billingFrequency==TeamConstants.TEAM_UNKNOWN){$scope.teamDetails.isAddSeatNotAvailable=true}if($scope.teamDetails.type.toUpperCase()==TeamConstants.CONTRACT_TYPE_INDIRECT){$scope.teamDetails.isAddSeatNotAvailable=true;$scope.isNoSeatAvailableForCancel=true}if(!$scope.teamDetails.isEditable){$scope.teamDetails.isAddSeatNotAvailable=true;$scope.isNoSeatAvailableForDelete=true;$scope.isNoSeatAvailableForCancel=true}angular.forEach($scope.seatDetails,function(seat){if(seat.isRemoveDelegateAvailable){$scope.seatListForDelete.push(seat)}});if($scope.seatListForDelete.length==0){$scope.isNoSeatAvailableForDelete=true}angular.forEach($scope.seatDetails,function(seat){if(seat.isCancelAvailable&&seat.paymentStatus!=TeamConstants.PAYMENT_STATUS_CANCELLING&&seat.paymentStatus!=TeamConstants.PAYMENT_STATUS_CANCELLED){$scope.seatListForCancel.push(seat)}});if($scope.seatListForCancel.length==0){$scope.isNoSeatAvailableForCancel=true}$scope.isShowSeatDetails=true;$scope.offerId=offerId}};$scope.updateView=function(viewType){$scope.viewType=viewType;if(viewType=="admin"){TeamUtil.addParameterToUrl("viewType","admin");$("#adminTab").addClass("active");$("#contractTab").removeClass("active");$("#productTab").removeClass("active");$("#historyTab").removeClass("active");$("#administratorDetails").addClass("active");$("#contractDetails").removeClass("active");$("#productDetails").removeClass("active");$("#actionHistory").removeClass("active")}else{if(viewType=="contract"){TeamUtil.addParameterToUrl("viewType","contract");$("#adminTab").removeClass("active");$("#contractTab").addClass("active");$("#productTab").removeClass("active");$("#historyTab").removeClass("active");$("#contractDetails").addClass("active");$("#administratorDetails").removeClass("active");$("#productDetails").removeClass("active");$("#actionHistory").removeClass("active")}else{if(viewType=="product"){TeamUtil.addParameterToUrl("viewType","product");$("#adminTab").removeClass("active");$("#contractTab").removeClass("active");$("#productTab").addClass("active");$("#historyTab").removeClass("active");$("#administratorDetails").removeClass("active");$("#contractDetails").removeClass("active");$("#productDetails").addClass("active");$("#actionHistory").removeClass("active")}else{if(viewType=="history"){TeamUtil.addParameterToUrl("viewType","history");$("#adminTab").removeClass("active");$("#contractTab").removeClass("active");$("#productTab").removeClass("active");$("#historyTab").addClass("active");$("#administratorDetails").removeClass("active");$("#contractDetails").removeClass("active");$("#productDetails").removeClass("active");$("#actionHistory").addClass("active")}}}}};$scope.backToProductDetails=function(){$scope.isShowSeatDetails=false;$scope.updateView("product");TeamUtil.removeParameterFromUrl("offerId");$scope.offerId=""};$scope.addProduct=function(){var addProductUrl="";var countryCode;if($scope.teamDetails.isDrContract){countryCode=_.has($scope.customerDetails,"countryCode")?$scope.customerDetails.countryCode:""}else{countryCode=$scope.teamDetails.countryCode}if($scope.teamDetails.marketSegment=="COMMERCIAL"){addProductUrl="/sales?store="+countryCode+"&productType=TEAM_DIRECT&id="+$scope.rengaId}else{if($scope.teamDetails.marketSegment=="EDUCATION"){addProductUrl="/sales?store="+countryCode+"-EDU&productType=TEAM_DIRECT&id="+$scope.rengaId}}if($scope.teamDetails.billingFrequency=="ANNUAL"){addProductUrl=addProductUrl+"&commitment=YEAR_PREPAID&billing=ANNUAL"}else{if($scope.teamDetails.billingFrequency=="MONTHLY"){addProductUrl=addProductUrl+"&commitment=YEAR"}}$location.$$search={};$location.$$compose();$location.url(addProductUrl)};$scope.cancelDRContractPreview=function(){var cancelContractDto=angular.copy(DrTeamCancelContractDto);cancelContractDto.cancelledBy=$rootScope.currentUser.username;cancelContractDto.status="PREVIEW";$scope.drModalHeader="Cancel Contract Preview";$scope.drModalMessages=[];$scope.isCancelContractPreviewLoading=true;$scope.isContractCancellationSuccess=false;$scope.isCancelContractPreviewFail=false;$("#cancelContractDRModal").modal("show");DrTeamService.cancelDRContract($scope.teamId,cancelContractDto).success(function(result,status,headers,config){$scope.cancelContractPreview=result;$scope.isCancelContractPreviewLoading=false}).error(function(error,status,headers,config){$scope.isCancelContractPreviewLoading=false;$scope.isCancelContractPreviewFail=true;var errorDetails=TeamUtil.standardErrorDrMessage(error);$scope.drModalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message)})};$scope.cancelDRContractConfirm=function(){$scope.cancelContractPreview.status="CANCELLING";$scope.isDRContractCancellingProcessing=true;DrTeamService.cancelDRContract($scope.teamId,$scope.cancelContractPreview).success(function(result,status,headers,config){$scope.isDRContractCancellingProcessing=false;$scope.isContractCancellationSuccess=true;$scope.drModalHeader="Cancel Contract Confirmation";$scope.drModalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Contract successfully cancelled");var actionHistoryDto=angular.copy(ActionHistoryDto);actionHistoryDto.noteType="SUBSCRIPTION";actionHistoryDto.note=$scope.teamDetails.externalContractId+" contract cancelled by "+result.cancelledBy;actionHistoryDto.reasonCode=result.cancellationReason;actionHistoryDto.orderNumber=$scope.teamDetails.externalContractId;actionHistoryDto.eccContractId=$scope.teamDetails.externalContractId;actionHistoryDto.subType="TEAM";actionHistoryDto.reasonType="SEAT_MGMT";actionHistoryDto.guid=$scope.rengaId;actionHistoryDto.userId=0;actionHistoryDto.agentId=0;actionHistoryDto.cancellationValue=_.has(result,"fee.amountWithoutTax")?Math.abs(result.fee["amountWithoutTax"]):0;actionHistoryDto.event.eventType="CCT_DR_CANCEL_CONTRACT";actionHistoryDto.event.comments=$scope.teamId.split("@")[0];actionHistoryDto.event.guid=$scope.customerGuid.split("@")[0];TeamActionHistoryService.logActionHistoryForCancelDrContract(actionHistoryDto).success(function(result){$scope.resultMessage=result}).error(function(error){$scope.errorMessage=error});var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="DR Team Subscription - Cancel contract";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isDRContractCancellingProcessing=false;$scope.isContractCancellationSuccess=true;$scope.drModalHeader="Cancel Contract Confirmation";$scope.drModalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,error.errorMessage);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,error);messageObject.Functionality="DR Team Subscription - Cancel contract";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.closeCancelContractModal=function(){$scope.isDRContractCancellingProcessing=false;$scope.isDRContractCancellingProcessing=false;$scope.drModalMessages=[];if($scope.isContractCancellationSuccess){$scope.refreshTeamSubscriptionDetails()}$("#cancelContractDRModal").modal("hide")};$scope.refreshTeamSubscriptionDetails=function(){$scope.viewType=_.has($scope,"viewType")?$scope.viewType:"product";$location.$$search={};$location.$$compose();var templateUrl="/team?teamId="+$scope.teamId+"&customerGuid="+$scope.customerGuid+"&viewType="+$scope.viewType;if($scope.offerId){templateUrl=templateUrl+"&offerId="+$scope.offerId}if($scope.cancelSeat){templateUrl=templateUrl+"&cancelSeat="+$scope.cancelSeat}$location.url(templateUrl);location.reload()};$scope.inviteAdmin=function(){$scope.isInviteAdminProcessing=false;$scope.modalMessages="";$scope.inviteAdminFirstName="";$scope.inviteAdminLastName="";$scope.inviteAdminEmail="";$scope.invitationMessage="";$("#inviteAdminModal").modal("show")};$scope.closeInviteAdmin=function(){$scope.isInviteAdminProcessing=false;$("#inviteAdminModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelInviteAdmin=function(){$scope.isInviteAdminProcessing=false;$("#inviteAdminModal").modal("hide")};$scope.isValidateInviteAdminForm=function(){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if($scope.inviteAdminFirstName&&$scope.inviteAdminLastName&&$scope.inviteAdminEmail){$scope.isValidatedInviteAdminForm=true;if($scope.inviteAdminEmail&&$scope.inviteAdminEmail!=""){$scope.isValidatedInviteAdminForm=re.test($scope.inviteAdminEmail)}}else{$scope.isValidatedInviteAdminForm=false}return $scope.isValidatedInviteAdminForm};$scope.inviteAdminRequest=function(){$scope.isInviteAdminProcessing=true;$scope.isInviteAdminProcessSuccess="";$scope.modalMessages="";$scope.invitationAdminRequestBody={};$scope.invitationAdminRequestBody.jsonValue={invitationType:TeamConstants.ADMIN_TYPE_GROUP,invitations:[{firstName:$scope.inviteAdminFirstName,lastName:$scope.inviteAdminLastName,email:$scope.inviteAdminEmail}],invitationMessage:$scope.invitationMessage};$scope.invitationAdminRequestBody.note={noteType:"SUBSCRIPTION",note:"Admin Email: "+$scope.inviteAdminEmail,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_ADMN.",guid:$scope.rengaId,userId:0,agentId:0,event:{eventType:"CCT_INVITE_ADMIN",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.inviteSecondayAdmin({teamId:$scope.teamId,invitationAdminRequestBody:$scope.invitationAdminRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){if(result[0].invitationSuccessful){$scope.isInviteAdminProcessing=false;$scope.isInviteAdminProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.inviteAdminFirstName+" "+$scope.inviteAdminLastName+" has been invited as Secondary admin.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Invite Secondary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Invite Secondary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.isInviteAdminProcessing=false;$scope.isInviteAdminProcessSuccess=true;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Invite Secondary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.revokeAdmin=function(adminDetails){$scope.isRevokeAdminProcessing=false;$scope.isInvitedAsSecondary=adminDetails.isInvitedAsSecondary;$scope.isInvitedAsPrimary=adminDetails.isInvitedAsPrimary;$scope.isSecondaryAdmin=adminDetails.isSecondaryAdmin;$scope.isPrimaryAdmin=adminDetails.isPrimaryAdmin;$scope.firstName=adminDetails.firstName;$scope.lastName=adminDetails.lastName;$scope.invitationCode=_.has(adminDetails,"invitation.invitationCode")?adminDetails.invitation["invitationCode"]:"";$scope.revokeAdminRequestBody={emailsList:[adminDetails.email]};$scope.modalMessages="";$("#removeSecondaryAdminModal").modal("show");console.log(adminDetails)};$scope.closeRevokeAdmin=function(){$scope.isRevokeAdminProcessing=false;$("#removeSecondaryAdminModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelRevokeAdmin=function(){$scope.isRevokeAdminProcessing=false;$("#removeSecondaryAdminModal").modal("hide")};$scope.revokeAdminRequest=function(){$scope.isRevokeAdminProcessing=true;if(($scope.isInvitedAsPrimary||$scope.isInvitedAsSecondary)&&$scope.invitationCode){$scope.revokeAdminNoteDetails={noteType:"SUBSCRIPTION",note:"Admin Email: "+$scope.revokeAdminRequestBody.emailsList[0],orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_ADMN.",guid:$scope.rengaId,userId:0,agentId:0,event:{eventType:"CCT_REMOVE_ADMIN_INVITATION",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.revokeInviteAdmin({invitationCode:$scope.invitationCode,locale:$scope.locale,noteDto:$scope.revokeAdminNoteDetails}).success(function(result,status,headers,config){$scope.isRevokeAdminProcessing=false;$scope.isRevokeAdminProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Invitation to "+$scope.firstName+" "+$scope.lastName+" has been revoked.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Revoke Admin Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isRevokeAdminProcessing=false;$scope.isRevokeAdminProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Revoke Admin Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)})}else{$scope.revokeAdminRequestBodyDetails={};$scope.revokeAdminRequestBodyDetails.jsonValue=$scope.revokeAdminRequestBody;$scope.revokeAdminRequestBodyDetails.note={noteType:"SUBSCRIPTION",note:"Admin Email: "+$scope.revokeAdminRequestBody.emailsList[0],orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_ADMN.",guid:$scope.rengaId,userId:0,agentId:0,event:{eventType:"CCT_REMOVE_ADMIN",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.revokeAdmin({teamId:$scope.teamId,revokeAdminRequestBody:$scope.revokeAdminRequestBodyDetails,locale:$scope.locale}).success(function(result,status,headers,config){$scope.isRevokeAdminProcessing=false;$scope.isRevokeAdminProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.firstName+" "+$scope.lastName+" has been removed as Secondary admin.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Revoke Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isRevokeAdminProcessing=false;$scope.isRevokeAdminProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Revoke Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})}};$scope.closeReinviteAdmin=function(){$scope.isReinviteAdminProcessing=false;$("#reinviteAdminModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelReinviteAdmin=function(){$scope.isReinviteAdminProcessing=false;$("#reinviteAdminModal").modal("hide")};$scope.reInviteAdmin=function(adminDetails){$scope.isReinviteAdminProcessing=false;$scope.firstName=adminDetails.firstName;$scope.lastName=adminDetails.lastName;$scope.email=adminDetails.email;$scope.modalMessages="";$("#reinviteAdminModal").modal("show");console.log(adminDetails);$scope.reInviteAdminRequestBody={};$scope.reInviteAdminRequestBody.jsonValue=[$scope.email]};$scope.reInviteAdminRequest=function(){$scope.isReinviteAdminProcessing=true;$scope.reInviteAdminRequestBody.note={noteType:"SUBSCRIPTION",note:"Admin Email: "+$scope.email,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_ADMN.",guid:$scope.rengaId,userId:0,agentId:0,event:{eventType:"CCT_REINVITE_ADMIN",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.reInviteAdmin({teamId:$scope.teamId,reInviteAdminRequestBody:$scope.reInviteAdminRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){if(result[0].invitationSuccessful){$scope.isReinviteAdminProcessing=false;$scope.isReinviteAdminProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Invitation has been resent to "+$scope.firstName+" "+$scope.lastName);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Resent Admin Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Resent Admin Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.isReinviteAdminProcessing=false;$scope.isReinviteAdminProcessSuccess=true;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Resent Admin Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getSeats=function(offerId){var qty=0;angular.forEach($scope.teamDetails.seatDetails,function(seat){if(offerId==seat.offerId&&seat.paymentStatus&&seat.paymentStatus.toUpperCase()!=="CANCELLED"){qty++}});return qty};$scope.getPayments=function(offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter($scope.teamDetails.seatDetails,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus};$scope.changePrimary=function(administrators){$scope.modalMessages="";$scope.isChangePrimaryProcessing=false;$scope.administrators=administrators;$scope.secondaryCount=0;$scope.isInviteAsPrimaryAvailable=false;$scope.isNoSecondaryAdminAvailable=false;$scope.isOneSecondaryAdminAvailable=false;$scope.isMoreSecondaryAdminAvailable=false;$scope.inviteAdminFirstName="";$scope.inviteAdminLastName="";$scope.inviteAdminEmail="";$scope.invitationMessage="";$scope.secondaryList=[];angular.forEach($scope.administrators,function(admin){if(admin.isInvitedAsPrimary){$scope.isInviteAsPrimaryAvailable=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_INFO_TYPE,TeamConstants.MESSAGE_PRIMARY_ALREADY_AVAILABLE)}if(admin.isSecondaryAdmin){$scope.secondaryList.push(admin)}if(admin.isPrimaryAdmin){$scope.primaryEmail=admin.email}});if($scope.secondaryList.length==0&&!$scope.isInviteAsPrimaryAvailable){$scope.isNoSecondaryAdminAvailable=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_INFO_TYPE,TeamConstants.MESSAGE_NO_SECONDARY)}else{if($scope.secondaryList.length==1&&!$scope.isInviteAsPrimaryAvailable){$scope.isOneSecondaryAdminAvailable=true;$scope.selectSecondaryAdmin($scope.secondaryList[0])}else{if($scope.secondaryList.length>=2&&!$scope.isInviteAsPrimaryAvailable){$scope.isMoreSecondaryAdminAvailable=true}}}$("#changePrimaryModal").modal("show")};$scope.changePrimaryRequest=function(){$scope.isChangePrimaryProcessing=true;$scope.invitationAdminRequestBody={};$scope.invitationAdminRequestBody.jsonValue={invitationType:TeamConstants.ADMIN_TYPE_PRIMARY,invitations:[{firstName:$scope.inviteAdminFirstName,lastName:$scope.inviteAdminLastName,email:$scope.inviteAdminEmail}],invitationMessage:$scope.invitationMessage};$scope.invitationAdminRequestBody.note={noteType:"SUBSCRIPTION",note:"Previous Admin Email: "+$scope.primaryEmail,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_ADMN.",guid:$scope.rengaId,userId:0,agentId:0,event:{eventType:"CCT_CHANGE_ADMIN",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.inviteSecondayAdmin({teamId:$scope.teamId,invitationAdminRequestBody:$scope.invitationAdminRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){if(result[0].invitationSuccessful){$scope.isChangePrimaryProcessing=false;$scope.isChangePrimaryProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Secondary admin "+$scope.inviteAdminFirstName+" "+$scope.inviteAdminLastName+" has been invited to the role of Primary admin.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Change Primary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.isChangePrimaryProcessing=false;$scope.isChangePrimaryProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Change Primary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.isChangePrimaryProcessing=false;$scope.isChangePrimaryProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Change Primary Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.closeChangePrimary=function(){$scope.isChangePrimaryProcessing=false;$("#changePrimaryModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelChangePrimary=function(){$scope.isChangePrimaryProcessing=false;$("#changePrimaryModal").modal("hide")};$scope.selectSecondaryAdmin=function(admin){console.log(admin);$scope.inviteAdminFirstName=admin.firstName;$scope.inviteAdminLastName=admin.lastName;$scope.inviteAdminEmail=admin.email};$scope.createCase=function(product,caseType){var returnCaseTemplateUrl="";$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:$scope.rengaId,customerType:"1",authSrc:"AdobeID"};TeamService.search($scope.searchFields).success(function(result,status,headers,config){if(result&&result.customerSearchResults){angular.forEach(result.customerSearchResults,function(searchResult){if($scope.rengaId==searchResult.rengaGuid){$scope.customerNo=searchResult.customerNo;if(caseType==TeamConstants.CASE_TYPE_TS){returnCaseTemplateUrl="/case/newTs?customerNo="+$scope.customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&productSku="+product.sku+"&contextType=TEAM&tenureDate="}else{if(caseType==TeamConstants.CASE_TYPE_CS){returnCaseTemplateUrl="/case/newCs?customerNo="+$scope.customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+product.sku+"&contextType=TEAM&tenureDate="}else{if(caseType==TeamConstants.CASE_TYPE_EDU){returnCaseTemplateUrl="/case/newCs/?customerNo="+$scope.customerNo+"&regType=&prodMetaName="+product.productName+"&prodMetaLanguage=&prodMetaConfig=&prodMetaPlatform=&prodName="+product.productCode+"&prodPlatform=&prodLang=&prodVersion=&tempId=template_default_edu&productType=&productSegment=&tenureDate="}else{if(caseType==TeamConstants.CASE_TYPE_RETURN){returnCaseTemplateUrl="/case/newCs/?customerNo="+$scope.customerNo+"&regType=&prodMetaName="+product.productName+"&prodMetaLanguage=&prodMetaConfig=&prodMetaPlatform=&prodName="+product.productCode+"&prodPlatform=&prodLang=&prodVersion=&tempId=template_default_return&productType=&productSegment=&tenureDate="}else{if(caseType==TeamConstants.CASE_TYPE_ENTERPRISE){returnCaseTemplateUrl="/case/newCs/?customerNo="+$scope.customerNo+"&regType=&prodMetaName="+product.productName+"&prodMetaLanguage=&prodMetaConfig=&prodMetaPlatform=&prodName="+product.productCode+"&prodPlatform=&prodLang=&prodVersion=&tempId=template_default_cs_enterprise&productType=&productSegment=&tenureDate="}}}}}if(returnCaseTemplateUrl){window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)}var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,true,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)}})}else{var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,true,result);messageObject.Functionality="Team Subscription - CRM Customer Search - Search result is blank.";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.customerNo="";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,false,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.closeTeamDetails=function(){$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:$scope.rengaId,customerType:"1",authSrc:"AdobeID"};TeamService.search($scope.searchFields).success(function(result,status,headers,config){if(result&&result.customerSearchResults&&result.customerSearchResults.length==1){$scope.customerNo=result.customerSearchResults[0].customerNo;var returnCaseTemplateUrl="/customer/"+$scope.customerNo+"/subscription/team";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,true,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config);$location.url(returnCaseTemplateUrl)}}).error(function(result,status,headers,config){$scope.customerNo="";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,false,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.closeInviteDelegate=function(){$scope.isInviteDelegateProcessing=false;$("#inviteDelegateModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelInviteDelegate=function(){$scope.isInviteDelegateProcessing=false;$("#inviteDelegateModal").modal("hide")};$scope.inviteDelegate=function(productDetails,seatDetails){$scope.isInviteDelegateProcessing=false;$scope.modalMessages="";$scope.inviteDelegateFirstName="";$scope.inviteDelegateLastName="";$scope.inviteDelegateEmail="";$scope.invitationDelegateMessage="";$scope.productCode=productDetails.productCode;$scope.productLanguage=productDetails.language;$scope.fulfillableEntitlementId=seatDetails.fulfillableEntitlementId;$("#inviteDelegateModal").modal("show")};$scope.isValidateInviteDelegateForm=function(){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if($scope.inviteDelegateFirstName&&$scope.inviteDelegateLastName&&$scope.inviteDelegateEmail){$scope.isValidatedInviteDelegateForm=true;if($scope.inviteDelegateEmail&&$scope.inviteDelegateEmail!=""){$scope.isValidatedInviteDelegateForm=re.test($scope.inviteDelegateEmail)}}else{$scope.isValidatedInviteDelegateForm=false}return $scope.isValidatedInviteDelegateForm};$scope.inviteDelegateRequest=function(){$scope.isInviteDelegateProcessing=true;$scope.isInviteDelegateProcessSuccess="";$scope.modalMessages="";$scope.inviteDelegateRequestBody={};$scope.inviteDelegateRequestBody.jsonValue={invitationType:TeamConstants.INVITATION_TYPE,invitations:[{firstName:$scope.inviteDelegateFirstName,lastName:$scope.inviteDelegateLastName,productCode:$scope.productCode,productLanguage:$scope.productLanguage,fulfillableEntitlementId:$scope.fulfillableEntitlementId,email:$scope.inviteDelegateEmail}],invitationMessage:$scope.invitationDelegateMessage};$scope.inviteDelegateRequestBody.note={noteType:"SUBSCRIPTION",note:"Delegate Email: "+$scope.inviteDelegateEmail,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_DELG.",guid:$scope.rengaId,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,sku:$scope.productDetails.sku,userId:0,agentId:0,event:{eventType:"CCT_INVITE_DELEGATE",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.inviteDelegate({teamId:$scope.teamId,inviteDelegateRequestBody:$scope.inviteDelegateRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){if(result[0].invitationSuccessful){$scope.isInviteDelegateProcessing=false;$scope.isInviteDelegateProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.inviteDelegateFirstName+" "+$scope.inviteDelegateLastName+" has been invited as delegate for the seat.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.isInviteDelegateProcessing=false;$scope.isInviteDelegateProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.resendInviteDelegate=function(seatInfo){$scope.isResendInviteDelegateProcessing=false;$scope.firstName=seatInfo.firstName;$scope.lastName=seatInfo.lastName;$scope.email=seatInfo.email;$scope.fulfilledEntitlementId=seatInfo.fulfilledEntitlementId;$scope.resendInviteDelegateRequestBody={};$scope.modalMessages="";$("#resendInviteDelegateModal").modal("show");console.log(seatInfo);$scope.resendInviteDelegateRequestBody.jsonValue=[{email:$scope.email,fulfilledEntitlementId:$scope.fulfilledEntitlementId}]};$scope.cancelResendInviteDelegate=function(){$scope.isResendInviteDelegateProcessing=false;$("#resendInviteDelegateModal").modal("hide")};$scope.resendInviteDelegateRequest=function(){$scope.isResendInviteDelegateProcessing=true;$scope.resendInviteDelegateRequestBody.note={noteType:"SUBSCRIPTION",note:"Delegate Email: "+$scope.email,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_DELG.",guid:$scope.rengaId,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,sku:$scope.productDetails.sku,userId:0,agentId:0,event:{eventType:"CCT_REINVITE_DELEGATE",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.resendInviteDelegate({teamId:$scope.teamId,resendInviteDelegateRequestBody:$scope.resendInviteDelegateRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){if(result[0].invitationSuccessful){$scope.isResendInviteDelegateProcessing=false;$scope.isResendInviteDelegateProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Invitation has been resent to "+$scope.firstName+" "+$scope.lastName);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Resent Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}else{$scope.isResendInviteDelegateProcessing=false;$scope.isResendInviteDelegateProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Resent Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}}).error(function(result,status,headers,config){$scope.isResendInviteDelegateProcessing=false;$scope.isResendInviteDelegateProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Resent Invite Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.revokeInviteDelegate=function(seatDetails){$scope.isRevokeInviteDelegateProcessing=false;$scope.firstName=seatDetails.firstName;$scope.lastName=seatDetails.lastName;$scope.fulfilledEntitlementId=seatDetails.fulfilledEntitlementId;$scope.revokeInviteDelegateEmail=seatDetails.email;$scope.modalMessages="";$("#revokeInviteDelegateModal").modal("show");console.log(seatDetails)};$scope.closeRevokeInviteDelegate=function(){$scope.isRevokeInviteDelegateProcessing=false;$("#revokeInviteDelegateModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelRevokeInviteDelegate=function(){$scope.isRevokeInviteDelegateProcessing=false;$("#revokeInviteDelegateModal").modal("hide")};$scope.revokeInviteDelegateRequest=function(){$scope.isRevokeInviteDelegateProcessing=true;$scope.revokeInviteDelegateNoteDetails={noteType:"SUBSCRIPTION",note:"Delegate Email: "+$scope.revokeInviteDelegateEmail,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_DELG.",guid:$scope.rengaId,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,sku:$scope.productDetails.sku,userId:0,agentId:0,event:{eventType:"CCT_REVOKE_DELEGATE",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.revokeInviteDelegate({teamId:$scope.teamId,fulfilledEntitlementId:$scope.fulfilledEntitlementId,locale:$scope.locale,noteDto:$scope.revokeInviteDelegateNoteDetails}).success(function(result,status,headers,config){$scope.isRevokeInviteDelegateProcessing=false;$scope.isRevokeInviteDelegateProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,"Invitation to "+$scope.firstName+" "+$scope.lastName+" has been revoked.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Revoke Delegate Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isRevokeInviteDelegateProcessing=false;$scope.isRevokeInviteDelegateProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Revoke Delegate Invitation";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.deleteDelegate=function(seatDetails){$scope.isDeleteDelegateProcessing=false;$scope.firstName=seatDetails.firstName;$scope.lastName=seatDetails.lastName;$scope.fulfilledEntitlementId=seatDetails.fulfilledEntitlementId;$scope.removeInviteDelegateEmail=seatDetails.email;$scope.modalMessages="";$("#deleteDelegateModal").modal("show");console.log(seatDetails)};$scope.closeDeleteDelegate=function(){$scope.isDeleteDelegateProcessing=false;$("#deleteDelegateModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelDeleteDelegate=function(){$scope.isDeleteDelegateProcessing=false;$("#deleteDelegateModal").modal("hide")};$scope.deleteDelegateRequest=function(){$scope.isDeleteDelegateProcessing=true;$scope.deleteDelegateNoteDetails={noteType:"SUBSCRIPTION",note:"Delegate Email: "+$scope.removeInviteDelegateEmail,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_DELG.",guid:$scope.rengaId,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,sku:$scope.productDetails.sku,userId:0,agentId:0,event:{eventType:"CCT_REMOVE_DELEGATE",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};TeamService.deleteDelegate({teamId:$scope.teamId,fulfilledEntitlementId:$scope.fulfilledEntitlementId,locale:$scope.locale,noteDto:$scope.deleteDelegateNoteDetails}).success(function(result,status,headers,config){$scope.isDeleteDelegateProcessing=false;$scope.isDeleteDelegateProcessSuccess=true;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.firstName+" "+$scope.lastName+" has been removed as delegate for the seat.");var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Delete Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isDeleteDelegateProcessing=false;$scope.isDeleteDelegateProcessSuccess=false;errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Delete Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.deleteMultipleDelegates=function(seatDetails){$scope.isDeleteMultipleDelegateProcessing=false;$scope.isMoreSeatsAvailableForDelete=false;$scope.seatList=[];angular.forEach(seatDetails,function(seat){if(seat.isRemoveDelegateAvailable){seat.isSelected=false;$scope.seatList.push(seat)}});if($scope.seatList.length>=1){$scope.isMoreSeatsAvailableForDelete=true}$scope.modalMessages="";$("#deleteMultipleDelegateModal").modal("show")};$scope.closeDeleteMultipleDelegates=function(){$scope.isDeleteDelegateProcessing=false;$("#deleteMultipleDelegateModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelDeleteMultipleDelegates=function(){$scope.isDeleteDelegateProcessing=false;$("#deleteMultipleDelegateModal").modal("hide")};$scope.selectAllSeats=function(seatList){$scope.seatList=[];angular.forEach(seatList,function(seat){if(seat.isRemoveDelegateAvailable){seat.isSelected=true;$scope.seatList.push(seat)}})};$scope.deselectAllSeats=function(seatList){$scope.seatList=[];angular.forEach(seatList,function(seat){if(seat.isRemoveDelegateAvailable){seat.isSelected=false;$scope.seatList.push(seat)}})};$scope.isDeleteMultipleDelegateFormValidate=function(){var isNotValidForm=true;angular.forEach($scope.seatList,function(seat){if(seat.isSelected&&isNotValidForm){isNotValidForm=false}});return isNotValidForm};$scope.deleteMultipleDelegateRequest=function(){console.log($scope.seatList);$scope.modalMessages="";$scope.successCount=0;$scope.failureCount=0;var parallelCalls=[];$scope.isDeleteMultipleDelegateProcessing=true;$scope.isDeleteMultipleDelegateProcessSuccess=false;angular.forEach($scope.seatList,function(seat){if(seat.isSelected){$scope.deleteDelegateNoteDetails={noteType:"SUBSCRIPTION",note:"Delegate Email: "+seat.email,orderNumber:$scope.teamDetails.externalContractId,eccContractId:$scope.teamDetails.externalContractId,subType:"TEAM",reasonType:"TEAM_DELG.",guid:$scope.rengaId,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,sku:$scope.productDetails.sku,userId:0,agentId:0,event:{eventType:"CCT_REMOVE_DELEGATE",comments:$scope.teamId.split("@")[0],guid:$scope.rengaId,userId:0,agentId:0}};parallelCalls.push(TeamService.deleteDelegate({teamId:$scope.teamId,fulfilledEntitlementId:seat.fulfilledEntitlementId,locale:$scope.locale,noteDto:$scope.deleteDelegateNoteDetails}).success(function(result,status,headers,config){$scope.successCount++;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Delete Multiple Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.failureCount++;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Delete Multiple Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)}))}});$q.all(parallelCalls).then(function(value){$scope.isDeleteMultipleDelegateProcessing=false;$scope.isDeleteMultipleDelegateProcessSuccess=true;if($scope.successCount&&$scope.failureCount){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,$scope.successCount+" delegate(s) removed from seat(s)."+$scope.failureCount+" delegate(s) could not be removed! Try removing delegates one at a time.")}else{$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.successCount+" delegate(s) successfully removed from seat(s).")}},function(reason){console.log("All call fail");$scope.isDeleteMultipleDelegateProcessing=false;$scope.isDeleteMultipleDelegateProcessSuccess=false;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,$scope.failureCount+" delegate(s) could not be removed! Try removing delegates one at a time.")})};$scope.isDRContrat=false;$scope.addSeats=function(team){$scope.isDrContract=$scope.teamDetails.isDrContract;if($scope.isDrContract){$scope.addDRSeat(team)}else{$scope.productData=[];$scope.productData.push(team);$scope.productData[0].totalSeats=$scope.getSeats(team.offerId);var addSeatProductObj={teamId:$scope.teamId,customerGuid:$scope.customerGuid,source:TeamConstants.SEAT_VIEW_TYPE,productData:$scope.productData,paymentType:$scope.teamDetails.paymentType,billingFrequency:$scope.teamDetails.billingFrequency,externalContractId:$scope.teamDetails.externalContractId};$rootScope.$broadcast("InitiateAddSeatProduct",addSeatProductObj)}};$scope.addSeat=function(){$scope.isDrContract=$scope.teamDetails.isDrContract;if($scope.isDrContract){$scope.addDRSeat($scope.productDetails)}else{var addSeatProductObj={teamId:$scope.teamId,customerGuid:$scope.customerGuid,source:TeamConstants.SEAT_VIEW_TYPE,productData:$scope.productData,paymentType:$scope.teamDetails.paymentType,billingFrequency:$scope.teamDetails.billingFrequency,externalContractId:$scope.teamDetails.externalContractId};$rootScope.$broadcast("InitiateAddSeatProduct",addSeatProductObj)}};$scope.addDRSeat=function(team){$scope.productData=[];$scope.productData.push(team);var drObject=angular.copy(DrTeamAddSeatDto);var admin=_.filter($scope.teamDetails.administrators,function(admin){return admin.isPrimaryAdmin});drObject.isDrFlow=true;drObject.last_modified_by_id=$rootScope.currentUser.username;drObject.owner_id=admin[0].userId+"@AdobeID";drObject.teamId=$scope.teamId;drObject.productData=$scope.productData;drObject.status="PENDING";drObject.externalContractId=$scope.teamDetails.externalContractId;drObject.customerGuid=$scope.customerGuid;drObject.country=_.has($scope.customerDetails,"countryCode")?$scope.customerDetails.countryCode:"";var cartItem={offerId:_.has(team,"offerId")?team.offerId:"",quantity:1};drObject.cartItems.push(cartItem);$rootScope.$broadcast("InitiateAddDrSeatProduct",drObject)};$scope.cancelSeats=function(seatDetails){$scope.isCancelSeatProcessing=false;$scope.isDrContract=$scope.teamDetails.isDrContract;$scope.isMoreSeatsAvailableForCancel=false;$scope.cancelSeatList=[];angular.forEach(seatDetails,function(seat){if(seat.isCancelAvailable&&seat.paymentStatus!=TeamConstants.PAYMENT_STATUS_CANCELLING&&seat.paymentStatus!=TeamConstants.PAYMENT_STATUS_CANCELLED){seat.isSelected=false;$scope.cancelSeatList.push(seat)}});if($scope.cancelSeatList.length>=1){$scope.isMoreSeatsAvailableForCancel=true}$scope.modalMessages="";$scope.cancelReason.selectedId="";$scope.wizardStep=TeamConstants.WIZARD_STEP_CANCEL_SEAT_REASON;$("#cancelSeatModal").modal("show")};$scope.closeCancelSeat=function(){$scope.isCancelSeatProcessing=false;$("#cancelSeatModal").modal("hide");$scope.refreshTeamSubscriptionDetails()};$scope.cancelCancelSeat=function(){$scope.cancelReason.selectedId="";$scope.isCancelSeatProcessing=false;$("#cancelSeatModal").modal("hide")};$scope.selectAllCancelSeats=function(seatList){$scope.cancelSeatList=[];angular.forEach(seatList,function(seat){if(seat.isCancelAvailable){seat.isSelected=true;$scope.cancelSeatList.push(seat)}});$scope.checkCancelItemCount()};$scope.cancellingItemCount=0;$scope.showCancelContractMessage=false;$scope.checkCancelItemCount=function(){if($scope.teamDetails.isDrContract){$scope.cancellingItemCount=0;$scope.showCancelContractMessage=false;angular.forEach($scope.cancelSeatList,function(seat){if(seat.isCancelAvailable&&seat.isSelected){$scope.cancellingItemCount++}});if(($scope.teamDetails.totalSeats-$scope.teamDetails.cancelling-$scope.cancellingItemCount)<=0){$scope.showCancelContractMessage=true}}};$scope.deselectAllCancelSeats=function(seatList){$scope.cancelSeatList=[];angular.forEach(seatList,function(seat){if(seat.isCancelAvailable){seat.isSelected=false;$scope.cancelSeatList.push(seat)}});$scope.checkCancelItemCount()};$scope.isCancelSeatFormValidate=function(){var isNotValidForm=true;angular.forEach($scope.cancelSeatList,function(seat){if(seat.isSelected&&isNotValidForm){isNotValidForm=false}});return isNotValidForm};$scope.$watch("cancelReason.selectedId",function(){$scope.cancelReasonCode="";if($scope.cancelReason.selectedId!=null&&$scope.cancelReason.selectedId!=""){angular.forEach($scope.metadata.subscriptionMetadata.cancellation_reason,function(reason){if(reason.crmcode==$scope.cancelReason.selectedId){$scope.cancelReasonCode=reason.code;$scope.wizardStep=TeamConstants.WIZARD_STEP_CANCEL_SEAT_LISTS}})}},true);$scope.calculatePenality=function(){$scope.isDrContract=$scope.teamDetails.isDrContract;if($scope.isDrContract){$scope.calculateDRPenality()}else{$scope.calculatePenalityFromCRM()}};$scope.calculatePenalityFromCRM=function(){$scope.modalMessages="";$scope.cancelAnyway="";$scope.wizardStep=TeamConstants.WIZARD_STEP_CANCEL_CRITERIA;$scope.isCalculatePenaltyProcessing=true;$scope.calculatePenaltyMessage="";$scope.cancelSeatCount=0;$scope.cancelSeatCriteria={};angular.forEach($scope.cancelSeatList,function(seat){if(seat.isSelected){$scope.cancelSeatCount++}});console.log($scope.productDetails.purchasedEntitlementId);$scope.calculatePenaltyBodyRequest={urlKey:"sap-team-cancellationPenalty",requestBody:"<CAL_CONTRACT_PRICE><IV_OBJECTID></IV_OBJECTID><IV_ENTITLEID>"+$scope.productDetails.purchasedEntitlementId+"</IV_ENTITLEID><IP_POSNR></IP_POSNR><IV_SEAT>"+$scope.cancelSeatCount+"</IV_SEAT><IV_ACTION></IV_ACTION><IV_PRODUCT></IV_PRODUCT></CAL_CONTRACT_PRICE>",requestBodyType:"application/xml",responseBodyType:"application/json"};TeamService.calculatePenalty({calculatePenaltyBodyRequest:$scope.calculatePenaltyBodyRequest}).success(function(result,status,headers,config){if(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.TYPE=="I"){$scope.isDisableWithFee=false;$scope.isDisableWithoutFee=false;$scope.isDisableRefund=false;$scope.calculatePenaltyMessage=result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.MESSAGE;$scope.cancelSeatCriteria.currencyCode="";if(result.CAL_CONTRACT_PRICE.ES_PRICE.ISO3CUR&&result.CAL_CONTRACT_PRICE.ES_PRICE.ISO3CUR.length){$scope.cancelSeatCriteria.currencyCode=result.CAL_CONTRACT_PRICE.ES_PRICE.ISO3CUR}if(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.ID=="ZCCM"&&result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==45||result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==37){$scope.cancelSeatCriteria.CancellationRuleId="Fee";$scope.cancelSeatCriteria.RefundRuleId="No Refund";$scope.cancelSeatCriteria.refundTotalPrice=0;$scope.cancelSeatCriteria.debitTotalPrice=result.CAL_CONTRACT_PRICE.ES_PRICE.FEE_TOT_R;$scope.defaultCancellationSelection="1"}else{if(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.ID=="ZCCM"&&result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==11){$scope.cancelSeatCriteria.CancellationRuleId="No Fee";$scope.cancelSeatCriteria.RefundRuleId="No Refund";$scope.cancelSeatCriteria.refundTotalPrice=0;$scope.cancelSeatCriteria.debitTotalPrice=result.CAL_CONTRACT_PRICE.ES_PRICE.FEE_TOT_R;$scope.defaultCancellationSelection="2"}else{if(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.ID=="ZCCM"&&(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==48||result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==49||result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.NUMBER==58)){$scope.cancelSeatCriteria.CancellationRuleId="No Fee";$scope.cancelSeatCriteria.RefundRuleId="Refund";$scope.cancelSeatCriteria.refundTotalPrice=result.CAL_CONTRACT_PRICE.ES_PRICE.FEE_TOT_R;$scope.cancelSeatCriteria.debitTotalPrice=0;$scope.defaultCancellationSelection="3"}else{$scope.cancelSeatCriteria.CancellationRuleId="No Fee";$scope.cancelSeatCriteria.RefundRuleId="No Refund";$scope.cancelSeatCriteria.refundTotalPrice=0;$scope.cancelSeatCriteria.debitTotalPrice=0;$scope.defaultCancellationSelection="2";$scope.cancelAnyway="Do you still want to proceed with cancellation (Without Fee)?";$scope.isDisableWithFee=true;$scope.isDisableRefund=true}}}}else{if(result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.TYPE=="E"){$scope.isDisableWithFee=true;$scope.isDisableWithoutFee=false;$scope.isDisableRefund=true;$scope.cancelSeatCriteria.CancellationRuleId="No Fee";$scope.cancelSeatCriteria.RefundRuleId="No Refund";$scope.cancelSeatCriteria.refundTotalPrice=0;$scope.cancelSeatCriteria.debitTotalPrice=0;$scope.defaultCancellationSelection="2";$scope.calculatePenaltyMessage=result.CAL_CONTRACT_PRICE.ET_RETURN.BAPIRET2.MESSAGE;$scope.cancelAnyway="Do you still want to proceed with cancellation (Without Fee)?"}}$scope.isCalculatePenaltyProcessing=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Cancel Seats - Calculate Penalty";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isCalculatePenalityProcessing=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Cancel Seats - Calculate Penalty";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.calculateDRPenality=function(){$scope.modalMessages="";$scope.cancelAnyway="";$scope.errorMessages="";$scope.wizardStep=TeamConstants.WIZARD_STEP_PREVIEW_DR_CANCELLATION;$scope.isCalculatePenaltyProcessing=true;$scope.calculatePenaltyMessage="";$scope.cancelSeatCount=0;DrTeamService.cancelDRSeat($scope.getCancelDRSeatDto(true)).success(function(result,status,headers,config){$scope.isCalculatePenaltyProcessing=false;$scope.cancelSeatPreviewDto=result}).error(function(error,status,headers,config){$scope.isCalculatePenaltyProcessing=false;var errorDetails=TeamUtil.standardErrorDrMessage(error);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);$scope.drModalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message);$scope.errorDrMessages=errorDetails.message})};$scope.getCancelDRSeatDto=function(isPreviewMode){var cartItems=[];var entitlementList=[];var offerId;var quantity=0;var cancelSeatCartItems=angular.copy(DrTeamCancelLicenseDto);if(isPreviewMode){angular.forEach($scope.cancelSeatList,function(seat){var entitlementDto={};if(seat.isSelected){var cancelSeatCart=angular.copy(DrTeamCartItemDto);offerId=seat.offerId;quantity=quantity+1;if(seat.fulfillableEntitlementId){entitlementDto.seatId=seat.fulfillableEntitlementId}else{if(seat.fulfilledEntitlementId){entitlementDto.seatId=seat.fulfilledEntitlementId}}entitlementDto.status="CANCELLING";entitlementList.push(entitlementDto)}});cancelSeatCartItems.offerId=offerId;cancelSeatCartItems.quantity=quantity;cancelSeatCartItems.entitlementDetails=entitlementList;cartItems.push(cancelSeatCartItems)}else{angular.forEach($scope.cancelSeatList,function(seat){var entitlementDto={};if(seat.isSelected){var cancelSeatCart=angular.copy(DrTeamCartItemDto);offerId=seat.offerId;quantity=quantity+1;if(seat.fulfillableEntitlementId){entitlementDto.seatId=seat.fulfillableEntitlementId}else{if(seat.fulfilledEntitlementId){entitlementDto.seatId=seat.fulfillableEntitlementId}}entitlementDto.status="CANCELLING";angular.forEach($scope.cancelSeatPreviewDto.cartItems,function(cartItem){if(cartItem.entitlementDetails.seatId==seat.seatId){entitlementDto.purchaseAuthId=cartItem.purchaseAuthId;entitlementDto.cancelationPolicyId=cartItem.cancelationPolicyId}});entitlementList.push(entitlementDto)}});cancelSeatCartItems.offerId=offerId;cancelSeatCartItems.quantity=quantity;$scope.drSeatLength=quantity;cancelSeatCartItems.entitlementDetails=entitlementList;cartItems.push(cancelSeatCartItems)}var cancelSeatDto=angular.copy(AddDRSeatDto);cancelSeatDto.status=isPreviewMode?"PENDING":"SUBMIT";cancelSeatDto.country=_.has($scope.customerDetails,"countryCode")?$scope.customerDetails.countryCode:"";cancelSeatDto.teamId=$scope.teamId;cancelSeatDto.cartItems=cartItems;cancelSeatDto.lastModifiedById=$rootScope.currentUser.username;cancelSeatDto.ownerId=$scope.customerGuid;return cancelSeatDto};$scope.cancelDRSeat=function(){$scope.isCancellingDRSeatInProgress=true;var submitDrTeamSeatDTO=$scope.getCancelDRSeatDto(false);DrTeamService.cancelDRSeat(submitDrTeamSeatDTO).success(function(result,status,headers,config){$scope.isCancellingDRSeatInProgress=false;$scope.wizardStep=TeamConstants.WIZARD_STEP_PREVIEW_DR_CONFIRMATION;var actionHistoryDto=angular.copy(ActionHistoryDto);actionHistoryDto.noteType="SUBSCRIPTION";actionHistoryDto.note=(angular.isDefined(result.cartItems)&&angular.isArray(result.cartItems)&&result.cartItems.length>=1?result.cartItems[0].quantity:0)+" seat(s) cancelled for "+$scope.productDetails.productName;actionHistoryDto.reasonCode=$scope.cancelReasonCode;actionHistoryDto.productCode=$scope.productDetails.productCode;actionHistoryDto.orderNumber=$scope.externalContractId;actionHistoryDto.eccContractId=$scope.externalContractId;actionHistoryDto.subType="TEAM";actionHistoryDto.reasonType="SEAT_MGMT";actionHistoryDto.guid=$scope.rengaId;actionHistoryDto.currency=$scope.cancelSeatPreviewDto.currency.code;actionHistoryDto.userId=0;actionHistoryDto.agentId=0;actionHistoryDto.seatsCancelled=angular.isDefined(result.cartItems)&&angular.isArray(result.cartItems)&&result.cartItems.length>=1?result.cartItems[0].quantity:0;actionHistoryDto.seatLeft=$scope.productDetails.totalSeats-result.cartItems.length;actionHistoryDto.cancellationValue=Math.abs($scope.cancelSeatPreviewDto.subTotal.amountWithoutTax);actionHistoryDto.event.eventType="CCT_DR_CANCEL_SEAT";actionHistoryDto.event.comments=$scope.teamId.split("@")[0];actionHistoryDto.event.guid=$scope.customerGuid.split("@")[0];TeamActionHistoryService.logActionHistoryForCancelDrSeat(actionHistoryDto).success(function(result){$scope.resultMessage=result}).error(function(error){$scope.errorMessage=error});var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="DR Team Subscription - Cancel Seats";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(error,status,headers,config){$scope.isCancellingDRSeatInProgress=false;$scope.wizardStep=TeamConstants.WIZARD_STEP_PREVIEW_DR_CONFIRMATION;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,error);messageObject.Functionality="DR Team Subscription - Cancel Seats";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.backFromDRPreiview=function(){$scope.wizardStep=TeamConstants.WIZARD_STEP_CANCEL_SEAT_LISTS;$scope.modalMessages="";$scope.drModalMessages=[];$scope.errorDrMessages=""};$scope.startDebitMemo=function(){$scope.isCreditMemoFlow=$scope.isWithoutFeeFlow=$scope.isSaveSuccessfulFlow=false;$scope.isDebitMemoFlow=true;$scope.wizardStep=TeamConstants.WIZARD_STEP_DEBIT_MEMO;$scope.$broadcast(TeamConstants.INITIALIZE_DM_TRANSACTION,"Transaction Initialize")};$scope.startCreditMemo=function(){$scope.isDebitMemoFlow=$scope.isWithoutFeeFlow=$scope.isSaveSuccessfulFlow=false;$scope.isCreditMemoFlow=true;$scope.wizardStep=TeamConstants.WIZARD_STEP_REFUND_REASON;$scope.$broadcast(TeamConstants.INITIALIZE_CM_TRANSACTION,"Transaction Initialize")};$scope.startWithoutFeeFlow=function(){$scope.isWithoutFeeFlow=true;$scope.isDebitMemoFlow=$scope.isCreditMemoFlow=$scope.isSaveSuccessfulFlow=false;$scope.wizardStep=TeamConstants.WIZARD_STEP_WITHOUT_FEE_REASON};$scope.$on(TeamConstants.CREATE_DEBIT_MEMO_EVENT_FAILED,function(event,messages,result){$scope.wizardStep=TeamConstants.WIZARD_STEP_DEBIT_MEMO_CONFIRM;if(result){$scope.errorMessages=result.messages}$app.hideLoading()});$scope.$on(TeamConstants.CREATE_CREDIT_MEMO_EVENT_FAILED,function(event,messages,result){$scope.wizardStep=TeamConstants.WIZARD_STEP_CREDIT_MEMO_CONFIRM;if(result){$scope.errorMessages=result.messages}$app.hideLoading()});$scope.$on(TeamConstants.DEBIT_MEMO_VIEW_LOADED,function(event,messages){$scope.isDebitMemoViewLoaded=true});$scope.$on(TeamConstants.CREATE_DEBIT_MEMO_EVENT_SUCCESS,function(event,message,transaction){$scope.errorMessages=null;$scope.createdDebitMemoTransaction=transaction;$scope.cancelSubscriptionNote="With Fee - "+$scope.createdDebitMemoTransaction.transactionNumber+" | Reason: None";$scope.etfAmount=$scope.createdDebitMemoTransaction.totalValue;$scope.creditDebitMemoNo=$scope.createdDebitMemoTransaction.transactionNumber;$scope.cancelSeatRequest(TeamConstants.WIZARD_STEP_DEBIT_MEMO_CONFIRM)});$scope.$on(TeamConstants.CREATE_CREDIT_MEMO_EVENT_SUCCESS,function(event,message,transaction){$scope.errorMessages=null;$scope.createdCreditMemoTransaction=transaction;$scope.createCreditMemoCsCase();$scope.cancelSubscriptionNote="With Refund - "+$scope.createdCreditMemoTransaction.transactionNumber+" | Reason: "+$scope.cancelRefundReason.selectedId;$scope.etfAmount=$scope.createdCreditMemoTransaction.totalValue;$scope.creditDebitMemoNo=$scope.createdCreditMemoTransaction.transactionNumber;$scope.cancelSeatRequest(TeamConstants.WIZARD_STEP_CREDIT_MEMO_CONFIRM)});$scope.validateIsCsCaseExist=function(selectedValue){console.log(selectedValue);if(selectedValue=="Yes"){$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isSaveOthersCsCaseExist=true}else{$scope.isDmCsCaseExist=$scope.isCmCsCaseExist=$scope.isWithoutFeeCsCaseExist=$scope.isSaveOthersCsCaseExist=false}};$scope.cancelSeatFromWithoutFee=function(){$scope.cancelSubscriptionNote="Without Fee | Reason: "+$scope.cancelWithoutFeeReason.selectedId;$scope.isCancelSeatProcessing=true;$scope.cancelSeatRequest(TeamConstants.WIZARD_STEP_WITHOUT_FEE_CONFIRM);if(angular.uppercase($scope.cancelWithoutFeeReason.selectedId).indexOf($scope.SAVE_MIGRATION_PATH_UNAVAILABLE)>=0){$scope.isWithoutFeeSaveOptionSelected=true}else{$scope.isWithoutFeeSaveOptionSelected=false}};$scope.cancelSeatRequest=function(wizardId){$scope.modalMessages="";$scope.isCancelSeatProcessing=true;$scope.cancelSeatCount=0;$scope.fulfillableEntitlementId=[];$scope.fulfilledEntitlementId=[];console.log($scope.cancelSeatList);$scope.totalSeat=$scope.getSeats($scope.productDetails.offerId);angular.forEach($scope.cancelSeatList,function(seat){if(seat.isSelected){$scope.cancelSeatCount++;if(seat.fulfillableEntitlementId){$scope.fulfillableEntitlementId.push(seat.fulfillableEntitlementId)}else{if(seat.fulfilledEntitlementId){$scope.fulfilledEntitlementId.push(seat.fulfilledEntitlementId)}}}});$scope.seatLeft=$scope.cancelSeatList.length-$scope.cancelSeatCount;if($scope.cancelSeatCriteria.refundTotalPrice){$scope.cancelAmount=$scope.cancelSeatCriteria.refundTotalPrice}else{if($scope.cancelSeatCriteria.debitTotalPrice){$scope.cancelAmount=$scope.cancelSeatCriteria.debitTotalPrice}}$scope.cancelRequestBody={note:{comments:$scope.teamId.split("@")[0],note:$scope.cancelSubscriptionNote,guid:$scope.rengaId,orderNumber:$scope.teamDetails.externalContractId,reasonCode:$scope.cancelReasonCode,sku:$scope.productDetails.sku,currency:_.has($scope.cancelSeatCriteria,"currencyCode")?$scope.cancelSeatCriteria.currencyCode:"",eccContractId:$scope.teamDetails.externalContractId,creditDebitMemoNo:$scope.creditDebitMemoNo,productCode:$scope.productDetails.productCode,productLanguage:$scope.productDetails.language,etfAmount:$scope.etfAmount,cancellationValue:$scope.cancelAmount,seatsCancelled:$scope.cancelSeatCount,seatsLeft:$scope.seatLeft}};if($scope.fulfillableEntitlementId.length){$scope.cancelRequestBody.fulfillableEntitlementId=$scope.fulfillableEntitlementId}if($scope.fulfilledEntitlementId.length){$scope.cancelRequestBody.fulfilledEntitlementId=$scope.fulfilledEntitlementId}console.log($scope.cancelRequestBody);TeamService.cancelSeats({teamId:$scope.teamId,cancelRequestBody:$scope.cancelRequestBody,locale:$scope.locale}).success(function(result,status,headers,config){$scope.isCancelSeatProcessing=false;$scope.isCancelSeatProcessSuccess=true;$scope.isCreditMemoProcessing=false;$scope.isDebitMemoProcessing=false;$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_SUCCESS_TYPE,$scope.cancelSeatCount+" Seat(s) has been cancelled.");$scope.wizardStep=wizardId;$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Team Subscription - Cancel Seats";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.isCancelSeatProcessing=false;$scope.isCancelSeatProcessSuccess=false;$scope.wizardStep=wizardId;if(status==504){$scope.modalMessages=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. But this is does not necessarily imply failure. Please check the subscription after 10 minutes before attempting to reprocess.")}else{errorDetails=TeamUtil.standardErrorMessage(result);$scope.modalMessages=AppUtils.getSingleMessage(errorDetails.type,errorDetails.message)}$app.hideLoading();var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Team Subscription - Cancel Seats";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.startSaveSuccessful=function(wizardStep,description){$scope.isSaveSuccessfulFlow=true;$scope.isDebitMemoFlow=$scope.isCreditMemoFlow=$scope.isWithoutFeeFlow=false;$scope.saveSuccessfulOtherDescription=description;$scope.saveSuccessfulOtherNote="";$scope.wizardStep=wizardStep;$scope.isSaveOthersFlow=$scope.isSaveOthersTextFlow=false;if(wizardStep==TeamConstants.WIZARD_STEP_SAVE_OTHERS_PREVIEW){$scope.isSaveOthersFlow=$scope.isSaveOthersTextFlow=false;if(angular.uppercase(description)==TeamConstants.SAVE_OTHER_MANDATORY_TEXT){$scope.isSaveOthersTextFlow=true;$scope.wizardStep=TeamConstants.WIZARD_STEP_SAVE_OTHERS}else{$scope.isSaveOthersFlow=true;$scope.wizardStep=TeamConstants.WIZARD_STEP_SAVE_OTHERS_PREVIEW}}};$scope.saveSubscription=function(saveReasonCode,noteData){$scope.isSaveServiceLoading=true;$scope.loadingMessage="Saving Subscription, Please wait...";$scope.errorMessages=null;$scope.cancelSeatCount=0;$scope.etfAmount=_.has($scope.cancelSeatCriteria,"debitTotalPrice")?$scope.cancelSeatCriteria.debitTotalPrice:"";if($scope.etfAmount==""||$scope.etfAmount==0){$scope.etfAmount=_.has($scope.cancelSeatCriteria,"refundTotalPrice")?$scope.cancelSeatCriteria.refundTotalPrice:0}angular.forEach($scope.cancelSeatList,function(seat){if(seat.isSelected){$scope.cancelSeatCount++}});$scope.seatLeft=$scope.cancelSeatList.length-$scope.cancelSeatCount;var saveData={teamId:$scope.teamId.split("@")[0],customerGuid:$scope.rengaId,saveReasonCode:saveReasonCode,note:noteData,etfAmount:$scope.etfAmount,currency:_.has($scope.cancelSeatCriteria,"currencyCode")?$scope.cancelSeatCriteria.currencyCode:"",cancelReason:$scope.cancelReasonCode,eccContractId:$scope.teamDetails.externalContractId,productCode:$scope.productDetails.productCode,sku:$scope.productDetails.sku,cancelSeatCount:$scope.cancelSeatCount,seatLeft:$scope.seatLeft,language:$scope.productDetails.language};TeamService.saveSubscription(saveData).success(function(result){$scope.wizardStep=TeamConstants.WIZARD_STEP_SAVE_OTHERS_CONFIRM;$scope.isSaveServiceLoading=false;if(result&&result.STATUS&&result.STATUS==false){$scope.errorMessages="Service Failed - "+result.REASON}else{if(!result){$scope.errorMessages="Service Failed, Please Try Again..."}else{$scope.errorMessages=null;AppUtils.sendLogToServer("Cancel Seat - Save Subscription Completed Successfully: Team ID - "+$scope.teamId)}}}).error(function(result){$scope.wizardStep=TeamConstants.WIZARD_STEP_SAVE_OTHERS_CONFIRM;$scope.isSaveServiceLoading=false;$scope.errorMessages="Service Failed, Please Try Again...";AppUtils.sendLogToServer("Cancel Seat - Save Subscription Failed: Team ID - "+$scope.teamId)})};$scope.createCsCaseFromTemplate=function(){var customerNo=$scope.customerNo;var productSku=$scope.productDetails.sku;var storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var orderNumber=$scope.teamDetails.externalContractId;var caseNote=$scope.cancelReason.selectedId==$scope.CANCEL_REASON_OTHER_CODE?$scope.cancellationReasonOther.selectedText:"";var csCaseCreationUrl="/case/newCs?customerNo="+customerNo+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+productSku+"&teamId="+$scope.teamId+"&cancelSubscription=true&cancelReason="+$scope.cancelReason.selectedId+"&cancelNote="+caseNote+"&contextType=TEAM&customerGuid="+$scope.customerGuid;window.open(AppUtils.getApplicationUrl()+csCaseCreationUrl)};$scope.createCreditMemoCsCase=function(){var customerNo=$scope.customerNo;var productSku=$scope.productDetails.sku;var storeId=(typeof $scope.storeMetadata==="undefined"||$scope.storeMetadata==null)?0:$scope.storeMetadata.key;var orderNumber=$scope.teamDetails.externalContractId;var returnCaseTemplateUrl="/case/newCs?customerNo="+customerNo+"&tempId="+AppConstants.TEMPLATE_CREDIT_MEMO_RETURN_ORDER+"&productSku="+productSku+"&storeId="+$scope.storeId+"&orderNumber="+$scope.createdCreditMemoTransaction.transactionNumber+"&contextType=TEAM&customerGuid="+$scope.customerGuid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.openCaseHistory=function(){window.open(AppUtils.getApplicationUrl()+"/customer/"+$scope.customerNo+"/cases")};$scope.openCsCase=function(caseNumber){window.open(AppUtils.getApplicationUrl()+"/case/"+caseNumber)};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Team_Id=$scope.teamId;messageObject.Customer_Guid=$scope.customerGuid;messageObject.OfferId=$scope.offerId?$scope.offerId:"";messageObject.viewType=$scope.viewType?$scope.viewType:"";messageObject.fulfilledEntitlementId=$scope.fulfilledEntitlementId?$scope.fulfilledEntitlementId:"";messageObject.productCode=$scope.productCode?$scope.productCode:"";messageObject.productLanguage=$scope.productLanguage?$scope.productLanguage:"";messageObject.TeamType=$scope.teamDetails.type?$scope.teamDetails.type:"";messageObject.BillingType=$scope.teamDetails.isDrContract?"DR":"Adobe";messageObject.BillingFrequency=$scope.teamDetails.billingFrequency?$scope.teamDetails.billingFrequency:""}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_CRM){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Customer_No=$scope.customerNo}}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TeamDetailsDto",{teamId:"",teamName:"",isPrimaryAdmin:"",isSeondaryAdmin:"",isInvitedAdmin:"",totalSeats:"",seatDetails:[],billingInfo:{},administrators:{},address:{}});var app=app||angular.module("hxApp.directive",[]);app.directive("ngTeamMessages",["$location","TeamConstants",function(location,TeamConstants){return{restrict:"EA",scope:{source:"=",modalSource:"="},replace:true,templateUrl:"js/team/partials/team-messages.html",link:function($scope,element,attrs){$scope.TeamConstants=TeamConstants}}}]);app.directive("ngCustomerHeader",["$location","TeamService","AppConstants","AppUtils",function(location,TeamService,AppConstants,AppUtils){return{restrict:"EA",scope:{customerDetails:"=",rengaId:"=",teamDetails:"="},replace:true,templateUrl:"js/team/partials/customer-header.html",link:function($scope,element,attrs){$scope.closeTeamDetails=function(){$scope.searchFields={firstName:"",lastName:"",customerId:"",transactionNo:"",serialNo:"",email:"",idNumber:$scope.rengaId,customerType:"1",authSrc:"AdobeID"};TeamService.search($scope.searchFields).success(function(result,status,headers,config){if(result&&result.customerSearchResults&&result.customerSearchResults.length==1){$scope.customerNo=result.customerSearchResults[0].customerNo;var returnCaseTemplateUrl="/customer/"+$scope.customerNo+"/subscription/team";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,true,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config);location.url(returnCaseTemplateUrl)}}).error(function(result,status,headers,config){$scope.customerNo="";var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_CRM,false,result);messageObject.Functionality="Team Subscription - CRM Customer Search";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Team_Id=$scope.teamId;messageObject.Customer_Guid=$scope.customerGuid;messageObject.OfferId=$scope.offerId?$scope.offerId:"";messageObject.viewType=$scope.viewType?$scope.viewType:"";messageObject.fulfilledEntitlementId=$scope.fulfilledEntitlementId?$scope.fulfilledEntitlementId:"";messageObject.productCode=$scope.productCode?$scope.productCode:"";messageObject.productLanguage=$scope.productLanguage?$scope.productLanguage:""}else{if(sourceSystem==AppConstants.SOURCE_SYSTEM_CRM){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_CRM;messageObject.Customer_No=$scope.customerNo}}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject}}}}]);app.directive("ngTeamPaymentStatus",["$location","TeamConstants",function(location,TeamConstants){return{restrict:"EA",scope:{paymentStatus:"="},replace:true,templateUrl:"js/team/partials/team-payment-status.html",link:function($scope,element,attrs){$scope.TeamConstants=TeamConstants}}}]);app.directive("ngTeamDelegateStatus",["$location","TeamConstants",function(location,TeamConstants){return{restrict:"EA",scope:{delegateStatus:"="},replace:true,templateUrl:"js/team/partials/team-delegate-status.html",link:function($scope,element,attrs){$scope.TeamConstants=TeamConstants}}}]);app.directive("ngTeamProductStatus",["$location","TeamConstants",function(location,TeamConstants){return{restrict:"EA",scope:{productStatus:"="},replace:true,templateUrl:"js/team/partials/team-product-status.html",link:function($scope,element,attrs){$scope.TeamConstants=TeamConstants}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TeamProductService",["$http",function($http){var service={};var transform=function(data){return $.param(data)};var transform2=function(data){return $.customParam(data)};service.getTeamProductDetails=function(data){return $http({method:"POST",url:"../teamProductService/get.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getAddSeatDetails=function(data){return $http({method:"POST",url:"../teamProductService/calculatePriceForSeatAddition.do",data:data})};service.purchaseSeat=function(data){return $http({method:"POST",url:"../teamProductService/addSeats.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getCalculatePenaltyDetails=function(data){return $http({method:"POST",url:"../teamProductService/calculateCancellationPenalty.do",data:data})};service.cancelSeatOrSubscription=function(data){return $http({method:"POST",url:"../teamProductService/cancelSubscription.do",data:data})};service.reCancelSeat=function(data){return $http({method:"POST",url:"../teamProductService/cancelSeats.do",data:data})};service.removeUserFromSeat=function(teamId,seatId){return $http({method:"POST",url:"../teamProductService/removeUserFromSeat.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{teamId:teamId,seatId:seatId},transformRequest:transform})};service.inviteAdmins=function(data){return $http({method:"POST",url:"../teamProductService/inviteAdmins.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.inviteAdminsForIndirectOrg=function(data){return $http({method:"POST",url:"../teamProductService/inviteAdminsForIndirectOrg.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.deleteAdmin=function(data){return $http({method:"POST",url:"../teamProductService/deleteAdmins.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.addDelegateDetails=function(data){return $http({method:"POST",url:"../teamProductService/addDelegateDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.removeDelegateDetails=function(data){return $http({method:"POST",url:"../teamProductService/removeDelegateDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.updateDelegateDetails=function(data){return $http({method:"POST",url:"../teamProductService/updateDelegateDetails.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.sendPrimaryAdminInvite=function(data){return $http({method:"POST",url:"../teamProductService/sendPrimaryAdminInvite.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.resendPrimaryAdminInvite=function(data){return $http({method:"POST",url:"../teamProductService/resendPrimaryAdminInvite.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform2,data:data})};service.revokePrimaryAdminInvite=function(data){return $http({method:"POST",url:"../teamProductService/revokePrimaryAdminInvite.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.withdrawAndRemoveAdmin=function(data){return $http({method:"POST",url:"../teamProductService/withdrawAndRemoveAdmin.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTeamAdmins=function(data){return $http({method:"GET",url:"../teamProductService/getTeamAdmins.do?teamId="+data.teamId,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getLoyalty=function(data){return $http({method:"GET",url:"../teamProductService/getLoyalty.do?orgId="+data.guid+"@AdobeOrg",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TeamSeatProductDto",{productName:"",offerId:"",primaryImageUrl:"",productCode:"",seatQuantity:"",sku:"",pricePoint:""});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TeamService",["$http",function($http){var service={};service.getTeamSubscriptionLists=function(data){return $http({method:"GET",url:"../teamSubscriptionService/getTeamSubscriptionList.do",params:{customerGuid:data.customerGuid,locale:data.locale}})};service.getTeamSubscriptionDetails=function(data){return $http({method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"},url:"../teamSubscriptionService/getTeamSubscriptionDetails.do",params:{customerGuid:data.customerGuid,teamId:data.teamId,locale:data.locale}})};service.inviteSecondayAdmin=function(data){return $http({method:"POST",url:"../teamSubscriptionService/teams/"+data.teamId+"/administrators/invitations.do?locale="+data.locale,data:data.invitationAdminRequestBody})};service.revokeAdmin=function(data){return $http({method:"DELETE",headers:{"Content-Type":"application/json; charset=UTF-8"},url:"../teamSubscriptionService/teams/"+data.teamId+"/administrators.do?locale="+data.locale,data:data.revokeAdminRequestBody})};service.reInviteAdmin=function(data){return $http({method:"PUT",url:"../teamSubscriptionService/teams/"+data.teamId+"/administrators/invitations.do?locale="+data.locale,data:data.reInviteAdminRequestBody})};service.revokeInviteAdmin=function(data){return $http({method:"DELETE",headers:{"Content-Type":"application/json; charset=UTF-8"},url:"../teamSubscriptionService/invitations/"+data.invitationCode+"/revokeInvite.do?locale="+data.locale,data:data.noteDto})};service.search=function(data){return $http({method:"POST",url:"../customerPreviewService/search.do",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:transform,data:data})};service.inviteDelegate=function(data){return $http({method:"POST",url:"../teamSubscriptionService/teams/"+data.teamId+"/seats/named/invitations.do?locale="+data.locale,data:data.inviteDelegateRequestBody})};service.resendInviteDelegate=function(data){return $http({method:"PUT",url:"../teamSubscriptionService/teams/"+data.teamId+"/seats/named/invitations.do?locale="+data.locale,data:data.resendInviteDelegateRequestBody})};service.revokeInviteDelegate=function(data){return $http({method:"DELETE",headers:{"Content-Type":"application/json; charset=UTF-8"},url:"../teamSubscriptionService/teams/"+data.teamId+"/seats/named/"+data.fulfilledEntitlementId+"/invitations.do?locale="+data.locale,data:data.noteDto})};service.deleteDelegate=function(data){return $http({method:"DELETE",headers:{"Content-Type":"application/json; charset=UTF-8"},url:"../teamSubscriptionService/teams/"+data.teamId+"/seats/named/"+data.fulfilledEntitlementId+"/remove.do?locale="+data.locale,data:data.noteDto})};service.getPricingData=function(data){return $http({method:"GET",url:"../teamSubscriptionService/teams/"+data.teamId+"/subscription-offerings/"+data.offerId+"/pricing/getPricingData.do",params:{priceTableIndex:1,priceTableSize:100,pricingMode:""}})};service.addSeat=function(data){return $http({method:"POST",url:"../teamSubscriptionService/teams/"+data.teamId+"/seats.do?locale="+data.locale,data:data.addSeatRequestBody})};service.calculatePenalty=function(data){return $http({method:"POST",url:"../apihub/processRequest.do",data:data.calculatePenaltyBodyRequest})};service.cancelSeats=function(data){return $http({method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json",},url:"../teamSubscriptionService/teams/"+data.teamId+"/seats.do?locale="+data.locale,data:data.cancelRequestBody})};service.saveSubscription=function(data){return $http({method:"GET",url:"../csuiService/saveSubscription.do",params:{subscriptionAccountID:data.teamId,saveReasonCode:data.saveReasonCode,customerGuid:data.customerGuid,note:data.note,etfAmount:data.etfAmount,currency:data.currency,cancelReason:data.cancelReason,eccContractId:data.eccContractId,isTeam:true,productCode:data.productCode,sku:data.sku,cancelSeatCount:data.cancelSeatCount,seatLeft:data.seatLeft,language:data.language}})};service.actionHistory=function(data){return $http({method:"GET",url:"../csuiService/getSubscriptionNotes.do",params:{subscriptionAccountId:"",subscriptionGuid:data.teamId,isTeam:true}})};return service}]);var app=app||angular.module("hxApp",["ngRoute"]);app.controller("TeamSubscriptionListCtrl",["$scope","$log","$rootScope","$location","$routeParams","$filter","TrackingService","Utils","ImsCustomerService",function($scope,$log,$rootScope,$location,$routeParams,$filter,TrackingService,Utils,ImsCustomerService){TrackingService.trackPageView("Communication","Communication");if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.isLoading=true;Utils.pageTitle("Team Subscription");$scope.customerAccountID=$routeParams.customerAccountID;$scope.customer={};var customerSearchObj={guid:$scope.customerAccountID.split("@")[0],authSrc:$scope.customerAccountID.split("@")[1]};ImsCustomerService.getCustomerProfileByGuid(customerSearchObj).then(function(response){if(angular.isDefined(response.data.error)){$scope.customer.messages=Utils.showMessage("error","Customer is not valid");$scope.isLoading=false;return}$scope.customer=response.data;setTimeout(function(){$rootScope.$broadcast("LOAD_TEAM_SUBSCRIPTION_LIST",$scope.customer)},0);$scope.isLoading=false},function(error){console.log("IMS details load failed");$scope.customer.messages.push(Utils.showMessage("error","Customer is not valid"));$scope.isLoading=false})}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngListTeamSubscription",["Utils","webGuidFilterFilter","CustomerSubscriptionService","CustomerUtil","AppConstants","AppUtils","TeamUtil","CustomerConstants","SubscriptionUtil","TeamConstants",function(Utils,webGuidFilterFilter,CustomerSubscriptionService,CustomerUtil,AppConstants,AppUtils,TeamUtil,CustomerConstants,SubscriptionUtil,TeamConstants){return{restrict:"EA",scope:{records:"=",customerNo:"=customerno",contactNo:"=contactno",filterSubscriptions:"=filter"},replace:true,templateUrl:"js/customer/subscription/partials/teamSubscriptionListDirective.html",link:function($scope,element,attrs){$scope.$on("LOAD_TEAM_SUBSCRIPTION_LIST",function(event,customerObj){$scope.customerObj=customerObj;$scope.customerGuid=customerObj.userId.split("@")[0];$scope.loadJilTeamSubscriptions()});var handleValueChange=function(value){if(value){$scope.newCaseCustomerLink=Utils.newCaseCustomerLink($scope.customerNo,$scope.contactNo)}};$scope.encodeUriQuery=function(val){return encodeURIComponent(val)};$scope.$watch(function(){return $scope.contactNo},handleValueChange);$scope.$watch(function(){return $scope.customerNo},handleValueChange);$scope.VIEW_TYPE_TEAM="TEAM";$scope.CustomerConstants=CustomerConstants;$scope.loadJilTeamSubscriptions=function(){$scope.isJilTeamSubscriptionLoading=true;$scope.locale="en_US";$scope.teamSubscriptionListByDelegate=[];$scope.jilTeamSubscriptionlists=[];CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:$scope.locale.toLowerCase()}).success(function(result,status,headers,config){$scope.teamSubscriptionListByAdmin=CustomerUtil.getTeamSubscriptionList(result,$scope.customerGuid);var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Customer Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config);CustomerSubscriptionService.getTeamSubscriptionListByDelegate({customerGuid:$scope.customerGuid,locale:$scope.locale.toLowerCase()}).success(function(result,status,headers,config){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Customer Details - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config);$scope.delegateCount=result.length;$scope.delegateSearchCount=1;if(result&&result.length>=1){angular.forEach(result,function(team){CustomerSubscriptionService.getTeamSubscriptionDetails({customerGuid:$scope.customerGuid,teamId:team.teamId,locale:$scope.locale.toLowerCase()}).success(function(resultDetails,status,headers,config){var delegateDetails=[];if($scope.teamSubscriptionListByAdmin.length&&$scope.delegateSearchCount==1){$scope.jilTeamSubscriptionlists.push($scope.teamSubscriptionListByAdmin[0])}if($scope.delegateCount==$scope.delegateSearchCount){$scope.isJilTeamSubscriptionLoading=false}else{$scope.delegateSearchCount++}delegateDetails.push(resultDetails);$scope.teamSubscriptionListByDelegate=CustomerUtil.getTeamSubscriptionList(delegateDetails,$scope.customerGuid);if($scope.teamSubscriptionListByAdmin.length&&$scope.teamSubscriptionListByAdmin[0].teamId!=$scope.teamSubscriptionListByDelegate[0].teamId){if(!_.find($scope.jilTeamSubscriptionlists,{teamId:$scope.teamSubscriptionListByDelegate[0].teamId})){$scope.jilTeamSubscriptionlists.push($scope.teamSubscriptionListByDelegate[0])}}else{if(!$scope.teamSubscriptionListByAdmin.length&&$scope.teamSubscriptionListByDelegate.length){if(!_.find($scope.jilTeamSubscriptionlists,{teamId:$scope.teamSubscriptionListByDelegate[0].teamId})){$scope.jilTeamSubscriptionlists.push($scope.teamSubscriptionListByDelegate[0])}}}var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,resultDetails);messageObject.Functionality="Customer Details - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(resultDetails,status,headers,config){var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,resultDetails);messageObject.Functionality="Customer Details - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})})}else{$scope.isJilTeamSubscriptionLoading=false;if($scope.teamSubscriptionListByAdmin.length&&$scope.delegateSearchCount==1){if(!_.find($scope.jilTeamSubscriptionlists,{teamId:$scope.teamSubscriptionListByAdmin[0].teamId})){$scope.jilTeamSubscriptionlists.push($scope.teamSubscriptionListByAdmin[0])}}}$scope.jilTeamRecords=$scope.jilTeamSubscriptionlists}).error(function(result,status,headers,config){$scope.isJilTeamSubscriptionLoading=false;if($scope.teamSubscriptionListByAdmin.length){if(!_.find($scope.jilTeamSubscriptionlists,{teamId:$scope.teamSubscriptionListByAdmin[0].teamId})){$scope.jilTeamSubscriptionlists.push($scope.teamSubscriptionListByAdmin[0])}}else{$scope.subscriptionError=TeamUtil.standardErrorMessage(result)}$scope.jilTeamRecords=$scope.jilTeamSubscriptionlists;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Customer Details - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(result,status,headers,config){$scope.isJilTeamSubscriptionLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Customer Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=$scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject};$scope.createTSCase=function(rec,contextType){var returnCaseTemplateUrl;returnCaseTemplateUrl="/case/newTs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE+"&productSku="+rec.sku+"&contextType="+contextType+"&tenureDate="+rec.registrationDate+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUrl)};$scope.createCSCase=function(rec,contextType){var returnCaseTemplateUr;returnCaseTemplateUr="/case/newCs?"+$scope.newCaseCustomerLink+"&tempId="+AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE+"&productSku="+rec.sku+"&contextType="+contextType+"&tenureDate="+rec.registrationDate+"&orgguid="+$scope.orgguid;window.open(AppUtils.getApplicationUrl()+returnCaseTemplateUr)};$scope.toggleExpandCollapseAll=function(){var buttonClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#jil-team-subscription-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-chevron-right":"glyphicon glyphicon-chevron-down";$("#accordionJilTeamProductView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionJilTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};$scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-chevron-right")?"glyphicon glyphicon-chevron-down":"glyphicon glyphicon-chevron-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseJilTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseJilTeamProductItems"+indexId).removeClass().addClass(accordionClassName)};$scope.getProductSeats=function(records,offerId){var qty=0;angular.forEach(records,function(product){if(offerId==product.offerId&&product.paymentStatus&&product.paymentStatus.toUpperCase()!=="CANCELLED"){qty=qty+product.quantity}});return qty};$scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus}}}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TeamSubscriptionListDto",{teamId:"",customerGuid:"",teamName:"",isPrimaryAdmin:"",isSeondaryAdmin:"",isInvitedAdmin:"",totalSeats:"",seatDetails:[],externalContractId:"",programContractId:""});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TeamUtil",["$rootScope","$location","CustomerDetailsDto","TeamDetailsDto","TeamConstants","TeamAddSeatPriceDto","TeamSeatProductDto","AppUtils","DrTeamAddSeatDto",function($rootScope,$location,CustomerDetailsDto,TeamDetailsDto,TeamConstants,TeamAddSeatPriceDto,TeamSeatProductDto,AppUtils,DrTeamAddSeatDto){this.getCustomerHeaderDetails=function(customerDetails){var customerDetailsDto=angular.copy(CustomerDetailsDto);customerDetailsDto.displayName=_.has(customerDetails,"displayName")?customerDetails.displayName:"";customerDetailsDto.firstName=_.has(customerDetails,"first_name")?customerDetails.first_name:"";customerDetailsDto.lastName=_.has(customerDetails,"last_name")?customerDetails.last_name:"";customerDetailsDto.email=_.has(customerDetails,"email")?customerDetails.email:"";customerDetailsDto.rengaId=_.has(customerDetails,"userId")?customerDetails.userId.replace(/@AdobeID/i,""):"";customerDetailsDto.countryCode=_.has(customerDetails,"countryCode")?customerDetails.countryCode:"";return customerDetailsDto};this.getTeamDetails=function(teamDetails,customerGuid){var seatDetails;var administrators;var teamSubscriptionDetailsDto=angular.copy(TeamDetailsDto);if(teamDetails){teamSubscriptionDetailsDto.teamId=_.has(teamDetails,"id")?teamDetails.id:"";teamSubscriptionDetailsDto.customerGuid=customerGuid+"@AdobeID";teamSubscriptionDetailsDto.teamName=_.has(teamDetails,"name")?teamDetails.name:"";teamSubscriptionDetailsDto.type=_.has(teamDetails,"type")?teamDetails.type:"";teamSubscriptionDetailsDto.programContractId=_.has(teamDetails,"programContractId")?teamDetails.programContractId:"";teamSubscriptionDetailsDto.marketSegment=_.has(teamDetails,"marketSegment")?teamDetails.marketSegment:"";teamSubscriptionDetailsDto.externalContractId=_.has(teamDetails,"externalContractId")?teamDetails.externalContractId:"";teamSubscriptionDetailsDto.anniversaryDate=_.has(teamDetails,"commitmentInfo.anniversaryDate")?teamDetails.commitmentInfo["anniversaryDate"]:"";teamSubscriptionDetailsDto.lastBillingDate=_.has(teamDetails,"billingInfo.lastBillingDate")?teamDetails.billingInfo["lastBillingDate"]:"";teamSubscriptionDetailsDto.billingFrequency=_.has(teamDetails,"billingInfo.billingFrequency")?teamDetails.billingInfo["billingFrequency"]:"";teamSubscriptionDetailsDto.renewalState=_.has(teamDetails,"commitmentInfo.renewalState")?teamDetails.commitmentInfo["renewalState"]:"";teamSubscriptionDetailsDto.paymentType=_.has(teamDetails,"billingInfo.paymentCategory")?this.getPaymentTypeText(teamDetails.billingInfo["paymentCategory"]):"";teamSubscriptionDetailsDto.locale=_.has(teamDetails,"preferredLanguage")?teamDetails.preferredLanguage:"en_us";teamSubscriptionDetailsDto.isEditable=_.has(teamDetails,"isEditable")?teamDetails.isEditable:false;teamSubscriptionDetailsDto.isDrContract=_.has(teamDetails,"isDrContract")?teamDetails.isDrContract:false;teamSubscriptionDetailsDto.pstPaidStartDate=_.has(teamDetails,"pstPaidStartDate")?teamDetails.pstPaidStartDate:"";teamSubscriptionDetailsDto.pstPaidEndDate=_.has(teamDetails,"pstPaidEndDate")?teamDetails.pstPaidEndDate:"";teamSubscriptionDetailsDto.countryCode=_.has(teamDetails,"address.country.countryCode")?teamDetails.address["country"]["countryCode"]:"";teamSubscriptionDetailsDto.isContractTypeIndirect=false;if(teamSubscriptionDetailsDto.type&&teamSubscriptionDetailsDto.type.toUpperCase()==TeamConstants.CONTRACT_TYPE_INDIRECT){teamSubscriptionDetailsDto.isContractTypeIndirect=true;teamSubscriptionDetailsDto.resellerOrgName=_.has(teamDetails,"managedBy.resellerOrganizationName")?teamDetails.managedBy["resellerOrganizationName"]:"";teamSubscriptionDetailsDto.resellerUserId=_.has(teamDetails,"managedBy.userId")?teamDetails.managedBy["userId"]:"";teamSubscriptionDetailsDto.resellerId=_.has(teamDetails,"managedBy.resellerId")?teamDetails.managedBy["resellerId"]:"";teamSubscriptionDetailsDto.resellerFirstName=_.has(teamDetails,"managedBy.firstName")?teamDetails.managedBy["firstName"]:"";teamSubscriptionDetailsDto.resellerLastName=_.has(teamDetails,"managedBy.lastName")?teamDetails.managedBy["lastName"]:"";teamSubscriptionDetailsDto.resellerEmail=_.has(teamDetails,"managedBy.email")?teamDetails.managedBy["email"]:""}if(teamSubscriptionDetailsDto.renewalState&&teamSubscriptionDetailsDto.renewalState.toUpperCase()==TeamConstants.RENEWAL_STATE_NON_RENEWAL){teamSubscriptionDetailsDto.renewalState=TeamConstants.RENEWAL_STATE_NON_RENEWAL_TXT}else{if(teamSubscriptionDetailsDto.renewalState&&teamSubscriptionDetailsDto.renewalState.toUpperCase()==TeamConstants.RENEWAL_STATE_RENEWAL){teamSubscriptionDetailsDto.renewalState=TeamConstants.RENEWAL_STATE_RENEWAL_TXT}else{if(teamSubscriptionDetailsDto.renewalState&&teamSubscriptionDetailsDto.renewalState.toUpperCase()==TeamConstants.RENEWAL_STATE_BEFORE_ANNIVERSARY_DATE){teamSubscriptionDetailsDto.renewalState=TeamConstants.RENEWAL_STATE_BEFORE_ANNIVERSARY_DATE_TXT}}}teamSubscriptionDetailsDto.billingInfo=_.has(teamDetails,"billingInfo")?teamDetails.billingInfo:"";teamSubscriptionDetailsDto.administrators=[];teamSubscriptionDetailsDto.isPrimaryAdmin=false;teamSubscriptionDetailsDto.isSeondaryAdmin=false;teamSubscriptionDetailsDto.isInvitedAsPrimary=false;teamSubscriptionDetailsDto.isInvitedAsSecondary=false;teamSubscriptionDetailsDto.isInviteAsSecondaryAvailable=true;teamSubscriptionDetailsDto.isAddSeatAvailable=false;angular.forEach(teamDetails.administrators,function(admin){administrators={};administrators.type=_.has(admin,"type")?admin.type:"";administrators.userId=_.has(admin,"userId")?admin.userId.replace(/@AdobeID/i,""):"";administrators.invitation=_.has(admin,"invitation")?admin.invitation:"";if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_PRIMARY&&administrators.userId==customerGuid){teamSubscriptionDetailsDto.isPrimaryAdmin=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_GROUP&&administrators.invitation&&administrators.invitation.typeCode.toUpperCase()==TeamConstants.TEAM_INVITE_PRIMARY&&administrators.userId==customerGuid){teamSubscriptionDetailsDto.isInvitedAsPrimary=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_GROUP&&administrators.userId==customerGuid){teamSubscriptionDetailsDto.isSeondaryAdmin=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_INVITED&&administrators.userId==customerGuid){teamSubscriptionDetailsDto.isInvitedAsSecondary=true}}}}});angular.forEach(teamDetails.administrators,function(admin){administrators={};administrators.firstName=_.has(admin,"firstName")?admin.firstName:"";administrators.lastName=_.has(admin,"lastName")?admin.lastName:"";administrators.type=_.has(admin,"type")?admin.type:"";administrators.invitation=_.has(admin,"invitation")?admin.invitation:"";administrators.userId=_.has(admin,"userId")?admin.userId.replace(/@AdobeID/i,""):"";administrators.email=_.has(admin,"email")?admin.email.toLowerCase():"";administrators.isRemoveAdminAvailable=_.has(admin,"isRemoveAdminAvailable")?admin.isRemoveAdminAvailable:"";administrators.isChangePrimaryAdminAvailable=_.has(teamDetails,"isChangePrimaryAdminAvailable")?teamDetails.isChangePrimaryAdminAvailable:false;if(teamSubscriptionDetailsDto.paymentType&&teamSubscriptionDetailsDto.paymentType.toUpperCase()==TeamConstants.PAYMENT_TYPE_PAYPAL.toUpperCase()){administrators.isChangePrimaryAdminAvailable=false}administrators.isInvitedAsSecondary=false;administrators.isInvitedAsPrimary=false;administrators.isSecondaryAdmin=false;administrators.isPrimaryAdmin=false;if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_PRIMARY){administrators.type="Primary Admin";administrators.isPrimaryAdmin=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_GROUP&&administrators.invitation&&administrators.invitation.typeCode.toUpperCase()==TeamConstants.TEAM_INVITE_PRIMARY){administrators.type="Invited as Primary";administrators.invitationCode=_.has(admin,"invitation.invitationCode")?admin.invitation["invitationCode"]:"";administrators.isInvitedAsPrimary=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_GROUP){administrators.type="Secondary Admin";administrators.isSecondaryAdmin=true}else{if(administrators.type&&administrators.type.toUpperCase()==TeamConstants.ADMIN_TYPE_INVITED){administrators.type="Invited as Secondary";administrators.isInvitedAsSecondary=true}}}}if(!teamSubscriptionDetailsDto.isEditable){administrators.isChangePrimaryAdminAvailable=false;administrators.isRemoveAdminAvailable=false;administrators.isInvitedAsSecondary=false;administrators.isInvitedAsPrimary=false;teamSubscriptionDetailsDto.isInviteAsSecondaryAvailable=false;teamSubscriptionDetailsDto.isAddSeatAvailable=true}teamSubscriptionDetailsDto.administrators.push(administrators)});teamSubscriptionDetailsDto.seatDetails=[];angular.forEach(teamDetails.seats.named,function(seat){seatDetails={};seatDetails.productName=_.has(seat,"productName")?seat.productName:_.has(seat,"localizedLongProductDescriptor")?seat.localizedLongProductDescriptor:"";seatDetails.productCode=_.has(seat,"productCode")?seat.productCode:"";seatDetails.quantity=_.has(seat,"quantity")?seat.quantity:"";seatDetails.paymentStatus=_.has(seat,"paymentStatus")?seat.paymentStatus:"";seatDetails.language=_.has(seat,"language")?seat.language:"";seatDetails.primaryImageUrl=_.has(seat,"primaryImageUrl")?"https://wwwimages2.adobe.com"+seat.primaryImageUrl:"img/products/no-product.png";seatDetails.sku=_.has(seat,"sku")?seat.sku:"";seatDetails.ProductLongName=_.has(seat,"localizedLongProductDescriptor")?seat.localizedLongProductDescriptor:"";seatDetails.offerId=_.has(seat,"offerId")?seat.offerId:"";seatDetails.isRemoveDelegateAvailable=_.has(seat,"isRemoveDelegateAvailable")?seat.isRemoveDelegateAvailable:false;seatDetails.isInviteDelegateAvailable=_.has(seat,"isInviteDelegateAvailable")?seat.isInviteDelegateAvailable:false;seatDetails.isCancelAvailable=_.has(seat,"isCancelAvailable")?seat.isCancelAvailable:false;seatDetails.isResendInviteDelegateAvailable=false;seatDetails.delegateStatus=_.has(seat,"status")?seat.status:"";seatDetails.purchasedEntitlementId=_.has(seat,"purchasedEntitlementId")?seat.purchasedEntitlementId:"";seatDetails.poNumber=_.has(seat,"poNumber")?seat.poNumber:"";seatDetails.termStartDate=_.has(seat,"termStartDate")?seat.termStartDate:"";seatDetails.termEndDate=_.has(seat,"termEndDate")?seat.termEndDate:"";dateTimeArray=seatDetails.termStartDate.split("T");timeArray=dateTimeArray[1].split("-");dateString=dateTimeArray[0].split("-");seatDetails.termStartDate=dateString[2]+"-"+dateString[1]+"-"+dateString[0]+" "+timeArray[0]+" PST";dateTimeArray=seatDetails.termEndDate.split("T");timeArray=dateTimeArray[1].split("-");dateString=dateTimeArray[0].split("-");seatDetails.termEndDate=dateString[2]+"-"+dateString[1]+"-"+dateString[0]+" "+timeArray[0]+" PST";if(seatDetails.delegateStatus&&seatDetails.delegateStatus.toUpperCase()==TeamConstants.DELEGATE_STATUS_INVITED){seatDetails.firstName=_.has(seat,"invitation.firstName")?seat.invitation["firstName"]:"";seatDetails.lastName=_.has(seat,"invitation.lastName")?seat.invitation["lastName"]:"";seatDetails.email=_.has(seat,"invitation.email")?seat.invitation["email"].toLowerCase():"-";seatDetails.fulfilledEntitlementId=_.has(seat,"fulfilledEntitlementId")?seat.fulfilledEntitlementId:"";seatDetails.isResendInviteDelegateAvailable=true}else{if(seatDetails.delegateStatus&&seatDetails.delegateStatus.toUpperCase()==TeamConstants.DELEGATE_STATUS_ASSIGNED){seatDetails.firstName=_.has(seat,"delegation.firstName")?seat.delegation["firstName"]:"";seatDetails.lastName=_.has(seat,"delegation.lastName")?seat.delegation["lastName"]:"";seatDetails.email=_.has(seat,"delegation.email")?seat.delegation["email"].toLowerCase():"-";seatDetails.fulfilledEntitlementId=_.has(seat,"fulfilledEntitlementId")?seat.fulfilledEntitlementId:""}else{if(seatDetails.delegateStatus&&seatDetails.delegateStatus.toUpperCase()==TeamConstants.DELEGATE_STATUS_UNASSIGNED){seatDetails.fulfillableEntitlementId=_.has(seat,"fulfillableEntitlementId")?seat.fulfillableEntitlementId:"";seatDetails.email="-"}}}if(!seatDetails.isInviteDelegateAvailable){if(seatDetails.paymentStatus==TeamConstants.PAYMENT_STATUS_PENDING_PAYMENT&&seatDetails.delegateStatus==TeamConstants.DELEGATE_STATUS_UNASSIGNED){seatDetails.isInviteDelegateAvailable=true}}if(!teamSubscriptionDetailsDto.isEditable){seatDetails.isResendInviteDelegateAvailable=false;seatDetails.isRemoveDelegateAvailable=false;seatDetails.isInviteDelegateAvailable=false;seatDetails.isCancelAvailable=false}if(!seatDetails.offerId){AppUtils.sendLogToServer("Missing OfferId: "+teamSubscriptionDetailsDto.teamId+" Customer GUID : "+teamSubscriptionDetailsDto.customerGuid+" SKU : "+seatDetails.sku+" Product Code :"+seatDetails.productCode+" Market Segment : "+teamSubscriptionDetailsDto.marketSegment+" Locale : "+teamSubscriptionDetailsDto.locale)}teamSubscriptionDetailsDto.seatDetails.push(seatDetails)});teamSubscriptionDetailsDto.totalSeats=_.has(teamDetails,"seats.summary.namedSummary.total")?teamDetails.seats["summary"]["namedSummary"]["total"]:0;teamSubscriptionDetailsDto.cancelledSeats=_.has(teamDetails,"seats.summary.namedSummary.cancelled")?teamDetails.seats["summary"]["namedSummary"]["cancelled"]:0;teamSubscriptionDetailsDto.availableSeats=teamSubscriptionDetailsDto.totalSeats-teamSubscriptionDetailsDto.cancelledSeats;teamSubscriptionDetailsDto.delegated=_.has(teamDetails,"seats.summary.namedSummary.delegated")?teamDetails.seats["summary"]["namedSummary"]["delegated"]:0;teamSubscriptionDetailsDto.unassigned=_.has(teamDetails,"seats.summary.namedSummary.unassigned")?teamDetails.seats["summary"]["namedSummary"]["unassigned"]:0;teamSubscriptionDetailsDto.invited=_.has(teamDetails,"seats.summary.namedSummary.invited")?teamDetails.seats["summary"]["namedSummary"]["invited"]:0;teamSubscriptionDetailsDto.paid=_.has(teamDetails,"seats.summary.namedSummary.paid")?teamDetails.seats["summary"]["namedSummary"]["paid"]:0;teamSubscriptionDetailsDto.pendingPayment=_.has(teamDetails,"seats.summary.namedSummary.pendingPayment")?teamDetails.seats["summary"]["namedSummary"]["pendingPayment"]:0;teamSubscriptionDetailsDto.gracePastDue=_.has(teamDetails,"seats.summary.namedSummary.gracePastDue")?teamDetails.seats["summary"]["namedSummary"]["gracePastDue"]:0;teamSubscriptionDetailsDto.pastDue=_.has(teamDetails,"seats.summary.namedSummary.pastDue")?teamDetails.seats["summary"]["namedSummary"]["pastDue"]:0;teamSubscriptionDetailsDto.cancelling=_.has(teamDetails,"seats.summary.namedSummary.cancelling")?teamDetails.seats["summary"]["namedSummary"]["cancelling"]:0;teamSubscriptionDetailsDto.cancelled=_.has(teamDetails,"seats.summary.namedSummary.cancelled")?teamDetails.seats["summary"]["namedSummary"]["cancelled"]:0;teamSubscriptionDetailsDto.address=_.has(teamDetails,"address")?teamDetails.address:""}if(teamSubscriptionDetailsDto.billingFrequency==TeamConstants.TEAM_UNKNOWN){teamSubscriptionDetailsDto.paymentType=TeamConstants.TEAM_UNKNOWN;if(teamSubscriptionDetailsDto.seatDetails[0].poNumber&&teamSubscriptionDetailsDto.seatDetails[0].poNumber!=""&&(teamSubscriptionDetailsDto.seatDetails[0].poNumber.startsWith("AD")||teamSubscriptionDetailsDto.seatDetails[0].poNumber.startsWith("HD")||teamSubscriptionDetailsDto.seatDetails[0].poNumber.startsWith("C"))){teamSubscriptionDetailsDto.externalContractId=teamSubscriptionDetailsDto.seatDetails[0].poNumber}else{teamSubscriptionDetailsDto.externalContractId="In Process"}}console.log(teamSubscriptionDetailsDto);return teamSubscriptionDetailsDto};this.getPaymentType=function(billingInfo){var paymentInfo=_.has(billingInfo,"paymentInstrumentInfo")?billingInfo.paymentInstrumentInfo:"";var paymentDetails=new Object();if(paymentInfo&&billingInfo.paymentCategory.toUpperCase()=="CREDIT_CARD"){if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="VISA"){paymentDetails.cardTypeName="VISA"}else{if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="MASTER_CARD"){paymentDetails.cardTypeName="MasterCard"}else{if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="AMEX"){paymentDetails.cardTypeName="American Express"}else{if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="JCB"){paymentDetails.cardTypeName="JCB"}else{if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="Switch"){paymentDetails.cardTypeName="Switch"}else{paymentDetails.cardTypeName=""}}}}}paymentDetails.paymentType=2;paymentDetails.cardHolder=paymentInfo.accountHolderName;paymentDetails.cardNumber=paymentInfo.maskedAccountNumber;paymentDetails.expirationDate=paymentInfo.expiryDate}else{if(billingInfo.paymentCategory.toUpperCase()=="DIRECT_CREDIT"){paymentDetails.cardTypeName="Debit Card";paymentDetails.paymentType=3}else{if(paymentInfo&&billingInfo.paymentCategory.toUpperCase()=="DIRECT_DEBIT"){paymentDetails.cardTypeName="DD";paymentDetails.paymentType=6;paymentDetails.ibaNumber=paymentInfo.maskedAccountNumber;paymentDetails.bankName=paymentInfo.bankName;paymentDetails.city=paymentInfo.bankCity;paymentDetails.accountHolder=paymentInfo.accountHolderName}else{if(paymentInfo&&billingInfo.paymentCategory.toUpperCase()=="OFFLINE"){if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="CVS"){paymentDetails.cardTypeName="CVS";paymentDetails.paymentType=4}else{if(paymentInfo.paymentType&&paymentInfo.paymentType.toUpperCase()=="BANKTRANSFER"){paymentDetails.cardTypeName="Bank Transfer";paymentDetails.paymentType=5;paymentDetails.accountHolder=paymentInfo.accountHolderName}}paymentDetails.bankTransferNumber=""}else{if(paymentInfo&&billingInfo.paymentCategory.toUpperCase()=="PAYPAL"){paymentDetails.cardTypeName="PayPal";paymentDetails.paymentType=8;paymentDetails.paypalEmail=paymentInfo.payerId}else{if(billingInfo.paymentCategory=="PURCHASE_ORDER"){paymentDetails.cardTypeName="PO";paymentDetails.paymentType=9;paymentDetails.poNumber=""}else{paymentDetails.cardTypeName="";paymentDetails.paymentType=0}}}}}}return paymentDetails};this.getPaymentTypeText=function(paymentType){if(paymentType.toUpperCase()==TeamConstants.PAYMENT_CC){paymentType=TeamConstants.PAYMENT_TYPE_CC}else{if(paymentType.toUpperCase()==TeamConstants.PAYMENT_DC){paymentType=TeamConstants.PAYMENT_TYPE_DC}else{if(paymentType.toUpperCase()==TeamConstants.PAYMENT_DD){paymentType=TeamConstants.PAYMENT_TYPE_DD}else{if(paymentType.toUpperCase()==TeamConstants.PAYMENT_OFFLINE){paymentType=TeamConstants.PAYMENT_TYPE_OFFLINE}else{if(paymentType.toUpperCase()==TeamConstants.PAYMENT_PAYPAL){paymentType=TeamConstants.PAYMENT_TYPE_PAYPAL}else{if(paymentType.toUpperCase()==TeamConstants.PAYMENT_PO){paymentType=TeamConstants.PAYMENT_TYPE_PO}else{paymentType=""}}}}}}return paymentType};this.removeParameterFromUrl=function(paramName){$location.skipReload().search(paramName,null)};this.addParameterToUrl=function(paramName,paramValue){if($location.path().indexOf(paramName)==-1){$location.skipReload().search(paramName,paramValue)}};this.standardErrorMessage=function(errorResult){var errorDetails={};var splitedMessage=[];if(errorResult[0]&&errorResult[0].invitationFailureReason&&errorResult[0].invitationFailureReason.toUpperCase()==TeamConstants.ALREADY_INVITED){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Invited admin is already exists."}else{if(errorResult[0]&&errorResult[0].invitationFailureReason&&errorResult[0].invitationFailureReason.toUpperCase()==TeamConstants.PRIMARY_ADMIN_INVITEE_COUNTRY_CONFLICT){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Primary Admin invitee country conflict."}else{if(errorResult[0]&&errorResult[0].invitationFailureReason&&errorResult[0].invitationFailureReason.toUpperCase()==TeamConstants.PRIMARY_ADMIN_FOR_ANOTHER_DIRECT_TEAM){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Primary Admin for another direct team."}else{if(errorResult&&errorResult.error_code=="401013"&&errorResult.message==TeamConstants.OAUTH_TOKEN_IS_NOT_VALID){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Oauth token is not valid."}else{if(errorResult&&errorResult.error_code=="UNSUPPORTED_TEAM_TYPE"&&errorResult.message==TeamConstants.UNSUPPORTED_TEAM_TYPE){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Unsupported Team Type."}else{if(errorResult&&errorResult.errorCode=="JEM_SERVER_ERROR"&&errorResult.errorMessage==TeamConstants.JEM_SERVER_ERROR){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="JEM Server Error."}else{if(errorResult&&errorResult.errorCode=="PURCHASE_ORDER_NUMBER_IS_REQUIRED"&&errorResult.errorMessage==TeamConstants.PURCHASE_ORDER_NUMBER_IS_REQUIRED){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Purchase Order Number Is Required."}else{if(errorResult&&errorResult[0]&&errorResult[0].seatUpdateFailureReason&&errorResult[0].seatUpdateFailureReason==TeamConstants.INVALID_PRODUCT_CODE){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Invalid Product Code."}else{if(errorResult&&errorResult[0]&&errorResult[0].seatUpdateFailureReason&&errorResult[0].seatUpdateFailureReason==TeamConstants.SEAT_ALREADY_REQUESTED_FOR_DELETION){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Seat Already Requsted For Deletion."}else{if(errorResult&&errorResult[0]&&errorResult[0].seatUpdateFailureReason&&errorResult[0].seatUpdateFailureReason=="SEAT_NOT_FOUND"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Seat Not Found."}else{errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="";if(errorResult.errorMessage){splitedMessage=errorResult.errorMessage.split("_");angular.forEach(splitedMessage,function(item){errorDetails.message=errorDetails.message+" "+item.toLowerCase().replace(/\b(\s\w|^\w)/g,function(txt){return txt.toUpperCase()})})}else{errorDetails.message="The service failed to get data, please try again..."}}}}}}}}}}}return errorDetails};this.standardErrorDrMessage=function(errorResult){var errorDetails={};if(errorResult){if(errorResult.errorCode=="CUSTOMER_NOT_IN_RENEWAL_WINDOW"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Customer not in renewal window"}else{if(errorResult.errorCode=="DR_ERROR_ANNUAL_PUF_CONTRACT_LICENSE_REMOVAL_NOT_ALLOWED"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Annual puf contract license removal not allowed"}else{if(errorResult.errorCode=="DR_ERROR_ORDER_ALREADY_SUBMITTED_FOR_CANCELLATION"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="The contract is already submitted for cancellation"}else{if(errorResult.errorCode=="DR_ERROR_CANCELLATION_FOR_THIS_ORDER_ALREADY_IN_PROGRESS"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message=" Contract cancellation is already in progress"}else{if(errorResult.errorCode=="DR_ERROR_NO_OPEN_ORDER_FOUND"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Unable to find the contract on Digital River"}else{if(errorResult.errorCode=="DR_ERROR_UNABLE_TO_UPDATE_ORDER"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Unable to update the contract on Digital River"}else{if(errorResult.errorCode=="DR_ERROR_REMOVING_PUF_LICENSE_IS_NOT_ALLOWED"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Cancelling PUF contract is not supported by Digital River"}else{if(errorResult.errorCode=="DR_ERROR_NO_MATCHING_PRODUCTS"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Unable to find the products on contract"}else{if(errorResult.errorCode=="DR_ERROR_COULD_NOT_FIND_CONTRACT_CHARGE_ORDER"){errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message="Unable to find contract charge order"}else{errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message=errorResult.errorMessage}}}}}}}}}}else{errorDetails.type=TeamConstants.MESSAGE_ERROR_TYPE;errorDetails.message=errorResult.errorMessage}return errorDetails};this.getTeamAddSeatPriceDetails=function(priceData){var teamAddSeatPriceDto=angular.copy(TeamAddSeatPriceDto);teamAddSeatPriceDto.currentPriceWithTax=_.has(priceData,"priceList.currentPrice.priceWithTax")?priceData.priceList["currentPrice"]["priceWithTax"]:"";teamAddSeatPriceDto.currentPriceWithoutTax=_.has(priceData,"priceList.currentPrice.priceWithoutTax")?priceData.priceList["currentPrice"]["priceWithoutTax"]:"";teamAddSeatPriceDto.currentQuantity=_.has(priceData,"priceList.currentPrice.quantityIndex")?priceData.priceList["currentPrice"]["quantityIndex"]:"";teamAddSeatPriceDto.oneUnitPriceWithTax=_.has(priceData,"priceList.price[1].priceWithTax")?priceData.priceList["price"][1]["priceWithTax"]:"";teamAddSeatPriceDto.oneUnitPriceWithoutTax=_.has(priceData,"priceList.price[1].priceWithoutTax")?priceData.priceList["price"][1]["priceWithoutTax"]:"";teamAddSeatPriceDto.currencyCode=_.has(priceData,"currency.iso3code")?priceData.currency["iso3code"]:"";return teamAddSeatPriceDto};this.getDrTeamAddSeatPriceDetails=function(priceData){var teamAddSeatPriceDto=angular.copy(TeamAddSeatPriceDto);teamAddSeatPriceDto.currentPriceWithoutTax=_.has(priceData,"cartItems[0].priceDetails.subTotal.amountWithoutTax")?priceData.cartItems[0]["priceDetails"]["subTotal"]["amountWithoutTax"]:"";teamAddSeatPriceDto.currentQuantity=_.has(priceData,"cartItems[0].quantity")?priceData.cartItems[0]["quantity"]:"";teamAddSeatPriceDto.oneUnitPriceWithTax=_.has(priceData,"cartItems[0].priceDetails.subTotal.amountWithoutTax")?priceData.cartItems[0]["priceDetails"]["subTotal"]["amountWithoutTax"]:"";teamAddSeatPriceDto.oneUnitPriceWithoutTax=_.has(priceData,"cartItems[0].priceDetails.subTotal.amountWithoutTax")?priceData.cartItems[0]["priceDetails"]["subTotal"]["amountWithoutTax"]:"";teamAddSeatPriceDto.currencyCode=_.has(priceData,"currency.code")?priceData.currency["code"]:"";teamAddSeatPriceDto.provisionedSubTotal=_.has(priceData,"provisionedSubTotal.amountWithoutTax")?priceData.provisionedSubTotal["amountWithoutTax"]:"";teamAddSeatPriceDto.seatQuantity=teamAddSeatPriceDto.currentQuantity;return teamAddSeatPriceDto};this.drTeamAddProductPriceDetails=function(priceData,cartItem){var teamAddSeatPriceDto=angular.copy(TeamAddSeatPriceDto);teamAddSeatPriceDto.currentPriceWithoutTax=_.has(cartItem,"priceDetails.subTotal.amountWithoutTax")?cartItem.priceDetails["subTotal"]["amountWithoutTax"]:"";teamAddSeatPriceDto.currentQuantity=_.has(cartItem,"quantity")?cartItem.quantity:"";teamAddSeatPriceDto.oneUnitPriceWithTax=_.has(cartItem,"priceDetails.unit.amountWithoutTax")?cartItem.priceDetails["unit"]["amountWithoutTax"]:"";teamAddSeatPriceDto.oneUnitPriceWithoutTax=_.has(cartItem,"priceDetails.unit.amountWithoutTax")?cartItem.priceDetails["unit"]["amountWithoutTax"]:"";teamAddSeatPriceDto.currencyCode=_.has(priceData,"currency.code")?priceData.currency["code"]:"";teamAddSeatPriceDto.provisionedSubTotal=_.has(priceData,"provisionedSubTotal.amountWithoutTax")?priceData.provisionedSubTotal["amountWithoutTax"]:"";teamAddSeatPriceDto.seatQuantity=teamAddSeatPriceDto.currentQuantity;return teamAddSeatPriceDto};this.getSeatProductDetails=function(productData){var productDataList=[];angular.forEach(productData,function(product){var seatProductDto=angular.copy(TeamSeatProductDto);seatProductDto.productName=_.has(product,"name")?product.name:"";seatProductDto.offerId=_.has(product,"offerId")?product.offerId:"";seatProductDto.primaryImageUrl=_.has(product,"primaryImage")?product.primaryImage:"";seatProductDto.productCode=_.has(product,"productCode")?product.productCode:"";seatProductDto.seatQuantity=_.has(product,"qtySelected")?product.qtySelected:1;seatProductDto.sku=_.has(product,"materialId")?product.materialId:"";seatProductDto.pricePoint=_.has(product,"pricePoint")?product.pricePoint:"";seatProductDto.isPromo=_.has(product,"isPromo")?product.isPromo:false;if(seatProductDto.isPromo){seatProductDto.productName=seatProductDto.productName+" Promo"}productDataList.push(seatProductDto)});return productDataList};this.getProductDetailsFromCart=function(product,cartData){var seatProductDto=angular.copy(TeamSeatProductDto);var isPromo="";seatProductDto.productName=_.has(product,"productName")?product.productName:"";seatProductDto.offerId=_.has(cartData,"offerId")?cartData.offerId:"";seatProductDto.primaryImageUrl=_.has(product,"primaryImageUrl")?product.primaryImageUrl:"";seatProductDto.productCode=_.has(product,"productCode")?product.productCode:"";seatProductDto.seatQuantity=_.has(product,"seatQuantity")?product.seatQuantity:1;seatProductDto.sku=_.has(cartData,"sku")?cartData.sku:"";seatProductDto.pricePoint=_.has(cartData,"pricePoint")?cartData.pricePoint:"";isPromo=_.has(product,"isPromo")?product.isPromo:false;if(isPromo){seatProductDto.productName=seatProductDto.productName.split(" Promo")[0]}return seatProductDto}}]);var app=app||angular.module("hxApp-directive",[]);app.directive("titileText",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}MetadataService.getTitles().success(function(response){})})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("titleText",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}MetadataService.getTitles().success(function(response){angular.forEach(response,function(item){if(value==item.code){scope.value=item.title;return}})})})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTooltipImage",function(){return{link:function(scope,elm,attrs){var xOffset=10,yOffset=30;function getExtension(filename){var parts=filename.split(".");return parts[parts.length-1]}function isImage(filename){var ext=getExtension(filename);switch(ext.toLowerCase()){case"jpg":case"gif":case"bmp":case"png":return true}return false}var fnOver=function(e){this.t=this.title;this.title="";var c=(this.t!="")?"<br/>"+this.t:"";$("body").append("<p id='img-preview'><img style='max-width: 200px'/><span>Loading...</span>"+c+"</p>");$("#img-preview img").attr("src",this.href).load(function(){$(this).animate({width:"200px"},"fast");$("#img-preview span").hide()});$("#img-preview").css("top",(e.pageY-xOffset)+"px").css("left",(e.pageX+yOffset)+"px").fadeIn("fast")};var fnOut=function(){this.title=this.t;$("#img-preview").remove()};scope.$watch(function(){return elm.attr("title")},function(value){if(!value){return}console.log(value);if(isImage(value)){elm.hover(fnOver,fnOut);elm.mousemove(function(e){$("#img-preview").css("top",(e.pageY-xOffset)+"px").css("left",(e.pageX+yOffset)+"px")})}})}}});var app=app||angular.module("hxApp.services").value("version","0.1");var transform=function(data){if(data){return $.param(data)}};app.factory("TrackerService",function($http){var service={};service.getOpenCases=function(agents,filterOptions){return $http({data:{agentIds:agents.toString(),startDate:filterOptions.startDate,tags:filterOptions.tags,endDate:filterOptions.endDate,maxResults:filterOptions.maxResults,statuses:filterOptions.statuses},method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../trackerService/getOpenCases.do",transformRequest:transform})};service.getOpenOrders=function(agents,filterOptions){return $http({data:{agentIds:agents.toString(),startDate:filterOptions.startDate,tags:filterOptions.tags,endDate:filterOptions.endDate,maxResults:filterOptions.maxResults},method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../trackerService/getOpenOrders.do",transformRequest:transform})};service.getOpenQuotes=function(agents,filterOptions){return $http({data:{agentIds:agents.toString(),startDate:filterOptions.startDate,tags:filterOptions.tags,endDate:filterOptions.endDate,maxResults:filterOptions.maxResults},method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../trackerService/getOpenQuotes.do",transformRequest:transform})};service.getCasesByTag=function(agents,filterOptions){return $http({data:{agentIds:agents,startDate:filterOptions.startDate,endDate:filterOptions.endDate,tags:filterOptions.tags,maxResults:filterOptions.maxResults},method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"../trackerService/getCasesByTag.do",transformRequest:transform})};return service});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TrackingService",["$rootScope","$window","$location",function($rootScope,$window,$location){this.trackPageView=function(channelName,pageName){var request=getPageViewRequest("Hx5:"+channelName,"Hx5:"+pageName);addRequest(request)};function trackCustomEvent(channelName,eventId,eventName,eVars){var request=getEventRequest(channelName,eventId,eventName,eVars);addRequest(request)}var REQUEST_TYPE_PAGE_VIEW="pageViewRequest";var REQUEST_TYPE_EVENT="eventRequest";var REQUEST_TIMER_DELAY=500;var REQUEST_ATTEMPTS_LIMIT=25;var requestQueue=[];var requestTimer;var requestTimerIsRunning=false;var currentEvars=[];var numRequestAttempts=0;function getPageViewRequest(channelName,pageName){return{requestType:REQUEST_TYPE_PAGE_VIEW,channelName:channelName,pageName:pageName}}function getEventRequest(channelName,eventId,eventName,eVars){return{requestType:REQUEST_TYPE_EVENT,channelName:channelName,eventId:eventId,eventName:eventName,eVars:eVars}}function addRequest(request){requestQueue.push(request);startRequestTimer()}function startRequestTimer(){if(!requestTimerIsRunning){requestTimer=setTimeout(processRequest,REQUEST_TIMER_DELAY);requestTimerIsRunning=true}}function stopRequestTimer(){if(requestTimerIsRunning){clearTimeout(requestTimer);requestTimerIsRunning=false}}function processRequest(){stopRequestTimer();if(requestQueue.length>0){if(analyticsAvailable()){var request=requestQueue.shift();sendRequest(request);numRequestAttempts=0}else{numRequestAttempts++}}if(requestQueue.length>0){if(numRequestAttempts<REQUEST_ATTEMPTS_LIMIT){startRequestTimer()}}}function sendRequest(request){switch(request.requestType){case REQUEST_TYPE_PAGE_VIEW:sendPageViewRequest(request);break;case REQUEST_TYPE_EVENT:sendEventRequest(request);break}}function sendPageViewRequest(request){var analyticsObject=getAnalyticsObject(request.channelName,request.pageName);analyticsObject.t()}function sendEventRequest(request){var analyticsObject=getAnalyticsObject(request.channelName,"");var trackVars=analyticsObject.linkTrackVars;trackVars+=",events";if(request.eVars){var eVars=request.eVars;for(var i=0;i<eVars.length;i++){var eVar=eVars[i];for(key in eVar){trackVars+=","+key;analyticsObject[key]=eVar[key]}}currentEvars=eVars}analyticsObject.linkTrackVars=trackVars;analyticsObject.linkTrackEvents=request.eventId;analyticsObject.events=request.eventId;analyticsObject.tl(true,"o",request.eventName)}function getAnalyticsObject(channelName,pageName){var analyticsObject=window.s;analyticsObject=resetAnalyticsObject(analyticsObject);analyticsObject.channel=channelName;analyticsObject.pageName=pageName;analyticsObject.linkTrackVars="channel";return analyticsObject}function resetAnalyticsObject(analyticsObject){clearCurrentEvars(analyticsObject);analyticsObject.linkTrackVars="";analyticsObject.linkTrackEvents="";analyticsObject.events="";return analyticsObject}function clearCurrentEvars(analyticsObject){for(var i=0;i<currentEvars.length;i++){var eVar=currentEvars[i];for(var eVarName in eVar){if(analyticsObject[eVarName]){analyticsObject[eVarName]=null}}}currentEvars=[]}function analyticsAvailable(){return(window.s!=undefined)}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TransactionBuilder",["$rootScope","StoreConstants","TransactionDto","TransactionItemDto",function($rootScope,StoreConstants,TransactionDto,TransactionItemDto){this.create=function(customer,cart){var transactionDto=angular.copy(TransactionDto);transactionDto.customer=customer;transactionDto.isCcmTeamTransaction=false;transactionDto.isSubscriptionTransaction=true;transactionDto.items=[];transactionDto.paymentDetails={cardHolder:"Default",cardNumber:"",cardType:"",expirationDate:"",expiryDate:"",expiryMonth:"",expiryYear:"",paymentType:2};angular.forEach(cart.items,function(cartItem){transactionDto.items.push(createTransactionItem(cartItem))});return transactionDto};var createTransactionItem=function(cartItem){var transactionItemDto=angular.copy(TransactionItemDto);transactionItemDto.sku=cartItem.sku;transactionItemDto.productName=cartItem.name;transactionItemDto.quantity=cartItem.quantity;transactionItemDto.currencyCode=cartItem.price.currency;transactionItemDto.listPrice=cartItem.price.listPrice;transactionItemDto.vatPrice=cartItem.price.vatPrice;transactionItemDto.ispuf=cartItem.puf;transactionItemDto.platform=cartItem.platform;transactionItemDto.config=cartItem.config;transactionItemDto.language=cartItem.language;transactionItemDto.version=cartItem.version;transactionItemDto.fulfillmentMethodTypeLabel="";transactionItemDto.serviceCommitment="";transactionItemDto.promoSku=cartItem.promoSku;transactionItemDto.productType=cartItem.prodType;transactionItemDto.promoCode=cartItem.promoCode;transactionItemDto.stock=cartItem.stock;return transactionItemDto};this.createDummyPayment=function(){var paymentDetails={cardHolder:"Default",cardNumber:"",cardType:"",expirationDate:"",expiryDate:"",expiryMonth:"",expiryYear:"",paymentType:2};return paymentDetails};this.recreateTransactionFromCancelledOrder=function(cancelOrder){var transactionDto=angular.copy(cancelOrder);transactionDto.transactionNumber="";transactionDto.recreate=true;transactionDto.transactionGuid="";transactionDto.status="";transactionDto.statusLabel="";transactionDto.rawStatus="";transactionDto.cancelCodeReason="";transactionDto.transactionTypeName="";transactionDto.transactionTypeChanged="";transactionDto.editingAllowed=false;transactionDto.creationDate="";for(var count=0;count<transactionDto.items.length;count++){transactionDto.items[count].id=null;transactionDto.items[count].rejectionCode="";transactionDto.items[count].rejectionCodeLabel="";transactionDto.items[count].status=""}return transactionDto}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.constant("TransactionConstants",{TRANSACTION_STANDARD_ORDER:"ZCOR",TRANSACTION_NON_SUBSCRIPTION__ORDER:"ZCOR",TRANSACTION_NEW_STANDARD_ORDER:"ZCSB",TRANSACTION_CCM_TEAM_ORDER:"ZCSB",TRANSACTION_FREE_OF_CHARGE_ORDER:"ZCKL",TRANSACTION_ORDER:"ORDER",TRANSACTION_DYLAN_ORDER:"ZSTO",SUBSCRIPTION_TRANSACTION_TYPE:"ZCSB",TRANSACTION_QUOTATION:"ZCAG",TRANSACTION_STANDARD_QUOTATION:"ZSAG",TRANSACTION_QUOTE:"QUOTE",TRANSACTION_ORDER_RETURN:"ZCRE",TRANSACTION_CREDIT_MEMO:"ZCCR",TRANSACTION_CM:"CREDIT_MEMO",TRANSACTION_DEBIT_MEMO:"ZCDR",TRANSACTION_DM:"DEBIT_MEMO",TRANSACTION_FREE_OF_CHARGE_ORDER:"ZCKL",TRANSACTION_FOC:"FOC",TRANSACTION_ADOBE_TRAINING_SERVICE_ORDER:"ZATS",TRANSACTION_ATS:"ATS",TRANSACTION_STATUS_OPEN:"OPEN",TRANSACTION_STATUS_IN_PROCESS:"IN_PROCESS",TRANSACTION_STATUS_CREATED:"CREATED",TRANSACTION_STATUS_COMPLETED:"COMPLETED",TRANSACTION_STATUS_RELEASED:"RELEASED",TRANSACTION_STATUS_FOR_RELEASE:"FOR_RELEASE",TRANSACTION_STATUS_DO_NOT_PRINT:"DO_NOT_PRINT",TRANSACTION_STATUS_PAYMENT_PENDING:"PAYMENT_PENDING",TRANSACTION_STATUS_ECOM_FULLFILLED:"FULFILLED",TRANSACTION_STATUS_ECOM_IN_PROGRESS:"ORDER_IN_PROGRESS",TRANSACTION_STATUS_ECOM_IN_REVIEW:"IN_REVIEW",TRANSACTION_STATUS_ECOM_REVIEW_ACCEPTED:"REVIEW_ACCEPTED",TRANSACTION_STATUS_ECOM_FAILED_REVIEW:"FAILED_REVIEW",TRANSACTION_STATUS_ECOM_UNAUTHORIZED:"UNAUTHORIZED",TRANSACTION_STATUS_ECOM_CANCELLED:"CANCELLED",TRANSACTION_STATUS_ECOM_REVIEW_EXPIRED:"REVIEW_EXPIRED",TRANSACTION_STATUS_ECOM_IN_REVIEW_NOTIFIED:"IN_REVIEW_NOTIFIED",TRANSACTION_STATUS_ECOM_HELD_OFFLINE_PAYMENT:"HELD_OFFLINE_PAYMENT",TRANSACTION_STATUS_ECOM_HELD_UNAUTHORIZED:"HELD_UNAUTHORIZED",TRANSACTION_STATUS_ECOM_HELD_FOR_MANUAL_AUTH:"HELD_FOR_MANUAL_AUTH",TRANSACTION_STATUS_ECOM_SUBMITTED:"SUBMITTED",TRANSACTION_STATUS_ECOM_READY_FOR_VALIDATION:"READY_FOR_VALIDATION",TRANSACTION_STATUS_ECOM_VALIDATED:"VALIDATED",TRANSACTION_STATUS_ECOM_PAYPAL_INITIALIZE:"PAYPAL_INITIALIZE",TRANSACTION_STATUS_ECOM_NEW:"NEW",TRANSACTION_STATUS_ECOM_INVOICED:"INVOICED",HARD_GOOD_PRODUCT_TYPE:"HGD",ESD_PRODUCT_TYPE:"ESD",ESD_PRODUCT_TYPE_UNCLASSIFIED:"ESD - UNCLASSIFIED",DSP_PRODUCT_TYPE:"DSP",CCM_TEAM_PRODUCT_TYPE:"CCMT",CCT_TEAM_PRODUCT_TYPE:"CCT",SUB_PRODUCT_TYPE:"SUB",WIRED_PRODUCTS:"ESD, SUB, CCM, DSP, CCLE, CCMT, SSP",SSP_PRODUCT_TYPE:"SSP",CCM_TEAM_PRODUCT_NAME:"CCLE",DOCUMENT_FLOW_BILLING_TYPE:"BILLING DOCUMENT",DOCUMENT_FLOW_CREDIT_MEMO_REQUEST:"CREDIT MEMO REQUEST",DOCUMENT_FLOW_DEBIT_MEMO_REQUEST:"DEBIT MEMO REQUEST",CREDIT_CARD_PAYMENT_TYPE:2,DIRECT_DEBIT_PAYMENT_TYPE:6,TRANSACTION_CHANGE_VIEW_EVENT:"TRANSACTION_CHANGE_VIEW_EVENT",TRANSACTION_EDIT_BILLING_EVENT:"TRANSACTION_EDIT_BILLING_EVENT",TRANSACTION_MODIFY_ORDER_EVENT:"TRANSACTION_MODIFY_ORDER_EVENT",TRANSACTION_ORDER_VIEW_EVENT:"TRANSACTION_ORDER_VIEW_EVENT",TRANSACTION_PAYMENT_UPDATE_EVENT:"TRANSACTION_PAYMENT_UPDATE_EVENT",TRANSACTION_ADDRESS_UPDATE_EVENT:"TRANSACTION_ADDRESS_UPDATE_EVENT",TRANSACTION_CANCEL_PAYMENT_UPDATE_EVENT:"TRANSACTION_CANCEL_PAYMENT_UPDATE_EVENT",TRANSACTION_PAYMENT_RESET_EVENT:"TRANSACTION_PAYMENT_RESET_EVENT",TRANSACTION_CANCEL_ADDRESS_UPDATE_EVENT:"TRANSACTION_CANCEL_ADDRESS_UPDATE_EVENT",TRANSACTION_CREATE_CREDIT_MEMO_EVENT:"TRANSACTION_CREATE_CREDIT_MEMO_EVENT",TRANSACTION_CREATE_DEBIT_MEMO_EVENT:"TRANSACTION_CREATE_DEBIT_MEMO_EVENT",TRANSACTION_PROGRESS_EVENT:"TRANSACTION_PROGRESS_EVENT",TRANSACTION_COMPLETE_EVENT:"TRANSACTION_COMPLETE_EVENT",TRANSACTION_ORDER_RETURN_VIEW_EVENT:"TRANSACTION_ORDER_RETURN_VIEW_EVENT",TRANSACTION_CANCEL_JPOP_ORDER_EVENT:"TRANSACTION_CANCEL_JPOP_ORDER_EVENT",TRANSACTION_UPDATE_MESSAGE_EVENT:"TRANSACTION_UPDATE_MESSAGE_EVENT",TRANSACTION_ORDER_VIEW:"TRANSACTION_ORDER_VIEW",TRANSACTION_DYLAN_ORDER_VIEW:"TRANSACTION_DYLAN_ORDER_VIEW",TRANSACTION_EDIT_BILLING_VIEW:"TRANSACTION_EDIT_BILLING_VIEW",TRANSACTION_RESET_PAYMENT_VIEW:"TRANSACTION_RESET_PAYMENT_VIEW",TRANSACTION_MODIFY_ORDER_VIEW:"TRANSACTION_MODIFY_ORDER_VIEW",TRANSACTION_CREATE_CREDIT_MEMO_VIEW:"TRANSACTION_CREATE_CREDIT_MEMO_VIEW",TRANSACTION_CREDIT_MEMO_VIEW:"TRANSACTION_CREDIT_MEMO_VIEW",TRANSACTION_DEBIT_MEMO_VIEW:"TRANSACTION_DEBIT_MEMO_VIEW",TRANSACTION_CREATE_DEBIT_MEMO_VIEW:"TRANSACTION_CREATE_DEBIT_MEMO_VIEW",TRANSACTION_QUOTE_VIEW:"TRANSACTION_QUOTE_VIEW",TRANSACTION_ORDER_RETURN_VIEW:"TRANSACTION_ORDER_RETURN_VIEW",TRANSACTION_CREATE_ORDER_RETURN_VIEW:"TRANSACTION_CREATE_ORDER_RETURN_VIEW",TRANSACTION_FOC_ORDER_VIEW:"TRANSACTION_FOC_ORDER_VIEW",TRANSACTION_ATS_ORDER_VIEW:"TRANSACTION_ATS_ORDER_VIEW",PAYMENT_REQUEST_SUCCESS:"PAYMENT_REQUEST_SUCCESS",PAYMENT_REQUEST_ERROR:"PAYMENT_REQUEST_ERROR",TEMPLATES:[{name:"Order View",url:"js/transaction/order/partials/order-view.html",item:"ZCOR, ZCSB",type:"ORDER",edit:false,viewName:"TRANSACTION_ORDER_VIEW"},{name:"Subscription Order Edit",url:"js/transaction/order/partials/subscription-order-edit.html",item:"ZCSB",type:"ORDER",edit:true,viewName:"TRANSACTION_EDIT_BILLING_VIEW"},{name:"Non Subscription Order Edit",url:"js/transaction/order/partials/non-subscription-order-edit.html",item:"ZCOR",type:"ORDER",edit:true,viewName:"TRANSACTION_MODIFY_ORDER_VIEW"},{name:"Credit Memo View",url:"js/transaction/credit-memo/partials/credit-memo-view.html",item:"ZCCR",type:"CREDIT_MEMO",edit:false,viewName:"TRANSACTION_CREDIT_MEMO_VIEW"},{name:"Create Credit Memo",url:"js/transaction/credit-memo/partials/create-credit-memo.html",item:"ZCCR",type:"CREDIT_MEMO",edit:true,viewName:"TRANSACTION_CREATE_CREDIT_MEMO_VIEW"},{name:"Debit Memo",url:"js/transaction/debit-memo/partials/debit-memo-view.html",item:"ZCDR",type:"DEBIT_MEMO",edit:false,viewName:"TRANSACTION_DEBIT_MEMO_VIEW"},{name:"Create Debit Memo",url:"js/transaction/debit-memo/partials/create-debit-memo.html",item:"ZCDR",type:"DEBIT_MEMO",edit:true,viewName:"TRANSACTION_CREATE_DEBIT_MEMO_VIEW"},{name:"Order Return",url:"js/transaction/order-return/partials/order-return.html",item:"ZCRE",type:"RETURN",edit:false,viewName:"TRANSACTION_ORDER_RETURN_VIEW"},{name:"Create Order Return",url:"js/transaction/order-return/partials/create-order-return.html",item:"ZCRE",type:"RETURN",edit:true,viewName:"TRANSACTION_CREATE_ORDER_RETURN_VIEW"},{name:"Quote",url:"js/transaction/quote/partials/quote-view.html",item:"ZCAG, ZSAG",type:"QUOTE",edit:false,viewName:"TRANSACTION_QUOTE_VIEW"},{name:"FOC Order View",url:"js/transaction/foc/partials/foc-order-view.html",item:"ZCKL",type:"FOC",edit:false,viewName:"TRANSACTION_FOC_ORDER_VIEW"},{name:"ATS Order View",url:"js/transaction/ats/partials/ats-order-view.html",item:"ZATS",type:"ATS",edit:false,viewName:"TRANSACTION_ATS_ORDER_VIEW"},{name:"Dylan Only Order View",url:"js/transaction/dylan-order/partials/dylan-order-view.html",item:"ZSTO",type:"DYLAN_ORDER",edit:false,viewName:"TRANSACTION_DYLAN_ORDER_VIEW"}],STATUS_TEMPLATES:[{name:"OPEN",code:"OPEN",description:"The order has passed all authorization and fraud checks and is open for fulfillment. At least one item is not yet fulfilled"},{name:"FULFILLED",code:"FULFILLED",description:"The order has been fulfilled. No further processing will be completed. All items in the order have been fulfilled or cancelled"},{name:"UNAUTHORIZED",code:"UNAUTHORIZED",description:"The submitted order failed authorization or conclusively failed a fraud check (no manual review necessary). The order will not be proecessed further."},{name:"CANCELLED",code:"CANCELLED",description:"All items in the order have been cancelled"},{name:"IN_REVIEW",code:"IN REVIEW",description:"If the order is educational, review may be necessary to confirm eligibility."},{name:"FAILED_REVIEW",code:"FAILED REVIEW",description:"The user's educational order was rejected."},{name:"REVIEW_EXPIRED",code:"REVIEW EXPIRED",description:"The user's educational status was not reviewed within the specified time (e.g. the user did not submit the necessary documentation), so the order was rejected."},{name:"IN_REVIEW_NOTIFIED",code:"IN REVIEW NOTIFIED",description:"The user's educational order has been held for review, and the user has been reminded to submit the necessary documentation."},{name:"HELD_OFFLINE_PAYMENT",code:"HELD OFFLINE PAYMENT",description:"The order was placed with a payment method that requires subsequent user action to complete. The order will be held until the payment is processed."},{name:"HELD_UNAUTHORIZED",code:"HELD UNAUTHORIZED",description:'The order is in a "held" state because it could not be processed due to service error, such as network connectivity with the credit card processor. The service will automatically attempt to resubmit the order.'},{name:"HELD_FOR_MANUAL_AUTH",code:"HELD FOR MANUAL AUTH",description:"The fraud check marked the order as requiring manual review."},{name:"REVIEW_ACCEPTED",code:"REVIEW ACCEPTED",description:"The user's educational eligibility has been confirmed. The order will then roll over into an OPEN state."},{name:"SUBMITTED",code:"SUBMITTED",description:"The user has committed to purchase the order. This is the state triggering the commerce engine to process the order."},{name:"IN_PROGRESS",code:"IN PROGRESS",description:"Order information is being updated by the user/client. Updates should be persisted, but the order is not ready to be submitted. This step is optional."},{name:"READY_FOR_VALIDATION",code:"READY FOR VALIDATION",description:"The order is complete from the client perspective and should be ready to submit. This state requests validation but not actually that the order be processed. If the order is valid, it will be updated in the database and returned as VALIDATED. This step is optional."},{name:"VALIDATED",code:"VALIDATED",description:"The order has been validated by the service and is ready to be submitted."},{name:"PAYPAL_INITIALIZE",code:"PAYPAL INITIALIZE",description:"The user has selected PayPal as the preferred payment instrument. The service will get a token from PayPal. If the service return a valid token, the order will be returned as VALIDATED; otherwise, the order will be returned as IN_PROGRESS."},{name:"NEW",code:"NEW",description:"The order exists in the database as a shell containing a list of products. This is first state of the order. User information not entered"},{name:"ITEM_CANCELLED",code:"CANCELLED",description:"The item has been cancelled"},{name:"ITEM_INVOICED",code:"INVOICED",description:"The full amount has been collected"},{name:"ITEM_FULFILLED",code:"FULFILLED",description:"The customer has received the goods/subscription"},{name:"ITEM_OPEN",code:"OPEN",description:"The item is awaiting invoicing / fulfillment"}],DELIVERY_STATUS_NOT_PROCESSED:"A",DELIVERY_STATUS_PARTIALLY_PROCESSED:"B",DELIVERY_STATUS_COMPLETELY_PROCESSED:"C",MESSAGE_ERROR_TYPE:"error",MESSAGE_INFO_TYPE:"info",MESSAGE_WARNING_TYPE:"warning",MESSAGE_SUCCESS_TYPE:"success",MESSAGE_ERROR_TYPE_CODE:"E",MESSAGE_INFO_TYPE_CODE:"I",MESSAGE_WARNING_TYPE_CODE:"W",MESSAGE_SUCCESS_TYPE_CODE:"S",ADDRESS_TYPE_SHIPPING:"Shipping",ADDRESS_TYPE_BILLING:"Billing",ORDER_ACTIONS_PROCESSED:"processed",STORE_COMMERCIAL_TYPE:"COM",STORE_EDUCATIONAL_TYPE:"EDU",TRANSACTION_ACTION_TYPE_CM:"cm",TRANSACTION_ACTION_TYPE_DM:"dm",SELF_CANCELLATION_CM_REASON_CODE:"SCC",SELF_CANCELLATION_DM_REASON_CODE:"SCD",TRANSACTION_STATUS_OPEN:"OPEN",TRANSACTION_STATUS_ACTIVE:"ACTIVE",TRANSACTION_STATUS_STOPPED:"STOPPED",TRANSACTION_STATUS_SUSPENDED:"SUSPENDED",TRANSACTION_STATUS_SUSPENDED30:"SUSPENDED30",TRANSACTION_STATUS_CLOSED:"CLOSED",TRANSACTION_STATUS_INACTIVE:"INACTIVE",TRANSACTION_STATUS_PROCESSING:"PROCESSING",TRANSACTION_STATUS_OPEN_CODE:"OPN",TRANSACTION_STATUS_ACTIVE_CODE:"ACT",TRANSACTION_STATUS_STOPPED_CODE:"STO",TRANSACTION_STATUS_SUSPENDED_CODE:"SUS",TRANSACTION_STATUS_SUSPENDED30_CODE:"S30",TRANSACTION_STATUS_CLOSED_CODE:"CLO",TRANSACTION_STATUS_INACTIVE_CODE:"INA",TRANSACTION_STATUS_PROCESSING_CODE:"PRO",EMAIL_TEMPLATE_CODE_ORDER:"ORDER_RECEIVED",EMAIL_TEMPLATE_DESC_ORDER:"Order Confirmation Email",EMAIL_TEMPLATE_CODE_ESD:"ESD",EMAIL_TEMPLATE_DESC_ESD:"ESD Fulfillment Email",SESI_ORDER_REASON_CODE_ADOBE_MANAGED:920,SESI_ORDER_REASON_CODE_VENDOR_MANAGED:921,ECOM_SKU_DETAILS_API_URL:"https://store1.adobe.com/svcs/sellableitems/",ECOM_SKU_DETAILS_API_URL_IN_STAGE:"https://store1.stage.adobe.com/svcs/sellableitems/",HENDRIX_PRODUCTION:"hendrixprod"});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("TransactionController",["$scope","$log","$rootScope","$location","$routeParams","TrackingService","TransactionConstants","PaymentConstants","AppConstants","AppUtils","TransactionUtil","Utils","OrderUtils","MetadataService","TransactionService","CustomerSubscriptionService","SubscriptionConstants","CustomerUtil","TeamConstants",function($scope,$log,$rootScope,$location,$routeParams,TrackingService,TransactionConstants,PaymentConstants,AppConstants,AppUtils,TransactionUtil,Utils,OrderUtils,MetadataService,TransactionService,CustomerSubscriptionService,SubscriptionConstants,CustomerUtil,TeamConstants){TrackingService.trackPageView("Transaction","Transaction View");$scope.headeredit=false;$scope.unidentifyshow=true;$scope.TransactionConstants=TransactionConstants;$scope.PaymentConstants=PaymentConstants;$scope.dbStatus=MetadataService.DB_STATUS.NEW;$scope.metadata=new Object();$scope.searchAgentFields=new Object();$scope.subscriptionId=$location.search().subscriptionId;$scope.guid=$location.search().guid;$scope.isTransactionBTWithPUF=false;$scope.isShowOtherInformationPod=false;if($location.path().toLowerCase().indexOf("/cm")==0){$scope.isCreditMemoFromDirectUrl=true;$scope.transactionNo=$location.search().transactionId;if(!$scope.transactionNo){$scope.transactionNo="";Utils.pageTitle("Transaction [ "+$scope.subscriptionId+" ]")}else{$scope.nTransactionNo=Number($location.search().transactionId);Utils.pageTitle("Transaction [ "+$scope.transactionNo+" ]")}}else{if($location.path().toLowerCase().indexOf("/dm")==0){$scope.isDebitMemoFromDirectUrl=true;$scope.transactionNo=$location.search().transactionId;if(!$scope.transactionNo){$scope.transactionNo="";Utils.pageTitle("Transaction [ "+$scope.subscriptionId+" ]")}else{$scope.nTransactionNo=Number($location.search().transactionId);Utils.pageTitle("Transaction [ "+$scope.transactionNo+" ]")}}else{$scope.transactionNo=$routeParams.transactionNo;$scope.nTransactionNo=Number($routeParams.transactionNo);$scope.subscriptionId="";Utils.pageTitle("Transaction [ "+$scope.transactionNo+" ]")}}$scope.isLoading=true;$scope.loadingCustomer=true;$scope.isTransactionViewValid=true;$scope.isPromoCcmTeamSku=false;var timer;$scope.headerCustomer=new Object();$scope.headerCustomer.isLoading=true;$scope.transactionLockMessage="";$scope.savedTransactionSuccess;$scope.transactionCustomerCountry;$scope.transactionProductTypes=[];$scope.modifiedBillingAddress;$scope.modifiedShippingAddress;$scope.showSubscriptionPod=false;$scope.showTeamSubscriptionPod=false;MetadataService.initializeTransactionMetadata($scope.metadata,function(dbStatus){$scope.dbStatus=dbStatus});$scope.setTemplate=function(transactionType,isEditableTemplate){$scope.templateUrl=TransactionUtil.getTemplate(transactionType,isEditableTemplate);$scope.templateType=TransactionUtil.getTemplateType(transactionType,isEditableTemplate);$scope.transactionView=TransactionUtil.getTransactionView(transactionType,isEditableTemplate)};$scope.initializeProductItems=function(){angular.forEach($scope.transaction.items,function(productItem){productItem.NotModify_quantity=productItem.quantity;productItem.NotModify_listPrice=productItem.listPrice;productItem.NotModify_promoPrice=productItem.promoPrice;if(productItem.rejectionCode&&productItem.rejectionCode!=""){productItem.rejectionCodeLabel=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.ORDER_CANCELLATION_REASON],productItem.rejectionCode,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)}productItem.NewProp_productImg=AppUtils.getProductThumbnailImage(productItem.productName);productItem.NewProp_productName=AppUtils.getProductName(productItem.productName);$scope.transactionProductTypes.push(productItem.productType);if(!$scope.isPromoCcmTeamSku){$scope.isPromoCcmTeamSku=productItem.promoSku}productItem.serialNumber="";if($scope.transaction.serialData){for(var i=0;i<$scope.transaction.serialData.length;i++){if(productItem.id==$scope.transaction.serialData[i].guid){productItem.serialNumber=productItem.serialNumber+"\n"+$scope.transaction.serialData[i].serialNumber}else{productItem.serialNumber=""}}}})};$scope.initializeTransactionScreen=function(){try{var isCmDMEnabled=false;var isSubscriptionTransaction=OrderUtils.isSubscriptionOrder($scope.transaction);angular.forEach($scope.transaction.items,function(productItem){if(productItem.deliveryStatus!=TransactionConstants.DELIVERY_STATUS_NOT_PROCESSED){isCmDMEnabled=true}});$scope.isTransactionBTWithPUF=TransactionUtil.isTransactionBtWithPuf($scope.transaction);if($scope.isCreditMemoFromDirectUrl&&isSubscriptionTransaction&&isCmDMEnabled){$scope.setTemplate(TransactionConstants.TRANSACTION_CREDIT_MEMO,true)}else{if($scope.isDebitMemoFromDirectUrl&&isSubscriptionTransaction&&isCmDMEnabled){$scope.setTemplate(TransactionConstants.TRANSACTION_DEBIT_MEMO,true)}else{$scope.isDebitMemoFromDirectUrl=$scope.isCreditMemoFromDirectUrl=false;$scope.setTemplate($scope.transaction.transactionType,false)}}$scope.initializeProductItems();$scope.transactionCustomerCountry=$scope.transaction.customer.address.country.code;if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_DYLAN_ORDER&&$scope.transaction.externalReferenceNo.startsWith("AD")){$scope.transaction.transactionTypeName="Commerce Order"}else{if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_DYLAN_ORDER&&($scope.transaction.externalReferenceNo.startsWith("HDD")||$scope.transaction.externalReferenceNo.startsWith("C"))){$scope.transaction.transactionTypeName="Hendrix Order"}else{$scope.transaction.transactionTypeName=TransactionUtil.getTransactionTypeName($scope.transaction.transactionType)}}$scope.transaction.reasonLabel=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ORDER_REASONS],$scope.transaction.reason.code,$scope.transaction.transactionType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.ORDER_TYPE,MetadataService.INDEX_NAMES.LABEL);$scope.transaction.billingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.transaction.billingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);$scope.transaction.billingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.transaction.billingAddress.country.code,$scope.transaction.billingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.transaction.payerAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.transaction.payerAddress.country.code,$scope.transaction.payerAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION);$scope.transaction.billingBlockReason=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.BILLING_BLOCKING_REASONS],$scope.transaction.billingBlock,MetadataService.INDEX_NAMES.REASON,MetadataService.INDEX_NAMES.TEXT);$scope.transaction.isBillingBlockOn=$scope.transaction.billingBlock!=""?true:false;$scope.transaction.deliveryBlockReason=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.DELIVERY_BLOCKING_REASONS],$scope.transaction.deliveryBlock,MetadataService.INDEX_NAMES.REASON,MetadataService.INDEX_NAMES.TEXT);$scope.transaction.deliveryBlockOn=$scope.transaction.deliveryBlock!=""?true:false;if($scope.transaction.shippingAddress){$scope.transaction.shippingAddress.country.name=MetadataService.find($scope.metadata[MetadataService.STORE_NAMES.COUNTRIES],$scope.transaction.shippingAddress.country.code,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.NAME);$scope.transaction.shippingAddress.stateName=MetadataService.findResult($scope.metadata[MetadataService.STORE_NAMES.ALL_STATES],$scope.transaction.shippingAddress.country.code,$scope.transaction.shippingAddress.state,MetadataService.INDEX_NAMES.COUNTRY_CODE,MetadataService.INDEX_NAMES.ID,MetadataService.INDEX_NAMES.DESCRIPTION)}}catch(error){console.log("Error in transaction data",error)}};$scope.$on(TransactionConstants.TRANSACTION_ORDER_VIEW_EVENT,function(event,transactionType){$scope.setTemplate(transactionType,false)});$scope.$on(TransactionConstants.TRANSACTION_EDIT_BILLING_EVENT,function(event,transactionType,lockResult){if(AppUtils.isHavingErrorMessage(lockResult)){$scope.transactionLockMessage=AppUtils.getErrorMessage(lockResult);$("#transactionLockModal").modal("show")}else{$scope.setTemplate(transactionType,true)}$scope.shippingModifyBtnShow=$scope.billingModifyBtnShow=true});$scope.$on(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,function(event,messages){$scope.messages=messages});$scope.$on(TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_EVENT,function(event){$scope.setTemplate(TransactionConstants.TRANSACTION_CREDIT_MEMO,true)});$scope.$on(TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_EVENT,function(event){$scope.setTemplate(TransactionConstants.TRANSACTION_DEBIT_MEMO,true)});$scope.$on(TransactionConstants.TRANSACTION_ORDER_RETURN_VIEW_EVENT,function(event){$scope.setTemplate(TransactionConstants.TRANSACTION_ORDER_RETURN,true)});$scope.$on(TransactionConstants.TRANSACTION_PROGRESS_EVENT,function(event,transactionProgressTitle,transactionProgressMessage,isTransactionComplete,showCloseButton){$scope.transactionProgressTitle=transactionProgressTitle;$scope.isTransactionMessageArray=Array.isArray(transactionProgressMessage);$scope.transactionProgressMessage=transactionProgressMessage;$scope.isTransactionComplete=isTransactionComplete;$scope.showProgressCloseButton=showCloseButton});$scope.$on(TransactionConstants.TRANSACTION_COMPLETE_EVENT,function(event,isTransactionComplete,successTransaction){$scope.isTransactionComplete=isTransactionComplete;$scope.savedTransactionSuccess=successTransaction});$scope.$on(TransactionConstants.TRANSACTION_PAYMENT_RESET_EVENT,function(event,messages){$scope.transactionView=TransactionConstants.TRANSACTION_RESET_PAYMENT_VIEW});$scope.$on(TransactionConstants.TRANSACTION_CANCEL_PAYMENT_UPDATE_EVENT,function(event,messages){$scope.transactionView=TransactionConstants.TRANSACTION_EDIT_BILLING_VIEW});$scope.$on(TransactionConstants.TRANSACTION_CANCEL_ADDRESS_UPDATE_EVENT,function(event,billingAddress,shippingAddress){if(billingAddress){$scope.modifiedBillingAddress=billingAddress}if(shippingAddress){$scope.modifiedShippingAddress=shippingAddress}});$scope.isJPOPOrderCancelled=false;$scope.$on(TransactionConstants.TRANSACTION_CANCEL_JPOP_ORDER_EVENT,function(event,isJPOPOrderCancelled){if(isJPOPOrderCancelled){$scope.isJPOPOrderCancelled=true}else{$scope.isJPOPOrderCancelled=false}});$scope.processTransactionDetails=function(){if($scope.dbStatus==MetadataService.DB_STATUS.SUCCESS){console.info("Transaction Metadata Initialized Successfully");clearInterval(timer);if($rootScope.returnUrl){$rootScope.returnUrl=null}$scope.initializeTransactionScreen()}};$scope.isTransactionValid=function(transactionType){return[TransactionConstants.TRANSACTION_STANDARD_ORDER,TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER,TransactionConstants.TRANSACTION_ORDER_RETURN,TransactionConstants.TRANSACTION_CCM_TEAM_ORDER,TransactionConstants.TRANSACTION_CREDIT_MEMO,TransactionConstants.TRANSACTION_DEBIT_MEMO,TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER,TransactionConstants.TRANSACTION_ADOBE_TRAINING_SERVICE_ORDER,TransactionConstants.TRANSACTION_QUOTATION,TransactionConstants.TRANSACTION_STANDARD_QUOTATION,TransactionConstants.TRANSACTION_DYLAN_ORDER].indexOf(transactionType)>-1};$scope.searchByTransactionId=function(transactionNo,guid,subscriptionId){TransactionService.getTransaction({guid:"",number:transactionNo,subscriptionId:subscriptionId}).success(function(result){$scope.isLoading=false;if(result){if(!$scope.isTransactionValid(result.transactionType)){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Transaction Is Not Valid");$scope.isLoading=false;$scope.isTransactionViewValid=false;return}$scope.transaction=result;$scope.originalTransaction=angular.copy($scope.transaction);if($scope.transaction.externalReferenceNo.startsWith("RMA")||$scope.transaction.externalReferenceNo.startsWith("DSC")){$scope.isShowOtherInformationPod=true}if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_CCM_TEAM_ORDER||$scope.transaction.transactionType==TransactionConstants.TRANSACTION_DYLAN_ORDER){for(var i=0;i<$scope.transaction.items.length;i++){if($scope.transaction.items[i].productType.indexOf(TransactionConstants.DSP_PRODUCT_TYPE)>-1||$scope.transaction.items[i].productType.indexOf(TransactionConstants.SSP_PRODUCT_TYPE)>-1){$scope.showSubscriptionPod=true}else{if($scope.transaction.items[i].productType.indexOf(TransactionConstants.CCM_TEAM_PRODUCT_TYPE)>-1||$scope.transaction.items[i].productType.indexOf(TransactionConstants.CCT_TEAM_PRODUCT_TYPE)>-1){$scope.showTeamSubscriptionPod=true}}if($scope.transaction.items[i].extendedPromoCode){$scope.transaction.items[i].promoData={};$scope.transaction.items[i].promoData.extendedPromoCode=$scope.transaction.items[i].extendedPromoCode;var extendedPromoDetail=$scope.transaction.items[i].promoData.extendedPromoCode.split(":");if(extendedPromoDetail[2].toString().substring(extendedPromoDetail[2].length-3,extendedPromoDetail[2].length)=="FMF"){$scope.transaction.items[i].promoData.termValue=1;$scope.transaction.items[i].promoData.termUnit="MONTHS"}else{if(extendedPromoDetail[2].toUpperCase()=="7DAYTRIAL"){$scope.transaction.items[i].promoData.termValue=1;$scope.transaction.items[i].promoData.termUnit="WEEKS";var currentDate=moment(new Date());var transactionCreationDate=moment(new Date($scope.transaction.creationDate));var promoEndDate=moment(transactionCreationDate,"DD-MM-YYYY").add(7,"days");var endDateDifference=currentDate.diff(promoEndDate,"minutes");if(endDateDifference<0){$scope.transaction.items[i].isPromoPeriod=true}else{$scope.transaction.items[i].isPromoPeriod=false}}}}}}else{$scope.showSubscriptionPod=false;$scope.showTeamSubscriptionPod=false}if($scope.transaction.customer!=null){$scope.subscriptionListRecords=[];var customerIdentificationGuid;if($scope.transaction.customer.customerIdentifications!=null){var customerIdentifications=$scope.transaction.customer.customerIdentifications;for(var i=0;i<customerIdentifications.length;i++){if(customerIdentifications[i].idType==AppConstants.CUSTOMER_WEB_GUID){customerIdentificationGuid=customerIdentifications[i].idNumber;if($scope.showSubscriptionPod){$scope.locale="";$scope.subscriptionAccountId=customerIdentificationGuid+"@AdobeID";CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:$scope.subscriptionAccountId,locale:$scope.locale}).success(function(result){console.log("Success CustomerSubscriptionService.getSubscriptions");for(var subscriptionObj in result){if(result[subscriptionObj].storeOrderNumber===$scope.transaction.externalReferenceNo){result[subscriptionObj].subscriptionAccountId=customerIdentificationGuid;if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAID)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_GRACE_PAST_DUE&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_INACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED}else{result[subscriptionObj].status=""}}}}}$scope.subscriptionListRecords.push(result[subscriptionObj])}}}).error(function(error){console.log("error",error)})}else{if($scope.showTeamSubscriptionPod){$scope.teamSubscriptionsLoading=true;$scope.teamSubscriptionProductList=[];$scope.customerGuid=$scope.transaction.customer.customerNo;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:"en_us"}).success(function(result,status,headers,config){$scope.teamSubscriptionProductList=CustomerUtil.getTeamSubscriptionList(result,$scope.customerGuid);$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})}}}}}if($scope.transaction.customer.customerIdentifications!=null&&$scope.transaction.customer.customerNo==null||typeof $scope.transaction.customer.customerNo=="undefined"){$scope.transaction.customer.customerNo=customerIdentificationGuid}var customerEmail=(angular.isDefined($scope.transaction.customer.address.email)&&$scope.transaction.customer.address.email!=null)?$scope.transaction.customer.address.email:$scope.transaction.customer.adobeId;AppUtils.loadCustomer($scope.transaction.customer.customerNo,customerEmail,$scope.headerCustomer)}$scope.fetchAgentDetails();if(result.messages){$scope.messages=AppUtils.getMultipleMessages(result.messages)}timer=setInterval(function(){$scope.processTransactionDetails()},500)}}).error(function(result){$scope.isLoading=$scope.isTransactionViewValid=false;$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Failed to load transaction details")})};$scope.loadDylanOnlyOrder=function(transactionNo){TransactionService.dylanOrderDetails(transactionNo).success(function(result){$scope.isLoading=false;if(result){if(!$scope.isTransactionValid(result.transactionType)){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Transaction Is Not Valid");$scope.isLoading=false;$scope.isTransactionViewValid=false;return}$scope.transaction=result;$scope.originalTransaction=angular.copy($scope.transaction);if($scope.transaction.transactionType==TransactionConstants.TRANSACTION_CCM_TEAM_ORDER||$scope.transaction.transactionType==TransactionConstants.TRANSACTION_DYLAN_ORDER){for(var i=0;i<$scope.transaction.items.length;i++){if($scope.transaction.items[i].productType.indexOf(TransactionConstants.DSP_PRODUCT_TYPE)>-1||$scope.transaction.items[i].productType.indexOf(TransactionConstants.SSP_PRODUCT_TYPE)>-1){$scope.showSubscriptionPod=true}else{if($scope.transaction.items[i].productType.indexOf(TransactionConstants.CCM_TEAM_PRODUCT_TYPE)>-1||$scope.transaction.items[i].productType.indexOf(TransactionConstants.CCT_TEAM_PRODUCT_TYPE)>-1){$scope.showTeamSubscriptionPod=true}}if($scope.transaction.items[i].extendedPromoCode){$scope.transaction.items[i].promoData={};$scope.transaction.items[i].promoData.extendedPromoCode=$scope.transaction.items[i].extendedPromoCode;$scope.transaction.items[i].promoData.termUnit=$scope.transaction.items[i].promoPeriod;$scope.transaction.items[i].promoData.termValue=$scope.transaction.items[i].promoPeriodLength;var extendedPromoDetail=$scope.transaction.items[i].promoData.extendedPromoCode.split(":");if(extendedPromoDetail[2].toUpperCase()=="7DAYTRIAL"){var currentDate=moment(new Date());var transactionCreationDate=moment(new Date($scope.transaction.creationDate));var promoEndDate=moment(transactionCreationDate,"DD-MM-YYYY").add(7,"days");var endDateDifference=currentDate.diff(promoEndDate,"minutes");if(endDateDifference<0){$scope.transaction.items[i].isPromoPeriod=true}else{$scope.transaction.items[i].isPromoPeriod=false}}}}}else{$scope.showSubscriptionPod=false;$scope.showTeamSubscriptionPod=false}if($scope.transaction.customer!=null){if($scope.transaction.customer.customerIdentifications!=null&&$scope.transaction.customer.customerNo==null||typeof $scope.transaction.customer.customerNo=="undefined"){for(var i=0;i<$scope.transaction.customer.customerIdentifications.length;i++){if($scope.transaction.customer.customerIdentifications[i].idType==AppConstants.CUSTOMER_WEB_GUID){$scope.transaction.customer.customerNo=$scope.transaction.customer.customerIdentifications[i].idNumber;if($scope.showSubscriptionPod){$scope.subscriptionListRecords=[];console.log("Query CustomerSubscriptionService.getSubscriptionLists",$scope.guid);$scope.subscriptionsLoading=true;$scope.locale="";$scope.subscriptionAccountId=$scope.transaction.customer.customerNo+"@AdobeID";CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:$scope.subscriptionAccountId,locale:$scope.locale}).success(function(result){$scope.subscriptionsLoading=false;console.log("Success CustomerSubscriptionService.getSubscriptions");for(var subscriptionObj in result){if(result[subscriptionObj].storeOrderNumber===$scope.transaction.externalReferenceNo){result[subscriptionObj].subscriptionAccountId=$scope.transaction.customer.customerNo;if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PENDING_PAYMENT||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAID)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_GRACE_PAST_DUE&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_SUSPENDED30}else{if((result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_PAST_DUE||result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLED)&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_INACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_CLOSED}else{if(result[subscriptionObj].paymentStatus.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_CANCELLING&&result[subscriptionObj].contract.status.toUpperCase()==SubscriptionConstants.SUBSCRIPTION_STATUS_ACTIVE){result[subscriptionObj].status=SubscriptionConstants.SUBSCRIPTION_STATUS_STOPPED}else{result[subscriptionObj].status=""}}}}}$scope.subscriptionListRecords.push(result[subscriptionObj])}}}).error(function(error){console.log("error",error);$scope.subscriptionsLoading=false})}else{if($scope.showTeamSubscriptionPod){$scope.teamSubscriptionsLoading=true;$scope.teamSubscriptionProductList=[];$scope.customerGuid=$scope.transaction.customer.customerNo;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:$scope.customerGuid,locale:"en_us"}).success(function(result,status,headers,config){$scope.teamSubscriptionProductList=CustomerUtil.getTeamSubscriptionList(result,$scope.customerGuid);$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(result,status,headers,config){$scope.teamSubscriptionsLoading=false;var messageObject=$scope.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="Transaction Details - Search Team Subscription List By Admin";AppUtils.sendLogToServer(messageObject,status,headers,config)})}}}}}var customerEmail=(angular.isDefined($scope.transaction.customer.address.email)&&$scope.transaction.customer.address.email!=null)?$scope.transaction.customer.address.email:$scope.transaction.customer.adobeId;AppUtils.loadCustomer($scope.transaction.customer.customerNo,customerEmail,$scope.headerCustomer)}$scope.fetchAgentDetails();if(result.messages){$scope.messages=AppUtils.getMultipleMessages(result.messages)}timer=setInterval(function(){$scope.processTransactionDetails()},500)}}).error(function(result){$scope.isLoading=false;$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Failed to load transaction details")})};$scope.isInCRM=false;if(typeof $scope.transactionNo!="undefined"||typeof $scope.subscriptionId!="undefined"){if(typeof $routeParams.commerce!=="undefined"&&$routeParams.commerce){$scope.isInCRM=true;$scope.isCommerceView=true;$scope.loadDylanOnlyOrder($scope.transactionNo)}else{if((isNaN($scope.nTransactionNo)||$scope.nTransactionNo==0)&&(typeof $scope.subscriptionId=="undefined"&&$scope.subscriptionId=="")){$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"The Transaction Number Is Not Valid");$scope.isLoading=false;$scope.isTransactionViewValid=false}else{$scope.searchByTransactionId($scope.transactionNo,$scope.guid,$scope.subscriptionId)}}}$scope.toggleClassName=function($event){var className=$($event.currentTarget).find("a").hasClass("collapsed")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").first().removeClass().addClass(className)};$scope.closeTransactionLockModal=function(){$("#transactionLockModal").modal("hide")};$scope.closeCancelOrderModal=function(){$("#cancelOrderModal").modal("hide")};$scope.closeTransactionProgressModal=function(){$("#transactionProgressModal").modal("hide");if($scope.isTransactionComplete){if($scope.transactionView==TransactionConstants.TRANSACTION_EDIT_BILLING_VIEW||$scope.isJPOPOrderCancelled){location.reload()}else{if($scope.transactionView==TransactionConstants.TRANSACTION_CREATE_CREDIT_MEMO_VIEW){$location.url("/transaction/"+$scope.savedTransactionSuccess.transactionNumber)}else{($scope.transactionView==TransactionConstants.TRANSACTION_CREATE_DEBIT_MEMO_VIEW)}}$location.url("/transaction/"+$scope.savedTransactionSuccess.transactionNumber)}$scope.setTemplate($scope.transaction.transactionType,false)};$scope.goToOrderView=function(){$scope.unlockTransaction();$("#cancelOrderModal").modal("hide");$scope.setTemplate($scope.transaction.transactionType,false);$scope.shippingModifyBtnShow=$scope.billingModifyBtnShow=false;if($scope.modifiedBillingAddress){$scope.transaction.billingAddress=$scope.modifiedBillingAddress}if($scope.modifiedShippingAddress){$scope.transaction.shippingAddress=$scope.modifiedShippingAddress}};$scope.unlockTransaction=function(){var requestTransactionDto=new Object();requestTransactionDto.customerNo=$scope.transaction.customer.customerNo;requestTransactionDto.transaction=$scope.transaction;TransactionService.unlockTransaction(requestTransactionDto)};$scope.fetchAgentDetails=function(){$scope.searchAgentFields.funnel=null;$scope.searchAgentFields.agent=new Object();$scope.searchAgentFields.agent.username=$scope.transaction.createdBy;TransactionService.getAgentDetails($scope.searchAgentFields).success(function(result){if(result!=null&&result.employees&&result.employees.length>0){$scope.agentDetails=result.employees[0].agent}}).error(function(result){$scope.agentDetails=null})};$scope.showModifyBilling=function(){alert("Modify Billing")};$scope.showModifyShipping=function(){alert("Modify Shipping")};$scope.showViewLoading=function(){$("#view-loading-modal").modal("show")};$scope.hideViewLoading=function(){$("#view-loading-modal").modal("hide")};$scope.updateLoadingMessage=function(message){$scope.loadingMessage=message+"..."};if(location.hash.contains("payment-request-id")){$scope.showActionsForFraudCheck=true}else{$scope.showActionsForFraudCheck=false}$scope.getPayments=function(seatDetails,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(seatDetails,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus};$scope.getMessageLoggingObject=function(sourceSystem,isSuccess,result){var messageObject=new Object();if(sourceSystem==AppConstants.SOURCE_SYSTEM_JIL){messageObject.Source_System=AppConstants.SOURCE_SYSTEM_JIL;messageObject.Customer_Guid=$scope.customerGuid}if(isSuccess){messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE}else{messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE}return messageObject}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTransactionDetails",["DocumentFlowService","TransactionService","MetadataService","$routeParams","TransactionConstants","webGuidFilterFilter","AppUtils","TransactionUtil","AppConstants",function(DocumentFlowService,TransactionService,MetadataService,$routeParams,TransactionConstants,webGuidFilterFilter,AppUtils,TransactionUtil,AppConstants){return{restrict:"EA",scope:{transaction:"=",metadata:"=",headercustomer:"=",isretriggerchkboxdisabled:"=",isexecuteactionshow:"="},replace:true,templateUrl:"js/transaction/common/partials/transaction-details.html",link:function(scope,element,attrs){scope.showTransactionHistoryBtn=false;scope.newUI=$routeParams.newui=="true"?true:false;scope.$watch("isretriggerchkboxdisabled",function(value){scope.isRetriggerChkBoxDisabled=value});scope.$watch("isexecuteactionshow",function(value){scope.isExecuteActionShow=value});scope.showTransactionDetailsModal=function(){element.find("#transactionDetailsModal").modal("show");scope.rescale();scope.fetchDocumentFlowDetails();scope.fetchBillingInformationDetails();scope.fetchOrderActionsDetails();scope.fetchInteractionHistory();scope.isExecuteActionDisabled=true;$(window).bind("resize",scope.rescale)};scope.closeTransactionHistoryModal=function(){scope.interactionHistory=[];$("body").css("overflow","auto");element.find("#transactionDetailsModal").modal("hide")};scope.rescale=function rescale(){var size={width:$(window).width(),height:$(window).height()};$("#transactionDetailsModal .modal-body").css({"max-height":"none","overflow-x":"hidden"})};scope.fetchDocumentFlowDetails=function(){scope.documentFlowItemDtoList=[];scope.documentTypesList=[];scope.itemsList=[];scope.isDocumentListLoading=true;DocumentFlowService.get({guid:scope.transaction.transactionGuid,transactionNo:scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find(scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL);if(documentFlowItem.docType.indexOf("Expert")>-1){documentFlowItem.docType="Expert Service Contract"}if(scope.documentTypesList.indexOf(documentFlowItem.docType)==-1){scope.documentTypesList.push(documentFlowItem.docType)}if(scope.itemsList.indexOf(documentFlowItem.ordItem)==-1&&documentFlowItem.ordItem!="0"){scope.itemsList.push(documentFlowItem.ordItem)}});scope.documentFlowItemDtoList=result;scope.isDocumentListLoading=false;scope.isTransactionBTWithPUF=TransactionUtil.isTransactionBtWithPuf(scope.transaction)}).error(function(result){scope.isDocumentListLoading=false})};scope.fetchBillingInformationDetails=function(){scope.isBillingInfoLoading=true;DocumentFlowService.getBillingPlan({guid:scope.transaction.transactionGuid,transactionNo:scope.transaction.transactionNumber}).success(function(result){angular.forEach(result,function(documentFlowItem){documentFlowItem.ccTypeName=MetadataService.find(scope.metadata[MetadataService.STORE_NAMES.CREDIT_CARD_TYPES],documentFlowItem.ccType,MetadataService.INDEX_NAMES.CODE,MetadataService.INDEX_NAMES.LABEL)});scope.billingPlanDtoList=result;scope.isBillingInfoLoading=false}).error(function(result){scope.isBillingInfoLoading=false})};scope.fetchOrderActionsDetails=function(){scope.transactionOrderActionsHistory=[];scope.isActionsLoading=true;if(scope.transaction.actions){if(scope.transaction.actions.length>0){scope.transactionOrderActionsHistory=scope.transaction.actions;scope.isActionsLoading=false}else{scope.isActionsLoading=false}}};scope.fetchInteractionHistory=function(){scope.interactionHistory=[];scope.isInteractionDetailsLoading=true;scope.showInteractionDetailsMessage=false;TransactionService.getTransactionHistory({transactionId:scope.transaction.transactionNumber}).success(function(result){console.log("TransactionService.getTransactionHistory  :: -->"+result);scope.interactionHistory=result;if(scope.interactionHistory==0){scope.interactionHistoryMessage="No records found";scope.showInteractionDetailsMessage=true;scope.isInteractionDetailsLoading=false}scope.isInteractionDetailsLoading=false}).error(function(result){scope.interactionHistoryMessage="There was some error while fetching the history. Please refresh..";scope.showInteractionDetailsMessage=true;scope.isInteractionDetailsLoading=false;console.log("TransactionService.getTransactionHistory  :: -->"+result)})};scope.toggleDocumentTabClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseDocumentItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseDocumentItems"+indexId).removeClass().addClass(accordionClassName)};scope.toggleBillingPlanView=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass().addClass(className);var accordionClassName=$("#collapseBillingInfo"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseBillingInfo"+indexId).removeClass().addClass(accordionClassName)};scope.toggleExpandCollapseAllForDocument=function(){var buttonClassName=$("#document-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#document-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#document-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionDocumentFlowView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#document-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionDocumentFlowView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};scope.toggleExpandCollapseAllForBilling=function(){var buttonClassName=$("#billing-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#billing-collapse-expand-all").find("i").removeClass().addClass(buttonClassName);var itemClassName=$("#billing-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionBillingPlanView").find("i").removeClass().addClass(itemClassName);var accordionClassName=$("#billing-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionBillingPlanView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};scope.refreshDocumentFlow=function(){scope.fetchDocumentFlowDetails()};scope.refreshBillingPlan=function(){scope.fetchBillingInformationDetails()};scope.refreshActionsDetails=function(){scope.fetchOrderActionsDetails()};scope.refreshHistoryDetails=function(){scope.fetchInteractionHistory()};scope.openDocumentFlowInvoice=function(documentFlowItemDto){var invoiceUrl="../invoicePreviewService/getInvoice.do?rengaGuid="+webGuidFilterFilter(scope.headercustomer.customer)+"&invoiceNo="+documentFlowItemDto.docNum;window.open(invoiceUrl,"Billing Document","width=1024, height=800, scrollbars=yes")};scope.enableActionExecution=function(){if($("#triggerPaymentFormChkboxPopUp").prop("checked")||$("#triggerPaymentFormEmailChkboxPopUp").prop("checked")){scope.triggerJapanesePaymentForm=$("#triggerPaymentFormChkboxPopUp").prop("checked");scope.triggerJapanesePaymentEmail=$("#triggerPaymentFormEmailChkboxPopUp").prop("checked");scope.isExecuteActionDisabled=false;return}scope.isExecuteActionDisabled=true};scope.executeAction=function(){var executeOrderTransaction=angular.copy(scope.transaction);executeOrderTransaction.triggerJapanesePaymentEmail=scope.triggerJapanesePaymentEmail;executeOrderTransaction.triggerJapanesePaymentForm=scope.triggerJapanesePaymentForm;$("#transactionProgressModal").modal("show");scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execute Actions","Execute Action Is In Progress",false,false);TransactionService.update(executeOrderTransaction).success(function(result){if(AppUtils.isHavingErrorMessage(result.messages)){scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Execution Failed",result.messages,true,true);scope.transaction=angular.copy(scope.originalTransaction)}else{scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed",result.messages,true,true);scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,result)}}).error(function(result){scope.$emit(TransactionConstants.TRANSACTION_UPDATE_MESSAGE_EVENT,AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Execute Action Failed, Try Again..."));$("#transactionProgressModal").modal("hide");scope.transaction=angular.copy($scope.originalTransaction)})};scope.createDocumentFlowItemWrapper=function(invoiceNum){return jQuery.extend({},{invoice:invoiceNum,documentFlowItemDtos:[]})};scope.createDocumentFlowItem=function(documentFlowItemDto){return jQuery.extend({},{cc4Digits:documentFlowItemDto.cc4Digits,ccType:documentFlowItemDto.ccType,currency:documentFlowItemDto.currency,description:documentFlowItemDto.description,docDate:documentFlowItemDto.docDate,docNum:documentFlowItemDto.docNum,docPosNo:documentFlowItemDto.docPosNo,docType:documentFlowItemDto.docType,ordItem:documentFlowItemDto.ordItem,orderNo:documentFlowItemDto.orderNo,product:documentFlowItemDto.product,quantity:documentFlowItemDto.quantity,quantityUnit:documentFlowItemDto.quantityUnit,value:documentFlowItemDto.value})};scope.retriggerEmail=function(documentFlowItemDto){var documentFlowItem=scope.createDocumentFlowItem(documentFlowItemDto);var documentFlowWrapper=scope.createDocumentFlowItemWrapper(documentFlowItemDto.docNum);documentFlowWrapper.documentFlowItemDtos.push(documentFlowItem);$("#transactionProgressModal").modal("show");scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Pay Online Email Action","'How to pay online' email send Is In Progress",false,false);DocumentFlowService.retriggerEmail(documentFlowWrapper).success(function(result){scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Executed","'How to pay online' email has been sent.",true,true);scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,scope.transaction)}).error(function(result){scope.$emit(TransactionConstants.TRANSACTION_PROGRESS_EVENT,"Action Failed","'How to pay online' email has not been sent.",true,true);scope.$emit(TransactionConstants.TRANSACTION_COMPLETE_EVENT,true,scope.transaction)})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngOrderItem",["$rootScope","TransactionConstants","SubscriptionConstants",function($rootScope,TransactionConstants,SubscriptionConstants){return{restrict:"EA",scope:{transaction:"=",isCcmTeam:"=",isSubscriptionOrder:"=",taxNumber:"="},replace:true,templateUrl:"js/transaction/common/partials/order-items.html",link:function(scope,element,attrs){scope.TransactionConstants=TransactionConstants}}}]);app.directive("ngTransactionMessages",["$location","TransactionConstants",function(location,TransactionConstants){return{restrict:"EA",scope:{source:"="},replace:true,templateUrl:"js/transaction/common/partials/transaction-messages.html",link:function($scope,element,attrs){$scope.TransactionConstants=TransactionConstants}}}]);app.directive("ngTransactionResultMessages",["$location","$rootScope",function(location,rootScope){return{restrict:"EA",scope:{source:"="},replace:true,templateUrl:"js/transaction/common/partials/transaction-result-messages.html",link:function($scope,element,attrs){}}}]);app.directive("ngTransactionResultAllMessages",["$location","$rootScope",function(location,rootScope){return{restrict:"EA",scope:{source:"="},replace:true,templateUrl:"js/transaction/common/partials/transaction-result-all-messages.html",link:function($scope,element,attrs){}}}]);app.directive("ngTransactionStatusLabel",["$location","TransactionConstants",function(location,TransactionConstants){return{restrict:"EA",replace:true,templateUrl:"js/transaction/common/partials/transaction-status-labels.html",scope:{transactionStatusLabelValue:"="},link:function($scope,element,attrs){$scope.TransactionConstants=TransactionConstants}}}]);app.directive("ngCommerceStatus",["$location","TransactionConstants",function(location,TransactionConstants){return{restrict:"EA",replace:true,templateUrl:"js/transaction/common/partials/commerce-status-labels.html",link:function($scope,element,attrs){$scope.TransactionConstants=TransactionConstants}}}]);app.directive("ngPaymentHistory",["$rootScope","$location","TransactionService","TransactionConstants",function($rootScope,location,TransactionService,TransactionConstants){return{restrict:"EA",replace:true,templateUrl:"js/transaction/common/partials/payment-history.html",scope:{paymentHistoryListItem:"=",filterPayment:"=",showTransmitStatusRow:"=",setActionsForPaymentId:"="},link:function($scope,element,attrs){$scope.confirmBlockPayment=function(){$scope.confirmPaymentBlock=true};$scope.confirmManualSettlePayment=function(){$scope.confirmPaymentSettle=true};$scope.confirmResetCounterPayment=function(){$scope.confirmPaymentResetCounter=true};$scope.closePendingPaymentConfirmation=function(){$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false};$scope.blockPayment=function(paymentRequestId){TransactionService.blockPaymentService(paymentRequestId).success(function(result){$scope.setActionsForPaymentId="";$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_SUCCESS,"Successfully blocked the payment.")}).error(function(result){$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_ERROR,result,"Attempt to block the payment failed. Please verify & retry.")})};$scope.settleManually=function(paymentRequestId){TransactionService.settleManuallyService(paymentRequestId).success(function(result){$scope.setActionsForPaymentId="";$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_SUCCESS,'Successfully flagged the payment as "Manually Settled".')}).error(function(result){$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_ERROR,result,'Attempt to mark the payment as "Manually Settled" failed. Please verify & retry.')})};$scope.resetCounter=function(paymentRequestId){$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;TransactionService.resetCounterService(paymentRequestId).success(function(result){$scope.setActionsForPaymentId="";$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_SUCCESS,"Successfully reset the payment counter.")}).error(function(result){$scope.confirmPaymentBlock=false;$scope.confirmPaymentSettle=false;$scope.confirmPaymentResetCounter=false;$rootScope.$broadcast(TransactionConstants.PAYMENT_REQUEST_ERROR,result,"Attempt to reset the payment counter failed. Please verify & retry.")})}}}}]);app.directive("popover",["TransactionConstants","SubscriptionConstants",function(TransactionConstants,SubscriptionConstants){return function(scope,elem){elem.popover()}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TransactionDto",{billingAddress:new Object(),billingBlock:"",bpType:"",campaignDescription:"",campaignTitle:"",cancelCodeReason:"",closed:false,contact:"",contactFullName:"",createdBy:"",creationDate:new Date(),currencyCode:"",customer:new Object(),deliveryBlock:"",deliveryIndication:"",deliveryMethod:"",deliveryMethodCode:"",description:"",discounts:0,endDate:new Date(),esdOrderLock:"",externalReferenceNo:"",freeOfCharge:"",items:[],lastModifiedDate:new Date(),locked:false,netValue:"",ocard:0,originalOrderPriceDto:new Object(),payerAddress:new Object(),paymentDetails:new Object(),paymentReferenceNo:"",paymentRetriggerAllowed:false,promoCode:"",pufProratedPrice:0,quantity:0,quoteExpired:false,reason:new Object(),recreate:false,referenceTransactionGuid:"",referenceTransactionNumber:"",returnInProgress:false,returnReasonCode:"",searchableContent:"",shipping:0,shippingAddress:new Object(),startDate:new Date(),status:"",subtotal:0,tax:0,taxNumber:"",teamName:"",termsAndConditionAccepted:false,termsAndConditionsList:[],totalValue:0,transType:"",transactionGuid:"",transactionNumber:"",transactionType:"ZCSB",transactionTypeChanged:false});var app=app||angular.module("hxApp",["ngRoute"]);app.value("TransactionDto",{number:"",text:"",type:""});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TransactionItemBuilder",["$rootScope","StoreConstants",function($rootScope,StoreConstants){this.create=function(transactionType,editMode){for(var count=0;count<TransactionConstants.TEMPLATES.length;count++){if(TransactionConstants.TEMPLATES[count].item.indexOf(transactionType)>=0&&TransactionConstants.TEMPLATES[count].edit==editMode){return TransactionConstants.TEMPLATES[count].url}}return""}}]);var app=app||angular.module("hxApp",["ngRoute"]);app.value("TransactionItemDto",{billingBlock:"",billingBlockReason:"",campaignDescription:"",campaignTitle:"",currencyCode:"",currencySymbol:"",deleteFlag:false,deliveryStatus:"",deliveryStatusLabel:"",discount:0,endDate:new Date(),fulfillmentMethodTypeLabel:"",id:"",ispuf:"",language:"",listPrice:0,platform:"",productDescriptionName:"",productDescriptionVisible:false,productName:"",productType:"",promoCode:"",promoPrice:0,promoSku:false,quantity:0,quantityToReturn:0,referenceItemGuid:"",rejectionCode:"",returnable:false,serviceCommitment:"",sku:"",startDate:new Date(),status:"",termsAndConditionAccepted:false,toReturn:false,trackingDetails:[],vatPrice:0,version:""});var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TransactionService",["$http",function($http){var service={};service.fill=function(data){return $http({method:"POST",url:"../transactionService/fill.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTransaction=function(data){return $http({method:"POST",url:"../transactionService/getTransaction.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.lockTransaction=function(data){return $http({method:"POST",url:"../transactionService/lockTransaction.do",transformRequest:transform,data:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.update=function(data){return $http({method:"POST",url:"../transactionService/update.do",data:data})};service.review=function(data){return $http({method:"POST",url:"../transactionService/review.do",data:data})};service.create=function(data){return $http({method:"POST",url:"../transactionService/create.do",data:data})};service.reviewForRecreate=function(data){return $http({method:"POST",url:"../transactionService/reviewForRecreate.do",data:data})};service.priceLockForTransaction=function(data){return $http({method:"POST",url:"../transactionService/priceLockForTransaction.do",data:data})};service.cancelReturn=function(data){return $http({method:"POST",url:"../transactionService/cancelReturn.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.sendEmailConfirmation=function(data){return $http({method:"POST",url:"../transactionService/sendEmailConfirmation.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.cancelNonSubscriptionOrder=function(data){return $http({method:"POST",url:"../transactionService/cancelTransactionStatus.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.unlockTransaction=function(data){return $http({method:"POST",url:"../transactionService/rollbackTransaction.do",data:data})};service.getAgentDetails=function(data){return $http({method:"POST",url:"../tsCaseEmployeeService/getEmployees.do",data:data})};service.getTnC=function(data){return $http({method:"POST",url:"../transactionService/getTermsAndConditionsBySku.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,transformResponse:function(data,headers){return data},responseType:"text",data:data})};service.cancelStoreOrder=function(data){return $http({method:"POST",url:"../transactionService/cancelStoreOrder.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,transformResponse:function(data,headers){return data},responseType:"text",data:data})};service.refreshTransaction=function(data){return $http({method:"POST",url:"../transactionService/refreshTransaction.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.approveEduOrder=function(data){return $http({method:"POST",url:"../transactionService/approveEduOrder.do?orderExtRefNo="+data})};service.rejectEduOrder=function(data){return $http({method:"POST",url:"../transactionService/rejectEduOrder.do?orderExtRefNo="+data})};service.dylanOrderDetails=function(data){return $http({method:"GET",url:"../transactionService/getOrderDetails.do?orderNumber="+data})};service.getTransactionHistory=function(data){return $http({method:"POST",url:"../transactionService/getTransactionHistory.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.resendStoreEmail=function(data){return $http({method:"POST",url:"../transactionService/resendEmail.do",headers:{"Content-Type":"application/json"},data:data})};service.resendOrderToCRM=function(data){return $http({method:"POST",url:"../transactionService/resendOrderToCRM.do?orderExtRefNo="+data.orderExtRefNo})};service.getPaymentList=function(data){return $http({method:"GET",url:"../transactionService/getPaymentList.do?orderExtRefNo="+data})};service.dmOrderApprove=function(data){return $http({method:"POST",url:"../transactionService/approveDMOrder.do?orderExtRefNo="+data})};service.dmOrderReject=function(data){return $http({method:"POST",url:"../transactionService/rejectDMOrder.do?orderExtRefNo="+data})};service.getEcommOrderDetails=function(data){return $http({method:"GET",url:"../transactionService/getEcommOrderDetails.do?orderNumber="+data.orderExtRefNo})};service.editAddress=function(data){return $http({method:"POST",url:"../transactionService/editAddress.do?orderId="+data.orderId,headers:{"Content-Type":"application/json"},data:data})};service.blockPaymentService=function(data){return $http({method:"POST",url:"../transactionService/blockPayment.do?paymentId="+data,headers:{"Content-Type":"application/json"},data:data})};service.settleManuallyService=function(data){return $http({method:"POST",url:"../transactionService/settleManually.do?paymentId="+data,headers:{"Content-Type":"application/json"},data:data})};service.resetCounterService=function(data){return $http({method:"POST",url:"../transactionService/resetRetryCounter.do?paymentId="+data,headers:{"Content-Type":"application/json"},data:data})};return service}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TransactionUtil",["$rootScope","TransactionConstants","PaymentConstants",function($rootScope,TransactionConstants,PaymentConstants){this.getTemplate=function(transactionType,editMode){for(var count=0;count<TransactionConstants.TEMPLATES.length;count++){if(TransactionConstants.TEMPLATES[count].item.indexOf(transactionType)>=0&&TransactionConstants.TEMPLATES[count].edit==editMode){return TransactionConstants.TEMPLATES[count].url}}return""};this.getTemplateType=function(transactionType,editMode){for(var count=0;count<TransactionConstants.TEMPLATES.length;count++){if(TransactionConstants.TEMPLATES[count].item.indexOf(transactionType)>=0&&TransactionConstants.TEMPLATES[count].edit==editMode){return TransactionConstants.TEMPLATES[count].type}}return""};this.getTransactionTypeName=function(transactionType){switch(angular.uppercase(transactionType)){case TransactionConstants.TRANSACTION_CREDIT_MEMO:return"Credit Memo";break;case TransactionConstants.TRANSACTION_DEBIT_MEMO:return"Debit Memo";break;case TransactionConstants.TRANSACTION_ORDER_RETURN:return"Order Return";break;case TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER:return"FOC";break;case TransactionConstants.TRANSACTION_ADOBE_TRAINING_SERVICE_ORDER:return"ATS";break}};this.getStatusLabel=function(status){switch(angular.uppercase(status)){case TransactionConstants.TRANSACTION_STATUS_CREATED:return"CREATED";break;case TransactionConstants.TRANSACTION_STATUS_IN_PROCESS:return"IN PROCESS";break;case TransactionConstants.TRANSACTION_STATUS_FOR_RELEASE:return"FOR RELEASE";break;case TransactionConstants.TRANSACTION_STATUS_RELEASED:return"RELEASED";break;case TransactionConstants.TRANSACTION_STATUS_COMPLETED:return"COMPLETED";break;case TransactionConstants.TRANSACTION_STATUS_DO_NOT_PRINT:return"DO NOT PRINT";break;case TransactionConstants.TRANSACTION_STATUS_OPEN:return"OPEN";break;case TransactionConstants.TRANSACTION_STATUS_PAYMENT_PENDING:return"PENDING";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_IN_REVIEW:return"IN REVIEW";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_REVIEW_ACCEPTED:return"REVIEW ACCEPTED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_FULLFILLED:return"FULFILLED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_FAILED_REVIEW:return"FAILED REVIEW";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_UNAUTHORIZED:return"UNAUTHORIZED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_CANCELLED:return"CANCELLED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_REVIEW_EXPIRED:return"REVIEW EXPIRED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_IN_REVIEW_NOTIFIED:return"IN REVIEW NOTIFIED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_HELD_OFFLINE_PAYMENT:return"HELD OFFLINE PAYMENT";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_HELD_UNAUTHORIZED:return"HELD UNAUTHORIZED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_HELD_FOR_MANUAL_AUTH:return"HELD FOR MANUAL AUTH";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_SUBMITTED:return"SUBMITTED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_READY_FOR_VALIDATION:return"READY FOR VALIDATION";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_VALIDATED:return"VALIDATED";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_PAYPAL_INITIALIZE:return"PAYPAL INITIALIZE";break;case TransactionConstants.TRANSACTION_STATUS_ECOM_NEW:return"NEW";break}};this.getTransactionView=function(transactionType,editMode){for(var count=0;count<TransactionConstants.TEMPLATES.length;count++){if(TransactionConstants.TEMPLATES[count].item.indexOf(transactionType)>=0&&TransactionConstants.TEMPLATES[count].edit==editMode){return TransactionConstants.TEMPLATES[count].viewName}}return""};this.getTransactionTypeName=function(transactionType){var transactionTypeName="";switch(transactionType){case TransactionConstants.TRANSACTION_STANDARD_ORDER:transactionTypeName="Non Subscription Order";break;case TransactionConstants.TRANSACTION_NEW_STANDARD_ORDER:transactionTypeName="Subscription Order";break;case TransactionConstants.TRANSACTION_CREDIT_MEMO:transactionTypeName="Credit Memo";break;case TransactionConstants.TRANSACTION_DEBIT_MEMO:transactionTypeName="Debit Memo";break;case TransactionConstants.TRANSACTION_FREE_OF_CHARGE_ORDER:transactionTypeName="FOC Order";break;case TransactionConstants.TRANSACTION_ADOBE_TRAINING_SERVICE_ORDER:transactionTypeName="ATS Order";break;case TransactionConstants.TRANSACTION_ORDER_RETURN:transactionTypeName="Order Return";break;case TransactionConstants.TRANSACTION_QUOTATION:transactionTypeName="Quote";break;case TransactionConstants.TRANSACTION_STANDARD_QUOTATION:transactionTypeName="Quote";break;case TransactionConstants.TRANSACTION_DYLAN_ORDER:transactionTypeName="Commerce Order";break}return transactionTypeName};this.isTransactionBtWithPuf=function(orderTransaction){var result=false,isPufItem=false;angular.forEach(orderTransaction.items,function(productItem){if(productItem.ispuf=="true"){isPufItem=true}});if(isPufItem&&this.isCcmTeam(orderTransaction.items)&&orderTransaction.paymentDetails&&orderTransaction.paymentDetails.paymentType==PaymentConstants.BANK_TRANSFER_PAYMENT_TYPE){result=true}return result};this.isCcmTeam=function(cartItems){if(cartItems){for(var cartCount=0;cartCount<cartItems.length;cartCount++){if(angular.uppercase(cartItems[cartCount].productType)==TransactionConstants.CCM_TEAM_PRODUCT_TYPE||angular.uppercase(cartItems[cartCount].productName)==TransactionConstants.CCM_TEAM_PRODUCT_NAME){return true}}return false}return false}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("TsCaseService",function($http){var service={};service.getCSItem=function(data){return $http({method:"POST",url:"../tsCaseService/getCs.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getTSItem=function(data){return $http({method:"POST",url:"../tsCaseService/get.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getDefaultTsCase=function(data){return $http({method:"POST",url:"../tsCaseService/getDefaultTsCase.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.lock=function(data){return $http({method:"POST",url:"../tsCaseService/lock.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.unlock=function(data){return $http({method:"POST",url:"../tsCaseService/unlock.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.getCSCaseFromTemplate=function(data){return $http({method:"POST",url:"../caseTemplateService/createCaseFromTemplate.do",data:data})};service.getDefaultCaseTemplate=function(){return $http({method:"POST",url:"../caseTemplateService/getCaseTemplateDto.do"})};service.save=function(data){data.messages=[];if(data.activityType&&data.activityType.id==""){data.activityType=null}return $http({method:"POST",url:"../tsCaseService/save.do",data:data})};service.getFunnels=function(){return $http({method:"GET",url:"../tsCaseEmployeeService/getFunnels.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};service.getEmployees=function(data){return $http({method:"POST",url:"../tsCaseEmployeeService/getEmployees.do",data:data})};service.getAttachmentList=function(data){return $http({method:"POST",url:"../tsCaseService/getAttachmentList.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};return service});var app=app||angular.module("hxApp.directive",[]);app.directive("ngTsCasesListProductsCrm",["Utils","$rootScope","$routeParams","$location","AppConstants","AppUtils","$timeout","TsCaseService",function(Utils,$rootScope,$routeParams,$location,AppConstants,AppUtils,$timeout,TsCaseService){return{restrict:"EA",scope:{records:"=",perpetualRecords:"=",enterpriseRecords:"=",allRecords:"=",customerNo:"=customerno",customerdetail:"=customerdetail",contactNo:"=contactno",refresh:"&",loading:"=",customer:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/ts-cases-list-products-crm.html",link:function(scope,element,attrs){scope.AppConstants=AppConstants;scope.VIEW_TYPE_PERPETUAL="PERPETUAL";scope.VIEW_TYPE_ENTERPRISE="ENTERPRISE";scope.viewType=scope.VIEW_TYPE_PERPETUAL;var defaultCustomer=function(){return jQuery.extend({},{firstName:"",lastName:"",outputLanguage:""})};scope.$watch("perpetualRecords",function(value){if(scope.viewType==scope.VIEW_TYPE_PERPETUAL&&value){scope.records=value}});scope.$watch("enterpriseRecords",function(value){if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE&&value){scope.records=value}});scope.filterProductName=function(recordItem){var productName="";if(angular.uppercase(recordItem.name)!="CCLE"&&(angular.uppercase(recordItem.regInd)=="C")){productName=recordItem.metaName+" (CCTeam)"}else{if((angular.uppercase(recordItem.name)=="CCSV"||angular.uppercase(recordItem.name)=="APAP")&&(angular.uppercase(recordItem.regType)=="N")){scope.orgNameRecordStyle={width:"240px"};productName=recordItem.offeringCode+" | "+recordItem.cceDesc}else{productName=recordItem.metaName}}return productName};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.isEnterpriseID=function(){return(scope.customer&&scope.customer.enterpriseId)};scope.isCustomerRecord=function(){return(scope.customer&&scope.customer.bpType!=2)};scope.toggleClassName=function($event,indexId){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseProductItems"+indexId).removeClass().addClass(accordionClassName)};scope.toggleExpandCollapseAll=function(){var buttonClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#product-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#product-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)};scope.selectExistingProductHandler=function(rec){if(rec){rec.viewType=scope.viewType;if(scope.viewType==scope.VIEW_TYPE_ENTERPRISE){scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,rec)}else{scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,rec)}}};scope.fetchProductDetailsFromProductSkuAndTemplate=function(productSku,storeId){console.log("tempID:: "+scope.tempid);scope.defaultCaseTemplateSearchDto={};scope.selectTemplateDependingOnCaseType();scope.defaultCaseTemplateSearchDto.templateId=scope.tempid;scope.defaultCaseTemplateSearchDto.productSku=productSku;scope.defaultCaseTemplateSearchDto.storeId=storeId;scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();scope.defaultCaseTemplateSearchDto.customerDto.customerNo=scope.customer.customerNo;scope.defaultCaseTemplateSearchDto.customerDto.firstName=scope.customer.firstName;scope.defaultCaseTemplateSearchDto.customerDto.lastName=scope.customer.lastName;scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=scope.customer.outputLanguage;scope.defaultCaseTemplateSearchDto.customerDto.address=scope.customer.address;scope.defaultCaseTemplateSearchDto.contactId=scope.contactid;TsCaseService.getCSCaseFromTemplate(scope.defaultCaseTemplateSearchDto).success(function(result){result.viewType=scope.viewType;result.product.product.sku=productSku;scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,result);scope.isFetchingProductDetailsFromRecord=false}).error(function(error){console.log("TsCaseService.getCSCaseFromTemplate: "+error)})};scope.selectTemplateDependingOnCaseType=function(){if(!scope.tempid){if(scope.casetype=="csCase"){scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE}else{scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE}}};scope.triggerBtnName="";scope.isBtnTriggered=false;scope.triggerClickInBtnGrp=function(triggerBtnName){if(triggerBtnName&&!angular.element(triggerBtnName).hasClass("active")){scope.isBtnTriggered=true;$("#perpetualProductsListBtn").removeClass("active");$("#enterpriseProductsListBtn").removeClass("active");$timeout(function(){$(triggerBtnName).trigger("click");scope.isBtnTriggered=false},0)}};$rootScope.$on(AppConstants.UPDATE_CLOSE_POPUP_EVENT,function(event){scope.isBtnTriggered=false});scope.switchViewInProducts=function(type){if(!scope.isBtnTriggered){if(type==scope.VIEW_TYPE_PERPETUAL){scope.records=scope.perpetualRecords;scope.viewType=scope.VIEW_TYPE_PERPETUAL;if(!scope.perpetualRecords){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#perpetualProductsListBtn")}else{if(type==scope.VIEW_TYPE_ENTERPRISE){scope.records=scope.enterpriseRecords;scope.viewType=scope.VIEW_TYPE_ENTERPRISE;if(!scope.enterpriseRecords){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#enterpriseProductsListBtn")}}}};scope.refreshPerpetualList=function(){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshEnterpriseList=function(){scope.$emit(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,scope.viewType)};$rootScope.$on(AppConstants.UPDATE_TS_PRODUCT_VIEW_CONTEXT_EVENT,function(event,viewType){scope.viewType=viewType;if(scope.viewType==AppConstants.PRODUCT_TYPE_IBASE){scope.viewType=scope.VIEW_TYPE_PERPETUAL}else{if(scope.viewType==AppConstants.PRODUCT_TYPE_ENT){scope.viewType=scope.VIEW_TYPE_ENTERPRISE}}scope.switchViewInProducts(scope.viewType)})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTsCasesListSubscriptions",["Utils","$rootScope","$location","$routeParams","AppConstants","AppUtils","$timeout","SubscriptionService","TsCaseService","TeamConstants",function(Utils,$rootScope,$location,$routeParams,AppConstants,AppUtils,$timeout,SubscriptionService,TsCaseService,TeamConstants){return{restrict:"EA",scope:{records:"=",trialRecords:"=",trialLoading:"=",teamRecords:"=",customerNo:"=customerno",contactNo:"=contactno",refresh:"&",loading:"=",teamLoading:"=",jilTeamLoading:"=",jilTeamRecords:"=",subTab:"=",customer:"=",casetype:"=",contactid:"=",tempid:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/ts-cases-list-subscriptions.html",link:function(scope,element,attrs){scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;scope.isBtnClicked=false;var defaultCustomer=function(){return jQuery.extend({},{firstName:"",lastName:"",outputLanguage:""})};var defaultProductDto=function(){return jQuery.extend({},{allowedOnlyWithCcmt:false,cceDesc:null,classification:null,commitTerm:null,componentId:null,config:null,description:null,educational:false,excludeFromHendrix:false,isSelected:null,language:null,marketSegment:null,mediaType:"",metaConfig:"",metaLanguage:"",metaName:"",metaPlatform:"",metaType:"",name:"",offeringCode:"",ownerId:"",platform:"",price:null,prodType:"",productCode:"",promoSku:false,puf:false,recordNumber:"",regInd:"",regType:"",registrationDate:"",searchableContent:"",serialNumber:"",sku:"",status:"",stock:false,teamId:null,teamName:null,teamRole:null,uniqueId:null,version:null})};scope.encodeUriQuery=function(val){return encodeURIComponent(val)};scope.formatDate=function(date){return new Date(date)};scope.showProductDetail=function(productData){scope.$parent.selectedProductData=productData;$rootScope.$broadcast("showProductDetailEvent",productData)};scope.toggleClassNameForSubscription=function($event,indexId){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseSubscriptionItems"+indexId).hasClass("collapse in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseSubscriptionItems"+indexId).removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_TEAM){var className=$($event.currentTarget).find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus pull-right":"glyphicon glyphicon-plus pull-right";$($event.currentTarget).find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(className);var accordionClassName=$("#collapseTeamProductItems"+indexId).hasClass("in")?"panel-collapse collapse":"panel-collapse collapse in";$("#collapseTeamProductItems"+indexId).removeClass().addClass(accordionClassName)}}};scope.toggleExpandCollapseAll=function(){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){var buttonClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionSubscriptionsView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionSubscriptionsView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){var buttonClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#jil-team-subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-chevron-right":"glyphicon glyphicon-chevron-down";$("#accordionJilTeamProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#jil-team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionJilTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}else{var buttonClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-minus":"glyphicon glyphicon-plus";$("#team-subscription-collapse-expand-all").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(buttonClassName);var itemClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"glyphicon glyphicon-plus pull-right":"glyphicon glyphicon-minus pull-right";$("#accordionTeamProductView").find("i").removeClass("glyphicon-plus glyphicon-minus").addClass(itemClassName);var accordionClassName=$("#team-subscription-collapse-expand-all").find("i").hasClass("glyphicon-plus")?"panel-collapse collapse":"panel-collapse collapse in";$("#accordionTeamProductView").find("div.panel-collapse").removeClass().addClass(accordionClassName)}}};scope.isFetchingProductDetailsFromRecord=false;scope.fetchProductSkuDataFromSubscriptionId=function(rec){SubscriptionService.getSubscriptionDetails({subscriptionId:rec.id,subscriptionAccountId:rec.customerGuid,locale:""}).success(function(result){if(result.sellableItemSku){scope.productSku=result.sellableItemSku;scope.storeId="";scope.fetchProductDetailsFromProductSkuAndTemplate(scope.productSku,scope.storeId)}}).error(function(error){console.log("fetchProductSkuDataFromSubscriptionId ::"+error)})};scope.selectTemplateDependingOnCaseType=function(){if(!scope.tempid){if(scope.casetype=="csCase"){scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_CS_CASE}else{scope.tempid=AppConstants.TEMPLATE_DEFAULT_SUBSCRIPTION_TS_CASE}}};scope.fetchProductDetailsFromProductSkuAndTemplate=function(productSku,storeId){console.log("tempID:: "+scope.tempid);scope.defaultCaseTemplateSearchDto={};scope.selectTemplateDependingOnCaseType();scope.defaultCaseTemplateSearchDto.templateId=scope.tempid;scope.defaultCaseTemplateSearchDto.productSku=productSku;scope.defaultCaseTemplateSearchDto.storeId=storeId;scope.defaultCaseTemplateSearchDto.customerDto=defaultCustomer();scope.defaultCaseTemplateSearchDto.customerDto.customerNo=scope.customer.customerNo;scope.defaultCaseTemplateSearchDto.customerDto.firstName=scope.customer.firstName;scope.defaultCaseTemplateSearchDto.customerDto.lastName=scope.customer.lastName;scope.defaultCaseTemplateSearchDto.customerDto.outputLanguage=scope.customer.outputLanguage;scope.defaultCaseTemplateSearchDto.customerDto.address=scope.customer.address;scope.defaultCaseTemplateSearchDto.contactId=scope.contactid;TsCaseService.getCSCaseFromTemplate(scope.defaultCaseTemplateSearchDto).success(function(result){result.viewType=scope.viewType;result.product.product.sku=productSku;scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,result);scope.isFetchingProductDetailsFromRecord=false}).error(function(error){console.log("TsCaseService.getCSCaseFromTemplate: "+error)})};scope.selectExistingProductHandler=function(rec){if(rec){if(scope.viewType==scope.VIEW_TYPE_INDIVIDUAL){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductSkuDataFromSubscriptionId(rec)}else{if(scope.viewType==scope.VIEW_TYPE_TEAM){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductDetailsFromProductSkuAndTemplate(rec.sku,"")}else{if(scope.viewType==scope.VIEW_TYPE_JIL_TEAM){scope.isFetchingProductDetailsFromRecord=true;scope.fetchProductDetailsFromProductSkuAndTemplate(rec.sku,"")}else{if(scope.viewType==scope.VIEW_TYPE_TRIAL){var prodDto=new defaultProductDto();prodDto.name=rec.sap_code;prodDto.metaName=rec.product_name;prodDto.metaType=rec.app_leid;prodDto.metaConfig=rec.app_leid;prodDto.viewType=scope.viewType;scope.$emit(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,prodDto)}}}}}};scope.triggerBtnName="";scope.isBtnTriggered=false;scope.triggerClickInBtnGrp=function(triggerBtnName){if(triggerBtnName&&!angular.element(triggerBtnName).hasClass("active")){scope.isBtnTriggered=true;$("#individualSubscriptionListBtn").removeClass("active");$("#teamSubscriptionListBtn").removeClass("active");$("#trialSubscriptionListBtn").removeClass("active");$("#jilTeamSubscriptionListBtn").removeClass("active");$timeout(function(){$(triggerBtnName).trigger("click");scope.isBtnTriggered=false},0)}};$rootScope.$on(AppConstants.UPDATE_CLOSE_POPUP_EVENT,function(event){scope.isBtnTriggered=false});scope.switchViewInSubscriptions=function(type){if(!scope.isBtnTriggered){if(type==scope.VIEW_TYPE_INDIVIDUAL){scope.viewType=scope.VIEW_TYPE_INDIVIDUAL;if(!scope.records){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#individualSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_TEAM){scope.viewType=scope.VIEW_TYPE_TEAM;if(!scope.teamRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#teamSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_JIL_TEAM){scope.viewType=scope.VIEW_TYPE_JIL_TEAM;if(!scope.jilTeamRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#jilTeamSubscriptionListBtn")}else{if(type==scope.VIEW_TYPE_TRIAL){scope.viewType=scope.VIEW_TYPE_TRIAL;if(!scope.trialRecords){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)}scope.triggerClickInBtnGrp("#trialSubscriptionListBtn")}}}}}};scope.refreshIndividualsList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshTeamsList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};scope.refreshTrialList=function(){scope.$emit(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,scope.viewType)};$rootScope.$on(AppConstants.UPDATE_TS_SUBSCRIPTION_VIEW_CONTEXT_EVENT,function(event,viewType){scope.viewType=viewType;scope.switchViewInSubscriptions(scope.viewType)});scope.getPayments=function(records,offerId){var productStatus,payments=[];payments=_.map(_.uniqBy(_.filter(records,{offerId:offerId}),_.property("paymentStatus")),"paymentStatus");if(payments.length==1){productStatus=payments[0]}else{if(payments.length==2){if(payments[0]==TeamConstants.PAYMENT_STATUS_CANCELLING&&payments[1]==TeamConstants.PAYMENT_STATUS_CANCELLED){productStatus=TeamConstants.PAYMENT_STATUS_CANCELLING}else{productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}else{if(payments.length>2){productStatus=TeamConstants.PAYMENT_STATUS_ACTIVE}}}return productStatus}}}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.service("TsCaseUtils",["$log","$timeout","$q","MetadataService",function($log,$timeout,$q,MetadataService){this.getTSCaseProductMetadataDetails=function(product){var deferred=$q.defer();$timeout(function(){var response={};response.subProductMetadataDtos=[];response.subService=[];response.technologyCodes=[];response.product=product;MetadataService.getTsCaseProductMetadata({productCode:product.product.name}).success(function(result){if(result.subProductMetadataDtos){response.subProductMetadataDtos=result.subProductMetadataDtos;var subProduct=null;if(product.subProduct){subProduct=MetadataService.findDto(result.subProductMetadataDtos,product.subProduct.code,"code");if(subProduct){response.product.subProduct={code:subProduct.code,productCode:"",label:subProduct.name}}}if(subProduct&&subProduct.subServices){response.subService=subProduct.subServices}if(subProduct&&subProduct.techCodes){response.technologyCodes=subProduct.techCodes}}if(!response.subService||response.subService.length==0){response.subServices=result.subServices}if(!response.technologyCodes||response.technologyCodes.length==0){response.technologyCodes=result.techCodes}if(response.product.product.subService){response.product.product.subService.value=MetadataService.find(response.subServices,response.product.product.subService.id,"id","value")}if(response.product.product.technologyCode){response.product.product.technologyCode.value=MetadataService.find(response.technologyCodes,response.product.product.technologyCode.id,"id","value")}deferred.resolve(response)}).error(function(){deferred.reject()})},10);return deferred.promise}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngTsSelectExistingProducts",["$rootScope","ProductRecordService","CustomerSubscriptionService","webGuidFilterFilter","AppConstants","Utils","CustomerConstants","$timeout","SubscriptionConstants","OnlineFlexibleTrialProductService","CustomerPreviewService","CustomerUtil","AppUtils",function($rootScope,ProductRecordService,CustomerSubscriptionService,webGuidFilterFilter,AppConstants,Utils,CustomerConstants,$timeout,SubscriptionConstants,OnlineFlexibleTrialProductService,CustomerPreviewService,CustomerUtil,AppUtils){return{restrict:"EA",scope:{customer:"=",caseedit:"=",contactid:"=",imscustomer:"=",casetype:"=",tempid:"=",orgguid:"="},replace:true,templateUrl:"js/cases/partials/ts-select-existing-products.html",link:function(scope,element,attrs){scope.showTransactionHistoryBtn=false;scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_IBASE;scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;scope.VIEW_TYPE_PERPETUAL="PERPETUAL";scope.VIEW_TYPE_ENTERPRISE="ENTERPRISE";scope.VIEW_TYPE_INDIVIDUAL="INDIVIDUAL";scope.VIEW_TYPE_TEAM="TEAM";scope.VIEW_TYPE_JIL_TEAM="JILTEAM";scope.VIEW_TYPE_TRIAL="TRIAL";scope.PRODUCT_TAB="PRODUCT_TAB";scope.SUBSCRIPTION_TAB="SUBSCRIPTION_TAB";scope.DEFAULT_CASE_TYPE="tsCase";scope.isTeamOrIndividual=false;scope.$watch("isTeamOrIndividual",function(newValue,oldValue){if(!newValue){return}if(newValue==true){$timeout(function(){$("#tsSubProducts a").tab("show")},0)}});scope.$watch("contactid",function(newValue,oldValue){if(!newValue){return}scope.contactId=newValue});$rootScope.$on("LOAD_EXISTING_PRODUCT_DETAIL",function(event,caseViewType){if(caseViewType==scope.DEFAULT_CASE_TYPE){scope.showExistingProductsModal()}});scope.isPopUpInitailized=false;scope.showExistingProductsModal=function(){if(scope.isPopUpInitailized){return}element.find("#existingTsCaseProductListModal").modal("show");scope.rescale();$(window).bind("resize",scope.rescale);scope.isPopUpInitailized=true;scope.loadContextualData()};scope.isCustomerEnterprise=false;scope.loadContextualData=function(){if(scope.customer.enterpriseId==true){scope.PRODUCT_VIEW_TYPE=scope.VIEW_TYPE_ENTERPRISE;scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;scope.isCustomerEnterprise=true}else{scope.PRODUCT_VIEW_TYPE=scope.VIEW_TYPE_PERPETUAL;scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE}if(Utils.getCustomerTypeFromImsDetail($rootScope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_JIL_TEAM;if(!scope.isCustomerEnterprise){scope.fetchSelectedTabInformation(scope.SUBSCRIPTION_TAB);scope.isTeamOrIndividual=true}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}else{if(Utils.getCustomerTypeFromImsDetail($rootScope.imsCustomer)==CustomerConstants.CUSTOMER_CONTEXT_IND){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;if(!scope.isCustomerEnterprise){scope.fetchSelectedTabInformation(scope.SUBSCRIPTION_TAB);scope.isTeamOrIndividual=true;scope.loadSubscriptions()}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}else{scope.fetchSelectedTabInformation(scope.PRODUCT_TAB)}}};scope.closeExistingProductsModal=function(){scope.interactionHistory=[];$("body").css("overflow","auto");scope.$emit(AppConstants.UPDATE_CLOSE_POPUP_EVENT);scope.isTeamOrIndividual=false;scope.isPopUpInitailized=false;element.find("#existingTsCaseProductListModal").modal("hide")};scope.rescale=function rescale(){$("#existingTsCaseProductListModal .modal-body").css({"max-height":"none","overflow-x":"hidden"})};scope.$on(AppConstants.SELECTED_PRODUCT_FROM_REGISTERED_PRODUCT_EVENT,function(event,rec){scope.closeExistingProductsModal()});scope.$on(AppConstants.PRODUCTS_VIEW_SELECT_EVENT,function(event,viewType){if(viewType==scope.VIEW_TYPE_PERPETUAL){scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_IBASE;scope.refreshProductType=AppConstants.PRODUCT_TYPE_IBASE;scope.loadProducts()}else{if(viewType==scope.VIEW_TYPE_ENTERPRISE){scope.PRODUCT_VIEW_TYPE=AppConstants.PRODUCT_TYPE_ENT;scope.refreshProductType=AppConstants.PRODUCT_TYPE_ENT;scope.loadProducts()}}});scope.$on(AppConstants.SUBSCRIPTION_VIEW_SELECT_EVENT,function(event,viewType){if(viewType==scope.VIEW_TYPE_INDIVIDUAL){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_INDIVIDUAL;scope.loadSubscriptions()}else{if(viewType==scope.VIEW_TYPE_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_TEAM;scope.loadTeamProducts()}else{if(viewType==scope.VIEW_TYPE_JIL_TEAM){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_JIL_TEAM;scope.loadJilTeamSubscriptions()}else{if(viewType==scope.VIEW_TYPE_TRIAL){scope.SUBSCRIPTION_VIEW_TYPE=scope.VIEW_TYPE_TRIAL;scope.loadTrialProduct()}}}}});scope.loadSubscriptions=function(){scope.isSubscriptionLoading=true;scope.subscriptionlists=[];scope.guid=webGuidFilterFilter(scope.customer);console.log("Query CustomerSubscriptionService.getSubscriptions",scope.guid);if(!scope.isSubscriptionsListCalled){scope.isSubscriptionsListCalled=true;scope.subscriptionAccountId=scope.guid+"@AdobeID";scope.locale=scope.customer.outputLanguage+"_"+scope.customer.address.country.code;CustomerSubscriptionService.getSubscriptions({subscriptionAccountId:scope.subscriptionAccountId,locale:scope.locale}).success(function(result){console.log("Success CustomerSubscriptionService.getSubscriptions");scope.subscriptionlists=result;scope.isSubscriptionsListCalled=false;for(var i=0;i<scope.subscriptionlists.length;i++){scope.subscriptionlists[i].purchaseDate=scope.subscriptionlists[i].contract.termStartDate;scope.subscriptionlists[i].productName=scope.subscriptionlists[i].localizedLongProductDescriptor;scope.subscriptionlists[i].customerGuid=scope.guid;if(scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_REDEMPTION_CODE_STUDENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_DIGITAL_RIVER_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_APPLE_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_GOOGLE_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_AMAZON_PAYMENT||scope.subscriptionlists[i].billingInfo.paymentInstrumentInfo.paymentCategory==SubscriptionConstants.SUBSCRIPTION_SOURCE_TYPE_VENDOR_MANAGED_PAYMENT){scope.subscriptionlists[i].storeOrderNumber=scope.subscriptionlists[i].contract.id}}scope.isSubscriptionLoading=false}).error(function(error){console.log("error",error);$("#subscriptions").html(error);scope.isSubscriptionLoading=false;scope.isSubscriptionsListCalled=false})}};scope.loadJilTeamSubscriptions=function(){scope.jilTeamLoading=true;scope.jilTeamRecords=[];scope.customerGuid=webGuidFilterFilter(scope.customer);scope.locale=scope.customer.outputLanguage+"_"+scope.customer.address.country.code;CustomerSubscriptionService.getTeamSubscriptionListByAdmin({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){scope.jilTeamAdminRecords=CustomerUtil.getTeamSubscriptionList(result,scope.customerGuid);var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config);CustomerSubscriptionService.getTeamSubscriptionListByDelegate({customerGuid:scope.customerGuid,locale:scope.locale}).success(function(result,status,headers,config){var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config);scope.delegateCount=result.length;scope.delegateSearchCount=1;if(result&&result.length>=1){angular.forEach(result,function(team){CustomerSubscriptionService.getTeamSubscriptionDetails({customerGuid:scope.customerGuid,teamId:team.teamId,locale:scope.locale}).success(function(resultDetails,status,headers,config){var delegateDetails=[];if(scope.delegateCount==scope.delegateSearchCount){scope.jilTeamLoading=false}else{scope.delegateSearchCount++}delegateDetails.push(resultDetails);if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}scope.jilTeamDelegateRecords=CustomerUtil.getTeamSubscriptionList(delegateDetails,scope.customerGuid);if(scope.jilTeamAdminRecords.length&&scope.jilTeamAdminRecords[0].teamId!=scope.jilTeamDelegateRecords[0].teamId){scope.jilTeamRecords.push(scope.jilTeamDelegateRecords)}else{if(!scope.jilTeamAdminRecords.length&&scope.jilTeamDelegateRecords.length){scope.jilTeamRecords.push(scope.jilTeamDelegateRecords)}}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,true,resultDetails);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)}).error(function(resultDetails,status,headers,config){scope.totalRecords="";scope.jilTeamLoading=false;var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,resultDetails);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription Details";AppUtils.sendLogToServer(messageObject,status,headers,config)})})}else{scope.jilTeamLoading=false;if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}else{scope.totalRecords=""}}}).error(function(result,status,headers,config){if(scope.jilTeamAdminRecords.length){scope.jilTeamRecords.push(scope.jilTeamAdminRecords)}else{scope.totalRecords=""}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List By Delegate";AppUtils.sendLogToServer(messageObject,status,headers,config)})}).error(function(result,status,headers,config){scope.jilTeamLoading=false;scope.totalRecords="";if(status==504){scope.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_WARNING_TYPE,"The request has timed out. Please check the subscription after 5 minutes before attempting to reprocess.")}else{scope.teamError=AppUtils.getSingleMessage(TeamConstants.MESSAGE_ERROR_TYPE,"Failed to load team subscription details")}var messageObject=AppUtils.getMessageLoggingObject(AppConstants.SOURCE_SYSTEM_JIL,false,result);messageObject.Functionality="CS Case Select Existing Product - Search Team Subscription List";AppUtils.sendLogToServer(messageObject,status,headers,config)})};scope.isFillForCCEWithImsCalled=false;scope.loadTeamProducts=function(){console.log("Query ProductRecordService.fill",scope.customer.customerNo);scope.isTeamSubscriptionLoading=true;if(scope.customer&&scope.customer.bpType=="2"){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}if(!scope.isFillForCCEWithImsCalled){scope.isFillForCCEWithImsCalled=true;ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:"CCT",janusOrgId:scope.orgguid,isIndirect:true}).success(function(result){scope.isTeamSubscriptionLoading=false;scope.teamProductsCrm=result;scope.isFillForCCEWithImsCalled=false}).error(function(error){scope.isTeamSubscriptionLoading=false;scope.isFillForCCEWithImsCalled=false;$("#subscriptions").html(error)})}}else{if(!scope.isFillFromCrmCalled){scope.isFillFromCrmCalled=true;ProductRecordService.fillFromCrm({customerNo:scope.customer.customerNo,startIndex:0,numberOfRows:100,prodType:"CCT",isIndirect:"true"}).success(function(result){scope.isTeamSubscriptionLoading=false;scope.teamProductsCrm=result;scope.isFillFromCrmCalled=false}).error(function(error){scope.isTeamSubscriptionLoading=false;scope.isFillFromCrmCalled=false;$("#subscriptions").html(error)})}}};scope.loadTrialProduct=function(){scope.isTrialProductLoading=true;OnlineFlexibleTrialProductService.getTrialDeviceDetails({customerGuid:webGuidFilterFilter(scope.customer)+"@AdobeID",filterType:""}).success(function(result){scope.trialProductList=result;scope.isTrialProductLoading=false;if(!angular.isArray(scope.trialProductList[0].machines)){var machineArray=[];machineArray.push(scope.trialProductList[0].machines);scope.trialProductList[0].machines=machineArray}if(angular.isArray(scope.trialProductList[0].machines)){var applicationArray=[];angular.forEach(scope.trialProductList[0].machines,function(machine){applicationArray=[];if(!angular.isArray(machine.applications)){applicationArray.push(machine.applications);machine.applications=applicationArray}})}var allApplication=[];angular.forEach(scope.trialProductList[0].machines,function(machine){angular.forEach(machine.applications,function(app){app.machine_id=machine.machine_id;allApplication.push(app)})});scope.trialProductList[0]["newmachines"]=angular.copy(allApplication)}).error(function(error){scope.isTrialProductLoading=false;$("#subscriptions").html(error)})};scope.fetchSelectedTabInformation=function(selectedTab){if(selectedTab==scope.PRODUCT_TAB){$timeout(function(){$("#tsCrmProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_TS_PRODUCT_VIEW_CONTEXT_EVENT,scope.PRODUCT_VIEW_TYPE);if((scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE&&!scope.perpetualProducts)||(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT&&!scope.enterpriseProducts)){scope.loadProducts()}}else{if(selectedTab==scope.SUBSCRIPTION_TAB){$timeout(function(){$("#tsSubProducts a").tab("show")},0);scope.$emit(AppConstants.UPDATE_TS_SUBSCRIPTION_VIEW_CONTEXT_EVENT,scope.SUBSCRIPTION_VIEW_TYPE);if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_INDIVIDUAL&&!scope.subscriptionlists){scope.loadSubscriptions()}else{if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_TEAM&&!scope.teamProductsCrm){scope.loadTeamProducts()}else{if(scope.SUBSCRIPTION_VIEW_TYPE==scope.VIEW_TYPE_JIL_TEAM&&!scope.jilTeamRecords){scope.loadJilTeamSubscriptions()}}}}}};scope.imsCustomer=null;scope.loadProducts=function(){scope.isLoadingProductsCrm=true;if(scope.customer&&scope.customer.bpType=="2"){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}if(!scope.isOrgProductsServiceCalled){scope.isOrgProductsServiceCalled=true;scope.processENTProduct()}}else{if(!scope.isProductServiceCalled){scope.isProductServiceCalled=true;var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillFromCrm({customerNo:scope.customer.customerNo,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("success ProductRecordService.fill");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isProductServiceCalled=false}).error(function(error){console.log("1error",error);scope.isLoadingProductsCrm=false;scope.isProductServiceCalled=false;$("#products").html(error)})}}};scope.processENTProduct=function(){if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.loadPerpetualData()}else{if(angular.isDefined(scope.orgguid)&&scope.orgguid.length>0){scope.loadENTData()}else{scope.orgguidFound=false;CustomerPreviewService.getCustomerRelatedOrgWithoutLocking({customerNo:scope.contactid,customerType:"ENT",viewMode:""}).success(function(result){if(angular.isDefined(result)&&angular.isArray(result.customerRelations)&&result.customerRelations.length>0){for(var i=0;i<result.customerRelations.length;i++){if(result.customerRelations[i].partner1==scope.customer.customerNo){scope.orgguid=result.customerRelations[i].orgguid;if(angular.isDefined(scope.orgguid)&&scope.orgguid&&scope.orgguid.length>0){scope.orgguidFound=true;scope.loadENTData()}else{scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}break}}if(!scope.orgguidFound){scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}}else{scope.isLoadingProductsCrm=false;scope.enterpriseProducts=[];scope.isOrgProductsServiceCalled=false}}).error(function(error){})}}};scope.loadENTData=function(){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,janusOrgId:scope.orgguid,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isOrgProductsServiceCalled=false}).error(function(error){console.log("error",error);scope.isLoadingProductsCrm=false;scope.isOrgProductsServiceCalled=false;$("#products").html(error)})};scope.loadPerpetualData=function(){var imsOrg="";if($rootScope.imsCustomer&&$rootScope.imsCustomer.serviceAccounts&&$rootScope.imsCustomer.serviceAccounts.length>0){imsOrg=$rootScope.imsCustomer.serviceAccounts[0].ownerGuid}var isInDirectFlag="true";if(scope.refreshProductType=="IBASE"){isInDirectFlag="false"}ProductRecordService.fillForCCEWithImsV1({customerNo:scope.contactId,orgId:scope.customer.customerNo,imsOrgGuid:imsOrg,startIndex:0,numberOfRows:100,prodType:scope.refreshProductType,isIndirect:isInDirectFlag}).success(function(result){console.log("Success ProductRecordService.fill for CC4E");scope.isLoadingProductsCrm=false;if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_IBASE){scope.perpetualProducts=result}else{if(scope.refreshProductType==AppConstants.PRODUCT_TYPE_ENT){scope.enterpriseProducts=result}}scope.isOrgProductsServiceCalled=false}).error(function(error){console.log("error",error);scope.isLoadingProductsCrm=false;scope.isOrgProductsServiceCalled=false;$("#products").html(error)})}}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("hxInputNumber",function(){return{restrict:"EA",require:"ngModel",scope:{numberValue:"=ngModel",min:"=",max:"="},templateUrl:"js/ui-components/templates/hx-input-number.html",link:function($scope,$element,$attrs,ctrl){$scope.$watch("numberValue",function(newValue,oldValue){if(!newValue){return}if(angular.isDefined($scope.min)&&$scope.numberValue<$scope.min){$scope.numberValue=$scope.min}if(angular.isDefined($scope.max)&&$scope.numberValue>$scope.max){$scope.numberValue=$scope.max}});$scope.decreaseQuantity=function(){if(angular.isDefined($scope.min)&&$scope.numberValue>$scope.min){$scope.numberValue=$scope.numberValue-1}};$scope.increaseQuantity=function(){if(angular.isDefined($scope.max)&&$scope.numberValue<$scope.max){$scope.numberValue=$scope.numberValue+1}}}}});var app=app||angular.module("hxApp",["ngRoute"]);app.controller("UserCtrl",["$scope","$rootScope","$routeParams","$location","UserService","TrackingService","HxDbFactory","MetadataService","AppConstants","LocalStorageService","StoreShortcutsService","Utils","AppUtils","$timeout","$window",function($scope,$rootScope,$routeParams,$location,UserService,TrackingService,HxDbFactory,MetadataService,AppConstants,LocalStorageService,StoreShortcutsService,Utils,AppUtils,$timeout,$window){$scope.alert="";$scope.isLoading=false;$scope.loginInfo={username:"",password:"",workstation:"",lang:""};$scope.isMaxConnectionExceed=false;Utils.pageTitle("User Login");if($location.search().cti){LocalStorageService.add("isValidUser",false)}if($scope.$root.refreshRequired){window.location.reload()}var isValidUser=LocalStorageService.get("isValidUser");if(isValidUser==true){$location.path("/search");return}$scope.setLanguage=function(){$scope.languages=AppConstants.LANGUAGES;angular.forEach(AppConstants.LANGUAGES,function(language){if(angular.uppercase($location.search().lang)==language.code){$scope.loginInfo.lang=language.code}});if(!$scope.loginInfo.lang){var locallyStoredLanguage=LocalStorageService.get("language",$scope.loginInfo.lang);if(locallyStoredLanguage){$scope.loginInfo.lang=locallyStoredLanguage}else{$scope.loginInfo.lang=AppConstants.DEFAULT_LANGUAGE}}};$scope.setLanguage();$scope.login=function(){$scope.isLoading=true;$scope.isMaxConnectionExceed=false;var messageObject={Source_System:AppConstants.SOURCE_SYSTEM_CRM,Functionality:"Agent - Login",User_Name:$scope.loginInfo.username};UserService.login($scope.loginInfo).success(function(result,status,headers,config){TrackingService.trackPageView("User","Login");worker.postMessage("start");$scope.isLoading=false;if(typeof(result.lastName)!=="undefined"){$rootScope.loginInfo=result;localStorage.setItem("ls.language",$scope.loginInfo.lang);localStorage.setItem("ls.isValidUser",true);HxDbFactory.metadataInit(function(result){if(result!=null&&!result){$location.path("/setting");location.reload()}else{$rootScope.$broadcast("event:ping");setTimeout($scope.checkMetatadataVersion(),2000)}});messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_SUCCESS;messageObject.Result=AppConstants.MESSAGE_SUCCESS_TYPE;AppUtils.sendLogToServerWithoutAuth(messageObject,status,headers,config)}else{messageObject.Error_Title="Login Error";messageObject.Exception_Reason_Text="Result Object Is Not Complete";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServerWithoutAuth(messageObject,status,headers,config)}}).error(function(error,status,headers,config){$scope.isLoading=false;if(error&&error.messages&&error.messages.length>0){if(error.messages[0].text.indexOf("Name or password is incorrect")>=0){$scope.alert="Invalid username or password."}else{$scope.alert=error.messages[0].text}angular.forEach(error.messages,function(errorItem,key){var itemKeyName="Exception_Reason_"+(key+1)+"_";messageObject[itemKeyName+"Code"]=errorItem.number;messageObject[itemKeyName+"Type"]=errorItem.type;messageObject[itemKeyName+"Description"]=errorItem.text})}else{if(status==509&&angular.isDefined(error)&&angular.isDefined(error.exceptionMessage)&&error.exceptionMessage.length>0){$scope.alert="Maximum  user login limit exhausted. Please click on refresh button for retry and to further help report Hendrix Support.";messageObject.Exception_Reason_Text="Invalid username or password.";$scope.isMaxConnectionExceed=true}else{$scope.alert="Invalid username or password.";messageObject.Exception_Reason_Text="Invalid username or password."}}messageObject.Error_Title="Login Error";messageObject.Flow_Result=AppConstants.SERVICE_MESSAGE_UNSUCCESS;messageObject.Result=AppConstants.MESSAGE_ERROR_TYPE;AppUtils.sendLogToServerWithoutAuth(messageObject,status,headers,config);LocalStorageService.add("isValidUser",false)})};$scope.initializeStore=function(){StoreShortcutsService.getShortcuts().success(function(result){LocalStorageService.add("agentStoreProfile",result)}).error(function(result){$scope.isLoading=false;$scope.messages=AppUtils.getSingleMessage(AppConstants.MESSAGE_ERROR_TYPE,"Failed to load agent store profile")})};$scope.checkMetatadataVersion=function(){var metadataObject=new Object();var metadataVersion;MetadataService.initializeSettingMetadata(metadataObject,function(dbStatus){if(dbStatus==MetadataService.DB_STATUS.SUCCESS){metadataVersion=metadataObject.metadataInfo[0].timestamp}if(metadataVersion){MetadataService.checkMetadataVersion({clientCacheTimestamp:metadataVersion}).success(function(isUpdateRequiredResult){if(isUpdateRequiredResult=="true"||isUpdateRequiredResult==true){console.log("Metadata Status : Metadata Version Is Up To Date With Server Version");MetadataService.isMetadataUptodate=true;var sessionRtrnUrl=decodeURIComponent(window.sessionStorage.returnUrl);var temporarySFDCURL=decodeURIComponent(window.sessionStorage.returnUrlSFDC);if((angular.isDefined(temporarySFDCURL)&&temporarySFDCURL&&temporarySFDCURL!=""&&temporarySFDCURL.indexOf("/sfdc")==0)||(angular.isDefined($routeParams.apq_Id)&&$routeParams.apq_Id.length>0)){$timeout(function(){$location.path("/sfdc")},1000)}else{if(sessionRtrnUrl.indexOf("/login")==-1&&sessionRtrnUrl.indexOf("undefined")==-1){$rootScope.returnUrl=sessionRtrnUrl;window.sessionStorage.clear()}if($rootScope.rediretUrl&&$rootScope.rediretUrl!=""){$location.path(decodeURIComponent($rootScope.rediretUrl))}if($rootScope.returnUrl&&decodeURIComponent($rootScope.returnUrl).indexOf("/login")==-1){$location.path(decodeURIComponent($rootScope.returnUrl))}else{$location.path("/search")}}}else{console.log("Metadata Status : Metadata Version Is Needs To Update With Latest Server Version");MetadataService.isMetadataUptodate=false;$location.path("/setting")}}).error(function(error){console.log("Metadata Version Check Service Failed");$location.path("/search")})}else{$location.path("/search")}})};$scope.refresh=function(){deleteCookie("Hendrix-BigIP");$window.location.reload()}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("UserService",function($http){var service={};service.getCurrentUser=function(){return $http({method:"GET",url:"../userService/getCurrentUser.do?"+Math.random()})};service.login=function(data){return $http({method:"POST",url:"../userService/loginUser.do",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:transform,data:data})};service.logout=function(){return $http({method:"POST",url:"../userService/logoutUser.do",headers:{"Content-Type":"application/x-www-form-urlencoded"}})};return service});var app=app||angular.module("hxApp.services").value("version","0.1");app.service("Utils",["$rootScope","CustomerConstants",function($rootScope,CustomerConstants){this.customerLink=function(rec){var result="/customer/";if(rec){result+=rec.customerNumber;if(rec.contact){result+="/rel/"+rec.contact}}return result};this.customerUrl=function(customerNo){var result="/customer/";if(customerNo){result+=customerNo}return result};this.customerLink2=function(customerNo,contactNo){var result="/customer/";if(customerNo){result+=customerNo;if(contactNo!=customerNo&&contactNo!=null){result+="/rel/"+contactNo}}return result};this.newCaseCustomerLink=function(customerNo,contactNo){var result="customerNo=";if(customerNo){result+=customerNo;if(contactNo!=customerNo&&contactNo!=null){result+="&contactId="+contactNo}}return result};this.linkToCase=function(caseNumber,transType,customerId,contactId){var link=this.customerLink2(customerId,contactId);if(transType=="ZCSS"){link+="/tsCase/"}else{link+="/csCase/"}link+=caseNumber;return link};this.linkToCaseView=function(caseNumber,transType,customerId,contactId){return"/case/"+caseNumber};this.linkToOrderView=function(orderNumber){return"/order/"+orderNumber};this.linkToTransactionView=function(orderNumber){return"/transaction/"+orderNumber};this.pageTitle=function(newTitle){$rootScope.title=newTitle};this.getNameFromCustomerDto=function(dto){if(!dto){return""}if(dto.bpType=="1"){if(dto.address.country.code=="JA"){return dto.lastName+" "+dto.firstName}return dto.firstName+" "+dto.lastName}else{return dto.organizationName1+" "+dto.organizationName2}};this.getCustomerTypeFromImsDetail=function(imsCustomer){var customerType=CustomerConstants.CUSTOMER_CONTEXT_ALL;if(imsCustomer){if(imsCustomer.roles&&imsCustomer.roles.length>0){if(imsCustomer.roles[0].named_role=="org_admin"){customerType=CustomerConstants.CUSTOMER_CONTEXT_TEAM}}else{customerType=CustomerConstants.CUSTOMER_CONTEXT_IND}}return customerType};this.isEnterPriseOrgExist=function(imsOrgsForCustomer){var flag=false;if(!angular.isDefined(imsOrgsForCustomer)||!angular.isArray(imsOrgsForCustomer)||!(imsOrgsForCustomer.length>0)){return false}for(var i=0;i<imsOrgsForCustomer.length;i++){if(imsOrgsForCustomer[i].orgType=="Enterprise"){flag=true;break}}return flag};this.createSubscriptionLinkInCustomerView=function(imsCustomerData,customerNo){var subLink="#/customer/"+customerNo+"/subscriptions";var customerType=this.getCustomerTypeFromImsDetail(imsCustomerData);if(customerType==CustomerConstants.CUSTOMER_CONTEXT_TEAM){subLink="#/customer/"+customerNo+"/subscriptions/team"}else{if(customerType==CustomerConstants.CUSTOMER_CONTEXT_IND){subLink="#/customer/"+customerNo+"/subscriptions/individual"}}return subLink};this.createProductLinkInCustomerView=function(imsCustomerData,customerNo){var productLink='#/customer/"+customerNo+"/products';var customerType=this.getCustomerTypeFromImsDetail(imsCustomerData);if(customerType==CustomerConstants.CUSTOMER_CONTEXT_ENT){productLink="#/customer/"+customerNo+"/products/enterprise"}else{productLink="#/customer/"+customerNo+"/products/perpetual"}return productLink};this.getStatusColor=function(statusText){var red=["In Process","Pending Adobe Action"];var green=["Pending Customer Action","Pending Customer Close","Suspended"];var yellow=["Pending Patch","Pending Release","Pending Tech Note","Transfer to Engineering"];if(red.indexOf(statusText)!=-1){return"red"}if(green.indexOf(statusText)!=-1){return"green"}if(yellow.indexOf(statusText)!=-1){return"yellow"}};this.hasErrors=function(messages){var result=false;if(!messages){return false}angular.forEach(messages,function(msg){if(msg.type=="E"){result=true;return}});return result};this.hasWarnings=function(messages){var result=false;if(!messages){return false}angular.forEach(messages,function(msg){if(msg.type=="W"){result=true;return}});return result};this.errorMsg=function(msg){return{type:"E",error:true,text:msg}};this.getDefaultCountriesLanguage=function(countryCode){var countriesDefaultLanguage="AD:ES,AE:EN,AF:EN,AG:EN,AI:EN,AL:EN,AM:EN,AN:EN,AO:EN,AQ:EN,AR:ES,AS:EN,AT:DE,AU:EN,AW:EN,AZ:EN,BA:EN,BB:EN,BD:EN,BE:NL,BF:EN,BG:EN,BH:EN,BI:EN,BJ:EN,BM:EN,BN:EN,BO:EN,BR:PT,BS:EN,BT:EN,BU:EN,BV:EN,BW:EN,BY:EN,BZ:EN,CA:EN,CC:EN,CD:EN,CF:EN,CG:EN,CH:DE,CI:EN,CK:EN,CL:ES,CM:EN,CN:EN,CO:ES,CR:EN,CS:EN,CU:EN,CV:EN,CX:EN,CY:EN,CZ:CS,DE:DE,DJ:EN,DK:DA,DM:EN,DO:EN,DZ:EN,EC:EN,EE:EN,EG:EN,EH:EN,ER:EN,ES:ES,ET:EN,FI:FI,FJ:EN,FK:EN,FM:EN,FO:DA,FR:FR,FX:FR,GA:EN,GB:EN,GD:EN,GE:EN,GF:FR,GG:EN,GH:EN,GI:EN,GL:EN,GM:EN,GN:EN,GP:EN,GQ:EN,GR:EN,GS:EN,GT:EN,GU:EN,GW:EN,GY:EN,GZ:EN,HK:EN,HM:EN,HN:EN,HR:EN,HT:EN,HU:EN,ID:EN,IE:EN,IL:HE,IM:EN,IN:EN,IO:EN,IQ:EN,IR:EN,IS:EN,IT:IT,JE:EN,JM:EN,JO:EN,JP:JA,KE:EN,KG:EN,KH:EN,KI:EN,KM:EN,KN:EN,KP:EN,KR:EN,KV:EN,KW:EN,KY:EN,KZ:EN,LA:EN,LB:EN,LC:EN,LI:DE,LK:EN,LR:EN,LS:EN,LT:EN,LU:FR,LV:EN,LY:EN,MA:FR,MC:FR,MD:EN,ME:EN,MG:EN,MH:EN,MK:EN,ML:EN,MM:EN,MN:EN,MO:EN,MP:EN,MQ:EN,MR:EN,MS:EN,MT:EN,MU:EN,MV:EN,MW:EN,MX:ES,MY:EN,MZ:EN,NA:EN,NC:EN,NE:EN,NF:EN,NG:EN,NI:EN,NL:NL,NO:NO,NP:EN,NR:EN,NU:EN,NZ:EN,OM:EN,PA:EN,PE:ES,PF:FR,PG:EN,PH:EN,PK:EN,PL:PL,PM:EN,PN:EN,PR:EN,PS:EN,PT:PT,PW:EN,PY:EN,QA:EN,RE:EN,RO:EN,RS:EN,RU:RU,RW:EN,SA:EN,SB:EN,SC:EN,SD:EN,SE:SV,SG:EN,SH:EN,SI:EN,SJ:EN,SK:EN,SL:EN,SM:IT,SN:EN,SO:EN,SR:EN,SS:EN,ST:EN,SV:EN,SY:EN,SZ:EN,TC:EN,TD:EN,TF:FR,TG:EN,TH:EN,TJ:EN,TK:EN,TL:EN,TM:EN,TN:EN,TO:EN,TP:EN,TR:TR,TT:EN,TV:EN,TW:EN,TZ:EN,UA:RU,UG:EN,UM:EN,US:EN,UY:EN,UZ:EN,VA:IT,VC:EN,VE:EN,VG:EN,VI:EN,VN:EN,VU:EN,WE:EN,WF:EN,WS:EN,XM:EN,YD:EN,YE:EN,YT:EN,YU:EN,ZA:EN,ZM:EN,ZR:EN,ZW:EN";var indexFound=countriesDefaultLanguage.search(countryCode+":");return countriesDefaultLanguage.substring(indexFound+3,indexFound+5)};this.showCrmMessage=function(messageList){var showMessageList=[];angular.forEach(messageList,function(message){if(message.error){showMessageList.push({info:false,error:true,warning:false,text:message.text})}else{if(message.information){showMessageList.push({info:true,error:false,warning:false,text:message.text})}else{if(message.warning){showMessageList.push({info:false,error:false,warning:true,text:message.text})}else{if(message.success){showMessageList.push({info:true,error:false,warning:false,text:message.text})}}}}});return showMessageList};this.ccmTeamMessage=function(messageList,modifiedSucessMessage){var showMessageList=[];angular.forEach(messageList,function(message){if(message.error){showMessageList.push({info:false,error:true,warning:false,text:message.text})}else{if(message.information&&modifiedSucessMessage!=""){showMessageList.push({info:true,error:false,warning:false,text:modifiedSucessMessage})}else{if(message.information){showMessageList.push({info:true,error:false,warning:false,text:message.text})}else{if(message.warning){showMessageList.push({info:false,error:false,warning:true,text:message.text})}else{if(message.success&&modifiedSucessMessage!=""){showMessageList.push({info:true,error:false,warning:false,text:modifiedSucessMessage})}else{if(message.success&&modifiedSucessMessage==""){showMessageList.push({info:true,error:false,warning:false,text:message.text})}}}}}}});return showMessageList};this.showMessage=function(type,message){var messages=[];messages.push({info:type=="info",error:type=="error",success:type=="success",text:message});return messages};this.isCCMTeam=function(productData){if(!productData||(productData.businessSegment&&productData.businessSegment=="VIP")){return false}return((angular.uppercase(productData.name)=="CCLE")||(angular.uppercase(productData.regType)=="CCM"))?true:false};this.isCCE=function(productData){if(!productData){return false}return angular.uppercase(productData.regType)=="N"?true:false};this.isCCMIndividual=function(productData){if(!productData){return false}return angular.uppercase(productData.name)=="CCSN"?true:false};this.isOrganization=function(bpType){var ORGANIZATION="2";return bpType==ORGANIZATION};this.isEnrollee=function(bpType){var PERSON_BP_TYPE="1";return bpType==PERSON_BP_TYPE};this.getInformationMessage=function(messagesList){if(messagesList){for(var count=0;count<messagesList.length;count++){if(messagesList[count].type=="I"&&messagesList[count].information==true){return messagesList[count].text}}}return""};this.getCorrectIdforCRM=function(receivedId){if(receivedId&&receivedId!=""){var receivedId=receivedId.toString();if(receivedId.length==7){receivedId="000"+receivedId}else{if(receivedId.length==8){receivedId="00"+receivedId}else{if(receivedId.length==9){receivedId="0"+receivedId}}}}return receivedId};this.getProductSubscriptionAge=function(age){var dateDiff="";if(age){var subscriptionDate=new Date(age);var dateDiff="";var b=moment(subscriptionDate);var a=moment(new Date());var years=a.diff(b,"year");b.add(years,"years");var months=a.diff(b,"months");b.add(months,"months");var days=a.diff(b,"days");console.log(years+" years "+months+" months "+days+" days");if(years>0){dateDiff=years+"y "}if(months>0){dateDiff=dateDiff+months+"m "}if(days>=0){dateDiff=dateDiff+days+"d "}}return dateDiff}}]);var app=app||angular.module("hxApp.services").value("version","0.1");app.factory("ValidateCouponService",["$http",function($http){var service={};service.validateCoupon=function(data){return $http({method:"POST",url:"../validateCouponService/validate.do",data:data})};return service}]);var app=app||angular.module("hxApp.directive",[]);app.directive("validateEmptyField",function(){return{require:"ngModel",link:function(scope,element,attrs){scope.$watch(attrs.ngModel,function(data){if(data){var modelDataLength=data.length;if(modelDataLength!=0){element.removeClass("highlightEmptyField")}}else{element.addClass("highlightEmptyField")}})}}});var app=app||angular.module("hxApp.directive",[]);app.directive("vatOption",["MetadataService",function(MetadataService){return{restrict:"E",scope:{ngModel:"=",vatOptions:"="},replace:true,template:"<span>{{value}}</span>",link:function(scope,element,attrs){scope.$watch(function(){return scope.ngModel},function(value){if(!value){return}angular.forEach(scope.vatOptions,function(item){if(value.taxType==item.code){scope.value=item.description;return}})})}}}]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngVisible",function(){return function(scope,element,attr){scope.$watch(attr.ngVisible,function(visible){element.css("visibility",visible?"visible":"hidden")})}});var app=app||angular.module("hxApp.directive",[]);var app=app||angular.module("hxApp.directive",[]);app.directive("ngWait",["CustomerConstants",function(CustomerConstants){return{restrict:"E",scope:{loadingMessage:"@loadingMessage"},replace:false,templateUrl:"js/common/partials/wait.html",link:function(scope,element,attrs){}}}]);